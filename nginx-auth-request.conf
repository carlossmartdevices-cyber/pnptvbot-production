# ============================================================================
# PNPtv Nginx Configuration with auth_request Route Protection
# ============================================================================
# Phase 1 Implementation: Protect /hub/, /media/*, /hangouts/, /portal/
#
# USAGE:
#   1. Backup current config: sudo cp /etc/nginx/nginx.conf nginx.conf.backup
#   2. Replace the relevant sections of /etc/nginx/nginx.conf with this file
#   3. Test syntax: sudo nginx -t
#   4. Reload: sudo systemctl reload nginx
#   5. Test: curl -i https://pnptv.app/hub/ (should 302 without auth)
#
# Modified: 2026-02-21
# ============================================================================

# Upstream backend
upstream pnptv_backend {
  server 127.0.0.1:3001;
  keepalive 32;
}

# HTTP → HTTPS redirect
server {
  listen 80;
  listen [::]:80;
  server_name pnptv.app;
  return 301 https://$server_name$request_uri;
}

# Main HTTPS server
server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name pnptv.app;

  # SSL Certificate (update paths to your cert)
  ssl_certificate /etc/ssl/certs/pnptv.crt;
  ssl_certificate_key /etc/ssl/private/pnptv.key;

  # SSL Security
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5:!3DES;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_stapling on;
  ssl_stapling_verify on;

  # Security headers
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header X-Frame-Options "SAMEORIGIN" always;
  add_header X-XSS-Protection "1; mode=block" always;

  # ⭐ CRITICAL: Trust reverse proxy headers (required for auth middleware)
  set_real_ip_from 127.0.0.1;
  real_ip_header X-Forwarded-For;

  # Logging
  access_log /var/log/nginx/pnptv-access.log combined buffer=32k flush=5s;
  error_log /var/log/nginx/pnptv-error.log warn;

  # ============================================================================
  # INTERNAL: Auth verify endpoint (called by auth_request directive)
  # ============================================================================
  location = /api/webapp/auth/verify {
    internal;  # ⭐ CRITICAL: Only accessible from auth_request directive, not from browsers
    proxy_pass http://pnptv_backend;
    proxy_http_version 1.1;

    # Don't send request body to auth endpoint
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";

    # Forward original request info for Express to validate
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header X-Original-Method $request_method;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;

    # ⭐ Session cookie MUST be forwarded for auth check
    proxy_set_header Cookie $http_cookie;

    # Auth endpoint should respond quickly (timeout 5s)
    proxy_connect_timeout 5s;
    proxy_send_timeout 5s;
    proxy_read_timeout 5s;
  }

  # ============================================================================
  # PUBLIC ROUTES (no authentication required)
  # ============================================================================

  # Login page
  location /login {
    try_files $uri /index.html;
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
  }

  # Auth apps (OAuth flows, login UI)
  location /auth/ {
    try_files $uri /auth/index.html;
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
  }

  # Payment processing (webhooks, checkout)
  location /api/payment/ {
    proxy_pass http://pnptv_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_request_buffering off;
  }

  # ePayco webhooks
  location /api/webhook/ {
    proxy_pass http://pnptv_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_request_buffering off;
  }

  # Health check
  location = /health {
    proxy_pass http://pnptv_backend;
    access_log off;
  }

  # ============================================================================
  # AUTHENTICATED ROUTES (require valid session via auth_request)
  # ============================================================================

  # Main dashboard (hub)
  location /hub/ {
    auth_request /api/webapp/auth/verify;
    auth_request_set $auth_status $upstream_status;
    error_page 401 403 = @auth_failed;

    try_files $uri /hub/index.html;
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
  }

  # Media apps (live, radio, videorama)
  location /media/ {
    auth_request /api/webapp/auth/verify;
    auth_request_set $auth_status $upstream_status;
    error_page 401 403 = @auth_failed;

    try_files $uri /media/index.html;
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
  }

  # Video conferencing (hangouts)
  location /hangouts/ {
    auth_request /api/webapp/auth/verify;
    auth_request_set $auth_status $upstream_status;
    error_page 401 403 = @auth_failed;

    try_files $uri /hangouts/index.html;
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
  }

  # User portal (if kept)
  location /portal/ {
    auth_request /api/webapp/auth/verify;
    auth_request_set $auth_status $upstream_status;
    error_page 401 403 = @auth_failed;

    try_files $uri /portal/index.html;
    expires 1h;
    add_header Cache-Control "public, max-age=3600";
  }

  # ============================================================================
  # PROTECTED API ENDPOINTS
  # ============================================================================

  # Profile & account management
  location /api/webapp/profile {
    auth_request /api/webapp/auth/verify;
    error_page 401 403 = @auth_failed;

    proxy_pass http://pnptv_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
  }

  # Social feed
  location /api/webapp/social {
    auth_request /api/webapp/auth/verify;
    error_page 401 403 = @auth_failed;

    proxy_pass http://pnptv_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header Cookie $http_cookie;
  }

  # Chat
  location /api/webapp/chat {
    auth_request /api/webapp/auth/verify;
    error_page 401 403 = @auth_failed;

    proxy_pass http://pnptv_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header Cookie $http_cookie;
  }

  # Admin panel
  location /api/webapp/admin {
    auth_request /api/webapp/auth/verify;
    error_page 401 403 = @auth_failed;

    proxy_pass http://pnptv_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header Cookie $http_cookie;
  }

  # All other /api/webapp/* routes
  location /api/webapp/ {
    auth_request /api/webapp/auth/verify;
    error_page 401 403 = @auth_failed;

    proxy_pass http://pnptv_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Cookie $http_cookie;
  }

  # ============================================================================
  # AUTH FAILURE HANDLER
  # ============================================================================
  location @auth_failed {
    # Return 302 to login with return URL (browser can redirect back after login)
    return 302 /auth/?redirect=$uri;
  }

  # ============================================================================
  # STATIC ASSETS (no auth needed, aggressive caching)
  # ============================================================================

  # React bundles & CSS (hashed filenames, long-term cache)
  location /assets/ {
    expires 1y;
    add_header Cache-Control "public, max-age=31536000, immutable";
    access_log off;
  }

  location /public/ {
    expires 30d;
    add_header Cache-Control "public, max-age=2592000";
  }

  # User uploads (avatars, post images)
  location /uploads/ {
    expires 7d;
    add_header Cache-Control "public, max-age=604800";
  }

  # ============================================================================
  # ROOT REDIRECT
  # ============================================================================
  location = / {
    # Redirect to authenticated dashboard (auth_request will protect it)
    return 302 /hub/;
  }

  # ============================================================================
  # 404 Handler
  # ============================================================================
  location ~ \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    try_files $uri =404;
  }

  location ~ /\. {
    deny all;
    access_log off;
  }
}

# ============================================================================
# TESTING & DEBUGGING
# ============================================================================
#
# Test without session (should redirect to auth):
#   curl -i https://pnptv.app/hub/
#
# Test with session (should serve app):
#   curl -i -H "Cookie: connect.sid=YOUR_SESSION_ID" https://pnptv.app/hub/
#
# Test public route (should work always):
#   curl -i https://pnptv.app/health
#
# Check Nginx syntax:
#   sudo nginx -t
#
# View error logs:
#   tail -f /var/log/nginx/pnptv-error.log
#
# View auth_request calls:
#   grep "auth_request" /var/log/nginx/pnptv-error.log
#
# ============================================================================
