const { Markup } = require('telegraf');
const PaymentService = require('../../services/paymentService');
const PlanModel = require('../../../models/planModel');
const { t } = require('../../../utils/i18n');
const logger = require('../../../utils/logger');
const { getLanguage } = require('../../utils/helpers');
const DaimoConfig = require('../../../config/daimo');
const registerActivationHandlers = require('./activation');

/**
 * Payment handlers
 * @param {Telegraf} bot - Bot instance
 */
const registerPaymentHandlers = (bot) => {
  // Register activation code handlers
  registerActivationHandlers(bot);
  // Show subscription plans
  bot.action('show_subscription_plans', async (ctx) => {
    try {
      const lang = getLanguage(ctx);
      const plans = await PlanModel.getAll();

      // Build styled message similar to main menu
      let message = lang === 'es'
        ? '`ðŸ’Ž PLANES DE SUSCRIPCIÃ“N`\n\n' +
          'Â¡Ãšnete a la familia PRIME, papi! ðŸ”¥\n\n' +
          '**Con PRIME obtienes:**\n' +
          'â€¢ ðŸ“» Radio 24/7\n' +
          'â€¢ ðŸŽ¬ Shows en vivo de performers\n' +
          'â€¢ ðŸ“ Encuentra papis cerca de ti\n' +
          'â€¢ ðŸ“¹ Videos completos\n\n' +
          '`Selecciona tu plan:`\n\n'
        : '`ðŸ’Ž SUBSCRIPTION PLANS`\n\n' +
          'Join the PRIME family, papi! ðŸ”¥\n\n' +
          '**With PRIME you get:**\n' +
          'â€¢ ðŸ“» 24/7 Radio access\n' +
          'â€¢ ðŸŽ¬ Watch live performer shows\n' +
          'â€¢ ðŸ“ Find nearby cloudy papis\n' +
          'â€¢ ðŸ“¹ Full-length videos\n\n' +
          '`Select your plan:`\n\n';

      const buttons = [];
      plans.forEach((plan) => {
        const planName = lang === 'es' ? (plan.nameEs || plan.name) : plan.name;
        const duration = plan.duration || 30;

        // Format duration nicely
        let durationText;
        if (duration >= 36500) {
          durationText = lang === 'es' ? 'De por vida' : 'Lifetime';
        } else if (duration === 7) {
          durationText = lang === 'es' ? '7 dÃ­as' : '7 days';
        } else if (duration === 30) {
          durationText = lang === 'es' ? '30 dÃ­as' : '30 days';
        } else {
          durationText = lang === 'es' ? `${duration} dÃ­as` : `${duration} days`;
        }

        // Build plan display - icon + name + price
        const icon = plan.icon || 'ðŸ’Ž';
        const priceDisplay = duration >= 36500
          ? `$${plan.price}`
          : `$${plan.price}/${lang === 'es' ? 'mes' : 'mo'}`;

        buttons.push([
          Markup.button.callback(
            `${icon} ${planName} - ${priceDisplay}`,
            `select_plan_${plan.id}`,
          ),
        ]);
      });

      buttons.push([Markup.button.callback(lang === 'es' ? 'ðŸ”™ AtrÃ¡s' : 'ðŸ”™ Back', 'back_to_main')]);

      await ctx.editMessageText(message, {
        parse_mode: 'Markdown',
        ...Markup.inlineKeyboard(buttons),
      });
    } catch (error) {
      logger.error('Error showing subscription plans:', error);
    }
  });

  // Select plan
  bot.action(/^select_plan_(.+)$/, async (ctx) => {
    try {
      // Validate match result exists
      if (!ctx.match || !ctx.match[1]) {
        logger.error('Invalid plan selection action format');
        return;
      }

      const planId = ctx.match[1];
      const lang = getLanguage(ctx);

      ctx.session.temp.selectedPlan = planId;
      await ctx.saveSession();

      // Get plan details for display
      const plan = await PlanModel.getById(planId);
      const planName = plan ? (lang === 'es' ? (plan.nameEs || plan.name) : plan.name) : planId;
      const planPrice = plan ? plan.price : '?';
      const planIcon = plan?.icon || 'ðŸ’Ž';

      const message = lang === 'es'
        ? '`ðŸ’³ MÃ‰TODO DE PAGO`\n\n' +
          `Plan seleccionado: **${planIcon} ${planName}**\n` +
          `Precio: **$${planPrice} USD**\n\n` +
          'Â¿CÃ³mo deseas pagar?\n\n' +
          'ðŸ’³ **Tarjeta** - Visa, Mastercard, PSE\n' +
          'ðŸ“± **Daimo** - Zelle, CashApp, Venmo'
        : '`ðŸ’³ PAYMENT METHOD`\n\n' +
          `Selected plan: **${planIcon} ${planName}**\n` +
          `Price: **$${planPrice} USD**\n\n` +
          'How would you like to pay?\n\n' +
          'ðŸ’³ **Card** - Visa, Mastercard, PSE\n' +
          'ðŸ“± **Daimo** - Zelle, CashApp, Venmo';

      await ctx.editMessageText(
        message,
        {
          parse_mode: 'Markdown',
          ...Markup.inlineKeyboard([
            [Markup.button.callback(lang === 'es' ? 'ðŸ’³ Tarjeta de CrÃ©dito/DÃ©bito' : 'ðŸ’³ Credit/Debit Card', `pay_epayco_${planId}`)],
            [Markup.button.callback(lang === 'es' ? 'ðŸ“± Daimo (Zelle, CashApp, Venmo)' : 'ðŸ“± Daimo (Zelle, CashApp, Venmo)', `pay_daimo_${planId}`)],
            [Markup.button.callback(lang === 'es' ? 'ðŸ”™ AtrÃ¡s' : 'ðŸ”™ Back', 'show_subscription_plans')],
          ]),
        }
      );
    } catch (error) {
      logger.error('Error selecting plan:', error);
    }
  });

  // Pay with ePayco
  bot.action(/^pay_epayco_(.+)$/, async (ctx) => {
    try {
      // Validate match result exists
      if (!ctx.match || !ctx.match[1]) {
        logger.error('Invalid ePayco payment action format');
        return;
      }

      const planId = ctx.match[1];
      const lang = getLanguage(ctx);

      // Validate user context exists
      if (!ctx.from?.id) {
        logger.error('Missing user context in ePayco payment');
        await ctx.reply(t('error', lang));
        return;
      }

      const userId = ctx.from.id;

      await ctx.editMessageText(t('loading', lang));

      const result = await PaymentService.createPayment({
        userId,
        planId,
        provider: 'epayco',
      });

      if (result.success) {
        await ctx.editMessageText(
          t('paymentInstructions', lang, { paymentUrl: result.paymentUrl }),
          Markup.inlineKeyboard([
            [Markup.button.url('ðŸ’³ Pay Now', result.paymentUrl)],
            [Markup.button.callback(t('back', lang), 'show_subscription_plans')],
          ]),
        );
      } else {
        await ctx.editMessageText(
          `${t('error', lang)}\n\n${result.error}`,
          Markup.inlineKeyboard([
            [Markup.button.callback(t('back', lang), 'show_subscription_plans')],
          ]),
        );
      }
    } catch (error) {
      logger.error('Error creating ePayco payment:', error);
    }
  });

  // Pay with Daimo
  bot.action(/^pay_daimo_(.+)$/, async (ctx) => {
    try {
      // Validate match result exists
      if (!ctx.match || !ctx.match[1]) {
        logger.error('Invalid Daimo payment action format');
        return;
      }

      const planId = ctx.match[1];
      const lang = getLanguage(ctx);

      // Validate user context exists
      if (!ctx.from?.id) {
        logger.error('Missing user context in Daimo payment');
        await ctx.reply(t('error', lang));
        return;
      }

      const userId = ctx.from.id;
      const chatId = ctx.chat?.id;

      await ctx.editMessageText(t('loading', lang));

      // Get plan details for display
      const plan = await PlanModel.getById(planId);
      if (!plan) {
        await ctx.editMessageText(
          t('error', lang),
          Markup.inlineKeyboard([
            [Markup.button.callback(t('back', lang), 'show_subscription_plans')],
          ]),
        );
        return;
      }

      const result = await PaymentService.createPayment({
        userId,
        planId,
        provider: 'daimo',
        chatId,
      });

      if (result.success) {
        // Get supported payment apps
        const paymentApps = DaimoConfig.SUPPORTED_PAYMENT_APPS.join(', ');

        const message = lang === 'es'
          ? 'ðŸ’³ *Pago con Daimo Pay*\n\n'
            + `Plan: ${plan.nameEs || plan.name}\n`
            + `Precio: $${plan.price} USDC\n\n`
            + 'ðŸ“± *Puedes pagar usando:*\n'
            + 'â€¢ Zelle\n'
            + 'â€¢ CashApp\n'
            + 'â€¢ Venmo\n'
            + 'â€¢ Revolut\n'
            + 'â€¢ Wise\n\n'
            + 'ðŸ’¡ *CÃ³mo funciona:*\n'
            + '1. Haz clic en "Pagar Ahora"\n'
            + '2. Elige tu app de pago preferida\n'
            + '3. El pago se convierte automÃ¡ticamente a USDC\n'
            + '4. Tu suscripciÃ³n se activa inmediatamente\n\n'
            + 'ðŸ”’ Seguro y rÃ¡pido en la red Optimism'
          : 'ðŸ’³ *Pay with Daimo Pay*\n\n'
            + `Plan: ${plan.name}\n`
            + `Price: $${plan.price} USDC\n\n`
            + 'ðŸ“± *You can pay using:*\n'
            + 'â€¢ Zelle\n'
            + 'â€¢ CashApp\n'
            + 'â€¢ Venmo\n'
            + 'â€¢ Revolut\n'
            + 'â€¢ Wise\n\n'
            + 'ðŸ’¡ *How it works:*\n'
            + '1. Click "Pay Now"\n'
            + '2. Choose your preferred payment app\n'
            + '3. Payment is automatically converted to USDC\n'
            + '4. Your subscription activates immediately\n\n'
            + 'ðŸ”’ Secure and fast on Optimism network';

        await ctx.editMessageText(
          message,
          {
            parse_mode: 'Markdown',
            ...Markup.inlineKeyboard([
              [Markup.button.url('ðŸ’° Pay Now', result.paymentUrl)],
              [Markup.button.callback(t('back', lang), 'show_subscription_plans')],
            ]),
          },
        );
      } else {
        await ctx.editMessageText(
          `${t('error', lang)}\n\n${result.error}`,
          Markup.inlineKeyboard([
            [Markup.button.callback(t('back', lang), 'show_subscription_plans')],
          ]),
        );
      }
    } catch (error) {
      logger.error('Error creating Daimo payment:', error);
      const lang = getLanguage(ctx);
      await ctx.editMessageText(
        t('error', lang),
        Markup.inlineKeyboard([
          [Markup.button.callback(t('back', lang), 'show_subscription_plans')],
        ]),
      ).catch(() => {});
    }
  });
};

module.exports = registerPaymentHandlers;
