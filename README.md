# PNPtv Telegram Bot - Production Ready

A comprehensive, production-ready Telegram bot for PNPtv featuring live streaming, radio, Zoom rooms, subscription payments, and more.

## ğŸŒŸ Features

### Core Functionality
- âœ… **User Onboarding**: Multi-step onboarding with language selection, age verification, and terms acceptance
- ğŸ‘¤ **Profile Management**: Customizable profiles with photos, bios, locations, and interests
- ğŸŒ **Nearby Users**: Geolocation-based user discovery with radius filtering
- ğŸ’ **Subscription System**: Premium plans with ePayco (USD) and Daimo (USDC) payment integration
- ğŸ“» **Radio Streaming**: 24/7 radio with song requests and now playing info
- ğŸ¥ **Zoom Rooms**: Create and join video conference rooms
- ğŸ¤ **Live Streaming**: Start and view live streams (premium feature)
- ğŸ¤– **AI Support**: Cristina AI assistant powered by OpenAI GPT-4
- ğŸ‘¨â€ğŸ’¼ **Admin Panel**: User management, broadcasts, analytics, and plan management

### Technical Features
- ğŸ”’ **Security**: Input validation, rate limiting, Helmet.js, secure sessions
- ğŸŒ **i18n**: Full English/Spanish support with dynamic language switching
- ğŸ“Š **Analytics**: User statistics, revenue tracking, and insights
- ğŸš¨ **Error Tracking**: Sentry integration for production monitoring
- âš¡ **Performance**: Redis caching, optimized PostgreSQL queries with indexes
- ğŸ—„ï¸ **Database**: PostgreSQL with Sequelize ORM for robust data management
- ğŸ³ **Containerization**: Docker and Docker Compose ready
- ğŸ”„ **CI/CD**: GitHub Actions workflow for automated testing and deployment
- ğŸ“ **Logging**: Structured logging with Winston and daily log rotation
- âœ… **Testing**: Jest unit tests with coverage reporting

## ğŸŒˆğŸ”¥ GuÃ­a Oficial â€“ PNP Latino TV & PNPtv Bot

Tu puerta de entrada al universo PNP queer en Telegram

1ï¸âƒ£ **Â¿QuÃ© es PNP Latino TV y quÃ© es el PNPtv Bot?**

PNP Latino TV es una comunidad digital queer para adultos que viven, crean y conectan alrededor de la cultura PNP (Party â€˜n Play), el arte, la mÃºsica, el sexo positivo y la conversaciÃ³n sin tabÃºes.
No somos solo porno. Somos comunidad + tecnologÃ­a + experiencias en vivo.
El PNPtv Bot es el corazÃ³n de todo: un bot de Telegram que te permite acceder a contenidos, salas, playlists, eventos en vivo y herramientas sociales desde un solo lugar.
En esencia, PNP Latino TV es:
âœ¨ Una comunidad gratuita en Telegram  
âœ¨ Una membresÃ­a PRIME para acceso completo  
âœ¨ Un espacio seguro para adultos verificados  
âœ¨ Un laboratorio de experiencias queer digitales

2ï¸âƒ£ **Â¿QuÃ© puedes hacer dentro del PNPtv Bot?**

Dentro del bot vas a encontrar (progresivamente):

ğŸ“ Nearby â€“ Mapa social para ver quiÃ©n estÃ¡ cerca de ti  
ğŸ¥ Hangouts â€“ Salas de video para fumar, hablar, ligar y socializar  
ğŸ¶ Videorama â€“ Playlists, podcasts y contenido curado por la comunidad  
ğŸ“º PNP Live â€“ Shows, performances y transmisiones en vivo  
ğŸ§‘â€ğŸ¤ Perfiles â€“ Tu bio, foto, tribu, links y mood  
ğŸŸ Eventos â€“ Acceso a fiestas virtuales y experiencias especiales

3ï¸âƒ£ **Mini tutorial â€“ CÃ³mo usar el PNPtv Bot (en 1 minuto)**

Paso 1 Entra al bot desde Telegram: ğŸ‘‰ `t.me/pnplatinotv_bot`  
Paso 2 Presiona Start / Iniciar. El bot te pedirÃ¡:
  - Aceptar TÃ©rminos y Condiciones
  - Confirmar que eres +18
  - Elegir idioma (ES / EN)
Paso 3 VerÃ¡s el menÃº principal con botones como:
  - Nearby  
  - Hangouts  
  - Videorama  
  - PNP Live  
  - Mi Perfil  
  - Soporte  
Paso 4 Explora libremente si eres usuario FREE o desbloquea todo con PNPtv PRIME

4ï¸âƒ£ **FREE vs PRIME (simple y sin drama)**

**Usuario FREE**
  - Ver salas pÃºblicas  
  - Unirte a salas abiertas  
  - Escuchar playlists pÃºblicas  
  - Ver previews de contenido  
  - Acceder a eventos abiertos

**Usuario PRIME**
  - Crear salas privadas y pÃºblicas  
  - Acceder a todo Videorama  
  - Ver PNP Live completo  
  - Crear playlists y podcasts  
  - Acceder a eventos exclusivos  
  - Soporte prioritario

5ï¸âƒ£ **ğŸ“† Calendario de Lanzamiento de Features**

(Todo se libera por fases â€“ una por semana)

Estamos lanzando cada mÃ³dulo poco a poco para hacerlo bien, testearlo contigo y pulir la experiencia.

ğŸ”¹ **Fase 1 â€“ Nearby**  
ğŸ“… Lanzamiento: 3 de febrero 2026  
ğŸ“ Mapa social para ver quiÃ©n estÃ¡ cerca  
ğŸ‘¥ Perfiles bÃ¡sicos  
ğŸ§ª Pruebas abiertas con la comunidad

ğŸ”¹ **Fase 2 â€“ Hangouts**  
ğŸ“… Lanzamiento: 10 de febrero 2026  
ğŸ¥ Salas de video pÃºblicas y privadas  
ğŸ”¥ Smoke sessions, chats calientes, afters  
ğŸ§ª Stress test de llamadas y salas

ğŸ”¹ **Fase 3 â€“ Videorama**  
ğŸ“… Lanzamiento: 17 de febrero 2026  
ğŸ¶ Playlists  
ğŸ™ Podcasts  
ğŸ¬ Contenido curado  
ğŸ§ª Pruebas de carga y calidad

ğŸ”¹ **Fase 4 â€“ PNP Live**  
ğŸ“… Lanzamiento: 24 de febrero 2026  
ğŸ“º Shows en vivo  
ğŸ­ Performances  
ğŸ’¬ Chat en tiempo real  
ğŸ§ª Pruebas de transmisiÃ³n

6ï¸âƒ£ **Nota importante sobre el despliegue ğŸ› **

Durante cada semana de lanzamiento:
  - Te vamos a enviar instrucciones simples  
  - Te pediremos que pruebes botones, entres a salas, reportes errores y digas quÃ© se siente raro  
  - Algunas funciones pueden caerse, cambiar de diseÃ±o o reiniciarse
  
Eso es normal. EstÃ¡s dentro del beta queer underground mÃ¡s delicioso de Telegram ğŸ˜ˆ

7ï¸âƒ£ **Soporte & contacto**

Si algo no funciona o tenÃ©s dudas:
  - BotÃ³n Soporte dentro del bot  
  - O DM directo a ğŸ‘‰ `@pnptvadmin`

8ï¸âƒ£ **Cierre vibe PNP**

Esto no es solo una app. Es una experiencia viva que estamos creando con vos.  
Gracias por ser parte del caos creativo, del humo digital y del futuro raro y hermoso de PNP Latino TV.  
ğŸ’œ Santino & Lex PNP Latino TV

## ğŸ—‚ï¸ Flujos y menÃºs actuales

El bot mantiene una experiencia guiada con las acciones principales expuestas desde el menÃº principal. Cada entrada abre secciones dedicadas:

  - `Nearby`: mapa interactivo, discovery social y acciones de perfil inmediato.  
  - `Hangouts`: salas pÃºblicas, privadas y funciones premium para iniciar sesiones.  
  - `Videorama`: listas curadas, podcasts y contenido bajo demanda.  
  - `PNP Live`: acceso a shows y chat en vivo.  
  - `Mi Perfil`: ediciÃ³n de bio, links, fotos y tribu.  
  - `Soporte`: acceso a Cristina AI, soporte humano y documentos Ãºtiles.

Las instrucciones y flujos tambiÃ©n estÃ¡n indexados en la nueva opciÃ³n `ğŸ§  Cristina Asistente Admin` dentro del panel de administradores. Desde ahÃ­:
  - Se alimentan bloques de conocimiento sobre planes (Lex/canal).  
  - Se actualizan precios y estado del bot con un click.  
  - Se activa â€œCristina soy Lexâ€ para obtener estrategias, uso de herramientas y traducciones bajo pedido explÃ­cito.

## ğŸ’³ Pagos: Daimo, Epayco y Meru

El bot soporta mÃºltiples procesadores para cubrir distintas monedas y regiones. Siguen las instrucciones principales:

  - **Daimo (USDC)**: GenerÃ¡ una billetera USDC y enviÃ¡ el monto exacto a la direcciÃ³n indicada en el bot. IncluÃ­ tu `user_id` en la referencia y subÃ­ un comprobante si hay verificaciÃ³n manual.  
  - **Epayco (USD)**: ElegÃ­ el plan desde el menÃº, seleccionÃ¡ Epayco y completÃ¡ los datos de tarjeta o PSE cuando el bot envÃ­a el enlace seguro. La confirmaciÃ³n llega por webhook y se actualiza automÃ¡ticamente tu membresÃ­a.  
  - **Meru (Moneda local)**: Si Meru estÃ¡ habilitado, el bot despliega opciones de pago con puntos o balance. SeleccionÃ¡ el proveedor, confirmÃ¡ el monto y Meru notifica la activaciÃ³n sin salir del flujo de Telegram.

En todos los casos el usuario recibe mensaje de confirmaciÃ³n y, si es necesario, el equipo de soporte puede verificar desde `/support` o el panel admin.

## ğŸ“‹ Prerequisites

- Node.js 18.x or higher
- npm 9.x or higher
- PostgreSQL 14.x or higher
- Redis 7.x
- Telegram Bot Token (from @BotFather)
- (Optional) Sentry account for error tracking
- (Optional) OpenAI API key for AI support
- (Optional) Zoom API credentials
- (Optional) ePayco and Daimo payment provider accounts

## ğŸŸï¸ Lifetime100 Promo Activation Flow

The bot now supports a special Lifetime100 promo activation flow that includes:

### User Flow
1. **Command**: User sends `/lifetime100 CODE123` with their activation code
2. **Validation**: Bot validates the code format and checks if it's a valid lifetime100 promo code
3. **Receipt Request**: Bot requests the user to attach their payment receipt
4. **Receipt Processing**: User uploads a photo or document showing their payment
5. **Admin Review**: Admins review the receipt and manually activate the membership
6. **Activation**: User receives confirmation with the special Lifetime100 activation message

### Admin Flow
1. **Manual Activation**: Admins use `/activate_lifetime100 USERID CODE123` to activate after receipt verification
2. **Automatic Notification**: User receives the activation confirmation with channel invite
3. **Logging**: All activations are logged in Firestore for audit purposes

### Payment Methods
- **Excluded from ePayco/Daimo**: Lifetime100 promo is not available through automated payment processors
- **Manual Payment Only**: Users must purchase through the lifetime100 landing page and provide receipt
- **Receipt Storage**: All receipts are stored in Firestore collection `lifetime100Receipts`

## ğŸš€ Quick Start

### 1. Clone and Install

```bash
git clone https://github.com/yourusername/pnptv-bot.git
cd pnptv-bot
npm install
```

### 2. Environment Configuration

Copy the example environment file and configure:

```bash
cp .env.example .env
```

Edit `.env` with your credentials (see Environment Variables section below).

### 3. Setup Database

Run migrations and seed data:

```bash
# Run database migrations
npm run db:migrate

# Seed default plans
npm run db:seed
```

### 4. Run Development Server

```bash
npm run dev
```

### 5. Run with Docker

```bash
# Start all services (PostgreSQL, Redis, Bot)
docker-compose up -d

# Run migrations
docker-compose exec bot npm run db:migrate

# Seed database
docker-compose exec bot npm run db:seed
```

## ğŸ”§ Environment Variables

### Required Variables

```env
BOT_TOKEN=your_telegram_bot_token
NODE_ENV=development
PORT=3000

# PostgreSQL
DB_HOST=localhost
DB_PORT=5432
DB_NAME=pnptv_bot
DB_USER=postgres
DB_PASSWORD=your_secure_password

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
```

### Optional Variables

See `.env.example` for the complete list of configuration options including:
- Payment providers (ePayco, Daimo)
- Zoom API credentials
- OpenAI API key
- Sentry DSN
- Admin user IDs
- Rate limiting settings

## ğŸ“ Project Structure

```
pnptvbot-production/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ bot/
â”‚   â”‚   â”œâ”€â”€ core/              # Bot initialization and middleware
â”‚   â”‚   â”‚   â”œâ”€â”€ bot.js         # Main bot entry point
â”‚   â”‚   â”‚   â”œâ”€â”€ middleware/    # Session, rate limiting, error handling
â”‚   â”‚   â”‚   â””â”€â”€ plugins/       # Sentry integration
â”‚   â”‚   â”œâ”€â”€ handlers/          # Command and callback handlers
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/         # Admin panel
â”‚   â”‚   â”‚   â”œâ”€â”€ user/          # User commands (onboarding, profile, menu)
â”‚   â”‚   â”‚   â”œâ”€â”€ payments/      # Payment processing
â”‚   â”‚   â”‚   â””â”€â”€ media/         # Radio, Zoom, live streams, support
â”‚   â”‚   â”œâ”€â”€ services/          # Business logic layer
â”‚   â”‚   â”‚   â”œâ”€â”€ userService.js
â”‚   â”‚   â”‚   â””â”€â”€ paymentService.js
â”‚   â”‚   â””â”€â”€ api/               # REST API and webhooks
â”‚   â”‚       â”œâ”€â”€ routes.js
â”‚   â”‚       â””â”€â”€ controllers/
â”‚   â”œâ”€â”€ models/                # Data models (PostgreSQL/Sequelize)
â”‚   â”‚   â”œâ”€â”€ userModel.js
â”‚   â”‚   â”œâ”€â”€ planModel.js
â”‚   â”‚   â””â”€â”€ paymentModel.js
â”‚   â”œâ”€â”€ utils/                 # Utilities
â”‚   â”‚   â”œâ”€â”€ i18n.js           # Internationalization
â”‚   â”‚   â”œâ”€â”€ validation.js     # Input validation
â”‚   â”‚   â””â”€â”€ logger.js         # Logging
â”‚   â””â”€â”€ config/                # Configuration
â”‚       â”œâ”€â”€ database.js
â”‚       â””â”€â”€ redis.js
â”œâ”€â”€ scripts/                   # Utility scripts
â”‚   â”œâ”€â”€ cron.js               # Scheduled tasks
â”‚   â””â”€â”€ seed.js               # Database seeding
â”œâ”€â”€ tests/                     # Test files
â”‚   â”œâ”€â”€ unit/
â”‚   â””â”€â”€ integration/
â”œâ”€â”€ logs/                      # Application logs
â”œâ”€â”€ docs/                      # Documentation
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

## ğŸ® Bot Commands

### User Commands
- `/start` - Start the bot and begin onboarding
- `/menu` - Show main menu
- `/language` - Change language
- `/support` - Access support center

### Admin Commands
- `/admin` - Access admin panel (requires admin privileges)

## ğŸ“± Main Menu Options

1. **ğŸ’ Subscribe to PRIME** - View and purchase subscription plans
2. **ğŸ‘¤ My Profile** - Manage profile, photos, bio, location
3. **ğŸŒ Nearby Users** - Find users within selected radius
4. **ğŸ¤ Live Streams** - Start or view live streams
5. **ğŸ“» Radio** - Listen to radio, request songs
6. **ğŸ¥ Zoom Rooms** - Create or join video rooms
7. **ğŸ¤– Support** - AI chat, contact admin, FAQs
8. **âš™ï¸ Settings** - Language, notifications, privacy

## ğŸ” Security Features

- **Input Sanitization**: All user inputs are sanitized to prevent XSS and injection attacks
- **Rate Limiting**: Protection against spam and abuse
- **Session Management**: Secure Redis-based sessions with TTL
- **Payment Verification**: Webhook signature verification for payments
- **Admin Authorization**: Role-based access control
- **Environment Variables**: Sensitive data stored securely
- **Helmet.js**: Security headers for API endpoints

## ğŸ§ª Testing

Run tests:

```bash
# Unit tests
npm test

# Watch mode
npm run test:watch

# Integration tests
npm run test:integration

# Coverage
npm test -- --coverage
```

## ğŸ“Š Monitoring and Logging

### Logging

Logs are stored in the `logs/` directory:
- `combined-YYYY-MM-DD.log` - All logs
- `error-YYYY-MM-DD.log` - Error logs only

Logs rotate daily and are kept for 14 days.

### Error Tracking

Sentry integration provides:
- Real-time error tracking
- User context (ID, username, action)
- Stack traces and breadcrumbs
- Performance monitoring

### Health Check

```bash
curl http://localhost:3000/health
```

## ğŸš¢ Deployment

### Docker Deployment

1. Build and run with Docker Compose:

```bash
docker-compose up -d
```

2. View logs:

```bash
docker-compose logs -f bot
```

3. Stop:

```bash
docker-compose down
```

### Production Deployment

1. Set environment to production in `.env`:

```env
NODE_ENV=production
BOT_WEBHOOK_DOMAIN=https://yourdomain.com
BOT_WEBHOOK_PATH=/pnp/webhook/telegram
```

2. Configure webhook mode in production for better performance

3. Set up GitHub Actions secrets for CI/CD:
   - `DOCKER_USERNAME`
   - `DOCKER_PASSWORD`
   - `PRODUCTION_HOST`
   - `PRODUCTION_USER`
   - `PRODUCTION_SSH_KEY`

4. Push to main branch to trigger deployment

## ğŸ“ˆ Scaling Considerations

- **Redis Cluster**: For high availability and horizontal scaling
- **Load Balancer**: Distribute traffic across multiple bot instances
- **PostgreSQL Optimization**: Use composite indexes, connection pooling, and query optimization
- **CDN**: Serve static assets (images, media) via CDN
- **Caching Strategy**: Cache frequently accessed data with appropriate TTLs
- **Queue System**: Implement message queue for broadcasts and background jobs

## ğŸ› ï¸ Maintenance

### Cron Jobs

The bot includes automated cron jobs (configured in `scripts/cron.js`):

- **Subscription Expiry Check**: Runs daily at midnight
- Processes expired subscriptions and updates user status

### Database Maintenance

- Regularly review and optimize PostgreSQL indexes
- Monitor database performance with pg_stat_statements
- Implement regular backup strategy (pg_dump or continuous archiving)
- Monitor database size and implement data retention policies

## ğŸ› Troubleshooting

### Bot Not Responding

1. Check logs: `docker-compose logs -f bot`
2. Verify bot token is correct
3. Check Redis connection
4. Verify webhook is set correctly (production)

### Payment Issues

1. Check webhook configuration and URLs
2. Verify payment provider credentials
3. Review payment logs in PostgreSQL database
4. Check webhook signature verification

### Performance Issues

1. Monitor Redis cache hit rate
2. Review PostgreSQL query performance with EXPLAIN ANALYZE
3. Check for memory leaks
4. Analyze error rates in Sentry

## ğŸ“ API Documentation

### Webhooks

#### ePayco Webhook
```
POST /api/webhooks/epayco
```

Receives payment confirmation from ePayco.

#### Daimo Webhook
```
POST /api/webhooks/daimo
```

Receives payment confirmation from Daimo.

### Public Endpoints

#### Health Check
```
GET /health
```

Returns bot health status.

#### Statistics
```
GET /api/stats
```

Returns user statistics (public).

## ğŸ¤ Contributing

1. Fork the repository
2. Create a feature branch: `git checkout -b feature/new-feature`
3. Commit changes: `git commit -am 'Add new feature'`
4. Push to branch: `git push origin feature/new-feature`
5. Submit a pull request

## ğŸ“„ License

This project is licensed under the MIT License.

## ğŸ‘¥ Support

For support and questions:
- Email: support@pnptv.com
- Telegram: @pnptv_support
- Documentation: https://docs.pnptv.com

## ğŸ™ Acknowledgments

- Telegraf.js - Modern Telegram Bot Framework
- PostgreSQL - Robust relational database
- Sequelize - ORM for database operations
- Redis - Caching and sessions
- OpenAI - AI assistant
- Sentry - Error tracking

---

Built with â¤ï¸ for PNPtv
