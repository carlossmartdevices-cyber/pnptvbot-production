<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Restablecer contraseña – PNPtv</title>
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #120d14; color: #fff; font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 24px; }
    .glow { position: fixed; top: -200px; left: 50%; transform: translateX(-50%); width: 500px; height: 500px; background: radial-gradient(circle, rgba(255,0,204,0.15) 0%, transparent 70%); pointer-events: none; }
    .card { position: relative; z-index: 1; background: #2C2C2E; border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 40px 36px; width: 100%; max-width: 400px; box-shadow: 0 24px 80px rgba(0,0,0,0.5); }
    .logo img { width: 80px; height: 80px; object-fit: contain; display: block; margin: 0 auto 12px; }
    h1 { font-size: 22px; font-weight: 800; text-align: center; margin-bottom: 6px; }
    .sub { text-align: center; color: #8E8E93; font-size: 14px; margin-bottom: 24px; }
    .banner { padding: 10px 14px; border-radius: 10px; font-size: 13px; margin-bottom: 16px; display: none; }
    .banner.error   { background: rgba(255,69,58,0.15);  border: 1px solid rgba(255,69,58,0.4);  color: #ff453a; display: block; }
    .banner.success { background: rgba(48,209,88,0.12);  border: 1px solid rgba(48,209,88,0.35); color: #30d158; display: block; }
    input[type="password"] { width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px; padding: 12px 14px; color: #fff; font-size: 14px; font-family: inherit; outline: none; margin-bottom: 10px; transition: border-color 0.15s; }
    input:focus { border-color: rgba(255,0,204,0.5); }
    input::placeholder { color: #8E8E93; }
    .btn { display: flex; align-items: center; justify-content: center; width: 100%; padding: 13px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; border: none; background: linear-gradient(135deg, #ff3377, #8A00FF); color: #fff; margin-top: 4px; transition: opacity 0.15s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .back { display: block; text-align: center; margin-top: 16px; font-size: 13px; color: #ff9933; text-decoration: none; }
    .back:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="glow"></div>
  <div class="card">
    <div class="logo"><img src="/logo.png" alt="PNPtv" /></div>
    <h1>Nueva contraseña</h1>
    <p class="sub">Elige una contraseña segura de al menos 8 caracteres.</p>

    <div id="banner"></div>

    <div id="form-section">
      <input type="password" id="password"  placeholder="Nueva contraseña" autocomplete="new-password" />
      <input type="password" id="password2" placeholder="Confirmar contraseña" autocomplete="new-password" />
      <button class="btn" id="btn-save" onclick="handleSave()">Guardar contraseña</button>
    </div>

    <a href="/" class="back">← Volver al inicio</a>
  </div>

  <script>
    const token = new URLSearchParams(location.search).get('token');
    if (!token) {
      document.getElementById('banner').className = 'banner error';
      document.getElementById('banner').textContent = 'Enlace inválido. Solicita uno nuevo.';
      document.getElementById('form-section').style.display = 'none';
    }

    async function handleSave() {
      const pw  = document.getElementById('password').value;
      const pw2 = document.getElementById('password2').value;
      const btn = document.getElementById('btn-save');
      const banner = document.getElementById('banner');
      banner.className = 'banner';
      banner.textContent = '';

      if (!pw || !pw2)   { banner.className = 'banner error'; banner.textContent = 'Completa ambos campos.'; return; }
      if (pw !== pw2)    { banner.className = 'banner error'; banner.textContent = 'Las contraseñas no coinciden.'; return; }
      if (pw.length < 8) { banner.className = 'banner error'; banner.textContent = 'Mínimo 8 caracteres.'; return; }

      btn.disabled = true;
      btn.textContent = 'Guardando...';
      try {
        const res  = await fetch('/api/webapp/auth/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ token, password: pw }),
        });
        const data = await res.json();
        if (res.ok && data.success) {
          banner.className = 'banner success';
          banner.textContent = '¡Contraseña actualizada! Redirigiendo al login...';
          document.getElementById('form-section').style.display = 'none';
          setTimeout(() => { location.href = '/'; }, 2000);
        } else {
          banner.className = 'banner error';
          banner.textContent = data.error || 'Error al guardar. Solicita un nuevo enlace.';
          btn.disabled = false;
          btn.textContent = 'Guardar contraseña';
        }
      } catch {
        banner.className = 'banner error';
        banner.textContent = 'Error de red. Intenta de nuevo.';
        btn.disabled = false;
        btn.textContent = 'Guardar contraseña';
      }
    }

    document.addEventListener('keydown', e => { if (e.key === 'Enter') handleSave(); });
  </script>
</body>
</html>
