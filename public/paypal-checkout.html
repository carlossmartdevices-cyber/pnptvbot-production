<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNPtv - PayPal Checkout</title>
  <!-- PayPal SDK will be loaded dynamically after fetching client ID -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0070ba 0%, #003087 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 600px;
      width: 100%;
      overflow: hidden;
      animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .header {
      background: linear-gradient(135deg, #0070ba 0%, #003087 100%);
      color: white;
      padding: 40px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .header p {
      font-size: 16px;
      opacity: 0.95;
    }

    .paypal-logo {
      width: 120px;
      height: auto;
      margin-bottom: 20px;
      filter: brightness(0) invert(1);
    }

    .content {
      padding: 40px;
    }

    .plan-details {
      background: #f8f9ff;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      border: 2px solid #e0e7ff;
    }

    .plan-name {
      font-size: 24px;
      font-weight: 600;
      color: #0070ba;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .plan-name i {
      color: #0070ba;
    }

    .plan-price {
      font-size: 36px;
      font-weight: 700;
      color: #003087;
      margin: 20px 0;
    }

    .plan-price span {
      font-size: 18px;
      font-weight: 400;
      color: #666;
    }

    .plan-description {
      color: #555;
      line-height: 1.8;
      margin-top: 15px;
      font-size: 15px;
    }

    .features {
      list-style: none;
      margin-top: 20px;
    }

    .features li {
      padding: 10px 0;
      color: #444;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .features li::before {
      content: "✓";
      color: #0070ba;
      font-weight: bold;
      font-size: 18px;
    }

    .divider {
      height: 1px;
      background: linear-gradient(to right, transparent, #ddd, transparent);
      margin: 30px 0;
    }

    #paypal-button-container {
      margin: 30px 0;
    }

    .security-badges {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .security-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #666;
      font-size: 14px;
    }

    .security-badge i {
      color: #0070ba;
      font-size: 20px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0070ba;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
    }

    .success {
      background: #efe;
      border: 1px solid #cfc;
      color: #3c3;
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      display: none;
    }

    .info-box {
      background: #e8f4fd;
      border-left: 4px solid #0070ba;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .info-box h3 {
      color: #0070ba;
      margin-bottom: 10px;
      font-size: 18px;
    }

    .info-box p {
      color: #555;
      line-height: 1.6;
      font-size: 14px;
    }

    @media (max-width: 600px) {
      .header h1 {
        font-size: 24px;
      }

      .plan-price {
        font-size: 28px;
      }

      .security-badges {
        flex-direction: column;
        gap: 10px;
      }

      .content {
        padding: 25px;
      }
    }

    .cancel-button {
      display: block;
      text-align: center;
      margin-top: 20px;
      padding: 12px;
      color: #666;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .cancel-button:hover {
      background: #f5f5f5;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <svg class="paypal-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 32">
        <path fill="currentColor" d="M35.9 10.6c-.3-1.9-1.8-3.2-3.9-3.2h-9.8c-.7 0-1.3.5-1.4 1.2l-4.1 25.9c-.1.4.2.8.7.8h4.9c.7 0 1.3-.5 1.4-1.2l1.1-7.1c.1-.7.7-1.2 1.4-1.2h3.2c6.7 0 10.5-3.2 11.5-9.6.4-2.8 0-5-1.3-6.5-.4-.5-1-.9-1.7-1.1zm-6.5 9.4c-.5 3.5-3.2 3.5-5.8 3.5h-1.5l1-6.5c.1-.4.4-.7.8-.7h.7c1.8 0 3.5 0 4.4 1 .5.6.7 1.5.4 2.7z"/>
      </svg>
      <h1 id="pageTitle">Complete Your Subscription</h1>
      <p>Secure payment powered by PayPal</p>
    </div>

    <div class="content">
      <div id="loading" class="loading">
        <div class="loading-spinner"></div>
        <p>Loading payment details...</p>
      </div>

      <div id="error" class="error"></div>
      <div id="success" class="success"></div>

      <div id="paymentContent" style="display: none;">
        <div class="plan-details">
          <div class="plan-name">
            <i class="fas fa-crown"></i>
            <span id="planName">Loading...</span>
          </div>
          <div class="plan-price">
            $<span id="planPrice">0.00</span> <span id="planDuration"></span>
          </div>
          <div class="plan-description" id="planDescription">
            Loading plan details...
          </div>
          <ul class="features" id="planFeatures"></ul>
        </div>

        <div class="divider"></div>

        <!-- PayPal Button Container -->
        <div id="paypal-button-container"></div>

        <div class="info-box">
          <h3><i class="fas fa-shield-alt"></i> Secure Payment</h3>
          <p>
            Your payment is processed securely through PayPal. You can pay using your PayPal balance,
            credit card, debit card, or bank account. Your financial information is never shared with us.
          </p>
        </div>

        <div class="security-badges">
          <div class="security-badge">
            <i class="fas fa-lock"></i>
            <span>256-bit SSL</span>
          </div>
          <div class="security-badge">
            <i class="fas fa-shield-alt"></i>
            <span>Buyer Protection</span>
          </div>
          <div class="security-badge">
            <i class="fas fa-credit-card"></i>
            <span>Secure Payment</span>
          </div>
        </div>

        <a href="#" id="cancelButton" class="cancel-button">
          <i class="fas fa-arrow-left"></i> Return to plans
        </a>
      </div>
    </div>
  </div>

  <script>
    // Get payment ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const paymentId = window.location.pathname.split('/').pop();
    const lang = urlParams.get('lang') || 'en';

    // Translations
    const translations = {
      en: {
        pageTitle: 'Complete Your Subscription',
        loading: 'Loading payment details...',
        days: 'days',
        perMonth: '/ month',
        securePayment: 'Secure Payment',
        securePaymentDesc: 'Your payment is processed securely through PayPal. You can pay using your PayPal balance, credit card, debit card, or bank account. Your financial information is never shared with us.',
        returnToPlans: 'Return to plans',
        paymentSuccess: 'Payment Successful! Redirecting...',
        paymentError: 'Payment failed. Please try again.',
        loadError: 'Failed to load payment details. Please try again.'
      },
      es: {
        pageTitle: 'Completa Tu Suscripción',
        loading: 'Cargando detalles del pago...',
        days: 'días',
        perMonth: '/ mes',
        securePayment: 'Pago Seguro',
        securePaymentDesc: 'Tu pago se procesa de forma segura a través de PayPal. Puedes pagar usando tu saldo de PayPal, tarjeta de crédito, tarjeta de débito o cuenta bancaria. Tu información financiera nunca se comparte con nosotros.',
        returnToPlans: 'Volver a planes',
        paymentSuccess: '¡Pago Exitoso! Redirigiendo...',
        paymentError: 'Pago fallido. Por favor intenta de nuevo.',
        loadError: 'Error al cargar detalles del pago. Por favor intenta de nuevo.'
      }
    };

    const t = translations[lang];

    // Update page language
    document.getElementById('pageTitle').textContent = t.pageTitle;
    document.querySelector('#loading p').textContent = t.loading;

    // Utility function to escape HTML and prevent XSS
    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      const div = document.createElement('div');
      div.textContent = unsafe;
      return div.innerHTML;
    }

    function loadPayPalSDK(clientId) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&currency=USD`;
        script.onload = () => {
          console.log('PayPal SDK loaded successfully');
          resolve();
        };
        script.onerror = () => {
          console.error('Failed to load PayPal SDK');
          reject(new Error('Failed to load PayPal SDK'));
        };
        document.head.appendChild(script);
      });
    }

    async function loadPaymentDetails() {
      try {
        const response = await fetch(`/api/payment/${paymentId}`);
        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error(data.error || t.loadError);
        }

        const payment = data.payment;

        // Update UI with payment details
        document.getElementById('planName').textContent = payment.plan.name;
        document.getElementById('planPrice').textContent = parseFloat(payment.amountUSD).toFixed(2);
        document.getElementById('planDuration').textContent = payment.plan.duration ? `/ ${payment.plan.duration} ${t.days}` : t.perMonth;
        document.getElementById('planDescription').textContent = payment.plan.description || '';

        // Add features
        if (payment.plan.features && payment.plan.features.length > 0) {
          const featuresHtml = payment.plan.features.map(feature => `<li>${escapeHtml(feature)}</li>`).join('');
          document.getElementById('planFeatures').innerHTML = featuresHtml;
        }

        // Load PayPal SDK with client ID
        const clientId = payment.paypalClientId;
        if (!clientId) {
          throw new Error('PayPal client ID not available');
        }

        // Dynamically load PayPal SDK
        await loadPayPalSDK(clientId);

        // Hide loading, show content
        document.getElementById('loading').style.display = 'none';
        document.getElementById('paymentContent').style.display = 'block';

        // Initialize PayPal button
        initPayPalButton(payment.amountUSD, payment.paymentId);
      } catch (error) {
        console.error('Error loading payment:', error);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').textContent = error.message;
        document.getElementById('error').style.display = 'block';
      }
    }

    function initPayPalButton(amount, paymentId) {
      paypal.Buttons({
        style: {
          layout: 'vertical',
          color: 'blue',
          shape: 'rect',
          label: 'paypal'
        },
        createOrder: function(data, actions) {
          return fetch(`/api/paypal/create-order`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              paymentId: paymentId
            })
          })
          .then(response => response.json())
          .then(order => order.orderId);
        },
        onApprove: function(data, actions) {
          return fetch(`/api/paypal/capture-order`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              orderId: data.orderID,
              paymentId: paymentId
            })
          })
          .then(response => response.json())
          .then(result => {
            if (result.success) {
              document.getElementById('success').textContent = t.paymentSuccess;
              document.getElementById('success').style.display = 'block';

              // Redirect to success page or Telegram bot
              setTimeout(() => {
                window.location.href = `https://t.me/${result.botUsername || 'pnptvbot'}`;
              }, 2000);
            } else {
              throw new Error(result.error);
            }
          })
          .catch(error => {
            console.error('Error capturing payment:', error);
            document.getElementById('error').textContent = t.paymentError;
            document.getElementById('error').style.display = 'block';
          });
        },
        onError: function(err) {
          console.error('PayPal error:', err);
          document.getElementById('error').textContent = t.paymentError;
          document.getElementById('error').style.display = 'block';
        }
      }).render('#paypal-button-container');
    }

    // Cancel button
    document.getElementById('cancelButton').addEventListener('click', function(e) {
      e.preventDefault();
      window.history.back();
    });

    // Load payment details on page load
    loadPaymentDetails();
  </script>
</body>
</html>
