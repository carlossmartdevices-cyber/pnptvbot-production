<body>
    <!-- Explicit Consent Modal -->
    <div class="consent-modal active" id="consentModal">
        <div class="consent-content">
            <h2>üîí Privacy & Consent Notice</h2>

            <p><strong>Before we proceed, please review what happens with your data:</strong></p>

            <div class="data-handling">
                <strong>‚úì What We Do:</strong>
                <ul style="margin: 8px 0 0 0;">
                    <li>Analyze your selfie in real-time using AI</li>
                    <li>Estimate age from facial features</li>
                    <li>Store only: age estimate, confidence score, verification date</li>
                </ul>
            </div>

            <div class="data-handling">
                <strong>‚úì What We DON'T Do:</strong>
                <ul style="margin: 8px 0 0 0;">
                    <li>Never store facial images or photos</li>
                    <li>Never share data with third parties</li>
                    <li>Photo deleted immediately after analysis</li>
                    <li>No facial recognition for identification</li>
                </ul>
            </div>

            <p><strong>Technology Used:</strong></p>
            <ul>
                <li>Face++ AI (HTTPS encrypted transmission)</li>
                <li>Local browser processing (device handles camera)</li>
                <li>Secure connection verified by certificate</li>
            </ul>

            <p style="font-size: 12px; color: #999; margin-top: 15px;">
                By clicking "I Understand & Consent", you agree that:
                <br>‚Ä¢ Your camera data is processed for age verification only
                <br>‚Ä¢ You understand data handling practices
                <br>‚Ä¢ You agree to our <a href="https://pnptv.app/privacy" target="_blank" style="color: var(--accent);">Privacy Policy</a>
            </p>

            <div class="consent-buttons">
                <button class="btn-decline" id="declineBtn">Decline</button>
                <button class="btn-accept" id="acceptConsentBtn">‚úì I Understand & Consent</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <h1>üîí Age Verification</h1>
        <p class="subtitle">Device Camera Verification</p>

        <!-- Privacy Notice -->
        <div class="privacy-notice">
            <strong>üîê Your Privacy is Protected:</strong><br>
            Your photo is analyzed in real-time and deleted immediately. We never store facial images.
        </div>

        <!-- Instructions -->
        <div class="instructions" id="instructions">
            <div class="instruction-item">Take a clear selfie</div>
            <div class="instruction-item">Ensure good lighting</div>
            <div class="instruction-item">Look directly at camera</div>
            <div class="instruction-item">No filters or effects</div>
        </div>

        <!-- Camera Section -->
        <div class="camera-section">
            <video id="cameraFeed" autoplay playsinline></video>
            <canvas id="captureCanvas"></canvas>

            <!-- Loader -->
            <div class="loader" id="loader">
                <div class="spinner"></div>
                <p>Analyzing your photo with AI...</p>
            </div>

            <!-- Result Display -->
            <div class="result-box hidden" id="resultBox">
                <h3 id="resultStatus">Verifying...</h3>
                <p id="resultMessage"></p>
            </div>

            <!-- Info Box -->
            <div class="info-box" id="infoBox"></div>
        </div>

        <!-- Control Buttons -->
        <div class="button-group" id="controlButtons">
            <button class="btn-primary" id="captureBtn">üì∏ Capture Photo</button>
            <button class="btn-secondary" id="switchBtn">üîÑ Switch Camera</button>
        </div>

        <div class="button-group hidden" id="resultButtons">
            <button class="btn-success" id="acceptBtn">‚úÖ Verify & Continue</button>
            <button class="btn-danger" id="retryBtn">üîÑ Try Again</button>
        </div>

        <button class="btn-secondary" id="manualBtn" style="width: 100%; margin-top: 10px;">
            Skip to Manual Verification
        </button>

        <!-- Footer -->
        <div class="footer-text">
            By continuing, you agree to our <a href="https://pnptv.app/privacy" target="_blank">Privacy Policy</a>
            and <a href="https://pnptv.app/terms" target="_blank">Terms of Service</a>
        </div>
    </div>

    <script>
        const TELEGRAM_BOT_TOKEN = new URLSearchParams(window.location.search).get('token');
        const USER_ID = new URLSearchParams(window.location.search).get('user_id');
        const LANGUAGE = new URLSearchParams(window.location.search).get('lang') || 'en';

        const consentModal = document.getElementById('consentModal');
        const mainContainer = document.getElementById('mainContainer');
        const acceptConsentBtn = document.getElementById('acceptConsentBtn');
        const declineBtn = document.getElementById('declineBtn');

        const video = document.getElementById('cameraFeed');
        const canvas = document.getElementById('captureCanvas');
        const loader = document.getElementById('loader');
        const resultBox = document.getElementById('resultBox');
        const captureBtn = document.getElementById('captureBtn');
        const switchBtn = document.getElementById('switchBtn');
        const manualBtn = document.getElementById('manualBtn');
        const acceptBtn = document.getElementById('acceptBtn');
        const retryBtn = document.getElementById('retryBtn');
        const infoBox = document.getElementById('infoBox');

        let stream = null;
        let currentFacingMode = 'user';
        let verificationResult = null;
        let consentGiven = false;

        // Handle consent acceptance
        acceptConsentBtn.addEventListener('click', () => {
            consentGiven = true;
            localStorage.setItem('ageVerificationConsent', 'true');
            consentModal.classList.remove('active');
            mainContainer.style.display = 'block';
            initCamera();
        });

        // Handle consent decline
        declineBtn.addEventListener('click', () => {
            alert('You must consent to age verification to continue.');
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                Telegram.WebApp.close();
            } else {
                window.location.href = 'tg://resolve?domain=pnplatinotv_bot';
            }
        });

        // Check if consent was previously given (within session)
        function checkConsent() {
            if (localStorage.getItem('ageVerificationConsent') === 'true') {
                consentGiven = true;
                consentModal.classList.remove('active');
                mainContainer.style.display = 'block';
            }
        }

        // Initialize camera only after consent
        async function initCamera() {
            if (!consentGiven) {
                return;
            }

            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode },
                    audio: false
                });
                video.srcObject = stream;
                video.play();
                updateInfoBox('success', '‚úì Camera ready. Tap capture when you\'re ready.');
            } catch (error) {
                updateInfoBox('error', '‚úó Camera access denied. Please enable camera permissions and refresh.');
                captureBtn.disabled = true;
                console.error('Camera error:', error);
            }
        }

        // Capture photo
        captureBtn.addEventListener('click', async () => {
            if (!stream) {
                updateInfoBox('error', '‚úó Camera not ready');
                return;
            }

            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            // Convert canvas to blob
            canvas.toBlob(async (blob) => {
                await verifyAge(blob);
            }, 'image/jpeg', 0.9);
        });

        // Switch camera
        switchBtn.addEventListener('click', async () => {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            await initCamera();
        });

        // Manual verification fallback
        manualBtn.addEventListener('click', () => {
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                Telegram.WebApp.sendData('manual_verification');
            } else {
                window.location.href = `tg://resolve?domain=pnplatinotv_bot&start=age_manual`;
            }
        });

        // Verify age with AI
        async function verifyAge(photoBlob) {
            loader.classList.add('active');
            captureBtn.disabled = true;
            switchBtn.disabled = true;

            try {
                // Send to backend for AI verification
                const formData = new FormData();
                formData.append('photo', photoBlob);
                formData.append('user_id', USER_ID);
                formData.append('lang', LANGUAGE);

                const response = await fetch('/api/verify-age', {
                    method: 'POST',
                    body: formData
                });

                let result = null;
                try {
                    result = await response.json();
                } catch (parseError) {
                    result = {
                        success: false,
                        message: 'Verification service error. Please try again in a moment.'
                    };
                }
                if (!response.ok) {
                    result = result || { success: false };
                    result.success = false;
                    if (!result.message) {
                        result.message = 'We could not process your photo. Please try again or use manual verification.';
                    }
                }
                verificationResult = result;

                if (result.success && result.ageVerified) {
                    loader.classList.remove('active');
                    showResult(true, '‚úÖ Age Verified!', 'You have been verified as 18 or older.');
                    document.getElementById('controlButtons').classList.add('hidden');
                    document.getElementById('resultButtons').classList.remove('hidden');
                } else {
                    const failureMessage = result?.message || result?.error || 'We could not verify your age. Please try again or use manual verification.';
                    loader.classList.remove('active');
                    showResult(false, '‚ùå Verification Failed', failureMessage);
                    document.getElementById('controlButtons').classList.remove('hidden');
                    document.getElementById('resultButtons').classList.add('hidden');
                    captureBtn.disabled = false;
                    switchBtn.disabled = false;
                }
            } catch (error) {
                loader.classList.remove('active');
                updateInfoBox('error', '‚úó Verification error: ' + error.message);
                captureBtn.disabled = false;
                switchBtn.disabled = false;
                console.error('Verification error:', error);
            }
        }

        // Show result
        function showResult(success, status, message) {
            resultBox.classList.remove('hidden');
            document.getElementById('resultStatus').textContent = status;
            document.getElementById('resultMessage').textContent = message;
            resultBox.className = resultBox.className.replace('error success', '') + (success ? ' success' : ' error');
        }

        // Update info box
        function updateInfoBox(type, message) {
            infoBox.textContent = message;
            infoBox.className = 'info-box ' + type;
        }

        // Accept verification
        acceptBtn.addEventListener('click', () => {
            if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
                Telegram.WebApp.sendData('age_verified:' + verificationResult.estimatedAge);
            } else {
                alert('Age verified! Redirecting...');
                window.location.href = `tg://resolve?domain=pnplatinotv_bot&start=age_verified`;
            }
        });

        // Retry
        retryBtn.addEventListener('click', () => {
            resultBox.classList.add('hidden');
            document.getElementById('controlButtons').classList.remove('hidden');
            document.getElementById('resultButtons').classList.add('hidden');
            captureBtn.disabled = false;
            switchBtn.disabled = false;
            updateInfoBox('success', 'Ready to try again. Tap capture when ready.');
        });

        // Initialize on load
        window.addEventListener('load', () => {
            checkConsent();
            // Only init camera if consent already given, otherwise user must click accept
            if (consentGiven) {
                initCamera();
            }
        });

        // Cleanup on unload
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // Handle Telegram WebApp
        if (typeof Telegram !== 'undefined' && Telegram.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }

        // Add page visibility to pause/resume stream
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        });
    </script>
</body>
</html>
