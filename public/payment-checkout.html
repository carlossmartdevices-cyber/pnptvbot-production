<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Secure Checkout - EasyBots</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://checkout.epayco.co/checkout.js"></script>
    <script src="https://multimedia.epayco.co/general/3DS/validateThreeds.min.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1A1A1D;
            color: #FFFFFF;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 24px 0 20px;
            text-align: center;
        }
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .header-logo svg { width: 36px; height: 36px; }
        .header-logo span {
            font-size: 22px;
            font-weight: 700;
            color: #FFFFFF;
            letter-spacing: -0.3px;
        }
        .header-subtitle {
            font-size: 14px;
            color: #888;
            font-weight: 400;
        }

        .content { flex: 1; padding-bottom: 24px; }

        .loading { text-align: center; padding: 60px 20px; }
        .spinner {
            border: 3px solid #2A2A2D;
            border-top: 3px solid #FFF700;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { font-size: 14px; color: #888; }

        .plan-card {
            background: #222225;
            border-radius: 12px;
            padding: 16px 18px;
            margin-bottom: 24px;
            border-left: 3px solid #FFF700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .plan-left { display: flex; align-items: center; gap: 10px; }
        .plan-icon { font-size: 20px; }
        .plan-name { font-size: 15px; font-weight: 600; color: #FFF; }
        .plan-price { font-size: 22px; font-weight: 700; color: #FFF700; }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-brand {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            background: #2A2A2D;
            color: #FFF700;
            text-transform: none;
            letter-spacing: 0;
        }

        .form-group { margin-bottom: 14px; }
        .form-group label {
            display: block;
            font-size: 13px;
            color: #AAA;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 14px;
            background: #2A2A2D;
            color: #FFFFFF;
            border: 1px solid #3A3A3D;
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color 0.2s;
            -webkit-appearance: none;
            min-height: 48px;
        }
        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%23888'%3E%3Cpath d='M1 1l5 5 5-5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #FFF700;
            box-shadow: 0 0 0 2px rgba(255, 247, 0, 0.15);
        }
        .form-group input::placeholder { color: #555; }
        .form-group input.invalid { border-color: #ff4444; }
        .form-group input.valid { border-color: #44bb44; }

        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }

        .pay-button {
            width: 100%;
            padding: 16px;
            background: #FFF700;
            color: #1A1A1D;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: transform 0.15s, opacity 0.15s;
            margin-top: 20px;
            min-height: 52px;
        }
        .pay-button:active:not(:disabled) { transform: scale(0.98); }
        .pay-button:disabled {
            background: #2A2A2D;
            color: #555;
            cursor: not-allowed;
        }

        .error-msg {
            background: rgba(255, 68, 68, 0.1);
            color: #ff6666;
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 14px;
            text-align: center;
            font-size: 14px;
            border: 1px solid rgba(255, 68, 68, 0.2);
        }

        .success-msg {
            background: rgba(68, 187, 68, 0.1);
            color: #44bb44;
            padding: 28px 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(68, 187, 68, 0.2);
        }
        .success-msg h2 { font-size: 20px; margin-bottom: 10px; }
        .success-msg p { font-size: 14px; color: #888; margin: 6px 0; }

        .pending-msg {
            background: rgba(255, 247, 0, 0.08);
            color: #FFF700;
            padding: 28px 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 247, 0, 0.2);
        }
        .pending-msg h2 { font-size: 20px; margin-bottom: 10px; }
        .pending-msg p { font-size: 14px; color: #888; margin: 6px 0; }

        .footer {
            padding: 16px 0 24px;
            text-align: center;
            border-top: 1px solid #2A2A2D;
        }
        .footer-badge {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 16px;
        }
        .footer-links a {
            font-size: 12px;
            color: #888;
            text-decoration: none;
        }
        .footer-links a:hover { color: #FFF700; }

        .polling-status {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }
        .polling-status .spinner {
            width: 30px; height: 30px;
            margin: 0 auto 12px;
        }
        .polling-status p { font-size: 14px; color: #888; }

        .back-link { text-align: center; margin-top: 14px; }
        .back-link a { color: #888; text-decoration: none; font-size: 13px; }
        .back-link a:hover { color: #FFF700; }

        .divider { height: 1px; background: #2A2A2D; margin: 20px 0; }

        .terms-notice {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 16px;
            line-height: 1.5;
        }
        .terms-notice a { color: #FFF700; text-decoration: none; }
        .terms-notice a:hover { text-decoration: underline; }

        .lang-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #2A2A2D;
            border: 1px solid #3A3A3D;
            color: #AAA;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
        }
        .lang-toggle:hover { color: #FFF700; border-color: #FFF700; }
    </style>
</head>
<body>
    <div class="container" style="position: relative;">
        <button class="lang-toggle" id="lang-toggle" onclick="toggleLang()">ES</button>

        <header class="header">
            <div class="header-logo">
                <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="36" height="36" rx="8" fill="#FFF700"/>
                    <path d="M10 8C10 6.9 10.9 6 12 6H24C25.1 6 26 6.9 26 8V20C26 21.1 25.1 22 24 22H20L14 28V22H12C10.9 22 10 21.1 10 20V8Z" fill="#1A1A1D"/>
                    <path d="M19.5 9L16 16H19L17 23L22 14.5H18.5L19.5 9Z" fill="#FFF700"/>
                </svg>
                <span>EasyBots</span>
            </div>
            <p class="header-subtitle" data-i18n="subtitle"></p>
        </header>

        <main class="content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p data-i18n="loading"></p>
            </div>

            <div id="error" style="display: none;"></div>

            <div id="checkout-form" style="display: none;">
                <div class="plan-card">
                    <div class="plan-left">
                        <span class="plan-icon" id="plan-icon"></span>
                        <span class="plan-name" id="plan-name"></span>
                    </div>
                    <span class="plan-price">$<span id="plan-price-usd">0</span></span>
                </div>

                <div class="section-title">
                    <span data-i18n="cardDetails"></span>
                    <span class="card-brand" id="card-brand" style="display: none;"></span>
                </div>

                <div class="form-group">
                    <label data-i18n="cardNumber"></label>
                    <input type="text" id="cardNumber" placeholder="4575 6231 8229 0326" maxlength="19" inputmode="numeric" autocomplete="cc-number">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="month"></label>
                        <select id="expMonth" autocomplete="cc-exp-month">
                            <option value="">MM</option>
                            <option value="01">01</option><option value="02">02</option>
                            <option value="03">03</option><option value="04">04</option>
                            <option value="05">05</option><option value="06">06</option>
                            <option value="07">07</option><option value="08">08</option>
                            <option value="09">09</option><option value="10">10</option>
                            <option value="11">11</option><option value="12">12</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="year"></label>
                        <select id="expYear" autocomplete="cc-exp-year"></select>
                    </div>
                    <div class="form-group">
                        <label>CVC</label>
                        <input type="text" id="cvc" placeholder="123" maxlength="4" inputmode="numeric" autocomplete="cc-csc">
                    </div>
                </div>

                <div class="divider"></div>

                <div class="section-title"><span data-i18n="personalInfo"></span></div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="firstName"></label>
                        <input type="text" id="name" placeholder="Juan" autocomplete="given-name">
                    </div>
                    <div class="form-group">
                        <label data-i18n="lastName"></label>
                        <input type="text" id="lastName" placeholder="Perez" autocomplete="family-name">
                    </div>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="correo@ejemplo.com" autocomplete="email">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="docType"></label>
                        <select id="docType">
                            <option value="CC">CC</option>
                            <option value="CE">CE</option>
                            <option value="NIT">NIT</option>
                            <option value="PP" data-i18n-opt="passport"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="docNumber"></label>
                        <input type="text" id="docNumber" placeholder="1234567890" inputmode="numeric">
                    </div>
                </div>

                <div id="form-error" class="error-msg" style="display: none;"></div>

                <p class="terms-notice" id="terms-notice"></p>

                <button id="pay-button" class="pay-button" data-i18n="pay"></button>

                <div class="back-link">
                    <a href="#" onclick="window.close(); return false;" data-i18n="backToBot"></a>
                </div>
            </div>

            <div id="polling-status" class="polling-status">
                <div class="spinner"></div>
                <p data-i18n="verifying"></p>
            </div>

            <div id="success" class="success-msg" style="display: none;">
                <h2 data-i18n="successTitle"></h2>
                <p data-i18n="successMsg1"></p>
                <p data-i18n="successMsg2"></p>
            </div>

            <div id="pending" class="pending-msg" style="display: none;">
                <h2 data-i18n="pendingTitle"></h2>
                <p data-i18n="pendingMsg1"></p>
                <p data-i18n="pendingMsg2"></p>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-badge" data-i18n="securedBy"></div>
            <div class="footer-links">
                <a href="/terms" data-i18n="terms"></a>
                <a href="/contact" data-i18n="contact"></a>
            </div>
        </footer>
    </div>

    <script>
        // ── i18n ──
        var I = {
            en: {
                subtitle: 'Secure Checkout',
                loading: 'Loading payment info...',
                cardDetails: 'Card Details',
                cardNumber: 'Card Number',
                month: 'Month',
                year: 'Year',
                personalInfo: 'Personal Info',
                firstName: 'First Name',
                lastName: 'Last Name',
                docType: 'Doc Type',
                docNumber: 'Document Number',
                passport: 'Passport',
                pay: 'Pay',
                payAmount: 'Pay ${amount} USD',
                backToBot: 'Return to bot',
                verifying: 'Verifying payment status...',
                successTitle: 'Payment Approved',
                successMsg1: 'Your subscription has been activated.',
                successMsg2: 'Check the Telegram bot for your access link.',
                pendingTitle: 'Payment Pending',
                pendingMsg1: "Your payment is being processed. You'll receive confirmation shortly.",
                pendingMsg2: 'Check the Telegram bot in a few minutes.',
                securedBy: 'Secured by ePayco',
                terms: 'Terms',
                contact: 'Contact',
                tokenizing: 'Tokenizing card...',
                processing: 'Processing payment...',
                errCardInvalid: 'Enter a valid card number.',
                errCardLuhn: 'Invalid card number. Check the digits.',
                errExpDate: 'Select the expiration date.',
                errExpired: 'Card is expired.',
                errCvc: 'Enter the CVC code ({n} digits).',
                errName: 'Enter your first name.',
                errEmail: 'Enter a valid email.',
                errDoc: 'Enter your document number.',
                errTokenize: 'Error tokenizing card.',
                errDeclined: 'Payment was declined. Try another card.',
                errConnection: 'Connection error. Please try again.',
                errLoadPayment: 'Could not load payment info',
                errLoadGeneric: 'Error loading payment',
                errVerify: 'Error verifying payment status.',
                errEpaycoKey: 'Could not load ePayco public key.',
                errEpaycoScript: 'ePayco script did not load correctly.',
                errEpaycoToken: 'ePayco tokenization function is not available.',
                errTokenGen: 'Could not generate token.',
                termsNotice: 'By proceeding, you agree to our <a href="/terms">Terms & Conditions</a> and <a href="/terms#data">Data Treatment Policy</a>.',
            },
            es: {
                subtitle: 'Pago Seguro',
                loading: 'Cargando informaci\u00f3n del pago...',
                cardDetails: 'Datos de Tarjeta',
                cardNumber: 'N\u00famero de Tarjeta',
                month: 'Mes',
                year: 'A\u00f1o',
                personalInfo: 'Datos Personales',
                firstName: 'Nombre',
                lastName: 'Apellido',
                docType: 'Tipo Doc.',
                docNumber: 'N\u00famero de Documento',
                passport: 'Pasaporte',
                pay: 'Pagar',
                payAmount: 'Pagar ${amount} USD',
                backToBot: 'Volver al bot',
                verifying: 'Verificando el estado del pago...',
                successTitle: 'Pago Aprobado',
                successMsg1: 'Tu suscripci\u00f3n ha sido activada.',
                successMsg2: 'Revisa el bot de Telegram para tu enlace de acceso.',
                pendingTitle: 'Pago Pendiente',
                pendingMsg1: 'Tu pago est\u00e1 siendo procesado. Recibir\u00e1s confirmaci\u00f3n pronto.',
                pendingMsg2: 'Revisa el bot de Telegram en unos minutos.',
                securedBy: 'Pago seguro procesado por ePayco',
                terms: 'T\u00e9rminos',
                contact: 'Contacto',
                tokenizing: 'Tokenizando tarjeta...',
                processing: 'Procesando pago...',
                errCardInvalid: 'Ingresa un n\u00famero de tarjeta v\u00e1lido.',
                errCardLuhn: 'N\u00famero de tarjeta inv\u00e1lido. Verifica los d\u00edgitos.',
                errExpDate: 'Selecciona la fecha de vencimiento.',
                errExpired: 'La tarjeta est\u00e1 vencida.',
                errCvc: 'Ingresa el c\u00f3digo CVC ({n} d\u00edgitos).',
                errName: 'Ingresa tu nombre.',
                errEmail: 'Ingresa un email v\u00e1lido.',
                errDoc: 'Ingresa tu n\u00famero de documento.',
                errTokenize: 'Error al tokenizar la tarjeta.',
                errDeclined: 'El pago fue rechazado. Intenta con otra tarjeta.',
                errConnection: 'Error de conexi\u00f3n. Intenta nuevamente.',
                errLoadPayment: 'No se pudo cargar la informaci\u00f3n del pago',
                errLoadGeneric: 'Error al cargar el pago',
                errVerify: 'Error al verificar el estado del pago.',
                errEpaycoKey: 'No se pudo cargar la clave p\u00fablica de ePayco.',
                errEpaycoScript: 'El script de ePayco no se carg\u00f3 correctamente.',
                errEpaycoToken: 'La funci\u00f3n de tokenizaci\u00f3n de ePayco no est\u00e1 disponible.',
                errTokenGen: 'No se pudo generar el token.',
                termsNotice: 'Al continuar, aceptas nuestros <a href="/terms">T\u00e9rminos y Condiciones</a> y la <a href="/terms#data">Pol\u00edtica de Tratamiento de Datos</a>.',
            }
        };

        var lang = (navigator.language || '').startsWith('es') ? 'es' : 'en';

        function t(key) { return (I[lang] && I[lang][key]) || I.en[key] || key; }

        function applyLang() {
            document.documentElement.lang = lang;
            document.getElementById('lang-toggle').textContent = lang === 'en' ? 'ES' : 'EN';
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
                el.textContent = t(el.getAttribute('data-i18n'));
            });
            document.querySelectorAll('[data-i18n-opt]').forEach(function(el) {
                el.textContent = t(el.getAttribute('data-i18n-opt'));
            });
            // Update terms notice (uses innerHTML for links)
            var tn = document.getElementById('terms-notice');
            if (tn) tn.innerHTML = t('termsNotice');
            // Update pay button if payment loaded
            if (paymentData) {
                var btn = document.getElementById('pay-button');
                if (!btn.disabled) {
                    btn.textContent = t('payAmount').replace('${amount}', '$' + paymentData.amountUSD.toFixed(2));
                }
            }
        }

        function toggleLang() {
            lang = lang === 'en' ? 'es' : 'en';
            applyLang();
        }

        // ── Payment logic ──
        const pathParts = window.location.pathname.split('/');
        const paymentId = pathParts[pathParts.length - 1];
        let paymentData = null;
        let epaycoTokenClient = null;

        const createEpaycoClient = () => {
            if (epaycoTokenClient) return epaycoTokenClient;
            if (!paymentData || !paymentData.epaycoPublicKey) {
                throw new Error(t('errEpaycoKey'));
            }

            const sdk = window.ePayco || window.Epayco || window.epayco;
            if (!sdk) {
                throw new Error(t('errEpaycoScript'));
            }

            if (typeof sdk.setPublicKey === 'function') {
                sdk.setPublicKey(paymentData.epaycoPublicKey);
            }

            if (!sdk.token || typeof sdk.token.create !== 'function') {
                throw new Error(t('errEpaycoToken'));
            }

            epaycoTokenClient = sdk;
            return epaycoTokenClient;
        };

        const tokenizeCard = (payload) => {
            const client = createEpaycoClient();
            return new Promise((resolve, reject) => {
                const result = client.token.create(payload, function(error, token) {
                    if (error) {
                        reject(new Error(typeof error === 'string' ? error : (error.message || t('errTokenize'))));
                        return;
                    }
                    if (!token || !token.id) {
                        reject(new Error(token?.description || t('errTokenGen')));
                        return;
                    }
                    resolve(token);
                });
                if (result && typeof result.then === 'function') {
                    result.then(function(token) {
                        if (!token || !token.id) {
                            reject(new Error(token?.description || t('errTokenGen')));
                            return;
                        }
                        resolve(token);
                    }).catch(reject);
                }
            });
        };

        function detectCardBrand(number) {
            var n = number.replace(/\s/g, '');
            if (/^4/.test(n)) return 'Visa';
            if (/^5[1-5]/.test(n) || /^2[2-7]/.test(n)) return 'Mastercard';
            if (/^3[47]/.test(n)) return 'Amex';
            if (/^3(0[0-5]|[68])/.test(n)) return 'Diners';
            return '';
        }

        function luhnCheck(number) {
            var n = number.replace(/\s/g, '');
            if (!/^\d{13,19}$/.test(n)) return false;
            var sum = 0;
            var alternate = false;
            for (var i = n.length - 1; i >= 0; i--) {
                var digit = parseInt(n[i], 10);
                if (alternate) {
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                sum += digit;
                alternate = !alternate;
            }
            return sum % 10 === 0;
        }

        var yearSelect = document.getElementById('expYear');
        var currentYear = new Date().getFullYear();
        var opt0 = document.createElement('option');
        opt0.value = ''; opt0.textContent = lang === 'es' ? 'AAAA' : 'YYYY';
        yearSelect.appendChild(opt0);
        for (var y = currentYear; y <= currentYear + 10; y++) {
            var opt = document.createElement('option');
            opt.value = String(y); opt.textContent = String(y);
            yearSelect.appendChild(opt);
        }

        document.getElementById('cardNumber').addEventListener('input', function(e) {
            var v = e.target.value.replace(/\D/g, '').substring(0, 16);
            e.target.value = v.replace(/(\d{4})(?=\d)/g, '$1 ');

            var brand = detectCardBrand(v);
            var brandEl = document.getElementById('card-brand');
            if (brand && v.length >= 2) {
                brandEl.textContent = brand;
                brandEl.style.display = 'inline';
            } else {
                brandEl.style.display = 'none';
            }

            if (v.length >= 13) {
                if (luhnCheck(v)) {
                    e.target.classList.remove('invalid');
                    e.target.classList.add('valid');
                } else {
                    e.target.classList.remove('valid');
                    e.target.classList.add('invalid');
                }
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });

        document.getElementById('cvc').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
        });

        function payBtnLabel() {
            return t('payAmount').replace('${amount}', '$' + paymentData.amountUSD.toFixed(2));
        }

        async function loadPaymentInfo() {
            try {
                var response = await fetch('/api/payment/' + paymentId);
                if (!response.ok) throw new Error(t('errLoadPayment'));
                var data = await response.json();
                if (!data.success) throw new Error(data.error || t('errLoadGeneric'));
                paymentData = data.payment;
                try {
                    createEpaycoClient();
                } catch (initError) {
                    showError(initError.message);
                    return;
                }
                displayPaymentInfo();
            } catch (error) {
                showError(error.message || t('errLoadPayment'));
            }
        }

        function displayPaymentInfo() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('checkout-form').style.display = 'block';
            document.getElementById('plan-icon').textContent = paymentData.plan.icon || '';
            document.getElementById('plan-name').textContent = paymentData.plan.name;
            document.getElementById('plan-price-usd').textContent = paymentData.amountUSD.toFixed(2);

            var btn = document.getElementById('pay-button');
            btn.textContent = payBtnLabel();
        }

        document.getElementById('pay-button').addEventListener('click', async function() {
            const btn = document.getElementById('pay-button');
            const errDiv = document.getElementById('form-error');
            errDiv.style.display = 'none';

            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expMonth = document.getElementById('expMonth').value;
            const expYear = document.getElementById('expYear').value;
            const cvc = document.getElementById('cvc').value;
            const name = document.getElementById('name').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const docType = document.getElementById('docType').value;
            const docNumber = document.getElementById('docNumber').value.trim();

            if (!cardNumber || cardNumber.length < 13) {
                return showFormError(t('errCardInvalid'));
            }
            if (!luhnCheck(cardNumber)) {
                return showFormError(t('errCardLuhn'));
            }
            if (!expMonth || !expYear) {
                return showFormError(t('errExpDate'));
            }
            const now = new Date();
            const expDate = new Date(parseInt(expYear, 10), parseInt(expMonth, 10) - 1);
            if (expDate < new Date(now.getFullYear(), now.getMonth())) {
                return showFormError(t('errExpired'));
            }
            const brand = detectCardBrand(cardNumber);
            const expectedCvcLen = brand === 'Amex' ? 4 : 3;
            if (!cvc || cvc.length < expectedCvcLen) {
                return showFormError(t('errCvc').replace('{n}', expectedCvcLen));
            }
            if (!name) return showFormError(t('errName'));
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                return showFormError(t('errEmail'));
            }
            if (!docNumber) return showFormError(t('errDoc'));

            btn.disabled = true;
            btn.textContent = t('tokenizing');

            let tokenResult;
            try {
                tokenResult = await tokenizeCard({
                    'card[number]': cardNumber,
                    'card[exp_year]': expYear,
                    'card[exp_month]': expMonth.padStart ? expMonth.padStart(2, '0') : expMonth,
                    'card[cvc]': cvc,
                    'card[name]': `${name} ${lastName || ''}`.trim(),
                    'card[email]': email,
                    doc_type: docType,
                    doc_number: docNumber,
                    hasCvv: true,
                });
            } catch (tokenError) {
                showFormError(tokenError.message || t('errTokenize'));
                btn.disabled = false;
                btn.textContent = payBtnLabel();
                return;
            }

            btn.textContent = t('processing');

            try {
                const response = await fetch('/api/payment/tokenized-charge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentId,
                        tokenCard: tokenResult.id,
                        name,
                        lastName: lastName || name,
                        email,
                        docType,
                        docNumber,
                        city: 'Bogota',
                        address: 'N/A',
                        phone: '',
                        dues: '1',
                    }),
                });

                const result = await response.json();

                if (result.success && result.status === 'approved') {
                    document.getElementById('checkout-form').style.display = 'none';
                    document.getElementById('success').style.display = 'block';
                } else if (result.status === 'pending') {
                    if (result.redirectUrl) {
                        window.location.href = result.redirectUrl;
                        return;
                    }
                    document.getElementById('checkout-form').style.display = 'none';
                    pollPaymentStatus();
                } else {
                    showFormError(result.error || t('errDeclined'));
                    btn.disabled = false;
                    btn.textContent = payBtnLabel();
                }
            } catch (error) {
                showFormError(t('errConnection'));
                btn.disabled = false;
                btn.textContent = payBtnLabel();
            }
        });

        var pollAttempts = 0;
        var maxPollAttempts = 10;
        var pollInterval = 3000;
        var polling = false;

        function pollPaymentStatus() {
            if (polling) return;
            polling = true;
            pollAttempts = 0;

            document.getElementById('checkout-form').style.display = 'none';
            document.getElementById('polling-status').style.display = 'block';

            doPoll();
        }

        function doPoll() {
            if (pollAttempts >= maxPollAttempts) {
                document.getElementById('polling-status').style.display = 'none';
                document.getElementById('pending').style.display = 'block';
                polling = false;
                return;
            }

            pollAttempts++;

            fetch('/api/payment/' + paymentId + '/status')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (!data.success) {
                        document.getElementById('polling-status').style.display = 'none';
                        showError(t('errVerify'));
                        polling = false;
                        return;
                    }

                    if (data.status === 'completed') {
                        document.getElementById('polling-status').style.display = 'none';
                        document.getElementById('success').style.display = 'block';
                        polling = false;
                    } else if (data.status === 'failed' || data.status === 'rejected') {
                        document.getElementById('polling-status').style.display = 'none';
                        document.getElementById('checkout-form').style.display = 'block';
                        showFormError(t('errDeclined'));
                        var btn = document.getElementById('pay-button');
                        btn.disabled = false;
                        btn.textContent = payBtnLabel();
                        polling = false;
                    } else {
                        setTimeout(doPoll, pollInterval);
                    }
                })
                .catch(function() {
                    setTimeout(doPoll, pollInterval);
                });
        }

        // Apply language on load
        applyLang();

        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('ref_payco') || urlParams.get('transactionID')) {
            document.getElementById('loading').style.display = 'none';
            pollPaymentStatus();
        } else {
            loadPaymentInfo();
        }

        function showFormError(msg) {
            var errDiv = document.getElementById('form-error');
            errDiv.textContent = msg;
            errDiv.style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            var errorDiv = document.getElementById('error');
            errorDiv.className = 'error-msg';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>
