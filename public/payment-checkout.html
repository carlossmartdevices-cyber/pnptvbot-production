<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Secure Checkout - EasyBots</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://checkout.epayco.co/epayco.min.js" onerror="window.__epaycoLoadFailed=true"></script>
    <script src="https://multimedia.epayco.co/general/3DS/validateThreeds.min.js"></script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1A1A1D;
            color: #FFFFFF;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 0 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            padding: 24px 0 20px;
            text-align: center;
        }
        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        .header-logo svg { width: 36px; height: 36px; }
        .header-logo span {
            font-size: 22px;
            font-weight: 700;
            color: #FFFFFF;
            letter-spacing: -0.3px;
        }
        .header-subtitle {
            font-size: 14px;
            color: #888;
            font-weight: 400;
        }

        .content { flex: 1; padding-bottom: 24px; }

        .loading { text-align: center; padding: 60px 20px; }
        .spinner {
            border: 3px solid #2A2A2D;
            border-top: 3px solid #FFF700;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading p { font-size: 14px; color: #888; }

        .plan-card {
            background: #222225;
            border-radius: 12px;
            padding: 16px 18px;
            margin-bottom: 24px;
            border-left: 3px solid #FFF700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .plan-left { display: flex; align-items: center; gap: 10px; }
        .plan-icon { font-size: 20px; }
        .plan-name { font-size: 15px; font-weight: 600; color: #FFF; }
        .plan-price { font-size: 22px; font-weight: 700; color: #FFF700; }

        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 0 0 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-brand {
            font-size: 12px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            background: #2A2A2D;
            color: #FFF700;
            text-transform: none;
            letter-spacing: 0;
        }

        .form-group { margin-bottom: 14px; }
        .form-group label {
            display: block;
            font-size: 13px;
            color: #AAA;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 14px;
            background: #2A2A2D;
            color: #FFFFFF;
            border: 1px solid #3A3A3D;
            border-radius: 8px;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            outline: none;
            transition: border-color 0.2s;
            -webkit-appearance: none;
            min-height: 48px;
        }
        .form-group select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' fill='%23888'%3E%3Cpath d='M1 1l5 5 5-5'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #FFF700;
            box-shadow: 0 0 0 2px rgba(255, 247, 0, 0.15);
        }
        .form-group input::placeholder { color: #555; }
        .form-group input.invalid { border-color: #ff4444; }
        .form-group input.valid { border-color: #44bb44; }

        .form-row { display: flex; gap: 10px; }
        .form-row .form-group { flex: 1; }

        .pay-button {
            width: 100%;
            padding: 16px;
            background: #FFF700;
            color: #1A1A1D;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            cursor: pointer;
            transition: transform 0.15s, opacity 0.15s;
            margin-top: 20px;
            min-height: 52px;
        }
        .pay-button:active:not(:disabled) { transform: scale(0.98); }
        .pay-button:disabled {
            background: #2A2A2D;
            color: #555;
            cursor: not-allowed;
        }

        .error-msg {
            background: rgba(255, 68, 68, 0.1);
            color: #ff6666;
            padding: 12px 14px;
            border-radius: 8px;
            margin-bottom: 14px;
            text-align: center;
            font-size: 14px;
            border: 1px solid rgba(255, 68, 68, 0.2);
        }

        .success-msg {
            background: rgba(68, 187, 68, 0.1);
            color: #44bb44;
            padding: 28px 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(68, 187, 68, 0.2);
        }
        .success-msg h2 { font-size: 20px; margin-bottom: 10px; }
        .success-msg p { font-size: 14px; color: #888; margin: 6px 0; }

        .pending-msg {
            background: rgba(255, 247, 0, 0.08);
            color: #FFF700;
            padding: 28px 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 247, 0, 0.2);
        }
        .pending-msg h2 { font-size: 20px; margin-bottom: 10px; }
        .pending-msg p { font-size: 14px; color: #888; margin: 6px 0; }

        .footer {
            padding: 16px 0 24px;
            text-align: center;
            border-top: 1px solid #2A2A2D;
        }
        .footer-badge {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 16px;
        }
        .footer-links a {
            font-size: 12px;
            color: #888;
            text-decoration: none;
        }
        .footer-links a:hover { color: #FFF700; }

        .polling-status {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }
        .polling-status .spinner {
            width: 30px; height: 30px;
            margin: 0 auto 12px;
        }
        .polling-status p { font-size: 14px; color: #888; }

        .back-link { text-align: center; margin-top: 14px; }
        .back-link a { color: #888; text-decoration: none; font-size: 13px; }
        .back-link a:hover { color: #FFF700; }

        .divider { height: 1px; background: #2A2A2D; margin: 20px 0; }

        .terms-notice {
            font-size: 12px;
            color: #888;
            text-align: center;
            margin-top: 16px;
            line-height: 1.5;
        }
        .terms-notice a { color: #FFF700; text-decoration: none; }
        .terms-notice a:hover { text-decoration: underline; }

        .lang-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            background: #2A2A2D;
            border: 1px solid #3A3A3D;
            color: #AAA;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
        }
        .lang-toggle:hover { color: #FFF700; border-color: #FFF700; }
    </style>
</head>
<body>
    <div class="container" style="position: relative;">
        <button class="lang-toggle" id="lang-toggle" onclick="toggleLang()">ES</button>

        <header class="header">
            <div class="header-logo">
                <svg viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="36" height="36" rx="8" fill="#FFF700"/>
                    <path d="M10 8C10 6.9 10.9 6 12 6H24C25.1 6 26 6.9 26 8V20C26 21.1 25.1 22 24 22H20L14 28V22H12C10.9 22 10 21.1 10 20V8Z" fill="#1A1A1D"/>
                    <path d="M19.5 9L16 16H19L17 23L22 14.5H18.5L19.5 9Z" fill="#FFF700"/>
                </svg>
                <span>EasyBots</span>
            </div>
            <p class="header-subtitle" data-i18n="subtitle"></p>
        </header>

        <main class="content">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p data-i18n="loading"></p>
            </div>

            <div id="error" style="display: none;"></div>

            <div id="checkout-form" style="display: none;">
                <div class="plan-card">
                    <div class="plan-left">
                        <span class="plan-icon" id="plan-icon"></span>
                        <span class="plan-name" id="plan-name"></span>
                    </div>
                    <span class="plan-price">$<span id="plan-price-usd">0</span></span>
                </div>

                <div class="section-title">
                    <span data-i18n="cardDetails"></span>
                    <span class="card-brand" id="card-brand" style="display: none;"></span>
                </div>

                <div class="form-group">
                    <label data-i18n="cardNumber"></label>
                    <input type="text" id="cardNumber" placeholder="4575 6231 8229 0326" maxlength="19" inputmode="numeric" autocomplete="cc-number">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="month"></label>
                        <select id="expMonth" autocomplete="cc-exp-month">
                            <option value="">MM</option>
                            <option value="01">01</option><option value="02">02</option>
                            <option value="03">03</option><option value="04">04</option>
                            <option value="05">05</option><option value="06">06</option>
                            <option value="07">07</option><option value="08">08</option>
                            <option value="09">09</option><option value="10">10</option>
                            <option value="11">11</option><option value="12">12</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="year"></label>
                        <select id="expYear" autocomplete="cc-exp-year"></select>
                    </div>
                    <div class="form-group">
                        <label>CVC</label>
                        <input type="text" id="cvc" placeholder="123" maxlength="4" inputmode="numeric" autocomplete="cc-csc">
                    </div>
                </div>

                <div class="divider"></div>

                <div class="section-title"><span data-i18n="personalInfo"></span></div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="firstName"></label>
                        <input type="text" id="name" placeholder="Juan" autocomplete="given-name">
                    </div>
                    <div class="form-group">
                        <label data-i18n="lastName"></label>
                        <input type="text" id="lastName" placeholder="Perez" autocomplete="family-name">
                    </div>
                </div>

                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="correo@ejemplo.com" autocomplete="email">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label data-i18n="docType"></label>
                        <select id="docType">
                            <option value="CC">CC</option>
                            <option value="CE">CE</option>
                            <option value="NIT">NIT</option>
                            <option value="PP" data-i18n-opt="passport"></option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label data-i18n="docNumber"></label>
                        <input type="text" id="docNumber" placeholder="1234567890" inputmode="numeric">
                    </div>
                </div>

                <div id="form-error" class="error-msg" style="display: none;"></div>

                <p class="terms-notice" id="terms-notice"></p>

                <button id="pay-button" class="pay-button" data-i18n="pay"></button>

                <div class="back-link">
                    <a href="#" onclick="window.close(); return false;" data-i18n="backToBot"></a>
                </div>
            </div>

            <div id="polling-status" class="polling-status">
                <div class="spinner"></div>
                <p data-i18n="verifying"></p>
            </div>

            <div id="success" class="success-msg" style="display: none;">
                <h2 data-i18n="successTitle"></h2>
                <p data-i18n="successMsg1"></p>
                <p data-i18n="successMsg2"></p>
            </div>

            <div id="pending" class="pending-msg" style="display: none;">
                <h2 data-i18n="pendingTitle"></h2>
                <p data-i18n="pendingMsg1"></p>
                <p data-i18n="pendingMsg2"></p>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-badge" data-i18n="securedBy"></div>
            <div class="footer-links">
                <a href="/terms" data-i18n="terms"></a>
                <a href="/contact" data-i18n="contact"></a>
            </div>
        </footer>
    </div>

    <script>
        // ── i18n ──
        var I = {
            en: {
                subtitle: 'Secure Checkout',
                loading: 'Loading payment info...',
                cardDetails: 'Card Details',
                cardNumber: 'Card Number',
                month: 'Month',
                year: 'Year',
                personalInfo: 'Personal Info',
                firstName: 'First Name',
                lastName: 'Last Name',
                docType: 'Doc Type',
                docNumber: 'Document Number',
                passport: 'Passport',
                pay: 'Pay',
                payAmount: 'Pay ${amount} USD',
                backToBot: 'Return to bot',
                verifying: 'Verifying payment status...',
                successTitle: 'Payment Approved',
                successMsg1: 'Your subscription has been activated.',
                successMsg2: 'Check the Telegram bot for your access link.',
                pendingTitle: 'Payment Pending',
                pendingMsg1: "Your payment is being processed. You'll receive confirmation shortly.",
                pendingMsg2: 'Check the Telegram bot in a few minutes.',
                securedBy: 'Secured by ePayco',
                terms: 'Terms',
                contact: 'Contact',
                processing: 'Processing payment...',
                errCardInvalid: 'Enter a valid card number.',
                errCardLuhn: 'Invalid card number. Check the digits.',
                errExpDate: 'Select the expiration date.',
                errExpired: 'Card is expired.',
                errCvc: 'Enter the CVC code ({n} digits).',
                errName: 'Enter your first name.',
                errEmail: 'Enter a valid email.',
                errDoc: 'Enter your document number.',
                errDeclined: 'Payment was declined. Try another card.',
                errConnection: 'Connection error. Please try again.',
                errLoadPayment: 'Could not load payment info',
                errLoadGeneric: 'Error loading payment',
                errVerify: 'Error verifying payment status.',
                termsNotice: 'By proceeding, you agree to our <a href="/terms">Terms & Conditions</a> and <a href="/terms#data">Data Treatment Policy</a>.',
            },
            es: {
                subtitle: 'Pago Seguro',
                loading: 'Cargando informaci\u00f3n del pago...',
                cardDetails: 'Datos de Tarjeta',
                cardNumber: 'N\u00famero de Tarjeta',
                month: 'Mes',
                year: 'A\u00f1o',
                personalInfo: 'Datos Personales',
                firstName: 'Nombre',
                lastName: 'Apellido',
                docType: 'Tipo Doc.',
                docNumber: 'N\u00famero de Documento',
                passport: 'Pasaporte',
                pay: 'Pagar',
                payAmount: 'Pagar ${amount} USD',
                backToBot: 'Volver al bot',
                verifying: 'Verificando el estado del pago...',
                successTitle: 'Pago Aprobado',
                successMsg1: 'Tu suscripci\u00f3n ha sido activada.',
                successMsg2: 'Revisa el bot de Telegram para tu enlace de acceso.',
                pendingTitle: 'Pago Pendiente',
                pendingMsg1: 'Tu pago est\u00e1 siendo procesado. Recibir\u00e1s confirmaci\u00f3n pronto.',
                pendingMsg2: 'Revisa el bot de Telegram en unos minutos.',
                securedBy: 'Pago seguro procesado por ePayco',
                terms: 'T\u00e9rminos',
                contact: 'Contacto',
                processing: 'Procesando pago...',
                errCardInvalid: 'Ingresa un n\u00famero de tarjeta v\u00e1lido.',
                errCardLuhn: 'N\u00famero de tarjeta inv\u00e1lido. Verifica los d\u00edgitos.',
                errExpDate: 'Selecciona la fecha de vencimiento.',
                errExpired: 'La tarjeta est\u00e1 vencida.',
                errCvc: 'Ingresa el c\u00f3digo CVC ({n} d\u00edgitos).',
                errName: 'Ingresa tu nombre.',
                errEmail: 'Ingresa un email v\u00e1lido.',
                errDoc: 'Ingresa tu n\u00famero de documento.',
                errDeclined: 'El pago fue rechazado. Intenta con otra tarjeta.',
                errConnection: 'Error de conexi\u00f3n. Intenta nuevamente.',
                errLoadPayment: 'No se pudo cargar la informaci\u00f3n del pago',
                errLoadGeneric: 'Error al cargar el pago',
                errVerify: 'Error al verificar el estado del pago.',
                termsNotice: 'Al continuar, aceptas nuestros <a href="/terms">T\u00e9rminos y Condiciones</a> y la <a href="/terms#data">Pol\u00edtica de Tratamiento de Datos</a>.',
            }
        };

        var lang = (navigator.language || '').startsWith('es') ? 'es' : 'en';

        function t(key) { return (I[lang] && I[lang][key]) || I.en[key] || key; }

        function applyLang() {
            document.documentElement.lang = lang;
            document.getElementById('lang-toggle').textContent = lang === 'en' ? 'ES' : 'EN';
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
                el.textContent = t(el.getAttribute('data-i18n'));
            });
            document.querySelectorAll('[data-i18n-opt]').forEach(function(el) {
                el.textContent = t(el.getAttribute('data-i18n-opt'));
            });
            // Update terms notice (uses innerHTML for links)
            var tn = document.getElementById('terms-notice');
            if (tn) tn.innerHTML = t('termsNotice');
            // Update pay button if payment loaded
            if (paymentData) {
                var btn = document.getElementById('pay-button');
                if (!btn.disabled) {
                    btn.textContent = t('payAmount').replace('${amount}', '$' + paymentData.amountUSD.toFixed(2));
                }
            }
        }

        function toggleLang() {
            lang = lang === 'en' ? 'es' : 'en';
            applyLang();
        }

        // ── Payment logic ──
        const checkoutQueryParams = new URLSearchParams(window.location.search);
        const paymentIdFromQuery = checkoutQueryParams.get('paymentId');
        const pathParts = window.location.pathname.split('/');
        const paymentIdFromPath = pathParts[pathParts.length - 1];
        const paymentId = paymentIdFromQuery || paymentIdFromPath;
        let paymentData = null;
        var epaycoInstance = null;

        function collectBrowserInfo() {
            return {
                userAgent: navigator.userAgent,
                language: navigator.language || '',
                colorDepth: window.screen ? window.screen.colorDepth : null,
                screenHeight: window.screen ? window.screen.height : null,
                screenWidth: window.screen ? window.screen.width : null,
                timezoneOffset: new Date().getTimezoneOffset(),
            };
        }

        function waitForEpaycoSDK(maxWaitMs) {
            return new Promise(function(resolve, reject) {
                if (window.ePayco && typeof window.ePayco.token === 'object' && typeof window.ePayco.token.create === 'function') {
                    return resolve();
                }
                // If initial script load failed, try dynamic reload
                if (window.__epaycoLoadFailed) {
                    var s = document.createElement('script');
                    s.src = 'https://checkout.epayco.co/epayco.min.js';
                    document.head.appendChild(s);
                    window.__epaycoLoadFailed = false;
                }
                var waited = 0;
                var interval = 300;
                var timer = setInterval(function() {
                    waited += interval;
                    if (window.ePayco && typeof window.ePayco.token === 'object' && typeof window.ePayco.token.create === 'function') {
                        clearInterval(timer);
                        return resolve();
                    }
                    if (waited >= maxWaitMs) {
                        clearInterval(timer);
                        reject(new Error('El SDK de ePayco no pudo cargarse. Revisa tu conexión a internet y recarga la página.'));
                    }
                }, interval);
            });
        }

        function initEpaycoSDK() {
            if (epaycoInstance) return;
            if (!window.ePayco || typeof window.ePayco.setPublicKey !== 'function') {
                throw new Error('El SDK de ePayco no pudo cargarse. Revisa tu conexión a internet y recarga la página.');
            }
            window.ePayco.setPublicKey(paymentData.epaycoPublicKey);
            epaycoInstance = window.ePayco;
        }

        function isTokenLikeResponse(value) {
            if (!value || typeof value !== 'object') return false;
            if (value.status === false) return false;
            return Boolean(
                value.id
                || value.token
                || (value.data && (value.data.id || value.data.token))
            );
        }

        function extractTokenId(tokenResult) {
            if (!tokenResult || typeof tokenResult !== 'object') return null;
            return tokenResult.id
                || tokenResult.token
                || (tokenResult.data && (tokenResult.data.id || tokenResult.data.token))
                || null;
        }

        function tokenizeCardWithEpayco(cardPayload) {
            return waitForEpaycoSDK(8000).then(function() {
                return new Promise(function(resolve, reject) {
                    try {
                        initEpaycoSDK();
                        // ePayco SDK callback signatures can vary across versions:
                        // callback(error, token) OR callback(token, error).
                        window.ePayco.token.create(cardPayload, function(firstArg, secondArg) {
                            var tokenResult = isTokenLikeResponse(firstArg)
                                ? firstArg
                                : (isTokenLikeResponse(secondArg) ? secondArg : null);
                            var error = tokenResult === firstArg ? secondArg : firstArg;

                            if (!tokenResult && error) {
                                reject(typeof error === 'object' ? error : new Error(String(error)));
                                return;
                            }

                            if (!tokenResult || tokenResult.status === false || !extractTokenId(tokenResult)) {
                                reject(new Error((tokenResult && tokenResult.description) || 'Error al tokenizar la tarjeta'));
                                return;
                            }
                            resolve(tokenResult);
                        });
                    } catch (err) {
                        reject(err);
                    }
                });
            });
        }

        function detectCardBrand(number) {
            var n = number.replace(/\s/g, '');
            if (/^4/.test(n)) return 'Visa';
            if (/^5[1-5]/.test(n) || /^2[2-7]/.test(n)) return 'Mastercard';
            if (/^3[47]/.test(n)) return 'Amex';
            if (/^3(0[0-5]|[68])/.test(n)) return 'Diners';
            return '';
        }

        function luhnCheck(number) {
            var n = number.replace(/\s/g, '');
            if (!/^\d{13,19}$/.test(n)) return false;
            var sum = 0;
            var alternate = false;
            for (var i = n.length - 1; i >= 0; i--) {
                var digit = parseInt(n[i], 10);
                if (alternate) {
                    digit *= 2;
                    if (digit > 9) digit -= 9;
                }
                sum += digit;
                alternate = !alternate;
            }
            return sum % 10 === 0;
        }

        var yearSelect = document.getElementById('expYear');
        var currentYear = new Date().getFullYear();
        var opt0 = document.createElement('option');
        opt0.value = ''; opt0.textContent = lang === 'es' ? 'AAAA' : 'YYYY';
        yearSelect.appendChild(opt0);
        for (var y = currentYear; y <= currentYear + 10; y++) {
            var opt = document.createElement('option');
            opt.value = String(y); opt.textContent = String(y);
            yearSelect.appendChild(opt);
        }

        document.getElementById('cardNumber').addEventListener('input', function(e) {
            var v = e.target.value.replace(/\D/g, '').substring(0, 16);
            e.target.value = v.replace(/(\d{4})(?=\d)/g, '$1 ');

            var brand = detectCardBrand(v);
            var brandEl = document.getElementById('card-brand');
            if (brand && v.length >= 2) {
                brandEl.textContent = brand;
                brandEl.style.display = 'inline';
            } else {
                brandEl.style.display = 'none';
            }

            if (v.length >= 13) {
                if (luhnCheck(v)) {
                    e.target.classList.remove('invalid');
                    e.target.classList.add('valid');
                } else {
                    e.target.classList.remove('valid');
                    e.target.classList.add('invalid');
                }
            } else {
                e.target.classList.remove('valid', 'invalid');
            }
        });

        document.getElementById('cvc').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
        });

        function payBtnLabel() {
            return t('payAmount').replace('${amount}', '$' + paymentData.amountUSD.toFixed(2));
        }

        async function loadPaymentInfo() {
            try {
                var response = await fetch('/api/payment/' + paymentId);
                if (!response.ok) throw new Error(t('errLoadPayment'));
                var data = await response.json();
                if (!data.success) throw new Error(data.error || t('errLoadGeneric'));
                paymentData = data.payment;
                displayPaymentInfo();
            } catch (error) {
                showError(error.message || t('errLoadPayment'));
            }
        }

        function displayPaymentInfo() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('checkout-form').style.display = 'block';
            document.getElementById('plan-icon').textContent = paymentData.plan.icon || '';
            document.getElementById('plan-name').textContent = paymentData.plan.name;
            document.getElementById('plan-price-usd').textContent = paymentData.amountUSD.toFixed(2);

            var btn = document.getElementById('pay-button');
            btn.textContent = payBtnLabel();
        }

        document.getElementById('pay-button').addEventListener('click', async function() {
            const btn = document.getElementById('pay-button');
            const errDiv = document.getElementById('form-error');
            errDiv.style.display = 'none';

            const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
            const expMonth = document.getElementById('expMonth').value;
            const expYear = document.getElementById('expYear').value;
            const cvc = document.getElementById('cvc').value;
            const name = document.getElementById('name').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const docType = document.getElementById('docType').value;
            const docNumber = document.getElementById('docNumber').value.trim();

            if (!cardNumber || cardNumber.length < 13) {
                return showFormError(t('errCardInvalid'));
            }
            if (!luhnCheck(cardNumber)) {
                return showFormError(t('errCardLuhn'));
            }
            if (!expMonth || !expYear) {
                return showFormError(t('errExpDate'));
            }
            const now = new Date();
            const expDate = new Date(parseInt(expYear, 10), parseInt(expMonth, 10) - 1);
            if (expDate < new Date(now.getFullYear(), now.getMonth())) {
                return showFormError(t('errExpired'));
            }
            const brand = detectCardBrand(cardNumber);
            const expectedCvcLen = brand === 'Amex' ? 4 : 3;
            if (!cvc || cvc.length < expectedCvcLen) {
                return showFormError(t('errCvc').replace('{n}', expectedCvcLen));
            }
            if (!name) return showFormError(t('errName'));
            if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                return showFormError(t('errEmail'));
            }
            if (!docNumber) return showFormError(t('errDoc'));

            btn.disabled = true;
            btn.textContent = t('processing');

            try {
                var tokenResult = await tokenizeCardWithEpayco({
                    // Official SDK style (matches ePayco docs)
                    'card[number]': cardNumber,
                    'card[exp_year]': expYear,
                    'card[exp_month]': expMonth,
                    'card[cvc]': cvc,
                    'card[holder_name]': (name + ' ' + (lastName || '')).trim(),
                    hasCvv: true,
                    // Compatibility style for older ePayco.js variants that expect nested card object
                    card: {
                        number: cardNumber,
                        exp_year: expYear,
                        exp_month: expMonth,
                        cvc: cvc,
                        name: (name + ' ' + (lastName || '')).trim(),
                        email: email,
                    }
                });

                // Browser SDK may return token in different fields
                var tokenId = extractTokenId(tokenResult);
                if (!tokenId) {
                    var errMsg = (tokenResult && tokenResult.description) || 'No fue posible tokenizar la tarjeta.';
                    throw new Error(errMsg);
                }

                // Never send PAN/CVC to backend.
                const response = await fetch('/api/payment/tokenized-charge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentId,
                        tokenCard: tokenId,
                        name,
                        lastName: lastName || name,
                        email,
                        docType,
                        docNumber,
                        city: 'Bogota',
                        address: 'N/A',
                        phone: '',
                        dues: '1',
                        browserInfo: collectBrowserInfo(),
                    }),
                });

                const result = await response.json();
                document.getElementById('cvc').value = '';
                handleBackendResponse(result);
            } catch (error) {
                var epaycoError = (error && (error.description || error.error || error.message)) || t('errConnection');
                showFormError(epaycoError);
                btn.disabled = false;
                btn.textContent = payBtnLabel();
            }
        });

        function handleBackendResponse(result) {
            var btn = document.getElementById('pay-button');
            if (result && result.success && (result.status === 'approved' || result.status === 'completed')) {
                document.getElementById('checkout-form').style.display = 'none';
                document.getElementById('success').style.display = 'block';
                return;
            }

            if (result && result.status === 'processing') {
                document.getElementById('checkout-form').style.display = 'none';
                pollPaymentStatus();
                return;
            }

            if (result && result.status === 'pending') {
                if (result.redirectUrl) {
                    window.location.href = result.redirectUrl;
                    return;
                }
                if (result.threeDSecure && result.threeDSecure.version === '2.0') {
                    document.getElementById('checkout-form').style.display = 'none';
                    handle3DS2Authentication(result.threeDSecure, paymentId);
                    return;
                }
                document.getElementById('checkout-form').style.display = 'none';
                pollPaymentStatus();
                return;
            }

            showFormError((result && result.error) || t('errDeclined'));
            btn.disabled = false;
            btn.textContent = payBtnLabel();
        }

        var pollAttempts = 0;
        var maxPollAttempts = 30;
        var pollInterval = 3000;
        var polling = false;

        function pollPaymentStatus() {
            if (polling) return;
            polling = true;
            pollAttempts = 0;

            document.getElementById('checkout-form').style.display = 'none';
            document.getElementById('polling-status').style.display = 'block';

            doPoll();
        }

        function doPoll() {
            if (pollAttempts >= maxPollAttempts) {
                document.getElementById('polling-status').style.display = 'none';
                document.getElementById('pending').style.display = 'block';
                polling = false;
                return;
            }

            pollAttempts++;

            fetch('/api/payment/' + paymentId + '/status', {
                method: 'GET',
                cache: 'no-store',
                headers: {
                    'Cache-Control': 'no-cache',
                    'Pragma': 'no-cache'
                }
            })
                .then(function(response) {
                    if (response.status === 304) {
                        return { success: true, status: 'pending' };
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (!data.success) {
                        document.getElementById('polling-status').style.display = 'none';
                        showError(t('errVerify'));
                        polling = false;
                        return;
                    }

                    if (data.status === 'completed') {
                        document.getElementById('polling-status').style.display = 'none';
                        document.getElementById('success').style.display = 'block';
                        polling = false;
                    } else if (data.status === 'failed' || data.status === 'rejected' || data.status === 'cancelled') {
                        document.getElementById('polling-status').style.display = 'none';
                        document.getElementById('checkout-form').style.display = 'block';
                        showFormError(t('errDeclined'));
                        var btn = document.getElementById('pay-button');
                        btn.disabled = false;
                        btn.textContent = payBtnLabel();
                        polling = false;
                    } else { // This will now also handle 'pending' and 'processing'
                        setTimeout(doPoll, pollInterval);
                    }
                })
                .catch(function() {
                    setTimeout(doPoll, pollInterval);
                });
        }

        function attemptRecoveryCheck() {
            // This function is no longer needed as the backend handles recovery.
            // Kept here to avoid breaking callsites, but it does nothing.
        }

        var epayco3dsMessageListener = null;
        var epayco3dsSafetyTimer = null;

        function loadEpayco3DSValidator() {
            return new Promise(function(resolve, reject) {
                if (typeof window.validate3ds === 'function') {
                    resolve();
                    return;
                }

                var existingScript = document.getElementById('epayco-validate-3ds-script');
                if (existingScript) {
                    if (typeof window.validate3ds === 'function') {
                        resolve();
                        return;
                    }
                    existingScript.addEventListener('load', function() { resolve(); }, { once: true });
                    existingScript.addEventListener('error', function() { reject(new Error('3DS script load error')); }, { once: true });
                    setTimeout(function() {
                        if (typeof window.validate3ds === 'function') {
                            resolve();
                            return;
                        }
                        reject(new Error('3DS script exists but validate3ds is unavailable'));
                    }, 3000);
                    return;
                }

                var script = document.createElement('script');
                script.id = 'epayco-validate-3ds-script';
                script.src = 'https://multimedia.epayco.co/general/3DS/validateThreeds.min.js';
                script.async = true;
                script.onload = function() {
                    if (typeof window.validate3ds === 'function') {
                        resolve();
                    } else {
                        reject(new Error('validate3ds not exposed after script load'));
                    }
                };
                script.onerror = function() { reject(new Error('Failed to load validateThreeds.min.js')); };
                document.head.appendChild(script);
            });
        }

        function cleanup3DSArtifacts() {
            try {
                document.querySelectorAll('iframe').forEach(function(frame) {
                    var src = (frame.src || '').toLowerCase();
                    if (src.indexOf('cardinalcommerce.com') !== -1 || src.indexOf('epayco.co') !== -1 || src.indexOf('payco.co') !== -1) {
                        frame.remove();
                    }
                });

                document.querySelectorAll('div, section, aside').forEach(function(node) {
                    var token = ((node.id || '') + ' ' + (node.className || '')).toLowerCase();
                    if (!token) return;
                    if (token.indexOf('3ds') === -1 && token.indexOf('cardinal') === -1 && token.indexOf('epayco') === -1) return;

                    var style = window.getComputedStyle(node);
                    if (style.position === 'fixed' || style.position === 'absolute') {
                        node.remove();
                    }
                });

                document.documentElement.style.overflow = '';
                document.body.style.overflow = '';
            } catch (e) {
                console.warn('[3DS] cleanup warning', e && e.message ? e.message : e);
            }
        }

        function isTrusted3DSOrigin(origin) {
            if (!origin) return false;
            try {
                var parsed = new URL(origin);
                var host = (parsed.hostname || '').toLowerCase();
                var currentHost = (window.location.hostname || '').toLowerCase();
                return host === 'localhost'
                    || host === currentHost
                    || host.endsWith('.epayco.co')
                    || host.endsWith('.payco.co')
                    || host.endsWith('.cardinalcommerce.com');
            } catch (e) {
                return false;
            }
        }

        function attachEpayco3DSMessageHandler() {
            if (epayco3dsMessageListener) {
                window.removeEventListener('message', epayco3dsMessageListener);
                epayco3dsMessageListener = null;
            }

            epayco3dsMessageListener = function(event) {
                var origin = event && event.origin ? event.origin : '';
                if (!isTrusted3DSOrigin(origin)) {
                    return;
                }

                var payload = event && event.data ? event.data : {};
                if (!(payload.success || payload.message || payload.ref_payco || payload.transactionId)) {
                    return;
                }

                console.log('[3DS ePayco] message event received', payload);
                if (epayco3dsSafetyTimer) {
                    clearTimeout(epayco3dsSafetyTimer);
                    epayco3dsSafetyTimer = null;
                }
                window.removeEventListener('message', epayco3dsMessageListener);
                epayco3dsMessageListener = null;
                cleanup3DSArtifacts();

                document.getElementById('checkout-form').style.display = 'none';
                document.getElementById('polling-status').style.display = 'block';
                pollPaymentStatus();
            };

            window.addEventListener('message', epayco3dsMessageListener);
        }

        function buildEpayco3DSPayload(threeDSecure, paymentId) {
            var tx = (threeDSecure && threeDSecure.transactionData) || {};
            var data3ds = {
                franquicia: tx.franquicia,
                '3DS': tx['3DS'],
                ref_payco: tx.ref_payco,
                cc_network_response: tx.cc_network_response
            };

            if (!data3ds.ref_payco) {
                data3ds.ref_payco = (threeDSecure && threeDSecure.reference) || paymentId;
            }

            return data3ds;
        }

        async function runDeviceDataCollection(methodUrl) {
            if (!methodUrl) return false;
            return new Promise(function(resolve) {
                var done = false;
                var iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.setAttribute('aria-hidden', 'true');

                function finish(result) {
                    if (done) return;
                    done = true;
                    setTimeout(function() {
                        if (iframe && iframe.parentNode) {
                            iframe.parentNode.removeChild(iframe);
                        }
                    }, 5000);
                    resolve(result);
                }

                iframe.onload = function() { finish(true); };
                iframe.onerror = function() { finish(false); };
                iframe.src = methodUrl;
                document.body.appendChild(iframe);

                setTimeout(function() { finish(false); }, 4000);
            });
        }

        async function tryOfficialEpayco3DSFlow(threeDSecure, paymentId) {
            var data3DS = buildEpayco3DSPayload(threeDSecure, paymentId);
            if (!data3DS['3DS']) {
                return false;
            }

            await runDeviceDataCollection(
                threeDSecure
                && threeDSecure.data
                && threeDSecure.data.deviceDataCollectionUrl
            );

            await loadEpayco3DSValidator();
            attachEpayco3DSMessageHandler();

            document.getElementById('checkout-form').style.display = 'none';
            document.getElementById('polling-status').style.display = 'block';
            window.validate3ds(data3DS);

            // Safety net: if postMessage is blocked, start status polling without interrupting challenge UI.
            if (epayco3dsSafetyTimer) {
                clearTimeout(epayco3dsSafetyTimer);
                epayco3dsSafetyTimer = null;
            }
            epayco3dsSafetyTimer = setTimeout(function() {
                if (epayco3dsMessageListener) {
                    console.warn('[3DS ePayco] No postMessage received yet, starting status polling fallback', { paymentId });
                    pollPaymentStatus();
                }
            }, 30000);
            return true;
        }

        /**
         * Handle 3DS authentication with ePayco official API flow first.
         * Fallback to direct Cardinal flow for backward compatibility.
         * @param {Object} threeDSecure - 3DS 2.0 authentication data from ePayco
         * @param {String} paymentId - Payment ID for tracking
         */
        async function handle3DS2Authentication(threeDSecure, paymentId) {
            try {
                var usedOfficialFlow = await tryOfficialEpayco3DSFlow(threeDSecure, paymentId);
                if (usedOfficialFlow) {
                    console.log('[3DS ePayco] validate3ds flow started', { paymentId });
                    return;
                }
            } catch (flowError) {
                console.warn('[3DS ePayco] Official validate3ds flow failed, fallback to Cardinal', {
                    paymentId,
                    error: flowError.message
                });
            }

            try {
                const data = threeDSecure.data;
                console.log('[3DS 2.0] Starting Cardinal Commerce fallback', {
                    paymentId,
                    referenceId: data && data.referenceId,
                    provider: threeDSecure.provider
                });

                // Fallback: Load Cardinal Commerce SDK
                loadCardinalCommerceSdk(data, paymentId);
            } catch (error) {
                console.error('[3DS 2.0] Error in handle3DS2Authentication fallback', error);
                document.getElementById('checkout-form').style.display = 'none';
                document.getElementById('polling-status').style.display = 'block';
                pollPaymentStatus();
            }
        }

        /**
         * Load Cardinal Commerce JavaScript SDK and initialize device data collection
         */
        function loadCardinalCommerceSdk(data, paymentId) {
            try {
                console.log('[3DS 2.0] Loading Cardinal Commerce SDK from production', { paymentId });

                // Check if SDK already loaded
                if (window.Cardinal) {
                    console.log('[3DS 2.0] Cardinal SDK already in memory, using cached version');
                    initCardinalSession(data, paymentId);
                    return;
                }

                // Cardinal Commerce SDK script (production endpoint)
                const script = document.createElement('script');
                script.src = 'https://songbird.cardinalcommerce.com/edge/v1/songbird.js';
                script.async = true;
                script.defer = false;

                let loadTimeout = setTimeout(function() {
                    console.warn('[3DS 2.0] SDK load timeout, falling back', { paymentId });
                    submitPaymentWith3DS2Token(data, paymentId);
                }, 8000); // 8 second timeout

                script.onload = function() {
                    clearTimeout(loadTimeout);
                    console.log('[3DS 2.0] Cardinal SDK loaded successfully', { paymentId });
                    if (window.Cardinal) {
                        initCardinalSession(data, paymentId);
                    } else {
                        console.warn('[3DS 2.0] Cardinal object not available, retrying');
                        setTimeout(() => {
                            if (window.Cardinal) {
                                initCardinalSession(data, paymentId);
                            } else {
                                submitPaymentWith3DS2Token(data, paymentId);
                            }
                        }, 500);
                    }
                };

                script.onerror = function() {
                    clearTimeout(loadTimeout);
                    console.warn('[3DS 2.0] Failed to load SDK, fallback to token submission', { paymentId });
                    submitPaymentWith3DS2Token(data, paymentId);
                };

                document.head.appendChild(script);
                console.log('[3DS 2.0] SDK script appended to head', { paymentId });
            } catch (error) {
                console.error('[3DS 2.0] Exception loading Cardinal SDK', error);
                submitPaymentWith3DS2Token(data, paymentId);
            }
        }

        /**
         * Initialize Cardinal Commerce session and collect device data
         */
        function initCardinalSession(data, paymentId) {
            try {
                console.log('[3DS 2.0] Initializing Cardinal session', {
                    paymentId,
                    referenceId: data.referenceId,
                    hasAccessToken: !!data.accessToken
                });

                if (!window.Cardinal) {
                    console.error('[3DS 2.0] Cardinal not available after load');
                    submitPaymentWith3DS2Token(data, paymentId);
                    return;
                }

                if (!data.accessToken) {
                    console.error('[3DS 2.0] No access token provided');
                    submitPaymentWith3DS2Token(data, paymentId);
                    return;
                }

                // Setup Cardinal session with verbose logging
                window.Cardinal.setup('init', {
                    logging: {
                        level: 'verbose'
                    }
                });

                // Handler for setup complete
                let setupComplete = false;
                window.Cardinal.on('payments.setupComplete', function() {
                    setupComplete = true;
                    console.log('[3DS 2.0] Setup complete, collecting device data', { paymentId });
                    collectDeviceData(data, paymentId);
                });

                // Handler for validation complete
                window.Cardinal.on('payments.validationComplete', function(validationData) {
                    console.log('[3DS 2.0] Validation complete', {
                        paymentId,
                        actionCode: validationData.ActionCode,
                        serverJWT: !!validationData.ServerJWT
                    });
                    submitPaymentWith3DS2JWT(data, paymentId, validationData);
                });

                // Initialize with access token
                console.log('[3DS 2.0] Configuring with JWT token', { paymentId });
                window.Cardinal.configure({
                    jwt: data.accessToken
                });

                // Timeout if setup doesn't complete
                setTimeout(function() {
                    if (!setupComplete) {
                        console.warn('[3DS 2.0] Setup timeout, submitting with token', { paymentId });
                        submitPaymentWith3DS2Token(data, paymentId);
                    }
                }, 5000);

            } catch (error) {
                console.error('[3DS 2.0] Error initializing Cardinal session', error);
                submitPaymentWith3DS2Token(data, paymentId);
            }
        }

        /**
         * Collect device data using Cardinal Commerce
         */
        function collectDeviceData(data, paymentId) {
            try {
                console.log('[3DS 2.0] Collecting device data', { paymentId });

                if (!window.Cardinal) {
                    submitPaymentWith3DS2Token(data, paymentId);
                    return;
                }

                // Send device data collection request
                window.Cardinal.trigger('payments.load', {
                    'DFReferenceId': data.referenceId
                });
            } catch (error) {
                console.error('[3DS 2.0] Error collecting device data', error);
                submitPaymentWith3DS2Token(data, paymentId);
            }
        }

        /**
         * Submit payment with 3DS 2.0 JWT (for Cardinal Commerce)
         */
        async function submitPaymentWith3DS2JWT(data, paymentId, validationData) {
            try {
                console.log('[3DS 2.0] Submitting payment with Cardinal validation', {
                    paymentId,
                    actionCode: validationData?.ActionCode
                });

                const response = await fetch('/api/payment/complete-3ds-2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentId,
                        threeDSecure: {
                            version: '2.0',
                            provider: 'CardinalCommerce',
                            referenceId: data.referenceId,
                            accessToken: data.accessToken,
                            token: data.token,
                            validationData: validationData
                        }
                    })
                });

                const result = await response.json();
                console.log('[3DS 2.0] Backend response', { paymentId, success: result.success, status: result.status });

                handlePaymentCompletion(result, paymentId);
            } catch (error) {
                console.error('[3DS 2.0] Error submitting with JWT', error);
                document.getElementById('polling-status').style.display = 'block';
                pollPaymentStatus();
            }
        }

        /**
         * Submit payment with 3DS 2.0 authentication (fallback without Cardinal SDK)
         */
        async function submitPaymentWith3DS2Token(data, paymentId) {
            try {
                console.log('[3DS 2.0] Submitting payment with 3DS 2.0 token (no Cardinal SDK)', {
                    paymentId,
                    referenceId: data.referenceId
                });

                const response = await fetch('/api/payment/complete-3ds-2', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        paymentId,
                        threeDSecure: {
                            version: '2.0',
                            provider: 'CardinalCommerce',
                            referenceId: data.referenceId,
                            accessToken: data.accessToken,
                            token: data.token,
                        }
                    })
                });

                const result = await response.json();
                handlePaymentCompletion(result, paymentId);
            } catch (error) {
                console.error('[3DS 2.0] Error in submitPaymentWith3DS2Token', error);
                // On network error, start polling to see if payment goes through
                document.getElementById('polling-status').style.display = 'block';
                pollPaymentStatus();
            }
        }

        /**
         * Handle payment completion response
         */
        function handlePaymentCompletion(result, paymentId) {
            console.log('[3DS 2.0] Handling payment completion', {
                paymentId,
                success: result.success,
                status: result.status
            });

            if (result.success && result.status === 'authenticated') {
                // 3DS 2.0 authentication successful, payment should be completed
                document.getElementById('polling-status').style.display = 'none';
                document.getElementById('success').style.display = 'block';
                console.log('[3DS 2.0] Payment authenticated successfully', { paymentId });
            } else if (result.status === 'pending') {
                // Payment still pending, start polling
                console.log('[3DS 2.0] Payment still pending, starting poll', { paymentId });
                document.getElementById('polling-status').style.display = 'block';
                pollPaymentStatus();
            } else if (result.status === 'failed' || result.status === 'rejected') {
                // Payment failed
                document.getElementById('polling-status').style.display = 'none';
                document.getElementById('checkout-form').style.display = 'block';
                showFormError(result.error || t('errDeclined'));
                var btn = document.getElementById('pay-button');
                btn.disabled = false;
                btn.textContent = payBtnLabel();
                console.error('[3DS 2.0] Payment rejected', { paymentId, error: result.error });
            } else {
                // Unexpected response, poll for status
                console.log('[3DS 2.0] Unexpected response, polling for status', { paymentId });
                document.getElementById('polling-status').style.display = 'block';
                pollPaymentStatus();
            }
        }

        // Apply language on load
        applyLang();

        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('ref_payco') || urlParams.get('transactionID')) {
            document.getElementById('loading').style.display = 'none';
            pollPaymentStatus();
        } else {
            loadPaymentInfo();
        }

        function showFormError(msg) {
            var errDiv = document.getElementById('form-error');
            errDiv.textContent = msg;
            errDiv.style.display = 'block';
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            var errorDiv = document.getElementById('error');
            errorDiv.className = 'error-msg';
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    </script>
</body>
</html>
