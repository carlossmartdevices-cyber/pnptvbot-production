import{a as uY,b as hY,g as ok,r as W,u as ak,L as dn,c as pY,R as ck,d as US,e as dk,N as QS,f as mY,h as Mn,B as fY}from"./vendor-BYwGbbwJ.js";import{S as _Y,R as lk,M as im,F as EY,H as gY,U as Ia,a as SY,b as Pl,C as tm,c as rm,d as WS,X as ZS,e as TY,f as $S,T as sm,g as yY,h as vY,i as BL,j as RY,k as eT,l as CY,P as tT,m as bY,L as nT,n as om,o as am,p as Ml,V as xl,q as uk,E as GS,r as IY,s as wY,t as AY,u as OY,v as hk,w as NY,x as WL,y as DY,A as PY,z as Zc,B as LY,D as kY,G as xY,I as MY,J as UY,K as VY}from"./icons-Drir8Hoj.js";(function(){const f=document.createElement("link").relList;if(f&&f.supports&&f.supports("modulepreload"))return;for(const D of document.querySelectorAll('link[rel="modulepreload"]'))C(D);new MutationObserver(D=>{for(const U of D)if(U.type==="childList")for(const B of U.addedNodes)B.tagName==="LINK"&&B.rel==="modulepreload"&&C(B)}).observe(document,{childList:!0,subtree:!0});function g(D){const U={};return D.integrity&&(U.integrity=D.integrity),D.referrerPolicy&&(U.referrerPolicy=D.referrerPolicy),D.crossOrigin==="use-credentials"?U.credentials="include":D.crossOrigin==="anonymous"?U.credentials="omit":U.credentials="same-origin",U}function C(D){if(D.ep)return;D.ep=!0;const U=g(D);fetch(D.href,U)}})();var VS={exports:{}},Ol={};var GL;function jY(){if(GL)return Ol;GL=1;var E=uY(),f=Symbol.for("react.element"),g=Symbol.for("react.fragment"),C=Object.prototype.hasOwnProperty,D=E.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,U={key:!0,ref:!0,__self:!0,__source:!0};function B(te,z,_e){var ne,ee={},q=null,ce=null;_e!==void 0&&(q=""+_e),z.key!==void 0&&(q=""+z.key),z.ref!==void 0&&(ce=z.ref);for(ne in z)C.call(z,ne)&&!U.hasOwnProperty(ne)&&(ee[ne]=z[ne]);if(te&&te.defaultProps)for(ne in z=te.defaultProps,z)ee[ne]===void 0&&(ee[ne]=z[ne]);return{$$typeof:f,type:te,key:q,ref:ce,props:ee,_owner:D.current}}return Ol.Fragment=g,Ol.jsx=B,Ol.jsxs=B,Ol}var HL;function FY(){return HL||(HL=1,VS.exports=jY()),VS.exports}var m=FY(),Bp={},KL;function BY(){if(KL)return Bp;KL=1;var E=hY();return Bp.createRoot=E.createRoot,Bp.hydrateRoot=E.hydrateRoot,Bp}var WY=BY();const GY=ok(WY),Yp="/api/webapp";async function je(E,f={}){const g=`${Yp}${E}`,C={"Content-Type":"application/json",...f.headers},D=await fetch(g,{credentials:"include",headers:C,...f}),U=await D.json();if(!D.ok)throw new Error(U.error||`Request failed (${D.status})`);return U}const Me={authStatus:async()=>{const E=await fetch("/api/me",{credentials:"include"}),f=await E.json();if(!E.ok)throw new Error(f.error||`Request failed (${E.status})`);return f},telegramLogin:E=>je("/auth/telegram",{method:"POST",body:JSON.stringify({telegramUser:E})}),emailLogin:(E,f,g=!1)=>je("/auth/email/login",{method:"POST",body:JSON.stringify({email:E,password:f,rememberMe:g})}),emailRegister:(E,f,g,C="")=>je("/auth/email/register",{method:"POST",body:JSON.stringify({firstName:E,email:f,password:g,lastName:C})}),forgotPassword:E=>je("/auth/forgot-password",{method:"POST",body:JSON.stringify({email:E})}),xLoginStart:async()=>(window.location.assign("/api/webapp/auth/x/start?redirect=true"),{success:!0}),logout:()=>je("/auth/logout",{method:"POST"}),getProfile:()=>je("/profile"),updateProfile:E=>je("/profile",{method:"PUT",body:JSON.stringify(E)}),uploadAvatar:E=>{const f=new FormData;return f.append("avatar",E),fetch(`${Yp}/profile/avatar`,{method:"POST",credentials:"include",body:f}).then(g=>g.json()).then(g=>{if(!g.success)throw new Error(g.error||"Upload failed");return g})},nearbyUpdateLocation:(E,f,g)=>je("/nearby/update-location",{method:"POST",body:JSON.stringify({latitude:E,longitude:f,accuracy:g})}),nearbySearch:(E,f,g=5)=>je(`/nearby/search?latitude=${E}&longitude=${f}&radius=${g}&limit=30`),getMastodonFeed:(E=10)=>je(`/mastodon/feed?limit=${E}`),getMediaLibrary:(E="all",f=50)=>fetch(`/api/media/library?type=${E}&limit=${f}`,{credentials:"include"}).then(g=>g.json()),getRadioNowPlaying:()=>fetch("/api/radio/now-playing",{credentials:"include"}).then(E=>E.json()).catch(()=>({})),getPublicHangouts:()=>je("/webapp/hangouts/public"),createHangout:E=>je("/webapp/hangouts/create",{method:"POST",body:JSON.stringify(E)}),joinHangout:E=>je(`/webapp/hangouts/join/${E}`,{method:"POST"}),leaveHangout:E=>je(`/webapp/hangouts/leave/${E}`,{method:"POST"}),endHangout:E=>je(`/webapp/hangouts/${E}`,{method:"DELETE"}),getFeed:E=>je(`/social/feed${E?`?cursor=${encodeURIComponent(E)}`:""}`),getWall:(E,f)=>je(`/social/wall/${E}${f?`?cursor=${encodeURIComponent(f)}`:""}`),createPost:E=>je("/social/posts",{method:"POST",body:JSON.stringify(E)}),createPostWithMedia:(E,f)=>{const g=new FormData;return g.append("content",E),f&&g.append("media",f),fetch(`${Yp}/social/posts/with-media`,{method:"POST",credentials:"include",body:g}).then(C=>C.json()).then(C=>{if(!C.success)throw new Error(C.error||"Post failed");return C})},toggleLike:E=>je(`/social/posts/${E}/like`,{method:"POST"}),deletePost:E=>je(`/social/posts/${E}`,{method:"DELETE"}),getReplies:(E,f)=>je(`/social/posts/${E}/replies${f?`?cursor=${encodeURIComponent(f)}`:""}`),getDMThreads:()=>je("/dm/threads"),getConversation:(E,f)=>je(`/dm/conversation/${E}${f?`?cursor=${encodeURIComponent(f)}`:""}`),getDMPartnerInfo:E=>je(`/dm/user/${E}`),sendDMRest:(E,f)=>je(`/dm/send/${E}`,{method:"POST",body:JSON.stringify({content:f})}),getChatHistory:(E="general")=>je(`/chat/${E}/history`),sendChatRest:(E="general",f)=>je(`/chat/${E}/send`,{method:"POST",body:JSON.stringify({content:f})}),searchUsers:E=>je(`/users/search?q=${encodeURIComponent(E)}`),getAdminStats:()=>je("/admin/stats"),listAdminUsers:(E,f)=>je(`/admin/users?page=${E}&search=${encodeURIComponent(f||"")}`),getAdminUser:E=>je(`/admin/users/${E}`),updateAdminUser:(E,f)=>je(`/admin/users/${E}`,{method:"PUT",body:JSON.stringify(f)}),banAdminUser:(E,f,g)=>je(`/admin/users/${E}/ban`,{method:"POST",body:JSON.stringify({ban:f,reason:g})}),listAdminPosts:E=>je(`/admin/posts?page=${E}`),deleteAdminPost:E=>je(`/admin/posts/${E}`,{method:"DELETE"}),listAdminHangouts:()=>je("/admin/hangouts"),endAdminHangout:E=>je(`/admin/hangouts/${E}`,{method:"DELETE"}),getLiveStreams:()=>je("/live/streams"),startLiveStream:E=>je("/live/start",{method:"POST",body:JSON.stringify(E)}),joinLiveStream:E=>je(`/live/streams/${E}/join`),endLiveStream:E=>je(`/live/streams/${E}/end`,{method:"POST"}),leaveLiveStream:E=>je(`/live/streams/${E}/leave`,{method:"POST"}),getAdminMedia:(E="")=>{const f=`/admin/media/library${E}`;return je(f)},getAdminMediaCategories:()=>je("/admin/media/categories"),uploadAdminMedia:E=>fetch(`${Yp}/admin/media/upload`,{method:"POST",credentials:"include",body:E}).then(f=>f.json()).then(f=>{if(!f.success&&!f.media)throw new Error(f.error||"Upload failed");return f}),updateAdminMedia:(E,f)=>je(`/admin/media/${E}`,{method:"PUT",body:JSON.stringify(f)}),deleteAdminMedia:E=>je(`/admin/media/${E}`,{method:"DELETE"}),getAdminRadioNowPlaying:()=>je("/admin/radio/now-playing"),setAdminRadioNowPlaying:E=>je("/admin/radio/now-playing",{method:"POST",body:JSON.stringify(E)}),getAdminRadioQueue:()=>je("/admin/radio/queue"),addAdminRadioQueue:E=>je("/admin/radio/queue",{method:"POST",body:JSON.stringify(E)}),removeAdminRadioQueue:E=>je(`/admin/radio/queue/${E}`,{method:"DELETE"}),clearAdminRadioQueue:()=>je("/admin/radio/queue/clear",{method:"POST"}),getAdminRadioRequests:(E="pending")=>je(`/admin/radio/requests?status=${E}`),updateAdminRadioRequest:(E,f)=>je(`/admin/radio/requests/${E}`,{method:"PUT",body:JSON.stringify(f)}),getAdminRoles:()=>je("/admin/roles"),getAdminUsersByRole:(E,f=1,g=20)=>je(`/admin/users?role=${E}&page=${f}&limit=${g}`),assignAdminUserRole:(E,f,g="")=>je("/admin/users/role",{method:"PUT",body:JSON.stringify({userId:E,roleName:f,reason:g})}),removeAdminUserRole:(E,f)=>je(`/admin/users/${E}/role`,{method:"DELETE",body:JSON.stringify({userId:E,roleName:f})}),getAdminUserRoles:E=>je(`/admin/users/${E}/roles`),getAdminPermissions:(E=null)=>{let f="/admin/permissions";return E&&(f+=`?roleName=${E}`),je(f)},checkAdminPermission:(E,f)=>je(`/admin/permissions/check?userId=${E}&permission=${f}`),getAdminAuditLogs:(E={})=>{const f=new URLSearchParams;return Object.entries(E).forEach(([g,C])=>{C&&f.append(g,C)}),je(`/admin/audit-logs?${f.toString()}`)},getAdminAuditLogsResource:(E,f,g=50)=>je(`/admin/audit-logs/resource?resourceType=${E}&resourceId=${f}&limit=${g}`),getLatestPrimeVideo:()=>je("/prime/latest"),getLatestVideoramaVideo:()=>je("/videorama/latest"),getActiveLiveStreams:()=>je("/livestream/active"),getMostActiveHangout:()=>je("/hangouts/most-active")},zp=Me,pk=W.createContext(null);function HY({children:E}){const[f,g]=W.useState(null),[C,D]=W.useState(!0),U=W.useCallback(async()=>{try{const ee=await Me.authStatus();ee.authenticated?g(ee.user):g(null)}catch{g(null)}finally{D(!1)}},[]);W.useEffect(()=>{U()},[U]);const B=W.useCallback(async ee=>{const q=await Me.telegramLogin(ee);return q.authenticated&&q.registered?(g(q.user),{success:!0}):{success:!1,...q}},[]),te=W.useCallback(async(ee,q,ce=!1)=>{const ae=await Me.emailLogin(ee,q,ce);return ae.authenticated?(g(ae.user),{success:!0}):{success:!1,...ae}},[]),z=W.useCallback(async(ee,q,ce,ae="")=>{const Te=await Me.emailRegister(ee,q,ce,ae);return Te.authenticated?(g(Te.user),{success:!0}):{success:!1,...Te}},[]),_e=W.useCallback(async()=>{await Me.xLoginStart()},[]),ne=W.useCallback(async()=>{await Me.logout(),g(null),window.location.replace("/")},[]);return m.jsx(pk.Provider,{value:{user:f,loading:C,loginWithTelegram:B,loginWithEmail:te,registerWithEmail:z,loginWithX:_e,logout:ne,checkAuth:U},children:E})}function $i(){const E=W.useContext(pk);if(!E)throw new Error("useAuth must be used within AuthProvider");return E}function KY(){const{user:E}=$i(),f=ak();return m.jsxs("header",{className:"app-header",children:[m.jsx("div",{className:"header-left",children:m.jsx(dn,{to:"/",className:"header-logo",children:m.jsx("img",{src:"/logo.png",alt:"PNPtv PRIME"})})}),m.jsxs("nav",{className:"header-nav",children:[E&&["admin","superadmin"].includes(E.role)&&m.jsx(dn,{to:"/admin",className:`header-nav-btn ${f.pathname.startsWith("/admin")?"active":""}`,title:"Admin Panel",children:m.jsx(_Y,{size:18})}),m.jsx(dn,{to:"/feed",className:`header-nav-btn ${f.pathname==="/feed"?"active":""}`,title:"Social Feed",children:m.jsx(lk,{size:18})}),m.jsx(dn,{to:"/messages",className:`header-nav-btn ${f.pathname.startsWith("/messages")?"active":""}`,title:"Messages",children:m.jsx(im,{size:18})}),m.jsx("a",{href:"/terms",target:"_blank",rel:"noopener",className:"header-nav-btn",title:"Terms",children:m.jsx(EY,{size:18})}),m.jsx("a",{href:"https://t.me/PNPLatinoTV_Bot",target:"_blank",rel:"noopener",className:"header-nav-btn",title:"Support",children:m.jsx(gY,{size:18})})]}),m.jsxs("div",{className:"header-right",children:[E&&m.jsx(dn,{to:`/wall/${E.id}`,className:`header-nav-btn ${f.pathname.startsWith("/wall")?"active":""}`,title:"My Wall",children:m.jsx(Ia,{size:18})}),m.jsx(dn,{to:"/profile",title:"My Profile",children:m.jsx("div",{className:"header-avatar",children:E?.photoUrl?m.jsx("img",{src:E.photoUrl,alt:E.username||"Profile"}):m.jsx(SY,{size:18,color:"#8E8E93"})})})]})]})}const YY=[{path:"/nearby",label:"Nearby",icon:Pl},{path:"/hangouts",label:"Hangouts",icon:Ia},{path:"/prime",label:"Prime",icon:tm},{path:"/live",label:"Live",icon:rm},{path:"/videorama",label:"Videorama",icon:WS}];function zY(){const E=ak();return m.jsx("nav",{className:"app-footer",children:YY.map(({path:f,label:g,icon:C})=>m.jsxs(dn,{to:f,className:`footer-tab ${E.pathname===f?"active":""}`,children:[m.jsx(C,{size:22}),g]},f))})}const Rs=Object.create(null);Rs.open="0";Rs.close="1";Rs.ping="2";Rs.pong="3";Rs.message="4";Rs.upgrade="5";Rs.noop="6";const qp=Object.create(null);Object.keys(Rs).forEach(E=>{qp[Rs[E]]=E});const HS={type:"error",data:"parser error"},mk=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",fk=typeof ArrayBuffer=="function",_k=E=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(E):E&&E.buffer instanceof ArrayBuffer,iT=({type:E,data:f},g,C)=>mk&&f instanceof Blob?g?C(f):YL(f,C):fk&&(f instanceof ArrayBuffer||_k(f))?g?C(f):YL(new Blob([f]),C):C(Rs[E]+(f||"")),YL=(E,f)=>{const g=new FileReader;return g.onload=function(){const C=g.result.split(",")[1];f("b"+(C||""))},g.readAsDataURL(E)};function zL(E){return E instanceof Uint8Array?E:E instanceof ArrayBuffer?new Uint8Array(E):new Uint8Array(E.buffer,E.byteOffset,E.byteLength)}let jS;function qY(E,f){if(mk&&E.data instanceof Blob)return E.data.arrayBuffer().then(zL).then(f);if(fk&&(E.data instanceof ArrayBuffer||_k(E.data)))return f(zL(E.data));iT(E,!1,g=>{jS||(jS=new TextEncoder),f(jS.encode(g))})}const qL="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ll=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let E=0;E<qL.length;E++)Ll[qL.charCodeAt(E)]=E;const XY=E=>{let f=E.length*.75,g=E.length,C,D=0,U,B,te,z;E[E.length-1]==="="&&(f--,E[E.length-2]==="="&&f--);const _e=new ArrayBuffer(f),ne=new Uint8Array(_e);for(C=0;C<g;C+=4)U=Ll[E.charCodeAt(C)],B=Ll[E.charCodeAt(C+1)],te=Ll[E.charCodeAt(C+2)],z=Ll[E.charCodeAt(C+3)],ne[D++]=U<<2|B>>4,ne[D++]=(B&15)<<4|te>>2,ne[D++]=(te&3)<<6|z&63;return _e},JY=typeof ArrayBuffer=="function",rT=(E,f)=>{if(typeof E!="string")return{type:"message",data:Ek(E,f)};const g=E.charAt(0);return g==="b"?{type:"message",data:QY(E.substring(1),f)}:qp[g]?E.length>1?{type:qp[g],data:E.substring(1)}:{type:qp[g]}:HS},QY=(E,f)=>{if(JY){const g=XY(E);return Ek(g,f)}else return{base64:!0,data:E}},Ek=(E,f)=>f==="blob"?E instanceof Blob?E:new Blob([E]):E instanceof ArrayBuffer?E:E.buffer,gk="",ZY=(E,f)=>{const g=E.length,C=new Array(g);let D=0;E.forEach((U,B)=>{iT(U,!1,te=>{C[B]=te,++D===g&&f(C.join(gk))})})},$Y=(E,f)=>{const g=E.split(gk),C=[];for(let D=0;D<g.length;D++){const U=rT(g[D],f);if(C.push(U),U.type==="error")break}return C};function ez(){return new TransformStream({transform(E,f){qY(E,g=>{const C=g.length;let D;if(C<126)D=new Uint8Array(1),new DataView(D.buffer).setUint8(0,C);else if(C<65536){D=new Uint8Array(3);const U=new DataView(D.buffer);U.setUint8(0,126),U.setUint16(1,C)}else{D=new Uint8Array(9);const U=new DataView(D.buffer);U.setUint8(0,127),U.setBigUint64(1,BigInt(C))}E.data&&typeof E.data!="string"&&(D[0]|=128),f.enqueue(D),f.enqueue(g)})}})}let FS;function Wp(E){return E.reduce((f,g)=>f+g.length,0)}function Gp(E,f){if(E[0].length===f)return E.shift();const g=new Uint8Array(f);let C=0;for(let D=0;D<f;D++)g[D]=E[0][C++],C===E[0].length&&(E.shift(),C=0);return E.length&&C<E[0].length&&(E[0]=E[0].slice(C)),g}function tz(E,f){FS||(FS=new TextDecoder);const g=[];let C=0,D=-1,U=!1;return new TransformStream({transform(B,te){for(g.push(B);;){if(C===0){if(Wp(g)<1)break;const z=Gp(g,1);U=(z[0]&128)===128,D=z[0]&127,D<126?C=3:D===126?C=1:C=2}else if(C===1){if(Wp(g)<2)break;const z=Gp(g,2);D=new DataView(z.buffer,z.byteOffset,z.length).getUint16(0),C=3}else if(C===2){if(Wp(g)<8)break;const z=Gp(g,8),_e=new DataView(z.buffer,z.byteOffset,z.length),ne=_e.getUint32(0);if(ne>Math.pow(2,21)-1){te.enqueue(HS);break}D=ne*Math.pow(2,32)+_e.getUint32(4),C=3}else{if(Wp(g)<D)break;const z=Gp(g,D);te.enqueue(rT(U?z:FS.decode(z),f)),C=0}if(D===0||D>E){te.enqueue(HS);break}}}})}const Sk=4;function Wn(E){if(E)return nz(E)}function nz(E){for(var f in Wn.prototype)E[f]=Wn.prototype[f];return E}Wn.prototype.on=Wn.prototype.addEventListener=function(E,f){return this._callbacks=this._callbacks||{},(this._callbacks["$"+E]=this._callbacks["$"+E]||[]).push(f),this};Wn.prototype.once=function(E,f){function g(){this.off(E,g),f.apply(this,arguments)}return g.fn=f,this.on(E,g),this};Wn.prototype.off=Wn.prototype.removeListener=Wn.prototype.removeAllListeners=Wn.prototype.removeEventListener=function(E,f){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var g=this._callbacks["$"+E];if(!g)return this;if(arguments.length==1)return delete this._callbacks["$"+E],this;for(var C,D=0;D<g.length;D++)if(C=g[D],C===f||C.fn===f){g.splice(D,1);break}return g.length===0&&delete this._callbacks["$"+E],this};Wn.prototype.emit=function(E){this._callbacks=this._callbacks||{};for(var f=new Array(arguments.length-1),g=this._callbacks["$"+E],C=1;C<arguments.length;C++)f[C-1]=arguments[C];if(g){g=g.slice(0);for(var C=0,D=g.length;C<D;++C)g[C].apply(this,f)}return this};Wn.prototype.emitReserved=Wn.prototype.emit;Wn.prototype.listeners=function(E){return this._callbacks=this._callbacks||{},this._callbacks["$"+E]||[]};Wn.prototype.hasListeners=function(E){return!!this.listeners(E).length};const cm=typeof Promise=="function"&&typeof Promise.resolve=="function"?f=>Promise.resolve().then(f):(f,g)=>g(f,0),vr=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),iz="arraybuffer";function Tk(E,...f){return f.reduce((g,C)=>(E.hasOwnProperty(C)&&(g[C]=E[C]),g),{})}const rz=vr.setTimeout,sz=vr.clearTimeout;function dm(E,f){f.useNativeTimers?(E.setTimeoutFn=rz.bind(vr),E.clearTimeoutFn=sz.bind(vr)):(E.setTimeoutFn=vr.setTimeout.bind(vr),E.clearTimeoutFn=vr.clearTimeout.bind(vr))}const oz=1.33;function az(E){return typeof E=="string"?cz(E):Math.ceil((E.byteLength||E.size)*oz)}function cz(E){let f=0,g=0;for(let C=0,D=E.length;C<D;C++)f=E.charCodeAt(C),f<128?g+=1:f<2048?g+=2:f<55296||f>=57344?g+=3:(C++,g+=4);return g}function yk(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function dz(E){let f="";for(let g in E)E.hasOwnProperty(g)&&(f.length&&(f+="&"),f+=encodeURIComponent(g)+"="+encodeURIComponent(E[g]));return f}function lz(E){let f={},g=E.split("&");for(let C=0,D=g.length;C<D;C++){let U=g[C].split("=");f[decodeURIComponent(U[0])]=decodeURIComponent(U[1])}return f}class uz extends Error{constructor(f,g,C){super(f),this.description=g,this.context=C,this.type="TransportError"}}class sT extends Wn{constructor(f){super(),this.writable=!1,dm(this,f),this.opts=f,this.query=f.query,this.socket=f.socket,this.supportsBinary=!f.forceBase64}onError(f,g,C){return super.emitReserved("error",new uz(f,g,C)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(f){this.readyState==="open"&&this.write(f)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(f){const g=rT(f,this.socket.binaryType);this.onPacket(g)}onPacket(f){super.emitReserved("packet",f)}onClose(f){this.readyState="closed",super.emitReserved("close",f)}pause(f){}createUri(f,g={}){return f+"://"+this._hostname()+this._port()+this.opts.path+this._query(g)}_hostname(){const f=this.opts.hostname;return f.indexOf(":")===-1?f:"["+f+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port)!==443||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(f){const g=dz(f);return g.length?"?"+g:""}}class hz extends sT{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(f){this.readyState="pausing";const g=()=>{this.readyState="paused",f()};if(this._polling||!this.writable){let C=0;this._polling&&(C++,this.once("pollComplete",function(){--C||g()})),this.writable||(C++,this.once("drain",function(){--C||g()}))}else g()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(f){const g=C=>{if(this.readyState==="opening"&&C.type==="open"&&this.onOpen(),C.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(C)};$Y(f,this.socket.binaryType).forEach(g),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const f=()=>{this.write([{type:"close"}])};this.readyState==="open"?f():this.once("open",f)}write(f){this.writable=!1,ZY(f,g=>{this.doWrite(g,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const f=this.opts.secure?"https":"http",g=this.query||{};return this.opts.timestampRequests!==!1&&(g[this.opts.timestampParam]=yk()),!this.supportsBinary&&!g.sid&&(g.b64=1),this.createUri(f,g)}}let vk=!1;try{vk=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const pz=vk;function mz(){}class fz extends hz{constructor(f){if(super(f),typeof location<"u"){const g=location.protocol==="https:";let C=location.port;C||(C=g?"443":"80"),this.xd=typeof location<"u"&&f.hostname!==location.hostname||C!==f.port}}doWrite(f,g){const C=this.request({method:"POST",data:f});C.on("success",g),C.on("error",(D,U)=>{this.onError("xhr post error",D,U)})}doPoll(){const f=this.request();f.on("data",this.onData.bind(this)),f.on("error",(g,C)=>{this.onError("xhr poll error",g,C)}),this.pollXhr=f}}class vs extends Wn{constructor(f,g,C){super(),this.createRequest=f,dm(this,C),this._opts=C,this._method=C.method||"GET",this._uri=g,this._data=C.data!==void 0?C.data:null,this._create()}_create(){var f;const g=Tk(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");g.xdomain=!!this._opts.xd;const C=this._xhr=this.createRequest(g);try{C.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){C.setDisableHeaderCheck&&C.setDisableHeaderCheck(!0);for(let D in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(D)&&C.setRequestHeader(D,this._opts.extraHeaders[D])}}catch{}if(this._method==="POST")try{C.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{C.setRequestHeader("Accept","*/*")}catch{}(f=this._opts.cookieJar)===null||f===void 0||f.addCookies(C),"withCredentials"in C&&(C.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(C.timeout=this._opts.requestTimeout),C.onreadystatechange=()=>{var D;C.readyState===3&&((D=this._opts.cookieJar)===null||D===void 0||D.parseCookies(C.getResponseHeader("set-cookie"))),C.readyState===4&&(C.status===200||C.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof C.status=="number"?C.status:0)},0))},C.send(this._data)}catch(D){this.setTimeoutFn(()=>{this._onError(D)},0);return}typeof document<"u"&&(this._index=vs.requestsCount++,vs.requests[this._index]=this)}_onError(f){this.emitReserved("error",f,this._xhr),this._cleanup(!0)}_cleanup(f){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=mz,f)try{this._xhr.abort()}catch{}typeof document<"u"&&delete vs.requests[this._index],this._xhr=null}}_onLoad(){const f=this._xhr.responseText;f!==null&&(this.emitReserved("data",f),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}vs.requestsCount=0;vs.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",XL);else if(typeof addEventListener=="function"){const E="onpagehide"in vr?"pagehide":"unload";addEventListener(E,XL,!1)}}function XL(){for(let E in vs.requests)vs.requests.hasOwnProperty(E)&&vs.requests[E].abort()}const _z=(function(){const E=Rk({xdomain:!1});return E&&E.responseType!==null})();class Ez extends fz{constructor(f){super(f);const g=f&&f.forceBase64;this.supportsBinary=_z&&!g}request(f={}){return Object.assign(f,{xd:this.xd},this.opts),new vs(Rk,this.uri(),f)}}function Rk(E){const f=E.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!f||pz))return new XMLHttpRequest}catch{}if(!f)try{return new vr[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Ck=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class gz extends sT{get name(){return"websocket"}doOpen(){const f=this.uri(),g=this.opts.protocols,C=Ck?{}:Tk(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(C.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(f,g,C)}catch(D){return this.emitReserved("error",D)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=f=>this.onClose({description:"websocket connection closed",context:f}),this.ws.onmessage=f=>this.onData(f.data),this.ws.onerror=f=>this.onError("websocket error",f)}write(f){this.writable=!1;for(let g=0;g<f.length;g++){const C=f[g],D=g===f.length-1;iT(C,this.supportsBinary,U=>{try{this.doWrite(C,U)}catch{}D&&cm(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const f=this.opts.secure?"wss":"ws",g=this.query||{};return this.opts.timestampRequests&&(g[this.opts.timestampParam]=yk()),this.supportsBinary||(g.b64=1),this.createUri(f,g)}}const BS=vr.WebSocket||vr.MozWebSocket;class Sz extends gz{createSocket(f,g,C){return Ck?new BS(f,g,C):g?new BS(f,g):new BS(f)}doWrite(f,g){this.ws.send(g)}}class Tz extends sT{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(f){return this.emitReserved("error",f)}this._transport.closed.then(()=>{this.onClose()}).catch(f=>{this.onError("webtransport error",f)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(f=>{const g=tz(Number.MAX_SAFE_INTEGER,this.socket.binaryType),C=f.readable.pipeThrough(g).getReader(),D=ez();D.readable.pipeTo(f.writable),this._writer=D.writable.getWriter();const U=()=>{C.read().then(({done:te,value:z})=>{te||(this.onPacket(z),U())}).catch(te=>{})};U();const B={type:"open"};this.query.sid&&(B.data=`{"sid":"${this.query.sid}"}`),this._writer.write(B).then(()=>this.onOpen())})})}write(f){this.writable=!1;for(let g=0;g<f.length;g++){const C=f[g],D=g===f.length-1;this._writer.write(C).then(()=>{D&&cm(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var f;(f=this._transport)===null||f===void 0||f.close()}}const yz={websocket:Sz,webtransport:Tz,polling:Ez},vz=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Rz=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function KS(E){if(E.length>8e3)throw"URI too long";const f=E,g=E.indexOf("["),C=E.indexOf("]");g!=-1&&C!=-1&&(E=E.substring(0,g)+E.substring(g,C).replace(/:/g,";")+E.substring(C,E.length));let D=vz.exec(E||""),U={},B=14;for(;B--;)U[Rz[B]]=D[B]||"";return g!=-1&&C!=-1&&(U.source=f,U.host=U.host.substring(1,U.host.length-1).replace(/;/g,":"),U.authority=U.authority.replace("[","").replace("]","").replace(/;/g,":"),U.ipv6uri=!0),U.pathNames=Cz(U,U.path),U.queryKey=bz(U,U.query),U}function Cz(E,f){const g=/\/{2,9}/g,C=f.replace(g,"/").split("/");return(f.slice(0,1)=="/"||f.length===0)&&C.splice(0,1),f.slice(-1)=="/"&&C.splice(C.length-1,1),C}function bz(E,f){const g={};return f.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(C,D,U){D&&(g[D]=U)}),g}const YS=typeof addEventListener=="function"&&typeof removeEventListener=="function",Xp=[];YS&&addEventListener("offline",()=>{Xp.forEach(E=>E())},!1);class Io extends Wn{constructor(f,g){if(super(),this.binaryType=iz,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,f&&typeof f=="object"&&(g=f,f=null),f){const C=KS(f);g.hostname=C.host,g.secure=C.protocol==="https"||C.protocol==="wss",g.port=C.port,C.query&&(g.query=C.query)}else g.host&&(g.hostname=KS(g.host).host);dm(this,g),this.secure=g.secure!=null?g.secure:typeof location<"u"&&location.protocol==="https:",g.hostname&&!g.port&&(g.port=this.secure?"443":"80"),this.hostname=g.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=g.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},g.transports.forEach(C=>{const D=C.prototype.name;this.transports.push(D),this._transportsByName[D]=C}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},g),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=lz(this.opts.query)),YS&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},Xp.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(f){const g=Object.assign({},this.opts.query);g.EIO=Sk,g.transport=f,this.id&&(g.sid=this.id);const C=Object.assign({},this.opts,{query:g,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[f]);return new this._transportsByName[f](C)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const f=this.opts.rememberUpgrade&&Io.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const g=this.createTransport(f);g.open(),this.setTransport(g)}setTransport(f){this.transport&&this.transport.removeAllListeners(),this.transport=f,f.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",g=>this._onClose("transport close",g))}onOpen(){this.readyState="open",Io.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(f){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",f),this.emitReserved("heartbeat"),f.type){case"open":this.onHandshake(JSON.parse(f.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const g=new Error("server error");g.code=f.data,this._onError(g);break;case"message":this.emitReserved("data",f.data),this.emitReserved("message",f.data);break}}onHandshake(f){this.emitReserved("handshake",f),this.id=f.sid,this.transport.query.sid=f.sid,this._pingInterval=f.pingInterval,this._pingTimeout=f.pingTimeout,this._maxPayload=f.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const f=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+f,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},f),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const f=this._getWritablePackets();this.transport.send(f),this._prevBufferLen=f.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let g=1;for(let C=0;C<this.writeBuffer.length;C++){const D=this.writeBuffer[C].data;if(D&&(g+=az(D)),C>0&&g>this._maxPayload)return this.writeBuffer.slice(0,C);g+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const f=Date.now()>this._pingTimeoutTime;return f&&(this._pingTimeoutTime=0,cm(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),f}write(f,g,C){return this._sendPacket("message",f,g,C),this}send(f,g,C){return this._sendPacket("message",f,g,C),this}_sendPacket(f,g,C,D){if(typeof g=="function"&&(D=g,g=void 0),typeof C=="function"&&(D=C,C=null),this.readyState==="closing"||this.readyState==="closed")return;C=C||{},C.compress=C.compress!==!1;const U={type:f,data:g,options:C};this.emitReserved("packetCreate",U),this.writeBuffer.push(U),D&&this.once("flush",D),this.flush()}close(){const f=()=>{this._onClose("forced close"),this.transport.close()},g=()=>{this.off("upgrade",g),this.off("upgradeError",g),f()},C=()=>{this.once("upgrade",g),this.once("upgradeError",g)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?C():f()}):this.upgrading?C():f()),this}_onError(f){if(Io.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",f),this._onClose("transport error",f)}_onClose(f,g){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),YS&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const C=Xp.indexOf(this._offlineEventListener);C!==-1&&Xp.splice(C,1)}this.readyState="closed",this.id=null,this.emitReserved("close",f,g),this.writeBuffer=[],this._prevBufferLen=0}}}Io.protocol=Sk;class Iz extends Io{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let f=0;f<this._upgrades.length;f++)this._probe(this._upgrades[f])}_probe(f){let g=this.createTransport(f),C=!1;Io.priorWebsocketSuccess=!1;const D=()=>{C||(g.send([{type:"ping",data:"probe"}]),g.once("packet",ee=>{if(!C)if(ee.type==="pong"&&ee.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",g),!g)return;Io.priorWebsocketSuccess=g.name==="websocket",this.transport.pause(()=>{C||this.readyState!=="closed"&&(ne(),this.setTransport(g),g.send([{type:"upgrade"}]),this.emitReserved("upgrade",g),g=null,this.upgrading=!1,this.flush())})}else{const q=new Error("probe error");q.transport=g.name,this.emitReserved("upgradeError",q)}}))};function U(){C||(C=!0,ne(),g.close(),g=null)}const B=ee=>{const q=new Error("probe error: "+ee);q.transport=g.name,U(),this.emitReserved("upgradeError",q)};function te(){B("transport closed")}function z(){B("socket closed")}function _e(ee){g&&ee.name!==g.name&&U()}const ne=()=>{g.removeListener("open",D),g.removeListener("error",B),g.removeListener("close",te),this.off("close",z),this.off("upgrading",_e)};g.once("open",D),g.once("error",B),g.once("close",te),this.once("close",z),this.once("upgrading",_e),this._upgrades.indexOf("webtransport")!==-1&&f!=="webtransport"?this.setTimeoutFn(()=>{C||g.open()},200):g.open()}onHandshake(f){this._upgrades=this._filterUpgrades(f.upgrades),super.onHandshake(f)}_filterUpgrades(f){const g=[];for(let C=0;C<f.length;C++)~this.transports.indexOf(f[C])&&g.push(f[C]);return g}}let wz=class extends Iz{constructor(f,g={}){const C=typeof f=="object"?f:g;(!C.transports||C.transports&&typeof C.transports[0]=="string")&&(C.transports=(C.transports||["polling","websocket","webtransport"]).map(D=>yz[D]).filter(D=>!!D)),super(f,C)}};function Az(E,f="",g){let C=E;g=g||typeof location<"u"&&location,E==null&&(E=g.protocol+"//"+g.host),typeof E=="string"&&(E.charAt(0)==="/"&&(E.charAt(1)==="/"?E=g.protocol+E:E=g.host+E),/^(https?|wss?):\/\//.test(E)||(typeof g<"u"?E=g.protocol+"//"+E:E="https://"+E),C=KS(E)),C.port||(/^(http|ws)$/.test(C.protocol)?C.port="80":/^(http|ws)s$/.test(C.protocol)&&(C.port="443")),C.path=C.path||"/";const U=C.host.indexOf(":")!==-1?"["+C.host+"]":C.host;return C.id=C.protocol+"://"+U+":"+C.port+f,C.href=C.protocol+"://"+U+(g&&g.port===C.port?"":":"+C.port),C}const Oz=typeof ArrayBuffer=="function",Nz=E=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(E):E.buffer instanceof ArrayBuffer,bk=Object.prototype.toString,Dz=typeof Blob=="function"||typeof Blob<"u"&&bk.call(Blob)==="[object BlobConstructor]",Pz=typeof File=="function"||typeof File<"u"&&bk.call(File)==="[object FileConstructor]";function oT(E){return Oz&&(E instanceof ArrayBuffer||Nz(E))||Dz&&E instanceof Blob||Pz&&E instanceof File}function Jp(E,f){if(!E||typeof E!="object")return!1;if(Array.isArray(E)){for(let g=0,C=E.length;g<C;g++)if(Jp(E[g]))return!0;return!1}if(oT(E))return!0;if(E.toJSON&&typeof E.toJSON=="function"&&arguments.length===1)return Jp(E.toJSON(),!0);for(const g in E)if(Object.prototype.hasOwnProperty.call(E,g)&&Jp(E[g]))return!0;return!1}function Lz(E){const f=[],g=E.data,C=E;return C.data=zS(g,f),C.attachments=f.length,{packet:C,buffers:f}}function zS(E,f){if(!E)return E;if(oT(E)){const g={_placeholder:!0,num:f.length};return f.push(E),g}else if(Array.isArray(E)){const g=new Array(E.length);for(let C=0;C<E.length;C++)g[C]=zS(E[C],f);return g}else if(typeof E=="object"&&!(E instanceof Date)){const g={};for(const C in E)Object.prototype.hasOwnProperty.call(E,C)&&(g[C]=zS(E[C],f));return g}return E}function kz(E,f){return E.data=qS(E.data,f),delete E.attachments,E}function qS(E,f){if(!E)return E;if(E&&E._placeholder===!0){if(typeof E.num=="number"&&E.num>=0&&E.num<f.length)return f[E.num];throw new Error("illegal attachments")}else if(Array.isArray(E))for(let g=0;g<E.length;g++)E[g]=qS(E[g],f);else if(typeof E=="object")for(const g in E)Object.prototype.hasOwnProperty.call(E,g)&&(E[g]=qS(E[g],f));return E}const xz=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var Mt;(function(E){E[E.CONNECT=0]="CONNECT",E[E.DISCONNECT=1]="DISCONNECT",E[E.EVENT=2]="EVENT",E[E.ACK=3]="ACK",E[E.CONNECT_ERROR=4]="CONNECT_ERROR",E[E.BINARY_EVENT=5]="BINARY_EVENT",E[E.BINARY_ACK=6]="BINARY_ACK"})(Mt||(Mt={}));class Mz{constructor(f){this.replacer=f}encode(f){return(f.type===Mt.EVENT||f.type===Mt.ACK)&&Jp(f)?this.encodeAsBinary({type:f.type===Mt.EVENT?Mt.BINARY_EVENT:Mt.BINARY_ACK,nsp:f.nsp,data:f.data,id:f.id}):[this.encodeAsString(f)]}encodeAsString(f){let g=""+f.type;return(f.type===Mt.BINARY_EVENT||f.type===Mt.BINARY_ACK)&&(g+=f.attachments+"-"),f.nsp&&f.nsp!=="/"&&(g+=f.nsp+","),f.id!=null&&(g+=f.id),f.data!=null&&(g+=JSON.stringify(f.data,this.replacer)),g}encodeAsBinary(f){const g=Lz(f),C=this.encodeAsString(g.packet),D=g.buffers;return D.unshift(C),D}}class aT extends Wn{constructor(f){super(),this.reviver=f}add(f){let g;if(typeof f=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");g=this.decodeString(f);const C=g.type===Mt.BINARY_EVENT;C||g.type===Mt.BINARY_ACK?(g.type=C?Mt.EVENT:Mt.ACK,this.reconstructor=new Uz(g),g.attachments===0&&super.emitReserved("decoded",g)):super.emitReserved("decoded",g)}else if(oT(f)||f.base64)if(this.reconstructor)g=this.reconstructor.takeBinaryData(f),g&&(this.reconstructor=null,super.emitReserved("decoded",g));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+f)}decodeString(f){let g=0;const C={type:Number(f.charAt(0))};if(Mt[C.type]===void 0)throw new Error("unknown packet type "+C.type);if(C.type===Mt.BINARY_EVENT||C.type===Mt.BINARY_ACK){const U=g+1;for(;f.charAt(++g)!=="-"&&g!=f.length;);const B=f.substring(U,g);if(B!=Number(B)||f.charAt(g)!=="-")throw new Error("Illegal attachments");C.attachments=Number(B)}if(f.charAt(g+1)==="/"){const U=g+1;for(;++g&&!(f.charAt(g)===","||g===f.length););C.nsp=f.substring(U,g)}else C.nsp="/";const D=f.charAt(g+1);if(D!==""&&Number(D)==D){const U=g+1;for(;++g;){const B=f.charAt(g);if(B==null||Number(B)!=B){--g;break}if(g===f.length)break}C.id=Number(f.substring(U,g+1))}if(f.charAt(++g)){const U=this.tryParse(f.substr(g));if(aT.isPayloadValid(C.type,U))C.data=U;else throw new Error("invalid payload")}return C}tryParse(f){try{return JSON.parse(f,this.reviver)}catch{return!1}}static isPayloadValid(f,g){switch(f){case Mt.CONNECT:return JL(g);case Mt.DISCONNECT:return g===void 0;case Mt.CONNECT_ERROR:return typeof g=="string"||JL(g);case Mt.EVENT:case Mt.BINARY_EVENT:return Array.isArray(g)&&(typeof g[0]=="number"||typeof g[0]=="string"&&xz.indexOf(g[0])===-1);case Mt.ACK:case Mt.BINARY_ACK:return Array.isArray(g)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Uz{constructor(f){this.packet=f,this.buffers=[],this.reconPack=f}takeBinaryData(f){if(this.buffers.push(f),this.buffers.length===this.reconPack.attachments){const g=kz(this.reconPack,this.buffers);return this.finishedReconstruction(),g}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function JL(E){return Object.prototype.toString.call(E)==="[object Object]"}const Vz=Object.freeze(Object.defineProperty({__proto__:null,Decoder:aT,Encoder:Mz,get PacketType(){return Mt}},Symbol.toStringTag,{value:"Module"}));function Xr(E,f,g){return E.on(f,g),function(){E.off(f,g)}}const jz=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Ik extends Wn{constructor(f,g,C){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=f,this.nsp=g,C&&C.auth&&(this.auth=C.auth),this._opts=Object.assign({},C),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const f=this.io;this.subs=[Xr(f,"open",this.onopen.bind(this)),Xr(f,"packet",this.onpacket.bind(this)),Xr(f,"error",this.onerror.bind(this)),Xr(f,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...f){return f.unshift("message"),this.emit.apply(this,f),this}emit(f,...g){var C,D,U;if(jz.hasOwnProperty(f))throw new Error('"'+f.toString()+'" is a reserved event name');if(g.unshift(f),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(g),this;const B={type:Mt.EVENT,data:g};if(B.options={},B.options.compress=this.flags.compress!==!1,typeof g[g.length-1]=="function"){const ne=this.ids++,ee=g.pop();this._registerAckCallback(ne,ee),B.id=ne}const te=(D=(C=this.io.engine)===null||C===void 0?void 0:C.transport)===null||D===void 0?void 0:D.writable,z=this.connected&&!(!((U=this.io.engine)===null||U===void 0)&&U._hasPingExpired());return this.flags.volatile&&!te||(z?(this.notifyOutgoingListeners(B),this.packet(B)):this.sendBuffer.push(B)),this.flags={},this}_registerAckCallback(f,g){var C;const D=(C=this.flags.timeout)!==null&&C!==void 0?C:this._opts.ackTimeout;if(D===void 0){this.acks[f]=g;return}const U=this.io.setTimeoutFn(()=>{delete this.acks[f];for(let te=0;te<this.sendBuffer.length;te++)this.sendBuffer[te].id===f&&this.sendBuffer.splice(te,1);g.call(this,new Error("operation has timed out"))},D),B=(...te)=>{this.io.clearTimeoutFn(U),g.apply(this,te)};B.withError=!0,this.acks[f]=B}emitWithAck(f,...g){return new Promise((C,D)=>{const U=(B,te)=>B?D(B):C(te);U.withError=!0,g.push(U),this.emit(f,...g)})}_addToQueue(f){let g;typeof f[f.length-1]=="function"&&(g=f.pop());const C={id:this._queueSeq++,tryCount:0,pending:!1,args:f,flags:Object.assign({fromQueue:!0},this.flags)};f.push((D,...U)=>(this._queue[0],D!==null?C.tryCount>this._opts.retries&&(this._queue.shift(),g&&g(D)):(this._queue.shift(),g&&g(null,...U)),C.pending=!1,this._drainQueue())),this._queue.push(C),this._drainQueue()}_drainQueue(f=!1){if(!this.connected||this._queue.length===0)return;const g=this._queue[0];g.pending&&!f||(g.pending=!0,g.tryCount++,this.flags=g.flags,this.emit.apply(this,g.args))}packet(f){f.nsp=this.nsp,this.io._packet(f)}onopen(){typeof this.auth=="function"?this.auth(f=>{this._sendConnectPacket(f)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(f){this.packet({type:Mt.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},f):f})}onerror(f){this.connected||this.emitReserved("connect_error",f)}onclose(f,g){this.connected=!1,delete this.id,this.emitReserved("disconnect",f,g),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(f=>{if(!this.sendBuffer.some(C=>String(C.id)===f)){const C=this.acks[f];delete this.acks[f],C.withError&&C.call(this,new Error("socket has been disconnected"))}})}onpacket(f){if(f.nsp===this.nsp)switch(f.type){case Mt.CONNECT:f.data&&f.data.sid?this.onconnect(f.data.sid,f.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case Mt.EVENT:case Mt.BINARY_EVENT:this.onevent(f);break;case Mt.ACK:case Mt.BINARY_ACK:this.onack(f);break;case Mt.DISCONNECT:this.ondisconnect();break;case Mt.CONNECT_ERROR:this.destroy();const C=new Error(f.data.message);C.data=f.data.data,this.emitReserved("connect_error",C);break}}onevent(f){const g=f.data||[];f.id!=null&&g.push(this.ack(f.id)),this.connected?this.emitEvent(g):this.receiveBuffer.push(Object.freeze(g))}emitEvent(f){if(this._anyListeners&&this._anyListeners.length){const g=this._anyListeners.slice();for(const C of g)C.apply(this,f)}super.emit.apply(this,f),this._pid&&f.length&&typeof f[f.length-1]=="string"&&(this._lastOffset=f[f.length-1])}ack(f){const g=this;let C=!1;return function(...D){C||(C=!0,g.packet({type:Mt.ACK,id:f,data:D}))}}onack(f){const g=this.acks[f.id];typeof g=="function"&&(delete this.acks[f.id],g.withError&&f.data.unshift(null),g.apply(this,f.data))}onconnect(f,g){this.id=f,this.recovered=g&&this._pid===g,this._pid=g,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(f=>this.emitEvent(f)),this.receiveBuffer=[],this.sendBuffer.forEach(f=>{this.notifyOutgoingListeners(f),this.packet(f)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(f=>f()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:Mt.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(f){return this.flags.compress=f,this}get volatile(){return this.flags.volatile=!0,this}timeout(f){return this.flags.timeout=f,this}onAny(f){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(f),this}prependAny(f){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(f),this}offAny(f){if(!this._anyListeners)return this;if(f){const g=this._anyListeners;for(let C=0;C<g.length;C++)if(f===g[C])return g.splice(C,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(f){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(f),this}prependAnyOutgoing(f){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(f),this}offAnyOutgoing(f){if(!this._anyOutgoingListeners)return this;if(f){const g=this._anyOutgoingListeners;for(let C=0;C<g.length;C++)if(f===g[C])return g.splice(C,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(f){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const g=this._anyOutgoingListeners.slice();for(const C of g)C.apply(this,f.data)}}}function td(E){E=E||{},this.ms=E.min||100,this.max=E.max||1e4,this.factor=E.factor||2,this.jitter=E.jitter>0&&E.jitter<=1?E.jitter:0,this.attempts=0}td.prototype.duration=function(){var E=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var f=Math.random(),g=Math.floor(f*this.jitter*E);E=(Math.floor(f*10)&1)==0?E-g:E+g}return Math.min(E,this.max)|0};td.prototype.reset=function(){this.attempts=0};td.prototype.setMin=function(E){this.ms=E};td.prototype.setMax=function(E){this.max=E};td.prototype.setJitter=function(E){this.jitter=E};class XS extends Wn{constructor(f,g){var C;super(),this.nsps={},this.subs=[],f&&typeof f=="object"&&(g=f,f=void 0),g=g||{},g.path=g.path||"/socket.io",this.opts=g,dm(this,g),this.reconnection(g.reconnection!==!1),this.reconnectionAttempts(g.reconnectionAttempts||1/0),this.reconnectionDelay(g.reconnectionDelay||1e3),this.reconnectionDelayMax(g.reconnectionDelayMax||5e3),this.randomizationFactor((C=g.randomizationFactor)!==null&&C!==void 0?C:.5),this.backoff=new td({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(g.timeout==null?2e4:g.timeout),this._readyState="closed",this.uri=f;const D=g.parser||Vz;this.encoder=new D.Encoder,this.decoder=new D.Decoder,this._autoConnect=g.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(f){return arguments.length?(this._reconnection=!!f,f||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(f){return f===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=f,this)}reconnectionDelay(f){var g;return f===void 0?this._reconnectionDelay:(this._reconnectionDelay=f,(g=this.backoff)===null||g===void 0||g.setMin(f),this)}randomizationFactor(f){var g;return f===void 0?this._randomizationFactor:(this._randomizationFactor=f,(g=this.backoff)===null||g===void 0||g.setJitter(f),this)}reconnectionDelayMax(f){var g;return f===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=f,(g=this.backoff)===null||g===void 0||g.setMax(f),this)}timeout(f){return arguments.length?(this._timeout=f,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(f){if(~this._readyState.indexOf("open"))return this;this.engine=new wz(this.uri,this.opts);const g=this.engine,C=this;this._readyState="opening",this.skipReconnect=!1;const D=Xr(g,"open",function(){C.onopen(),f&&f()}),U=te=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",te),f?f(te):this.maybeReconnectOnOpen()},B=Xr(g,"error",U);if(this._timeout!==!1){const te=this._timeout,z=this.setTimeoutFn(()=>{D(),U(new Error("timeout")),g.close()},te);this.opts.autoUnref&&z.unref(),this.subs.push(()=>{this.clearTimeoutFn(z)})}return this.subs.push(D),this.subs.push(B),this}connect(f){return this.open(f)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const f=this.engine;this.subs.push(Xr(f,"ping",this.onping.bind(this)),Xr(f,"data",this.ondata.bind(this)),Xr(f,"error",this.onerror.bind(this)),Xr(f,"close",this.onclose.bind(this)),Xr(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(f){try{this.decoder.add(f)}catch(g){this.onclose("parse error",g)}}ondecoded(f){cm(()=>{this.emitReserved("packet",f)},this.setTimeoutFn)}onerror(f){this.emitReserved("error",f)}socket(f,g){let C=this.nsps[f];return C?this._autoConnect&&!C.active&&C.connect():(C=new Ik(this,f,g),this.nsps[f]=C),C}_destroy(f){const g=Object.keys(this.nsps);for(const C of g)if(this.nsps[C].active)return;this._close()}_packet(f){const g=this.encoder.encode(f);for(let C=0;C<g.length;C++)this.engine.write(g[C],f.options)}cleanup(){this.subs.forEach(f=>f()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(f,g){var C;this.cleanup(),(C=this.engine)===null||C===void 0||C.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",f,g),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const f=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const g=this.backoff.duration();this._reconnecting=!0;const C=this.setTimeoutFn(()=>{f.skipReconnect||(this.emitReserved("reconnect_attempt",f.backoff.attempts),!f.skipReconnect&&f.open(D=>{D?(f._reconnecting=!1,f.reconnect(),this.emitReserved("reconnect_error",D)):f.onreconnect()}))},g);this.opts.autoUnref&&C.unref(),this.subs.push(()=>{this.clearTimeoutFn(C)})}}onreconnect(){const f=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",f)}}const Nl={};function Qp(E,f){typeof E=="object"&&(f=E,E=void 0),f=f||{};const g=Az(E,f.path||"/socket.io"),C=g.source,D=g.id,U=g.path,B=Nl[D]&&U in Nl[D].nsps,te=f.forceNew||f["force new connection"]||f.multiplex===!1||B;let z;return te?z=new XS(C,f):(Nl[D]||(Nl[D]=new XS(C,f)),z=Nl[D]),g.query&&!f.query&&(f.query=g.queryKey),z.socket(g.path,f)}Object.assign(Qp,{Manager:XS,Socket:Ik,io:Qp,connect:Qp});let $c=null,Zp=0;function wk(){return $c||($c=Qp(window.location.origin,{path:"/socket.io",transports:["websocket","polling"],withCredentials:!0})),Zp++,$c}function Ak(){Zp--,Zp<=0&&$c&&($c.disconnect(),$c=null,Zp=0)}function Fz(E="general"){const[f,g]=W.useState([]),[C,D]=W.useState(!1),[U,B]=W.useState(null),te=W.useRef(null);W.useEffect(()=>{const ne=wk();te.current=ne;const ee=()=>{D(!0),ne.emit("chat:join",{room:E})},q=()=>D(!1),ce=Se=>{Array.isArray(Se)?g(Se):(console.warn("chat:history received non-array:",Se),g([]))},ae=Se=>{Se&&Se.id&&Se.content!==void 0&&g(xe=>[...xe,Se])},Te=Se=>B(Se?.message||"Chat error");return ne.on("connect",ee),ne.on("disconnect",q),ne.on("chat:history",ce),ne.on("chat:message",ae),ne.on("chat:error",Te),ne.connected&&(D(!0),ne.emit("chat:join",{room:E})),()=>{ne.off("connect",ee),ne.off("disconnect",q),ne.off("chat:history",ce),ne.off("chat:message",ae),ne.off("chat:error",Te),Ak()}},[E]);const z=W.useCallback(ne=>{te.current&&ne.trim()&&te.current.emit("chat:message",{room:E,content:ne})},[E]),_e=W.useCallback(ne=>{g(ee=>[...ee,ne])},[]);return{messages:f,connected:C,error:U,sendMessage:z,pushMessage:_e}}function Bz(E){const f=W.useRef(null),[g,C]=W.useState(!1);W.useEffect(()=>{const B=wk();f.current=B;const te=()=>C(!0),z=()=>C(!1),_e=ne=>E&&E(ne);return B.on("connect",te),B.on("disconnect",z),B.on("dm:received",_e),B.connected&&C(!0),()=>{B.off("connect",te),B.off("disconnect",z),B.off("dm:received",_e),Ak()}},[]);const D=W.useCallback((B,te)=>{f.current&&f.current.emit("dm:send",{recipientId:B,content:te})},[]),U=W.useCallback(B=>{f.current&&f.current.emit("dm:typing",{recipientId:B})},[]);return{sendDM:D,sendTyping:U,connected:g}}function Wz(E){const f=Date.now()-new Date(E).getTime(),g=Math.floor(f/6e4);if(g<1)return"now";if(g<60)return`${g}m`;const C=Math.floor(g/60);return C<24?`${C}h`:`${Math.floor(C/24)}d`}function Gz(){const[E,f]=W.useState(!1),[g,C]=W.useState(""),{user:D}=$i(),{messages:U,connected:B,sendMessage:te,pushMessage:z}=Fz("general"),_e=W.useRef(null),ne=W.useRef(null),ee=W.useRef(!1);W.useEffect(()=>{E&&!B&&!ee.current&&U.length===0&&(ee.current=!0,Me.getChatHistory("general").then(ae=>{ae.success&&Array.isArray(ae.messages)&&ae.messages.forEach(Te=>z(Te))}).catch(ae=>{console.warn("Failed to load chat history:",ae)}))},[E,B,U.length]),W.useEffect(()=>{E&&_e.current&&_e.current.scrollIntoView({behavior:"smooth"})},[U,E]),W.useEffect(()=>{E&&ne.current&&ne.current.focus()},[E]);const q=async()=>{const ae=g.trim();if(!(!ae||!D))if(C(""),B)te(ae);else try{const Te=await Me.sendChatRest("general",ae);Te.message&&z(Te.message)}catch{}},ce=ae=>{ae.key==="Enter"&&!ae.shiftKey&&(ae.preventDefault(),q())};return D?m.jsxs(m.Fragment,{children:[m.jsxs("button",{onClick:()=>f(ae=>!ae),className:"chat-widget-fab",title:"Community Chat","aria-label":"Open community chat",children:[E?m.jsx(ZS,{size:22}):m.jsx(im,{size:22}),!E&&U.length>0&&m.jsx("span",{className:"chat-widget-badge"})]}),E&&m.jsxs("div",{className:"chat-widget-panel",children:[m.jsxs("div",{className:"chat-widget-header",children:[m.jsx("span",{children:"Community Chat"}),m.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[m.jsx("span",{className:`chat-status-dot ${B?"connected":"disconnected"}`}),m.jsx("button",{onClick:()=>f(!1),className:"chat-close-btn",children:m.jsx(TY,{size:18})})]})]}),m.jsxs("div",{className:"chat-messages-list",children:[U.length===0&&m.jsx("div",{style:{textAlign:"center",color:"var(--text-muted)",fontSize:13,padding:"20px 0"},children:"No messages yet. Say hi!"}),U.map(ae=>m.jsxs("div",{className:`chat-message ${ae.user_id===D.id?"own":""}`,children:[ae.user_id!==D.id&&m.jsx("div",{className:"chat-message-author",children:ae.first_name||ae.username}),m.jsx("div",{className:"chat-bubble",children:ae.content}),m.jsx("div",{className:"chat-message-time",children:Wz(ae.created_at)})]},ae.id)),m.jsx("div",{ref:_e})]}),m.jsxs("div",{className:"chat-input-row",children:[m.jsx("input",{ref:ne,type:"text",value:g,onChange:ae=>C(ae.target.value),onKeyDown:ce,placeholder:"Message...",maxLength:2e3,className:"chat-input"}),m.jsx("button",{onClick:q,disabled:!g.trim(),className:"chat-send-btn",children:m.jsx($S,{size:16})})]})]})]}):null}function Un({children:E}){return m.jsxs("div",{className:"app-layout",children:[m.jsx(KY,{}),m.jsx("main",{className:"app-main",children:E}),m.jsx(zY,{}),m.jsx(Gz,{})]})}function Hz(E){const f=Date.now()-new Date(E).getTime(),g=Math.floor(f/6e4);if(g<1)return"now";if(g<60)return`${g}m`;const C=Math.floor(g/60);return C<24?`${C}h`:`${Math.floor(C/24)}d`}function cT({post:E,onDeleted:f}){const{user:g}=$i(),[C,D]=W.useState(E.liked_by_me),[U,B]=W.useState(E.likes_count||0),[te,z]=W.useState(!1),[_e,ne]=W.useState([]),[ee,q]=W.useState(!1),[ce,ae]=W.useState(""),Te=async()=>{try{const dt=await Me.toggleLike(E.id);D(dt.liked),B(Fe=>dt.liked?Fe+1:Math.max(0,Fe-1))}catch{}},Se=async()=>{if(confirm("Delete this post?"))try{await Me.deletePost(E.id),f&&f(E.id)}catch{}},xe=async()=>{if(te){z(!1);return}try{const dt=await Me.getReplies(E.id);ne(dt.replies||[]),z(!0)}catch{}},it=async()=>{if(ce.trim())try{await Me.createPost({content:ce,replyToId:E.id}),ae(""),q(!1);const dt=await Me.getReplies(E.id);ne(dt.replies||[]),z(!0)}catch{}};return m.jsxs("div",{className:"post-card",children:[m.jsxs("div",{className:"post-header",children:[m.jsx("div",{className:"post-avatar",children:m.jsx("div",{className:"post-avatar-placeholder",children:(E.author_first_name||E.author_username||"?")[0].toUpperCase()})}),m.jsxs("div",{style:{flex:1},children:[m.jsx(dn,{to:`/wall/${E.author_id}`,className:"post-author-name",children:E.author_first_name||E.author_username}),E.author_username&&m.jsxs("span",{className:"post-author-handle",children:["@",E.author_username]}),m.jsx("div",{className:"post-time",children:Hz(E.created_at)})]}),E.author_id===g?.id&&m.jsx("button",{onClick:Se,className:"post-delete-btn",title:"Delete",children:m.jsx(sm,{size:14})})]}),E.repost_content&&m.jsxs("div",{className:"post-repost-preview",children:[m.jsx(yY,{size:12,style:{opacity:.6}}),m.jsxs("span",{children:[E.repost_author_first_name||E.repost_author_username,": ",E.repost_content.slice(0,100)]})]}),m.jsx("div",{className:"post-content",children:E.content}),E.media_url&&E.media_type==="image"&&m.jsx("img",{src:E.media_url,alt:"",className:"post-media"}),E.media_url&&E.media_type==="video"&&m.jsx("video",{src:E.media_url,controls:!0,className:"post-media",style:{maxHeight:400}}),m.jsxs("div",{className:"post-actions",children:[m.jsxs("button",{onClick:Te,className:`post-action-btn ${C?"liked":""}`,children:[m.jsx(vY,{size:16,fill:C?"currentColor":"none"}),m.jsx("span",{children:U})]}),m.jsxs("button",{onClick:xe,className:"post-action-btn",children:[m.jsx(BL,{size:16}),m.jsx("span",{children:E.replies_count||0})]}),m.jsx(dn,{to:`/messages/${E.author_id}`,className:"post-action-btn",style:{textDecoration:"none"},children:m.jsx(BL,{size:16,style:{opacity:0}})})]}),te&&m.jsxs("div",{className:"post-replies",children:[_e.map(dt=>m.jsxs("div",{className:"reply-item",children:[m.jsxs("span",{className:"reply-author",children:[dt.author_first_name||dt.author_username,":"]}),m.jsxs("span",{className:"reply-content",children:[" ",dt.content]})]},dt.id)),m.jsx("button",{onClick:()=>q(dt=>!dt),className:"post-action-btn",style:{marginTop:8},children:ee?"Cancel":"Reply"}),ee&&m.jsxs("div",{className:"reply-compose",children:[m.jsx("input",{type:"text",value:ce,onChange:dt=>ae(dt.target.value),placeholder:"Write a reply...",className:"reply-input",onKeyDown:dt=>dt.key==="Enter"&&it()}),m.jsx("button",{onClick:it,className:"chat-send-btn",disabled:!ce.trim(),children:"Reply"})]})]})]})}function Kz(){const[E,f]=W.useState(null);return W.useEffect(()=>{let g=!1;return Me.getRadioNowPlaying().then(C=>{!g&&C.track&&f(C.track)}).catch(()=>{}),()=>{g=!0}},[]),E?m.jsxs("div",{className:"card",style:{display:"flex",alignItems:"center",gap:12,padding:"12px 16px",marginBottom:4},children:[m.jsx("div",{style:{width:36,height:36,borderRadius:8,background:"linear-gradient(135deg, #ff453a, #ff6b35)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:m.jsx(RY,{size:18,color:"#fff"})}),m.jsxs("div",{style:{flex:1,minWidth:0},children:[m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:2},children:"Now Playing"}),m.jsx("div",{style:{fontWeight:600,fontSize:14,color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:E.title||"PNPtv Radio"}),E.artist&&E.artist!=="Starting Soon"&&m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:E.artist})]}),m.jsx(eT,{size:16,style:{color:"var(--accent)",flexShrink:0,animation:"pulse 2s infinite"}})]}):null}function Yz(){const[E,f]=W.useState([]),[g,C]=W.useState(!0);return W.useEffect(()=>{let D=!1;return Me.getFeed().then(U=>{D||f((U.posts||[]).slice(0,5))}).catch(()=>{}).finally(()=>{D||C(!1)}),()=>{D=!0}},[]),g?m.jsx("div",{className:"card",style:{textAlign:"center",padding:32},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):E.length===0?m.jsxs("div",{className:"card",style:{textAlign:"center",padding:24},children:[m.jsx("p",{style:{color:"var(--text-muted)",fontSize:14,marginBottom:12},children:"No posts yet. Be the first!"}),m.jsxs(dn,{to:"/feed",className:"btn-primary",style:{display:"inline-flex",alignItems:"center",gap:6,fontSize:13,textDecoration:"none"},children:[m.jsx(lk,{size:14})," Go to Feed"]})]}):m.jsxs("div",{children:[m.jsxs("div",{className:"card",style:{padding:"10px 16px",display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[m.jsx("span",{style:{fontWeight:600,fontSize:14,color:"var(--text)"},children:"Latest Posts"}),m.jsx(dn,{to:"/feed",style:{fontSize:12,color:"var(--text-muted)",textDecoration:"none"},children:"See all "})]}),E.map(D=>m.jsx(cT,{post:D},D.id))]})}function zz(){const{user:E}=$i(),[f,g]=W.useState(null),[C,D]=W.useState(null),[U,B]=W.useState(null),[te,z]=W.useState(null);W.useEffect(()=>{Me.getLatestPrimeVideo().then(ne=>g(ne.data)).catch(()=>{}),Me.getLatestVideoramaVideo().then(ne=>D(ne.data)).catch(()=>{}),Me.getActiveLiveStreams().then(ne=>B(ne.data)).catch(()=>{}),Me.getMostActiveHangout().then(ne=>z(ne.data)).catch(()=>{})},[]);const _e=({badge:ne,badgeColor:ee,title:q,subtitle:ce,image:ae,cta:Te,ctaText:Se,onClick:xe})=>m.jsxs("div",{onClick:xe,style:{background:"linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.6))",backgroundImage:ae?`url(${ae})`:"none",backgroundSize:"cover",backgroundPosition:"center",borderRadius:12,overflow:"hidden",cursor:"pointer",aspectRatio:"16/9",display:"flex",flexDirection:"column",justifyContent:"space-between",padding:16,position:"relative",textDecoration:"none",color:"inherit",transition:"transform 0.2s, box-shadow 0.2s"},onMouseEnter:it=>{it.currentTarget.style.transform="scale(1.02)",it.currentTarget.style.boxShadow="0 8px 16px rgba(0,0,0,0.3)"},onMouseLeave:it=>{it.currentTarget.style.transform="scale(1)",it.currentTarget.style.boxShadow="none"},as:dn,to:Te,className:"card",children:[m.jsx("span",{style:{display:"inline-block",background:ee||"var(--accent)",color:"#fff",padding:"4px 8px",borderRadius:6,fontSize:11,fontWeight:600,width:"fit-content",textShadow:"0 1px 2px rgba(0,0,0,0.3)"},children:ne}),m.jsxs("div",{children:[m.jsx("div",{style:{fontWeight:600,fontSize:16,color:"#fff",marginBottom:4,textShadow:"0 2px 4px rgba(0,0,0,0.5)"},children:q}),m.jsx("div",{style:{fontSize:13,color:"rgba(255,255,255,0.8)",marginBottom:12,textShadow:"0 1px 2px rgba(0,0,0,0.3)"},children:ce}),m.jsx("button",{style:{background:"var(--accent)",color:"#fff",border:"none",padding:"6px 12px",borderRadius:6,fontSize:12,fontWeight:600,cursor:"pointer"},onClick:it=>{it.preventDefault(),xe?.()},children:Se})]})]});return m.jsxs(Un,{children:[m.jsxs("div",{className:"welcome-banner",children:[m.jsxs("h2",{children:["Welcome",E?.firstName?`, ${E.firstName}`:"","!"]}),m.jsx("p",{children:"Your PNPtv hub - explore, connect, and enjoy."})]}),m.jsx(Kz,{}),m.jsx("div",{className:"section-label",children:"Featured Content"}),m.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(240px, 1fr))",gap:12,marginBottom:24},children:[f&&m.jsx(dn,{to:"/videorama",style:{textDecoration:"none"},children:m.jsx(_e,{badge:" PRIME",badgeColor:"#D4AF37",title:f.title,subtitle:f.artist,image:f.cover,cta:"/suscripcion",ctaText:"Subscribe"})}),C&&m.jsx(dn,{to:"/videorama",style:{textDecoration:"none"},children:m.jsx(_e,{badge:" VIDEORAMA",badgeColor:"#1abc9c",title:C.title,subtitle:C.artist,image:C.cover,cta:"/videorama",ctaText:"Watch"})}),U&&m.jsx(dn,{to:"/livestream",style:{textDecoration:"none"},children:m.jsx(_e,{badge:" LIVE",badgeColor:"#ff453a",title:U.title,subtitle:U.host,image:U.thumbnail,cta:"/livestream",ctaText:"Join"})}),te&&m.jsx(dn,{to:"/hangouts",style:{textDecoration:"none"},children:m.jsx(_e,{badge:" HANGOUT",badgeColor:"#007AFF",title:te.title,subtitle:`${te.members||0} members`,image:te.thumbnail,cta:"/hangouts",ctaText:"Join"})})]}),m.jsx("div",{className:"section-label",children:"Latest Posts"}),m.jsx(Yz,{})]})}function qz({status:E}){const g={active:{label:"Active",className:"active"},lifetime:{label:"Lifetime",className:"active"},trial:{label:"Trial",className:"active"},expired:{label:"Expired",className:"expired"},cancelled:{label:"Cancelled",className:"expired"}}[E]||{label:E||"Inactive",className:"inactive"};return m.jsx("span",{className:`sub-badge ${g.className}`,children:g.label})}function Xz({photoUrl:E,onUpload:f,uploading:g}){const C=ck.useRef(null),[D,U]=W.useState(null),B=async te=>{const z=te.target.files?.[0];if(!z)return;const _e=new FileReader;_e.onload=ne=>U(ne.target.result),_e.readAsDataURL(z);try{await f(z),U(null)}catch{U(null)}};return m.jsxs("div",{style:{position:"relative",display:"inline-block",margin:"0 auto"},children:[m.jsx("div",{className:"profile-avatar",onClick:()=>C.current?.click(),style:{cursor:"pointer",position:"relative"},title:"Click to upload avatar",children:D?m.jsx("img",{src:D,alt:"Preview"}):E?m.jsx("img",{src:E,alt:"Avatar"}):m.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%",fontSize:28,fontWeight:700,color:"var(--accent-pink)"},children:g?"...":""})}),m.jsx("input",{ref:C,type:"file",accept:"image/*",onChange:B,disabled:g,style:{display:"none"}})]})}function Dl({label:E,value:f,editing:g,name:C,form:D,onChange:U,placeholder:B,textarea:te}){if(!g)return f?m.jsxs("div",{className:"profile-row",children:[m.jsx("span",{className:"profile-row-label",children:E}),m.jsx("span",{className:"profile-row-value",children:f})]}):null;const z={name:C,value:D[C]??"",onChange:U,placeholder:B||E,className:"profile-edit-input"};return m.jsxs("div",{className:"profile-row profile-row-edit",children:[m.jsx("span",{className:"profile-row-label",children:E}),te?m.jsx("textarea",{...z,rows:3,className:"profile-edit-textarea"}):m.jsx("input",{...z})]})}function Jz(){const{user:E,logout:f}=$i();pY();const[g,C]=W.useState(null),[D,U]=W.useState(!0),[B,te]=W.useState(!1),[z,_e]=W.useState(!1),[ne,ee]=W.useState(!1),[q,ce]=W.useState(""),[ae,Te]=W.useState({});W.useEffect(()=>{let et=!1;return Me.getProfile().then(be=>{!et&&be.success&&C(be.profile)}).catch(()=>{}).finally(()=>{et||U(!1)}),()=>{et=!0}},[]);const Se=()=>{Te({firstName:g?.firstName||"",lastName:g?.lastName||"",bio:g?.bio||"",locationText:g?.locationText||"",interests:Array.isArray(g?.interests)?g.interests.join(", "):g?.interests||"",xHandle:g?.xHandle||"",instagramHandle:g?.instagramHandle||"",tiktokHandle:g?.tiktokHandle||""}),ce(""),te(!0)},xe=()=>{te(!1),ce("")},it=et=>Te(be=>({...be,[et.target.name]:et.target.value})),dt=async()=>{_e(!0),ce("");try{await Me.updateProfile(ae);const et=await Me.getProfile();et.success&&C(et.profile),te(!1)}catch(et){ce(et.message||"Failed to save profile")}finally{_e(!1)}},Fe=async et=>{ee(!0),ce("");try{const be=await Me.uploadAvatar(et);C(oe=>({...oe,photoUrl:be.photoUrl}))}catch(be){ce(be.message||"Failed to upload avatar")}finally{ee(!1)}},Ht=et=>et?new Date(et).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"N/A";return m.jsx(Un,{children:D?m.jsx("div",{style:{textAlign:"center",padding:48},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):m.jsxs(m.Fragment,{children:[m.jsxs("div",{className:"card profile-header-card",children:[m.jsx(Xz,{photoUrl:g?.photoUrl,onUpload:Fe,uploading:ne}),B?m.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[m.jsx("input",{name:"firstName",value:ae.firstName,onChange:it,placeholder:"First name",className:"profile-edit-input",style:{maxWidth:130}}),m.jsx("input",{name:"lastName",value:ae.lastName,onChange:it,placeholder:"Last name",className:"profile-edit-input",style:{maxWidth:130}})]}):m.jsxs("div",{className:"profile-name",children:[g?.firstName||E?.firstName||""," ",g?.lastName||E?.lastName||""]}),m.jsxs("div",{className:"profile-username",children:["@",g?.username||E?.username||"user"]}),B?m.jsx("textarea",{name:"bio",value:ae.bio,onChange:it,placeholder:"Bio (optional)",rows:3,className:"profile-edit-textarea",style:{marginTop:8}}):g?.bio&&m.jsx("p",{className:"profile-bio",children:g.bio}),q&&m.jsx("div",{style:{color:"#ff453a",fontSize:13,marginTop:6},children:q}),m.jsx("div",{style:{display:"flex",gap:10,marginTop:12,justifyContent:"center"},children:B?m.jsxs(m.Fragment,{children:[m.jsxs("button",{className:"btn-secondary",onClick:xe,disabled:z,style:{display:"flex",alignItems:"center",gap:6,fontSize:13},children:[m.jsx(ZS,{size:14})," Cancel"]}),m.jsxs("button",{className:"btn-primary",onClick:dt,disabled:z,style:{display:"flex",alignItems:"center",gap:6,fontSize:13},children:[m.jsx(CY,{size:14})," ",z?"Saving":"Save"]})]}):m.jsxs("button",{className:"btn-secondary",onClick:Se,style:{display:"flex",alignItems:"center",gap:6,fontSize:13},children:[m.jsx(tT,{size:14})," Edit Profile"]})}),m.jsxs("div",{className:"profile-stats",style:{marginTop:16},children:[m.jsxs("div",{className:"profile-stat",children:[m.jsx("div",{className:"profile-stat-value",children:m.jsx(tm,{size:16,style:{display:"inline",verticalAlign:"middle"}})}),m.jsx("div",{className:"profile-stat-label",children:m.jsx(qz,{status:g?.subscriptionStatus||E?.subscriptionStatus})})]}),m.jsxs("div",{className:"profile-stat",children:[m.jsx("div",{className:"profile-stat-value",children:m.jsx(bY,{size:16,style:{display:"inline",verticalAlign:"middle"}})}),m.jsxs("div",{className:"profile-stat-label",children:["Since ",Ht(g?.memberSince)]})]})]})]}),m.jsx("div",{className:"section-label",children:"Account"}),m.jsxs("div",{className:"card profile-section",children:[m.jsxs("div",{className:"profile-row",children:[m.jsx("span",{className:"profile-row-label",children:"Subscription"}),m.jsx("span",{className:"profile-row-value",children:g?.subscriptionPlan||"None"})]}),g?.subscriptionExpires&&m.jsxs("div",{className:"profile-row",children:[m.jsx("span",{className:"profile-row-label",children:"Expires"}),m.jsx("span",{className:"profile-row-value",children:Ht(g.subscriptionExpires)})]}),m.jsxs("div",{className:"profile-row",children:[m.jsx("span",{className:"profile-row-label",children:"Language"}),m.jsx("span",{className:"profile-row-value",children:g?.language==="es"?"Espaol":"English"})]}),m.jsx(Dl,{label:"Location",value:g?.locationText,editing:B,name:"locationText",form:ae,onChange:it,placeholder:"Your city or area"}),m.jsx(Dl,{label:"Interests",value:Array.isArray(g?.interests)?g.interests.join(", "):g?.interests,editing:B,name:"interests",form:ae,onChange:it,placeholder:"e.g. music, travel, art"})]}),m.jsx("div",{className:"section-label",children:"Social"}),m.jsxs("div",{className:"card profile-section",children:[m.jsx(Dl,{label:"X (Twitter)",value:g?.xHandle?`@${g.xHandle}`:null,editing:B,name:"xHandle",form:ae,onChange:it,placeholder:"username (without @)"}),m.jsx(Dl,{label:"Instagram",value:g?.instagramHandle?`@${g.instagramHandle}`:null,editing:B,name:"instagramHandle",form:ae,onChange:it,placeholder:"username (without @)"}),m.jsx(Dl,{label:"TikTok",value:g?.tiktokHandle?`@${g.tiktokHandle}`:null,editing:B,name:"tiktokHandle",form:ae,onChange:it,placeholder:"username (without @)"}),!B&&!g?.xHandle&&!g?.instagramHandle&&!g?.tiktokHandle&&m.jsx("div",{style:{color:"var(--text-muted)",fontSize:13,padding:"8px 0"},children:"No social handles yet. Click Edit Profile to add them."})]}),m.jsxs("button",{className:"btn-logout",onClick:f,children:[m.jsx(nT,{size:16,style:{display:"inline",verticalAlign:"middle",marginRight:8}}),"Sign Out"]})]})})}const Qz=[1,5,10,25,50];function Zz(E){return E<1?`${Math.round(E*1e3)} m`:`${E.toFixed(1)} km`}function $z(){const[E,f]=W.useState("idle"),[g,C]=W.useState([]),[D,U]=W.useState(5),[B,te]=W.useState(null),[z,_e]=W.useState(""),ne=W.useCallback(()=>{if(!navigator.geolocation){f("error"),_e("Geolocation is not supported by your browser.");return}f("locating"),_e(""),navigator.geolocation.getCurrentPosition(q=>{const{latitude:ce,longitude:ae,accuracy:Te}=q.coords;te({latitude:ce,longitude:ae}),f("searching"),Me.nearbyUpdateLocation(ce,ae,Te).catch(()=>{}).then(()=>Me.nearbySearch(ce,ae,D)).then(Se=>{C(Se.users||Se.nearby||[]),f("done")}).catch(Se=>{f("error"),_e(Se.message||"Failed to search nearby users.")})},q=>{f("error"),_e(q.code===1?"Location access denied. Please allow location in your browser settings.":q.code===2?"Location unavailable. Try again.":"Location request timed out. Try again.")},{enableHighAccuracy:!0,timeout:12e3,maximumAge:6e4})},[D]),ee=W.useCallback(()=>{if(!B){ne();return}f("searching"),Me.nearbySearch(B.latitude,B.longitude,D).then(q=>{C(q.users||q.nearby||[]),f("done")}).catch(q=>{f("error"),_e(q.message||"Search failed.")})},[B,D,ne]);return m.jsxs(Un,{children:[m.jsx("div",{className:"section-label",children:"Nearby"}),m.jsxs("div",{className:"card",style:{display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,flex:1},children:[m.jsx(Pl,{size:16,color:"var(--accent)"}),m.jsx("span",{style:{fontSize:13,color:"var(--text-muted)"},children:"Radius:"}),m.jsx("select",{value:D,onChange:q=>U(Number(q.target.value)),style:{background:"var(--surface-2)",border:"1px solid var(--border)",borderRadius:8,color:"var(--text)",padding:"4px 8px",fontSize:13},children:Qz.map(q=>m.jsxs("option",{value:q,children:[q," km"]},q))})]}),m.jsx("button",{className:"btn-primary",onClick:E==="done"?ee:ne,disabled:E==="locating"||E==="searching",style:{display:"flex",alignItems:"center",gap:6,fontSize:13,padding:"8px 16px"},children:E==="locating"||E==="searching"?m.jsxs(m.Fragment,{children:[m.jsx("div",{className:"loading-spinner",style:{width:14,height:14,borderWidth:2}})," ",E==="locating"?"Locating":"Searching"]}):E==="done"?m.jsxs(m.Fragment,{children:[m.jsx(om,{size:14})," Refresh"]}):m.jsxs(m.Fragment,{children:[m.jsx(am,{size:14})," Find Nearby"]})})]}),E==="error"&&m.jsx("div",{className:"card",style:{color:"#ff453a",fontSize:14,padding:"14px 16px"},children:z}),E==="done"&&g.length===0&&m.jsxs("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:[m.jsx(Pl,{size:32,style:{opacity:.3,margin:"0 auto 12px",display:"block"}}),m.jsxs("p",{children:["No users found within ",D," km."]}),m.jsx("p",{style:{fontSize:13,marginTop:6},children:"Try increasing the radius."})]}),E==="idle"&&m.jsxs("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:[m.jsx(Pl,{size:32,style:{opacity:.3,margin:"0 auto 12px",display:"block"}}),m.jsxs("p",{children:["Tap ",m.jsx("strong",{children:"Find Nearby"})," to discover members around you."]}),m.jsx("p",{style:{fontSize:12,marginTop:8},children:"Your location is only shared while searching."})]}),E==="done"&&g.length>0&&m.jsxs(m.Fragment,{children:[m.jsxs("div",{style:{fontSize:13,color:"var(--text-muted)",padding:"4px 0 8px"},children:[g.length," member",g.length!==1?"s":""," within ",D," km"]}),g.map(q=>m.jsxs("div",{className:"card",style:{display:"flex",alignItems:"center",gap:12},children:[m.jsx("div",{style:{width:44,height:44,borderRadius:"50%",background:"var(--surface-2)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:18,fontWeight:700,color:"var(--accent)",flexShrink:0},children:(q.name||q.username||"?")[0].toUpperCase()}),m.jsxs("div",{style:{flex:1,minWidth:0},children:[m.jsx(dn,{to:`/wall/${q.id||q.userId}`,style:{fontWeight:600,fontSize:15,color:"var(--text)",textDecoration:"none"},children:q.name||q.username||"User"}),q.username&&m.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["@",q.username]}),(q.distance_km!==void 0||q.distance!==void 0)&&m.jsxs("div",{style:{fontSize:12,color:"var(--accent)",marginTop:2},children:[m.jsx(Pl,{size:11,style:{display:"inline",verticalAlign:"middle"}})," ",Zz(q.distance_km??q.distance)]})]}),m.jsxs(dn,{to:`/messages/${q.id||q.userId}`,className:"btn-secondary",style:{display:"flex",alignItems:"center",gap:4,fontSize:12,padding:"6px 10px",flexShrink:0,textDecoration:"none"},children:[m.jsx(im,{size:13})," DM"]})]},q.id||q.userId))]})]})}function eq(E){if(!E)return"";const f=Date.now()-new Date(E).getTime(),g=Math.floor(f/6e4);return g<1?"just now":g<60?`${g}m ago`:`${Math.floor(g/60)}h ago`}let QL=!1,Hp=null;function tq(){return QL?Promise.resolve():Hp||(Hp=new Promise((E,f)=>{const g=document.createElement("script");g.src="https://8x8.vc/libs/external_api.min.js",g.onload=()=>{QL=!0,E()},g.onerror=()=>f(new Error("Failed to load Jitsi API")),document.head.appendChild(g)}),Hp)}function nq({activeCall:E,userName:f,onLeave:g,onEnd:C}){const D=W.useRef(null),U=W.useRef(null),[B,te]=W.useState("");return W.useEffect(()=>{let z=!1;return(async()=>{try{if(await tq(),z||!D.current)return;if(!window.JitsiMeetExternalAPI)throw new Error("JitsiMeetExternalAPI not available");const ne=new URL(E.jitsiUrl),ee=ne.pathname.split("/").filter(Boolean),q=ee[0],ce=ee[1],ae=ne.searchParams.get("jwt"),Te=new window.JitsiMeetExternalAPI("8x8.vc",{roomName:`${q}/${ce}`,jwt:ae,parentNode:D.current,width:"100%",height:"100%",configOverwrite:{startWithAudioMuted:!1,startWithVideoMuted:!1,disableDeepLinking:!0,prejoinPageEnabled:!1},interfaceConfigOverwrite:{SHOW_JITSI_WATERMARK:!1,SHOW_WATERMARK_FOR_GUESTS:!1,TOOLBAR_BUTTONS:["microphone","camera","closedcaptions","desktop","fullscreen","fodeviceselection","hangup","chat","raisehand","videoquality","tileview","select-background","stats"]},userInfo:{displayName:f||"Guest"}});U.current=Te,Te.addEventListener("readyToClose",()=>{z||g()}),Te.addEventListener("videoConferenceLeft",()=>{z||g()})}catch(ne){z||te(ne.message||"Failed to load video call")}})(),()=>{if(z=!0,U.current){try{U.current.dispose()}catch{}U.current=null}}},[E.jitsiUrl]),m.jsxs("div",{style:{position:"fixed",inset:0,zIndex:1e3,background:"#000",display:"flex",flexDirection:"column"},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 16px",background:"rgba(0,0,0,0.8)",borderBottom:"1px solid rgba(255,255,255,0.1)",flexShrink:0},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,color:"#fff",fontSize:14},children:[m.jsx(xl,{size:16,style:{color:"#30d158"}}),m.jsx("span",{style:{fontWeight:600},children:E.title||`${E.creatorName||"Host"}'s Room`})]}),m.jsxs("div",{style:{display:"flex",gap:8},children:[E.isModerator&&m.jsxs("button",{onClick:C,style:{display:"flex",alignItems:"center",gap:6,padding:"6px 14px",borderRadius:8,border:"none",cursor:"pointer",background:"rgba(255,69,58,0.2)",color:"#ff453a",fontSize:13,fontWeight:600},children:[m.jsx(uk,{size:14})," End Room"]}),m.jsxs("button",{onClick:g,style:{display:"flex",alignItems:"center",gap:6,padding:"6px 14px",borderRadius:8,border:"none",cursor:"pointer",background:"rgba(255,255,255,0.1)",color:"#fff",fontSize:13,fontWeight:600},children:[m.jsx(nT,{size:14})," Leave"]})]})]}),m.jsx("div",{ref:D,style:{flex:1,width:"100%",overflow:"hidden"},children:B&&m.jsx("div",{style:{color:"#ff453a",textAlign:"center",padding:40},children:B})})]})}function iq(){const{user:E}=$i(),[f,g]=W.useState([]),[C,D]=W.useState(!0),[U,B]=W.useState(!1),[te,z]=W.useState(!1),[_e,ne]=W.useState(""),[ee,q]=W.useState(""),[ce,ae]=W.useState(null),[Te,Se]=W.useState(null),xe=W.useCallback(async()=>{try{const be=await Me.getPublicHangouts();g(be.rooms||[])}catch{g([])}finally{D(!1)}},[]);W.useEffect(()=>{xe();const be=setInterval(xe,3e4);return()=>clearInterval(be)},[xe]);const it=(be,{title:oe,creatorName:Lt,isModerator:Rn})=>{be.jitsiUrl?Se({jitsiUrl:be.jitsiUrl,room:be.room,id:be.id,isModerator:Rn??!1,title:oe,creatorName:Lt}):window.open(`https://meet.jit.si/${be.room}`,"_blank","noopener")},dt=async()=>{q(""),B(!0);try{const be=await Me.createHangout({title:_e.trim()||null,isPublic:!0});z(!1),ne("");const oe=E?.firstName||E?.username||"You";it(be,{title:_e.trim()||null,creatorName:oe,isModerator:!0}),await xe()}catch(be){q(be.message||"Failed to create room")}finally{B(!1)}},Fe=async be=>{ae(be.id),q("");try{const oe=await Me.joinHangout(be.id);it(oe,{title:be.title,creatorName:be.creatorName,isModerator:oe.isModerator})}catch(oe){q(oe.message||"Failed to join room")}finally{ae(null)}},Ht=W.useCallback(async()=>{if(Te){try{await Me.leaveHangout(Te.id)}catch{}Se(null),xe()}},[Te,xe]),et=W.useCallback(async()=>{if(Te){try{await Me.endHangout(Te.id)}catch{}Se(null),xe()}},[Te,xe]);if(Te){const be=E?.firstName||E?.username||"Guest";return m.jsx(nq,{activeCall:Te,userName:be,onLeave:Ht,onEnd:et})}return m.jsxs(Un,{children:[m.jsxs("div",{className:"page-header",children:[m.jsx("h2",{className:"page-title",children:"Hangouts"}),m.jsxs("div",{style:{display:"flex",gap:8},children:[m.jsx("button",{onClick:xe,className:"btn-secondary",style:{padding:"6px 10px"},title:"Refresh",children:m.jsx(om,{size:15})}),m.jsxs("button",{onClick:()=>{z(be=>!be),q("")},className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6},children:[m.jsx(Ml,{size:16})," New Room"]})]})]}),te&&m.jsxs("div",{className:"card",style:{marginBottom:12,padding:16},children:[m.jsx("div",{style:{marginBottom:10,fontWeight:600,color:"var(--text-primary)"},children:"Create a Room"}),m.jsx("input",{type:"text",value:_e,onChange:be=>ne(be.target.value),placeholder:"Room title (optional)",maxLength:80,className:"chat-input",style:{width:"100%",marginBottom:10},onKeyDown:be=>be.key==="Enter"&&dt(),autoFocus:!0}),ee&&m.jsx("div",{className:"login-error",style:{marginBottom:8},children:ee}),m.jsxs("div",{style:{display:"flex",gap:8},children:[m.jsxs("button",{onClick:dt,disabled:U,className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6},children:[m.jsx(xl,{size:15}),U?"Starting...":"Start Room"]}),m.jsx("button",{onClick:()=>z(!1),className:"btn-secondary",children:"Cancel"})]})]}),ee&&!te&&m.jsx("div",{className:"login-error",style:{marginBottom:12},children:ee}),C?m.jsx("div",{style:{textAlign:"center",padding:40},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):f.length===0?m.jsxs("div",{className:"card",style:{textAlign:"center",padding:40},children:[m.jsx(xl,{size:36,style:{margin:"0 auto 12px",display:"block",opacity:.3}}),m.jsx("div",{style:{color:"var(--text-muted)",marginBottom:16},children:"No active rooms. Start one!"}),m.jsxs("button",{onClick:()=>z(!0),className:"btn-primary",style:{display:"inline-flex",alignItems:"center",gap:6},children:[m.jsx(Ml,{size:16})," New Room"]})]}):m.jsx("div",{style:{display:"flex",flexDirection:"column",gap:10},children:f.map(be=>m.jsx("div",{className:"card",style:{padding:16},children:m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[m.jsxs("div",{style:{flex:1,minWidth:0},children:[m.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)",marginBottom:4,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:be.title||`${be.creatorName}'s Room`}),m.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,fontSize:13,color:"var(--text-muted)"},children:[m.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[m.jsx(Ia,{size:13}),be.currentParticipants??0,"/",be.maxParticipants]}),m.jsxs("span",{children:["by ",be.creatorName]}),m.jsx("span",{children:eq(be.createdAt)})]})]}),m.jsxs("button",{onClick:()=>Fe(be),disabled:ce===be.id,className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6,flexShrink:0},children:[m.jsx(xl,{size:14}),ce===be.id?"Joining...":"Join"]})]})},be.id))})]})}var $p={exports:{}},rq=$p.exports,ZL;function sq(){return ZL||(ZL=1,(function(E,f){(function(g,C){E.exports=C()})(rq,(function(){function g(e,t){return t.forEach((function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach((function(i){if(i!=="default"&&!(i in e)){var r=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(e,i,r.get?r:{enumerable:!0,get:function(){return n[i]}})}}))})),Object.freeze(e)}var C=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof US<"u"?US:typeof self<"u"?self:{};function D(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var U=function(e){try{return!!e()}catch{return!0}},B=!U((function(){var e=(function(){}).bind();return typeof e!="function"||e.hasOwnProperty("prototype")})),te=B,z=Function.prototype,_e=z.call,ne=te&&z.bind.bind(_e,_e),ee=te?ne:function(e){return function(){return _e.apply(e,arguments)}},q=ee({}.isPrototypeOf),ce=function(e){return e&&e.Math===Math&&e},ae=ce(typeof globalThis=="object"&&globalThis)||ce(typeof window=="object"&&window)||ce(typeof self=="object"&&self)||ce(typeof C=="object"&&C)||ce(typeof C=="object"&&C)||(function(){return this})()||Function("return this")(),Te=B,Se=Function.prototype,xe=Se.apply,it=Se.call,dt=typeof Reflect=="object"&&Reflect.apply||(Te?it.bind(xe):function(){return it.apply(xe,arguments)}),Fe=ee,Ht=Fe({}.toString),et=Fe("".slice),be=function(e){return et(Ht(e),8,-1)},oe=be,Lt=ee,Rn=function(e){if(oe(e)==="Function")return Lt(e)},ot=typeof document=="object"&&document.all,ln=ot===void 0&&ot!==void 0?function(e){return typeof e=="function"||e===ot}:function(e){return typeof e=="function"},Qe={},at=!U((function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7})),Rr=B,Fs=Function.prototype.call,An=Rr?Fs.bind(Fs):function(){return Fs.apply(Fs,arguments)},Vl={},dT={}.propertyIsEnumerable,lT=Object.getOwnPropertyDescriptor,Vk=lT&&!dT.call({1:2},1);Vl.f=Vk?function(e){var t=lT(this,e);return!!t&&t.enumerable}:dT;var Bs,jl,Ws=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},jk=U,Fk=be,um=Object,Bk=ee("".split),Fl=jk((function(){return!um("z").propertyIsEnumerable(0)}))?function(e){return Fk(e)==="String"?Bk(e,""):um(e)}:um,Bl=function(e){return e==null},Wk=Bl,Gk=TypeError,Gs=function(e){if(Wk(e))throw new Gk("Can't call method on "+e);return e},Hk=Fl,Kk=Gs,Hs=function(e){return Hk(Kk(e))},Yk=ln,Yn=function(e){return typeof e=="object"?e!==null:Yk(e)},bi={},hm=bi,pm=ae,zk=ln,uT=function(e){return zk(e)?e:void 0},ti=function(e,t){return arguments.length<2?uT(hm[e])||uT(pm[e]):hm[e]&&hm[e][t]||pm[e]&&pm[e][t]},hT=ae.navigator,pT=hT&&hT.userAgent,Cs=pT?String(pT):"",mT=ae,mm=Cs,fT=mT.process,_T=mT.Deno,ET=fT&&fT.versions||_T&&_T.version,gT=ET&&ET.v8;gT&&(jl=(Bs=gT.split("."))[0]>0&&Bs[0]<4?1:+(Bs[0]+Bs[1])),!jl&&mm&&(!(Bs=mm.match(/Edge\/(\d+)/))||Bs[1]>=74)&&(Bs=mm.match(/Chrome\/(\d+)/))&&(jl=+Bs[1]);var Ao=jl,ST=Ao,qk=U,Xk=ae.String,wa=!!Object.getOwnPropertySymbols&&!qk((function(){var e=Symbol("symbol detection");return!Xk(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&ST&&ST<41})),TT=wa&&!Symbol.sham&&typeof Symbol.iterator=="symbol",Jk=ti,Qk=ln,Zk=q,$k=Object,nd=TT?function(e){return typeof e=="symbol"}:function(e){var t=Jk("Symbol");return Qk(t)&&Zk(t.prototype,$k(e))},e1=String,Aa=function(e){try{return e1(e)}catch{return"Object"}},t1=ln,n1=Aa,i1=TypeError,Ii=function(e){if(t1(e))return e;throw new i1(n1(e)+" is not a function")},r1=Ii,s1=Bl,id=function(e,t){var n=e[t];return s1(n)?void 0:r1(n)},yT=An,vT=ln,RT=Yn,o1=TypeError,CT={exports:{}},bT=ae,a1=Object.defineProperty,c1=ae,d1=function(e,t){try{a1(bT,e,{value:t,configurable:!0,writable:!0})}catch{bT[e]=t}return t},IT="__core-js_shared__",wT=CT.exports=c1[IT]||d1(IT,{});(wT.versions||(wT.versions=[])).push({version:"3.46.0",mode:"pure",copyright:" 2014-2025 Denis Pushkarev (zloirock.ru), 2025 CoreJS Company (core-js.io)",license:"https://github.com/zloirock/core-js/blob/v3.46.0/LICENSE",source:"https://github.com/zloirock/core-js"});var fm=CT.exports,AT=fm,Oa=function(e,t){return AT[e]||(AT[e]=t||{})},l1=Gs,u1=Object,Qr=function(e){return u1(l1(e))},h1=Qr,p1=ee({}.hasOwnProperty),Vn=Object.hasOwn||function(e,t){return p1(h1(e),t)},m1=ee,f1=0,_1=Math.random(),E1=m1(1.1.toString),_m=function(e){return"Symbol("+(e===void 0?"":e)+")_"+E1(++f1+_1,36)},g1=Oa,OT=Vn,S1=_m,T1=wa,y1=TT,Na=ae.Symbol,Em=g1("wks"),v1=y1?Na.for||Na:Na&&Na.withoutSetter||S1,$t=function(e){return OT(Em,e)||(Em[e]=T1&&OT(Na,e)?Na[e]:v1("Symbol."+e)),Em[e]},R1=An,NT=Yn,DT=nd,C1=id,b1=function(e,t){var n,i;if(vT(n=e.toString)&&!RT(i=yT(n,e))||vT(n=e.valueOf)&&!RT(i=yT(n,e)))return i;throw new o1("Can't convert object to primitive value")},I1=TypeError,w1=$t("toPrimitive"),A1=function(e,t){if(!NT(e)||DT(e))return e;var n,i=C1(e,w1);if(i){if(n=R1(i,e,t),!NT(n)||DT(n))return n;throw new I1("Can't convert object to primitive value")}return b1(e)},O1=nd,gm=function(e){var t=A1(e,"string");return O1(t)?t:t+""},PT=Yn,Sm=ae.document,N1=PT(Sm)&&PT(Sm.createElement),Tm=function(e){return N1?Sm.createElement(e):{}},D1=Tm,LT=!at&&!U((function(){return Object.defineProperty(D1("div"),"a",{get:function(){return 7}}).a!==7})),P1=at,L1=An,k1=Vl,x1=Ws,M1=Hs,U1=gm,V1=Vn,j1=LT,kT=Object.getOwnPropertyDescriptor;Qe.f=P1?kT:function(e,t){if(e=M1(e),t=U1(t),j1)try{return kT(e,t)}catch{}if(V1(e,t))return x1(!L1(k1.f,e,t),e[t])};var F1=U,B1=ln,W1=/#|\.prototype\./,rd=function(e,t){var n=H1[G1(e)];return n===Y1||n!==K1&&(B1(t)?F1(t):!!t)},G1=rd.normalize=function(e){return String(e).replace(W1,".").toLowerCase()},H1=rd.data={},K1=rd.NATIVE="N",Y1=rd.POLYFILL="P",xT=rd,z1=Ii,q1=B,X1=Rn(Rn.bind),Ks=function(e,t){return z1(e),t===void 0?e:q1?X1(e,t):function(){return e.apply(t,arguments)}},er={},MT=at&&U((function(){return Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype!==42})),J1=Yn,Q1=String,Z1=TypeError,Ei=function(e){if(J1(e))return e;throw new Z1(Q1(e)+" is not an object")},$1=at,ex=LT,tx=MT,Wl=Ei,UT=gm,nx=TypeError,ym=Object.defineProperty,ix=Object.getOwnPropertyDescriptor,vm="enumerable",Rm="configurable",Cm="writable";er.f=$1?tx?function(e,t,n){if(Wl(e),t=UT(t),Wl(n),typeof e=="function"&&t==="prototype"&&"value"in n&&Cm in n&&!n[Cm]){var i=ix(e,t);i&&i[Cm]&&(e[t]=n.value,n={configurable:Rm in n?n[Rm]:i[Rm],enumerable:vm in n?n[vm]:i[vm],writable:!1})}return ym(e,t,n)}:ym:function(e,t,n){if(Wl(e),t=UT(t),Wl(n),ex)try{return ym(e,t,n)}catch{}if("get"in n||"set"in n)throw new nx("Accessors not supported");return"value"in n&&(e[t]=n.value),e};var rx=er,sx=Ws,Oo=at?function(e,t,n){return rx.f(e,t,sx(1,n))}:function(e,t,n){return e[t]=n,e},sd=ae,ox=dt,ax=Rn,cx=ln,dx=Qe.f,lx=xT,Da=bi,ux=Ks,Pa=Oo,VT=Vn,hx=function(e){var t=function(n,i,r){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(n);case 2:return new e(n,i)}return new e(n,i,r)}return ox(e,this,arguments)};return t.prototype=e.prototype,t},lt=function(e,t){var n,i,r,s,o,a,c,d,l,u=e.target,h=e.global,p=e.stat,R=e.proto,T=h?sd:p?sd[u]:sd[u]&&sd[u].prototype,y=h?Da:Da[u]||Pa(Da,u,{})[u],I=y.prototype;for(s in t)i=!(n=lx(h?s:u+(p?".":"#")+s,e.forced))&&T&&VT(T,s),a=y[s],i&&(c=e.dontCallGetSet?(l=dx(T,s))&&l.value:T[s]),o=i&&c?c:t[s],(n||R||typeof a!=typeof o)&&(d=e.bind&&i?ux(o,sd):e.wrap&&i?hx(o):R&&cx(o)?ax(o):o,(e.sham||o&&o.sham||a&&a.sham)&&Pa(d,"sham",!0),Pa(y,s,d),R&&(VT(Da,r=u+"Prototype")||Pa(Da,r,{}),Pa(Da[r],s,o),e.real&&I&&(n||!I[s])&&Pa(I,s,o)))},px=Math.ceil,mx=Math.floor,fx=Math.trunc||function(e){var t=+e;return(t>0?mx:px)(t)},_x=fx,bm=function(e){var t=+e;return t!=t||t===0?0:_x(t)},Ex=bm,gx=Math.max,Sx=Math.min,Im=function(e,t){var n=Ex(e);return n<0?gx(n+t,0):Sx(n,t)},Tx=bm,yx=Math.min,jT=function(e){var t=Tx(e);return t>0?yx(t,9007199254740991):0},vx=jT,Ys=function(e){return vx(e.length)},Rx=Hs,Cx=Im,bx=Ys,FT=function(e){return function(t,n,i){var r=Rx(t),s=bx(r);if(s===0)return!e&&-1;var o,a=Cx(i,s);if(e&&n!=n){for(;s>a;)if((o=r[a++])!=o)return!0}else for(;s>a;a++)if((e||a in r)&&r[a]===n)return e||a||0;return!e&&-1}},wm={includes:FT(!0),indexOf:FT(!1)},Ix=wm.includes;lt({target:"Array",proto:!0,forced:U((function(){return!Array(1).includes()}))},{includes:function(e){return Ix(this,e,arguments.length>1?arguments[1]:void 0)}});var wx=ae,Ax=bi,Fi=function(e,t){var n=Ax[e+"Prototype"],i=n&&n[t];if(i)return i;var r=wx[e],s=r&&r.prototype;return s&&s[t]},Ox=Fi("Array","includes"),Nx=Yn,Dx=be,Px=$t("match"),Am=function(e){var t;return Nx(e)&&((t=e[Px])!==void 0?!!t:Dx(e)==="RegExp")},Lx=Am,kx=TypeError,BT={};BT[$t("toStringTag")]="z";var Om=String(BT)==="[object z]",xx=Om,Mx=ln,Gl=be,Ux=$t("toStringTag"),Vx=Object,jx=Gl((function(){return arguments})())==="Arguments",zs=xx?Gl:function(e){var t,n,i;return e===void 0?"Undefined":e===null?"Null":typeof(n=(function(r,s){try{return r[s]}catch{}})(t=Vx(e),Ux))=="string"?n:jx?Gl(t):(i=Gl(t))==="Object"&&Mx(t.callee)?"Arguments":i},Fx=zs,Bx=String,gi=function(e){if(Fx(e)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return Bx(e)},Wx=$t("match"),Gx=lt,Hx=function(e){if(Lx(e))throw new kx("The method doesn't accept regular expressions");return e},Kx=Gs,WT=gi,Yx=function(e){var t=/./;try{"/./"[e](t)}catch{try{return t[Wx]=!1,"/./"[e](t)}catch{}}return!1},zx=ee("".indexOf);Gx({target:"String",proto:!0,forced:!Yx("includes")},{includes:function(e){return!!~zx(WT(Kx(this)),WT(Hx(e)),arguments.length>1?arguments[1]:void 0)}});var qx=Fi("String","includes"),GT=q,Xx=Ox,Jx=qx,Nm=Array.prototype,Dm=String.prototype,Qx=function(e){var t=e.includes;return e===Nm||GT(Nm,e)&&t===Nm.includes?Xx:typeof e=="string"||e===Dm||GT(Dm,e)&&t===Dm.includes?Jx:t},X=D(Qx),Zx=Ii,$x=Qr,eM=Fl,tM=Ys,HT=TypeError,KT="Reduce of empty array with no initial value",nM=function(e){return function(t,n,i,r){var s=$x(t),o=eM(s),a=tM(s);if(Zx(n),a===0&&i<2)throw new HT(KT);var c=e?a-1:0,d=e?-1:1;if(i<2)for(;;){if(c in o){r=o[c],c+=d;break}if(c+=d,e?c<0:a<=c)throw new HT(KT)}for(;e?c>=0:a>c;c+=d)c in o&&(r=n(r,o[c],c,s));return r}},iM={left:nM(!1)},rM=U,Hl=function(e,t){var n=[][e];return!!n&&rM((function(){n.call(null,t||function(){return 1},1)}))},od=ae,sM=Cs,oM=be,Kl=function(e){return sM.slice(0,e.length)===e},Pm=Kl("Bun/")?"BUN":Kl("Cloudflare-Workers")?"CLOUDFLARE":Kl("Deno/")?"DENO":Kl("Node.js/")?"NODE":od.Bun&&typeof Bun.version=="string"?"BUN":od.Deno&&typeof Deno.version=="object"?"DENO":oM(od.process)==="process"?"NODE":od.window&&od.document?"BROWSER":"REST",Yl=Pm==="NODE",aM=iM.left;lt({target:"Array",proto:!0,forced:!Yl&&Ao>79&&Ao<83||!Hl("reduce")},{reduce:function(e){var t=arguments.length;return aM(this,e,t,t>1?arguments[1]:void 0)}});var cM=Fi("Array","reduce"),dM=q,lM=cM,Lm=Array.prototype,uM=function(e){var t=e.reduce;return e===Lm||dM(Lm,e)&&t===Lm.reduce?lM:t},YT=uM,Bi=D(YT),hM=be,ad=Array.isArray||function(e){return hM(e)==="Array"},pM=lt,mM=ad,fM=ee([].reverse),zT=[1,2];pM({target:"Array",proto:!0,forced:String(zT)===String(zT.reverse())},{reverse:function(){return mM(this)&&(this.length=this.length),fM(this)}});var _M=Fi("Array","reverse"),EM=q,gM=_M,km=Array.prototype,SM=function(e){var t=e.reverse;return e===km||EM(km,e)&&t===km.reverse?gM:t},qT=SM,XT=D(qT),TM=_m,JT=Oa("keys"),zl=function(e){return JT[e]||(JT[e]=TM(e))},yM=!U((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),vM=Vn,RM=ln,CM=Qr,bM=yM,QT=zl("IE_PROTO"),xm=Object,IM=xm.prototype,Mm=bM?xm.getPrototypeOf:function(e){var t=CM(e);if(vM(t,QT))return t[QT];var n=t.constructor;return RM(n)&&t instanceof n?n.prototype:t instanceof xm?IM:null},wM=ee,AM=Ii,OM=Yn,NM=function(e){return OM(e)||e===null},DM=String,PM=TypeError,LM=function(e,t,n){try{return wM(AM(Object.getOwnPropertyDescriptor(e,t)[n]))}catch{}},kM=Yn,xM=Gs,MM=function(e){if(NM(e))return e;throw new PM("Can't set "+DM(e)+" as a prototype")},UM=Object.setPrototypeOf||("__proto__"in{}?(function(){var e,t=!1,n={};try{(e=LM(Object.prototype,"__proto__","set"))(n,[]),t=n instanceof Array}catch{}return function(i,r){return xM(i),MM(r),kM(i)&&(t?e(i,r):i.__proto__=r),i}})():void 0),ql={},Xl={},Um=Vn,VM=Hs,jM=wm.indexOf,FM=Xl,ZT=ee([].push),$T=function(e,t){var n,i=VM(e),r=0,s=[];for(n in i)!Um(FM,n)&&Um(i,n)&&ZT(s,n);for(;t.length>r;)Um(i,n=t[r++])&&(~jM(s,n)||ZT(s,n));return s},Vm=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],BM=$T,WM=Vm.concat("length","prototype");ql.f=Object.getOwnPropertyNames||function(e){return BM(e,WM)};var cd={};cd.f=Object.getOwnPropertySymbols;var GM=ti,HM=ql,KM=cd,YM=Ei,zM=ee([].concat),qM=GM("Reflect","ownKeys")||function(e){var t=HM.f(YM(e)),n=KM.f;return n?zM(t,n(e)):t},ey=Vn,XM=qM,JM=Qe,QM=er,jm={},ZM=$T,$M=Vm,Jl=Object.keys||function(e){return ZM(e,$M)},eU=at,tU=MT,nU=er,iU=Ei,rU=Hs,sU=Jl;jm.f=eU&&!tU?Object.defineProperties:function(e,t){iU(e);for(var n,i=rU(t),r=sU(t),s=r.length,o=0;s>o;)nU.f(e,n=r[o++],i[n]);return e};var Ql,ty=ti("document","documentElement"),oU=Ei,aU=jm,ny=Vm,cU=Xl,dU=ty,lU=Tm,Fm="prototype",Bm="script",iy=zl("IE_PROTO"),Wm=function(){},ry=function(e){return"<"+Bm+">"+e+"</"+Bm+">"},sy=function(e){e.write(ry("")),e.close();var t=e.parentWindow.Object;return e=null,t},Zl=function(){try{Ql=new ActiveXObject("htmlfile")}catch{}var e,t,n;Zl=typeof document<"u"?document.domain&&Ql?sy(Ql):(t=lU("iframe"),n="java"+Bm+":",t.style.display="none",dU.appendChild(t),t.src=String(n),(e=t.contentWindow.document).open(),e.write(ry("document.F=Object")),e.close(),e.F):sy(Ql);for(var i=ny.length;i--;)delete Zl[Fm][ny[i]];return Zl()};cU[iy]=!0;var dd=Object.create||function(e,t){var n;return e!==null?(Wm[Fm]=oU(e),n=new Wm,Wm[Fm]=null,n[iy]=e):n=Zl(),t===void 0?n:aU.f(n,t)},uU=Yn,hU=Oo,oy=Error,pU=ee("".replace),mU=String(new oy("zxcasd").stack),ay=/\n\s*at [^:]*:[^\n]*/,fU=ay.test(mU),_U=Ws,EU=!U((function(){var e=new Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",_U(1,7)),e.stack!==7)})),gU=Oo,SU=function(e,t){if(fU&&typeof e=="string"&&!oy.prepareStackTrace)for(;t--;)e=pU(e,ay,"");return e},TU=EU,cy=Error.captureStackTrace,La={},yU=La,vU=$t("iterator"),RU=Array.prototype,dy=function(e){return e!==void 0&&(yU.Array===e||RU[vU]===e)},CU=zs,ly=id,bU=Bl,IU=La,wU=$t("iterator"),$l=function(e){if(!bU(e))return ly(e,wU)||ly(e,"@@iterator")||IU[CU(e)]},AU=An,OU=Ii,NU=Ei,DU=Aa,PU=$l,LU=TypeError,Gm=function(e,t){var n=arguments.length<2?PU(e):t;if(OU(n))return NU(AU(n,e));throw new LU(DU(e)+" is not iterable")},kU=An,uy=Ei,xU=id,hy=function(e,t,n){var i,r;uy(e);try{if(!(i=xU(e,"return"))){if(t==="throw")throw n;return n}i=kU(i,e)}catch(s){r=!0,i=s}if(t==="throw")throw n;if(r)throw i;return uy(i),n},MU=Ks,UU=An,VU=Ei,jU=Aa,FU=dy,BU=Ys,py=q,WU=Gm,GU=$l,my=hy,HU=TypeError,eu=function(e,t){this.stopped=e,this.result=t},fy=eu.prototype,ld=function(e,t,n){var i,r,s,o,a,c,d,l=n&&n.that,u=!(!n||!n.AS_ENTRIES),h=!(!n||!n.IS_RECORD),p=!(!n||!n.IS_ITERATOR),R=!(!n||!n.INTERRUPTED),T=MU(t,l),y=function(A){return i&&my(i,"normal"),new eu(!0,A)},I=function(A){return u?(VU(A),R?T(A[0],A[1],y):T(A[0],A[1])):R?T(A,y):T(A)};if(h)i=e.iterator;else if(p)i=e;else{if(!(r=GU(e)))throw new HU(jU(e)+" is not iterable");if(FU(r)){for(s=0,o=BU(e);o>s;s++)if((a=I(e[s]))&&py(fy,a))return a;return new eu(!1)}i=WU(e,r)}for(c=h?e.next:i.next;!(d=UU(c,i)).done;){try{a=I(d.value)}catch(A){my(i,"throw",A)}if(typeof a=="object"&&a&&py(fy,a))return a}return new eu(!1)},KU=gi,YU=lt,zU=q,qU=Mm,tu=UM,XU=function(e,t,n){for(var i=XM(t),r=QM.f,s=JM.f,o=0;o<i.length;o++){var a=i[o];ey(e,a)||n&&ey(n,a)||r(e,a,s(t,a))}},_y=dd,Hm=Oo,Km=Ws,JU=function(e,t){uU(t)&&"cause"in t&&hU(e,"cause",t.cause)},QU=function(e,t,n,i){TU&&(cy?cy(e,t):gU(e,"stack",SU(n,i)))},ZU=ld,$U=function(e,t){return e===void 0?arguments.length<2?"":t:KU(e)},e2=$t("toStringTag"),nu=Error,t2=[].push,ka=function(e,t){var n,i=zU(Ym,this);tu?n=tu(new nu,i?qU(this):Ym):(n=i?this:_y(Ym),Hm(n,e2,"Error")),t!==void 0&&Hm(n,"message",$U(t)),QU(n,ka,n.stack,1),arguments.length>2&&JU(n,arguments[2]);var r=[];return ZU(e,t2,{that:r}),Hm(n,"errors",r),n};tu?tu(ka,nu):XU(ka,nu,{name:!0});var Ym=ka.prototype=_y(nu.prototype,{constructor:Km(1,ka),message:Km(1,""),name:Km(1,"AggregateError")});YU({global:!0},{AggregateError:ka});var iu,ud,ru,n2=ln,Ey=ae.WeakMap,i2=n2(Ey)&&/native code/.test(String(Ey)),gy=ae,r2=Yn,s2=Oo,zm=Vn,qm=fm,o2=zl,a2=Xl,Sy="Object already initialized",Xm=gy.TypeError,c2=gy.WeakMap;if(i2||qm.state){var Zr=qm.state||(qm.state=new c2);Zr.get=Zr.get,Zr.has=Zr.has,Zr.set=Zr.set,iu=function(e,t){if(Zr.has(e))throw new Xm(Sy);return t.facade=e,Zr.set(e,t),t},ud=function(e){return Zr.get(e)||{}},ru=function(e){return Zr.has(e)}}else{var xa=o2("state");a2[xa]=!0,iu=function(e,t){if(zm(e,xa))throw new Xm(Sy);return t.facade=e,s2(e,xa,t),t},ud=function(e){return zm(e,xa)?e[xa]:{}},ru=function(e){return zm(e,xa)}}var No,Ty,yy,Do={set:iu,get:ud,has:ru,enforce:function(e){return ru(e)?ud(e):iu(e,{})},getterFor:function(e){return function(t){var n;if(!r2(t)||(n=ud(t)).type!==e)throw new Xm("Incompatible receiver, "+e+" required");return n}}},Jm=at,d2=Vn,vy=Function.prototype,l2=Jm&&Object.getOwnPropertyDescriptor,Ry=d2(vy,"name"),Cy={PROPER:Ry&&(function(){}).name==="something",CONFIGURABLE:Ry&&(!Jm||Jm&&l2(vy,"name").configurable)},u2=Oo,qs=function(e,t,n,i){return i&&i.enumerable?e[t]=n:u2(e,t,n),e},h2=U,p2=ln,m2=Yn,f2=dd,by=Mm,_2=qs,Qm=$t("iterator"),Iy=!1;[].keys&&("next"in(yy=[].keys())?(Ty=by(by(yy)))!==Object.prototype&&(No=Ty):Iy=!0);var E2=!m2(No)||h2((function(){var e={};return No[Qm].call(e)!==e}));p2((No=E2?{}:f2(No))[Qm])||_2(No,Qm,(function(){return this}));var wy={IteratorPrototype:No,BUGGY_SAFARI_ITERATORS:Iy},g2=zs,S2=Om?{}.toString:function(){return"[object "+g2(this)+"]"},T2=Om,y2=er.f,v2=Oo,R2=Vn,C2=S2,Ay=$t("toStringTag"),bs=function(e,t,n,i){var r=n?e:e&&e.prototype;r&&(R2(r,Ay)||y2(r,Ay,{configurable:!0,value:t}),i&&!T2&&v2(r,"toString",C2))},b2=wy.IteratorPrototype,I2=dd,w2=Ws,A2=bs,O2=La,N2=function(){return this},Zm=function(e,t,n,i){var r=t+" Iterator";return e.prototype=I2(b2,{next:w2(+!i,n)}),A2(e,r,!1,!0),O2[r]=N2,e},D2=lt,P2=An,L2=Cy,k2=Zm,x2=Mm,M2=bs,Oy=qs,Ny=La,U2=wy,V2=L2.PROPER,su=U2.BUGGY_SAFARI_ITERATORS,$m=$t("iterator"),Dy="keys",ou="values",Py="entries",j2=function(){return this},Ly=function(e,t,n,i,r,s,o){k2(n,t,i);var a,c,d,l=function(I){if(I===r&&T)return T;if(!su&&I&&I in p)return p[I];switch(I){case Dy:case ou:case Py:return function(){return new n(this,I)}}return function(){return new n(this)}},u=t+" Iterator",h=!1,p=e.prototype,R=p[$m]||p["@@iterator"]||r&&p[r],T=!su&&R||l(r),y=t==="Array"&&p.entries||R;if(y&&(a=x2(y.call(new e)))!==Object.prototype&&a.next&&(M2(a,u,!0,!0),Ny[u]=j2),V2&&r===ou&&R&&R.name!==ou&&(h=!0,T=function(){return P2(R,this)}),r)if(c={values:l(ou),keys:s?T:l(Dy),entries:l(Py)},o)for(d in c)(su||h||!(d in p))&&Oy(p,d,c[d]);else D2({target:t,proto:!0,forced:su||h},c);return o&&p[$m]!==T&&Oy(p,$m,T,{}),Ny[t]=T,c},au=function(e,t){return{value:e,done:t}},F2=Hs,ky=La,xy=Do;er.f;var B2=Ly,cu=au,My="Array Iterator",W2=xy.set,G2=xy.getterFor(My);B2(Array,"Array",(function(e,t){W2(this,{type:My,target:F2(e),index:0,kind:t})}),(function(){var e=G2(this),t=e.target,n=e.index++;if(!t||n>=t.length)return e.target=null,cu(void 0,!0);switch(e.kind){case"keys":return cu(n,!1);case"values":return cu(t[n],!1)}return cu([n,t[n]],!1)}),"values"),ky.Arguments=ky.Array;var H2=er,du=function(e,t,n){return H2.f(e,t,n)},K2=ti,Y2=du,z2=at,Uy=$t("species"),q2=q,X2=TypeError,ef=function(e,t){if(q2(t,e))return e;throw new X2("Incorrect invocation")},J2=ln,tf=fm,Q2=ee(Function.toString);J2(tf.inspectSource)||(tf.inspectSource=function(e){return Q2(e)});var Vy=tf.inspectSource,Z2=ee,$2=U,jy=ln,eV=zs,tV=Vy,Fy=function(){},By=ti("Reflect","construct"),nf=/^\s*(?:class|function)\b/,nV=Z2(nf.exec),iV=!nf.test(Fy),hd=function(e){if(!jy(e))return!1;try{return By(Fy,[],e),!0}catch{return!1}},Wy=function(e){if(!jy(e))return!1;switch(eV(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return iV||!!nV(nf,tV(e))}catch{return!0}};Wy.sham=!0;var pd,Ma,Gy,rf,lu=!By||$2((function(){var e;return hd(hd.call)||!hd(Object)||!hd((function(){e=!0}))||e}))?Wy:hd,rV=lu,sV=Aa,oV=TypeError,Hy=Ei,aV=function(e){if(rV(e))return e;throw new oV(sV(e)+" is not a constructor")},cV=Bl,dV=$t("species"),sf=function(e,t){var n,i=Hy(e).constructor;return i===void 0||cV(n=Hy(i)[dV])?t:aV(n)},Xs=ee([].slice),lV=TypeError,Po=function(e,t){if(e<t)throw new lV("Not enough arguments");return e},Ky=/(?:ipad|iphone|ipod).*applewebkit/i.test(Cs),Wi=ae,uV=dt,hV=Ks,Yy=ln,pV=Vn,zy=U,qy=ty,mV=Xs,Xy=Tm,fV=Po,_V=Ky,EV=Yl,of=Wi.setImmediate,af=Wi.clearImmediate,gV=Wi.process,cf=Wi.Dispatch,SV=Wi.Function,Jy=Wi.MessageChannel,TV=Wi.String,df=0,md={},Qy="onreadystatechange";zy((function(){pd=Wi.location}));var lf=function(e){if(pV(md,e)){var t=md[e];delete md[e],t()}},uf=function(e){return function(){lf(e)}},Zy=function(e){lf(e.data)},$y=function(e){Wi.postMessage(TV(e),pd.protocol+"//"+pd.host)};of&&af||(of=function(e){fV(arguments.length,1);var t=Yy(e)?e:SV(e),n=mV(arguments,1);return md[++df]=function(){uV(t,void 0,n)},Ma(df),df},af=function(e){delete md[e]},EV?Ma=function(e){gV.nextTick(uf(e))}:cf&&cf.now?Ma=function(e){cf.now(uf(e))}:Jy&&!_V?(rf=(Gy=new Jy).port2,Gy.port1.onmessage=Zy,Ma=hV(rf.postMessage,rf)):Wi.addEventListener&&Yy(Wi.postMessage)&&!Wi.importScripts&&pd&&pd.protocol!=="file:"&&!zy($y)?(Ma=$y,Wi.addEventListener("message",Zy,!1)):Ma=Qy in Xy("script")?function(e){qy.appendChild(Xy("script"))[Qy]=function(){qy.removeChild(this),lf(e)}}:function(e){setTimeout(uf(e),0)});var uu={set:of,clear:af},ev=ae,yV=at,vV=Object.getOwnPropertyDescriptor,tv=function(e){if(!yV)return ev[e];var t=vV(ev,e);return t&&t.value},nv=function(){this.head=null,this.tail=null};nv.prototype={add:function(e){var t={item:e,next:null},n=this.tail;n?n.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return(this.head=e.next)===null&&(this.tail=null),e.item}};var Ua,hf,pf,mf,iv,rv=nv,RV=/ipad|iphone|ipod/i.test(Cs)&&typeof Pebble<"u",CV=/web0s(?!.*chrome)/i.test(Cs),Va=ae,bV=tv,sv=Ks,ff=uu.set,IV=rv,wV=Ky,AV=RV,OV=CV,_f=Yl,ov=Va.MutationObserver||Va.WebKitMutationObserver,av=Va.document,cv=Va.process,hu=Va.Promise,Ef=bV("queueMicrotask");if(!Ef){var pu=new IV,mu=function(){var e,t;for(_f&&(e=cv.domain)&&e.exit();t=pu.get();)try{t()}catch(n){throw pu.head&&Ua(),n}e&&e.enter()};wV||_f||OV||!ov||!av?!AV&&hu&&hu.resolve?((mf=hu.resolve(void 0)).constructor=hu,iv=sv(mf.then,mf),Ua=function(){iv(mu)}):_f?Ua=function(){cv.nextTick(mu)}:(ff=sv(ff,Va),Ua=function(){ff(mu)}):(hf=!0,pf=av.createTextNode(""),new ov(mu).observe(pf,{characterData:!0}),Ua=function(){pf.data=hf=!hf}),Ef=function(e){pu.head||Ua(),pu.add(e)}}var dv=Ef,ja=function(e){try{return{error:!1,value:e()}}catch(t){return{error:!0,value:t}}},Lo=ae.Promise,NV=ae,fd=Lo,DV=ln,PV=xT,LV=Vy,kV=$t,lv=Pm,gf=Ao,uv=fd&&fd.prototype,xV=kV("species"),hv=DV(NV.PromiseRejectionEvent),MV=PV("Promise",(function(){var e=LV(fd),t=e!==String(fd);if(!t&&gf===66||!uv.catch||!uv.finally)return!0;if(!gf||gf<51||!/native code/.test(e)){var n=new fd((function(r){r(1)})),i=function(r){r((function(){}),(function(){}))};if((n.constructor={})[xV]=i,!(n.then((function(){}))instanceof i))return!0}return!(t||lv!=="BROWSER"&&lv!=="DENO"||hv)})),_d={CONSTRUCTOR:MV,REJECTION_EVENT:hv},$r={},pv=Ii,UV=TypeError,VV=function(e){var t,n;this.promise=new e((function(i,r){if(t!==void 0||n!==void 0)throw new UV("Bad Promise constructor");t=i,n=r})),this.resolve=pv(t),this.reject=pv(n)};$r.f=function(e){return new VV(e)};var Sf,mv,fv,jV=lt,fu=Yl,Js=ae,FV=bi,Ed=An,BV=qs,WV=bs,GV=function(e){var t=K2(e);z2&&t&&!t[Uy]&&Y2(t,Uy,{configurable:!0,get:function(){return this}})},HV=Ii,Tf=ln,KV=Yn,YV=ef,zV=sf,_v=uu.set,yf=dv,qV=function(e,t){try{arguments.length===1?console.error(e):console.error(e,t)}catch{}},XV=ja,JV=rv,Ev=Do,vf=Lo,gv=_d,Sv=$r,_u="Promise",Tv=gv.CONSTRUCTOR,QV=gv.REJECTION_EVENT,Rf=Ev.getterFor(_u),ZV=Ev.set,$V=vf&&vf.prototype,gd=vf,Cf=$V,yv=Js.TypeError,bf=Js.document,If=Js.process,wf=Sv.f,ej=wf,tj=!!(bf&&bf.createEvent&&Js.dispatchEvent),vv="unhandledrejection",Rv=function(e){var t;return!(!KV(e)||!Tf(t=e.then))&&t},Cv=function(e,t){var n,i,r,s=t.value,o=t.state===1,a=o?e.ok:e.fail,c=e.resolve,d=e.reject,l=e.domain;try{a?(o||(t.rejection===2&&ij(t),t.rejection=1),a===!0?n=s:(l&&l.enter(),n=a(s),l&&(l.exit(),r=!0)),n===e.promise?d(new yv("Promise-chain cycle")):(i=Rv(n))?Ed(i,n,c,d):c(n)):d(s)}catch(u){l&&!r&&l.exit(),d(u)}},bv=function(e,t){e.notified||(e.notified=!0,yf((function(){for(var n,i=e.reactions;n=i.get();)Cv(n,e);e.notified=!1,t&&!e.rejection&&nj(e)})))},Iv=function(e,t,n){var i,r;tj?((i=bf.createEvent("Event")).promise=t,i.reason=n,i.initEvent(e,!1,!0),Js.dispatchEvent(i)):i={promise:t,reason:n},!QV&&(r=Js["on"+e])?r(i):e===vv&&qV("Unhandled promise rejection",n)},nj=function(e){Ed(_v,Js,(function(){var t,n=e.facade,i=e.value;if(wv(e)&&(t=XV((function(){fu?If.emit("unhandledRejection",i,n):Iv(vv,n,i)})),e.rejection=fu||wv(e)?2:1,t.error))throw t.value}))},wv=function(e){return e.rejection!==1&&!e.parent},ij=function(e){Ed(_v,Js,(function(){var t=e.facade;fu?If.emit("rejectionHandled",t):Iv("rejectionhandled",t,e.value)}))},Fa=function(e,t,n){return function(i){e(t,i,n)}},Ba=function(e,t,n){e.done||(e.done=!0,n&&(e=n),e.value=t,e.state=2,bv(e,!0))},Af=function(e,t,n){if(!e.done){e.done=!0,n&&(e=n);try{if(e.facade===t)throw new yv("Promise can't be resolved itself");var i=Rv(t);i?yf((function(){var r={done:!1};try{Ed(i,t,Fa(Af,r,e),Fa(Ba,r,e))}catch(s){Ba(r,s,e)}})):(e.value=t,e.state=1,bv(e,!1))}catch(r){Ba({done:!1},r,e)}}};Tv&&(Cf=(gd=function(e){YV(this,Cf),HV(e),Ed(Sf,this);var t=Rf(this);try{e(Fa(Af,t),Fa(Ba,t))}catch(n){Ba(t,n)}}).prototype,(Sf=function(e){ZV(this,{type:_u,done:!1,notified:!1,parent:!1,reactions:new JV,rejection:!1,state:0,value:null})}).prototype=BV(Cf,"then",(function(e,t){var n=Rf(this),i=wf(zV(this,gd));return n.parent=!0,i.ok=!Tf(e)||e,i.fail=Tf(t)&&t,i.domain=fu?If.domain:void 0,n.state===0?n.reactions.add(i):yf((function(){Cv(i,n)})),i.promise})),mv=function(){var e=new Sf,t=Rf(e);this.promise=e,this.resolve=Fa(Af,t),this.reject=Fa(Ba,t)},Sv.f=wf=function(e){return e===gd||e===fv?new mv(e):ej(e)}),jV({global:!0,wrap:!0,forced:Tv},{Promise:gd}),fv=FV.Promise,WV(gd,_u,!1,!0),GV(_u);var Av=$t("iterator"),Ov=!1;try{var rj=0,Nv={next:function(){return{done:!!rj++}},return:function(){Ov=!0}};Nv[Av]=function(){return this},Array.from(Nv,(function(){throw 2}))}catch{}var sj=Lo,oj=function(e,t){try{if(!t&&!Ov)return!1}catch{return!1}var n=!1;try{var i={};i[Av]=function(){return{next:function(){return{done:n=!0}}}},e(i)}catch{}return n},Eu=_d.CONSTRUCTOR||!oj((function(e){sj.all(e).then(void 0,(function(){}))})),aj=An,cj=Ii,dj=$r,lj=ja,uj=ld;lt({target:"Promise",stat:!0,forced:Eu},{all:function(e){var t=this,n=dj.f(t),i=n.resolve,r=n.reject,s=lj((function(){var o=cj(t.resolve),a=[],c=0,d=1;uj(e,(function(l){var u=c++,h=!1;d++,aj(o,t,l).then((function(p){h||(h=!0,a[u]=p,--d||i(a))}),r)})),--d||i(a)}));return s.error&&r(s.value),n.promise}});var hj=lt,pj=_d.CONSTRUCTOR;Lo&&Lo.prototype,hj({target:"Promise",proto:!0,forced:pj,real:!0},{catch:function(e){return this.then(void 0,e)}});var mj=An,fj=Ii,_j=$r,Ej=ja,gj=ld;lt({target:"Promise",stat:!0,forced:Eu},{race:function(e){var t=this,n=_j.f(t),i=n.reject,r=Ej((function(){var s=fj(t.resolve);gj(e,(function(o){mj(s,t,o).then(n.resolve,i)}))}));return r.error&&i(r.value),n.promise}});var Sj=$r;lt({target:"Promise",stat:!0,forced:_d.CONSTRUCTOR},{reject:function(e){var t=Sj.f(this);return(0,t.reject)(e),t.promise}});var Tj=Ei,yj=Yn,vj=$r,Dv=function(e,t){if(Tj(e),yj(t)&&t.constructor===e)return t;var n=vj.f(e);return(0,n.resolve)(t),n.promise},Rj=lt,Cj=Lo,bj=_d.CONSTRUCTOR,Ij=Dv,wj=ti("Promise"),Aj=!bj;Rj({target:"Promise",stat:!0,forced:!0},{resolve:function(e){return Ij(Aj&&this===wj?Cj:this,e)}});var Oj=An,Nj=Ii,Dj=$r,Pj=ja,Lj=ld;lt({target:"Promise",stat:!0,forced:Eu},{allSettled:function(e){var t=this,n=Dj.f(t),i=n.resolve,r=n.reject,s=Pj((function(){var o=Nj(t.resolve),a=[],c=0,d=1;Lj(e,(function(l){var u=c++,h=!1;d++,Oj(o,t,l).then((function(p){h||(h=!0,a[u]={status:"fulfilled",value:p},--d||i(a))}),(function(p){h||(h=!0,a[u]={status:"rejected",reason:p},--d||i(a))}))})),--d||i(a)}));return s.error&&r(s.value),n.promise}});var kj=An,xj=Ii,Mj=ti,Uj=$r,Vj=ja,jj=ld,Pv="No one promise resolved";lt({target:"Promise",stat:!0,forced:Eu},{any:function(e){var t=this,n=Mj("AggregateError"),i=Uj.f(t),r=i.resolve,s=i.reject,o=Vj((function(){var a=xj(t.resolve),c=[],d=0,l=1,u=!1;jj(e,(function(h){var p=d++,R=!1;l++,kj(a,t,h).then((function(T){R||u||(u=!0,r(T))}),(function(T){R||u||(R=!0,c[p]=T,--l||s(new n(c,Pv)))}))})),--l||s(new n(c,Pv))}));return o.error&&s(o.value),i.promise}});var Fj=lt,Bj=dt,Wj=Xs,Gj=$r,Hj=Ii,Lv=ja,Of=ae.Promise,kv=!1;Fj({target:"Promise",stat:!0,forced:!Of||!Of.try||Lv((function(){Of.try((function(e){kv=e===8}),8)})).error||!kv},{try:function(e){var t=arguments.length>1?Wj(arguments,1):[],n=Gj.f(this),i=Lv((function(){return Bj(Hj(e),void 0,t)}));return(i.error?n.reject:n.resolve)(i.value),n.promise}});var Kj=$r;lt({target:"Promise",stat:!0},{withResolvers:function(){var e=Kj.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var Yj=lt,Nf=Lo,zj=U,qj=ti,Xj=ln,Jj=sf,xv=Dv,Qj=Nf&&Nf.prototype;Yj({target:"Promise",proto:!0,real:!0,forced:!!Nf&&zj((function(){Qj.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=Jj(this,qj("Promise")),n=Xj(e);return this.then(n?function(i){return xv(t,e()).then((function(){return i}))}:e,n?function(i){return xv(t,e()).then((function(){throw i}))}:e)}});var Df=ee,Zj=bm,$j=gi,eF=Gs,tF=Df("".charAt),Mv=Df("".charCodeAt),nF=Df("".slice),Uv=function(e){return function(t,n){var i,r,s=$j(eF(t)),o=Zj(n),a=s.length;return o<0||o>=a?e?"":void 0:(i=Mv(s,o))<55296||i>56319||o+1===a||(r=Mv(s,o+1))<56320||r>57343?e?tF(s,o):i:e?nF(s,o,o+2):r-56320+(i-55296<<10)+65536}},Pf={codeAt:Uv(!1),charAt:Uv(!0)},iF=Pf.charAt,rF=gi,Vv=Do,sF=Ly,jv=au,Fv="String Iterator",oF=Vv.set,aF=Vv.getterFor(Fv);sF(String,"String",(function(e){oF(this,{type:Fv,string:rF(e),index:0})}),(function(){var e,t=aF(this),n=t.string,i=t.index;return i>=n.length?jv(void 0,!0):(e=iF(n,i),t.index+=e.length,jv(e,!1))}));var cF=bi.Promise,dF={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},lF=ae,uF=bs,Bv=La;for(var Lf in dF)uF(lF[Lf],Lf),Bv[Lf]=Bv.Array;var Wv=cF,ie=D(Wv),hF=Fi("Array","values"),pF=zs,mF=Vn,fF=q,_F=hF,kf=Array.prototype,EF={DOMTokenList:!0,NodeList:!0},gF=function(e){var t=e.values;return e===kf||fF(kf,e)&&t===kf.values||mF(EF,pF(e))?_F:t},Si=D(gF),Gv=Aa,SF=TypeError,Hv=Xs,TF=Math.floor,xf=function(e,t){var n=e.length;if(n<8)for(var i,r,s=1;s<n;){for(r=s,i=e[s];r&&t(e[r-1],i)>0;)e[r]=e[--r];r!==s++&&(e[r]=i)}else for(var o=TF(n/2),a=xf(Hv(e,0,o),t),c=xf(Hv(e,o),t),d=a.length,l=c.length,u=0,h=0;u<d||h<l;)e[u+h]=u<d&&h<l?t(a[u],c[h])<=0?a[u++]:c[h++]:u<d?a[u++]:c[h++];return e},Kv=xf,Yv=Cs.match(/firefox\/(\d+)/i),yF=!!Yv&&+Yv[1],vF=/MSIE|Trident/.test(Cs),zv=Cs.match(/AppleWebKit\/(\d+)\./),RF=!!zv&&+zv[1],CF=lt,qv=ee,bF=Ii,IF=Qr,Xv=Ys,wF=function(e,t){if(!delete e[t])throw new SF("Cannot delete property "+Gv(t)+" of "+Gv(e))},Jv=gi,Mf=U,AF=Kv,OF=Hl,Qv=yF,NF=vF,Zv=Ao,$v=RF,Qs=[],eR=qv(Qs.sort),DF=qv(Qs.push),PF=Mf((function(){Qs.sort(void 0)})),LF=Mf((function(){Qs.sort(null)})),kF=OF("sort"),tR=!Mf((function(){if(Zv)return Zv<70;if(!(Qv&&Qv>3)){if(NF)return!0;if($v)return $v<603;var e,t,n,i,r="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(i=0;i<47;i++)Qs.push({k:t+i,v:n})}for(Qs.sort((function(s,o){return o.v-s.v})),i=0;i<Qs.length;i++)t=Qs[i].k.charAt(0),r.charAt(r.length-1)!==t&&(r+=t);return r!=="DGBEFHACIJK"}}));CF({target:"Array",proto:!0,forced:PF||!LF||!kF||!tR},{sort:function(e){e!==void 0&&bF(e);var t=IF(this);if(tR)return e===void 0?eR(t):eR(t,e);var n,i,r=[],s=Xv(t);for(i=0;i<s;i++)i in t&&DF(r,t[i]);for(AF(r,(function(o){return function(a,c){return c===void 0?-1:a===void 0?1:o!==void 0?+o(a,c)||0:Jv(a)>Jv(c)?1:-1}})(e)),n=Xv(r),i=0;i<n;)t[i]=r[i++];for(;i<s;)wF(t,i++);return t}});var xF=Fi("Array","sort"),MF=q,UF=xF,Uf=Array.prototype,VF=function(e){var t=e.sort;return e===Uf||MF(Uf,e)&&t===Uf.sort?UF:t},ko=D(VF),jF=lt,FF=ee,BF=Im,WF=RangeError,nR=String.fromCharCode,iR=String.fromCodePoint,GF=FF([].join);jF({target:"String",stat:!0,forced:!!iR&&iR.length!==1},{fromCodePoint:function(e){for(var t,n=[],i=arguments.length,r=0;i>r;){if(t=+arguments[r++],BF(t,1114111)!==t)throw new WF(t+" is not a valid code point");n[r]=t<65536?nR(t):nR(55296+((t-=65536)>>10),t%1024+56320)}return GF(n,"")}});var HF=U,KF=$t("iterator"),gu=!HF((function(){var e=new URL("b?a=1&b=2&c=3","https://a"),t=e.searchParams,n=new URLSearchParams("a=1&a=2&b=3"),i="";return e.pathname="c%20d",t.forEach((function(r,s){t.delete("b"),i+=s+r})),n.delete("a",2),n.delete("b",void 0),!e.toJSON||!n.has("a",1)||n.has("a",2)||!n.has("a",void 0)||n.has("b")||!t.size&&!0||!t.sort||e.href!=="https://a/c%20d?a=1&c=3"||t.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!t[KF]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://").host!=="xn--e1aybc"||new URL("https://a#").hash!=="#%D0%B1"||i!=="a1c3"||new URL("https://x",void 0).host!=="x"})),YF=qs,Vf=lt,rR=ae,jf=tv,zF=ti,Su=An,Cr=ee,Sd=at,sR=gu,oR=qs,qF=du,XF=function(e,t,n){for(var i in t)n&&n.unsafe&&e[i]?e[i]=t[i]:YF(e,i,t[i],n);return e},JF=bs,QF=Zm,Ff=Do,aR=ef,Bf=ln,ZF=Vn,$F=Ks,eB=zs,tB=Ei,cR=Yn,Ti=gi,nB=dd,dR=Ws,lR=Gm,iB=$l,Tu=au,Wa=Po,rB=Kv,sB=$t("iterator"),Ga="URLSearchParams",uR=Ga+"Iterator",hR=Ff.set,tr=Ff.getterFor(Ga),oB=Ff.getterFor(uR),pR=jf("fetch"),yu=jf("Request"),Td=jf("Headers"),Wf=yu&&yu.prototype,mR=Td&&Td.prototype,aB=rR.TypeError,cB=rR.encodeURIComponent,dB=String.fromCharCode,lB=zF("String","fromCodePoint"),uB=parseInt,vu=Cr("".charAt),fR=Cr([].join),Zs=Cr([].push),_R=Cr("".replace),hB=Cr([].shift),ER=Cr([].splice),gR=Cr("".split),SR=Cr("".slice),pB=Cr(/./.exec),mB=/\+/g,fB=/^[0-9a-f]+$/i,TR=function(e,t){var n=SR(e,t,t+2);return pB(fB,n)?uB(n,16):NaN},_B=function(e){for(var t=0,n=128;n>0&&(e&n)!=0;n>>=1)t++;return t},EB=function(e){var t=null;switch(e.length){case 1:t=e[0];break;case 2:t=(31&e[0])<<6|63&e[1];break;case 3:t=(15&e[0])<<12|(63&e[1])<<6|63&e[2];break;case 4:t=(7&e[0])<<18|(63&e[1])<<12|(63&e[2])<<6|63&e[3]}return t>1114111?null:t},yR=function(e){for(var t=(e=_R(e,mB," ")).length,n="",i=0;i<t;){var r=vu(e,i);if(r==="%"){if(vu(e,i+1)==="%"||i+3>t){n+="%",i++;continue}var s=TR(e,i+1);if(s!=s){n+=r,i++;continue}i+=2;var o=_B(s);if(o===0)r=dB(s);else{if(o===1||o>4){n+="",i++;continue}for(var a=[s],c=1;c<o&&!(++i+3>t||vu(e,i)!=="%");){var d=TR(e,i+1);if(d!=d){i+=3;break}if(d>191||d<128)break;Zs(a,d),i+=2,c++}if(a.length!==o){n+="";continue}var l=EB(a);l===null?n+="":r=lB(l)}}n+=r,i++}return n},gB=/[!'()~]|%20/g,SB={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},TB=function(e){return SB[e]},vR=function(e){return _R(cB(e),gB,TB)},Gf=QF((function(e,t){hR(this,{type:uR,target:tr(e).entries,index:0,kind:t})}),Ga,(function(){var e=oB(this),t=e.target,n=e.index++;if(!t||n>=t.length)return e.target=null,Tu(void 0,!0);var i=t[n];switch(e.kind){case"keys":return Tu(i.key,!1);case"values":return Tu(i.value,!1)}return Tu([i.key,i.value],!1)}),!0),RR=function(e){this.entries=[],this.url=null,e!==void 0&&(cR(e)?this.parseObject(e):this.parseQuery(typeof e=="string"?vu(e,0)==="?"?SR(e,1):e:Ti(e)))};RR.prototype={type:Ga,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,n,i,r,s,o,a,c=this.entries,d=iB(e);if(d)for(n=(t=lR(e,d)).next;!(i=Su(n,t)).done;){if(s=(r=lR(tB(i.value))).next,(o=Su(s,r)).done||(a=Su(s,r)).done||!Su(s,r).done)throw new aB("Expected sequence with length 2");Zs(c,{key:Ti(o.value),value:Ti(a.value)})}else for(var l in e)ZF(e,l)&&Zs(c,{key:l,value:Ti(e[l])})},parseQuery:function(e){if(e)for(var t,n,i=this.entries,r=gR(e,"&"),s=0;s<r.length;)(t=r[s++]).length&&(n=gR(t,"="),Zs(i,{key:yR(hB(n)),value:yR(fR(n,"="))}))},serialize:function(){for(var e,t=this.entries,n=[],i=0;i<t.length;)e=t[i++],Zs(n,vR(e.key)+"="+vR(e.value));return fR(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Ru=function(){aR(this,Ha);var e=hR(this,new RR(arguments.length>0?arguments[0]:void 0));Sd||(this.size=e.entries.length)},Ha=Ru.prototype;if(XF(Ha,{append:function(e,t){var n=tr(this);Wa(arguments.length,2),Zs(n.entries,{key:Ti(e),value:Ti(t)}),Sd||this.length++,n.updateURL()},delete:function(e){for(var t=tr(this),n=Wa(arguments.length,1),i=t.entries,r=Ti(e),s=n<2?void 0:arguments[1],o=s===void 0?s:Ti(s),a=0;a<i.length;){var c=i[a];if(c.key!==r||o!==void 0&&c.value!==o)a++;else if(ER(i,a,1),o!==void 0)break}Sd||(this.size=i.length),t.updateURL()},get:function(e){var t=tr(this).entries;Wa(arguments.length,1);for(var n=Ti(e),i=0;i<t.length;i++)if(t[i].key===n)return t[i].value;return null},getAll:function(e){var t=tr(this).entries;Wa(arguments.length,1);for(var n=Ti(e),i=[],r=0;r<t.length;r++)t[r].key===n&&Zs(i,t[r].value);return i},has:function(e){for(var t=tr(this).entries,n=Wa(arguments.length,1),i=Ti(e),r=n<2?void 0:arguments[1],s=r===void 0?r:Ti(r),o=0;o<t.length;){var a=t[o++];if(a.key===i&&(s===void 0||a.value===s))return!0}return!1},set:function(e,t){var n=tr(this);Wa(arguments.length,1);for(var i,r=n.entries,s=!1,o=Ti(e),a=Ti(t),c=0;c<r.length;c++)(i=r[c]).key===o&&(s?ER(r,c--,1):(s=!0,i.value=a));s||Zs(r,{key:o,value:a}),Sd||(this.size=r.length),n.updateURL()},sort:function(){var e=tr(this);rB(e.entries,(function(t,n){return t.key>n.key?1:-1})),e.updateURL()},forEach:function(e){for(var t,n=tr(this).entries,i=$F(e,arguments.length>1?arguments[1]:void 0),r=0;r<n.length;)i((t=n[r++]).value,t.key,this)},keys:function(){return new Gf(this,"keys")},values:function(){return new Gf(this,"values")},entries:function(){return new Gf(this,"entries")}},{enumerable:!0}),oR(Ha,sB,Ha.entries,{}),oR(Ha,"toString",(function(){return tr(this).serialize()}),{enumerable:!0}),Sd&&qF(Ha,"size",{get:function(){return tr(this).entries.length},configurable:!0,enumerable:!0}),JF(Ru,Ga),Vf({global:!0,forced:!sR},{URLSearchParams:Ru}),!sR&&Bf(Td)){var yB=Cr(mR.has),vB=Cr(mR.set),CR=function(e){if(cR(e)){var t,n=e.body;if(eB(n)===Ga)return t=e.headers?new Td(e.headers):new Td,yB(t,"content-type")||vB(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),nB(e,{body:dR(0,Ti(n)),headers:dR(0,t)})}return e};if(Bf(pR)&&Vf({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return pR(e,arguments.length>1?CR(arguments[1]):{})}}),Bf(yu)){var Hf=function(e){return aR(this,Wf),new yu(e,arguments.length>1?CR(arguments[1]):{})};Wf.constructor=Hf,Hf.prototype=Wf,Vf({global:!0,dontCallGetSet:!0,forced:!0},{Request:Hf})}}var nr,RB={URLSearchParams:Ru,getState:tr},CB=bi.URLSearchParams,bR=at,bB=ee,IB=An,wB=U,Kf=Jl,AB=cd,OB=Vl,NB=Qr,DB=Fl,Ka=Object.assign,IR=Object.defineProperty,PB=bB([].concat),LB=!Ka||wB((function(){if(bR&&Ka({b:1},Ka(IR({},"a",{enumerable:!0,get:function(){IR(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var e={},t={},n=Symbol("assign detection"),i="abcdefghijklmnopqrst";return e[n]=7,i.split("").forEach((function(r){t[r]=r})),Ka({},e)[n]!==7||Kf(Ka({},t)).join("")!==i}))?function(e,t){for(var n=NB(e),i=arguments.length,r=1,s=AB.f,o=OB.f;i>r;)for(var a,c=DB(arguments[r++]),d=s?PB(Kf(c),s(c)):Kf(c),l=d.length,u=0;l>u;)a=d[u++],bR&&!IB(o,c,a)||(n[a]=c[a]);return n}:Ka,kB=Ei,xB=hy,MB=at,UB=er,VB=Ws,Yf=function(e,t,n){MB?UB.f(e,t,VB(0,n)):e[t]=n},jB=Ks,FB=An,BB=Qr,WB=function(e,t,n,i){try{return i?t(kB(n)[0],n[1]):t(n)}catch(r){xB(e,"throw",r)}},GB=dy,HB=lu,KB=Ys,wR=Yf,YB=Gm,zB=$l,AR=Array,xo=ee,zf=2147483647,qB=/[^\0-\u007E]/,OR=/[.\u3002\uFF0E\uFF61]/g,NR="Overflow: input needs wider integers to process",DR=RangeError,XB=xo(OR.exec),Ya=Math.floor,qf=String.fromCharCode,PR=xo("".charCodeAt),LR=xo([].join),$s=xo([].push),JB=xo("".replace),QB=xo("".split),ZB=xo("".toLowerCase),kR=function(e){return e+22+75*(e<26)},$B=function(e,t,n){var i=0;for(e=n?Ya(e/700):e>>1,e+=Ya(e/t);e>455;)e=Ya(e/35),i+=36;return Ya(i+36*e/(e+38))},e3=function(e){var t=[];e=(function(I){for(var A=[],N=0,k=I.length;N<k;){var x=PR(I,N++);if(x>=55296&&x<=56319&&N<k){var P=PR(I,N++);(64512&P)==56320?$s(A,((1023&x)<<10)+(1023&P)+65536):($s(A,x),N--)}else $s(A,x)}return A})(e);var n,i,r=e.length,s=128,o=0,a=72;for(n=0;n<e.length;n++)(i=e[n])<128&&$s(t,qf(i));var c=t.length,d=c;for(c&&$s(t,"-");d<r;){var l=zf;for(n=0;n<e.length;n++)(i=e[n])>=s&&i<l&&(l=i);var u=d+1;if(l-s>Ya((zf-o)/u))throw new DR(NR);for(o+=(l-s)*u,s=l,n=0;n<e.length;n++){if((i=e[n])<s&&++o>zf)throw new DR(NR);if(i===s){for(var h=o,p=36;;){var R=p<=a?1:p>=a+26?26:p-a;if(h<R)break;var T=h-R,y=36-R;$s(t,qf(kR(R+T%y))),h=Ya(T/y),p+=36}$s(t,qf(kR(h))),a=$B(o,u,d===c),o=0,d++}}o++,s++}return LR(t,"")},t3=lt,Xf=at,n3=gu,Jf=ae,xR=Ks,ir=ee,Cu=qs,rr=du,i3=ef,Qf=Vn,Zf=LB,za=function(e){var t=BB(e),n=HB(this),i=arguments.length,r=i>1?arguments[1]:void 0,s=r!==void 0;s&&(r=jB(r,i>2?arguments[2]:void 0));var o,a,c,d,l,u,h=zB(t),p=0;if(!h||this===AR&&GB(h))for(o=KB(t),a=n?new this(o):AR(o);o>p;p++)u=s?r(t[p],p):t[p],wR(a,p,u);else for(a=n?new this:[],l=(d=YB(t,h)).next;!(c=FB(l,d)).done;p++)u=s?WB(d,r,[c.value,p],!0):c.value,wR(a,p,u);return a.length=p,a},br=Xs,r3=Pf.codeAt,s3=function(e){var t,n,i=[],r=QB(JB(ZB(e),OR,"."),".");for(t=0;t<r.length;t++)n=r[t],$s(i,XB(qB,n)?"xn--"+e3(n):n);return LR(i,".")},Is=gi,o3=bs,a3=Po,MR=RB,UR=Do,c3=UR.set,bu=UR.getterFor("URL"),d3=MR.URLSearchParams,l3=MR.getState,yd=Jf.URL,$f=Jf.TypeError,Iu=Jf.parseInt,u3=Math.floor,VR=Math.pow,sr=ir("".charAt),Ir=ir(/./.exec),vd=ir([].join),h3=ir(1.1.toString),p3=ir([].pop),qa=ir([].push),e_=ir("".replace),m3=ir([].shift),f3=ir("".split),Rd=ir("".slice),wu=ir("".toLowerCase),_3=ir([].unshift),t_="Invalid scheme",Mo="Invalid host",jR="Invalid port",FR=/[a-z]/i,E3=/[\d+-.a-z]/i,n_=/\d/,g3=/^0x/i,S3=/^[0-7]+$/,T3=/^\d+$/,BR=/^[\da-f]+$/i,y3=/[\0\t\n\r #%/:<>?@[\\\]^|]/,v3=/[\0\t\n\r #/:<>?@[\\\]^|]/,R3=/^[\u0000-\u0020]+/,C3=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,b3=/[\t\n\r]/g,Cd=function(e){var t,n,i,r;if(typeof e=="number"){for(t=[],n=0;n<4;n++)_3(t,e%256),e=u3(e/256);return vd(t,".")}if(typeof e=="object"){for(t="",i=(function(s){for(var o=null,a=1,c=null,d=0,l=0;l<8;l++)s[l]!==0?(d>a&&(o=c,a=d),c=null,d=0):(c===null&&(c=l),++d);return d>a?c:o})(e),n=0;n<8;n++)r&&e[n]===0||(r&&(r=!1),i===n?(t+=n?":":"::",r=!0):(t+=h3(e[n],16),n<7&&(t+=":")));return"["+t+"]"}return e},Au={},WR=Zf({},Au,{" ":1,'"':1,"<":1,">":1,"`":1}),GR=Zf({},WR,{"#":1,"?":1,"{":1,"}":1}),i_=Zf({},GR,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),eo=function(e,t){var n=r3(e,0);return n>32&&n<127&&!Qf(t,e)?e:encodeURIComponent(e)},Ou={ftp:21,file:null,http:80,https:443,ws:80,wss:443},bd=function(e,t){var n;return e.length===2&&Ir(FR,sr(e,0))&&((n=sr(e,1))===":"||!t&&n==="|")},HR=function(e){var t;return e.length>1&&bd(Rd(e,0,2))&&(e.length===2||(t=sr(e,2))==="/"||t==="\\"||t==="?"||t==="#")},I3=function(e){return e==="."||wu(e)==="%2e"},r_={},KR={},s_={},YR={},zR={},o_={},qR={},XR={},Nu={},Du={},a_={},c_={},d_={},l_={},JR={},u_={},Xa={},es={},QR={},Uo={},ws={},h_=function(e,t,n){var i,r,s,o=Is(e);if(t){if(r=this.parse(o))throw new $f(r);this.searchParams=null}else{if(n!==void 0&&(i=new h_(n,!0)),r=this.parse(o,null,i))throw new $f(r);(s=l3(new d3)).bindURL(this),this.searchParams=s}};h_.prototype={type:"URL",parse:function(e,t,n){var i,r,s,o,a,c=this,d=t||r_,l=0,u="",h=!1,p=!1,R=!1;for(e=Is(e),t||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,e=e_(e,R3,""),e=e_(e,C3,"$1")),e=e_(e,b3,""),i=za(e);l<=i.length;){switch(r=i[l],d){case r_:if(!r||!Ir(FR,r)){if(t)return t_;d=s_;continue}u+=wu(r),d=KR;break;case KR:if(r&&(Ir(E3,r)||r==="+"||r==="-"||r==="."))u+=wu(r);else{if(r!==":"){if(t)return t_;u="",d=s_,l=0;continue}if(t&&(c.isSpecial()!==Qf(Ou,u)||u==="file"&&(c.includesCredentials()||c.port!==null)||c.scheme==="file"&&!c.host))return;if(c.scheme=u,t)return void(c.isSpecial()&&Ou[c.scheme]===c.port&&(c.port=null));u="",c.scheme==="file"?d=l_:c.isSpecial()&&n&&n.scheme===c.scheme?d=YR:c.isSpecial()?d=XR:i[l+1]==="/"?(d=zR,l++):(c.cannotBeABaseURL=!0,qa(c.path,""),d=QR)}break;case s_:if(!n||n.cannotBeABaseURL&&r!=="#")return t_;if(n.cannotBeABaseURL&&r==="#"){c.scheme=n.scheme,c.path=br(n.path),c.query=n.query,c.fragment="",c.cannotBeABaseURL=!0,d=ws;break}d=n.scheme==="file"?l_:o_;continue;case YR:if(r!=="/"||i[l+1]!=="/"){d=o_;continue}d=Nu,l++;break;case zR:if(r==="/"){d=Du;break}d=es;continue;case o_:if(c.scheme=n.scheme,r===nr)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=br(n.path),c.query=n.query;else if(r==="/"||r==="\\"&&c.isSpecial())d=qR;else if(r==="?")c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=br(n.path),c.query="",d=Uo;else{if(r!=="#"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=br(n.path),c.path.length--,d=es;continue}c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=br(n.path),c.query=n.query,c.fragment="",d=ws}break;case qR:if(!c.isSpecial()||r!=="/"&&r!=="\\"){if(r!=="/"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,d=es;continue}d=Du}else d=Nu;break;case XR:if(d=Nu,r!=="/"||sr(u,l+1)!=="/")continue;l++;break;case Nu:if(r!=="/"&&r!=="\\"){d=Du;continue}break;case Du:if(r==="@"){h&&(u="%40"+u),h=!0,s=za(u);for(var T=0;T<s.length;T++){var y=s[T];if(y!==":"||R){var I=eo(y,i_);R?c.password+=I:c.username+=I}else R=!0}u=""}else if(r===nr||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(h&&u==="")return"Invalid authority";l-=za(u).length+1,u="",d=a_}else u+=r;break;case a_:case c_:if(t&&c.scheme==="file"){d=u_;continue}if(r!==":"||p){if(r===nr||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(c.isSpecial()&&u==="")return Mo;if(t&&u===""&&(c.includesCredentials()||c.port!==null))return;if(o=c.parseHost(u))return o;if(u="",d=Xa,t)return;continue}r==="["?p=!0:r==="]"&&(p=!1),u+=r}else{if(u==="")return Mo;if(o=c.parseHost(u))return o;if(u="",d=d_,t===c_)return}break;case d_:if(!Ir(n_,r)){if(r===nr||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()||t){if(u!==""){var A=Iu(u,10);if(A>65535)return jR;c.port=c.isSpecial()&&A===Ou[c.scheme]?null:A,u=""}if(t)return;d=Xa;continue}return jR}u+=r;break;case l_:if(c.scheme="file",r==="/"||r==="\\")d=JR;else{if(!n||n.scheme!=="file"){d=es;continue}switch(r){case nr:c.host=n.host,c.path=br(n.path),c.query=n.query;break;case"?":c.host=n.host,c.path=br(n.path),c.query="",d=Uo;break;case"#":c.host=n.host,c.path=br(n.path),c.query=n.query,c.fragment="",d=ws;break;default:HR(vd(br(i,l),""))||(c.host=n.host,c.path=br(n.path),c.shortenPath()),d=es;continue}}break;case JR:if(r==="/"||r==="\\"){d=u_;break}n&&n.scheme==="file"&&!HR(vd(br(i,l),""))&&(bd(n.path[0],!0)?qa(c.path,n.path[0]):c.host=n.host),d=es;continue;case u_:if(r===nr||r==="/"||r==="\\"||r==="?"||r==="#"){if(!t&&bd(u))d=es;else if(u===""){if(c.host="",t)return;d=Xa}else{if(o=c.parseHost(u))return o;if(c.host==="localhost"&&(c.host=""),t)return;u="",d=Xa}continue}u+=r;break;case Xa:if(c.isSpecial()){if(d=es,r!=="/"&&r!=="\\")continue}else if(t||r!=="?")if(t||r!=="#"){if(r!==nr&&(d=es,r!=="/"))continue}else c.fragment="",d=ws;else c.query="",d=Uo;break;case es:if(r===nr||r==="/"||r==="\\"&&c.isSpecial()||!t&&(r==="?"||r==="#")){if((a=wu(a=u))===".."||a==="%2e."||a===".%2e"||a==="%2e%2e"?(c.shortenPath(),r==="/"||r==="\\"&&c.isSpecial()||qa(c.path,"")):I3(u)?r==="/"||r==="\\"&&c.isSpecial()||qa(c.path,""):(c.scheme==="file"&&!c.path.length&&bd(u)&&(c.host&&(c.host=""),u=sr(u,0)+":"),qa(c.path,u)),u="",c.scheme==="file"&&(r===nr||r==="?"||r==="#"))for(;c.path.length>1&&c.path[0]==="";)m3(c.path);r==="?"?(c.query="",d=Uo):r==="#"&&(c.fragment="",d=ws)}else u+=eo(r,GR);break;case QR:r==="?"?(c.query="",d=Uo):r==="#"?(c.fragment="",d=ws):r!==nr&&(c.path[0]+=eo(r,Au));break;case Uo:t||r!=="#"?r!==nr&&(r==="'"&&c.isSpecial()?c.query+="%27":c.query+=r==="#"?"%23":eo(r,Au)):(c.fragment="",d=ws);break;case ws:r!==nr&&(c.fragment+=eo(r,WR))}l++}},parseHost:function(e){var t,n,i;if(sr(e,0)==="["){if(sr(e,e.length-1)!=="]"||(t=(function(r){var s,o,a,c,d,l,u,h=[0,0,0,0,0,0,0,0],p=0,R=null,T=0,y=function(){return sr(r,T)};if(y()===":"){if(sr(r,1)!==":")return;T+=2,R=++p}for(;y();){if(p===8)return;if(y()!==":"){for(s=o=0;o<4&&Ir(BR,y());)s=16*s+Iu(y(),16),T++,o++;if(y()==="."){if(o===0||(T-=o,p>6))return;for(a=0;y();){if(c=null,a>0){if(!(y()==="."&&a<4))return;T++}if(!Ir(n_,y()))return;for(;Ir(n_,y());){if(d=Iu(y(),10),c===null)c=d;else{if(c===0)return;c=10*c+d}if(c>255)return;T++}h[p]=256*h[p]+c,++a!=2&&a!==4||p++}if(a!==4)return;break}if(y()===":"){if(T++,!y())return}else if(y())return;h[p++]=s}else{if(R!==null)return;T++,R=++p}}if(R!==null)for(l=p-R,p=7;p!==0&&l>0;)u=h[p],h[p--]=h[R+l-1],h[R+--l]=u;else if(p!==8)return;return h})(Rd(e,1,-1)),!t))return Mo;this.host=t}else if(this.isSpecial()){if(e=s3(e),Ir(y3,e)||(t=(function(r){var s,o,a,c,d,l,u,h=f3(r,".");if(h.length&&h[h.length-1]===""&&h.length--,(s=h.length)>4)return r;for(o=[],a=0;a<s;a++){if((c=h[a])==="")return r;if(d=10,c.length>1&&sr(c,0)==="0"&&(d=Ir(g3,c)?16:8,c=Rd(c,d===8?1:2)),c==="")l=0;else{if(!Ir(d===10?T3:d===8?S3:BR,c))return r;l=Iu(c,d)}qa(o,l)}for(a=0;a<s;a++)if(l=o[a],a===s-1){if(l>=VR(256,5-s))return null}else if(l>255)return null;for(u=p3(o),a=0;a<o.length;a++)u+=o[a]*VR(256,3-a);return u})(e),t===null))return Mo;this.host=t}else{if(Ir(v3,e))return Mo;for(t="",n=za(e),i=0;i<n.length;i++)t+=eo(n[i],Au);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return Qf(Ou,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||this.scheme==="file"&&t===1&&bd(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,n=e.username,i=e.password,r=e.host,s=e.port,o=e.path,a=e.query,c=e.fragment,d=t+":";return r!==null?(d+="//",e.includesCredentials()&&(d+=n+(i?":"+i:"")+"@"),d+=Cd(r),s!==null&&(d+=":"+s)):t==="file"&&(d+="//"),d+=e.cannotBeABaseURL?o[0]:o.length?"/"+vd(o,"/"):"",a!==null&&(d+="?"+a),c!==null&&(d+="#"+c),d},setHref:function(e){var t=this.parse(e);if(t)throw new $f(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if(e==="blob")try{return new Ja(e.path[0]).origin}catch{return"null"}return e!=="file"&&this.isSpecial()?e+"://"+Cd(this.host)+(t!==null?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(Is(e)+":",r_)},getUsername:function(){return this.username},setUsername:function(e){var t=za(Is(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<t.length;n++)this.username+=eo(t[n],i_)}},getPassword:function(){return this.password},setPassword:function(e){var t=za(Is(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<t.length;n++)this.password+=eo(t[n],i_)}},getHost:function(){var e=this.host,t=this.port;return e===null?"":t===null?Cd(e):Cd(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,a_)},getHostname:function(){var e=this.host;return e===null?"":Cd(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,c_)},getPort:function(){var e=this.port;return e===null?"":Is(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||((e=Is(e))===""?this.port=null:this.parse(e,d_))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+vd(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,Xa))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){(e=Is(e))===""?this.query=null:(sr(e,0)==="?"&&(e=Rd(e,1)),this.query="",this.parse(e,Uo)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){(e=Is(e))!==""?(sr(e,0)==="#"&&(e=Rd(e,1)),this.fragment="",this.parse(e,ws)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Ja=function(e){var t=i3(this,yi),n=a3(arguments.length,1)>1?arguments[1]:void 0,i=c3(t,new h_(e,!1,n));Xf||(t.href=i.serialize(),t.origin=i.getOrigin(),t.protocol=i.getProtocol(),t.username=i.getUsername(),t.password=i.getPassword(),t.host=i.getHost(),t.hostname=i.getHostname(),t.port=i.getPort(),t.pathname=i.getPathname(),t.search=i.getSearch(),t.searchParams=i.getSearchParams(),t.hash=i.getHash())},yi=Ja.prototype,or=function(e,t){return{get:function(){return bu(this)[e]()},set:t&&function(n){return bu(this)[t](n)},configurable:!0,enumerable:!0}};if(Xf&&(rr(yi,"href",or("serialize","setHref")),rr(yi,"origin",or("getOrigin")),rr(yi,"protocol",or("getProtocol","setProtocol")),rr(yi,"username",or("getUsername","setUsername")),rr(yi,"password",or("getPassword","setPassword")),rr(yi,"host",or("getHost","setHost")),rr(yi,"hostname",or("getHostname","setHostname")),rr(yi,"port",or("getPort","setPort")),rr(yi,"pathname",or("getPathname","setPathname")),rr(yi,"search",or("getSearch","setSearch")),rr(yi,"searchParams",or("getSearchParams")),rr(yi,"hash",or("getHash","setHash"))),Cu(yi,"toJSON",(function(){return bu(this).serialize()}),{enumerable:!0}),Cu(yi,"toString",(function(){return bu(this).serialize()}),{enumerable:!0}),yd){var ZR=yd.createObjectURL,$R=yd.revokeObjectURL;ZR&&Cu(Ja,"createObjectURL",xR(ZR,yd)),$R&&Cu(Ja,"revokeObjectURL",xR($R,yd))}o3(Ja,"URL"),t3({global:!0,forced:!n3,sham:!Xf},{URL:Ja});var w3=lt,eC=U,A3=Po,tC=gi,O3=gu,p_=ti("URL"),N3=O3&&eC((function(){p_.canParse()})),D3=eC((function(){return p_.canParse.length!==1}));w3({target:"URL",stat:!0,forced:!N3||D3},{canParse:function(e){var t=A3(arguments.length,1),n=tC(e),i=t<2||arguments[1]===void 0?void 0:tC(arguments[1]);try{return!!new p_(n,i)}catch{return!1}}});var P3=lt,L3=Po,nC=gi,k3=gu,x3=ti("URL");P3({target:"URL",stat:!0,forced:!k3},{parse:function(e){var t=L3(arguments.length,1),n=nC(e),i=t<2||arguments[1]===void 0?void 0:nC(arguments[1]);try{return new x3(n,i)}catch{return null}}});var Pu=D(bi.URL);let iC=!0,rC=!0;function Lu(e,t,n){const i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)}function Vo(e,t,n){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(o,a){if(o!==t)return r.apply(this,arguments);const c=d=>{const l=n(d);l&&(a.handleEvent?a.handleEvent(l):a(l))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(a,c),r.apply(this,[o,c])};const s=i.removeEventListener;i.removeEventListener=function(o,a){if(o!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(a))return s.apply(this,arguments);const c=this._eventMap[t].get(a);return this._eventMap[t].delete(a),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(o){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),o&&this.addEventListener(t,this["_on"+t]=o)},enumerable:!0,configurable:!0})}function M3(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(iC=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function U3(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(rC=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function sC(){if(typeof window=="object"){if(iC)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function m_(e,t){rC&&console.warn(e+" is deprecated, please use "+t+" instead.")}function oC(e){return Object.prototype.toString.call(e)==="[object Object]"}function aC(e){var t;return oC(e)?Bi(t=Object.keys(e)).call(t,(function(n,i){const r=oC(e[i]),s=r?aC(e[i]):e[i],o=r&&!Object.keys(s).length;return s===void 0||o?n:Object.assign(n,{[i]:s})}),{}):e}function f_(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach((i=>{i.endsWith("Id")?f_(e,e.get(t[i]),n):i.endsWith("Ids")&&t[i].forEach((r=>{f_(e,e.get(r),n)}))})))}function cC(e,t,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(t===null)return r;const s=[];return e.forEach((o=>{o.type==="track"&&o.trackIdentifier===t.id&&s.push(o)})),s.forEach((o=>{e.forEach((a=>{a.type===i&&a.trackId===o.id&&f_(e,a,r)}))})),r}const dC=sC;function lC(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const i=function(o){if(typeof o!="object"||o.mandatory||o.optional)return o;const a={};return Object.keys(o).forEach((c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;const d=typeof o[c]=="object"?o[c]:{ideal:o[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);const l=function(u,h){return u?u+h.charAt(0).toUpperCase()+h.slice(1):h==="deviceId"?"sourceId":h};if(d.ideal!==void 0){a.optional=a.optional||[];let u={};typeof d.ideal=="number"?(u[l("min",c)]=d.ideal,a.optional.push(u),u={},u[l("max",c)]=d.ideal,a.optional.push(u)):(u[l("",c)]=d.ideal,a.optional.push(u))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[l("",c)]=d.exact):["min","max"].forEach((u=>{d[u]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[l(u,c)]=d[u])}))})),o.advanced&&(a.optional=(a.optional||[]).concat(o.advanced)),a},r=function(o,a){if(t.version>=61)return a(o);if((o=JSON.parse(JSON.stringify(o)))&&typeof o.audio=="object"){const c=function(d,l,u){l in d&&!(u in d)&&(d[u]=d[l],delete d[l])};c((o=JSON.parse(JSON.stringify(o))).audio,"autoGainControl","googAutoGainControl"),c(o.audio,"noiseSuppression","googNoiseSuppression"),o.audio=i(o.audio)}if(o&&typeof o.video=="object"){let c=o.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});const d=t.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||d)){let l;if(delete o.video.facingMode,c.exact==="environment"||c.ideal==="environment"?l=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(l=["front"]),l)return n.mediaDevices.enumerateDevices().then((u=>{u=u.filter((p=>p.kind==="videoinput"));let h=u.find((p=>l.some((R=>{var T;return X(T=p.label.toLowerCase()).call(T,R)}))));return!h&&u.length&&X(l).call(l,"back")&&(h=u[u.length-1]),h&&(o.video.deviceId=c.exact?{exact:h.deviceId}:{ideal:h.deviceId}),o.video=i(o.video),dC("chrome: "+JSON.stringify(o)),a(o)}))}o.video=i(o.video)}return dC("chrome: "+JSON.stringify(o)),a(o)},s=function(o){return t.version>=64?o:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[o.name]||o.name,message:o.message,constraint:o.constraint||o.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=(function(o,a,c){r(o,(d=>{n.webkitGetUserMedia(d,a,(l=>{c&&c(s(l))}))}))}).bind(n),n.mediaDevices.getUserMedia){const o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(a){return r(a,(c=>o(c).then((d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach((l=>{l.stop()})),new DOMException("","NotFoundError");return d}),(d=>ie.reject(s(d))))))}}}function uC(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function hC(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",(i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((o=>o.track&&o.track.id===i.track.id)):{track:i.track};const s=new Event("track");s.track=i.track,s.receiver=r,s.transceiver={receiver:r},s.streams=[n.stream],this.dispatchEvent(s)})),n.stream.getTracks().forEach((i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((o=>o.track&&o.track.id===i.id)):{track:i};const s=new Event("track");s.track=i,s.receiver=r,s.transceiver={receiver:r},s.streams=[n.stream],this.dispatchEvent(s)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Vo(e,"track",(t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t)))}function pC(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(o,a){let c=r.apply(this,arguments);return c||(c=t(this,o),this._senders.push(c)),c};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(o){s.apply(this,arguments);const a=this._senders.indexOf(o);a!==-1&&this._senders.splice(a,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach((s=>{this._senders.push(t(this,s))}))};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach((s=>{const o=this._senders.find((a=>a.track===s));o&&this._senders.splice(this._senders.indexOf(o),1)}))}}else if(typeof e=="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const n=t.apply(this,[]);return n.forEach((i=>i._pc=this)),n},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function mC(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[n,i,r]=arguments;if(arguments.length>0&&typeof n=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof n!="function"))return t.apply(this,[]);const s=function(a){const c={};return a.result().forEach((d=>{const l={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach((u=>{l[u]=d.stat(u)})),c[l.id]=l})),c},o=function(a){return new Map(Object.keys(a).map((c=>[c,a[c]])))};if(arguments.length>=2){const a=function(c){i(o(s(c)))};return t.apply(this,[a,n])}return new ie(((a,c)=>{t.apply(this,[function(d){a(o(s(d)))},c])})).then(i,r)}}function fC(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const n=e.RTCPeerConnection.prototype.getSenders;n&&(e.RTCPeerConnection.prototype.getSenders=function(){const r=n.apply(this,[]);return r.forEach((s=>s._pc=this)),r});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const r=i.apply(this,arguments);return r._pc=this,r}),e.RTCRtpSender.prototype.getStats=function(){const r=this;return this._pc.getStats().then((s=>cC(s,r.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const n=e.RTCPeerConnection.prototype.getReceivers;n&&(e.RTCPeerConnection.prototype.getReceivers=function(){const i=n.apply(this,[]);return i.forEach((r=>r._pc=this)),i}),Vo(e,"track",(i=>(i.receiver._pc=i.srcElement,i))),e.RTCRtpReceiver.prototype.getStats=function(){const i=this;return this._pc.getStats().then((r=>cC(r,i.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const n=arguments[0];let i,r,s;return this.getSenders().forEach((o=>{o.track===n&&(i?s=!0:i=o)})),this.getReceivers().forEach((o=>(o.track===n&&(r?s=!0:r=o),o.track===n))),s||i&&r?ie.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():r?r.getStats():ie.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function _C(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((s=>this._shimmedLocalStreams[s][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(s,o){if(!o)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const a=t.apply(this,arguments);return this._shimmedLocalStreams[o.id]?this._shimmedLocalStreams[o.id].indexOf(a)===-1&&this._shimmedLocalStreams[o.id].push(a):this._shimmedLocalStreams[o.id]=[o,a],a};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach((c=>{if(this.getSenders().find((l=>l.track===c)))throw new DOMException("Track already exists.","InvalidAccessError")}));const o=this.getSenders();n.apply(this,arguments);const a=this.getSenders().filter((c=>o.indexOf(c)===-1));this._shimmedLocalStreams[s.id]=[s].concat(a)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],i.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach((o=>{const a=this._shimmedLocalStreams[o].indexOf(s);a!==-1&&this._shimmedLocalStreams[o].splice(a,1),this._shimmedLocalStreams[o].length===1&&delete this._shimmedLocalStreams[o]})),r.apply(this,arguments)}}function EC(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return _C(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const c=n.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map((d=>this._reverseStreams[d.id]))};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach((d=>{if(this.getSenders().find((u=>u.track===d)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[c.id]){const d=new e.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}i.apply(this,[c])};const r=e.RTCPeerConnection.prototype.removeStream;function s(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach((u=>{const h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(p.id,"g"),h.id)})),new RTCSessionDescription({type:d.type,sdp:l})}e.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},e.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find((p=>p===c)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((p=>p.track===c)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const h=this._streams[d.id];if(h)h.addTrack(c),ie.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const p=new e.MediaStream([c]);this._streams[d.id]=p,this._reverseStreams[p.id]=d,this.addStream(p)}return this.getSenders().find((p=>p.track===c))},["createOffer","createAnswer"].forEach((function(c){const d=e.RTCPeerConnection.prototype[c],l={[c](){const u=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[h=>{const p=s(this,h);u[0].apply(null,[p])},h=>{u[1]&&u[1].apply(null,h)},arguments[2]]):d.apply(this,arguments).then((h=>s(this,h)))}};e.RTCPeerConnection.prototype[c]=l[c]}));const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=(function(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach((u=>{const h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(h.id,"g"),p.id)})),new RTCSessionDescription({type:d.type,sdp:l})})(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const c=a.get.apply(this);return c.type===""?c:s(this,c)}}),e.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach((l=>{this._streams[l].getTracks().find((u=>c.track===u))&&(d=this._streams[l])})),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function __(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(n){const i=e.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[n]=r[n]}))}function gC(e,t){Vo(e,"negotiationneeded",(n=>{const i=n.target;if(!(t.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")||i.signalingState==="stable")return n}))}var SC=Object.freeze({__proto__:null,fixNegotiationNeeded:gC,shimAddTrackRemoveTrack:EC,shimAddTrackRemoveTrackWithNative:_C,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(typeof t=="function"?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then((i=>{const r=n.video&&n.video.width,s=n.video&&n.video.height,o=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxFrameRate:o||3}},r&&(n.video.mandatory.maxWidth=r),s&&(n.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(n)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:pC,shimGetStats:mC,shimGetUserMedia:lC,shimMediaStream:uC,shimOnTrack:hC,shimPeerConnection:__,shimSenderReceiverGetStats:fC});function TC(e,t){const n=e&&e.navigator,i=e&&e.MediaStreamTrack;if(n.getUserMedia=function(r,s,o){m_("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(r).then(s,o)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const r=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),s(o)},i&&i.prototype.getSettings){const o=i.prototype.getSettings;i.prototype.getSettings=function(){const a=o.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const o=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function yC(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function E_(e,t){if(typeof e!="object"||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(r){const s=e.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};e.RTCPeerConnection.prototype[r]=o[r]}));const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[r,s,o]=arguments;return i.apply(this,[r||null]).then((a=>{if(t.version<53&&!s)try{a.forEach((c=>{c.type=n[c.type]||c.type}))}catch(c){if(c.name!=="TypeError")throw c;a.forEach(((d,l)=>{a.set(l,Object.assign({},d,{type:n[d.type]||d.type}))}))}return a})).then(s,o)}}function vC(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const i=t.apply(this,[]);return i.forEach((r=>r._pc=this)),i});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const i=n.apply(this,arguments);return i._pc=this,i}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):ie.resolve(new Map)}}function RC(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const n=t.apply(this,[]);return n.forEach((i=>i._pc=this)),n}),Vo(e,"track",(n=>(n.receiver._pc=n.srcElement,n))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function CC(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(t){m_("removeStream","removeTrack"),this.getSenders().forEach((n=>{var i;n.track&&X(i=t.getTracks()).call(i,n.track)&&this.removeTrack(n)}))})}function bC(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function IC(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];const i=n.length>0;i&&n.forEach((s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=t.apply(this,arguments);if(i){const{sender:s}=r,o=s.getParameters();(!("encodings"in o)||o.encodings.length===1&&Object.keys(o.encodings[0]).length===0)&&(o.encodings=n,s.sendEncodings=n,this.setParametersPromises.push(s.setParameters(o).then((()=>{delete s.sendEncodings})).catch((()=>{delete s.sendEncodings}))))}return r})}function wC(e){if(typeof e!="object"||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const n=t.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function AC(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?ie.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function OC(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?ie.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var NC=Object.freeze({__proto__:null,shimAddTransceiver:IC,shimCreateAnswer:OC,shimCreateOffer:AC,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,ie.reject(i)}return n.video===!0?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:wC,shimGetUserMedia:TC,shimOnTrack:yC,shimPeerConnection:E_,shimRTCDataChannel:bC,shimReceiverGetStats:RC,shimRemoveStream:CC,shimSenderGetStats:vC});function DC(e){if(typeof e=="object"&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(n){var i;this._localStreams||(this._localStreams=[]),X(i=this._localStreams).call(i,n)||this._localStreams.push(n),n.getAudioTracks().forEach((r=>t.call(this,r,n))),n.getVideoTracks().forEach((r=>t.call(this,r,n)))},e.RTCPeerConnection.prototype.addTrack=function(n){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return r&&r.forEach((o=>{var a;this._localStreams?X(a=this._localStreams).call(a,o)||this._localStreams.push(o):this._localStreams=[o]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const n=this._localStreams.indexOf(t);if(n===-1)return;this._localStreams.splice(n,1);const i=t.getTracks();this.getSenders().forEach((r=>{X(i).call(i,r.track)&&this.removeTrack(r)}))})}}function PC(e){if(typeof e=="object"&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach((r=>{var s;if(this._remoteStreams||(this._remoteStreams=[]),X(s=this._remoteStreams).call(s,r))return;this._remoteStreams.push(r);const o=new Event("addstream");o.stream=r,this.dispatchEvent(o)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(i){i.streams.forEach((r=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(r)>=0)return;n._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,n.dispatchEvent(s)}))}),t.apply(n,arguments)}}}function LC(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(c,d){const l=arguments.length>=2?arguments[2]:arguments[0],u=n.apply(this,[l]);return d?(u.then(c,d),ie.resolve()):u},t.createAnswer=function(c,d){const l=arguments.length>=2?arguments[2]:arguments[0],u=i.apply(this,[l]);return d?(u.then(c,d),ie.resolve()):u};let a=function(c,d,l){const u=r.apply(this,[c]);return l?(u.then(d,l),ie.resolve()):u};t.setLocalDescription=a,a=function(c,d,l){const u=s.apply(this,[c]);return l?(u.then(d,l),ie.resolve()):u},t.setRemoteDescription=a,a=function(c,d,l){const u=o.apply(this,[c]);return l?(u.then(d,l),ie.resolve()):u},t.addIceCandidate=a}function kC(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const n=t.mediaDevices,i=n.getUserMedia.bind(n);t.mediaDevices.getUserMedia=r=>i(xC(r))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(n,i,r){t.mediaDevices.getUserMedia(n).then(i,r)}).bind(t))}function xC(e){return e&&e.video!==void 0?Object.assign({},e,{video:aC(e.video)}):e}function MC(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(n,i){if(n&&n.iceServers){const r=[];for(let s=0;s<n.iceServers.length;s++){let o=n.iceServers[s];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(m_("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,r.push(o)):r.push(n.iceServers[s])}n.iceServers=r}return new t(n,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function UC(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function VC(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(n){if(n){n.offerToReceiveAudio!==void 0&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);const i=this.getTransceivers().find((s=>s.receiver.track.kind==="audio"));n.offerToReceiveAudio===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):n.offerToReceiveAudio!==!0||i||this.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo!==void 0&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);const r=this.getTransceivers().find((s=>s.receiver.track.kind==="video"));n.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):n.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function jC(e){typeof e!="object"||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var FC=Object.freeze({__proto__:null,shimAudioContext:jC,shimCallbacksAPI:LC,shimConstraints:xC,shimCreateOfferLegacy:VC,shimGetUserMedia:kC,shimLocalStreamsAPI:DC,shimRTCIceServerUrls:MC,shimRemoteStreamsAPI:PC,shimTrackEventTransceiver:UC}),BC=`	
\v\f\r \u2028\u2029\uFEFF`,V3=Gs,j3=gi,g_=BC,WC=ee("".replace),F3=RegExp("^["+g_+"]+"),B3=RegExp("(^|[^"+g_+"])["+g_+"]+$"),W3=function(e){return function(t){var n=j3(V3(t));return 1&e&&(n=WC(n,F3,"")),2&e&&(n=WC(n,B3,"$1")),n}},G3={trim:W3(3)},H3=Cy.PROPER,K3=U,GC=BC,Y3=G3.trim;lt({target:"String",proto:!0,forced:(function(e){return K3((function(){return!!GC[e]()||""[e]()!==""||H3&&GC[e].name!==e}))})("trim")},{trim:function(){return Y3(this)}});var z3=Fi("String","trim"),q3=q,X3=z3,S_=String.prototype,J3=function(e){var t=e.trim;return typeof e=="string"||e===S_||q3(S_,e)&&t===S_.trim?X3:t},zn=D(J3),HC={exports:{}};(function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(n){return n.trim().split(`
`).map((i=>i.trim()))},t.splitSections=function(n){return n.split(`
m=`).map(((i,r)=>(r>0?"m="+i:i).trim()+`\r
`))},t.getDescription=function(n){const i=t.splitSections(n);return i&&i[0]},t.getMediaSections=function(n){const i=t.splitSections(n);return i.shift(),i},t.matchPrefix=function(n,i){return t.splitLines(n).filter((r=>r.indexOf(i)===0))},t.parseCandidate=function(n){let i;i=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1])}return r},t.writeCandidate=function(n){const i=[];i.push(n.foundation);const r=n.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(n.protocol.toUpperCase()),i.push(n.priority),i.push(n.address||n.ip),i.push(n.port);const s=n.type;return i.push("typ"),i.push(s),s!=="host"&&n.relatedAddress&&n.relatedPort&&(i.push("raddr"),i.push(n.relatedAddress),i.push("rport"),i.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(i.push("ufrag"),i.push(n.usernameFragment||n.ufrag)),"candidate:"+i.join(" ")},t.parseIceOptions=function(n){return n.substring(14).split(" ")},t.parseRtpMap=function(n){let i=n.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(n){let i=n.payloadType;n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType);const r=n.channels||n.numChannels||1;return"a=rtpmap:"+i+" "+n.name+"/"+n.clockRate+(r!==1?"/"+r:"")+`\r
`},t.parseExtmap=function(n){const i=n.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},t.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},t.parseFmtp=function(n){const i={};let r;const s=n.substring(n.indexOf(" ")+1).split(";");for(let o=0;o<s.length;o++)r=s[o].trim().split("="),i[r[0].trim()]=r[1];return i},t.writeFmtp=function(n){let i="",r=n.payloadType;if(n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const s=[];Object.keys(n.parameters).forEach((o=>{n.parameters[o]!==void 0?s.push(o+"="+n.parameters[o]):s.push(o)})),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},t.parseRtcpFb=function(n){const i=n.substring(n.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},t.writeRtcpFb=function(n){let i="",r=n.payloadType;return n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach((s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`})),i},t.parseSsrcMedia=function(n){const i=n.indexOf(" "),r={ssrc:parseInt(n.substring(7,i),10)},s=n.indexOf(":",i);return s>-1?(r.attribute=n.substring(i+1,s),r.value=n.substring(s+1)):r.attribute=n.substring(i+1),r},t.parseSsrcGroup=function(n){const i=n.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map((r=>parseInt(r,10)))}},t.getMid=function(n){const i=t.matchPrefix(n,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(n){const i=n.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},t.getDtlsParameters=function(n,i){return{role:"auto",fingerprints:t.matchPrefix(n+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(n,i){let r="a=setup:"+i+`\r
`;return n.fingerprints.forEach((s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`})),r},t.parseCryptoLine=function(n){const i=n.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},t.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?t.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;const i=n.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},t.getCryptoParameters=function(n,i){return t.matchPrefix(n+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(n,i){const r=t.matchPrefix(n+i,"a=ice-ufrag:")[0],s=t.matchPrefix(n+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},t.writeIceParameters=function(n){let i="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(i+=`a=ice-lite\r
`),i},t.parseRtpParameters=function(n){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(n)[0].split(" ");i.profile=r[2];for(let o=3;o<r.length;o++){const a=r[o],c=t.matchPrefix(n,"a=rtpmap:"+a+" ")[0];if(c){const d=t.parseRtpMap(c),l=t.matchPrefix(n,"a=fmtp:"+a+" ");switch(d.parameters=l.length?t.parseFmtp(l[0]):{},d.rtcpFeedback=t.matchPrefix(n,"a=rtcp-fb:"+a+" ").map(t.parseRtcpFb),i.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(d.name.toUpperCase())}}}t.matchPrefix(n,"a=extmap:").forEach((o=>{i.headerExtensions.push(t.parseExtmap(o))}));const s=t.matchPrefix(n,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach((o=>{s.forEach((a=>{o.rtcpFeedback.find((c=>c.type===a.type&&c.parameter===a.parameter))||o.rtcpFeedback.push(a)}))})),i},t.writeRtpDescription=function(n,i){let r="";r+="m="+n+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map((o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType)).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach((o=>{r+=t.writeRtpMap(o),r+=t.writeFmtp(o),r+=t.writeRtcpFb(o)}));let s=0;return i.codecs.forEach((o=>{o.maxptime>s&&(s=o.maxptime)})),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach((o=>{r+=t.writeExtmap(o)})),r},t.parseRtpEncodingParameters=function(n){const i=[],r=t.parseRtpParameters(n),s=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=t.matchPrefix(n,"a=ssrc:").map((h=>t.parseSsrcMedia(h))).filter((h=>h.attribute==="cname")),c=a.length>0&&a[0].ssrc;let d;const l=t.matchPrefix(n,"a=ssrc-group:FID").map((h=>h.substring(17).split(" ").map((p=>parseInt(p,10)))));l.length>0&&l[0].length>1&&l[0][0]===c&&(d=l[0][1]),r.codecs.forEach((h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&d&&(p.rtx={ssrc:d}),i.push(p),s&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},i.push(p))}})),i.length===0&&c&&i.push({ssrc:c});let u=t.matchPrefix(n,"b=");return u.length&&(u=u[0].indexOf("b=TIAS:")===0?parseInt(u[0].substring(7),10):u[0].indexOf("b=AS:")===0?1e3*parseInt(u[0].substring(5),10)*.95-16e3:void 0,i.forEach((h=>{h.maxBitrate=u}))),i},t.parseRtcpParameters=function(n){const i={},r=t.matchPrefix(n,"a=ssrc:").map((a=>t.parseSsrcMedia(a))).filter((a=>a.attribute==="cname"))[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=t.matchPrefix(n,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const o=t.matchPrefix(n,"a=rtcp-mux");return i.mux=o.length>0,i},t.writeRtcpParameters=function(n){let i="";return n.reducedSize&&(i+=`a=rtcp-rsize\r
`),n.mux&&(i+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(i+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),i},t.parseMsid=function(n){let i;const r=t.matchPrefix(n,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=t.matchPrefix(n,"a=ssrc:").map((o=>t.parseSsrcMedia(o))).filter((o=>o.attribute==="msid"));return s.length>0?(i=s[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(n){const i=t.parseMLine(n),r=t.matchPrefix(n,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const o=t.matchPrefix(n,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const a=t.matchPrefix(n,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},t.writeSctpDescription=function(n,i){let r=[];return r=n.protocol!=="DTLS/SCTP"?["m="+n.kind+" 9 "+n.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:["m="+n.kind+" 9 "+n.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(n,i,r){let s;const o=i!==void 0?i:2;return s=n||t.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(n,i){const r=t.splitLines(n);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(n){return t.splitLines(n)[0].split(" ")[0].substring(2)},t.isRejected=function(n){return n.split(" ",2)[1]==="0"},t.parseMLine=function(n){const i=t.splitLines(n)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(n){const i=t.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;const i=t.splitLines(n);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},e.exports=t})(HC);var KC=HC.exports,Qa=D(KC),Q3=g({__proto__:null,default:Qa},[KC]);function ku(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){const i=new t(n),r=Qa.parseCandidate(n.candidate),s=Object.assign(i,r);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(n)},e.RTCIceCandidate.prototype=t.prototype,Vo(e,"icecandidate",(n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new e.RTCIceCandidate(n.candidate),writable:"false"}),n)))}function T_(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||Vo(e,"icecandidate",(t=>{if(t.candidate){const n=Qa.parseCandidate(t.candidate.candidate);n.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return t}))}function xu(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const n=function(a){if(!a||!a.sdp)return!1;const c=Qa.splitSections(a.sdp);return c.shift(),c.some((d=>{const l=Qa.parseMLine(d);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1}))},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const d=parseInt(c[1],10);return d!=d?-1:d},r=function(a){let c=65536;return t.browser==="firefox"&&(c=t.version<57?a===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637),c},s=function(a,c){let d=65536;t.browser==="firefox"&&t.version===57&&(d=65535);const l=Qa.matchPrefix(a.sdp,"a=max-message-size:");return l.length>0?d=parseInt(l[0].substr(19),10):t.browser==="firefox"&&c!==-1&&(d=2147483637),d},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const a=i(arguments[0]),c=r(a),d=s(arguments[0],a);let l;l=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);const u={};Object.defineProperty(u,"maxMessageSize",{get:()=>l}),this._sctp=u}return o.apply(this,arguments)}}function Mu(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(i,r){const s=i.send;i.send=function(){const o=arguments[0],a=o.length||o.size||o.byteLength;if(i.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const i=n.apply(this,arguments);return t(i,this),i},Vo(e,"datachannel",(i=>(t(i.channel,i.target),i)))}function y_(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((n=>{const i=t[n];t[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const o=new Event("connectionstatechange",r);s.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function v_(e,t){if(!e.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(i){if(i&&i.sdp&&i.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const r=i.sdp.split(`
`).filter((s=>zn(s).call(s)!=="a=extmap-allow-mixed")).join(`
`);e.RTCSessionDescription&&i instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:i.type,sdp:r}):i.sdp=r}return n.apply(this,arguments)}}function Uu(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.addIceCandidate;n&&n.length!==0&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?ie.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),ie.resolve())})}function Vu(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.setLocalDescription;n&&n.length!==0&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let i=arguments[0]||{};if(typeof i!="object"||i.type&&i.sdp)return n.apply(this,arguments);if(i={type:i.type,sdp:i.sdp},!i.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":i.type="offer";break;default:i.type="answer"}return i.sdp||i.type!=="offer"&&i.type!=="answer"?n.apply(this,[i]):(i.type==="offer"?this.createOffer:this.createAnswer).apply(this).then((r=>n.apply(this,[r])))})}var Z3=Object.freeze({__proto__:null,removeExtmapAllowMixed:v_,shimAddIceCandidateNullOrEmpty:Uu,shimConnectionState:y_,shimMaxMessageSize:xu,shimParameterlessSetLocalDescription:Vu,shimRTCIceCandidate:ku,shimRTCIceCandidateRelayProtocol:T_,shimSendThrowTypeError:Mu});(function(){let{window:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=sC,i=(function(s){const o={browser:null,version:null};if(s===void 0||!s.navigator)return o.browser="Not a browser.",o;const{navigator:a}=s;if(a.mozGetUserMedia)o.browser="firefox",o.version=Lu(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||s.isSecureContext===!1&&s.webkitRTCPeerConnection)o.browser="chrome",o.version=Lu(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!s.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return o.browser="Not a supported browser.",o;o.browser="safari",o.version=Lu(a.userAgent,/AppleWebKit\/(\d+)\./,1),o.supportsUnifiedPlan=s.RTCRtpTransceiver&&"currentDirection"in s.RTCRtpTransceiver.prototype}return o})(e),r={browserDetails:i,commonShim:Z3,extractVersion:Lu,disableLog:M3,disableWarnings:U3,sdp:Q3};switch(i.browser){case"chrome":if(!SC||!__||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(i.version===null)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=SC,Uu(e,i),Vu(e),lC(e,i),uC(e),__(e,i),hC(e),EC(e,i),pC(e),mC(e),fC(e),gC(e,i),ku(e),T_(e),y_(e),xu(e,i),Mu(e),v_(e,i);break;case"firefox":if(!NC||!E_||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=NC,Uu(e,i),Vu(e),TC(e,i),E_(e,i),yC(e),CC(e),vC(e),RC(e),bC(e),IC(e),wC(e),AC(e),OC(e),ku(e),y_(e),xu(e,i),Mu(e);break;case"safari":if(!FC||!t.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=FC,Uu(e,i),Vu(e),MC(e),VC(e),LC(e),DC(e),PC(e),UC(e),kC(e),jC(e),ku(e),T_(e),xu(e,i),Mu(e),v_(e,i);break;default:n("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var $3=U,YC=ae.RegExp,e5=!$3((function(){var e=!0;try{YC(".","d")}catch{e=!1}var t={},n="",i=e?"dgimsy":"gimsy",r=function(a,c){Object.defineProperty(t,a,{get:function(){return n+=c,!0}})},s={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var o in e&&(s.hasIndices="d"),s)r(o,s[o]);return Object.getOwnPropertyDescriptor(YC.prototype,"flags").get.call(t)!==i||n!==i})),t5=Ei,n5=An,i5=Vn,r5=q,zC={correct:e5},s5=function(){var e=t5(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},o5=RegExp.prototype,R_=zC.correct?function(e){return e.flags}:function(e){return zC.correct||!r5(o5,e)||i5(e,"flags")?e.flags:n5(s5,e)},C_=ee,a5=Math.floor,b_=C_("".charAt),c5=C_("".replace),I_=C_("".slice),d5=/\$([$&'`]|\d{1,2})/g,l5=lt,u5=An,w_=ee,qC=Gs,h5=ln,p5=Yn,m5=Am,Za=gi,f5=id,_5=R_,E5=function(e,t,n,i,r,s){var o=n+e.length,a=i.length,c=d5;return c5(s,c,(function(d,l){var u;switch(b_(l,0)){case"$":return"$";case"&":return e;case"`":return I_(t,0,n);case"'":return I_(t,o);case"<":u=r[I_(l,1,-1)];break;default:var h=+l;if(h===0)return d;if(h>a){var p=a5(h/10);return p===0?d:p<=a?i[p-1]===void 0?b_(l,1):i[p-1]+b_(l,1):d}u=i[h-1]}return u===void 0?"":u}))},g5=$t("replace"),S5=TypeError,A_=w_("".indexOf),T5=w_("".replace),XC=w_("".slice),y5=Math.max;l5({target:"String",proto:!0},{replaceAll:function(e,t){var n,i,r,s,o,a,c,d,l,u,h=qC(this),p=0,R="";if(p5(e)){if((n=m5(e))&&(i=Za(qC(_5(e))),!~A_(i,"g")))throw new S5("`.replaceAll` does not allow non-global regexes");if(r=f5(e,g5))return u5(r,e,h,t);if(n)return T5(Za(h),e,t)}for(s=Za(h),o=Za(e),(a=h5(t))||(t=Za(t)),c=o.length,d=y5(1,c),l=A_(s,o);l!==-1;)u=a?Za(t(o,l,s)):E5(o,s,l,[],void 0,t),R+=XC(s,p,l)+u,p=l+c,l=l+d>s.length?-1:A_(s,o,l+d);return p<s.length&&(R+=XC(s,p)),R}});var v5=Fi("String","replaceAll"),R5=q,C5=v5,O_=String.prototype,b5=function(e){var t=e.replaceAll;return typeof e=="string"||e===O_||R5(O_,e)&&t===O_.replaceAll?C5:t},I5=D(b5),N_=ae;lt({global:!0,forced:N_.globalThis!==N_},{globalThis:N_});var JC=D(ae),D_={exports:{}};(function(e,t){(function(n,i){var r="function",s="undefined",o="object",a="string",c="major",d="model",l="name",u="type",h="vendor",p="version",R="architecture",T="console",y="mobile",I="tablet",A="smarttv",N="wearable",k="embedded",x="Amazon",P="Apple",M="ASUS",G="BlackBerry",Y="Browser",de="Chrome",Ie="Firefox",Ce="Google",Ue="Honor",Pe="Huawei",nt="LG",Pt="Microsoft",H="Motorola",$="Nvidia",he="OnePlus",K="Opera",S="OPPO",O="Samsung",L="Sharp",Q="Sony",Oe="Xiaomi",Ct="Zebra",_n="Facebook",Zi="Chromium OS",vo="Mac OS",Vp=" Browser",zc=function(nn){for(var cn={},Ot=0;Ot<nn.length;Ot++)cn[nn[Ot].toUpperCase()]=nn[Ot];return cn},jp=function(nn,cn){return typeof nn===a&&ya(cn).indexOf(ya(nn))!==-1},ya=function(nn){return nn.toLowerCase()},Al=function(nn,cn){if(typeof nn===a)return nn=nn.replace(/^\s\s*/,""),typeof cn===s?nn:nn.substring(0,500)},va=function(nn,cn){for(var Ot,_i,Yr,zt,js,Je,zr=0;zr<cn.length&&!js;){var Ra=cn[zr],Ss=cn[zr+1];for(Ot=_i=0;Ot<Ra.length&&!js&&Ra[Ot];)if(js=Ra[Ot++].exec(nn))for(Yr=0;Yr<Ss.length;Yr++)Je=js[++_i],typeof(zt=Ss[Yr])===o&&zt.length>0?zt.length===2?typeof zt[1]==r?this[zt[0]]=zt[1].call(this,Je):this[zt[0]]=zt[1]:zt.length===3?typeof zt[1]!==r||zt[1].exec&&zt[1].test?this[zt[0]]=Je?Je.replace(zt[1],zt[2]):i:this[zt[0]]=Je?zt[1].call(this,Je,zt[2]):i:zt.length===4&&(this[zt[0]]=Je?zt[3].call(this,Je.replace(zt[1],zt[2])):i):this[zt]=Je||i;zr+=2}},Ro=function(nn,cn){for(var Ot in cn)if(typeof cn[Ot]===o&&cn[Ot].length>0){for(var _i=0;_i<cn[Ot].length;_i++)if(jp(cn[Ot][_i],nn))return Ot==="?"?i:Ot}else if(jp(cn[Ot],nn))return Ot==="?"?i:Ot;return cn.hasOwnProperty("*")?cn["*"]:nn},jL={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},FL={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,p],[/opios[\/ ]+([\w\.]+)/i],[p,[l,K+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[p,[l,K+" GX"]],[/\bopr\/([\w\.]+)/i],[p,[l,K]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[p,[l,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[p,[l,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/quark(?:pc)?\/([-\w\.]+)/i],[p,[l,"Quark"]],[/\bddg\/([\w\.]+)/i],[p,[l,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[l,"UC"+Y]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[l,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[p,[l,"Smart Lenovo "+Y]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+Y],p],[/\bfocus\/([\w\.]+)/i],[p,[l,Ie+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[l,K+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,K+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI"+Vp]],[/fxios\/([\w\.-]+)/i],[p,[l,Ie]],[/\bqihoobrowser\/?([\w\.]*)/i],[p,[l,"360"]],[/\b(qq)\/([\w\.]+)/i],[[l,/(.+)/,"$1Browser"],p],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1"+Vp],p],[/samsungbrowser\/([\w\.]+)/i],[p,[l,O+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[p,[l,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[l,"Sogou Mobile"],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[l,p],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[l],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[p,l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,_n],p],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[l,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[l,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[p,[l,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[l,de+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,de+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[l,"Android "+Y]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[p,Ro,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],p],[/(wolvic|librewolf)\/([\w\.]+)/i],[l,p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[l,Ie+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[l,[p,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[l,[p,/master.|lts./,""]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[R,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[R,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[R,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[R,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[R,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[R,/ower/,"",ya]],[/ sun4\w[;\)]/i],[[R,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[R,ya]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[h,O],[u,I]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[d,[h,O],[u,y]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[d,[h,P],[u,y]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[h,P],[u,I]],[/(macintosh);/i],[d,[h,P]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[h,L],[u,y]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[d,[h,Ue],[u,I]],[/honor([-\w ]+)[;\)]/i],[d,[h,Ue],[u,y]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[d,[h,Pe],[u,I]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[h,Pe],[u,y]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[d,/_/g," "],[h,Oe],[u,I]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[d,/_/g," "],[h,Oe],[u,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[h,S],[u,y]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[d,[h,Ro,{OnePlus:["304","403","203"],"*":S}],[u,I]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[h,"Vivo"],[u,y]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[d,[h,"Realme"],[u,y]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[h,H],[u,y]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[h,H],[u,I]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[h,nt],[u,I]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv|watch)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[h,nt],[u,y]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[d,[h,"Lenovo"],[u,I]],[/(nokia) (t[12][01])/i],[h,d,[u,I]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[d,/_/g," "],[u,y],[h,"Nokia"]],[/(pixel (c|tablet))\b/i],[d,[h,Ce],[u,I]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[h,Ce],[u,y]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[h,Q],[u,y]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[h,Q],[u,I]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[h,he],[u,y]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[h,x],[u,I]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[h,x],[u,y]],[/(playbook);[-\w\),; ]+(rim)/i],[d,h,[u,I]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[h,G],[u,y]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[h,M],[u,I]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[h,M],[u,y]],[/(nexus 9)/i],[d,[h,"HTC"],[u,I]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[h,[d,/_/g," "],[u,y]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[d,[h,"TCL"],[u,I]],[/(itel) ((\w+))/i],[[h,ya],d,[u,Ro,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[h,"Acer"],[u,I]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[h,"Meizu"],[u,y]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[d,[h,"Ulefone"],[u,y]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[d,[h,"Energizer"],[u,y]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[d,[h,"Cat"],[u,y]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[d,[h,"Smartfren"],[u,y]],[/droid.+; (a(?:015|06[35]|142p?))/i],[d,[h,"Nothing"],[u,y]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[d,[h,"Archos"],[u,I]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[d,[h,"Archos"],[u,y]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[h,d,[u,I]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (hmd|imo) ([\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[h,d,[u,y]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[h,d,[u,I]],[/(surface duo)/i],[d,[h,Pt],[u,I]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[h,"Fairphone"],[u,y]],[/(u304aa)/i],[d,[h,"AT&T"],[u,y]],[/\bsie-(\w*)/i],[d,[h,"Siemens"],[u,y]],[/\b(rct\w+) b/i],[d,[h,"RCA"],[u,I]],[/\b(venue[\d ]{2,7}) b/i],[d,[h,"Dell"],[u,I]],[/\b(q(?:mv|ta)\w+) b/i],[d,[h,"Verizon"],[u,I]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[h,"Barnes & Noble"],[u,I]],[/\b(tm\d{3}\w+) b/i],[d,[h,"NuVision"],[u,I]],[/\b(k88) b/i],[d,[h,"ZTE"],[u,I]],[/\b(nx\d{3}j) b/i],[d,[h,"ZTE"],[u,y]],[/\b(gen\d{3}) b.+49h/i],[d,[h,"Swiss"],[u,y]],[/\b(zur\d{3}) b/i],[d,[h,"Swiss"],[u,I]],[/\b((zeki)?tb.*\b) b/i],[d,[h,"Zeki"],[u,I]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[h,"Dragon Touch"],d,[u,I]],[/\b(ns-?\w{0,9}) b/i],[d,[h,"Insignia"],[u,I]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[h,"NextBook"],[u,I]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[h,"Voice"],d,[u,y]],[/\b(lvtel\-)?(v1[12]) b/i],[[h,"LvTel"],d,[u,y]],[/\b(ph-1) /i],[d,[h,"Essential"],[u,y]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[h,"Envizen"],[u,I]],[/\b(trio[-\w\. ]+) b/i],[d,[h,"MachSpeed"],[u,I]],[/\btu_(1491) b/i],[d,[h,"Rotor"],[u,I]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[d,[h,$],[u,I]],[/(sprint) (\w+)/i],[h,d,[u,y]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[h,Pt],[u,y]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[h,Ct],[u,I]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[h,Ct],[u,y]],[/smart-tv.+(samsung)/i],[h,[u,A]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[h,O],[u,A]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[h,nt],[u,A]],[/(apple) ?tv/i],[h,[d,P+" TV"],[u,A]],[/crkey/i],[[d,de+"cast"],[h,Ce],[u,A]],[/droid.+aft(\w+)( bui|\))/i],[d,[h,x],[u,A]],[/(shield \w+ tv)/i],[d,[h,$],[u,A]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[h,L],[u,A]],[/(bravia[\w ]+)( bui|\))/i],[d,[h,Q],[u,A]],[/(mi(tv|box)-?\w+) bui/i],[d,[h,Oe],[u,A]],[/Hbbtv.*(technisat) (.*);/i],[h,d,[u,A]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[h,Al],[d,Al],[u,A]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[d,[u,A]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,A]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[h,d,[u,T]],[/droid.+; (shield)( bui|\))/i],[d,[h,$],[u,T]],[/(playstation \w+)/i],[d,[h,Q],[u,T]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[h,Pt],[u,T]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[d,[h,O],[u,N]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[h,d,[u,N]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[d,[h,S],[u,N]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[h,P],[u,N]],[/(opwwe\d{3})/i],[d,[h,he],[u,N]],[/(moto 360)/i],[d,[h,H],[u,N]],[/(smartwatch 3)/i],[d,[h,Q],[u,N]],[/(g watch r)/i],[d,[h,nt],[u,N]],[/droid.+; (wt63?0{2,3})\)/i],[d,[h,Ct],[u,N]],[/droid.+; (glass) \d/i],[d,[h,Ce],[u,N]],[/(pico) (4|neo3(?: link|pro)?)/i],[h,d,[u,N]],[/; (quest( \d| pro)?)/i],[d,[h,_n],[u,N]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[h,[u,k]],[/(aeobc)\b/i],[d,[h,x],[u,k]],[/(homepod).+mac os/i],[d,[h,P],[u,k]],[/windows iot/i],[[u,k]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[d,[u,y]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[u,I]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,I]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,y]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[d,[h,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[l,p],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[l,p],[/ladybird\//i],[[l,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,p],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[l,[p,Ro,jL]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[p,Ro,jL],[l,"Windows"]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,vo],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,l],[/(ubuntu) ([\w\.]+) like android/i],[[l,/(.+)/,"$1 Touch"],p],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/; ]?([\d\.]*)/i],[l,p],[/\(bb(10);/i],[p,[l,G]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[l,Ie+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[l,de+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,Zi],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,p],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[l,p]]},Kr=function(nn,cn){if(typeof nn===o&&(cn=nn,nn=i),!(this instanceof Kr))return new Kr(nn,cn).getResult();var Ot=typeof n!==s&&n.navigator?n.navigator:i,_i=nn||(Ot&&Ot.userAgent?Ot.userAgent:""),Yr=Ot&&Ot.userAgentData?Ot.userAgentData:i,zt=cn?(function(Je,zr){var Ra={};for(var Ss in Je)zr[Ss]&&zr[Ss].length%2==0?Ra[Ss]=zr[Ss].concat(Je[Ss]):Ra[Ss]=Je[Ss];return Ra})(FL,cn):FL,js=Ot&&Ot.userAgent==_i;return this.getBrowser=function(){var Je={};return Je[l]=i,Je[p]=i,va.call(Je,_i,zt.browser),Je[c]=(function(zr){return typeof zr===a?zr.replace(/[^\d\.]/g,"").split(".")[0]:i})(Je[p]),js&&Ot&&Ot.brave&&typeof Ot.brave.isBrave==r&&(Je[l]="Brave"),Je},this.getCPU=function(){var Je={};return Je[R]=i,va.call(Je,_i,zt.cpu),Je},this.getDevice=function(){var Je={};return Je[h]=i,Je[d]=i,Je[u]=i,va.call(Je,_i,zt.device),js&&!Je[u]&&Yr&&Yr.mobile&&(Je[u]=y),js&&Je[d]=="Macintosh"&&Ot&&typeof Ot.standalone!==s&&Ot.maxTouchPoints&&Ot.maxTouchPoints>2&&(Je[d]="iPad",Je[u]=I),Je},this.getEngine=function(){var Je={};return Je[l]=i,Je[p]=i,va.call(Je,_i,zt.engine),Je},this.getOS=function(){var Je={};return Je[l]=i,Je[p]=i,va.call(Je,_i,zt.os),js&&!Je[l]&&Yr&&Yr.platform&&Yr.platform!="Unknown"&&(Je[l]=Yr.platform.replace(/chrome os/i,Zi).replace(/macos/i,vo)),Je},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return _i},this.setUA=function(Je){return _i=typeof Je===a&&Je.length>500?Al(Je,500):Je,this},this.setUA(_i),this};Kr.VERSION="0.7.41",Kr.BROWSER=zc([l,p,c]),Kr.CPU=zc([R]),Kr.DEVICE=zc([d,h,u,T,y,A,I,N,k]),Kr.ENGINE=Kr.OS=zc([l,p]),e.exports&&(t=e.exports=Kr),t.UAParser=Kr;var qc=typeof n!==s&&(n.jQuery||n.Zepto);if(qc&&!qc.ua){var Fp=new Kr;qc.ua=Fp.getResult(),qc.ua.get=function(){return Fp.getUA()},qc.ua.set=function(nn){Fp.setUA(nn);var cn=Fp.getResult();for(var Ot in cn)qc.ua[Ot]=cn[Ot]}}})(typeof window=="object"?window:C)})(D_,D_.exports);var w5=D(D_.exports),QC=uu.clear;lt({global:!0,bind:!0,forced:ae.clearImmediate!==QC},{clearImmediate:QC});var ZC=ae,A5=dt,O5=ln,N5=Pm,D5=Cs,P5=Xs,L5=Po,k5=ZC.Function,x5=/MSIE .\./.test(D5)||N5==="BUN"&&(function(){var e=ZC.Bun.version.split(".");return e.length<3||e[0]==="0"&&(e[1]<3||e[1]==="3"&&e[2]==="0")})(),M5=lt,$C=ae,eb=uu.set,U5=function(e,t){var n=1;return x5?function(i,r){var s=L5(arguments.length,1)>n,o=O5(i)?i:k5(i),a=s?P5(arguments,n):[],c=s?function(){A5(o,this,a)}:o;return e(c)}:e},tb=$C.setImmediate?U5(eb):eb;M5({global:!0,bind:!0,forced:$C.setImmediate!==tb},{setImmediate:tb});var nb=D(bi.setImmediate),V5=ae,j5=dv,F5=Ii,B5=Po,W5=at;lt({global:!0,dontCallGetSet:!0,forced:U((function(){return W5&&Object.getOwnPropertyDescriptor(V5,"queueMicrotask").value.length!==1}))},{queueMicrotask:function(e){B5(arguments.length,1),j5(F5(e))}});var ib=D(bi.queueMicrotask);function rb(e,t){return function(){return e.apply(t,arguments)}}const{toString:G5}=Object.prototype,{getPrototypeOf:P_}=Object,{iterator:ju,toStringTag:sb}=Symbol,Fu=(L_=Object.create(null),e=>{const t=G5.call(e);return L_[t]||(L_[t]=t.slice(8,-1).toLowerCase())});var L_;const wr=e=>(e=e.toLowerCase(),t=>Fu(t)===e),Bu=e=>t=>typeof t===e,{isArray:$a}=Array,ec=Bu("undefined");function Id(e){return e!==null&&!ec(e)&&e.constructor!==null&&!ec(e.constructor)&&wi(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}const ob=wr("ArrayBuffer"),H5=Bu("string"),wi=Bu("function"),ab=Bu("number"),wd=e=>e!==null&&typeof e=="object",Wu=e=>{if(Fu(e)!=="object")return!1;const t=P_(e);return!(t!==null&&t!==Object.prototype&&Object.getPrototypeOf(t)!==null||sb in e||ju in e)},K5=wr("Date"),Y5=wr("File"),z5=wr("Blob"),q5=wr("FileList"),X5=wr("URLSearchParams"),[J5,Q5,Z5,$5]=["ReadableStream","Request","Response","Headers"].map(wr);function Ad(e,t){let n,i,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(e!=null)if(typeof e!="object"&&(e=[e]),$a(e))for(n=0,i=e.length;n<i;n++)t.call(null,e[n],n,e);else{if(Id(e))return;const s=r?Object.getOwnPropertyNames(e):Object.keys(e),o=s.length;let a;for(n=0;n<o;n++)a=s[n],t.call(null,e[a],a,e)}}function cb(e,t){if(Id(e))return null;t=t.toLowerCase();const n=Object.keys(e);let i,r=n.length;for(;r-- >0;)if(i=n[r],t===i.toLowerCase())return i;return null}const jo=JC!==void 0?JC:typeof self<"u"?self:typeof window<"u"?window:US,db=e=>!ec(e)&&e!==jo,eW=(k_=typeof Uint8Array<"u"&&P_(Uint8Array),e=>k_&&e instanceof k_);var k_;const tW=wr("HTMLFormElement"),lb=(e=>{let{hasOwnProperty:t}=e;return(n,i)=>t.call(n,i)})(Object.prototype),nW=wr("RegExp"),ub=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),i={};Ad(n,((r,s)=>{let o;(o=t(r,s,e))!==!1&&(i[s]=o||r)})),Object.defineProperties(e,i)},iW=wr("AsyncFunction"),hb=(pb=typeof nb=="function",mb=wi(jo.postMessage),pb?nb:mb?(x_="axios@".concat(Math.random()),Gu=[],jo.addEventListener("message",(e=>{let{source:t,data:n}=e;t===jo&&n===x_&&Gu.length&&Gu.shift()()}),!1),e=>{Gu.push(e),jo.postMessage(x_,"*")}):e=>setTimeout(e));var pb,mb,x_,Gu;const rW=ib!==void 0?ib.bind(jo):typeof process<"u"&&process.nextTick||hb;var se={isArray:$a,isArrayBuffer:ob,isBuffer:Id,isFormData:e=>{let t;return e&&(typeof FormData=="function"&&e instanceof FormData||wi(e.append)&&((t=Fu(e))==="formdata"||t==="object"&&wi(e.toString)&&e.toString()==="[object FormData]"))},isArrayBufferView:function(e){let t;return t=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&ob(e.buffer),t},isString:H5,isNumber:ab,isBoolean:e=>e===!0||e===!1,isObject:wd,isPlainObject:Wu,isEmptyObject:e=>{if(!wd(e)||Id(e))return!1;try{return Object.keys(e).length===0&&Object.getPrototypeOf(e)===Object.prototype}catch{return!1}},isReadableStream:J5,isRequest:Q5,isResponse:Z5,isHeaders:$5,isUndefined:ec,isDate:K5,isFile:Y5,isBlob:z5,isRegExp:nW,isFunction:wi,isStream:e=>wd(e)&&wi(e.pipe),isURLSearchParams:X5,isTypedArray:eW,isFileList:q5,forEach:Ad,merge:function e(){const{caseless:t,skipUndefined:n}=db(this)&&this||{},i={},r=(s,o)=>{const a=t&&cb(i,o)||o;Wu(i[a])&&Wu(s)?i[a]=e(i[a],s):Wu(s)?i[a]=e({},s):$a(s)?i[a]=s.slice():n&&ec(s)||(i[a]=s)};for(let s=0,o=arguments.length;s<o;s++)arguments[s]&&Ad(arguments[s],r);return i},extend:function(e,t,n){let{allOwnKeys:i}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return Ad(t,((r,s)=>{n&&wi(r)?e[s]=rb(r,n):e[s]=r}),{allOwnKeys:i}),e},trim:e=>zn(e)?zn(e).call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(e.charCodeAt(0)===65279&&(e=e.slice(1)),e),inherits:(e,t,n,i)=>{e.prototype=Object.create(t.prototype,i),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),n&&Object.assign(e.prototype,n)},toFlatObject:(e,t,n,i)=>{let r,s,o;const a={};if(t=t||{},e==null)return t;do{for(r=Object.getOwnPropertyNames(e),s=r.length;s-- >0;)o=r[s],i&&!i(o,e,t)||a[o]||(t[o]=e[o],a[o]=!0);e=n!==!1&&P_(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},kindOf:Fu,kindOfTest:wr,endsWith:(e,t,n)=>{e=String(e),(n===void 0||n>e.length)&&(n=e.length),n-=t.length;const i=e.indexOf(t,n);return i!==-1&&i===n},toArray:e=>{if(!e)return null;if($a(e))return e;let t=e.length;if(!ab(t))return null;const n=new Array(t);for(;t-- >0;)n[t]=e[t];return n},forEachEntry:(e,t)=>{const n=(e&&e[ju]).call(e);let i;for(;(i=n.next())&&!i.done;){const r=i.value;t.call(e,r[0],r[1])}},matchAll:(e,t)=>{let n;const i=[];for(;(n=e.exec(t))!==null;)i.push(n);return i},isHTMLForm:tW,hasOwnProperty:lb,hasOwnProp:lb,reduceDescriptors:ub,freezeMethods:e=>{ub(e,((t,n)=>{if(wi(e)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const i=e[n];wi(i)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))}))},toObjectSet:(e,t)=>{const n={},i=r=>{r.forEach((s=>{n[s]=!0}))};return $a(e)?i(e):i(String(e).split(t)),n},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(t,n,i){return n.toUpperCase()+i})),noop:()=>{},toFiniteNumber:(e,t)=>e!=null&&Number.isFinite(e=+e)?e:t,findKey:cb,global:jo,isContextDefined:db,isSpecCompliantForm:function(e){return!!(e&&wi(e.append)&&e[sb]==="FormData"&&e[ju])},toJSONObject:e=>{const t=new Array(10),n=(i,r)=>{if(wd(i)){if(t.indexOf(i)>=0)return;if(Id(i))return i;if(!("toJSON"in i)){t[r]=i;const s=$a(i)?[]:{};return Ad(i,((o,a)=>{const c=n(o,r+1);!ec(c)&&(s[a]=c)})),t[r]=void 0,s}}return i};return n(e,0)},isAsyncFn:iW,isThenable:e=>e&&(wd(e)||wi(e))&&wi(e.then)&&wi(e.catch),setImmediate:hb,asap:rW,isIterable:e=>e!=null&&wi(e[ju])};function gt(e,t,n,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r,this.status=r.status?r.status:null)}se.inherits(gt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:se.toJSONObject(this.config),code:this.code,status:this.status}}});const fb=gt.prototype,_b={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{_b[e]={value:e}})),Object.defineProperties(gt,_b),Object.defineProperty(fb,"isAxiosError",{value:!0}),gt.from=(e,t,n,i,r,s)=>{const o=Object.create(fb);se.toFlatObject(e,o,(function(d){return d!==Error.prototype}),(d=>d!=="isAxiosError"));const a=e&&e.message?e.message:"Error",c=t==null&&e?e.code:t;return gt.call(o,a,c,n,i,r),e&&o.cause==null&&Object.defineProperty(o,"cause",{value:e,configurable:!0}),o.name=e&&e.name||"Error",s&&Object.assign(o,s),o};function M_(e){return se.isPlainObject(e)||se.isArray(e)}function Eb(e){return se.endsWith(e,"[]")?e.slice(0,-2):e}function gb(e,t,n){return e?e.concat(t).map((function(i,r){return i=Eb(i),!n&&r?"["+i+"]":i})).join(n?".":""):t}const sW=se.toFlatObject(se,{},null,(function(e){return/^is[A-Z]/.test(e)}));function Hu(e,t,n){if(!se.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const i=(n=se.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(h,p){return!se.isUndefined(p[h])}))).metaTokens,r=n.visitor||d,s=n.dots,o=n.indexes,a=(n.Blob||typeof Blob<"u"&&Blob)&&se.isSpecCompliantForm(t);if(!se.isFunction(r))throw new TypeError("visitor must be a function");function c(h){if(h===null)return"";if(se.isDate(h))return h.toISOString();if(se.isBoolean(h))return h.toString();if(!a&&se.isBlob(h))throw new gt("Blob is not supported. Use a Buffer instead.");return se.isArrayBuffer(h)||se.isTypedArray(h)?a&&typeof Blob=="function"?new Blob([h]):Buffer.from(h):h}function d(h,p,R){let T=h;if(h&&!R&&typeof h=="object"){if(se.endsWith(p,"{}"))p=i?p:p.slice(0,-2),h=JSON.stringify(h);else if(se.isArray(h)&&(function(y){return se.isArray(y)&&!y.some(M_)})(h)||(se.isFileList(h)||se.endsWith(p,"[]"))&&(T=se.toArray(h)))return p=Eb(p),T.forEach((function(y,I){!se.isUndefined(y)&&y!==null&&t.append(o===!0?gb([p],I,s):o===null?p:p+"[]",c(y))})),!1}return!!M_(h)||(t.append(gb(R,p,s),c(h)),!1)}const l=[],u=Object.assign(sW,{defaultVisitor:d,convertValue:c,isVisitable:M_});if(!se.isObject(e))throw new TypeError("data must be an object");return(function h(p,R){if(!se.isUndefined(p)){if(l.indexOf(p)!==-1)throw Error("Circular reference detected in "+R.join("."));l.push(p),se.forEach(p,(function(T,y){(!(se.isUndefined(T)||T===null)&&r.call(t,T,se.isString(y)?zn(y).call(y):y,R,u))===!0&&h(T,R?R.concat(y):[y])})),l.pop()}})(e),t}function Sb(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(n){return t[n]}))}function U_(e,t){this._pairs=[],e&&Hu(e,this,t)}const Tb=U_.prototype;function oW(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function yb(e,t,n){if(!t)return e;const i=n&&n.encode||oW;se.isFunction(n)&&(n={serialize:n});const r=n&&n.serialize;let s;if(s=r?r(t,n):se.isURLSearchParams(t)?t.toString():new U_(t,n).toString(i),s){const o=e.indexOf("#");o!==-1&&(e=e.slice(0,o)),e+=(e.indexOf("?")===-1?"?":"&")+s}return e}Tb.append=function(e,t){this._pairs.push([e,t])},Tb.toString=function(e){const t=e?function(n){return e.call(this,n,Sb)}:Sb;return this._pairs.map((function(n){return t(n[0])+"="+t(n[1])}),"").join("&")};var vb=class{constructor(){this.handlers=[]}use(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){se.forEach(this.handlers,(function(t){t!==null&&e(t)}))}},Rb={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},Cb={exports:{}},aW=lt,cW=at,bb=er.f;aW({target:"Object",stat:!0,forced:Object.defineProperty!==bb,sham:!cW},{defineProperty:bb});var Ib=bi.Object,dW=Cb.exports=function(e,t,n){return Ib.defineProperty(e,t,n)};Ib.defineProperty.sham&&(dW.sham=!0);var wb=D(Cb.exports),lW=TypeError,Ab=ad,uW=lu,hW=Yn,pW=$t("species"),Ob=Array,mW=function(e){var t;return Ab(e)&&(t=e.constructor,(uW(t)&&(t===Ob||Ab(t.prototype))||hW(t)&&(t=t[pW])===null)&&(t=void 0)),t===void 0?Ob:t},Nb=function(e,t){return new(mW(e))(t===0?0:t)},fW=U,_W=Ao,EW=$t("species"),Db=function(e){return _W>=51||!fW((function(){var t=[];return(t.constructor={})[EW]=function(){return{foo:1}},t[e](Boolean).foo!==1}))},gW=lt,SW=U,TW=ad,yW=Yn,vW=Qr,RW=Ys,Pb=function(e){if(e>9007199254740991)throw lW("Maximum allowed index exceeded");return e},Lb=Yf,CW=Nb,bW=Db,IW=Ao,kb=$t("isConcatSpreadable"),wW=IW>=51||!SW((function(){var e=[];return e[kb]=!1,e.concat()[0]!==e})),AW=function(e){if(!yW(e))return!1;var t=e[kb];return t!==void 0?!!t:TW(e)};gW({target:"Array",proto:!0,forced:!wW||!bW("concat")},{concat:function(e){var t,n,i,r,s,o=vW(this),a=CW(o,0),c=0;for(t=-1,i=arguments.length;t<i;t++)if(AW(s=t===-1?o:arguments[t]))for(r=RW(s),Pb(c+r),n=0;n<r;n++,c++)n in s&&Lb(a,c,s[n]);else Pb(c+1),Lb(a,c++,s);return a.length=c,a}});var xb={},OW=be,NW=Hs,Mb=ql.f,DW=Xs,Ub=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];xb.f=function(e){return Ub&&OW(e)==="Window"?(function(t){try{return Mb(t)}catch{return DW(Ub)}})(e):Mb(NW(e))};var tc={},PW=$t;tc.f=PW;var Vb=bi,LW=Vn,kW=tc,xW=er.f,Cn=function(e){var t=Vb.Symbol||(Vb.Symbol={});LW(t,e)||xW(t,e,{value:kW.f(e)})},MW=An,UW=ti,VW=$t,jW=qs,jb=function(){var e=UW("Symbol"),t=e&&e.prototype,n=t&&t.valueOf,i=VW("toPrimitive");t&&!t[i]&&jW(t,i,(function(r){return MW(n,this)}),{})},FW=Ks,BW=Fl,WW=Qr,GW=Ys,HW=Nb,Fb=ee([].push),KW=function(e){var t=e===1,n=e===2,i=e===3,r=e===4,s=e===6,o=e===7,a=e===5||s;return function(c,d,l,u){for(var h,p,R=WW(c),T=BW(R),y=GW(T),I=FW(d,l),A=0,N=u||HW,k=t?N(c,y):n||o?N(c,0):void 0;y>A;A++)if((a||A in T)&&(p=I(h=T[A],A,R),e))if(t)k[A]=p;else if(p)switch(e){case 3:return!0;case 5:return h;case 6:return A;case 2:Fb(k,h)}else switch(e){case 4:return!1;case 7:Fb(k,h)}return s?-1:i||r?r:k}},Bb={forEach:KW(0)},Ku=lt,Od=ae,V_=An,YW=ee,nc=at,ic=wa,zW=U,qn=Vn,qW=q,j_=Ei,Yu=Hs,F_=gm,XW=gi,B_=Ws,rc=dd,Wb=Jl,JW=ql,Gb=xb,QW=cd,Hb=Qe,Kb=er,ZW=jm,Yb=Vl,zb=qs,$W=du,W_=Oa,qb=Xl,Xb=_m,eG=$t,tG=tc,nG=Cn,iG=jb,rG=bs,Jb=Do,zu=Bb.forEach,Ai=zl("hidden"),qu="Symbol",Nd="prototype",sG=Jb.set,Qb=Jb.getterFor(qu),Ar=Object[Nd],Fo=Od.Symbol,Xu=Fo&&Fo[Nd],oG=Od.RangeError,aG=Od.TypeError,G_=Od.QObject,Zb=Hb.f,Bo=Kb.f,$b=Gb.f,cG=Yb.f,eI=YW([].push),As=W_("symbols"),Dd=W_("op-symbols"),dG=W_("wks"),H_=!G_||!G_[Nd]||!G_[Nd].findChild,tI=function(e,t,n){var i=Zb(Ar,t);i&&delete Ar[t],Bo(e,t,n),i&&e!==Ar&&Bo(Ar,t,i)},K_=nc&&zW((function(){return rc(Bo({},"a",{get:function(){return Bo(this,"a",{value:7}).a}})).a!==7}))?tI:Bo,Y_=function(e,t){var n=As[e]=rc(Xu);return sG(n,{type:qu,tag:e,description:t}),nc||(n.description=t),n},Ju=function(e,t,n){e===Ar&&Ju(Dd,t,n),j_(e);var i=F_(t);return j_(n),qn(As,i)?(n.enumerable?(qn(e,Ai)&&e[Ai][i]&&(e[Ai][i]=!1),n=rc(n,{enumerable:B_(0,!1)})):(qn(e,Ai)||Bo(e,Ai,B_(1,rc(null))),e[Ai][i]=!0),K_(e,i,n)):Bo(e,i,n)},z_=function(e,t){j_(e);var n=Yu(t),i=Wb(n).concat(sI(n));return zu(i,(function(r){nc&&!V_(nI,n,r)||Ju(e,r,n[r])})),e},nI=function(e){var t=F_(e),n=V_(cG,this,t);return!(this===Ar&&qn(As,t)&&!qn(Dd,t))&&(!(n||!qn(this,t)||!qn(As,t)||qn(this,Ai)&&this[Ai][t])||n)},iI=function(e,t){var n=Yu(e),i=F_(t);if(n!==Ar||!qn(As,i)||qn(Dd,i)){var r=Zb(n,i);return!r||!qn(As,i)||qn(n,Ai)&&n[Ai][i]||(r.enumerable=!0),r}},rI=function(e){var t=$b(Yu(e)),n=[];return zu(t,(function(i){qn(As,i)||qn(qb,i)||eI(n,i)})),n},sI=function(e){var t=e===Ar,n=$b(t?Dd:Yu(e)),i=[];return zu(n,(function(r){!qn(As,r)||t&&!qn(Ar,r)||eI(i,As[r])})),i};ic||(Fo=function(){if(qW(Xu,this))throw new aG("Symbol is not a constructor");var e=arguments.length&&arguments[0]!==void 0?XW(arguments[0]):void 0,t=Xb(e),n=function(i){var r=this===void 0?Od:this;r===Ar&&V_(n,Dd,i),qn(r,Ai)&&qn(r[Ai],t)&&(r[Ai][t]=!1);var s=B_(1,i);try{K_(r,t,s)}catch(o){if(!(o instanceof oG))throw o;tI(r,t,s)}};return nc&&H_&&K_(Ar,t,{configurable:!0,set:n}),Y_(t,e)},zb(Xu=Fo[Nd],"toString",(function(){return Qb(this).tag})),zb(Fo,"withoutSetter",(function(e){return Y_(Xb(e),e)})),Yb.f=nI,Kb.f=Ju,ZW.f=z_,Hb.f=iI,JW.f=Gb.f=rI,QW.f=sI,tG.f=function(e){return Y_(eG(e),e)},nc&&$W(Xu,"description",{configurable:!0,get:function(){return Qb(this).description}})),Ku({global:!0,wrap:!0,forced:!ic,sham:!ic},{Symbol:Fo}),zu(Wb(dG),(function(e){nG(e)})),Ku({target:qu,stat:!0,forced:!ic},{useSetter:function(){H_=!0},useSimple:function(){H_=!1}}),Ku({target:"Object",stat:!0,forced:!ic,sham:!nc},{create:function(e,t){return t===void 0?rc(e):z_(rc(e),t)},defineProperty:Ju,defineProperties:z_,getOwnPropertyDescriptor:iI}),Ku({target:"Object",stat:!0,forced:!ic},{getOwnPropertyNames:rI}),iG(),rG(Fo,qu),qb[Ai]=!0;var oI=wa&&!!Symbol.for&&!!Symbol.keyFor,lG=lt,uG=ti,hG=Vn,pG=gi,aI=Oa,mG=oI,q_=aI("string-to-symbol-registry"),fG=aI("symbol-to-string-registry");lG({target:"Symbol",stat:!0,forced:!mG},{for:function(e){var t=pG(e);if(hG(q_,t))return q_[t];var n=uG("Symbol")(t);return q_[t]=n,fG[n]=t,n}});var _G=lt,EG=Vn,gG=nd,SG=Aa,TG=oI,cI=Oa("symbol-to-string-registry");_G({target:"Symbol",stat:!0,forced:!TG},{keyFor:function(e){if(!gG(e))throw new TypeError(SG(e)+" is not a symbol");if(EG(cI,e))return cI[e]}});var dI=ad,yG=ln,lI=be,vG=gi,uI=ee([].push),RG=lt,hI=ti,pI=dt,CG=An,Pd=ee,mI=U,fI=ln,_I=nd,EI=Xs,bG=function(e){if(yG(e))return e;if(dI(e)){for(var t=e.length,n=[],i=0;i<t;i++){var r=e[i];typeof r=="string"?uI(n,r):typeof r!="number"&&lI(r)!=="Number"&&lI(r)!=="String"||uI(n,vG(r))}var s=n.length,o=!0;return function(a,c){if(o)return o=!1,c;if(dI(this))return c;for(var d=0;d<s;d++)if(n[d]===a)return c}}},IG=wa,wG=String,to=hI("JSON","stringify"),Qu=Pd(/./.exec),gI=Pd("".charAt),AG=Pd("".charCodeAt),OG=Pd("".replace),NG=Pd(1.1.toString),DG=/[\uD800-\uDFFF]/g,SI=/^[\uD800-\uDBFF]$/,TI=/^[\uDC00-\uDFFF]$/,yI=!IG||mI((function(){var e=hI("Symbol")("stringify detection");return to([e])!=="[null]"||to({a:e})!=="{}"||to(Object(e))!=="{}"})),vI=mI((function(){return to("\uDF06\uD834")!=='"\\udf06\\ud834"'||to("\uDEAD")!=='"\\udead"'})),PG=function(e,t){var n=EI(arguments),i=bG(t);if(fI(i)||e!==void 0&&!_I(e))return n[1]=function(r,s){if(fI(i)&&(s=CG(i,this,wG(r),s)),!_I(s))return s},pI(to,null,n)},LG=function(e,t,n){var i=gI(n,t-1),r=gI(n,t+1);return Qu(SI,e)&&!Qu(TI,r)||Qu(TI,e)&&!Qu(SI,i)?"\\u"+NG(AG(e,0),16):e};to&&RG({target:"JSON",stat:!0,forced:yI||vI},{stringify:function(e,t,n){var i=EI(arguments),r=pI(yI?PG:to,null,i);return vI&&typeof r=="string"?OG(r,DG,LG):r}});var RI=cd,kG=Qr;lt({target:"Object",stat:!0,forced:!wa||U((function(){RI.f(1)}))},{getOwnPropertySymbols:function(e){var t=RI.f;return t?t(kG(e)):[]}}),Cn("asyncDispose"),Cn("asyncIterator"),Cn("dispose"),Cn("hasInstance"),Cn("isConcatSpreadable"),Cn("iterator"),Cn("match"),Cn("matchAll"),Cn("replace"),Cn("search"),Cn("species"),Cn("split");var xG=jb;Cn("toPrimitive"),xG();var MG=ti,UG=bs;Cn("toStringTag"),UG(MG("Symbol"),"Symbol"),Cn("unscopables"),bs(ae.JSON,"JSON",!0);var VG=bi.Symbol,jG=$t,FG=er.f,CI=jG("metadata"),bI=Function.prototype;bI[CI]===void 0&&FG(bI,CI,{value:null}),Cn("metadata");var BG=VG,WG=ee,X_=ti("Symbol"),GG=X_.keyFor,HG=WG(X_.prototype.valueOf),II=X_.isRegisteredSymbol||function(e){try{return GG(HG(e))!==void 0}catch{return!1}};lt({target:"Symbol",stat:!0},{isRegisteredSymbol:II});for(var KG=Oa,wI=ti,YG=ee,zG=nd,qG=$t,Zu=wI("Symbol"),AI=Zu.isWellKnownSymbol,OI=wI("Object","getOwnPropertyNames"),XG=YG(Zu.prototype.valueOf),NI=KG("wks"),J_=0,DI=OI(Zu),JG=DI.length;J_<JG;J_++)try{var PI=DI[J_];zG(Zu[PI])&&qG(PI)}catch{}var LI=function(e){if(AI&&AI(e))return!0;try{for(var t=XG(e),n=0,i=OI(NI),r=i.length;n<r;n++)if(NI[i[n]]==t)return!0}catch{}return!1};lt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:LI}),Cn("customMatcher"),Cn("observable"),lt({target:"Symbol",stat:!0},{isRegistered:II}),lt({target:"Symbol",stat:!0,forced:!0},{isWellKnown:LI}),Cn("matcher"),Cn("metadataKey"),Cn("patternMatch"),Cn("replaceAll");var sc=D(BG),kI=D(tc.f("iterator"));function Ld(e){return Ld=typeof sc=="function"&&typeof kI=="symbol"?function(t){return typeof t}:function(t){return t&&typeof sc=="function"&&t.constructor===sc&&t!==sc.prototype?"symbol":typeof t},Ld(e)}var QG=D(tc.f("toPrimitive"));function ZG(e){var t=(function(n,i){if(Ld(n)!="object"||!n)return n;var r=n[QG];if(r!==void 0){var s=r.call(n,i);if(Ld(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(i==="string"?String:Number)(n)})(e,"string");return Ld(t)=="symbol"?t:t+""}function v(e,t,n){return(t=ZG(t))in e?wb(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var xI=D(CB),$G={isBrowser:!0,classes:{URLSearchParams:xI!==void 0?xI:U_,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const Q_=typeof window<"u"&&typeof document<"u",Z_=typeof navigator=="object"&&navigator||void 0,e4=Q_&&(!Z_||["ReactNative","NativeScript","NS"].indexOf(Z_.product)<0),t4=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",n4=Q_&&window.location.href||"http://localhost";function MI(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function UI(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?MI(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):MI(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}var ui=UI(UI({},Object.freeze({__proto__:null,hasBrowserEnv:Q_,hasStandardBrowserEnv:e4,hasStandardBrowserWebWorkerEnv:t4,navigator:Z_,origin:n4})),$G);function VI(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function i4(e,t){return Hu(e,new ui.classes.URLSearchParams,(function(n){for(var i=1;i<arguments.length;i++){var r=arguments[i]!=null?arguments[i]:{};i%2?VI(Object(r),!0).forEach((function(s){v(n,s,r[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):VI(Object(r)).forEach((function(s){Object.defineProperty(n,s,Object.getOwnPropertyDescriptor(r,s))}))}return n})({visitor:function(n,i,r,s){return ui.isNode&&se.isBuffer(n)?(this.append(i,n.toString("base64")),!1):s.defaultVisitor.apply(this,arguments)}},t))}var r4=Pf.charAt,jI=An,s4=Ei,o4=ln,a4=be,c4=/./.exec,d4=TypeError,l4=lt,FI=An,BI=Rn,u4=Zm,$u=au,WI=Gs,GI=jT,kd=gi,h4=Ei,p4=Yn,m4=be,f4=Am,HI=R_,_4=id,E4=U,g4=sf,S4=function(e,t,n){return t+(n?r4(e,t).length:1)},T4=function(e,t){var n=e.exec;if(o4(n)){var i=jI(n,e,t);return i!==null&&s4(i),i}if(a4(e)==="RegExp")return jI(c4,e,t);throw new d4("RegExp#exec called on incompatible receiver")},KI=Do,y4=$t("matchAll"),YI="RegExp String",zI=YI+" Iterator",v4=KI.set,R4=KI.getterFor(zI),C4=TypeError,$_=BI("".indexOf),eh=BI("".matchAll),eE=!!eh&&!E4((function(){eh("a",/./)})),b4=u4((function(e,t,n,i){v4(this,{type:zI,regexp:e,string:t,global:n,unicode:i,done:!1})}),YI,(function(){var e=R4(this);if(e.done)return $u(void 0,!0);var t=e.regexp,n=e.string,i=T4(t,n);return i===null?(e.done=!0,$u(void 0,!0)):e.global?(kd(i[0])===""&&(t.lastIndex=S4(n,GI(t.lastIndex),e.unicode)),$u(i,!1)):(e.done=!0,$u(i,!1))})),qI=function(e){var t,n,i,r=h4(this),s=kd(e),o=g4(r,RegExp),a=kd(HI(r));return t=new o(o===RegExp?r.source:r,a),n=!!~$_(a,"g"),i=!!~$_(a,"u"),t.lastIndex=GI(r.lastIndex),new b4(t,s,n,i)};l4({target:"String",proto:!0,forced:eE},{matchAll:function(e){var t,n,i,r,s=WI(this);if(p4(e)){if(f4(e)&&(t=kd(WI(HI(e))),!~$_(t,"g")))throw new C4("`.matchAll` does not allow non-global regexes");if(eE)return eh(s,e);if((i=_4(e,y4))===void 0&&m4(e)==="RegExp"&&(i=qI),i)return FI(i,e,s)}else if(eE)return eh(s,e);return n=kd(s),r=new RegExp(e,"g"),FI(qI,r,n)}});var I4=Fi("String","matchAll"),w4=q,A4=I4,tE=String.prototype,O4=function(e){var t=e.matchAll;return typeof e=="string"||e===tE||w4(tE,e)&&t===tE.matchAll?A4:t},N4=D(O4);function XI(e){function t(n,i,r,s){let o=n[s++];if(o==="__proto__")return!0;const a=Number.isFinite(+o),c=s>=n.length;return o=!o&&se.isArray(r)?r.length:o,c?(se.hasOwnProp(r,o)?r[o]=[r[o],i]:r[o]=i,!a):(r[o]&&se.isObject(r[o])||(r[o]=[]),t(n,i,r[o],s)&&se.isArray(r[o])&&(r[o]=(function(d){const l={},u=Object.keys(d);let h;const p=u.length;let R;for(h=0;h<p;h++)R=u[h],l[R]=d[R];return l})(r[o])),!a)}if(se.isFormData(e)&&se.isFunction(e.entries)){const n={};return se.forEachEntry(e,((i,r)=>{t((function(s){return N4(se).call(se,/\w+|\[(\w*)]/g,s).map((o=>o[0]==="[]"?"":o[1]||o[0]))})(i),r,n,0)})),n}return null}const nE={transitional:Rb,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const n=t.getContentType()||"",i=n.indexOf("application/json")>-1,r=se.isObject(e);if(r&&se.isHTMLForm(e)&&(e=new FormData(e)),se.isFormData(e))return i?JSON.stringify(XI(e)):e;if(se.isArrayBuffer(e)||se.isBuffer(e)||se.isStream(e)||se.isFile(e)||se.isBlob(e)||se.isReadableStream(e))return e;if(se.isArrayBufferView(e))return e.buffer;if(se.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let s;if(r){if(n.indexOf("application/x-www-form-urlencoded")>-1)return i4(e,this.formSerializer).toString();if((s=se.isFileList(e))||n.indexOf("multipart/form-data")>-1){const o=this.env&&this.env.FormData;return Hu(s?{"files[]":e}:e,o&&new o,this.formSerializer)}}return r||i?(t.setContentType("application/json",!1),(function(o,a,c){if(se.isString(o))try{return(a||JSON.parse)(o),zn(se).call(se,o)}catch(d){if(d.name!=="SyntaxError")throw d}return(c||JSON.stringify)(o)})(e)):e}],transformResponse:[function(e){const t=this.transitional||nE.transitional,n=t&&t.forcedJSONParsing,i=this.responseType==="json";if(se.isResponse(e)||se.isReadableStream(e))return e;if(e&&se.isString(e)&&(n&&!this.responseType||i)){const r=!(t&&t.silentJSONParsing)&&i;try{return JSON.parse(e,this.parseReviver)}catch(s){if(r)throw s.name==="SyntaxError"?gt.from(s,gt.ERR_BAD_RESPONSE,this,null,this.response):s}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:ui.classes.FormData,Blob:ui.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};se.forEach(["delete","get","head","post","put","patch"],(e=>{nE.headers[e]={}}));var iE=nE;const D4=se.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),JI=Symbol("internals");function xd(e){var t;return e&&zn(t=String(e)).call(t).toLowerCase()}function th(e){return e===!1||e==null?e:se.isArray(e)?e.map(th):String(e)}function rE(e,t,n,i,r){return se.isFunction(i)?i.call(this,t,n):(r&&(t=n),se.isString(t)?se.isString(i)?t.indexOf(i)!==-1:se.isRegExp(i)?i.test(t):void 0:void 0)}class nh{constructor(t){t&&this.set(t)}set(t,n,i){const r=this;function s(c,d,l){const u=xd(d);if(!u)throw new Error("header name must be a non-empty string");const h=se.findKey(r,u);(!h||r[h]===void 0||l===!0||l===void 0&&r[h]!==!1)&&(r[h||d]=th(c))}const o=(c,d)=>se.forEach(c,((l,u)=>s(l,u,d)));if(se.isPlainObject(t)||t instanceof this.constructor)o(t,n);else if(se.isString(t)&&(t=zn(t).call(t))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(zn(a=t).call(a)))o((c=>{const d={};let l,u,h;return c&&c.split(`
`).forEach((function(p){var R,T;h=p.indexOf(":"),l=zn(R=p.substring(0,h)).call(R).toLowerCase(),u=zn(T=p.substring(h+1)).call(T),!l||d[l]&&D4[l]||(l==="set-cookie"?d[l]?d[l].push(u):d[l]=[u]:d[l]=d[l]?d[l]+", "+u:u)})),d})(t),n);else if(se.isObject(t)&&se.isIterable(t)){let c,d,l={};for(const u of t){if(!se.isArray(u))throw TypeError("Object iterator must return a key-value pair");l[d=u[0]]=(c=l[d])?se.isArray(c)?[...c,u[1]]:[c,u[1]]:u[1]}o(l,n)}else t!=null&&s(n,t,i);var a;return this}get(t,n){if(t=xd(t)){const i=se.findKey(this,t);if(i){const r=this[i];if(!n)return r;if(n===!0)return(function(s){const o=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let c;for(;c=a.exec(s);)o[c[1]]=c[2];return o})(r);if(se.isFunction(n))return n.call(this,r,i);if(se.isRegExp(n))return n.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,n){if(t=xd(t)){const i=se.findKey(this,t);return!(!i||this[i]===void 0||n&&!rE(0,this[i],i,n))}return!1}delete(t,n){const i=this;let r=!1;function s(o){if(o=xd(o)){const a=se.findKey(i,o);!a||n&&!rE(0,i[a],a,n)||(delete i[a],r=!0)}}return se.isArray(t)?t.forEach(s):s(t),r}clear(t){const n=Object.keys(this);let i=n.length,r=!1;for(;i--;){const s=n[i];t&&!rE(0,this[s],s,t,!0)||(delete this[s],r=!0)}return r}normalize(t){const n=this,i={};return se.forEach(this,((r,s)=>{var o;const a=se.findKey(i,s);if(a)return n[a]=th(r),void delete n[s];const c=t?(function(d){return zn(d).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,((l,u,h)=>u.toUpperCase()+h))})(s):zn(o=String(s)).call(o);c!==s&&delete n[s],n[c]=th(r),i[c]=!0})),this}concat(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return this.constructor.concat(this,...n)}toJSON(t){const n=Object.create(null);return se.forEach(this,((i,r)=>{i!=null&&i!==!1&&(n[r]=t&&se.isArray(i)?i.join(", "):i)})),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((t=>{let[n,i]=t;return n+": "+i})).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t){const n=new this(t);for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return r.forEach((o=>n.set(o))),n}static accessor(t){const n=(this[JI]=this[JI]={accessors:{}}).accessors,i=this.prototype;function r(s){const o=xd(s);n[o]||((function(a,c){const d=se.toCamelCase(" "+c);["get","set","has"].forEach((l=>{Object.defineProperty(a,l+d,{value:function(u,h,p){return this[l].call(this,c,u,h,p)},configurable:!0})}))})(i,s),n[o]=!0)}return se.isArray(t)?t.forEach(r):r(t),this}}nh.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),se.reduceDescriptors(nh.prototype,((e,t)=>{let{value:n}=e,i=t[0].toUpperCase()+t.slice(1);return{get:()=>n,set(r){this[i]=r}}})),se.freezeMethods(nh);var Or=nh;function sE(e,t){const n=this||iE,i=t||n,r=Or.from(i.headers);let s=i.data;return se.forEach(e,(function(o){s=o.call(n,s,r.normalize(),t?t.status:void 0)})),r.normalize(),s}function QI(e){return!(!e||!e.__CANCEL__)}function oc(e,t,n){gt.call(this,e??"canceled",gt.ERR_CANCELED,t,n),this.name="CanceledError"}function ZI(e,t,n){const i=n.config.validateStatus;n.status&&i&&!i(n.status)?t(new gt("Request failed with status code "+n.status,[gt.ERR_BAD_REQUEST,gt.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):e(n)}se.inherits(oc,gt,{__CANCEL__:!0});const ih=function(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,i=0;const r=(function(s,o){s=s||10;const a=new Array(s),c=new Array(s);let d,l=0,u=0;return o=o!==void 0?o:1e3,function(h){const p=Date.now(),R=c[u];d||(d=p),a[l]=h,c[l]=p;let T=u,y=0;for(;T!==l;)y+=a[T++],T%=s;if(l=(l+1)%s,l===u&&(u=(u+1)%s),p-d<o)return;const I=R&&p-R;return I?Math.round(1e3*y/I):void 0}})(50,250);return(function(s,o){let a,c,d=0,l=1e3/o;const u=function(h){d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),a=null,c&&(clearTimeout(c),c=null),s(...h)};return[function(){const h=Date.now(),p=h-d;for(var R=arguments.length,T=new Array(R),y=0;y<R;y++)T[y]=arguments[y];p>=l?u(T,h):(a=T,c||(c=setTimeout((()=>{c=null,u(a)}),l-p)))},()=>a&&u(a)]})((s=>{const o=s.loaded,a=s.lengthComputable?s.total:void 0,c=o-i,d=r(c);i=o,e({loaded:o,total:a,progress:a?o/a:void 0,bytes:c,rate:d||void 0,estimated:d&&a&&o<=a?(a-o)/d:void 0,event:s,lengthComputable:a!=null,[t?"download":"upload"]:!0})}),n)},$I=(e,t)=>{const n=e!=null;return[i=>t[0]({lengthComputable:n,total:e,loaded:i}),t[1]]},ew=e=>function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return se.asap((()=>e(...n)))};var P4=ui.hasStandardBrowserEnv?((e,t)=>n=>(n=new Pu(n,ui.origin),e.protocol===n.protocol&&e.host===n.host&&(t||e.port===n.port)))(new Pu(ui.origin),ui.navigator&&/(msie|trident)/i.test(ui.navigator.userAgent)):()=>!0,L4=ui.hasStandardBrowserEnv?{write(e,t,n,i,r,s,o){if(typeof document>"u")return;const a=["".concat(e,"=").concat(encodeURIComponent(t))];se.isNumber(n)&&a.push("expires=".concat(new Date(n).toUTCString())),se.isString(i)&&a.push("path=".concat(i)),se.isString(r)&&a.push("domain=".concat(r)),s===!0&&a.push("secure"),se.isString(o)&&a.push("SameSite=".concat(o)),document.cookie=a.join("; ")},read(e){if(typeof document>"u")return null;const t=document.cookie.match(new RegExp("(?:^|; )"+e+"=([^;]*)"));return t?decodeURIComponent(t[1]):null},remove(e){this.write(e,"",Date.now()-864e5,"/")}}:{write(){},read:()=>null,remove(){}};function tw(e,t,n){let i=!(function(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)})(t);return e&&(i||n==0)?(function(r,s){return s?r.replace(/\/?\/$/,"")+"/"+s.replace(/^\/+/,""):r})(e,t):t}function nw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function oE(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?nw(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nw(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const iw=e=>e instanceof Or?oE({},e):e;function Wo(e,t){t=t||{};const n={};function i(d,l,u,h){return se.isPlainObject(d)&&se.isPlainObject(l)?se.merge.call({caseless:h},d,l):se.isPlainObject(l)?se.merge({},l):se.isArray(l)?l.slice():l}function r(d,l,u,h){return se.isUndefined(l)?se.isUndefined(d)?void 0:i(void 0,d,0,h):i(d,l,0,h)}function s(d,l){if(!se.isUndefined(l))return i(void 0,l)}function o(d,l){return se.isUndefined(l)?se.isUndefined(d)?void 0:i(void 0,d):i(void 0,l)}function a(d,l,u){return u in t?i(d,l):u in e?i(void 0,d):void 0}const c={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a,headers:(d,l,u)=>r(iw(d),iw(l),0,!0)};return se.forEach(Object.keys(oE(oE({},e),t)),(function(d){const l=c[d]||r,u=l(e[d],t[d],d);se.isUndefined(u)&&l!==a||(n[d]=u)})),n}var rw=e=>{const t=Wo({},e);let{data:n,withXSRFToken:i,xsrfHeaderName:r,xsrfCookieName:s,headers:o,auth:a}=t;if(t.headers=o=Or.from(o),t.url=yb(tw(t.baseURL,t.url,t.allowAbsoluteUrls),e.params,e.paramsSerializer),a&&o.set("Authorization","Basic "+btoa((a.username||"")+":"+(a.password?unescape(encodeURIComponent(a.password)):""))),se.isFormData(n)){if(ui.hasStandardBrowserEnv||ui.hasStandardBrowserWebWorkerEnv)o.setContentType(void 0);else if(se.isFunction(n.getHeaders)){const c=n.getHeaders(),d=["content-type","content-length"];Object.entries(c).forEach((l=>{let[u,h]=l;X(d).call(d,u.toLowerCase())&&o.set(u,h)}))}}if(ui.hasStandardBrowserEnv&&(i&&se.isFunction(i)&&(i=i(t)),i||i!==!1&&P4(t.url))){const c=r&&s&&L4.read(s);c&&o.set(r,c)}return t},k4=typeof XMLHttpRequest<"u"&&function(e){return new ie((function(t,n){const i=rw(e);let r=i.data;const s=Or.from(i.headers).normalize();let o,a,c,d,l,{responseType:u,onUploadProgress:h,onDownloadProgress:p}=i;function R(){d&&d(),l&&l(),i.cancelToken&&i.cancelToken.unsubscribe(o),i.signal&&i.signal.removeEventListener("abort",o)}let T=new XMLHttpRequest;function y(){if(!T)return;const A=Or.from("getAllResponseHeaders"in T&&T.getAllResponseHeaders());ZI((function(N){t(N),R()}),(function(N){n(N),R()}),{data:u&&u!=="text"&&u!=="json"?T.response:T.responseText,status:T.status,statusText:T.statusText,headers:A,config:e,request:T}),T=null}T.open(i.method.toUpperCase(),i.url,!0),T.timeout=i.timeout,"onloadend"in T?T.onloadend=y:T.onreadystatechange=function(){T&&T.readyState===4&&(T.status!==0||T.responseURL&&T.responseURL.indexOf("file:")===0)&&setTimeout(y)},T.onabort=function(){T&&(n(new gt("Request aborted",gt.ECONNABORTED,e,T)),T=null)},T.onerror=function(A){const N=new gt(A&&A.message?A.message:"Network Error",gt.ERR_NETWORK,e,T);N.event=A||null,n(N),T=null},T.ontimeout=function(){let A=i.timeout?"timeout of "+i.timeout+"ms exceeded":"timeout exceeded";const N=i.transitional||Rb;i.timeoutErrorMessage&&(A=i.timeoutErrorMessage),n(new gt(A,N.clarifyTimeoutError?gt.ETIMEDOUT:gt.ECONNABORTED,e,T)),T=null},r===void 0&&s.setContentType(null),"setRequestHeader"in T&&se.forEach(s.toJSON(),(function(A,N){T.setRequestHeader(N,A)})),se.isUndefined(i.withCredentials)||(T.withCredentials=!!i.withCredentials),u&&u!=="json"&&(T.responseType=i.responseType),p&&([c,l]=ih(p,!0),T.addEventListener("progress",c)),h&&T.upload&&([a,d]=ih(h),T.upload.addEventListener("progress",a),T.upload.addEventListener("loadend",d)),(i.cancelToken||i.signal)&&(o=A=>{T&&(n(!A||A.type?new oc(null,e,T):A),T.abort(),T=null)},i.cancelToken&&i.cancelToken.subscribe(o),i.signal&&(i.signal.aborted?o():i.signal.addEventListener("abort",o)));const I=(function(A){const N=/^([-+\w]{1,25})(:?\/\/|:)/.exec(A);return N&&N[1]||""})(i.url);I&&ui.protocols.indexOf(I)===-1?n(new gt("Unsupported protocol "+I+":",gt.ERR_BAD_REQUEST,e)):T.send(r||null)}))},x4=(e,t)=>{const{length:n}=e=e?e.filter(Boolean):[];if(t||n){let i,r=new AbortController;const s=function(d){if(!i){i=!0,a();const l=d instanceof Error?d:this.reason;r.abort(l instanceof gt?l:new oc(l instanceof Error?l.message:l))}};let o=t&&setTimeout((()=>{o=null,s(new gt("timeout ".concat(t," of ms exceeded"),gt.ETIMEDOUT))}),t);const a=()=>{e&&(o&&clearTimeout(o),o=null,e.forEach((d=>{d.unsubscribe?d.unsubscribe(s):d.removeEventListener("abort",s)})),e=null)};e.forEach((d=>d.addEventListener("abort",s)));const{signal:c}=r;return c.unsubscribe=()=>se.asap(a),c}},aE=D(Wv),sw=tc.f("asyncIterator"),M4=D(sw);function cE(e,t){this.v=e,this.k=t}function ni(e){return function(){return new Md(e.apply(this,arguments))}}function Md(e){var t,n;function i(s,o){try{var a=e[s](o),c=a.value,d=c instanceof cE;aE.resolve(d?c.v:c).then((function(l){if(d){var u=s==="return"?"return":"next";if(!c.k||l.done)return i(u,l);l=e[u](l).value}r(a.done?"return":"normal",l)}),(function(l){i("throw",l)}))}catch(l){r("throw",l)}}function r(s,o){switch(s){case"return":t.resolve({value:o,done:!0});break;case"throw":t.reject(o);break;default:t.resolve({value:o,done:!1})}(t=t.next)?i(t.key,t.arg):n=null}this._invoke=function(s,o){return new aE((function(a,c){var d={key:s,arg:o,resolve:a,reject:c,next:null};n?n=n.next=d:(t=n=d,i(s,o))}))},typeof e.return!="function"&&(this.return=void 0)}function Ve(e){return new cE(e,0)}function ac(e){var t={},n=!1;function i(r,s){return n=!0,s=new aE((function(o){o(e[r](s))})),{done:!1,value:new cE(s,1)}}return t[sc!==void 0&&kI||"@@iterator"]=function(){return this},t.next=function(r){return n?(n=!1,r):i("next",r)},typeof e.throw=="function"&&(t.throw=function(r){if(n)throw n=!1,r;return i("throw",r)}),typeof e.return=="function"&&(t.return=function(r){return n?(n=!1,r):i("return",r)}),t}Md.prototype[typeof sc=="function"&&M4||"@@asyncIterator"]=function(){return this},Md.prototype.next=function(e){return this._invoke("next",e)},Md.prototype.throw=function(e){return this._invoke("throw",e)},Md.prototype.return=function(e){return this._invoke("return",e)};var rh=D(sw);function dE(e){var t,n,i,r=2;for(typeof Symbol<"u"&&(n=rh,i=Symbol.iterator);r--;){if(n&&(t=e[n])!=null)return t.call(e);if(i&&(t=e[i])!=null)return new sh(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function sh(e){function t(n){if(Object(n)!==n)return ie.reject(new TypeError(n+" is not an object."));var i=n.done;return ie.resolve(n.value).then((function(r){return{value:r,done:i}}))}return sh=function(n){this.s=n,this.n=n.next},sh.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?ie.resolve({value:n,done:!0}):t(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?ie.reject(n):t(i.apply(this.s,arguments))}},new sh(e)}const U4=function*(e,t){let n=e.byteLength;if(!t||n<t)return void(yield e);let i,r=0;for(;r<n;)i=r+t,yield e.slice(r,i),r=i},V4=(function(){var e=ni((function*(t,n){var i,r=!1,s=!1;try{for(var o,a=dE(j4(t));r=!(o=yield Ve(a.next())).done;r=!1){const c=o.value;yield*ac(dE(U4(c,n)))}}catch(c){s=!0,i=c}finally{try{r&&a.return!=null&&(yield Ve(a.return()))}finally{if(s)throw i}}}));return function(t,n){return e.apply(this,arguments)}})(),j4=(function(){var e=ni((function*(t){if(t[rh])return void(yield*ac(dE(t)));const n=t.getReader();try{for(;;){const{done:i,value:r}=yield Ve(n.read());if(i)break;yield r}}finally{yield Ve(n.cancel())}}));return function(t){return e.apply(this,arguments)}})(),ow=(e,t,n,i)=>{const r=V4(e,t);let s,o=0,a=c=>{s||(s=!0,i&&i(c))};return new ReadableStream({async pull(c){try{const{done:d,value:l}=await r.next();if(d)return a(),void c.close();let u=l.byteLength;if(n){let h=o+=u;n(h)}c.enqueue(new Uint8Array(l))}catch(d){throw a(d),d}},cancel:c=>(a(c),r.return())},{highWaterMark:2})};function aw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function cw(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?aw(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):aw(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const{isFunction:oh}=se,F4=(e=>{let{Request:t,Response:n}=e;return{Request:t,Response:n}})(se.global),{ReadableStream:dw,TextEncoder:lw}=se.global,uw=function(e){try{for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return!!e(...n)}catch{return!1}},B4=e=>{e=se.merge.call({skipUndefined:!0},F4,e);const{fetch:t,Request:n,Response:i}=e,r=t?oh(t):typeof fetch=="function",s=oh(n),o=oh(i);if(!r)return!1;const a=r&&oh(dw),c=r&&(typeof lw=="function"?(d=new lw,R=>d.encode(R)):async R=>new Uint8Array(await new n(R).arrayBuffer()));var d;const l=s&&a&&uw((()=>{let R=!1;const T=new n(ui.origin,{body:new dw,method:"POST",get duplex(){return R=!0,"half"}}).headers.has("Content-Type");return R&&!T})),u=o&&a&&uw((()=>se.isReadableStream(new i("").body))),h={stream:u&&(R=>R.body)};r&&["text","arrayBuffer","blob","formData","stream"].forEach((R=>{!h[R]&&(h[R]=(T,y)=>{let I=T&&T[R];if(I)return I.call(T);throw new gt("Response type '".concat(R,"' is not supported"),gt.ERR_NOT_SUPPORT,y)})}));const p=async(R,T)=>{const y=se.toFiniteNumber(R.getContentLength());return y??(async I=>I==null?0:se.isBlob(I)?I.size:se.isSpecCompliantForm(I)?(await new n(ui.origin,{method:"POST",body:I}).arrayBuffer()).byteLength:se.isArrayBufferView(I)||se.isArrayBuffer(I)?I.byteLength:(se.isURLSearchParams(I)&&(I+=""),se.isString(I)?(await c(I)).byteLength:void 0))(T)};return async R=>{let{url:T,method:y,data:I,signal:A,cancelToken:N,timeout:k,onDownloadProgress:x,onUploadProgress:P,responseType:M,headers:G,withCredentials:Y="same-origin",fetchOptions:de}=rw(R),Ie=t||fetch;M=M?(M+"").toLowerCase():"text";let Ce=x4([A,N&&N.toAbortSignal()],k),Ue=null;const Pe=Ce&&Ce.unsubscribe&&(()=>{Ce.unsubscribe()});let nt;try{if(P&&l&&y!=="get"&&y!=="head"&&(nt=await p(G,I))!==0){let S,O=new n(T,{method:"POST",body:I,duplex:"half"});if(se.isFormData(I)&&(S=O.headers.get("content-type"))&&G.setContentType(S),O.body){const[L,Q]=$I(nt,ih(ew(P)));I=ow(O.body,65536,L,Q)}}se.isString(Y)||(Y=Y?"include":"omit");const Pt=s&&"credentials"in n.prototype,H=cw(cw({},de),{},{signal:Ce,method:y.toUpperCase(),headers:G.normalize().toJSON(),body:I,duplex:"half",credentials:Pt?Y:void 0});Ue=s&&new n(T,H);let $=await(s?Ie(Ue,de):Ie(T,H));const he=u&&(M==="stream"||M==="response");if(u&&(x||he&&Pe)){const S={};["status","statusText","headers"].forEach((Oe=>{S[Oe]=$[Oe]}));const O=se.toFiniteNumber($.headers.get("content-length")),[L,Q]=x&&$I(O,ih(ew(x),!0))||[];$=new i(ow($.body,65536,L,(()=>{Q&&Q(),Pe&&Pe()})),S)}M=M||"text";let K=await h[se.findKey(h,M)||"text"]($,R);return!he&&Pe&&Pe(),await new ie(((S,O)=>{ZI(S,O,{data:K,headers:Or.from($.headers),status:$.status,statusText:$.statusText,config:R,request:Ue})}))}catch(Pt){throw Pe&&Pe(),Pt&&Pt.name==="TypeError"&&/Load failed|fetch/i.test(Pt.message)?Object.assign(new gt("Network Error",gt.ERR_NETWORK,R,Ue),{cause:Pt.cause||Pt}):gt.from(Pt,Pt&&Pt.code,R,Ue)}}},W4=new Map,hw=e=>{let t=e&&e.env||{};const{fetch:n,Request:i,Response:r}=t,s=[i,r,n];let o,a,c=s.length,d=W4;for(;c--;)o=s[c],a=d.get(o),a===void 0&&d.set(o,a=c?new Map:B4(t)),d=a;return a};hw();const lE={http:null,xhr:k4,fetch:{get:hw}};se.forEach(lE,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch{}Object.defineProperty(e,"adapterName",{value:t})}}));const pw=e=>"- ".concat(e),G4=e=>se.isFunction(e)||e===null||e===!1;var mw={getAdapter:function(e,t){e=se.isArray(e)?e:[e];const{length:n}=e;let i,r;const s={};for(let o=0;o<n;o++){let a;if(i=e[o],r=i,!G4(i)&&(r=lE[(a=String(i)).toLowerCase()],r===void 0))throw new gt("Unknown adapter '".concat(a,"'"));if(r&&(se.isFunction(r)||(r=r.get(t))))break;s[a||"#"+o]=r}if(!r){const o=Object.entries(s).map((a=>{let[c,d]=a;return"adapter ".concat(c," ")+(d===!1?"is not supported by the environment":"is not available in the build")}));throw new gt("There is no suitable adapter to dispatch the request "+(n?o.length>1?`since :
`+o.map(pw).join(`
`):" "+pw(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r},adapters:lE};function uE(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new oc(null,e)}function fw(e){return uE(e),e.headers=Or.from(e.headers),e.data=sE.call(e,e.transformRequest),["post","put","patch"].indexOf(e.method)!==-1&&e.headers.setContentType("application/x-www-form-urlencoded",!1),mw.getAdapter(e.adapter||iE.adapter,e)(e).then((function(t){return uE(e),t.data=sE.call(e,e.transformResponse,t),t.headers=Or.from(t.headers),t}),(function(t){return QI(t)||(uE(e),t&&t.response&&(t.response.data=sE.call(e,e.transformResponse,t.response),t.response.headers=Or.from(t.response.headers))),ie.reject(t)}))}const _w="1.13.2",ah={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{ah[e]=function(n){return typeof n===e||"a"+(t<1?"n ":" ")+e}}));const Ew={};ah.transitional=function(e,t,n){function i(r,s){return"[Axios v"+_w+"] Transitional option '"+r+"'"+s+(n?". "+n:"")}return(r,s,o)=>{if(e===!1)throw new gt(i(s," has been removed"+(t?" in "+t:"")),gt.ERR_DEPRECATED);return t&&!Ew[s]&&(Ew[s]=!0,console.warn(i(s," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(r,s,o)}},ah.spelling=function(e){return(t,n)=>(console.warn("".concat(n," is likely a misspelling of ").concat(e)),!0)};var ch={assertOptions:function(e,t,n){if(typeof e!="object")throw new gt("options must be an object",gt.ERR_BAD_OPTION_VALUE);const i=Object.keys(e);let r=i.length;for(;r-- >0;){const s=i[r],o=t[s];if(o){const a=e[s],c=a===void 0||o(a,s,e);if(c!==!0)throw new gt("option "+s+" must be "+c,gt.ERR_BAD_OPTION_VALUE)}else if(n!==!0)throw new gt("Unknown option "+s,gt.ERR_BAD_OPTION)}},validators:ah};const ts=ch.validators;let dh=class{constructor(e){this.defaults=e||{},this.interceptors={request:new vb,response:new vb}}async request(e,t){try{return await this._request(e,t)}catch(n){if(n instanceof Error){let i={};Error.captureStackTrace?Error.captureStackTrace(i):i=new Error;const r=i.stack?i.stack.replace(/^.+\n/,""):"";try{n.stack?r&&!String(n.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+r):n.stack=r}catch{}}throw n}}_request(e,t){typeof e=="string"?(t=t||{}).url=e:t=e||{},t=Wo(this.defaults,t);const{transitional:n,paramsSerializer:i,headers:r}=t;n!==void 0&&ch.assertOptions(n,{silentJSONParsing:ts.transitional(ts.boolean),forcedJSONParsing:ts.transitional(ts.boolean),clarifyTimeoutError:ts.transitional(ts.boolean)},!1),i!=null&&(se.isFunction(i)?t.paramsSerializer={serialize:i}:ch.assertOptions(i,{encode:ts.function,serialize:ts.function},!0)),t.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),ch.assertOptions(t,{baseUrl:ts.spelling("baseURL"),withXsrfToken:ts.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let s=r&&se.merge(r.common,r[t.method]);r&&se.forEach(["delete","get","head","post","put","patch","common"],(p=>{delete r[p]})),t.headers=Or.concat(s,r);const o=[];let a=!0;this.interceptors.request.forEach((function(p){typeof p.runWhen=="function"&&p.runWhen(t)===!1||(a=a&&p.synchronous,o.unshift(p.fulfilled,p.rejected))}));const c=[];let d;this.interceptors.response.forEach((function(p){c.push(p.fulfilled,p.rejected)}));let l,u=0;if(!a){const p=[fw.bind(this),void 0];for(p.unshift(...o),p.push(...c),l=p.length,d=ie.resolve(t);u<l;)d=d.then(p[u++],p[u++]);return d}l=o.length;let h=t;for(;u<l;){const p=o[u++],R=o[u++];try{h=p(h)}catch(T){R.call(this,T);break}}try{d=fw.call(this,h)}catch(p){return ie.reject(p)}for(u=0,l=c.length;u<l;)d=d.then(c[u++],c[u++]);return d}getUri(e){return yb(tw((e=Wo(this.defaults,e)).baseURL,e.url,e.allowAbsoluteUrls),e.params,e.paramsSerializer)}};se.forEach(["delete","get","head","options"],(function(e){dh.prototype[e]=function(t,n){return this.request(Wo(n||{},{method:e,url:t,data:(n||{}).data}))}})),se.forEach(["post","put","patch"],(function(e){function t(n){return function(i,r,s){return this.request(Wo(s||{},{method:e,headers:n?{"Content-Type":"multipart/form-data"}:{},url:i,data:r}))}}dh.prototype[e]=t(),dh.prototype[e+"Form"]=t(!0)}));var lh=dh;class hE{constructor(t){if(typeof t!="function")throw new TypeError("executor must be a function.");let n;this.promise=new ie((function(r){n=r}));const i=this;this.promise.then((r=>{if(!i._listeners)return;let s=i._listeners.length;for(;s-- >0;)i._listeners[s](r);i._listeners=null})),this.promise.then=r=>{let s;const o=new ie((a=>{i.subscribe(a),s=a})).then(r);return o.cancel=function(){i.unsubscribe(s)},o},t((function(r,s,o){i.reason||(i.reason=new oc(r,s,o),n(i.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;const n=this._listeners.indexOf(t);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const t=new AbortController,n=i=>{t.abort(i)};return this.subscribe(n),t.signal.unsubscribe=()=>this.unsubscribe(n),t.signal}static source(){let t;return{token:new hE((function(i){t=i})),cancel:t}}}var H4=hE;const pE={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(pE).forEach((e=>{let[t,n]=e;pE[n]=t}));var K4=pE;const jn=(function e(t){const n=new lh(t),i=rb(lh.prototype.request,n);return se.extend(i,lh.prototype,n,{allOwnKeys:!0}),se.extend(i,n,null,{allOwnKeys:!0}),i.create=function(r){return e(Wo(t,r))},i})(iE);jn.Axios=lh,jn.CanceledError=oc,jn.CancelToken=H4,jn.isCancel=QI,jn.VERSION=_w,jn.toFormData=Hu,jn.AxiosError=gt,jn.Cancel=jn.CanceledError,jn.all=function(e){return ie.all(e)},jn.spread=function(e){return function(t){return e.apply(null,t)}},jn.isAxiosError=function(e){return se.isObject(e)&&e.isAxiosError===!0},jn.mergeConfig=Wo,jn.AxiosHeaders=Or,jn.formToJSON=e=>XI(se.isHTMLForm(e)?new FormData(e):e),jn.getAdapter=mw.getAdapter,jn.HttpStatusCode=K4,jn.default=jn;var ii=jn;const Y4=()=>{};function Ud(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:Y4};return e.promise=new ie(((t,n)=>{e.resolve=i=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(i),e.value=i)},e.reject=i=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,n(i))}})),e}const uh=new Map,hh=new Map,ns=new Map;let un=(function(e){return e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot",e})({}),tt=(function(e){return e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger",e})({});const gw=new w5;let Nr=gw.getResult(),mE=null;function Ze(e){if(!mE){Nr=gw.getResult();const t=(function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return tt.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return tt.CHROME;case"Safari":case"Mobile Safari":return tt.SAFARI;case"Edge":return tt.EDGE;case"Firefox":return tt.FIREFOX;case"QQ":case"QQBrowser":return tt.QQ;case"Opera":return tt.OPERA;case"WeChat":return tt.WECHAT;default:return a.browser.name||""}})(Nr),n=Sw(Nr),i=(function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""})(Nr),r=Nr.os.version,s=Sw(Nr,!1),o=Nr.device.type;if(!(t&&n&&i&&r))return{name:t,version:n,os:i,osVersion:r,browserVersion:s,deviceType:o};mE={name:t,version:n,os:i,osVersion:r,browserVersion:s,deviceType:o}}return mE}function Sw(e){let t,n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return t=e.engine.name==="Blink"?e.engine.version||"":e.browser.version||"",n?t.split(".")[0]:t}function ph(){return Ze().os}function Tw(){const e=Ze();return"".concat(e.os," ").concat(e.osVersion)}function mh(){const e=Ze();return!!(Nr.engine.name==="WebKit"&&e.os===un.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==tt.SAFARI||Fn()&&e.name!==tt.SAFARI)}function Os(){return Ze().name===tt.CHROME}function En(){return Ze().name===tt.SAFARI}function yw(){const e=Ze();if(e.name!==tt.SAFARI||!e.browserVersion)return!1;const t=e.browserVersion.split(".");return Number(t[0])>15||Number(t[0])===15&&Number(t[1])>=4}function vw(){return Ze().name===tt.EDGE}function It(){return Ze().name===tt.FIREFOX}function Fn(){return Ze().os===un.IOS}function Dr(e){const t=Ze();return!(t.name!==tt.CHROME||!t.osVersion)&&Number(t.version)>=e}function Rw(e){const t=Ze();return!(t.name!==tt.CHROME||!t.osVersion)&&Number(t.version)<e}function fE(e,t,n){const i=Ze();return!(i.name!==e||!i.osVersion)&&(n?Number(i.version)>=t&&Number(i.version)<=n:Number(i.version)===t)}function no(e){const t=Ze();return!(t.name!==tt.EDGE||!t.osVersion)&&Number(t.version)>=e}function _E(e){const t=Ze();return!(t.name!==tt.FIREFOX||!t.osVersion)&&Number(t.version)>=e}function Cw(e){const t=Ze();return!(t.name!==tt.SAFARI||!t.osVersion)&&Number(t.version)>=e}function bw(e,t,n){const i=Ze();if(i.os!==un.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])>t||Number(r[0])>e:t?Number(r[0])===e&&Number(r[1])>=t||Number(r[0])>e:Number(r[0])>=e}function Iw(e,t,n){const i=Ze();if(i.os!==un.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function EE(e,t,n){const i=Ze();if(i.name!==tt.SAFARI||!i.osVersion||!i.browserVersion)return!1;const r=i.browserVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function Go(e){const t=Ze();return!(t.name!==tt.OPERA||!t.osVersion)&&Number(t.version)>=e}function ww(){const e=Ze();if(e.os!==un.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function cc(){const e=Ze();if(e.os!==un.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15}function gE(){const e=Ze();if(e.os!==un.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===16}function Aw(){const e=Ze();if(e.os!==un.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function ar(){return En()&&navigator.maxTouchPoints>0}function Ow(){return Ze().name===tt.WECHAT}function Nw(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Dw(){const e=ph();return(function(){const{deviceType:t}=Ze();return t==="mobile"||t==="tablet"})()||e===un.ANDROID||e===un.IOS||e===un.HARMONY_OS}function is(){const e=Ze();return e.name!==tt.EDGE&&e.name!==tt.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Vd(){return ph()===un.ANDROID}function jd(){const e=Ze();return Vd()&&(e.name===tt.CHROME||e.name===tt.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function Ne(e,t,n){return(t=(function(i){var r=(function(s,o){if(typeof s!="object"||!s)return s;var a=s[Symbol.toPrimitive];if(a!==void 0){var c=a.call(s,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)})(i);return typeof r=="symbol"?r:r+""})(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Pw(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Z(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?Pw(Object(n),!0).forEach((function(i){Ne(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Pw(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let w=(function(e){return e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",e})({}),F=class extends Error{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(t),Ne(this,"code",void 0),Ne(this,"message",void 0),Ne(this,"data",void 0),Ne(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=n}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return e==="error"&&(t||console).error(this.toString()),e==="warning"&&(t||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}};function cr(e,t){if(typeof e!="boolean")throw new F(w.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function qt(e,t,n){if(!X(n).call(n,e))throw new F(w.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(n)))}function St(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(e<n||e>i||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!(function(r){return typeof r=="number"&&r%1==0})(e))throw new F(w.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(n,", ").concat(i,"]. integer only"))}function SE(e,t){if(typeof e!="number"){if(!(e.min||e.max||e.ideal||e.exact))throw new F(w.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));e.min!==void 0&&St(e.min,"".concat(t,".min"),0,1/0),e.max!==void 0&&St(e.max,"".concat(t,".max"),1,1/0),e.exact!==void 0&&St(e.exact,"".concat(t,".exact"),1,1/0),e.ideal!==void 0&&St(e.ideal,"".concat(t,".ideal"),1,1/0)}else St(e,t,1,1/0)}function bn(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(e==null)throw new F(w.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!Lw(e,n,i,r))throw new F(w.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(n,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function Ns(e,t){if(!Array.isArray(e))throw new F(w.INVALID_PARAMS,"".concat(t," should be an array"))}function Vt(e){return e==null}function Lw(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,i=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof e=="string"&&e.length<=n&&e.length>=t&&(!i||(function(r){if(typeof r!="string")return!1;for(let s=0;s<r.length;s+=1){const o=r.charCodeAt(s);if(o<0||o>255)return!1}return!0})(e))}function kw(e,t,n){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,n);const i=e.getUint32(t,n),r=e.getUint32(t+4,n),s=0,o=+!n;return BigInt(i*o+r*s)<<BigInt(32)|BigInt(i*s+r*o)}function xw(e,t,n,i){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,n,i);const r=Number(n>>BigInt(32)),s=Number(n&BigInt(4294967295));e.setUint32(t,r,i),e.setUint32(t+4,s,i)}var Fd=(function(e){return e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE",e})(Fd||{}),TE=(function(e){return e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",e})(TE||{});const Mw=new class{constructor(){Ne(this,"_clientSize",null),Ne(this,"getClientWidth",(()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth)),Ne(this,"getClientHeight",(()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight)),Ne(this,"getStyle",(e=>window.getComputedStyle(e,null))),Ne(this,"checkCssVisibleProperty",(e=>{var t;let n=!0;const i=this.getStyle(e),{display:r,visibility:s,opacity:o,filter:a}=i;return(r==="none"||X(t=["hidden","collapse"]).call(t,s)||Number(o)<.1)&&(n=!1),!!n&&(a&&a.split(" ").filter((c=>{var d;const l=c.split("(")[0];return X(d=["brightness","blur","opacity"]).call(d,l)})).map((c=>{const[d,l]=c.split(/\(|\)/);return[d,Number(l.match(/^[0-9\.]+/))]})).forEach((c=>{const[d,l]=c;switch(d){case"brightness":(l<.1||l>3)&&(n=!1);break;case"blur":l>3&&(n=!1);break;case"opacity":l<.1&&(n=!1)}})),n)})),Ne(this,"checkPropertyUpToAllParentNodes",((e,t)=>{let n=!0,i=!0;const r=o=>t(o);let s=e;for(;s&&i;)r(s)||(n=!1,i=!1),s=s.parentElement,s||(i=!1);return n})),Ne(this,"checkActualCssVisibleIncludeInherit",(e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty))),Ne(this,"getSizeAboutClient",(e=>{const{width:t,height:n,left:i,right:r,top:s,bottom:o}=e.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:t,height:n,left:i,right:r,top:s,bottom:o,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}})),Ne(this,"checkActualSize",(()=>{const{width:e,height:t,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(e,t,n)})),Ne(this,"elementFromPoint",((e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null)),Ne(this,"checkCoverForAPoint",((e,t,n)=>{const i=this.elementFromPoint(e,t);return i!==null&&i!==n})),Ne(this,"getPointPositionList",(()=>{const{width:e,height:t,left:n,top:i}=this._clientSize,r=e/6,s=t/6,o=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){const l=(n*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,u=(i*a+(d===0?.1:d===4?(s*d*a-1e5)/a:s*d)*a)/a;o.push({x:l,y:u})}return[...o]})),Ne(this,"checkElementCover",(e=>this.getPointPositionList().map((t=>this.checkCoverForAPoint(t.x,t.y,e))).filter((t=>!!t)).length>6)),Ne(this,"checkSizeIsVisible",((e,t,n)=>(e>50||n/e<=10)&&(t>50||n/t<=10))),Ne(this,"checkSizeOfPartInClient",(()=>{const{left:e,right:t,top:n,bottom:i,clientHeight:r,clientWidth:s,clientMin:o}=this._clientSize;let a,c,d,l;if(e<0)a=0;else{if(!(e<s))return!1;a=e}if(t<0)return!1;if(c=t<s?t:s,n<0)d=0;else{if(!(n<r))return!1;d=n}if(i<0)return!1;l=i<r?i:r;const u=c-a,h=l-d;return this.checkSizeIsVisible(u,h,o)})),Ne(this,"returnHiddenResult",(e=>(this._clientSize=null,{visible:!1,reason:e}))),Ne(this,"checkOneElementVisible",(e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(Fd.COVERED);{const t=this.checkActualSize(),n=this.checkSizeOfPartInClient();return t&&!n?this.returnHiddenResult(Fd.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Fd.SIZE)}}return this.returnHiddenResult(Fd.STYLE)}return this.returnHiddenResult(TE.UNMOUNTED)}return this.returnHiddenResult(TE.INVALID_HTML_ELEMENT)})),Ne(this,"checkElementIsMountedOnDom",(e=>this.checkPropertyUpToAllParentNodes(e,(t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))))}};function yE(e){return new TextEncoder().encode(e)}const Uw=function(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n},vE=async e=>(function(t,n){let i="";return new Uint8Array(t).forEach((r=>{i+=r.toString(n).padStart(2,"0")})),i})(await crypto.subtle.digest("SHA-256",yE(e)),16);let kt=class{constructor(){Ne(this,"_events",{}),Ne(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map((t=>t.listener)):[]}on(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];this._indexOfListener(n,t)===-1&&n.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];this._indexOfListener(n,t)===-1&&n.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;const n=this._events[e],i=this._indexOfListener(n,t);i!==-1&&n.splice(i,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const t=this._events[e].map((s=>s));for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(let s=0;s<t.length;s+=1){const o=t[s];o.once&&this.off(e,o.listener),o.listener.apply(this,i||[])}}safeEmit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];[...this._events[e]||[]].forEach((r=>{r.once&&this.off(e,r.listener);try{r.listener.apply(this,n)}catch(s){console.error("safeEmit event:".concat(e," error ").concat(s?.toString()))}}))}_indexOfListener(e,t){let n=e.length;for(;n--;)if(e[n].listener===t)return n;return-1}},Bd=null;function Vw(){if(Bd)return Bd;if(window.electron)return Bd=window.electron;if(!window.require)return null;try{return Bd=window.require("electron"),Bd}catch{return null}}let Nt=(function(e){return e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.PRELOAD="PRELOAD",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload",e.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",e.PRELOAD_MEDIA_FAILED="preloadMediaFailed",e.MISMATCH_DTLS_PARAMETERS="mismatchDtlsParameters",e.VOS_FALLBACK_CN="vosFallbackCN",e.DATACHANNEL_FAILBACK="datachannelFailback",e})({}),Tt=(function(e){return e.TRACER="tracer",e})({});function jw(e){return St(e.timeout,"config.timeout",0,1e5),St(e.timeoutFactor,"config.timeoutFactor",0,100,!1),St(e.maxRetryCount,"config.maxRetryConfig",0,1/0),St(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let z4=(function(e){return e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",e})({}),Ke=(function(e){return e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.FALLBACK="FALLBACK",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.FALLBACK_TO_HLS="FALLBACK_TO_HLS",e.UID_CONFLICT="UID_CONFLICT",e})({});function Ho(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach((t=>{if(!t.urls)throw Error()}))}catch{return!1}return!0}function Fw(e){return bn(e.turnServerURL,"turnServerURL"),bn(e.username,"username"),bn(e.password,"password"),e.udpport&&St(e.udpport,"udpport",1,99999,!0),e.forceturn&&cr(e.forceturn,"forceturn"),e.security&&cr(e.security,"security"),e.tcpport&&St(e.tcpport,"tcpport",1,99999,!0),!0}let dc=(function(e){return e[e.AUTO_SIMULCAST_STREAM=-1]="AUTO_SIMULCAST_STREAM",e[e.DISABLE_SIMULCAST_STREM=0]="DISABLE_SIMULCAST_STREM",e[e.ENABLE_SIMULCAST_STREAM=1]="ENABLE_SIMULCAST_STREAM",e})({});function RE(e){return e.level!==void 0&&qt(e.level,"level",[1,2,3]),e.delay!==void 0&&St(e.delay,"delay",0,3e3,!0),!0}let Be=(function(e){return e.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",e.AUDIO_METADATA="audio-metadata",e.AUDIO_PTS="audio-pts",e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",e.FALLBACK_TO_HLS="fallback-to-hls",e.FIRST_VIDEO_BUFFER_READY="first-video-buffer-ready",e.FIRST_VIDEO_PRE_RENDER="first-video-pre-render",e.AV1_DECODABLE_RESULT="av1-decodable-result",e})({}),CE=(function(e){return e.CONFIG="config",e.VOSERROR="vos_error",e.AP_ERROR="ap_error",e})({}),On=(function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",e})({}),Xn=(function(e){return e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e})({}),Ko=(function(e){return e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e})({});function en(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return e.getListeners(t).length===0?ie.reject(new F(w.UNEXPECTED_ERROR,"can not emit promise")):new ie(((s,o)=>{e.emit(t,...i,s,o)}))}function vt(e,t){if(e.getListeners(t).length===0)return ie.resolve();for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return en(e,t,...i)}function vi(e,t){if(e.getListeners(t).length===0)return null;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return Yo(e,t,...i)}function Yo(e,t){let n=null,i=null;for(var r=arguments.length,s=new Array(r>2?r-2:0),o=2;o<r;o++)s[o-2]=arguments[o];if(e.emit(t,...s,(a=>{n=a}),(a=>{i=a})),i!==null)throw i;if(n===null)throw new F(w.UNEXPECTED_ERROR,"handler is not sync");return n}const jt=new class extends kt{set networkState(e){this.emit(Ko.NETWORK_STATE_CHANGE,e,this._networkState),e===Xn.ONLINE?this.emit(Ko.ONLINE):e===Xn.OFFLINE&&(this.onlineWaiter=new ie((t=>{this.once(Ko.ONLINE,(()=>{this.onlineWaiter=void 0,t(Xn.ONLINE)}))})),this.emit(Ko.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===Xn.ONLINE}constructor(){super(),Ne(this,"_moduleName","network-indicator"),Ne(this,"_networkState",Xn.ONLINE),Ne(this,"onlineWaiter",void 0),window.addEventListener("online",(()=>{this.networkState=Xn.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=Xn.OFFLINE}))}},ri=[];for(let e=0;e<256;++e)ri.push((e+256).toString(16).slice(1));const Bw=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);let bE;const q4=new Uint8Array(16);function X4(){return Bw?Bw():(function(n,i,r){var s,o,a,c;const d=(s=(o=(n=n||{}).random)!==null&&o!==void 0?o:(a=(c=n).rng)===null||a===void 0?void 0:a.call(c))!==null&&s!==void 0?s:(function(){if(!bE){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");bE=crypto.getRandomValues.bind(crypto)}return bE(q4)})();if(d.length<16)throw new Error("Random bytes length must be >= 16");if(d[6]=15&d[6]|64,d[8]=63&d[8]|128,i){if((r=r||0)<0||r+16>i.length)throw new RangeError("UUID byte range ".concat(r,":").concat(r+15," is out of buffer bounds"));for(let l=0;l<16;++l)i[r+l]=d[l];return i}return(function(l){let u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(ri[l[u+0]]+ri[l[u+1]]+ri[l[u+2]]+ri[l[u+3]]+"-"+ri[l[u+4]]+ri[l[u+5]]+"-"+ri[l[u+6]]+ri[l[u+7]]+"-"+ri[l[u+8]]+ri[l[u+9]]+"-"+ri[l[u+10]]+ri[l[u+11]]+ri[l[u+12]]+ri[l[u+13]]+ri[l[u+14]]+ri[l[u+15]]).toLowerCase()})(d)})(e,t,void 0);var e,t}function fh(e,t){const n=e.indexOf(t);n!==-1&&e.splice(n,1)}function lc(e){const t=[];return e.forEach((n=>{t.indexOf(n)===-1&&t.push(n)})),t}function _h(e){ie!==void 0?ie.resolve().then(e):setTimeout(e,0)}function wt(e){return JSON.parse(JSON.stringify(e))}function zo(e){try{return wt(e)}catch{return e}}const Ww={};function io(e,t){Ww[t]||(Ww[t]=!0,e())}function qo(e){const t=window.atob(e),n=new Uint8Array(new ArrayBuffer(t.length));for(let i=0;i<t.length;i+=1)n[i]=t.charCodeAt(i);return n}function ro(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return window.btoa(t)}function Gw(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=new TextEncoder().encode(e);if(n.length>t)n=n.slice(0,t);else if(n.length<t){const i=new Uint8Array(t);i.set(n),n=i}return n}function Hw(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=Bi(t).call(t,((o,a)=>o+a.length),0),r=new Uint8Array(new ArrayBuffer(i));let s=0;return t.forEach((o=>{r.set(o,s),s+=o.length})),r}function rs(e){return window.TextEncoder?new TextEncoder().encode(e).length:e.length}function Kw(e){let t=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&e.realFormData&&(e=e.realFormData),e.forEach((n=>{t+=typeof n=="string"?rs(n):n.size})),t+138}function J4(e){const t=new F(w.TIMEOUT,"timeout");return new ie(((n,i)=>{window.setTimeout((()=>i(t)),e)}))}function hn(e){return new ie((t=>{window.setTimeout(t,e)}))}function ut(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,e).toLowerCase();return n.length===e?"".concat(t).concat(n):"".concat(t).concat(n)+ut(e-n.length,"")}function Xo(){let e,t=!1;try{var n;e=I5(n=X4()).call(n,"-","")}catch{t=!0}return!t&&e&&e.length===32||(e=ut(32,"")),e.toUpperCase()}const Wd=()=>{},Yw=new class{constructor(){Ne(this,"fnMap",new Map)}throttleByKey(e,t,n,i){for(var r=arguments.length,s=new Array(r>4?r-4:0),o=4;o<r;o++)s[o-4]=arguments[o];if(this.fnMap.has(t)){const a=this.fnMap.get(t);if(a.threshold!==n){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout((()=>{const d=this.fnMap.get(t);d&&d.fn(...d.args),this.fnMap.delete(t)}),n);this.fnMap.set(t,{fn:e,threshold:n,timer:c,args:s,skipFn:i})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(t,Z(Z({},a),{},{fn:e,args:s,skipFn:i}))}else{const a=window.setTimeout((()=>{const c=this.fnMap.get(t);c&&c.fn(...c.args),this.fnMap.delete(t)}),n);this.fnMap.set(t,{fn:e,threshold:n,timer:a,args:s,skipFn:i})}}},zw=Yw.throttleByKey.bind(Yw);function qw(e){return typeof e=="object"&&e!==null&&!(e instanceof RegExp)}function IE(e,t){if(!qw(e)||!qw(t)||Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){const n=[...e];for(let i=0;i<t.length;i++)n[i]=IE(e[i],t[i]);return n}{const n=Z({},e);for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(Object.prototype.hasOwnProperty.call(e,i)?n[i]=IE(e[i],t[i]):n[i]=t[i]);return n}}function Xw(e,t){let n=[0];if(n=new Array(t).fill(0),e===0)return n;let i=0;for(;e>0&&(n[i]=255&e,e>>=8,i++,i!==t););return n}function uc(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function wE(e,t){try{return typeof e=="object"&&typeof t=="object"&&JSON.stringify(e)===JSON.stringify(t)}catch{return!1}}function AE(e){return Bi(e).call(e,((t,n)=>t+n),0)}function Jw(e){const t="0123456789abcdef";function n(N){let k,x="";for(k=0;k<=3;k++)x+=t.charAt(N>>8*k+4&15)+t.charAt(N>>8*k&15);return x}function i(N,k){const x=(65535&N)+(65535&k);return(N>>16)+(k>>16)+(x>>16)<<16|65535&x}function r(N,k,x,P,M,G){return i((function(Y,de){return Y<<de|Y>>>32-de})(i(i(k,N),i(P,G)),M),x)}function s(N,k,x,P,M,G,Y){return r(k&x|~k&P,N,k,M,G,Y)}function o(N,k,x,P,M,G,Y){return r(k&P|x&~P,N,k,M,G,Y)}function a(N,k,x,P,M,G,Y){return r(k^x^P,N,k,M,G,Y)}function c(N,k,x,P,M,G,Y){return r(x^(k|~P),N,k,M,G,Y)}const d=(function(N){let k;const x=1+(N.length+8>>6),P=new Array(16*x);for(k=0;k<16*x;k++)P[k]=0;for(k=0;k<N.length;k++)P[k>>2]|=N.charCodeAt(k)<<k%4*8;return P[k>>2]|=128<<k%4*8,P[16*x-2]=8*N.length,P})(e);let l,u,h,p,R,T=1732584193,y=-271733879,I=-1732584194,A=271733878;for(l=0;l<d.length;l+=16)u=T,h=y,p=I,R=A,T=s(T,y,I,A,d[l+0],7,-680876936),A=s(A,T,y,I,d[l+1],12,-389564586),I=s(I,A,T,y,d[l+2],17,606105819),y=s(y,I,A,T,d[l+3],22,-1044525330),T=s(T,y,I,A,d[l+4],7,-176418897),A=s(A,T,y,I,d[l+5],12,1200080426),I=s(I,A,T,y,d[l+6],17,-1473231341),y=s(y,I,A,T,d[l+7],22,-45705983),T=s(T,y,I,A,d[l+8],7,1770035416),A=s(A,T,y,I,d[l+9],12,-1958414417),I=s(I,A,T,y,d[l+10],17,-42063),y=s(y,I,A,T,d[l+11],22,-1990404162),T=s(T,y,I,A,d[l+12],7,1804603682),A=s(A,T,y,I,d[l+13],12,-40341101),I=s(I,A,T,y,d[l+14],17,-1502002290),y=s(y,I,A,T,d[l+15],22,1236535329),T=o(T,y,I,A,d[l+1],5,-165796510),A=o(A,T,y,I,d[l+6],9,-1069501632),I=o(I,A,T,y,d[l+11],14,643717713),y=o(y,I,A,T,d[l+0],20,-373897302),T=o(T,y,I,A,d[l+5],5,-701558691),A=o(A,T,y,I,d[l+10],9,38016083),I=o(I,A,T,y,d[l+15],14,-660478335),y=o(y,I,A,T,d[l+4],20,-405537848),T=o(T,y,I,A,d[l+9],5,568446438),A=o(A,T,y,I,d[l+14],9,-1019803690),I=o(I,A,T,y,d[l+3],14,-187363961),y=o(y,I,A,T,d[l+8],20,1163531501),T=o(T,y,I,A,d[l+13],5,-1444681467),A=o(A,T,y,I,d[l+2],9,-51403784),I=o(I,A,T,y,d[l+7],14,1735328473),y=o(y,I,A,T,d[l+12],20,-1926607734),T=a(T,y,I,A,d[l+5],4,-378558),A=a(A,T,y,I,d[l+8],11,-2022574463),I=a(I,A,T,y,d[l+11],16,1839030562),y=a(y,I,A,T,d[l+14],23,-35309556),T=a(T,y,I,A,d[l+1],4,-1530992060),A=a(A,T,y,I,d[l+4],11,1272893353),I=a(I,A,T,y,d[l+7],16,-155497632),y=a(y,I,A,T,d[l+10],23,-1094730640),T=a(T,y,I,A,d[l+13],4,681279174),A=a(A,T,y,I,d[l+0],11,-358537222),I=a(I,A,T,y,d[l+3],16,-722521979),y=a(y,I,A,T,d[l+6],23,76029189),T=a(T,y,I,A,d[l+9],4,-640364487),A=a(A,T,y,I,d[l+12],11,-421815835),I=a(I,A,T,y,d[l+15],16,530742520),y=a(y,I,A,T,d[l+2],23,-995338651),T=c(T,y,I,A,d[l+0],6,-198630844),A=c(A,T,y,I,d[l+7],10,1126891415),I=c(I,A,T,y,d[l+14],15,-1416354905),y=c(y,I,A,T,d[l+5],21,-57434055),T=c(T,y,I,A,d[l+12],6,1700485571),A=c(A,T,y,I,d[l+3],10,-1894986606),I=c(I,A,T,y,d[l+10],15,-1051523),y=c(y,I,A,T,d[l+1],21,-2054922799),T=c(T,y,I,A,d[l+8],6,1873313359),A=c(A,T,y,I,d[l+15],10,-30611744),I=c(I,A,T,y,d[l+6],15,-1560198380),y=c(y,I,A,T,d[l+13],21,1309151649),T=c(T,y,I,A,d[l+4],6,-145523070),A=c(A,T,y,I,d[l+11],10,-1120210379),I=c(I,A,T,y,d[l+2],15,718787259),y=c(y,I,A,T,d[l+9],21,-343485551),T=i(T,u),y=i(y,h),I=i(I,p),A=i(A,R);return n(T)+n(y)+n(I)+n(A)}let Q4=1,Qw=console,gn=class{static setLogger(e){Qw=e}constructor(e,t){Ne(this,"id",void 0),Ne(this,"lockingPromise",ie.resolve()),Ne(this,"locks",0),Ne(this,"name",""),Ne(this,"lockId",void 0),this.lockId=Q4++,e&&(this.name=e),t&&(this.id=t),this.logger("created")}logger(e,t){const n=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),i=e==="created"?"is ".concat(e,"."):"is ".concat(e,", current queue ").concat(this.locks,". ").concat(t??"");Qw.debug("".concat(n," ").concat(i))}setId(e){this.id=e}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,this.logger("locked",e);const n=new ie((r=>{t=()=>{this.locks-=1,this.logger("unlocked",e),r()}})),i=this.lockingPromise.then((()=>t));return this.lockingPromise=this.lockingPromise.then((()=>n)),i}};function hc(e,t){return function(n,i,r){const s=r.value;if(typeof s!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const o=this[t];if(!o)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const a=await o.lock("From ".concat(e,".").concat(i));try{for(var c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];return await s.apply(this,d)}finally{a()}},r}}const Xt={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function Eh(e,t){const n=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,n)}function Pr(e,t,n,i){const r=Object.assign({},Xt,i);let s=r.timeout;const o=async()=>{await(function(d){return new ie((l=>{window.setTimeout(l,d)}))})(s),s*=r.timeoutFactor,s=Math.min(r.maxRetryTimeout,s)};let a=!1;const c=new ie((async(d,l)=>{t=t||(()=>!1),n=n||(()=>!0);for(let u=0;u<r.maxRetryCount;u+=1){if(a)return l(new F(w.OPERATION_ABORTED));try{const h=await e();if(!t(h,u)||u+1===r.maxRetryCount)return d(h);await o()}catch(h){if(!n(h,u)||u+1===r.maxRetryCount)return l(h);await o()}}}));return c.cancel=()=>a=!0,c}let gh,OE=class{constructor(e){Ne(this,"input",[]),Ne(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return this.input.length===0?0:Bi(e=this.input).call(e,((t,n)=>t+n))/this.input.length}},Sh=0,NE=0;function DE(e,t,n,i){return new ie(((r,s)=>{t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),Sh+=rs(t.data)):n&&(t.data.size?Sh+=t.data.size:t.data instanceof FormData?Sh+=Kw(t.data):Sh+=rs(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ii.request(t).then((o=>{typeof o.data=="string"?NE+=rs(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?NE+=o.data.byteLength:NE+=rs(JSON.stringify(o.data)),r(o.data)})).catch((o=>{ii.isCancel(o)?s(new F(w.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new F(w.NETWORK_TIMEOUT,o.message)):o.response?s(new F(w.NETWORK_RESPONSE_ERROR,o.response.status)):s(new F(w.NETWORK_ERROR,o.message))}))}))}async function Z4(e,t){const n=new Blob([t.data],{type:"buffer"});return await DE(e,Z(Z({},t),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}const Zw=()=>window.isSecureContext!==void 0;function dr(e){if(Array.isArray(e))return e.map((n=>n));if(!$w(e))return e;const t={};for(const n in e){const i=e[n];$w(i)||Array.isArray(i)?t[n]=dr(i):t[n]=i}return t}function $w(e){return!(typeof e!="object"||Array.isArray(e)||!e)}let PE=class{constructor(e){Ne(this,"input",[]),Ne(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}};const lr={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Gd={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],transport:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0},selectedCandidatePair:{id:"unknown",localCandidate:lr,remoteCandidate:lr},updateInterval:0},eA={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},tA={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},nA={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},iA={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0};let LE=class{constructor(e,t){Ne(this,"onFirstVideoReceived",void 0),Ne(this,"onFirstVideoDecoded",void 0),Ne(this,"onFirstAudioReceived",void 0),Ne(this,"onFirstVideoDecodedTimeout",void 0),Ne(this,"onFirstAudioDecoded",void 0),Ne(this,"onSelectedLocalCandidateChanged",void 0),Ne(this,"onSelectedRemoteCandidateChanged",void 0),Ne(this,"videoIsReady",!1),Ne(this,"videoIsReady2",{}),Ne(this,"pc",void 0),Ne(this,"options",void 0),Ne(this,"intervalTimer",void 0),Ne(this,"stats",dr(Gd)),Ne(this,"isFirstVideoReceived",{}),Ne(this,"isFirstVideoDecoded",{}),Ne(this,"isFirstAudioReceived",{}),Ne(this,"isFirstAudioDecoded",{}),Ne(this,"isFirstVideoDecodedTimeout",{}),Ne(this,"lossRateWindowStats",[]),this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new ie((e=>{e({local:Z({},lr),remote:Z({},lr)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"];let i=0,r=0,s=0,o=0;for(const a of n)e[a].forEach(((c,d)=>{if(!this.lossRateWindowStats[t-1][a][d]||!this.lossRateWindowStats[0][a][d])return;const l=this.lossRateWindowStats[t-1][a][d].packets-this.lossRateWindowStats[0][a][d].packets,u=this.lossRateWindowStats[t-1][a][d].packetsLost-this.lossRateWindowStats[0][a][d].packetsLost;a==="videoSend"||a==="audioSend"?(i+=l,s+=u):(r+=l,o+=u),Number.isNaN(l)||Number.isNaN(l)?c.packetLostRate=0:c.packetLostRate=l<=0||u<=0?0:u/(l+u)}));e.sendPacketLossRate=i<=0||s<=0?0:s/(i+s),e.recvPacketLossRate=r<=0||o<=0?0:o/(r+o)}},$4=class extends LE{constructor(){super(...arguments),Ne(this,"_stats",Gd),Ne(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=dr(Gd);const n=t.filter((r=>r.type==="ssrc"));this.processSSRCStats(n);const i=t.find((r=>r.type==="VideoBwe"));i&&this.processBandwidthStats(i),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((t=>{var n;const i=X(n=t.id).call(n,"send");switch("".concat(t.mediaType,"_").concat(i?"send":"recv")){case"video_send":{const r=dr(tA);r.codec=t.googCodecName,r.adaptionChangeReason="none",t.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),t.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(t.googAvgEncodeMs),r.inputFrame={width:Number(t.googFrameWidthInput)||Number(t.googFrameWidthSent),height:Number(t.googFrameHeightInput)||Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},r.sentFrame={width:Number(t.googFrameWidthSent),height:Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},r.firsCount=Number(t.googFirReceived),r.nacksCount=Number(t.googNacksReceived),r.plisCount=Number(t.googPlisReceived),r.frameCount=Number(t.framesEncoded),r.bytes=Number(t.bytesSent),r.packets=Number(t.packetsSent),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.rttMs=Number(t.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{const r=dr(eA),s=this.lastDecodeVideoReceiverStats.get(Number(t.ssrc));if(r.codec=t.googCodecName,r.targetDelayMs=Number(t.googTargetDelayMs),r.renderDelayMs=Number(t.googRenderDelayMs),r.currentDelayMs=Number(t.googCurrentDelayMs),r.minPlayoutDelayMs=Number(t.googMinPlayoutDelayMs),r.decodeMs=Number(t.googDecodeMs),r.maxDecodeMs=Number(t.googMaxDecodeMs),r.receivedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateReceived)},r.decodedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateDecoded)},r.decodeFrameRate=Number(t.googFrameRateDecoded),r.outputFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateOutput)},r.jitterBufferMs=Number(t.googJitterBufferMs),r.firsCount=Number(t.googFirsSent),r.nacksCount=Number(t.googNacksSent),r.plisCount=Number(t.googPlisSent),r.framesDecodeCount=Number(t.framesDecoded),r.bytes=Number(t.bytesReceived),r.packets=Number(t.packetsReceived),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),s){const o=s.stats,a=Date.now()-s.lts;r.framesDecodeFreezeTime=o.framesDecodeFreezeTime,r.framesDecodeInterval=o.framesDecodeInterval,r.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(s.lts=Date.now(),r.framesDecodeInterval=a,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):r.framesDecodeCount<s.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:Z({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{const r=dr(iA);r.codec=t.googCodecName,r.outputLevel=Math.abs(Number(t.audioOutputLevel))/32767,r.decodingCNG=Number(t.googDecodingCNG),r.decodingCTN=Number(t.googDecodingCTN),r.decodingCTSG=Number(t.googDecodingCTSG),r.decodingNormal=Number(t.googDecodingNormal),r.decodingPLC=Number(t.googDecodingPLC),r.decodingPLCCNG=Number(t.googDecodingPLCCNG),r.expandRate=Number(t.googExpandRate),r.accelerateRate=Number(t.googAccelerateRate),r.preemptiveExpandRate=Number(t.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(t.googSecondaryDecodedRate),r.speechExpandRate=Number(t.googSpeechExpandRate),r.preferredJitterBufferMs=Number(t.googPreferredJitterBufferMs),r.jitterBufferMs=Number(t.googJitterBufferMs),r.jitterMs=Number(t.googJitterReceived),r.bytes=Number(t.bytesReceived),r.packets=Number(t.packetsReceived),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.receivedFrames=Number(t.googDecodingCTN)||Number(t.packetsReceived),r.droppedFrames=Number(t.googDecodingPLC)+Number(t.googDecodingPLCCNG)||Number(t.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{const r=dr(nA);r.codec=t.googCodecName,r.inputLevel=Math.abs(Number(t.audioInputLevel))/32767,r.aecReturnLoss=Number(t.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(t.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(t.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(t.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(t.bytesSent),r.packets=Number(t.packetsSent),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.rttMs=Number(t.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}}))}_getStats(){return new ie(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((n=>{const i={id:n.id,timestamp:n.timestamp.valueOf().toString(),type:n.type};n.names().forEach((r=>{i[r]=n.stat(r)})),t.push(i)})),t}},pc=(function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e})({}),Th=(function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L1T3_KEY="L1T3_KEY",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e})({}),kE=(function(e){return e[e.new=0]="new",e[e.connecting=1]="connecting",e[e.connected=2]="connected",e[e.disconnected=3]="disconnected",e[e.failed=4]="failed",e[e.closed=5]="closed",e})({}),Oi=(function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e})({});var mc=(function(e){return e[e.kNone=1]="kNone",e[e.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",e[e.kBytesToBits=8]="kBytesToBits",e})(mc||{});function Hd(e,t,n,i){let r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:mc.kNone;if(!t)return;const s=Number(t[n]);if(typeof s!="number")return;const o=Number(t[i]);if(typeof o!="number")return;if(!e)return o?s/o*r:void 0;const a=Number(e[n]);if(typeof a!="number")return;const c=Number(e[i]);if(typeof c!="number")return;const d=o-c;return d?(s-a)/d*r:void 0}let rA=class extends LE{constructor(){super(...arguments),Ne(this,"_stats",Gd),Ne(this,"report",void 0),Ne(this,"lastDecodeVideoReceiverStats",new Map),Ne(this,"lastVideoFramesRecv",new Map),Ne(this,"lastVideoFramesSent",new Map),Ne(this,"lastVideoFramesDecode",new Map),Ne(this,"lastVideoFramesOutput",new Map),Ne(this,"lastVideoJBDelay",new Map),Ne(this,"lastAudioJBDelay",new Map),Ne(this,"mediaBytesSent",new Map),Ne(this,"mediaBytesRetransmit",new Map),Ne(this,"mediaBytesTargetEncode",new Map),Ne(this,"lastDecodeAudioReceiverStats",new Map),Ne(this,"lastAudioConcealment",new Map),Ne(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=dr(Gd),this.report.forEach((e=>{switch(e.type){case Oi.OUTBOUND:case Oi.INBOUND:{const t=e.mediaType||e.kind,n=!t&&"frameWidth"in e,i=!t&&!("frameWidth"in e);e.type===Oi.OUTBOUND?t==="audio"||i?this.processAudioOutboundStats(e):(t==="video"||n)&&this.processVideoOutboundStats(e):e.type===Oi.INBOUND&&(t==="audio"||i?this.processAudioInboundStats(e):(t==="video"||n)&&this.processVideoInboundStats(e));break}case Oi.TRANSPORT:{this.processTransportStats(e);const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case Oi.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:Z({},lr),remote:Z({},lr)};return e.forEach((n=>{let i;if(n.type===Oi.TRANSPORT&&(i=e.get(n.selectedCandidatePairId)),n.type===Oi.CANDIDATE_PAIR&&n.selected&&(i=n),i){const r=(s,o)=>{s.type=o.type,s.id=o.id,o.address&&(s.address=o.address),o.candidateType&&(s.candidateType=o.candidateType),o.port&&(s.port=o.port),o.priority&&(s.priority=o.priority),o.protocol&&(s.protocol=o.protocol),o.relayProtocol&&(s.relayProtocol=o.relayProtocol)};if(i.localCandidateId){const s=e.get(i.localCandidateId);s&&r(t.local,s)}if(i.remoteCandidateId){const s=e.get(i.remoteCandidateId);s&&r(t.remote,s)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===Oi.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===Oi.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===Oi.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(Z({},t),Z({},this.stats.selectedCandidatePair.localCandidate)),e.type===Oi.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(Z({},t),Z({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((i=>i.ssrc===e.ssrc));t||(t=dr(iA),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.packetsDiscarded=e.packetsDiscarded,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.totalProcessingDelay=e.totalProcessingDelay,t.jitterBufferEmittedCount=e.jitterBufferEmittedCount,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const n=this.lastDecodeAudioReceiverStats.get(t.ssrc);t.avgProcessingDelayMs=Hd(n,t,"totalProcessingDelay","jitterBufferEmittedCount",mc.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(e,e.trackId,t),this.calculateAudioFreeze(t,n,e),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),typeof e.concealedSamples=="number"&&(t.concealedSamples=e.concealedSamples),this.lastDecodeAudioReceiverStats.set(t.ssrc,Z({},t))}calculateAudioFreeze(e,t,n){const i=this.lastAudioConcealment.get(e.ssrc);if(t!=null&&i!=null){const r=i.lts,s=n.timestamp,o=s-r;if(o<=0)return;const a=e.concealedSamples-t.concealedSamples-0,c=i.nonSilent+a,d=e.totalSamplesReceived-t.totalSamplesReceived;if(d<=0)return;const l=80*d/o,u=200*d/o,h=o/d;let p=0;e.freezeSamples80=t.freezeSamples80,e.freezeMs80=t.freezeMs80,c>l&&(i.plc80>0?(e.freezeSamples80+=a,e.freezeMs80+=Math.round(a*h)):(e.freezeSamples80+=c,e.freezeMs80+=Math.round(c*h)),p=i.plc80+1);let R=0;e.freezeSamples200=t.freezeSamples200,e.freezeMs200=t.freezeMs200,c>u&&(i.plc200>0?(e.freezeSamples200+=a,e.freezeMs200+=Math.round(a*h)):(e.freezeSamples200+=c,e.freezeMs200+=Math.round(c*h)),R=i.plc200+1),this.lastAudioConcealment.set(e.ssrc,{nonSilent:a,lts:s,plc80:p,plc200:R})}else e.freezeSamples80=0,e.freezeSamples200=0,e.freezeMs80=0,e.freezeMs200=0,this.lastAudioConcealment.set(e.ssrc,{nonSilent:0,lts:n.timestamp,plc80:0,plc200:0})}processVideoInboundStats(e){let t=this._stats.videoRecv.find((o=>o.ssrc===e.ssrc));t||(t=dr(eA),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.framesDroppedCount=e.framesDropped,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,t.totalFreezesDuration=e.totalFreezesDuration,t.totalProcessingDelay=e.totalProcessingDelay,t.packetsDiscarded=e.packetsDiscarded,t.framesAssembledFromMultiplePackets=e.framesAssembledFromMultiplePackets,t.totalAssemblyTime=e.totalAssemblyTime,t.keyFramesDecoded=e.keyFramesDecoded,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const n=this.lastDecodeVideoReceiverStats.get(t.ssrc),i=this.lastVideoFramesDecode.get(t.ssrc),r=this.lastVideoFramesOutput.get(t.ssrc),s=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const o=t.decodedFrame?t.decodedFrame.width:0,a=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,o,a),this.isFirstVideoDecoded[t.ssrc]=!0}if(n){const o=n.stats,a=s-n.lts;t.framesDecodeFreezeTime=o.framesDecodeFreezeTime,t.framesDecodeInterval=o.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(n.lts=Date.now(),t.framesDecodeInterval=a,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<o.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(n.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-n.qpSum)/(e.framesDecoded-n.stats.framesDecodeCount))}e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime,t.avgDecodeMs=Hd(n?.stats,t,"decodeMs","framesDecodeCount")),t.avgProcessingDelayMs=Hd(n?.stats,t,"totalProcessingDelay","framesDecodeCount",mc.kMillisecondsFromSeconds),t.avgFramesAssembledFromMultiplePacketsMs=Hd(n?.stats,t,"totalAssemblyTime","framesAssembledFromMultiplePackets",mc.kMillisecondsFromSeconds),t.avgInterFrameDelayMs=Hd(n?.stats,t,"totalInterFrameDelay","framesDecodeCount",mc.kMillisecondsFromSeconds),i&&s-i.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-i.count)/((s-i.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:t.decodeFrameRate})):i?t.decodeFrameRate=i.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:0}),t.framesDroppedCount&&e.framesReceived&&(r&&s-r.lts>=800?(t.outputFrameRate=Math.round((e.framesReceived-t.framesDroppedCount-r.count)/((s-r.lts)/1e3)),this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:s,rate:Math.max(t.outputFrameRate,0)})):r?t.outputFrameRate=r.rate:this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:s,rate:0})),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:Z({},t),lts:n?n.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((i=>i.ssrc===e.ssrc));t||(t=dr(tA),this._stats.videoSend.push(t));const n=this.mediaBytesSent.get(e.ssrc);if(n)n.add(e.bytesSent);else{const i=new PE(10);i.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,i)}if(e.retransmittedBytesSent!==void 0){const i=this.mediaBytesRetransmit.get(e.ssrc);if(i)i.add(e.retransmittedBytesSent);else{const r=new PE(10);r.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,r)}}if(e.totalEncodedBytesTarget){const i=this.mediaBytesTargetEncode.get(e.ssrc);if(i)i.add(e.totalEncodedBytesTarget);else{const r=new PE(10);r.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,r)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,t.hugeFramesSent=e.hugeFramesSent,t.keyFramesEncoded=e.keyFramesEncoded,t.targetBitrate=e.targetBitrate,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);if(!i||i.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const r=e.framesEncoded-i.lastFrameCount,s=e.totalEncodeTime-i.lastEncoderTime;t.avgEncodeMs=1e3*s/r}}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);!i||i.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,Oi.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((n=>n.ssrc===e.ssrc));if(t||(t=dr(nA),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const n=this.findRemoteStatsId(e.ssrc,Oi.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,t)}}processTransportStats(e){this._stats.transport.bytesReceived=e.bytesReceived||this._stats.transport.bytesReceived,this._stats.transport.bytesSent=e.bytesSent||this._stats.transport.bytesSent,this._stats.transport.packetsReceived=e.packetsReceived||this._stats.transport.packetsReceived,this._stats.transport.packetsSent=e.packetsSent||this._stats.transport.packetsSent}findRemoteStatsId(e,t){var n;const i=Array.from(Si(n=this.report).call(n)).find((r=>r.type===t&&r.ssrc===e));return i?i.id:null}processVideoMediaSource(e,t){const n=this.report.get(e);n&&n.width&&n.height&&n.framesPerSecond&&(t.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(e,t){const n=this.report.get(e);n&&(t.inputLevel=n.audioLevel)}processVideoTrackSenderStats(e,t,n){var i,r,s,o;const a=t?this.report.get(t):void 0,c=(i=a?.framesSent)!==null&&i!==void 0?i:e.framesSent;if(typeof c!="number")return;let d=(r=a?.frameWidth)!==null&&r!==void 0?r:e.frameWidth,l=(s=a?.frameHeight)!==null&&s!==void 0?s:e.frameHeight,u=(o=a?.framesPerSecond)!==null&&o!==void 0?o:e.framesPerSecond;if(typeof d=="number"&&typeof l=="number"||(d=0,l=0),u==null){const h=Date.now(),p=this.lastVideoFramesSent.get(n.ssrc);p&&h-p.lts>=800?(u=Math.round((c-p.count)/((h-p.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:h,rate:u})):p?u=p.rate:this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:h,rate:0})}n.sentFrame={width:d,height:l,frameRate:Math.max(0,u)}}processVideoTrackReceiverStats(e,t,n){var i,r,s,o,a;const c=t?this.report.get(t):void 0,d=(i=c?.framesReceived)!==null&&i!==void 0?i:e.framesReceived,l=(r=c?.frameWidth)!==null&&r!==void 0?r:e.frameWidth,u=(s=c?.frameHeight)!==null&&s!==void 0?s:e.frameHeight,h=(o=c?.jitterBufferDelay)!==null&&o!==void 0?o:e.jitterBufferDelay,p=(a=c?.jitterBufferEmittedCount)!==null&&a!==void 0?a:e.jitterBufferEmittedCount;if(typeof d=="number"){const R=this.lastVideoFramesRecv.get(n.ssrc),T=Date.now();n.framesReceivedCount=d;let y=0;R&&T-R.lts>=800?(y=Math.round((d-R.count)/((T-R.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:d,lts:T,rate:y})):R?y=R.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:d,lts:T,rate:0}),n.receivedFrame={width:l||0,height:u||0,frameRate:y||0},n.decodedFrame={width:l||0,height:u||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:l||0,height:u||0,frameRate:n.outputFrameRate||n.decodeFrameRate||0}}if(h&&p){const R=this.lastVideoJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let T=R.jitterBufferMs;const y=p-R.jitterBufferEmittedCount;y>0&&(T=1e3*(h-R.jitterBufferDelay)/y),n.jitterBufferMs=T,n.currentDelayMs=Math.round(T),this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:h,jitterBufferEmittedCount:p,jitterBufferMs:n.currentDelayMs})}}processAudioTrackSenderStats(e,t,n){var i,r,s,o;const a=t?this.report.get(t):void 0,c=(i=(r=a?.echoReturnLoss)!==null&&r!==void 0?r:e.echoReturnLoss)!==null&&i!==void 0?i:0,d=(s=(o=a?.echoReturnLossEnhancement)!==null&&o!==void 0?o:e.echoReturnLossEnhancement)!==null&&s!==void 0?s:0;n.aecReturnLoss=c,n.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(e,t,n){var i,r,s,o,a,c,d,l,u;const h=t?this.report.get(t):void 0,p=(i=h?.removedSamplesForAcceleration)!==null&&i!==void 0?i:e.removedSamplesForAcceleration,R=(r=h?.totalSamplesReceived)!==null&&r!==void 0?r:e.totalSamplesReceived,T=(s=h?.jitterBufferDelay)!==null&&s!==void 0?s:e.jitterBufferDelay,y=(o=h?.jitterBufferEmittedCount)!==null&&o!==void 0?o:e.jitterBufferEmittedCount,I=(a=h?.audioLevel)!==null&&a!==void 0?a:e?.audioLevel,A=(c=h?.totalSamplesDuration)!==null&&c!==void 0?c:e?.totalSamplesDuration,N=(d=h?.concealedSamples)!==null&&d!==void 0?d:e.concealedSamples,k=(l=h?.silentConcealedSamples)!==null&&l!==void 0?l:e.silentConcealedSamples,x=(u=h?.concealmentEvents)!==null&&u!==void 0?u:e.concealmentEvents;if(typeof R=="number"&&(n.totalSamplesReceived=R),typeof k=="number"&&(n.silentConcealedSamples=k),typeof x=="number"&&(n.concealmentEvents=x),typeof N=="number"&&(n.concealedSamples=N),p&&R&&(n.accelerateRate=p/R),T&&y){const M=this.lastAudioJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let G=M.jitterBufferMs;const Y=y-M.jitterBufferEmittedCount;Y>0&&(G=1e3*(T-M.jitterBufferDelay)/Y),n.jitterBufferMs=Math.round(G),this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:T,jitterBufferEmittedCount:y,jitterBufferMs:n.jitterBufferMs})}n.outputLevel=I;let P=1920;A&&R&&(P=R/A/50,n.receivedFrames=Math.round(R/P)),N&&(n.droppedFrames=Math.round(N/P))}processRemoteInboundStats(e,t){const n=this.report.get(e);n&&(t.packetsLost=n.packetsLost,n.roundTripTime&&(t.rttMs=1e3*n.roundTripTime),n.jitter&&(t.jitterMs=1e3*n.jitter),n.timestamp&&(t.timestamp=n.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const n=t.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let e=0,t=null,n=null;this.mediaBytesSent.forEach((r=>{e+=r.diffMean()})),this.mediaBytesRetransmit.forEach((r=>{t=t===null?r.diffMean():t+r.diffMean()})),this.mediaBytesTargetEncode.forEach((r=>{n=n===null?r.diffMean():n+r.diffMean()}));const i=t!==null?e-t:e;this._stats.bitrate={actualEncoded:8*i/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},t!==null&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),n!==null&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}},e6=class extends LE{updateStats(){return ie.resolve()}};function yh(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const s=(function(){const o=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return o&&o[0]?Number(o[0].split("/")[1]):null})();return s?s<76?new $4(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new rA(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):(function(o){if(!window.RTCStatsReport)return!1;const a=o.getStats();return!!(a instanceof ie||(function(c){return!!c&&(typeof c=="object"||typeof c=="function")&&typeof c.then=="function"})(a))})(e)?new rA(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new e6(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r})}const sA="websdk_ng_install_id";function xE(){try{if(b("INSTALL_ID"))return b("INSTALL_ID");let e=window.localStorage.getItem(sA);return e||(e=Xo(),window.localStorage.setItem(sA,e)),_t("INSTALL_ID",e),e}catch{return}}const Gi=(function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(t&&t[1]&&t[2]){const n=t[1],i=t[2];return"".concat(n,".").concat(i)}return"4.0.0.999"})("4.24.2"),ME=(function(){try{return JSON.parse("true")===!0}catch{return!0}})();let Jo=(function(e){return e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn",e})({});const Nn=(function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const i=n.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const s=r.join(""),o={};return o[e]=i,o[t]=s,Object.assign(o,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})})();window.DEFAULT_TURN_CONFIG=Nn;const vh={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!0,FORCE_ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:1,ENABLE_AUT_FEEDBACK:!0,SVC_EXTENDED:["VP9"]},UE={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},VE="v4.24.2-0-g002485b1-dirty(12/12/2025, 5:26:54 PM)",jE={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",TURN_DOMAINS:["edge.agora.io"],USE_TURN_IP:!0,NEW_TURN_MODE:4,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1,FLS_FALLBACK_TIMEOUT:3e4,RTE_DETAIL_REPORT_INTERVAL:6e4,ENCODE_EXCEPTION_TIMES:5,ENABLE_ENCODE_EXCEPTION:!0,ENCODE_EXCEPTION_VALIDATE_CODEC:["h264"],VIDEO_ENCODER_CONFIG_LIST:[{width:240,height:180},{width:320,height:240},{width:400,height:300},{width:480,height:360},{width:560,height:420},{width:640,height:480}],DELETE_NEQ_AFTER_USER_LEAVE:!0,UPDATE_RTP_CAP_IN_HOST:!1,IOS_BG_TAG:!0,IOS_AUTO_RESTART_BG_TAG:!0,IGNORE_UID_CHECK:!1,ENABLE_UP_SPS_PPS:!1,ENABLE_DOWN_SPS_PPS:!1,NO_EDGES_RETRY:!0,BUFFER_READY_FRAMES:3,FLS_SYNC_AV_PLAY_LIMIT:0,FLS_BUFFER_WAIT_TIME:1500,VOS_CONFIGURE:void 0,ENABLE_QUALITY_FALLBACK:!1,QUALITY_FALLBACK_REHEARSAL:!0,ENABLE_FLS_AV1_FIRST:!1,ENABLE_AP_MULTI_IP:!0,FLS_ENABLE_AV1_DETECT:!0,FLS_ENABLE_AV1_DECODE_DETECT:!0},ht=Z(Z(Z(Z({},jE),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_MANAGER_WSS:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_WSS:"",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ENABLE_ABSSENDTIME_AS_SENTTS:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,DC_JOIN_WITH_FAILBACK:4e3,DC_CONNECTION_TIMEOUT:2e3,DC_PINGPONG_INTERVAL:2e3,DC_DEBUG_LOG:!1,UNSUPPORTED_VIDEO_UPLINK_CODEC:[],UNSUPPORTED_VIDEO_DOWNLINK_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:UE,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},vh),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,REMOTE_VIDEO_STREAM_TYPE:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1,ENABLE_FORCE_HLS:!1,MAX_WEBAUDIO_VOLUME:300,ENABLE_VOS_FALLBACK:!1,ENABLE_FALLBACK_TO_HLS:!1,ENABLE_PRE_RENDER:!1,FORCE_DISABLE_AUTO_SUB:!1,ENABLE_PRE_SUB_WITH_PRE_PC:!0,PRE_USE_LOCAL_CODECS:!0},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:2,BASELINE_MORE_H264_BITRATE_RATIO:1.1,IGNORE_RTC_DEVICE_CHECK:!1,FLS_AUTOPLAY_EMITS:!1,ENABLE_DUAL_STREAM_FLAG:!1,FORBID_MODIFY_LOCAL_OFFER_SDP:!1,RESERVE_MID_1_MLINE:!1});function _t(e,t,n){var i,r,s;X(i=Object.keys(ht)).call(i,e)&&(!n&&X(r=Object.keys(Ni)).call(r,e)||(ht[e]=t,e!=="ENABLE_VIDEO_SEI"&&e!=="ENABLE_AUDIO_TOPN"&&e!=="ENABLE_AUDIO_METADATA"&&e!=="ENABLE_AUDIO_PTS"||t!==!0||(ht.ENABLE_ENCODED_TRANSFORM=!0),e==="USE_NEW_NETWORK_CONFIG"&&t&&(s=!!t,ht.USE_NEW_NETWORK_CONFIG=s,s&&(ht.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],ht.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],ht.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ht.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],ht.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",ht.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",ht.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),e==="ENABLE_PRE_SUB"&&t&&(ht.ENABLE_INSTANT_VIDEO=!0,ht.ENABLE_PREALLOC_PC=!0),e==="ENABLE_SVC"&&t&&(ht.ENABLE_AUT_CC=!0),e==="NEW_FORCE_TURN"&&t&&(ht.NEW_TURN_MODE||(ht.NEW_TURN_MODE=4))))}function b(e){if(e==="TURN_DOMAINS"){const t=ht.TURN_DOMAINS;return X(t).call(t,b("TURN_DOMAIN"))?t:[b("TURN_DOMAIN")].concat(t)}return ht[e]}ME||(ht.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],ht.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],ht.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],ht.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ht.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],ht.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],ht.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",ht.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",ht.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",ht.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",ht.AREAS=["NORTH_AMERICA","OVERSEA"]);let oA=(function(e){return e[e.REALTIME=1]="REALTIME",e})({});const Ni={};var we=(function(e){return e.SET_SESSION_ID="SET_SESSION_ID",e.SET_RTE_URL="SET_RTE_URL",e.SET_RTE_SID="SET_RTE_SID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.KEY_METRIC_PRELOAD_START="KEY_METRIC_PRELOAD_START",e.KEY_METRIC_PRELOAD_END="KEY_METRIC_PRELOAD_END",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_REQUEST_SUA_END="KEY_METRIC_REQUEST_SUA_END",e.KEY_METRIC_BEFORE_CONNECT="KEY_METRIC_BEFORE_CONNECT",e.KEY_METRIC_PEER_RECEIVER="KEY_METRIC_PEER_RECEIVER",e.KEY_METRIC_SIGNAL_CONNECTED="KEY_METRIC_SIGNAL_CONNECTED",e.KEY_METRIC_JOIN_REQ="KEY_METRIC_JOIN_REQ",e.KEY_METRIC_JOIN_REP="KEY_METRIC_JOIN_REP",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED="KEY_METRIC_FIRST_VIDEO_FRAME_DECODED",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.RESET_FIRST_VIDEO_FRAME_DECODED="RESET_FIRST_VIDEO_FRAME_DECODED",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",e})(we||{});let Qo=(function(e){return e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1",e})({});(function(e){e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722"})({});const aA=128,t6=96,cA=1e3,fc=10;let n6=0;var dA=(()=>{var e={8:(i,r,s)=>{s.r(r),s.d(r,{Parser:()=>Y,Printer:()=>Pe,parse:()=>$,print:()=>he});const o=`
`,a="".concat("\r").concat(o),c=" ";let d;function l(K){return K>="0"&&K<="9"}function u(K){return K>="!"&&K<="~"}function h(K){return u(K)||K>=""&&K<=""}function p(K){return K==="!"||K>="#"&&K<="'"||K>="*"&&K<="+"||K>="-"&&K<="."||K>="0"&&K<="9"||K>="A"&&K<="Z"||K>="^"&&K<="~"}function R(K){return K>="1"&&K<="9"}function T(K){return K>="A"&&K<="Z"||K>="a"&&K<="z"}function y(K){return K==="d"||K==="h"||K==="m"||K==="s"}function I(K){return K>""&&K<"	"||K>"\v"&&K<"\f"||K>""&&K<""}function A(K){return T(K)||l(K)||K==="+"||K==="/"}function N(K){return l(K)||T(K)||K==="+"||K==="/"||K==="-"||K==="_"}function k(K){return T(K)||l(K)||K==="+"||K==="/"}function x(K,S){var O=Object.keys(K);if(Object.getOwnPropertySymbols){var L=Object.getOwnPropertySymbols(K);S&&(L=L.filter((function(Q){return Object.getOwnPropertyDescriptor(K,Q).enumerable}))),O.push.apply(O,L)}return O}function P(K){for(var S=1;S<arguments.length;S++){var O=arguments[S]!=null?arguments[S]:{};S%2?x(Object(O),!0).forEach((function(L){M(K,L,O[L])})):Object.getOwnPropertyDescriptors?Object.defineProperties(K,Object.getOwnPropertyDescriptors(O)):x(Object(O)).forEach((function(L){Object.defineProperty(K,L,Object.getOwnPropertyDescriptor(O,L))}))}return K}function M(K,S,O){return S in K?Object.defineProperty(K,S,{value:O,enumerable:!0,configurable:!0,writable:!0}):K[S]=O,K}(function(K){K.VERSION="v",K.ORIGIN="o",K.SESSION_NAME="s",K.INFORMATION="i",K.URI="u",K.EMAIL="e",K.PHONE="p",K.CONNECTION="c",K.BANDWIDTH="b",K.TIME="t",K.REPEAT="r",K.ZONE_ADJUSTMENTS="z",K.KEY="k",K.ATTRIBUTE="a",K.MEDIA="m"})(d||(d={}));class G{consumeText(S,O){let L=O;for(;L<S.length;){const Q=S[L];if(Q==="\0"||Q==="\r"||Q===o)break;L+=1}if(L-O==0)throw new Error("Invalid text, at ".concat(S));return L}consumeUnicastAddress(S,O,L){return this.consumeTill(S,O,c)}consumeOneOrMore(S,O,L){let Q=O;for(;L(S[Q]);)Q++;if(Q-O==0)throw new Error("Invalid rule at ".concat(O,"."));return Q}consumeSpace(S,O){if(S[O]===c)return O+1;throw new Error("Invalid space at ".concat(O,"."))}consumeIP4Address(S,O){let L=O;for(let Q=0;Q<4;Q++)if(L=this.consumeDecimalUChar(S,L),Q!==3){if(S[L]!==".")throw new Error("Invalid IP4 address.");L++}return L}consumeDecimalUChar(S,O){let L=O;for(let Oe=0;Oe<3&&l(S[L]);Oe++,L++);if(L-O==0)throw new Error("Invalid decimal uchar.");const Q=parseInt(S.slice(O,L));if(Q>=0&&Q<=255)return L;throw new Error("Invalid decimal uchar")}consumeIP6Address(S,O){let L=this.consumeHexpart(S,O);return S[L]===":"&&(L+=1,L=this.consumeIP4Address(S,L)),L}consumeHexpart(S,O){let L=O;if(S[L]===":"&&S[L+1]===":"){L+=2;try{L=this.consumeHexseq(S,L)}catch{}return L}if(L=this.consumeHexseq(S,L),S[L]===":"&&S[L+1]===":"){L+=2;try{L=this.consumeHexseq(S,L)}catch{}return L}return L}consumeHexseq(S,O){let L=O;for(;L=this.consumeHex4(S,L),S[L]===":"&&S[L+1]!==":";)L+=1;return L}consumeHex4(S,O){let L=0;for(;L<4;L++)if(!((Q=S[O+L])>="0"&&Q<="9"||Q>="a"&&Q<="f"||Q>="A"&&Q<="F")){if(L===0)throw new Error("Invalid hex 4");break}var Q;return O+L}consumeFQDN(S,O){let L=O;for(;l(S[L])||T(S[L])||S[L]==="-"||S[L]===".";)L+=1;if(L-O<4)throw new Error("Invalid FQDN");return L}consumeExtnAddr(S,O){return this.consumeOneOrMore(S,O,h)}consumeMulticastAddress(S,O,L){switch(L){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(S,O);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(S,O);default:try{return this.consumeFQDN(S,O)}catch{return this.consumeExtnAddr(S,O)}}}consumeIP6MulticastAddress(S,O){const L=this.consumeHexpart(S,O);return S[L]==="/"?this.consumeInteger(S,L+1):L}consumeIP4MulticastAddress(S,O){let L=O+3;const Q=S.slice(O,L),Oe=parseInt(Q);if(Oe<224||Oe>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Ct=0;Ct<3;Ct++){if(S[L]!==".")throw new Error("Invalid IP4 multicast address.");L+=1,L=this.consumeDecimalUChar(S,L)}return S[L]==="/"&&(L+=1),L=this.consumeTTL(S,L),S[L]==="/"&&(L=this.consumeInteger(S,L)),L}consumeInteger(S,O){if(!R(S[O]))throw new Error("Invalid integer.");for(O+=1;l(S[O]);)O+=1;return O}consumeTTL(S,O){if(S[O]==="0")return O+1;if(!R(S[O]))throw new Error("Invalid TTL.");O+=1;for(let L=0;L<2&&l(S[O]);L++)O+=1;return O}consumeToken(S,O){return this.consumeOneOrMore(S,O,p)}consumeTime(S,O){let L=O;if(S[L]==="0")return L+1;for(R(S[L])&&(L+=1);l(S[L]);)L++;if(L-O<10)throw new Error("Invalid time");return L}consumeAddress(S,O){return this.consumeTill(S,O,c)}consumeTypedTime(S,O){let L=O;return L=this.consumeOneOrMore(S,L,l),y(S[L])?L+1:L}consumeRepeatInterval(S,O){if(!R(S[O]))throw new Error("Invalid repeat interval");for(O+=1;l(S[O]);)O+=1;return y(S[O])&&(O+=1),O}consumePort(S,O){return this.consumeOneOrMore(S,O,l)}consume(S,O,L){for(let Q=0;Q<L.length;Q++){if(O+Q>=S.length)throw new Error("consume exceeding value length");if(S[O+Q]!==L[Q])throw new Error("consume ".concat(L," failed at ").concat(Q))}return O+L.length}consumeTill(S,O,L){let Q=O;for(;Q<S.length&&(typeof L!="string"||S[Q]!==L)&&(typeof L!="function"||!L(S[Q]));)Q++;return Q}}class Y extends G{constructor(){super(),M(this,"records",[]),M(this,"currentLine",0)}parse(S){const O=this.probeEOL(S);this.records=S.split(O).filter((Ro=>!!zn(Ro).call(Ro))).map(this.parseLine),this.currentLine=0;const L=this.parseVersion(),Q=this.parseOrigin(),Oe=this.parseSessionName(),Ct=this.parseInformation(),_n=this.parseUri(),Zi=this.parseEmail(),vo=this.parsePhone(),Vp=this.parseConnection(),zc=this.parseBandWidth(),jp=this.parseTimeFields(),ya=this.parseKey(),Al=this.parseSessionAttribute(),va=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:L,origin:Q,sessionName:Oe,information:Ct,uri:_n,emails:Zi,phones:vo,connection:Vp,bandwidths:zc,timeFields:jp,key:ya,attributes:Al,mediaDescriptions:va}}getCurrentRecord(){const S=this.records[this.currentLine];if(!S)throw new Error("Record doesn't exit.");return S}probeEOL(S){for(let O=0;O<S.length;O++)if(S[O]===o)return S[O-1]==="\r"?a:o;throw new Error("Invalid newline character.")}parseLine(S,O){if(S.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const L=S[0];if(S[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:L,value:S.slice(2),line:O,cur:0}}parseSessionAttribute(){const S=new Ie;for(;this.currentLine<this.records.length;){const O=this.getCurrentRecord();if(O.type!==d.ATTRIBUTE)break;const L={attField:this.extractOneOrMore(O,(Q=>p(Q)&&Q!==":")),_cur:0};O.value[O.cur]===":"&&(O.cur+=1,L.attValue=this.extractOneOrMore(O,I)),S.parse(L),this.currentLine++}return S.digest()}parseMediaAttributes(S){const O=new Ce(S);for(;this.currentLine<this.records.length;){const L=this.getCurrentRecord();if(L.type!==d.ATTRIBUTE)break;const Q={attField:this.extractOneOrMore(L,(Oe=>p(Oe)&&Oe!==":")),_cur:0};L.value[L.cur]===":"&&(L.cur+=1,Q.attValue=this.extractOneOrMore(L,I)),O.parse(Q),this.currentLine++}return O.digest()}parseKey(){const S=this.getCurrentRecord();if(S.type===d.KEY){if(S.value==="prompt"||S.value==="clear:"||S.value==="base64:"||S.value==="uri:")return S.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const S=this.getCurrentRecord();if(S.type===d.ZONE_ADJUSTMENTS){const O=[];for(;;)try{const L=this.extract(S,this.consumeTime);this.consumeSpaceForRecord(S);let Q=!1;S.value[S.cur]==="-"&&(Q=!0,S.cur+=1);const Oe=this.extract(S,this.consumeTypedTime);O.push({time:L,typedTime:Oe,back:Q})}catch{break}if(O.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,O}return[]}parseRepeat(){const S=[];for(;;){const O=this.getCurrentRecord();if(O.type!==d.REPEAT)break;{const L=this.extract(O,this.consumeRepeatInterval),Q=this.parseTypedTime(O);S.push({repeatInterval:L,typedTimes:Q}),this.currentLine++}}return S}parseTypedTime(S){const O=[];for(;;)try{this.consumeSpaceForRecord(S),O.push(this.extract(S,this.consumeTypedTime))}catch{break}if(O.length===0)throw new Error("Invalid typed time.");return O}parseTime(){const S=this.getCurrentRecord(),O=this.extract(S,this.consumeTime);this.consumeSpaceForRecord(S);const L=this.extract(S,this.consumeTime);return this.currentLine++,{startTime:O,stopTime:L}}parseBandWidth(){const S=[];for(;this.currentLine<this.records.length;){const O=this.getCurrentRecord();if(O.type!==d.BANDWIDTH)break;{const L=this.extractOneOrMore(O,p);if(O.value[O.cur]!==":")throw new Error("Invalid bandwidth field.");O.cur++;const Q=this.extractOneOrMore(O,l);S.push({bwtype:L,bandwidth:Q}),this.currentLine++}}return S}parseVersion(){const S=this.getCurrentRecord();if(S.type!==d.VERSION)throw new Error("first sdp record must be version");const O=S.value.slice(0,this.consumeOneOrMore(S.value,0,l));if(O.length!==S.value.length)throw new Error('invalid proto version, "v='.concat(S.value,'"'));return this.currentLine++,O}parseOrigin(){const S=this.getCurrentRecord();if(S.type!==d.ORIGIN)throw new Error("second line of sdp must be origin");const O=this.extractOneOrMore(S,h);this.consumeSpaceForRecord(S);const L=this.extractOneOrMore(S,l);this.consumeSpaceForRecord(S);const Q=this.extractOneOrMore(S,l);this.consumeSpaceForRecord(S);const Oe=this.extractOneOrMore(S,p);this.consumeSpaceForRecord(S);const Ct=this.extractOneOrMore(S,p);this.consumeSpaceForRecord(S);const _n=this.extract(S,this.consumeUnicastAddress);return this.currentLine++,{username:O,sessId:L,sessVersion:Q,nettype:Oe,addrtype:Ct,unicastAddress:_n}}parseSessionName(){const S=this.getCurrentRecord();if(S.type===d.SESSION_NAME){const O=this.extract(S,this.consumeText);return this.currentLine++,O}}parseInformation(){const S=this.getCurrentRecord();if(S.type!==d.INFORMATION)return;const O=this.extract(S,this.consumeText);return this.currentLine++,O}parseUri(){const S=this.getCurrentRecord();if(S.type===d.URI)return this.currentLine++,S.value}parseEmail(){const S=[];for(;;){const O=this.getCurrentRecord();if(O.type!==d.EMAIL)break;S.push(O.value),this.currentLine++}return S}parsePhone(){const S=[];for(;;){const O=this.getCurrentRecord();if(O.type!==d.PHONE)break;S.push(O.value),this.currentLine++}return S}parseConnection(){const S=this.getCurrentRecord();if(S.type===d.CONNECTION){const O=this.extractOneOrMore(S,p);this.consumeSpaceForRecord(S);const L=this.extractOneOrMore(S,p);this.consumeSpaceForRecord(S);const Q=this.extract(S,this.consumeAddress);return this.currentLine++,{nettype:O,addrtype:L,address:Q}}}parseMedia(){const S=this.getCurrentRecord(),O=this.extract(S,this.consumeToken);this.consumeSpaceForRecord(S);let L=this.extract(S,this.consumePort);S.value[S.cur]==="/"&&(S.cur+=1,L+=this.extract(S,this.consumeInteger)),this.consumeSpaceForRecord(S);const Q=[];for(Q.push(this.extract(S,this.consumeToken));S.value[S.cur]==="/";)S.cur+=1,Q.push(this.extract(S,this.consumeToken));if(Q.length===0)throw new Error("Invalid proto");const Oe=this.parseFmt(S);return this.currentLine++,{mediaType:O,port:L,protos:Q,fmts:Oe}}parseTimeFields(){const S=[];for(;this.getCurrentRecord().type===d.TIME;){const O=this.parseTime(),L=this.parseRepeat(),Q=this.parseZone();S.push({time:O,repeats:L,zones:Q})}return S}parseMediaDescription(){const S=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.MEDIA;){const O=this.parseMedia(),L=this.parseInformation(),Q=this.parseConnections(),Oe=this.parseBandWidth(),Ct=this.parseKey(),_n=this.parseMediaAttributes(O);S.push({media:O,information:L,connections:Q,bandwidths:Oe,key:Ct,attributes:_n})}return S}parseConnections(){const S=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.CONNECTION;)S.push(this.parseConnection());return S}parseFmt(S){const O=[];for(;;)try{this.consumeSpaceForRecord(S),O.push(this.extract(S,this.consumeToken))}catch{break}if(O.length===0)throw new Error("Invalid fmts");return O}extract(S,O){for(var L=arguments.length,Q=new Array(L>2?L-2:0),Oe=2;Oe<L;Oe++)Q[Oe-2]=arguments[Oe];const Ct=O.call(this,S.value,S.cur,...Q),_n=S.value.slice(S.cur,Ct);return S.cur=Ct,_n}extractOneOrMore(S,O){const L=this.consumeOneOrMore(S.value,S.cur,O),Q=S.value.slice(S.cur,L);return S.cur=L,Q}consumeSpaceForRecord(S){if(S.value[S.cur]!==c)throw new Error("Invalid space at ".concat(S.cur,"."));S.cur+=1}}class de extends G{constructor(){super(...arguments),M(this,"attributes",void 0),M(this,"digested",!1)}extractOneOrMore(S,O,L){const Q=this.consumeOneOrMore(S.attValue,S._cur,O),Oe=S.attValue.slice(S._cur,Q),[Ct,_n]=L||[];if(typeof Ct=="number"&&Oe.length<Ct)throw new Error("error in length, should be more or equal than ".concat(Ct," characters."));if(typeof _n=="number"&&Oe.length>_n)throw new Error("error in length, should be less or equal than ".concat(_n," characters."));return S._cur=Q,Oe}consumeAttributeSpace(S){if(S.attValue[S._cur]!==c)throw new Error("Invalid space at ".concat(S._cur,"."));S._cur+=1}extract(S,O){if(!S.attValue)throw new Error("Nothing to extract from attValue.");for(var L=arguments.length,Q=new Array(L>2?L-2:0),Oe=2;Oe<L;Oe++)Q[Oe-2]=arguments[Oe];const Ct=O.call(this,S.attValue,S._cur,...Q),_n=S.attValue.slice(S._cur,Ct);return S._cur=Ct,_n}atEnd(S){if(!S.attValue)throw new Error;return S._cur>=S.attValue.length}peekChar(S){if(!S.attValue)throw new Error;return S.attValue[S._cur]}peek(S,O){if(!S.attValue)throw new Error;for(let L=0;L<O.length;L++)if(O[L]!==S.attValue[S._cur+L])return!1;return!0}parseIceUfrag(S){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(S,A,[4,256])}parseIcePwd(S){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(S,A,[22,256])}parseIceOptions(S){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const O=[];for(;!this.atEnd(S);){O.push(this.extractOneOrMore(S,A));try{this.consumeAttributeSpace(S)}catch(L){if(this.atEnd(S))break;throw L}}this.attributes.iceOptions=O}parseFingerprint(S){const O=this.extract(S,this.consumeToken);this.consumeAttributeSpace(S);const L=this.extract(S,this.consumeTill);this.attributes.fingerprints.push({hashFunction:O,fingerprint:L})}parseExtmap(S){const O=this.extractOneOrMore(S,l);let L;this.peekChar(S)==="/"&&(this.extract(S,this.consume,"/"),L=this.extract(S,this.consumeToken)),this.consumeAttributeSpace(S);const Q=this.extract(S,this.consumeTill,c),Oe=P(P({entry:parseInt(O,10)},L&&{direction:L}),{},{extensionName:Q});this.peekChar(S)===c&&(this.consumeAttributeSpace(S),Oe.extensionAttributes=this.extract(S,this.consumeTill)),this.attributes.extmaps.push(Oe)}parseSetup(S){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const O=this.extract(S,this.consumeTill);if(O!=="active"&&O!=="passive"&&O!=="actpass"&&O!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=O}}class Ie extends de{constructor(){super(...arguments),M(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(S){if(this.digested)throw new Error("already digested");try{switch(S.attField){case"group":this.parseGroup(S);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(S);break;case"ice-pwd":this.parseIcePwd(S);break;case"ice-options":this.parseIceOptions(S);break;case"fingerprint":this.parseFingerprint(S);break;case"setup":this.parseSetup(S);break;case"tls-id":this.parseTlsId(S);break;case"identity":this.parseIdentity(S);break;case"extmap":this.parseExtmap(S);break;case"msid-semantic":this.parseMsidSemantic(S);break;default:S.ignored=!0,this.attributes.unrecognized.push(S)}}catch(O){throw console.error("parsing session attribute ".concat(S.attField,' error, "a=').concat(S.attField,":").concat(S.attValue,'"')),O}if(!S.ignored&&S.attValue&&!this.atEnd(S))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(S){const O=this.extract(S,this.consumeToken),L=[];for(;!this.atEnd(S)&&this.peekChar(S)===c;)this.consumeAttributeSpace(S),L.push(this.extract(S,this.consumeToken));this.attributes.groups.push({semantic:O,identificationTag:L})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(S){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(S,N)}parseIdentity(S){const O=this.extractOneOrMore(S,k),L=[];for(;!this.atEnd(S)&&this.peekChar(S)===c;){this.consumeAttributeSpace(S);const Q=this.extract(S,this.consumeToken);this.extract(S,this.consume,"=");const Oe=this.extractOneOrMore(S,(Ct=>Ct!==c&&I(Ct)));L.push({name:Q,value:Oe})}this.attributes.identities.push({assertionValue:O,extensions:L})}parseMsidSemantic(S){this.peekChar(S)===c&&this.consumeAttributeSpace(S);const O={semantic:this.extract(S,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(S)}catch{break}if(this.peekChar(S)==="*"){this.extract(S,this.consume,"*"),O.applyForAll=!0;break}{const L=this.extract(S,this.consumeTill,c);O.identifierList.push(L)}}this.attributes.msidSemantic=O}}class Ce extends de{constructor(S){super(),M(this,"attributes",void 0),S.protos.indexOf("RTP")!==-1||S.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(S){if(this.digested)throw new Error("already digested");try{switch(S.attField){case"extmap":this.parseExtmap(S);break;case"setup":this.parseSetup(S);break;case"ice-ufrag":this.parseIceUfrag(S);break;case"ice-pwd":this.parseIcePwd(S);break;case"ice-options":this.parseIceOptions(S);break;case"candidate":this.parseCandidate(S);break;case"remote-candidate":this.parseRemoteCandidate(S);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(S);break;case"rtpmap":this.parseRtpmap(S);break;case"ptime":this.parsePtime(S);break;case"maxptime":this.parseMaxPtime(S);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(S);break;case"ssrc":this.parseSSRC(S);break;case"fmtp":this.parseFmtp(S);break;case"rtcp-fb":this.parseRtcpFb(S);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(S);break;case"mid":this.parseMid(S);break;case"msid":this.parseMsid(S);break;case"imageattr":this.parseImageAttr(S);break;case"rid":this.parseRid(S);break;case"simulcast":this.parseSimulcast(S);break;case"sctp-port":this.parseSctpPort(S);break;case"max-message-size":this.parseMaxMessageSize(S);break;case"ssrc-group":this.parseSSRCGroup(S);break;default:S.ignored=!0,this.attributes.unrecognized.push(S)}}catch(O){throw console.error("parsing media attribute ".concat(S.attField,' error, "a=').concat(S.attField,":").concat(S.attValue,'"')),O}if(!S.ignored&&S.attValue&&!this.atEnd(S))throw new Error("attribute parsing error")}parseCandidate(S){const O=this.extractOneOrMore(S,A,[1,32]);this.consumeAttributeSpace(S);const L=this.extractOneOrMore(S,l,[1,5]);this.consumeAttributeSpace(S);const Q=this.extract(S,this.consumeToken);this.consumeAttributeSpace(S);const Oe=this.extractOneOrMore(S,l,[1,10]);this.consumeAttributeSpace(S);const Ct=this.extract(S,this.consumeAddress);this.consumeAttributeSpace(S);const _n=this.extract(S,this.consumePort);this.consumeAttributeSpace(S),this.extract(S,this.consume,"typ"),this.consumeAttributeSpace(S);const Zi={foundation:O,componentId:L,transport:Q,priority:Oe,connectionAddress:Ct,port:_n,type:this.extract(S,this.consumeToken),extension:{}};for(this.peek(S," raddr")&&(this.extract(S,this.consume," raddr"),this.consumeAttributeSpace(S),Zi.relAddr=this.extract(S,this.consumeAddress)),this.peek(S," rport")&&(this.extract(S,this.consume," rport"),this.consumeAttributeSpace(S),Zi.relPort=this.extract(S,this.consumePort));this.peekChar(S)===c;){this.consumeAttributeSpace(S);const vo=this.extract(S,this.consumeToken);this.consumeAttributeSpace(S),Zi.extension[vo]=this.extractOneOrMore(S,u)}this.attributes.candidates.push(Zi)}parseRemoteCandidate(S){const O=[];for(;;){const L=this.extractOneOrMore(S,l,[1,5]);this.consumeAttributeSpace(S);const Q=this.extract(S,this.consumeAddress);this.consumeAttributeSpace(S);const Oe=this.extract(S,this.consumePort);O.push({componentId:L,connectionAddress:Q,port:Oe});try{this.consumeAttributeSpace(S)}catch{break}}this.attributes.remoteCandidatesList.push(O)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(S){const O=this.extract(S,this.consumeToken);this.consumeAttributeSpace(S);const L=this.extract(S,this.consumeTill,"/");this.extract(S,this.consume,"/");const Q={encodingName:L,clockRate:this.extractOneOrMore(S,l)};this.atEnd(S)||this.peekChar(S)!=="/"||(this.extract(S,this.consume,"/"),Q.encodingParameters=parseInt(this.extract(S,this.consumeTill),10));const Oe=this.attributes.payloads.find((Ct=>Ct.payloadType===parseInt(O,10)));Oe?Oe.rtpMap=Q:this.attributes.payloads.push({payloadType:parseInt(O,10),rtpMap:Q,rtcpFeedbacks:[]})}parsePtime(S){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(S,this.consumeTill)}parseMaxPtime(S){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(S,this.consumeTill)}parseDirection(S){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=S.attField}parseSSRC(S){const O=this.extractOneOrMore(S,l);this.consumeAttributeSpace(S);const L=this.extract(S,this.consumeTill,":");let Q;this.peekChar(S)===":"&&(this.extract(S,this.consume,":"),Q=this.extract(S,this.consumeTill));const Oe=this.attributes.ssrcs.find((Ct=>Ct.ssrcId===parseInt(O,10)));Oe?Oe.attributes[L]=Q:this.attributes.ssrcs.push({ssrcId:parseInt(O,10),attributes:{[L]:Q}})}parseFmtp(S){const O=this.extract(S,this.consumeTill,c);this.consumeAttributeSpace(S);const L=this.extract(S,this.consumeTill),Q={};L.split(";").forEach((Ct=>{let[_n,Zi]=Ct.split("=");_n=zn(_n).call(_n);const vo=typeof Zi=="string"?zn(Zi).call(Zi):null;typeof _n=="string"&&_n.length>0&&(Q[_n]=vo)}));const Oe=this.attributes.payloads.find((Ct=>Ct.payloadType===parseInt(O,10)));Oe?Oe.fmtp={parameters:Q}:this.attributes.payloads.push({payloadType:parseInt(O,10),rtcpFeedbacks:[],fmtp:{parameters:Q}})}parseFmtParameters(S){const O={},L=this.extract(S,this.consumeTill,"=");S._cur++;const Q=this.extract(S,this.consumeTill,";");for(O[L]=Q;S.attValue[S._cur]===";";){const Oe=this.extract(S,this.consumeTill,"=");S._cur++;const Ct=this.extract(S,this.consumeTill,";");O[Oe]=Ct}return O}parseRtcpFb(S){let O="";O=this.peekChar(S)==="*"?this.extract(S,this.consume,"*"):this.extract(S,this.consumeTill,c),this.consumeAttributeSpace(S);const L=this.extract(S,this.consumeTill,c);let Q;if(L==="trr-int")Q={type:L,interval:this.extract(S,this.consumeTill)};else{const Oe={type:L};this.peekChar(S)===c&&(this.consumeAttributeSpace(S),Oe.parameter=this.extract(S,this.consumeToken),this.peekChar(S)===c&&(Oe.additional=this.extract(S,this.consumeTill))),Q=Oe}if(O==="*")this.attributes.rtcpFeedbackWildcards.push(Q);else{const Oe=this.attributes.payloads.find((Ct=>Ct.payloadType===parseInt(O,10)));Oe?Oe.rtcpFeedbacks.push(Q):this.attributes.payloads.push({payloadType:parseInt(O,10),rtcpFeedbacks:[Q]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(S){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const O={port:this.extract(S,this.consumePort)};this.peekChar(S)===c&&(this.consumeAttributeSpace(S),O.netType=this.extractOneOrMore(S,p),this.consumeAttributeSpace(S),O.addressType=this.extractOneOrMore(S,p),this.consumeAttributeSpace(S),O.address=this.extract(S,this.consumeAddress)),this.attributes.rtcp=O}parseMsid(S){const O={id:this.extractOneOrMore(S,p,[1,64])};this.peekChar(S)===c&&(this.consumeAttributeSpace(S),O.appdata=this.extractOneOrMore(S,p,[1,64])),this.attributes.msids.push(O)}parseImageAttr(S){this.attributes.imageattr.push(S.attValue)}parseRid(S){const O=this.extractOneOrMore(S,(Q=>T(Q)||l(Q)||Q==="_"||Q==="-"));this.consumeAttributeSpace(S);const L={id:O,direction:this.extract(S,this.consumeToken),params:[]};if(this.peekChar(S)===c){if(this.consumeAttributeSpace(S),this.peek(S,"pt=")){this.extract(S,this.consume,"pt=");const Q=[];for(;;){const Oe=this.extract(S,this.consumeToken);Q.push(Oe);try{this.extract(S,this.consume,",")}catch{break}}L.payloads=Q,this.peekChar(S)===c&&this.extract(S,this.consume,c)}for(;;){const Q=this.extract(S,this.consumeToken);if(Q==="depend"){const Oe={type:Q,rids:this.extract(S,this.consume,"=").split(",")};L.params.push(Oe)}else{const Oe={type:Q};this.peekChar(S)==="="&&(this.extract(S,this.consume,"="),Oe.val=this.extract(S,this.consumeTill,";")),L.params.push(Oe)}try{this.extract(S,this.consume,";")}catch{break}}}this.attributes.rids.push(L)}parseSimulcast(S){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=S.attValue,this.extract(S,this.consumeTill)}parseSctpPort(S){this.attributes.sctpPort=this.extractOneOrMore(S,l,[1,5])}parseMaxMessageSize(S){this.attributes.maxMessageSize=this.extractOneOrMore(S,l,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(S){this.attributes.mid=this.extract(S,this.consumeToken)}parseSSRCGroup(S){const O=this.extract(S,this.consumeToken),L=[];for(;;)try{this.consumeAttributeSpace(S);const Q=this.extract(S,this.consumeInteger);L.push(parseInt(Q,10))}catch{break}this.attributes.ssrcGroups.push({semantic:O,ssrcIds:L})}}function Ue(K,S,O){return S in K?Object.defineProperty(K,S,{value:O,enumerable:!0,configurable:!0,writable:!0}):K[S]=O,K}class Pe{constructor(){Ue(this,"eol",a)}print(S,O){let L="";return O&&(this.eol=O),L+=this.printVersion(S.version),L+=this.printOrigin(S.origin),L+=this.printSessionName(S.sessionName),L+=this.printInformation(S.information),L+=this.printUri(S.uri),L+=this.printEmail(S.emails),L+=this.printPhone(S.phones),L+=this.printConnection(S.connection),L+=this.printBandwidth(S.bandwidths),L+=this.printTimeFields(S.timeFields),L+=this.printKey(S.key),L+=this.printSessionAttributes(S.attributes),L+=this.printMediaDescription(S.mediaDescriptions),L}printVersion(S){return"v=".concat(S).concat(this.eol)}printOrigin(S){return"o=".concat(S.username," ").concat(S.sessId," ").concat(S.sessVersion," ").concat(S.nettype," ").concat(S.addrtype," ").concat(S.unicastAddress).concat(this.eol)}printSessionName(S){return S?"s=".concat(S).concat(this.eol):""}printInformation(S){return S?"i=".concat(S).concat(this.eol):""}printUri(S){return S?"u=".concat(S).concat(this.eol):""}printEmail(S){let O="";for(const L of S)O+="e=".concat(L).concat(this.eol);return O}printPhone(S){let O="";for(const L of S)O+="e=".concat(L).concat(this.eol);return O}printConnection(S){return S?"c=".concat(S.nettype," ").concat(S.addrtype," ").concat(S.address).concat(this.eol):""}printBandwidth(S){let O="";for(const L of S)O+="b=".concat(L.bwtype,":").concat(L.bandwidth).concat(this.eol);return O}printTimeFields(S){let O="";for(const L of S){O+="t=".concat(L.time.startTime," ").concat(L.time.startTime).concat(this.eol);for(const Q of L.repeats)O+="r=".concat(Q.repeatInterval," ").concat(Q.typedTimes.join(" ")).concat(this.eol);L.zoneAdjustments&&(O+="z=",O+="z=".concat(L.zoneAdjustments.map((Q=>"".concat(Q.time," ").concat(Q.back?"-":""," ").concat(Q.typedTime))).join(" ")).concat(this.eol),O+=this.eol)}return O}printKey(S){return S?"k=".concat(S).concat(this.eol):""}printAttributes(S){let O="";for(const L of S)O+="a=".concat(L.attField).concat(L.attValue?":".concat(L.attValue):"").concat(this.eol);return O}printMediaDescription(S){let O="";for(const L of S)O+=this.printMedia(L.media),O+=this.printInformation(L.information),O+=this.printConnections(L.connections),O+=this.printBandwidth(L.bandwidths),O+=this.printKey(L.key),O+=this.printMediaAttributes(L);return O}printConnections(S){let O="";for(const L of S)O+=this.printConnection(L);return O}printMedia(S){return"m=".concat(S.mediaType," ").concat(S.port," ").concat(S.protos.join("/")," ").concat(S.fmts.join(" ")).concat(this.eol)}printSessionAttributes(S){return new Pt(this.eol).print(S)}printMediaAttributes(S){return new H(this.eol).print(S)}}class nt{constructor(S){Ue(this,"eol",void 0),this.eol=S}printIceUfrag(S){return S===void 0?"":"a=ice-ufrag:".concat(S).concat(this.eol)}printIcePwd(S){return S===void 0?"":"a=ice-pwd:".concat(S).concat(this.eol)}printIceOptions(S){return S===void 0?"":"a=ice-options:".concat(S.join(c)).concat(this.eol)}printFingerprints(S){return S.length>0?S.map((O=>"a=fingerprint:".concat(O.hashFunction).concat(c).concat(O.fingerprint))).join(this.eol)+this.eol:""}printExtmap(S){return S.map((O=>"a=extmap:".concat(O.entry).concat(O.direction?"/".concat(O.direction):"").concat(c).concat(O.extensionName).concat(O.extensionAttributes?"".concat(c).concat(O.extensionAttributes):"").concat(this.eol))).join("")}printSetup(S){return S===void 0?"":"a=setup:".concat(S).concat(this.eol)}printUnrecognized(S){return S.map((O=>"a=".concat(O.attField).concat(O.attValue?":".concat(O.attValue):"").concat(this.eol))).join("")}}class Pt extends nt{print(S){let O="";return O+=this.printGroups(S.groups),O+=this.printMsidSemantic(S.msidSemantic),O+=this.printIceLite(S.iceLite),O+=this.printIceUfrag(S.iceUfrag),O+=this.printIcePwd(S.icePwd),O+=this.printIceOptions(S.iceOptions),O+=this.printFingerprints(S.fingerprints),O+=this.printSetup(S.setup),O+=this.printTlsId(S.tlsId),O+=this.printIdentity(S.identities),O+=this.printExtmap(S.extmaps),O+=this.printUnrecognized(S.unrecognized),O}printGroups(S){let O="";return S.length>0&&(O+=S.map((L=>"a=group:".concat(L.semantic).concat(L.identificationTag.map((Q=>"".concat(c).concat(Q))).join("")).concat(this.eol))).join("")),O}printIceLite(S){return S===void 0?"":"a=ice-lite"+this.eol}printTlsId(S){return S?"a=tls-id:".concat(S).concat(this.eol):""}printIdentity(S){return S.length===0?"":S.map((O=>"a=identity:".concat(O.assertionValue).concat(O.extensions.map((L=>"".concat(c).concat(L.name).concat(L.value?"=".concat(L.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(S){if(!S)return"";let O="a=msid-semantic:".concat(S.semantic);return S.applyForAll?O+="".concat(c,"*"):S.identifierList.length>0&&(O+=S.identifierList.map((L=>"".concat(c).concat(L)))),O+this.eol}}class H extends nt{print(S){const O=S.attributes;let L="";return L+=this.printRTCP(O.rtcp),L+=this.printIceUfrag(O.iceUfrag),L+=this.printIcePwd(O.icePwd),L+=this.printIceOptions(O.iceOptions),L+=this.printCandidates(O.candidates),L+=this.printRemoteCandidatesList(O.remoteCandidatesList),L+=this.printEndOfCandidates(O.endOfCandidates),L+=this.printFingerprints(O.fingerprints),L+=this.printSetup(O.setup),L+=this.printMid(O.mid),L+=this.printExtmap(O.extmaps),L+=this.printRTPRelated(O),L+=this.printPtime(O.ptime),L+=this.printMaxPtime(O.maxPtime),L+=this.printDirection(O.direction),L+=this.printSSRCGroups(O.ssrcGroups),L+=this.printSSRC(O.ssrcs),L+=this.printRTCPMux(O.rtcpMux),L+=this.printRTCPMuxOnly(O.rtcpMuxOnly),L+=this.printRTCPRsize(O.rtcpRsize),L+=this.printMSId(O.msids),L+=this.printImageattr(O.imageattr),L+=this.printRid(O.rids),L+=this.printSimulcast(O.simulcast),L+=this.printSCTPPort(O.sctpPort),L+=this.printMaxMessageSize(O.maxMessageSize),L+=this.printUnrecognized(O.unrecognized),L}printCandidates(S){return S.map((O=>"a=candidate:".concat(O.foundation).concat(c).concat(O.componentId).concat(c).concat(O.transport).concat(c).concat(O.priority).concat(c).concat(O.connectionAddress).concat(c).concat(O.port).concat(c,"typ").concat(c).concat(O.type).concat(O.relAddr?"".concat(c,"raddr").concat(c).concat(O.relAddr):"").concat(O.relPort?"".concat(c,"rport").concat(c).concat(O.relPort):"").concat(Object.keys(O.extension).map((L=>"".concat(c).concat(L).concat(c).concat(O.extension[L]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(S){return S.map((O=>"a=remote-candidates:".concat(O.join(c)).concat(this.eol))).join("")}printEndOfCandidates(S){return S===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(S){if(!S.payloads)return"";const O=S.payloads;let L="";L+=S.rtcpFeedbackWildcards.map((Q=>this.printRTCPFeedback("*",Q))).join("");for(const Q of O)L+=this.printRtpMap(Q.payloadType,Q.rtpMap),L+=this.printFmtp(Q.payloadType,Q.fmtp),L+=Q.rtcpFeedbacks.map((Oe=>this.printRTCPFeedback(Q.payloadType,Oe))).join("");return L}printFmtp(S,O){if(!O)return"";const L=Object.keys(O.parameters);return L.length===1&&O.parameters[L[0]]===null?"a=fmtp:".concat(S).concat(c).concat(L[0]).concat(this.eol):"a=fmtp:".concat(S).concat(c).concat(Object.keys(O.parameters).map((Q=>"".concat(Q,"=").concat(O.parameters[Q]))).join(";")).concat(this.eol)}printRtpMap(S,O){return O?"a=rtpmap:".concat(S).concat(c).concat(O.encodingName,"/").concat(O.clockRate).concat(O.encodingParameters?"/".concat(O.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(S,O){let L="a=rtcp-fb:".concat(S).concat(c),Q=O;return Q.type==="trr-int"?L+="ttr-int".concat(c).concat(Q.interval):(L+="".concat(Q.type),Q.parameter&&(L+="".concat(c).concat(Q.parameter),Q.additional&&(L+="".concat(c).concat(Q.additional)))),L+this.eol}printPtime(S){return S===void 0?"":"a=ptime:".concat(S).concat(this.eol)}printMaxPtime(S){return S===void 0?"":"a=maxptime:".concat(S).concat(this.eol)}printDirection(S){return S===void 0?"":"a=".concat(S).concat(this.eol)}printSSRC(S){return S.map((O=>Object.keys(O.attributes).map((L=>"a=ssrc:".concat(O.ssrcId.toString(10)).concat(c).concat(L).concat(O.attributes[L]?":".concat(O.attributes[L]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(S){return S===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(S){return S===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(S){return S===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(S){if(S===void 0)return"";let O="a=rtcp:".concat(S.port);return S.netType&&(O+="".concat(c).concat(S.netType)),S.addressType&&(O+="".concat(c).concat(S.addressType)),S.address&&(O+="".concat(c).concat(S.address)),O+this.eol}printMSId(S){return S.map((O=>"a=msid:".concat(O.id).concat(O.appdata?"".concat(c).concat(O.appdata):"").concat(this.eol))).join("")}printImageattr(S){return S.map((O=>"a=imageattr:".concat(O).concat(this.eol))).join("")}printRid(S){return S.map((O=>{let L="a=rid:".concat(O.id).concat(c).concat(O.direction);return O.payloads&&(L+="".concat(c,"pt=").concat(O.payloads.join(","))),O.params.length>0&&(L+="".concat(c).concat(O.params.map((Q=>Q.type==="depend"?"depend=".concat(Q.rids.join(",")):"".concat(Q.type,"=").concat(Q.val))).join(";"))),L+this.eol})).join("")}printSimulcast(S){return S===void 0?"":"a=simulcast:".concat(S).concat(this.eol)}printSCTPPort(S){return S===void 0?"":"a=sctp-port:".concat(S).concat(this.eol)}printMaxMessageSize(S){return S===void 0?"":"a=max-message-size:".concat(S).concat(this.eol)}printMid(S){return S===void 0?"":"a=mid:".concat(S).concat(this.eol)}printSSRCGroups(S){return S.map((O=>"a=ssrc-group:".concat(O.semantic).concat(O.ssrcIds.map((L=>"".concat(c).concat(L.toString(10)))).join("")).concat(this.eol))).join("")}}function $(K){return new Y().parse(K)}function he(K,S){return new Pe().print(K,S)}}},t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{}};return e[i](r,r.exports,n),r.exports}return n.d=(i,r)=>{for(var s in r)n.o(r,s)&&!n.o(i,s)&&Object.defineProperty(i,s,{enumerable:!0,get:r[s]})},n.o=(i,r)=>Object.prototype.hasOwnProperty.call(i,r),n.r=i=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},n(8)})();function Jn(e){return dA.parse(e)}function Ds(e,t){return dA.print(e,t)}var i6=Fi("Array","keys"),r6=zs,s6=Vn,o6=q,a6=i6,FE=Array.prototype,c6={DOMTokenList:!0,NodeList:!0},d6=function(e){var t=e.keys;return e===FE||o6(FE,e)&&t===FE.keys||s6(c6,r6(e))?a6:t},Bn=D(d6);function Ft(e,t,n){return(t=(function(i){var r=(function(s,o){if(typeof s!="object"||!s)return s;var a=s[Symbol.toPrimitive];if(a!==void 0){var c=a.call(s,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)})(i);return typeof r=="symbol"?r:r+""})(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function lA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function ke(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?lA(Object(n),!0).forEach((function(i){Ft(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):lA(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function Rh(e,t){return Rh=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,i){return n.__proto__=i,n},Rh(e,t)}function BE(){BE=function(r,s){return new n(r,void 0,s)};var e=RegExp.prototype,t=new WeakMap;function n(r,s,o){var a=RegExp(r,s);return t.set(a,o||t.get(r)),Rh(a,n.prototype)}function i(r,s){var o,a=t.get(s);return Bi(o=Object.keys(a)).call(o,(function(c,d){var l=a[d];if(typeof l=="number")c[d]=r[l];else{for(var u=0;r[l[u]]===void 0&&u+1<l.length;)u++;c[d]=r[l[u]]}return c}),Object.create(null))}return(function(r,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(s&&s.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),s&&Rh(r,s)})(n,RegExp),n.prototype.exec=function(r){var s=e.exec.call(this,r);if(s){s.groups=i(s,this);var o=s.indices;o&&(o.groups=i(o,this))}return s},n.prototype[Symbol.replace]=function(r,s){if(typeof s=="string"){var o=t.get(this);return e[Symbol.replace].call(this,r,s.replace(/\$<([^>]+)(>|$)/g,(function(c,d,l){if(l==="")return c;var u=o[d];return Array.isArray(u)?"$"+u.join("$"):typeof u=="number"?"$"+u:""})))}if(typeof s=="function"){var a=this;return e[Symbol.replace].call(this,r,(function(){var c=arguments;return typeof c[c.length-1]!="object"&&(c=[].slice.call(c)).push(i(c,a)),s.apply(this,c)}))}return e[Symbol.replace].call(this,r,s)},BE.apply(this,arguments)}const uA=new class extends kt{constructor(){super(...arguments),Ft(this,"currentUploadLogID",0)}reportLogUploadError(e){const{errorRange:t}=e;t[t.length-1]&&t[t.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=t[t.length-1],this.emit("REPORT_LOG_UPLOAD",e))}};class l6{constructor(t){Ft(this,"logger",void 0),Ft(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.debug(...this.prefixLists,...n)}info(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.info(...this.prefixLists,...n)}warning(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.warning(...this.prefixLists,...n)}error(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.error(...this.prefixLists,...n)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function WE(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function hA(){const e=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?t?.[0]+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const Hi={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Ch=Date.now(),Kd=e=>{for(const t in Hi)if(Object.prototype.hasOwnProperty.call(Hi,t)&&Hi[t]===e)return t;return"DEFAULT"},_=new class{constructor(){Ft(this,"proxyServerURL",void 0),Ft(this,"logLevel",Hi.DEBUG),Ft(this,"uploadState","collecting"),Ft(this,"uploadLogWaitingList",[]),Ft(this,"uploadLogUploadingList",[]),Ft(this,"uploadErrorCount",0),Ft(this,"currentLogID",0),Ft(this,"url",void 0),Ft(this,"extLog",((e,t)=>{this.appendLogToWaitingList(e,...t)}))}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Hi.DEBUG].concat(t);this.log.apply(this,i)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Hi.INFO].concat(t);this.log.apply(this,i)}warning(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Hi.WARNING].concat(t);this.log.apply(this,i)}warn(){this.warning(...arguments)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Hi.ERROR].concat(t);this.log.apply(this,i)}upload(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[Hi.DEBUG].concat(t);this.uploadLog.apply(this,i)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){_t("UPLOAD_LOG",!0)}disableLogUpload(){_t("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new l6(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-Ch<100)return void setTimeout((()=>{this.log(...t)}),Date.now()-Ch);const i=Math.max(0,Math.min(4,t[0]));if(t[0]=WE()+" Agora-SDK [".concat(Kd(i),"]:"),this.appendLogToWaitingList(i,...t),i<this.logLevel)return;const r=WE()+" %cAgora-SDK [".concat(Kd(i),"]:");let s=[];if(!b("USE_NEW_LOG"))switch(i){case Hi.DEBUG:s=[r,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,s);break;case Hi.INFO:s=[r,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,s);break;case Hi.WARNING:s=[r,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,s);break;case Hi.ERROR:s=[r,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,s)}}uploadLog(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-Ch<100)return void setTimeout((()=>{this.uploadLog(...t)}),Date.now()-Ch);const i=Math.max(0,Math.min(4,t[0]));t[0]=WE()+" Agora-SDK [".concat(Kd(i),"]:"),this.appendLogToWaitingList(i,...t)}appendLogToWaitingList(e){if(!b("UPLOAD_LOG"))return;for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];Array.isArray(n[0])?n[0][0]=hA()+" Agora-SDK [".concat(Kd(e),"]:"):n[0]=hA()+" Agora-SDK [".concat(Kd(e),"]:");let r="";n.forEach((s=>{typeof s=="object"&&(s=JSON.stringify(s)),r+="".concat(s," ")})),this.uploadLogWaitingList.push({payload_str:r,log_level:e,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const e=this.uploadLogUploadingList,t={sdk_version:Gi,process_id:b("PROCESS_ID"),payload:JSON.stringify(e)};return Pr((async()=>{const n=await ii.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(b("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(b("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if(n.data!=="OK"){const i=new Error("unexpected upload log response");throw i.response=n,i}}),(()=>(this.uploadLogUploadingList=[],!1)),(n=>{const i={status:-1,message:n.message,errorRange:e.map((r=>r.log_item_id))};return n.response?(i.status=n.response.status,i.data=n.response.data,i.headers=n.response.headers):n.request&&(i.status=n.request.status),uA.reportLogUploadError(i),!0}),{timeout:b("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:b("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,b("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),b("UPLOAD_LOG_INTERVAL"))})).catch((e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),b("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),b("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}};var pA;function u6(e){return bn(e.reportId,"params.reportId",0,100,!1),bn(e.category,"params.category",0,100,!1),bn(e.event,"params.event",0,100,!1),bn(e.label,"params.label",0,100,!1),St(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(pA={}).FREE="free",pA.UPLOADING="uploading",(function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"})({});const h6={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let rn=(function(e){return e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.RTE_DETAIL="rte_detail_stats",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.XLA_PEER_FIRST_VIDEO_FRAME="xla_peer_first_video_frame",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",e.AB_TEST="ab_test",e})({}),Dt=(function(e){return e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.RTE_DETAIL="io.agora.pb.Wrtc.RteDetailStats",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.XLA_PEER_FIRST_VIDEO_FRAME="io.agora.pb.Wrtc.XLAPeerFirstVideoFrame",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",e.AB_TEST="io.agora.pb.Wrtc.ABTest",e})({});(function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let p6=(function(e){return e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",e})({});function ve(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,n,i){const r=i.value;if(typeof r=="function"){const s=e.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);i.value=function(){for(var o,a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];let l=c;if(e.argsMap)try{l=e.argsMap(this,...c)}catch(h){_.warning(h),l=[]}try{JSON.stringify(l)}catch{_.warning("arguments for method ".concat(s,".").concat(String(n)," not serializable for apiInvoke.")),l=[]}const u=(e.report||pe).reportApiInvoke(this._sessionId||null,{id:this._clientId||((o=this.store)===null||o===void 0?void 0:o.clientId)||this._ID,name:"".concat(s,".").concat(String(n)),options:l,tag:Tt.TRACER,reportResult:e.reportResult},e.throttleTime);try{const h=r.apply(this,c);return h instanceof ie?h.then((p=>(u.onSuccess(e.reportResult&&p),p))).catch((p=>{throw u.onError(p),p})):(u.onSuccess(e.reportResult&&h),h)}catch(h){throw u.onError(h),h}}}return i}}const pe=new class{constructor(){Ft(this,"baseInfoMap",new Map),Ft(this,"proxyServer",void 0),Ft(this,"eventUploadTimer",void 0),Ft(this,"setSessionIdTimer",void 0),Ft(this,"url",void 0),Ft(this,"sids",new Set),Ft(this,"backupUrl",void 0),Ft(this,"_appId",void 0),Ft(this,"_aid",0),Ft(this,"keyEventUploadPendingItems",[]),Ft(this,"normalEventUploadPendingItems",[]),Ft(this,"apiInvokeUploadPendingItems",[]),Ft(this,"apiInvokeCount",0),Ft(this,"apiInvokeLoggedCount",0),Ft(this,"ltsList",[]),Ft(this,"lastSendNormalEventTime",Date.now()),Ft(this,"customReportCounterTimer",void 0),Ft(this,"customReportCount",0),Ft(this,"extApiInvoke",(async e=>{for(const t of e){const n=ke(ke({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Tt.TRACER});this.sendApiInvoke(n)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),b("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),b("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}setAppId(e){this._appId=e,this._aid=parseInt(e.replace(/[a-fA-F0-9]{8}/g,(t=>{let[n,i]=t;return n+i})),16)||0}reportApiInvoke(e,t,n){t.timeout=t.timeout||6e4,t.reportResult=t.reportResult===void 0||t.reportResult;const i=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,s=!!b("SHOW_REPORT_INVOKER_LOG"),o=!!b("SHOW_REPORT_USER_INVOKER_LOG"),a=s||o&&t.id;a&&(this.apiInvokeLoggedCount+=1);const c=this.apiInvokeLoggedCount;function d(p,R){if(a){let T="[apiInvoke-".concat(c,"]");if(t.id&&(T+="[".concat(t.id,"]")),t.name&&(T+="[".concat(t.name,"]"),t.name===Nt.JOIN))return _.info("".concat(T," ").concat(p));_.info("".concat(T," ").concat(p),p==="start"?t.options:R||"")}}const l=()=>({tag:t.tag,invokeId:r,sid:e,name:t.name,apiInvokeTime:i,options:t.options,states:t.states||null});d("start");let u=!1;hn(t.timeout).then((()=>{u||(this.sendApiInvoke(ke(ke({},l()),{},{error:w.API_INVOKE_TIMEOUT,success:!1})),d("timeout"))}));const h=new F(w.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:p=>{const R=()=>{if(u)throw h;return u=!0,this.sendApiInvoke(ke(ke({},l()),{},{success:!0},t.reportResult&&{result:p})),d("onSuccess"),p};return n?zw(R,t.name+"Success",n,(()=>u=!0)):R()},onError:p=>{const R=()=>{if(u)throw p;u=!0,this.sendApiInvoke(ke(ke({},l()),{},{success:!1,error:p})),d("onFailure",p.toString())};return n?zw(R,t.name+"Error",n,(()=>u=!0)):R()}}}_send(e,t,n){this.send({type:e,data:t},n)}_sendApiInvoke(e){return this.sendApiInvoke(e)}sessionInit(e,t){if(this.baseInfoMap.has(e))return;const n=Date.now(),i=this.createBaseInfo(e,n);i.cname=t.cname,i.rteUrl=t.rteUrl;const r=Object.assign({},{willUploadConsoleLog:b("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:ME?"global":"oversea",areas:b("AREAS")&&b("AREAS").join(",")},t.extend),{stringUid:s,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:d,clientRole:l}=t,u=Date.now(),h=ke(ke({},i),{},{eventType:rn.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,buildFormat:t.buildFormat,build:VE,lts:u,elapse:u-n,extend:JSON.stringify(r),mode:t.mode,process:b("PROCESS_ID"),appType:b("APP_TYPE"),success:!0,version:Gi,stringUid:s,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:d,clientType:X(p=window.navigator.userAgent).call(p,"AgoraWebView")?42:20,clientRole:l,serviceId:b("PROCESS_ID"),extensionID:b("PLUGIN_INFO").join(",")||"",rteUrl:t.rteUrl,rteSid:t.rteSid});var p;this.send({type:Dt.SESSION,data:h},!0)}reportRteDetail(e){const t=this.baseInfoMap.get(e);if(!t)return;const n=t.info,i=Date.now(),r=ke(ke({},n),{},{eventType:rn.RTE_DETAIL,lts:i,success:!0,elapse:i-t.startTime,vid:n.vid===void 0?0:Number(n.vid),ua:navigator.userAgent});this.send({type:Dt.RTE_DETAIL,data:r},!0)}joinChooseServer(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info;t.vid&&(i.vid=t.vid);const r=Date.now(),s=ke(ke({},i),{},{role:t.role,eventType:rn.JOIN_CHOOSE_SERVER,lts:r,eventElapse:t.elapse||r-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:r-n.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3,corssRegionTagReq:t.corssRegionTagReq||void 0,corssRegionTagRes:t.corssRegionTagRes||void 0,ua:navigator.userAgent,resourceTimingInfo:t.resourceTimingInfo||void 0});this.send({type:Dt.JOIN_CHOOSE_SERVER,data:s},!0)}reqUserAccount(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke({},i),{},{eventType:rn.REQ_USER_ACCOUNT,lts:r,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:t.elapse||r-n.startTime,eventElapse:r-t.lts,extend:JSON.stringify(t.extend)});this.send({type:Dt.REQ_USER_ACCOUNT,data:s},!0)}joinGateway(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info;t.vid&&(i.vid=t.vid),i.uid=t.uid,i.cid=t.cid;const r=Date.now(),{firstSuccess:s,addr:o,isProxy:a}=t,c=r-n.startTime,d=ke(ke({},i),{},{eventType:rn.JOIN_GATEWAY,lts:r,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,errorMsg:t.errorMsg||"",elapse:c,eventElapse:r-t.lts,firstSuccess:s,signalChannel:t.signalChannel,preload:t.preload?1:0,installId:xE(),isABTestSuccess:t.isABTestSuccess?1:0,gatewayIp:null,gatewayPort:null,isProxy:a?1:0}),l=d.success?1:0;if(t.succ&&(n.lastJoinSuccessTime=r),o)if(d.signalChannel==="1"){const u=BE(/(\d+\.\d+\.\d+\.\d+):(\d+)/,{ip:1,port:2}),h=o.match(u);d.gatewayIp=h&&h.groups?h.groups.ip:"",d.gatewayPort=h&&h.groups?h.groups.port:""}else if(a){const u=o.match(/h=(\d{1,3}-){3}\d{1,3}/g),h=o.match(/p=[0-9]{1,6}/g);d.gatewayIp=u&&u.length?u[0].split("=")[1].replace(/-/g,"."):"",d.gatewayPort=h&&h.length?h[0].split("=")[1]:""}else{const u=o.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),h=o.match(/(:|p=)[0-9]{1,6}/g);d.gatewayIp=u&&u.length?u[0].split("//")[1].replace(/-/g,"."):"",d.gatewayPort=h&&h.length?h[0].split(/:|p=/g)[1]:""}if(s)this.send({type:Dt.JOIN_GATEWAY,data:d},!0);else{let u={isSuccess:l,port:d.gatewayPort};delete d.success,delete d.eventType,delete d.firstSuccess,delete d.gatewayPort,d.vid=Number(d.vid);const h=Object.assign({},d,u,{eventType:rn.REJOIN_GATEWAY});this.send({type:Dt.RE_JOIN_GATEWAY,data:h},!0)}}joinChannelTimeout(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=Date.now(),r=ke(ke({},n.info),{},{lts:i,timeout:t,elapse:i-n.startTime});this.send({type:Dt.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke({},i),{},{eventType:rn.PUBLISH,lts:r,eventElapse:t.eventElapse,elapse:r-n.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:Dt.PUBLISH,data:s},!0)}subscribe(e,t,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,s=Date.now(),o=ke(ke({},r),{},{eventType:rn.SUBSCRIBE,lts:s,eventElapse:t.eventElapse,elapse:s-i.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid,preSsrc:t.preSsrc?1:0},n&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof t.peerid=="string"?o.peerSuid=t.peerid:o.peer=t.peerid,this.send({type:Dt.SUBSCRIBE,data:o},!0)}wsCompressorInit(e){var t;const n=[...Bn(t=this.baseInfoMap).call(t)],i=n.length?n[0]:"UnableToGetSid",r=this.baseInfoMap.get(i);if(!r)return;const s=r.info,o=Date.now(),a=ke(ke({},s),{},{eventType:rn.WS_COMPRESSOR_INIT,lts:o,eventElapse:e.eventElapse,elapse:o-r.startTime,status:e.status?1:2});this.send({type:Dt.WS_COMPRESSOR_INIT,data:a},!0)}firstXLAPeerFirstVideoFrame(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=t.peerPubStatusMs-(n.lastJoinSuccessTime||r),o=ke(ke({},i),{},{elapse:r-n.startTime,eventType:rn.XLA_PEER_FIRST_VIDEO_FRAME,lts:r,peer:t.peer,width:t.width,height:t.height,ssrc:t.ssrc,p2pid:t.p2pid,peerPublishDuration:t.peerPublishDuration,joinChannelSuccessElapse:s,peerPubStatusMs:t.peerPubStatusMs-t.joinChannelStart,availablePublish:t.peerPublishDuration>s?1:0,preloadStart:Math.max(t.preloadStart-t.joinChannelStart,0),preloadEnd:Math.max(t.preloadEnd-t.joinChannelStart,0),encrypt:Math.max(t.apStart-t.joinChannelStart,0),ap:Math.max(t.apEnd-t.joinChannelStart,0),sua:Math.max(t.suaEnd-t.joinChannelStart,0),beforeConnect:Math.max(t.beforeConnect-t.joinChannelStart,0),peerRecevier:Math.max(t.peerReceiver-t.joinChannelStart,0),ice:Math.max(t.ice-t.joinChannelStart,0),pc:Math.max(t.pc-t.joinChannelStart,0),signalConnected:Math.max(t.signalConnected-t.joinChannelStart,0),joinReq:Math.max(t.joinReq-t.joinChannelStart,0),joinRes:Math.max(t.joinRes-t.joinChannelStart,0),userJoinNotify:Math.max(t.userJoinNotify-t.joinChannelStart,0),videoSsrcNotify:Math.max(t.videoAddNotify-t.joinChannelStart,0),subscribeDelayMs:Math.max(t.subscribeStart-t.videoAddNotify,0),subscribeStart:Math.max(t.subscribeStart-t.joinChannelStart,0),subscribeEnd:Math.max(t.subscribeEnd-t.joinChannelStart,0),firstReceived:Math.max(t.firstReceived-t.joinChannelStart,0),firstDecoded:Math.max(t.firstDecoded-t.joinChannelStart,0),firstPreRender:Math.max(t.firstPreRender-t.joinChannelStart,0),firstRender:Math.max(t.firstRender-t.joinChannelStart,0),playDelayMs:Math.max(t.playStart-t.subscribeEnd,0),playStart:Math.max(t.playStart-t.joinChannelStart,0),playEnd:Math.max(t.playEnd-t.joinChannelStart,0),isPreSub:t.isPreSub?1:0,isPrePc:t.isPrePc?1:0,isPreInstantVideo:t.isPreInstantVideo?1:0,firstReceivedEncodedFrame:t.firstReceivedEncodedFrame?Math.max(t.firstReceivedEncodedFrame-t.joinChannelStart,0):void 0,frameType:t.frameType||"",rtpTimestamp:t.rtpTimestamp||0,framePayloadType:t.framePayloadType||0,frameDataLength:t.frameDataLength||0,mimeType:t.mimeType||""});this.send({type:Dt.XLA_PEER_FIRST_VIDEO_FRAME,data:o},!0)}firstRemoteVideoDecode(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=ke(ke(ke({},s),i),{},{elapse:o-r.startTime,eventType:t,lts:o,firstDecodeFrame:Math.max((i.firstFrame||o)-r.startTime,0),apEnd:Math.max(i.apEnd-r.startTime,0),apStart:Math.max(i.apStart-r.startTime,0),joinGwEnd:Math.max(i.joinGwEnd-r.startTime,0),joinGwStart:Math.max(i.joinGwStart-r.startTime,0),pcEnd:Math.max(i.pcEnd-r.startTime,0),pcStart:Math.max(i.pcStart-r.startTime,0),subscriberEnd:Math.max(i.subscriberEnd-r.startTime,0),subscriberStart:Math.max(i.subscriberStart-r.startTime,0),videoAddNotify:Math.max(i.videoAddNotify-r.startTime,0)});this.send({type:n,data:a},!0)}firstRemoteFrame(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=ke(ke(ke({},s),i),{},{elapse:o-r.startTime,eventType:t,lts:o});this.send({type:n,data:a},!0)}abTest(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke(ke({},i),t),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-n.startTime,eventType:rn.AB_TEST,lts:r});this.send({type:Dt.AB_TEST,data:s},!0)}pcStats(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke(ke({},i),t),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-n.startTime,eventType:rn.PC_STATS,lts:r,preallocation:t.preallocation?1:0});this.send({type:Dt.PC_STATS,data:s},!0)}updateRemoteRTPCapabilities(e,t){if(e){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke(ke({},i),t),{},{vid:i.vid===void 0?0:Number(i.vid),eventType:rn.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:Dt.UPDATE_REMOTE_RTPCAPABILITIES,data:s},!0)}}onGatewayStream(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=ke(ke(ke({},s),i),{},{eventType:t,lts:o});this.send({type:n,data:a},!0)}streamSwitch(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke({},i),{},{eventType:rn.STREAM_SWITCH,lts:r,isDual:t.isdual,elapse:r-n.startTime,success:t.succ});this.send({type:Dt.STREAM_SWITCH,data:s},!0)}requestProxyAppCenter(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke({},i),{},{eventType:rn.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-t.lts,elapse:r-n.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Dt.REQUEST_PROXY_APPCENTER,data:s},!0)}requestProxyWorkerManager(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke({},i),{},{eventType:rn.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-t.lts,elapse:r-n.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Dt.REQUEST_PROXY_WORKER_MANAGER,data:s},!0)}setProxyServer(e){this.proxyServer=e,e?_.debug("reportProxyServerurl: ".concat(e)):_.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke({},i),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:r,elapse:r-n.startTime,joinChannelSuccessElapse:r-(n.lastJoinSuccessTime||r),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:Dt.PEER_PUBLISH_STATUS,data:s},!0)}workerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now();(function(s,o,a){const c=s[o];if(!c||typeof c!="string")return[s];s[o]="";const d=rs(JSON.stringify(s));let l=0;const u=[];let h=0;for(let p=0;p<c.length;p++)h+=c.charCodeAt(p)<=127?1:3,h<=a-d||(u[u.length]=Z(Z({},s),{},{[o]:c.substring(l,p)}),l=p,h=c.charCodeAt(p)<=127?1:3);return l!==c.length-1&&(u[u.length]=Z(Z({},s),{},{[o]:c.substring(l)})),u})(ke(ke(ke({},i),t),{},{elapse:r-n.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach((s=>this.send({type:Dt.WORKER_EVENT,data:s},!0)))}apworkerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke(ke({},i),t),{},{elapse:r-n.startTime,lts:r});this.send({type:Dt.AP_WORKER_EVENT,data:s},!0)}joinWebProxyAP(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke(ke({},i),t),{},{elapse:r-n.startTime,lts:r,extend:t.extend||void 0});this.send({type:Dt.JOIN_WEB_PROXY_AP,data:s},!0)}WebSocketQuit(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=ke(ke(ke({},i),t),{},{elapse:r-n.startTime,lts:r});this.send({type:Dt.WEBSOCKET_QUIT,data:s},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>b("CUSTOM_REPORT_LIMIT"))throw new F(w.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const n=Date.now(),i=t.map((r=>({type:Dt.USER_ANALYTICS,data:ke(ke({sid:e},r),{},{lts:n})})));try{b("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(i):await this.postDataToStatsCollector(i)}catch(r){throw _.error("send custom report message failed",r.toString()),new F(w.CUSTOM_REPORT_SEND_FAILED,r.message)}}sendApiInvoke(e){const t=b("NOT_REPORT_EVENT");if(e.tag&&X(t)&&X(t).call(t,e.tag))return!1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;const n=this.baseInfoMap.get(e.sid);if(!n)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:i,uid:r,cid:s}=n.info;let o;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof F){const{code:c,message:d}=e.error;o=c||d||e.error.toString()}else o=e.error.toString();const a={invokeId:e.invokeId,sid:e.sid,cname:i,cid:s,uid:r,lts:e.lts,success:e.success,elapse:e.lts-n.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?o:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:Dt.API_INVOKE,data:a},!1),!0}addSid(e){this.sids.add(e)}removeSid(e){this.sids.delete(e)}appendSessionId(){const e=this.apiInvokeUploadPendingItems;if(e.length===0)return;const t=Array.from(this.sids).find((n=>n!==null));t&&e.forEach((n=>{n&&(n.sid=t,this.sendApiInvoke(Object.assign({},n)))})),e.length=0}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>b("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){const n=[],i=[];for(;e.length;){const s=e.shift();n.length<20?n.push(s):i.push(s)}e.push(...i);for(const s of[...n]){var r;this.ltsList.indexOf(s.data.lts)!==-1?(s.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(s.data.lts)):(this.ltsList.push(s.data.lts),ko(r=this.ltsList).call(r,((o,a)=>o-a)))}return t||(this.lastSendNormalEventTime=Date.now()),b("ENABLE_EVENT_REPORT")&&n.length&&(b("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((s=>o=>{b("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(s):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(s),this.normalEventUploadPendingItems.length>b("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-b("NORMAL_EVENT_QUEUE_CAPACITY")),_.warning("report: drop normal events"))))})(n)),e}async postDataToStatsCollector2(e){jt.networkState===Xn.OFFLINE&&await ie.race([jt.onlineWaiter,hn(2*Xt.maxRetryTimeout)]);const t=r=>{let s=new Uint8Array;return r.forEach((o=>{const a=yE(JSON.stringify(o.data)),c=new ArrayBuffer(5),d=(u=>{let h=0;return Object.entries(Dt).forEach((p=>{let[R,T]=p;T===u.type&&(h=p6[R])})),h})(o),l=new DataView(c);l.setUint16(0,a.byteLength,!0),l.setUint8(2,255&d),l.setUint8(3,d>>>8&255),l.setUint8(4,d>>>16&255),s=Uw(s,new Uint8Array(c)),s=Uw(s,a)})),s},n="event";let i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(b("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(n):"https://".concat(b("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(n);for(let r=0;r<2;r+=1){r===1&&(i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(b("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(n):"https://".concat(b("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(n));try{await DE(i,{timeout:1e4,data:t(e),headers:ke(ke({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(s){if(r===1)throw s;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=(a=>{const c=a&&a.data.sid&&this.baseInfoMap.get(a.data.sid);return c&&c.info.vid&&+c.info.vid||0})(e[0]),i=n?void 0:this._aid,r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map((a=>JSON.stringify(a))),vid:n,aid:i};jt.networkState===Xn.OFFLINE&&await ie.race([jt.onlineWaiter,hn(2*Xt.maxRetryTimeout)]);const s=t?"/events/proto-raws":"/events/messages";let o=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(b("EVENT_REPORT_DOMAIN"),"&p=").concat(b("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(b("EVENT_REPORT_DOMAIN"),":").concat(b("STATS_COLLECTOR_PORT")).concat(s));for(let a=0;a<2;a+=1){a===1&&(o=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(b("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(b("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(b("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(b("STATS_COLLECTOR_PORT")).concat(s)));try{t?await Z4(o,{timeout:1e4,data:r}):await DE(o,{timeout:1e4,data:r})}catch(c){if(a===1)throw c;continue}return}}createBaseInfo(e,t){const n=Object.assign({},h6);return n.sid=e,this.baseInfoMap.set(e,{info:n,startTime:t}),n}reportResourceTiming(e,t){const n=performance.getEntriesByName(e),i=n[n.length-1];i&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:i,tag:Tt.TRACER}).onSuccess()}};uA.on("REPORT_LOG_UPLOAD",(e=>{e.networkState=jt.networkState,pe.reportApiInvoke(null,{name:"logUploadError",options:e,tag:Tt.TRACER}).onSuccess("logUploadError")}));let V=class extends F{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),Ft(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,_)}throw(){super.throw(_)}};const pn={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1,supportSuppressLocalAudioPlayback:!1,supportRestrictOwnAudio:!1};function We(){return pn}function mA(){return"setSinkId"in HTMLAudioElement.prototype&&(!b("RESTRICTION_SET_PLAYBACK_DEVICE")||(Os()||vw())&&!Dw())}function bh(){return!pn.supportUnifiedPlan||b("CHROME_FORCE_PLAN_B")&&is()}function Yd(e){return!(It()||Rw(87)||bh()||!b("ENABLE_PRE_SUB")&&(e==null||!e.autoSubscribe||b("FORCE_DISABLE_AUTO_SUB")))}function fA(e){return b("ENABLE_INSTANT_VIDEO")?b("ENABLE_INSTANT_VIDEO"):!(e==null||!e.autoSubscribe||b("FORCE_DISABLE_AUTO_SUB"))}function _A(){return navigator.mediaDevices&&"getSupportedConstraints"in navigator.mediaDevices}function EA(){if(_A()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("suppressLocalAudioPlayback"in e)||!e.suppressLocalAudioPlayback)}return Dr(141)||no(141)||Go(141)}function gA(){if(_A()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("restrictOwnAudio"in e)||!e.restrictOwnAudio)}return Dr(141)||no(141)||Go(125)}let In=(function(e){return e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change",e})({});function _c(e,t,n){return{sampleRate:e,stereo:t,bitrate:n}}function $e(e,t,n,i,r){return{width:e,height:t,frameRate:n,bitrateMin:i,bitrateMax:r}}function ur(e,t,n,i,r){return{width:{max:e},height:{max:t},frameRate:n,bitrateMin:i,bitrateMax:r}}function GE(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}const m6={"90p":$e(160,90),"90p_1":$e(160,90),"120p":$e(160,120,15,30,65),"120p_1":$e(160,120,15,30,65),"120p_3":$e(120,120,15,30,50),"120p_4":$e(212,120),"180p":$e(320,180,15,30,140),"180p_1":$e(320,180,15,30,140),"180p_3":$e(180,180,15,30,100),"180p_4":$e(240,180,15,30,120),"240p":$e(320,240,15,40,200),"240p_1":$e(320,240,15,40,200),"240p_3":$e(240,240,15,40,140),"240p_4":$e(424,240,15,40,220),"360p":$e(640,360,15,80,400),"360p_1":$e(640,360,15,80,400),"360p_3":$e(360,360,15,80,260),"360p_4":$e(640,360,30,80,600),"360p_6":$e(360,360,30,80,400),"360p_7":$e(480,360,15,80,320),"360p_8":$e(480,360,30,80,490),"360p_9":$e(640,360,15,80,800),"360p_10":$e(640,360,24,80,800),"360p_11":$e(640,360,24,80,1e3),"480p":$e(640,480,15,100,500),"480p_1":$e(640,480,15,100,500),"480p_2":$e(640,480,30,100,1e3),"480p_3":$e(480,480,15,100,400),"480p_4":$e(640,480,30,100,750),"480p_6":$e(480,480,30,100,600),"480p_8":$e(848,480,15,100,610),"480p_9":$e(848,480,30,100,930),"480p_10":$e(640,480,10,100,400),"720p":$e(1280,720,15,120,1130),"720p_auto":$e(1280,720,30,900,3e3),"720p_1":$e(1280,720,15,120,1130),"720p_2":$e(1280,720,30,120,2e3),"720p_3":$e(1280,720,30,120,1710),"720p_5":$e(960,720,15,120,910),"720p_6":$e(960,720,30,120,1380),"1080p":$e(1920,1080,15,120,2080),"1080p_1":$e(1920,1080,15,120,2080),"1080p_2":$e(1920,1080,30,120,3e3),"1080p_3":$e(1920,1080,30,120,3150),"1080p_5":$e(1920,1080,60,120,4780),"1440p":$e(2560,1440,30,120,4850),"1440p_1":$e(2560,1440,30,120,4850),"1440p_2":$e(2560,1440,60,120,7350),"4k":$e(3840,2160,30,120,8910),"4k_1":$e(3840,2160,30,120,8910),"4k_3":$e(3840,2160,60,120,13500)},f6={"480p":ur(640,480,5),"480p_1":ur(640,480,5),"480p_2":ur(640,480,30),"480p_3":ur(640,480,15),"720p":ur(1280,720,5),"720p_auto":$e(1280,720,30,900,3e3),"720p_1":ur(1280,720,5),"720p_2":ur(1280,720,30),"720p_3":ur(1280,720,15),"1080p":ur(1920,1080,5),"1080p_1":ur(1920,1080,5),"1080p_2":ur(1920,1080,30),"1080p_3":ur(1920,1080,15)},_6={"1SL1TL":GE(1,1),"3SL3TL":GE(3,3),"2SL3TL":GE(2,3)};function hr(e){return e||(e="480p_1"),typeof e=="string"?Object.assign({},m6[e]):e}function HE(e){return typeof e=="string"?Object.assign({},f6[e]):e}function Ih(e){return typeof e=="string"?Object.assign({},_6[e]):e}const E6={speech_low_quality:_c(16e3,!1),speech_standard:_c(32e3,!1,18),music_standard:_c(48e3,!1),standard_stereo:_c(48e3,!0,56),high_quality:_c(48e3,!1,128),high_quality_stereo:_c(48e3,!0,192)};function wh(e){return typeof e=="string"?Object.assign({},E6[e]):e}const Zo=[];function SA(e){return qt(e,"mediaSource",["screen","window","application"]),!0}let me=(function(e){return e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track",e})({}),ct=(function(e){return e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream",e.SCREEN_LOW_TRACK="screen_low_track",e})({}),Ec=(function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e})({}),g6=(function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",e})({}),S6=(function(e){return e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e[e.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",e})({}),$o=(function(e){return e.TRANSCEIVER_UPDATED="transceiver-updated",e.SEI_TO_SEND="sei-to-send",e.SEI_RECEIVED="sei-received",e.TRACK_UPDATED="track-updated",e})({}),gc=(function(e){return e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed",e})({}),Ki=(function(e){return e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.VIDEO_STATE_CHANGED="video-state-changed",e.PLAY_START="play-start",e.PLAY_END="play-end",e.FIRST_FRAME_RENDER="first-frame-render",e})({}),Sc=(function(e){return e.AUDIO="audio",e.VIDEO="video",e.DATA="data",e})({}),Di=(function(e){return e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source",e})({});(function(e){e.UPDATE_TRACK_SOURCE="update-track-source"})({});const KE={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},YE={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},TA={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},T6={uplinkNetworkQuality:0,downlinkNetworkQuality:0},yA={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let Qn=(function(e){return e.ON_TRACK="on_track",e.ON_NODE="on_node",e})({}),Pi=(function(e){return e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints",e})({}),zd=(function(e){return e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND",e})({}),ea=(function(e){return e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e})({}),Ln=(function(e){return e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata",e})({}),ss=(function(e){return e[e.VideoStateStopped=0]="VideoStateStopped",e[e.VideoStateStarting=1]="VideoStateStarting",e[e.VideoStateDecoding=2]="VideoStateDecoding",e[e.VideoStateFrozen=3]="VideoStateFrozen",e})({});const zE={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let Ah=(function(e){return e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error",e})({});function ze(e,t,n,i,r){var s,o,a={};return Object.keys(i).forEach((function(c){a[c]=i[c]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=Bi(s=XT(o=n.slice()).call(o)).call(s,(function(c,d){return d(e,t,c)||c}),a),r&&a.initializer!==void 0&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),a.initializer===void 0?(Object.defineProperty(e,t,a),null):a}function j(e,t,n){return(t=(function(i){var r=(function(s,o){if(typeof s!="object"||!s)return s;var a=s[Symbol.toPrimitive];if(a!==void 0){var c=a.call(s,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)})(i);return typeof r=="symbol"?r:r+""})(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function vA(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function bt(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?vA(Object(n),!0).forEach((function(i){j(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vA(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class RA extends kt{set _mediaStreamTrack(t){t!==this.mediaStreamTrack&&(this.safeEmit($o.TRACK_UPDATED,t),this.mediaStreamTrack=t)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(t,n){super(),j(this,"trackMediaType",void 0),j(this,"_ID",void 0),j(this,"_rtpTransceiver",void 0),j(this,"_lowRtpTransceiver",void 0),j(this,"_hints",[]),j(this,"_isClosed",!1),j(this,"_originMediaStreamTrack",void 0),j(this,"mediaStreamTrack",void 0),j(this,"_external",{}),this._ID=n||ut(8,"track-"),this._originMediaStreamTrack=t,this.mediaStreamTrack=t,(function(i){X(Zo).call(Zo,i)||Zo.push(i)})(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){return t||io((()=>{var n;pe.reportApiInvoke(null,{name:Nt.GET_MEDIA_STREAM_TRACK,options:[],tag:Tt.TRACER}).onSuccess(((n=this._mediaStreamTrack)===null||n===void 0?void 0:n.label)||"")}),this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===Ec.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,(function(t){const n=Zo.indexOf(t);n!==-1&&Zo.splice(n,1)})(this),this.emit(gc.CLOSED),this.removeAllListeners($o.SEI_RECEIVED)}_updateRtpTransceiver(t,n){if(n===Ec.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit($o.TRANSCEIVER_UPDATED,t,n)}}class Tc extends RA{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(t,n){super(t,n),j(this,"_enabled",!0),j(this,"_muted",!1),j(this,"_isExternalTrack",!1),j(this,"_isClosed",!1),j(this,"_enabledMutex",void 0),j(this,"processor",void 0),j(this,"_processorContext",void 0),j(this,"_handleTrackEnded",(()=>{this.onTrackEnded()})),this._enabledMutex=new gn("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,n;return(t=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,_.debug("[".concat(this.getTrackId(),"] close")),this.emit(me.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=i,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await vt(this,me.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){_.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(gc.TRACK_ENDED)}stateCheck(t,n){if(_.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(n,"]")),cr(n,t),this._enabled&&this._muted&&t==="enabled"&&n===!1)throw new F(w.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",_);if(!this._enabled&&!this._muted&&t==="muted"&&n===!0)throw new F(w.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",_)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():ie.resolve([])}}const CA=window.AudioContext||window.webkitAudioContext;let qE,Li=null;const Et=new class extends kt{constructor(){super(...arguments),j(this,"prevState",void 0),j(this,"curState",void 0),j(this,"currentTime",void 0),j(this,"currentTimeStuckAt",void 0),j(this,"interruptDetectorTrack",void 0),j(this,"onLocalAudioTrackMute",(()=>{_.info("ios15-interruption-start"),this.emit(In.IOS_15_16_INTERRUPTION_START)})),j(this,"onLocalAudioTrackUnmute",(async()=>{_.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?_.info("ios15-interruption-end-canceled"):(Li&&await Li.suspend(),this.emit(In.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(e){_.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){_.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function yc(){if(!Li){if((function(){if(!CA)return void _.error("your browser is not support web audio");_.info("create audio context");const e=bt({},b("WEBAUDIO_INIT_OPTIONS"));_.debug("audio context init option:",JSON.stringify(e)),Li=new CA(e),Et.curState=Li.state,Li.onstatechange=()=>{Et.prevState=Et.curState,Et.curState=Li?Li.state:void 0;const{prevState:t,curState:n}=Et,i=n==="running",r=n==="interrupted",s=t==="running",o=t==="suspended",a=t==="interrupted",c=Ze().osVersion;(Fn()||ar())&&s&&r&&(_.info("ios".concat(c,"-interruption-start")),Et.emit(In.IOS_INTERRUPTION_START)),(Fn()||ar())&&(o||a)&&i&&(_.info("ios".concat(c,"-interruption-end")),Et.emit(In.IOS_INTERRUPTION_END)),t!==n&&Et.emit(In.STATE_CHANGE,n,t)},setInterval((()=>{var t;const n=(t=Li)===null||t===void 0?void 0:t.currentTime;Et.currentTime!==n?(Et.currentTimeStuckAt&&(_.debug("AudioContext current time resume at ".concat(n)),Et.currentTimeStuckAt=void 0),Et.currentTime=n):(n!==Et.currentTimeStuckAt&&(pe.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:Tt.TRACER}).onSuccess(),_.warning("AudioContext current time stuck at ".concat(n))),Et.currentTimeStuckAt=n)}),5e3),(async function(t){const n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,r,s=!1,o=!1,a=!1;function c(I){t.state==="running"?d(!1):Fn()||ar()?t.state==="suspended"&&(d(!0),I&&t.resume().then(l,l)):t.state!=="closed"&&(d(!0),I&&t.resume().then(l,l))}function d(I){if(s!==I){s=I;for(let A=0,N=n;A<N.length;A+=1){const k=N[A];I?window.addEventListener(k,u,{capture:!0,passive:!0}):window.removeEventListener(k,u,{capture:!0,passive:!0})}}}function l(){c(!1)}function u(){c(!0)}function h(){let I;try{I=i.play(),I?I.then(T,T):(i.addEventListener("playing",T),i.addEventListener("abort",T),i.addEventListener("error",T))}catch{T()}}function p(I){a||(i.paused?I?(R(!1),a=!0,h()):R(!0):R(!1))}function R(I){if(o!==I){o=I;for(let A=0,N=n;A<N.length;A++){const k=N[A];I?window.addEventListener(k,y,{capture:!0,passive:!0}):window.removeEventListener(k,y,{capture:!0,passive:!0})}}}function T(){i.removeEventListener("playing",T),i.removeEventListener("abort",T),i.removeEventListener("error",T),a=!1,p(!1)}function y(){p(!0)}if(Fn()&&b("IOS_BG_TAG")){const I=t.createMediaStreamDestination(),A=document.createElement("div");A.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=A.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=I.stream,r=()=>{if(b("IOS_AUTO_RESTART_BG_TAG")&&i&&i.srcObject&&!a&&(!i.paused||o!==!0)){i.paused||i.pause();try{a=!0,h()}catch{a=!1}return!0}},p(!0)}return Et.on(In.STATE_CHANGE,(function(){c(!0)})),c(!1),r})(Li).then((t=>{qE=t}))})(),!Li)throw new F(w.NOT_SUPPORTED,"can not create audio context");return Li}return Li}function ta(e){if((function(){if(XE!==null)return XE;const i=yc(),r=i.createBufferSource(),s=i.createGain(),o=i.createGain();r.connect(s),r.connect(o),r.disconnect(s);let a=!1;try{r.disconnect(s)}catch{a=!0}return r.disconnect(),XE=a,a})())return;const t=e.connect,n=e.disconnect;e.connect=(i,r,s)=>{var o;return e._inputNodes||(e._inputNodes=[]),X(o=e._inputNodes).call(o,i)||(i instanceof AudioNode?(e._inputNodes.push(i),t.call(e,i,r,s)):t.call(e,i,r)),e},e.disconnect=(i,r,s)=>{n.call(e),i?fh(e._inputNodes,i):e._inputNodes=[];for(const o of e._inputNodes)t.call(e,o)}}let XE=null;function JE(e,t){let n=!1;const i=1/t;if(b("DISABLE_WEBAUDIO")){const r=window.setInterval((()=>{n?window.clearInterval(r):e(performance.now()/1e3)}),1e3*i)}else{const r=yc();let s=r.createGain();s.gain.value=0,s.connect(r.destination);const o=()=>{if(n)return void(s=null);const a=r.createOscillator();a.onended=o,a.connect(s),a.start(0),a.stop(r.currentTime+i),e(r.currentTime)};o()}return()=>{n=!0}}class bA{constructor(){j(this,"context",void 0),j(this,"analyserNode",void 0),j(this,"sourceNode",void 0),this.context=yc(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t?.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Fn()||ar()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const i=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(i);for(let r=0;r<t.length;++r)t[r]=i[r]/128-1}const n=Bi(t).call(t,((i,r)=>i+r*r),0)/t.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,n;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode)}catch{_.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class IA extends kt{get processSourceNode(){return this.sourceNode}set processedNode(t){var n;if(!this.isDestroyed&&this._processedNode!==t){try{var i;(i=this.sourceNode)===null||i===void 0||i.disconnect(this.outputNode)}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),j(this,"outputNode",void 0),j(this,"outputTrack",void 0),j(this,"isPlayed",!1),j(this,"sourceNode",void 0),j(this,"context",void 0),j(this,"audioBufferNode",void 0),j(this,"destNode",void 0),j(this,"audioOutputLevel",0),j(this,"volumeLevelAnalyser",void 0),j(this,"_processedNode",void 0),j(this,"playNode",void 0),j(this,"isDestroyed",!1),j(this,"onNoAudioInput",void 0),j(this,"isNoAudioInput",!1),j(this,"_noAudioInputCount",0),this.context=yc(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),ta(this.outputNode),this.volumeLevelAnalyser=new bA}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(Di.ON_AUDIO_BUFFER,(function(i){for(let r=0;r<i.outputBuffer.numberOfChannels;r+=1){const s=i.outputBuffer.getChannelData(r);for(let o=0;o<s.length;o+=1)s[o]=0}return i.inputBuffer})(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!We().webAudioMediaStreamDest)throw new F(w.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&_h((()=>{Et.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Fn()||ar()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const n=this.volumeLevelAnalyser.getAnalyserNode();let i;n.getFloatTimeDomainData?(i=new Float32Array(n.fftSize),n.getFloatTimeDomainData(i)):(i=new Uint8Array(n.fftSize),n.getByteTimeDomainData(i));let r=!1;for(let s=0;s<i.length;s++)i[s]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await hn(200),await this.checkHasAudioInput(t?t+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,n;(t=this.processedNode)===null||t===void 0||t.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class QE extends IA{get isFreeze(){return!1}constructor(t,n,i){var r;if(super(),j(this,"sourceNode",void 0),j(this,"track",void 0),j(this,"clonedTrack",void 0),j(this,"audioElement",void 0),j(this,"isCurrentTrackCloned",!1),j(this,"isRemoteTrack",!1),j(this,"originVolumeLevelAnalyser",void 0),j(this,"rebuildWebAudio",(async()=>{if(_.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void _.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>_.info("resume success"))),_.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;const c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),ta(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),ta(this.outputNode),this.emit(Di.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),t.kind!=="audio")throw new F(w.UNEXPECTED_ERROR);this.track=t;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(s),ta(this.sourceNode),i){const a=i.clone();a.enabled=!0,this.clonedTrack=a,_.debug("create an unmuted track ".concat(a.id," from the original track ").concat(i.id," to get the volume"));const c=this.context.createMediaStreamSource(new MediaStream([a]));ta(c),this.originVolumeLevelAnalyser=new bA,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const o=Ze();n&&o.os===un.IOS&&Number((r=o.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(Et.on(In.STATE_CHANGE,(()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const n=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(n),ta(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Di.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),Et.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const n=t.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),_.debug("create an unmuted track ".concat(n.id," from the original track ").concat(t.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([n]));ta(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function wA(e,t,n){const i=(s,o)=>s?typeof s!="number"?s.max||s.exact||s.ideal||s.min||o:s:o,r={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:i(t.height,1080),maxWidth:i(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(r.video.mandatory.maxFrameRate=t.frameRate.max,r.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(r.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function y6(e,t){const n=await AA(e.mediaSource),{sourceId:i,audio:r}=await(function(s){let o=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new ie(((a,c)=>{const d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const l=document.createElement("div");l.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const u=document.createElement("div");u.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",u.setAttribute("style","height: 12%;");const h=document.createElement("div");h.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const p=document.createElement("div");p.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const R=document.createElement("button");R.innerHTML="cancel",R.setAttribute("style","width: 85px;"),R.onclick=()=>{document.body.removeChild(I);const A=new Error("NotAllowedError");A.name="NotAllowedError",c(A)};let T=o;const y=document.createElement("div");if(o){const A=document.createElement("input");A.setAttribute("type","checkbox");const N=document.createElement("span");A.setAttribute("style","margin-right: 6px;"),N.innerText="Share audio",A.checked=T,A.onchange=()=>{T=A.checked},y.appendChild(A),y.appendChild(N)}p.appendChild(y),p.appendChild(R),l.appendChild(u),l.appendChild(h),l.appendChild(p);const I=document.createElement("div");I.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),I.appendChild(d),I.appendChild(l),document.body.appendChild(I),s.map((A=>{if(A.id){const N=document.createElement("div");N.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let k=A.thumbnail;try{const{width:x}=k.getSize();x>1920&&(k=k.resize({width:1920}))}catch(x){throw x&&x.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),x}N.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+k.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+A.name.replace(/[\u00A0-\u9999<>\&]/g,(function(x){return"&#"+x.charCodeAt(0)+";"}))+"</span>",N.onclick=()=>{document.body.removeChild(I),a({sourceId:A.id,audio:T})},h.appendChild(N)}}))}))})(n,t);return await wA(i,e,r)}async function AA(e){let t=["window","screen"];e!=="application"&&e!=="window"||(t=["window"]),e==="screen"&&(t=["screen"]);const n=Vw();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new F(w.ELECTRON_IS_NULL);let i=null;try{var r;i=((r=n.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:t}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{i=null}i&&i.then||(i=new ie(((s,o)=>{n.desktopCapturer.getSources({types:t},((a,c)=>{a?o(a):s(c)}))})));try{return await i}catch(s){throw new F(w.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,s.toString())}}const ZE=new gn("safari");let OA=!1,NA=!1;async function ki(e,t){let n=0,i=null;for(;n<2;)try{i=await v6(e,t,n>0);break}catch(r){if(r instanceof F)throw _.error("[".concat(t,"] ").concat(r.toString())),r;const s=Oh(r.name||r.code||r,r.message);if(s.code===w.MEDIA_OPTION_INVALID){_.debug("[".concat(t,"] detect media option invalid, retry")),n+=1,await hn(500);continue}throw _.error("[".concat(t,"] ").concat(s.toString())),s}if(!i)throw new F(w.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function v6(e,t,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new F(w.NOT_SUPPORTED,"can not find getUserMedia");n&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const i=We(),r=new MediaStream;if(e.audioSource&&r.addTrack(e.audioSource),e.videoSource&&r.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return _.debug("Using Video Source/ Audio Source"),r;if(e.screen)if(Vw())e.screen.sourceId?vc(r,await wA(e.screen.sourceId,e.screen,!!e.screenAudio)):vc(r,await y6(e.screen,!!e.screenAudio));else if(Os()&&e.screen.extensionId&&e.screen.mandatory){if(!i.getStreamFromExtension)throw new F(w.NOT_SUPPORTED,"This browser does not support screen sharing");_.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const h=await(o=e.screen.extensionId,a=t,new ie(((p,R)=>{try{chrome.runtime.sendMessage(o,{getStream:!0},(T=>{if(!T||!T.streamId)return _.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),T),void R(new F(w.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));p(T.streamId)}))}catch(T){_.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(o,")"),T.toString()),R(new F(w.CHROME_PLUGIN_NOT_INSTALL))}})));e.screen.mandatory.chromeMediaSourceId=h,vc(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(i.getDisplayMedia){var s;e.screen.mediaSource&&SA(e.screen.mediaSource);const h={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:(s=e.screen.displaySurface)!==null&&s!==void 0?s:e.screen.mediaSource==="screen"?"monitor":e.screen.mediaSource},{selfBrowserSurface:p,surfaceSwitching:R,systemAudio:T,preferCurrentTab:y,windowAudio:I,monitorTypeSurfaces:A}=e.screen,N={selfBrowserSurface:p,surfaceSwitching:R,systemAudio:T,preferCurrentTab:y,windowAudio:I,monitorTypeSurfaces:A};!p&&delete N.selfBrowserSurface,!R&&delete N.surfaceSwitching,!T&&delete N.systemAudio,!y&&delete N.preferCurrentTab,!I&&delete N.windowAudio,!A&&delete N.monitorTypeSurfaces,_.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:h,audio:e.screenAudio,controls:N})),vc(r,await navigator.mediaDevices.getDisplayMedia(bt({video:h,audio:e.screenAudio},N)))}else{if(!It())throw _.error("[".concat(t,"] This browser does not support screenSharing")),new F(w.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&SA(e.screen.mediaSource);const h={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};_.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(h))),vc(r,await navigator.mediaDevices.getUserMedia(h))}}var o,a;if(!e.video&&!e.audio)return r;let c={video:e.video,audio:e.audio},d=b("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=IE(c,d)}catch{}_.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(c)),Ze();let l,u=null;(En()||Fn()||mh())&&(u=await ZE.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(h){throw u&&u(),h}return c.audio&&(OA=!0),c.video&&(NA=!0),vc(r,l),u&&u(),r}function Oh(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new F(w.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new F(w.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new F(w.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new F(w.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new F(w.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new F(w.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return _.error("getUserMedia unexpected error",e),new F(w.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function vc(e,t){const n=e.getVideoTracks()[0],i=e.getAudioTracks()[0],r=t.getVideoTracks()[0],s=t.getAudioTracks()[0];s&&(i&&e.removeTrack(i),e.addTrack(s)),r&&(n&&e.removeTrack(n),e.addTrack(r))}const xi=new class extends kt{get state(){return this._state}set state(e){e!==this._state&&(this.emit(ea.STATE_CHANGE,e),this._state=e)}constructor(){super(),j(this,"_state",zd.IDLE),j(this,"isAccessMicrophonePermission",!1),j(this,"isAccessCameraPermission",!1),j(this,"lastAccessMicrophonePermission",!1),j(this,"lastAccessCameraPermission",!1),j(this,"checkdeviceMatched",!1),j(this,"deviceInfoMap",new Map),this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(b("ENUMERATE_DEVICES_INTERVAL")||(Vd()||ph()===un.HARMONY_OS)&&is())&&this.updateDevicesInfo()}),b("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((e=>_.error(e.toString())))}async enumerateDevices(e,t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw new F(w.NOT_SUPPORTED,"enumerateDevices() not supported.");const i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i);let s=!this.isAccessMicrophonePermission&&e,o=!this.isAccessCameraPermission&&t;r.audio&&(s=!1),r.video&&(o=!1);let a=null,c=null,d=null;if(!n&&(s||o)){if(ZE.isLocked&&(_.debug("[device manager] wait GUM lock"),(await ZE.lock())(),_.debug("[device manager] GUM unlock")),OA&&(s=!1,this.isAccessMicrophonePermission=!0),NA&&(o=!1,this.isAccessCameraPermission=!0),_.debug("[device manager] check media device permissions",e,t,s,o),s&&o){try{d=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(l){const u=Oh(l.name||l.code||l,l.message);if(u.code===w.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(s){try{a=await navigator.mediaDevices.getUserMedia({audio:e})}catch(l){const u=Oh(l.name||l.code||l,l.message);if(u.code===w.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u)}this.isAccessMicrophonePermission=!0}else if(o){try{c=await navigator.mediaDevices.getUserMedia({video:t})}catch(l){const u=Oh(l.name||l.code||l,l.message);if(u.code===w.PERMISSION_DENIED)throw u;_.warning("getUserMedia failed in getDevices",u)}this.isAccessCameraPermission=!0}_.debug("[device manager] mic permission",e,"cam permission",t)}try{const l=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach((u=>u.stop())),c&&c.getTracks().forEach((u=>u.stop())),d&&d.getTracks().forEach((u=>u.stop())),a=null,c=null,d=null,l}catch(l){return a&&a.getTracks().forEach((u=>u.stop())),c&&c.getTracks().forEach((u=>u.stop())),d&&d.getTracks().forEach((u=>u.stop())),a=null,c=null,d=null,new F(w.ENUMERATE_DEVICES_FAILED,l.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((t=>t.kind==="audioinput"))}async getCamerasDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter((t=>t.kind==="videoinput"))}async getSpeakers(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((t=>t.kind==="audiooutput"))}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach((n=>{n.device.label===e&&(t=n.device.deviceId)})),t}async getDeviceById(e){const t=(await this.enumerateDevices(!0,!0,!0)).find((n=>n.deviceId===e));if(!t)throw new F(w.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=zd.INITING;try{await this.updateDevicesInfo(),this.state=zd.INITEND}catch(e){throw this.state=zd.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")?(_.warning("Device Detection functionality cannot start properly.",e.toString()),e):new F(w.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.")}}async updateDevicesInfo(){const e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),n=[];if(e[0]&&e[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const r=e.find((o=>o.kind==="audioinput"&&o.deviceId==="default")),s=e.find((o=>o.kind==="audiooutput"&&o.deviceId==="default"));r&&s?s.groupId===r.groupId?_.debug("[device-check] default input ".concat(r.label," and output ").concat(s.label," is the same group")):_.debug("[device-check] default input ".concat(r.label," and output ").concat(s.label," is not the same group")):_.debug("[device-check] default input or output not found")}const i=this.checkMediaDeviceInfoIsOk(e);if(e.forEach((r=>{if(!r.deviceId)return;const s=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((s?s.state:"INACTIVE")!=="ACTIVE"){const o={initAt:t,updateAt:t,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),o),n.push(o)}s&&(s.updateAt=t)})),this.deviceInfoMap.forEach(((r,s)=>{r.state==="ACTIVE"&&r.updateAt!==t&&(r.state="INACTIVE",n.push(r))})),this.state!==zd.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach((r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(ea.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(ea.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(ea.PLAYOUT_DEVICE_CHANGED,r)}})),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){const t=e.filter((r=>r.kind==="audioinput")),n=e.filter((r=>r.kind==="videoinput")),i={audio:!1,video:!1};for(const r of t)if(r.label&&r.deviceId){i.audio=!0;break}for(const r of n)if(r.label&&r.deviceId){i.video=!0;break}return i}};let $E=!1;const si=new class extends kt{constructor(){super(...arguments),j(this,"onAutoplayFailed",void 0),j(this,"onAudioAutoplayFailed",void 0)}};function DA(){if($E)return b("FLS_AUTOPLAY_EMITS")?(si.onAutoplayFailed&&si.onAutoplayFailed(),si.emit("autoplay-failed")):void 0;{const e=t=>{t.preventDefault(),$E=!1,jd()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};$E=!0,jd()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),_.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),si.onAutoplayFailed?si.onAutoplayFailed():si.onAudioAutoplayFailed?_.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):_.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),si.emit("autoplay-failed")}}function PA(e,t,n,i){if(!e)return;const r=pe.getBaseInfoBySessionId(e);if(!r)return;const s=r.info,o=Date.now(),a=bt(bt({},s),{},{vid:s.vid===void 0?0:Number(s.vid),lts:o,elapse:o-r.startTime,cbRegistered:si.onAutoplayFailed||si.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:t,trackId:i,extend:void 0});pe.send({type:Dt.AUTOPLAY_FAILED,data:a},!0)}const R6=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Gn=new class{constructor(){j(this,"onAutoplayFailed",void 0),j(this,"elementMap",new Map),j(this,"elementStateMap",new Map),j(this,"elementsNeedToResume",[]),j(this,"sinkIdMap",new Map),j(this,"autoResumeAfterInterruption",(e=>ie.all(Array.from(this.elementMap.entries()).map((async t=>{let[n,i]=t;const r=this.elementStateMap.get(n),s=i.srcObject.getAudioTracks()[0],o=s&&s.readyState;if(_.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(o," ").concat(e)),o==="live"){if(e)return i.pause(),i.play();if(Et.curState==="running")return cc()?(i.pause(),i.play()):r&&r==="paused"?i.play():void 0}}))))),j(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{Array.from(this.elementMap.entries()).forEach((e=>{let[t,n]=e;const i=n.srcObject.getAudioTracks()[0];i&&i.readyState==="live"&&(_.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())}))})),this.autoResumeAudioElement(),Et.on(In.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Et.on(In.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Et.on(In.STATE_CHANGE,(()=>{Fn()&&Et.prevState==="suspended"&&Et.curState==="running"&&this.autoResumeAfterInterruption()}))}async setSinkID(e,t){const n=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),n)try{await n.setSinkId(t)}catch(i){throw new F(w.PERMISSION_DENIED,"can not set sink id: "+i.toString())}}play(e,t,n,i){if(this.elementMap.has(t))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,r),this.elementMap.set(t,r),this.elementStateMap.set(t,Ln.INIT),this.setVolume(t,n);const s=this.sinkIdMap.get(t);if(s)try{r.setSinkId(s).catch((a=>{_.warning("[".concat(t,"] set sink id failed"),a.toString())}))}catch(a){_.warning("[".concat(t,"] set sink id failed"),a.toString())}const o=r.play();o&&o.then&&o.catch((a=>{i&&PA(i,"audio",a.message,t),_.warning("audio element play warning",a.toString()),this.elementMap.has(t)&&a.name==="NotAllowedError"&&(_.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),_h((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),DA()})))}))}updateTrack(e,t){const n=this.elementMap.get(e);n&&(n.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&this.elementStateMap.get(e)==="playing"}setVolume(e,t){const n=this.elementMap.get(e);n&&(t=Math.max(0,Math.min(100,t)),n.volume=t/100)}getVolume(e){const t=this.elementMap.get(e);return t?t.volume:0}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const n=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(n,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){R6.forEach((n=>{t.addEventListener(n,(i=>{const r=this.elementStateMap.get(e),s=i.type==="pause"?"paused":i.type;if(_.debug("[".concat(e,"] audio-element-status change ").concat(r," => ").concat(s)),i.type==="error"){const o=t?.error;o&&_.error("[".concat(e,"] media error, code: ").concat(o.code,", message: ").concat(o.message))}this.elementStateMap.set(e,s)}))}))}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach((t=>{t.play().then((n=>{_.debug("Auto resume audio element success")})).catch((n=>{_.warning("Auto resume audio element failed!",n)}))})),this.elementsNeedToResume=[]};new ie((t=>{document.body?t():window.addEventListener("load",(()=>t()))})).then((()=>{jd()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))}))}};function Bt(){return function(e,t,n){const i=n.value;return typeof i=="function"&&(n.value=function(){this._isClosed&&new F(w.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",_);for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];const a=i.apply(this,s);return a instanceof ie?new ie(((c,d)=>{a.then(c).catch(d)})):a}),n}}class LA extends kt{constructor(t){super(),j(this,"name","VideoProcessorDestination"),j(this,"ID","0"),j(this,"_source",void 0),j(this,"videoContext",void 0),j(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new F(w.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new F(w.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(Qn.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Qn.ON_TRACK,void 0)}}class kA extends kt{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,n){super(),j(this,"constraintsMap",new Map),j(this,"statsRegistry",[]),j(this,"usageRegistry",[]),j(this,"trackId",void 0),j(this,"direction",void 0),j(this,"_chained",!1),this.trackId=t,this.direction=n}async getConstraints(){return await en(this,Pi.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,n){var i;return _.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(n,t),vt(this,Pi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Si(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var n;if(this.constraintsMap.has(t))return _.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),vt(this,Pi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Si(n=this.constraintsMap).call(n)))}registerStats(t,n,i){this.statsRegistry.find((r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n))||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:n,cb:i})}unregisterStats(t,n){const i=this.statsRegistry.findIndex((r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n));i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:n,processorName:i,type:r,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:n,processorName:i,type:r,stats:o})}catch(o){_.error(new F(w.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,n){this.usageRegistry.find((i=>i.processorID===t.ID&&i.processorName===t.name))||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:n})}unregisterUsage(t){const n=this.usageRegistry.findIndex((i=>i.processorID===t.ID&&i.processorName===t.name));n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof ie&&(i=await i),t.push(bt(bt({},i),{},{direction:this.direction}))}catch(i){_.error("gather extension usage error",i)}return t}getDirection(){return this.direction}}class xA extends kt{constructor(t){super(),j(this,"name","AudioProcessorDestination"),j(this,"ID","0"),j(this,"inputTrack",void 0),j(this,"inputNode",void 0),j(this,"audioProcessorContext",void 0),j(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new F(w.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new F(w.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Qn.ON_TRACK,void 0),this.emit(Qn.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(Qn.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(Qn.ON_NODE,this.inputNode))}}class MA extends kt{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,n,i){super(),j(this,"constraintsMap",new Map),j(this,"statsRegistry",[]),j(this,"audioContext",void 0),j(this,"trackId",void 0),j(this,"direction",void 0),j(this,"usageRegistry",[]),j(this,"_chained",!1),this.audioContext=t,this.trackId=n,this.direction=i}async getConstraints(){return en(this,Pi.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,n){var i;return _.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(n,t),vt(this,Pi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Si(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var n;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),vt(this,Pi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Si(n=this.constraintsMap).call(n)))}registerStats(t,n,i){this.statsRegistry.find((r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n))||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:n,cb:i})}unregisterStats(t,n){const i=this.statsRegistry.findIndex((r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n));i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:n,processorName:i,type:r,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:n,processorName:i,type:r,stats:o})}catch(o){_.error(new F(w.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,n){this.usageRegistry.find((i=>i.processorID===t.ID&&i.processorName===t.name))||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:n})}unregisterUsage(t){const n=this.usageRegistry.findIndex((i=>i.processorID===t.ID&&i.processorName===t.name));n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof ie&&(i=await i),t.push(bt(bt({},i),{},{direction:this.direction}))}catch(i){_.error("gather extension usage error",i)}return t}getDirection(){return this.direction}}class eg extends kt{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),j(this,"context",void 0),j(this,"processSourceNode",void 0),j(this,"outputTrack",void 0),j(this,"processedNode",void 0),j(this,"clonedTrack",void 0),j(this,"outputNode",void 0),this.outputNode=new C6}setVolume(){}createOutputTrack(){throw new F(w.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class C6{disconnect(){}connect(){}}function UA(e){return new ie(((t,n)=>{let i=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const s=Fn()?"canplay":"playing";r.addEventListener(s,(()=>{const o=r.videoWidth,a=r.videoHeight;!o&&It()||(i=!0,r.srcObject=null,r.remove(),t([o,a]))})),r.srcObject=new MediaStream([e]),r.play().catch(Wd),setTimeout((()=>{i||(r.srcObject=null,r.remove(),t([r.videoWidth,r.videoHeight]))}),4e3)}))}function Nh(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const n=hr(e.encoderConfig);return n.width!=null&&(t.width=n.width),n.height!=null&&(t.height=n.height),!Nw()&&n.frameRate&&(t.frameRate=n.frameRate),vw()&&typeof t.frameRate=="object"&&(t.frameRate.max=60),It()&&(t.frameRate={ideal:30,max:30}),t}function VA(e){const t={};return Nw()||(e.AGC!==void 0&&(t.autoGainControl=e.AGC),e.AEC!==void 0&&(t.echoCancellation=e.AEC),e.ANS!==void 0&&(t.noiseSuppression=e.ANS,Os()&&e.ANS&&(t.googHighpassFilter=e.ANS))),t}function jA(e){const t=VA(e);if(e.encoderConfig){const n=wh(e.encoderConfig);t.channelCount=n.stereo?2:1,t.sampleRate=n.sampleRate,t.sampleSize=n.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),Vd()&&(t.sampleRate=void 0),t}const FA=e=>{const t=e._encoderConfig;if(!t)return;const{frameRate:n,width:i,height:r}=e.getMediaStreamTrackSettings();let{frameRate:s=n,width:o=i,height:a=r}=t;if(!s||!o||!a)return;o=uc(o),a=uc(a),s=uc(s);const{max:c,min:d}=(function(p,R,T){const y=200*Math.pow(T/15,.6)*Math.pow(p*R/640/360,.75);return{min:Math.floor(y),max:Math.floor(4*y)}})(o,a,s),{bitrateMax:l,bitrateMin:u}=t||{};l||_.debug("calculate bitrate: [w: ".concat(o,", h: ").concat(a,", fps: ").concat(s,"] => [brMax: ").concat(l,", brMin: ").concat(u,"]"));const{maxFramerate:h}=b("ENCODER_CONFIG_LIMIT");return h&&typeof h=="number"&&(s=Math.min(s,h)),{frameRate:s,bitrateMax:l||c,bitrateMin:u||d,scaleResolutionDownBy:1,scale:0}},BA=async(e,t,n)=>await(async(i,r,s)=>{const o=(function(d){const l=[];for(let u=0;u<d.length;u+=2)l.push(parseInt(d.slice(u,u+2),16));return Uint8Array.from(l)})(Jw(""+r+s)).slice(0,16),a=o.slice(0,12),c=await window.crypto.subtle.importKey("raw",o,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,i))})(e.buffer,t,n),tg=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new ie(((n,i)=>{t.toBlob((async r=>{if(t.remove(),r){const s=await WA(r);n({buffer:s,width:t.width,height:t.height})}else i(new F(w.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,1)}))},WA=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)};var GA,HA,KA,YA,zA,qA,XA,JA,QA,ZA,$A,e0,t0,n0,i0,r0,s0,o0,Ut,a0,c0,d0,l0,u0,h0,os,p0,m0,f0,_0,E0,g0,S0,T0,y0,v0,R0,C0,b0,Dn;let Wt=(GA=ve({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),HA=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),KA=Bt(),YA=hc("LocalAudioTrack","_enabledMutex"),zA=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),qA=Bt(),XA=hc("LocalAudioTrack","_enabledMutex"),JA=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),QA=Bt(),ZA=Bt(),$A=Bt(),e0=ve({argsMap:e=>[e.getTrackId()]}),t0=Bt(),n0=ve({argsMap:e=>[e.getTrackId()]}),i0=Bt(),r0=ve({argsMap:e=>[e.getTrackId()]}),s0=ve({argsMap:(e,t)=>[e.getTrackId(),t.name]}),o0=ve({argsMap:e=>[e.getTrackId()]}),ze((Ut=class extends Tc{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?Gn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,n,i){super(e,n),j(this,"trackMediaType",Sc.AUDIO),j(this,"_encoderConfig",void 0),j(this,"_trackSource",void 0),j(this,"metadata",[]),j(this,"_enabled",!0),j(this,"_volume",100),j(this,"_useAudioElement",!0),j(this,"_bypassWebAudio",!1),j(this,"processor",void 0),j(this,"_processorContext",void 0),j(this,"_processorDestination",void 0),j(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!i,this._trackSource=new eg,b("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),b("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),En()&&!Li?setTimeout((()=>this.initWebAudio())):this.initWebAudio()}setVolume(e){St(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&Gn.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void _.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,vt(this,me.NEED_REPLACE_TRACK,this).then((()=>{_.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((n=>{_.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)})))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!mA())throw new F(w.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Gn.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,n){return this._setEnabled(e,t,n)}async _setEnabled(e,t,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await vt(this,me.NEED_ENABLE_TRACK,this),_.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(i){throw n||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await vt(this,me.NEED_DISABLE_TRACK,this)}catch(i){throw n||(this._enabled=!0),_.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await vt(this,me.NEED_MUTE_TRACK,this):await vt(this,me.NEED_UNMUTE_TRACK,this))}getStats(){return io((()=>{_.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning"),vi(this,me.GET_STATS)||bt({},KE)}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Di.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Di.ON_AUDIO_BUFFER),this._source.on(Di.ON_AUDIO_BUFFER,(n=>e(n)))}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Gn.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Gn.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Gn.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await vt(this,me.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return ie.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new F(w.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new F(w.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(e){e.on(Qn.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await vt(this,me.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await vt(this,me.NEED_REPLACE_TRACK,this))})),e.on(Qn.ON_NODE,(t=>{this._source.processedNode=t}))}unbindProcessorDestinationEvents(e){e.removeAllListeners(Qn.ON_TRACK),e.removeAllListeners(Qn.ON_NODE)}bindProcessorContextEvents(e){e.on(Pi.REQUEST_CONSTRAINTS,(async t=>{t(this._originMediaStreamTrack.getSettings())}))}unbindProcessorContextEvents(e){e.removeAllListeners(Pi.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof eg&&(this._trackSource=new QE(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new MA(this._source.context,this.getTrackId(),"local"),t=new xA(e);return this._processorContext=e,this._processorDestination=t,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(t),this._source.on(Di.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})})),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(Gn.stop(this.getTrackId()),this._source.play()),vt(this,me.NEED_REPLACE_MIXING_TRACK,this).then((()=>{_.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))})).catch((n=>{_.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n)}))),{processorContext:e,processorDestination:t}}}).prototype,"setVolume",[GA],Object.getOwnPropertyDescriptor(Ut.prototype,"setVolume"),Ut.prototype),ze(Ut.prototype,"setPlaybackDevice",[HA,KA],Object.getOwnPropertyDescriptor(Ut.prototype,"setPlaybackDevice"),Ut.prototype),ze(Ut.prototype,"setEnabled",[YA,zA,qA],Object.getOwnPropertyDescriptor(Ut.prototype,"setEnabled"),Ut.prototype),ze(Ut.prototype,"setMuted",[XA,JA,QA],Object.getOwnPropertyDescriptor(Ut.prototype,"setMuted"),Ut.prototype),ze(Ut.prototype,"getStats",[ZA],Object.getOwnPropertyDescriptor(Ut.prototype,"getStats"),Ut.prototype),ze(Ut.prototype,"setAudioFrameCallback",[$A],Object.getOwnPropertyDescriptor(Ut.prototype,"setAudioFrameCallback"),Ut.prototype),ze(Ut.prototype,"play",[e0,t0],Object.getOwnPropertyDescriptor(Ut.prototype,"play"),Ut.prototype),ze(Ut.prototype,"stop",[n0,i0],Object.getOwnPropertyDescriptor(Ut.prototype,"stop"),Ut.prototype),ze(Ut.prototype,"close",[r0],Object.getOwnPropertyDescriptor(Ut.prototype,"close"),Ut.prototype),ze(Ut.prototype,"pipe",[s0],Object.getOwnPropertyDescriptor(Ut.prototype,"pipe"),Ut.prototype),ze(Ut.prototype,"unpipe",[o0],Object.getOwnPropertyDescriptor(Ut.prototype,"unpipe"),Ut.prototype),Ut),qd=(a0=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),c0=Bt(),d0=hc("MicrophoneAudioTrack","_enabledMutex"),l0=ve({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),u0=Bt(),h0=ve({argsMap:e=>[e.getTrackId()]}),ze((os=class extends Wt{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,n,i){super(e,t.encoderConfig?wh(t.encoderConfig):{},i,b("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),j(this,"_config",void 0),j(this,"_deviceName","default"),j(this,"_constraints",void 0),j(this,"_originalConstraints",void 0),j(this,"_enabled",!0),this._config=t,this._constraints=n,this._originalConstraints=n,this._deviceName=e.label,typeof t.bypassWebAudio=="boolean"&&(this._bypassWebAudio=t.bypassWebAudio),(cc()||gE())&&Et.bindInterruptDetectorTrack(this)}async setDevice(e){if(_.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await xi.getDeviceById(e),n={};n.audio=bt({},this._constraints),n.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let i=null;try{i=await ki(n,this.getTrackId())}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),i=await ki({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const t=await xi.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}_.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,n){if(t)return _.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),b("AUTO_RESET_AUDIO_ROUTE")&&(Fn()||ar())){const o=navigator.audioSession;o&&(e||(o.type="playback"),o.type="auto")}if(!e){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(i=this._source.clonedTrack)===null||i===void 0||i.stop(),n||(this._enabled=!1);try{await vt(this,me.NEED_DISABLE_TRACK,this)}catch(o){throw _.error("[".concat(this.getTrackId(),"] setEnabled false failed"),o.toString()),o}return}const r=bt({},this._constraints),s=xi.searchDeviceIdByName(this._deviceName);s&&!r.deviceId&&(r.deviceId=s);try{n||(this._enabled=!0);const o=await ki({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(o.getAudioTracks()[0],!1),await vt(this,me.NEED_ENABLE_TRACK,this)}catch(o){throw n||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled true failed"),o.toString()),o}_.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(cc()||gE())&&Et.unbindInterruptDetectorTrack(this),Zo.some((e=>(function(t){return"__className__"in t&&t.__className__==="MicrophoneAudioTrack"})(e)))||qE&&qE()&&(pe.reportApiInvoke(null,{name:"BG_AUDIO_TAG_RESTART",options:{},tag:Tt.TRACER}).onSuccess(),_.debug("restart background audio tag success"))}onTrackEnded(){if((Fn()||ar())&&this._enabled&&!this._isClosed&&Et.duringInterruption){const e=async()=>{Et.off(In.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Et.on(In.IOS_INTERRUPTION_END,e)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(gc.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,n=xi.searchDeviceIdByName(this._deviceName);if(n&&!t.deviceId&&(t.deviceId=n),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const i=await ki({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(Pi.REQUEST_UPDATE_CONSTRAINTS,(async(t,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}}))}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(Pi.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[a0,c0],Object.getOwnPropertyDescriptor(os.prototype,"setDevice"),os.prototype),ze(os.prototype,"setEnabled",[d0,l0,u0],Object.getOwnPropertyDescriptor(os.prototype,"setEnabled"),os.prototype),ze(os.prototype,"close",[h0],Object.getOwnPropertyDescriptor(os.prototype,"close"),os.prototype),os),b6=(p0=ve({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),m0=Bt(),f0=ve({argsMap:e=>[e.getTrackId()]}),_0=Bt(),E0=ve({argsMap:e=>[e.getTrackId()]}),g0=Bt(),S0=ve({argsMap:e=>[e.getTrackId()]}),T0=Bt(),y0=ve({argsMap:e=>[e.getTrackId()]}),v0=Bt(),R0=ve({argsMap:e=>[e.getTrackId()]}),C0=ve({argsMap:e=>[e.getTrackId()]}),b0=Bt(),ze((Dn=class extends Wt{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,n,i){super(t.createOutputTrack(),n,i),j(this,"source",void 0),j(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=t,this._bufferSource.on(Di.AUDIO_SOURCE_STATE_CHANGE,(r=>{this.safeEmit(gc.SOURCE_STATE_CHANGE,r)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){St(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}).prototype,"startProcessAudioBuffer",[p0,m0],Object.getOwnPropertyDescriptor(Dn.prototype,"startProcessAudioBuffer"),Dn.prototype),ze(Dn.prototype,"pauseProcessAudioBuffer",[f0,_0],Object.getOwnPropertyDescriptor(Dn.prototype,"pauseProcessAudioBuffer"),Dn.prototype),ze(Dn.prototype,"seekAudioBuffer",[E0,g0],Object.getOwnPropertyDescriptor(Dn.prototype,"seekAudioBuffer"),Dn.prototype),ze(Dn.prototype,"resumeProcessAudioBuffer",[S0,T0],Object.getOwnPropertyDescriptor(Dn.prototype,"resumeProcessAudioBuffer"),Dn.prototype),ze(Dn.prototype,"stopProcessAudioBuffer",[y0,v0],Object.getOwnPropertyDescriptor(Dn.prototype,"stopProcessAudioBuffer"),Dn.prototype),ze(Dn.prototype,"close",[R0],Object.getOwnPropertyDescriptor(Dn.prototype,"close"),Dn.prototype),ze(Dn.prototype,"setAudioBufferPlaybackSpeed",[C0,b0],Object.getOwnPropertyDescriptor(Dn.prototype,"setAudioBufferPlaybackSpeed"),Dn.prototype),Dn);class sn extends Wt{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=yc().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,ut(8,"track-mix-")),j(this,"trackList",void 0),j(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(_.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):_.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){_.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}fh(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach((n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(t.stereo=!0))})),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach((n=>{n instanceof sn?n.emit($o.TRANSCEIVER_UPDATED,t):n._updateRtpTransceiver(t)})))}}class I6 extends IA{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(Di.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),j(this,"audioBuffer",void 0),j(this,"sourceNode",void 0),j(this,"startPlayTime",0),j(this,"startPlayOffset",0),j(this,"pausePlayTime",0),j(this,"options",void 0),j(this,"currentLoopCount",0),j(this,"currentPlaybackSpeed",100),j(this,"_currentState","stopped"),this.audioBuffer=t,this.options=n,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){this.currentState==="stopped"?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):_.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=t,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const I0=new Map;function w0(e,t){if(e.length===0||t.length===0)return 1/0;const n=AE(e),i=AE(t);return Math.floor(i/n)}class ng{get rendFrameRate(){const t=Math.max(1,w0(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/t)}get videoElementStatus(){return this._isInPage?this._videoElementStatus:Ln.DESTROYED}set videoElementStatus(t){t!==this._videoElementStatus&&(_.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}get videoState(){return this._videoState}set videoState(t){var n;t!==this._videoState&&(this._videoState=t,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState))}constructor(t){j(this,"trackId",void 0),j(this,"config",void 0),j(this,"onFirstVideoFrameDecoded",void 0),j(this,"onFirstVideoFrameRender",void 0),j(this,"onVideoBufferReady",void 0),j(this,"onVideoStateChanged",void 0),j(this,"freezeTimeCounterList",[]),j(this,"renderFreezeAccTime",0),j(this,"renderFreezeAccTime2",0),j(this,"isKeepLastFrame",!1),j(this,"isDestroyed",!1),j(this,"timeUpdatedCount",0),j(this,"freezeTime",0),j(this,"playbackTime",0),j(this,"lastTimeUpdatedTime",0),j(this,"autoplayFailed",!1),j(this,"videoTrack",void 0),j(this,"videoElement",void 0),j(this,"cacheVideoElement",void 0),j(this,"cancelRVFId",void 0),j(this,"internal",!1),j(this,"_render_interframe_delays",[]),j(this,"_render_interframe_delays_sizes",[]),j(this,"_videoState",ss.VideoStateStopped),j(this,"videoElementCheckInterval",void 0),j(this,"videoElementFreezeTimeout",void 0),j(this,"_videoElementStatus",Ln.NONE),j(this,"_isInPage",!0),j(this,"isGettingVideoDimensions",!1),j(this,"startGetVideoDimensions",(()=>{const n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return _.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()})),j(this,"autoResumeAfterInterruption",(()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Et.curState==="running"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Tw())),Aw()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),j(this,"handleVideoEvents",(n=>{switch(n.type){case"play":case"playing":n.type==="play"&&_.debug("[".concat(this.trackId,"] video element status: play")),this.startGetVideoDimensions(),this.videoElementStatus=Ln.PLAYING;break;case"loadeddata":if(this.videoState=ss.VideoStateStarting,this.onFirstVideoFrameRender&&this.onFirstVideoFrameRender(),this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Ln.CANPLAY;break;case"stalled":this.videoElementStatus=Ln.STALLED;break;case"suspend":this.videoElementStatus=Ln.SUSPEND;break;case"pause":this.videoElementStatus=Ln.PAUSED,Fn()||ar()||En()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Ln.WAITING;break;case"abort":this.videoElementStatus=Ln.ABORT;break;case"ended":this.videoElementStatus=Ln.ENDED;break;case"emptied":this.videoElementStatus=Ln.EMPTIED;break;case"error":{const i=this.videoElement.error;i&&(this.videoElementStatus=Ln.ERROR,_.error("[".concat(this.trackId,"] media error: ").concat(i.message," (").concat(i.code,")")));break}case"timeupdate":{const i=performance.now();if(this.timeUpdatedCount+=1,this.onVideoBufferReady&&this.timeUpdatedCount>b("BUFFER_READY_FRAMES")&&this.onVideoBufferReady(),this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=i);const r=i-this.lastTimeUpdatedTime,s=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=i,Ri.lastVisibleTime<Ri.lastHiddenTime||s<Ri.lastHiddenTime||s<Ri.lastVisibleTime||this.isSkipCalcRenderFreezeTime())return;for(r>b("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;const o=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(o),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}})),j(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(Tw())),Aw()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),Et.on(In.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Et.on(In.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const n=this.videoElement.play();n&&n.catch&&n.catch((r=>{t&&PA(t,"video",r.message,this.trackId),r.name==="NotAllowedError"?(_.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):_.warning("[".concat(this.trackId,"] play warning: "),r)}));const i=Ze();if((i.name==="Safari"&&Number(i.version)===15||cc())&&n&&n.then){const r=()=>{this.config.mirror&&!this.config.noStyle&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(r).catch(r)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const n=t.getContext("2d");if(!n)return _.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,t.width,t.height);const i=n.getImageData(0,0,t.width,t.height);return t.remove(),i}async getCurrentFrameToUint8Array(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const r=i.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,i.width,i.height),new ie(((s,o)=>{i.toBlob((async a=>{if(i.remove(),a){const c=await WA(a);s({buffer:c,width:i.width,height:i.height})}else o(new F(w.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),t,n<0?.1:n>1?1:n)}))):await tg(t)}destroy(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this.isDestroyed=!0,Et.off(In.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Et.off(In.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),t?this.videoElement.pause():this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=ss.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=Ln.INIT,!this.videoElementCheckInterval&&(A0.forEach((s=>{this.videoElement.addEventListener(s,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{this._isInPage=(function(s){return s!==document.body&&document.body.contains(s)})(this.videoElement)}),1e3),b("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,n;let s;const o=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",o),this.videoElementFreezeTimeout=window.setTimeout(a,b("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===ss.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=ss.VideoStateFrozen:document.addEventListener("visibilitychange",o))},c=(d,l)=>{if(this.videoElementStatus===Ln.PLAYING){if(s){const p=l.presentationTime-s.presentationTime,R=l.presentedFrames-s.presentedFrames;this._render_interframe_delays_sizes.push(R),this._render_interframe_delays.push(p);const T=AE(this._render_interframe_delays_sizes),y=T-this._render_interframe_delays_sizes[0];if(T>30&&y>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===ss.VideoStateStarting&&(this.videoState=ss.VideoStateDecoding),this.videoState===ss.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,b("VIDEO_FREEZE_DURATION"))),p<b("VIDEO_FREEZE_DURATION")&&this.videoState===ss.VideoStateFrozen&&(this.videoState=ss.VideoStateDecoding),p>b("VIDEO_FREEZE_DURATION")&&Ri.lastVisibleTime>=Ri.lastHiddenTime&&s.timestamp>Ri.lastVisibleTime&&s.timestamp>Ri.lastHiddenTime){const I=Math.min(66,w0(this._render_interframe_delays_sizes,this._render_interframe_delays)),A=Math.max(0,p-(R-1)*I);this.renderFreezeAccTime2+=A>I?A:0,this.renderFreezeAccTime+=p}}s=bt(bt({},l),{},{timestamp:d})}else this.isSkipCalcRenderFreezeTime()&&(s=bt(bt({},l),{},{timestamp:d}));var u,h;b("ENABLE_VIDEO_FRAME_CALLBACK")&&(this.cancelRVFId=(u=(h=this.videoElement).requestVideoFrameCallback)===null||u===void 0?void 0:u.call(h,c))};this.cancelRVFId=(t=(n=this.videoElement).requestVideoFrameCallback)===null||t===void 0?void 0:t.call(n,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Vd()&&!b("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const i=Ze();this.config.noStyle||(i.name==="Safari"&&Number(i.version)===15||cc()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover"),this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,It()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,It()&&this.videoElement.load());const r=this.videoElement.play();r!==void 0&&r.catch((s=>{_.debug("[".concat(this.trackId,"] playback interrupted"),s.toString())}))}resetVideoElement(){var t,n;A0.forEach((i=>{this.videoElement&&this.videoElement.removeEventListener(i,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.cancelRVFId&&this.videoElement&&((t=(n=this.videoElement).cancelVideoFrameCallback)===null||t===void 0||t.call(n,this.cancelRVFId),this.cancelRVFId=void 0),this.videoElementStatus=Ln.NONE}isSkipCalcRenderFreezeTime(){return this.videoElementStatus===Ln.DESTROYED||this.internal}handleAutoPlayFailed(){const t=n=>{n.preventDefault(),this.videoElement.play().then((()=>{_.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((i=>{_.error(i)})),this.autoplayFailed=!1,jd()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};jd()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),DA()}}const A0=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class Dh extends ng{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];super(t),j(this,"container",void 0),j(this,"slot",void 0),this.slot=t.element,this.internal=n,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const n=t.element;var i;!this.internal||this.slot?(n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()):(this.slot=n,n&&this.container?(this.internal=!1,this.container.id="agora-video-player-".concat(this.trackId),this.videoElement.id="video_".concat(this.trackId),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",(i=this.slot)===null||i===void 0||i.appendChild(this.container)):this.createElements())}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var n;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,i):await tg(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{var t;this.container.remove(),(t=this.slot)===null||t===void 0||t.removeChild(this.container)}catch{}this.container=void 0}}createElements(){var t;this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",b("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),(t=this.slot)===null||t===void 0||t.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var O0,N0,D0,P0,L0,k0,x0,M0,U0,V0,j0,F0,B0,W0,G0,H0,K0,Y0,z0,q0,X0,J0,Q0,Z0,$0,eO,tO,nO,Ge,iO,rO,sO,oO,aO,cO,dO,lO,Mi;let yt=(O0=ve({argsMap:(e,t,n)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),N0=Bt(),D0=ve({argsMap:e=>[e.getTrackId()]}),P0=hc("LocalVideoTrack","_enabledMutex"),L0=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),k0=Bt(),x0=hc("LocalVideoTrack","_enabledMutex"),M0=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),U0=Bt(),V0=ve({argsMap:(e,t)=>[e.getTrackId(),t,e._saveEncodeBitrateRatio]}),j0=Bt(),F0=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),B0=Bt(),W0=Bt(),G0=ve({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),H0=Bt(),K0=Bt(),Y0=Bt(),z0=ve({argsMap:e=>[e.getTrackId()]}),q0=Bt(),X0=Bt(),J0=Bt(),Q0=Bt(),Z0=Bt(),$0=ve({argsMap:(e,t)=>[e.getTrackId(),t.name]}),eO=ve({argsMap:e=>[e.getTrackId()]}),tO=ve({argsMap:e=>[e.getTrackId()]}),nO=ve({argsMap:(e,t,n)=>[e.getTrackId(),t.label,n]}),Ge=class Ok extends Tc{get videoHeight(){if(En()){const{height:t}=this._mediaStreamTrack.getSettings();return this._videoHeight=t,this._videoHeight}return this._videoHeight}get videoWidth(){if(En()){const{width:t}=this._mediaStreamTrack.getSettings();return this._videoWidth=t,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Ln.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,n,i,r,s,o){if(super(t,s),j(this,"trackMediaType",Sc.VIDEO),j(this,"_player",void 0),j(this,"isUseScaleResolutionDownBy",!1),j(this,"_videoVisibleTimer",null),j(this,"_previousVideoVisibleStatus",void 0),j(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),j(this,"_encoderConfig",void 0),j(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),j(this,"_optimizationMode",void 0),j(this,"_saveEncodeBitrateRatio",1),j(this,"_videoHeight",void 0),j(this,"_videoWidth",void 0),j(this,"_forceBitrateLimit",void 0),j(this,"_enabled",!0),j(this,"_processorDestination",void 0),j(this,"_processorContext",void 0),En()){const{width:a,height:c}=t.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=i,this._optimizationMode=r,this._hints=o||[],n&&this._hints.indexOf(ct.CUSTOM_TRACK)!==-1?this._encoderConfig=wt(n):this._encoderConfig=n,this._hints.indexOf(ct.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(fE(tt.CHROME,115)&&ph().indexOf("Windows")!==-1){const a=(function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&We().supportWebRTCInsertableStream){const l=new MediaStreamTrackProcessor(c),u=new MediaStreamTrackGenerator({kind:"video"});let h,p,R=Date.now();const T=()=>{y&&(clearInterval(y),y=void 0),h&&(h.close(),h=void 0),c.stop(),p=void 0,u.removeEventListener("ended",T)};let y=window.setInterval((()=>{if(p&&h&&Date.now()-R>1e3)try{u.readyState==="live"?p.enqueue(h.clone()):T()}catch{T()}}),1e3);const I=new TransformStream({transform:(A,N)=>{u.readyState==="live"?(p=N,R=Date.now(),h===void 0?(h=A,N.enqueue(A.clone())):(N.enqueue(h),h=A)):A.close()}});return u.addEventListener("ended",T),l.readable.pipeThrough(I).pipeTo(u.writable),u}})(t);a&&(_.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}n&&this._hints.indexOf(ct.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new kA(this.getTrackId(),"local"),this._processorDestination=new LA(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const r=document.getElementById(t);r?t=r:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const i=bt(bt(bt({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new ng(i):this._player=new Dh(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(gc.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}}),b("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await vt(this,me.NEED_DISABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}return n||(this._enabled=!1),void _.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await vt(this,me.NEED_ENABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await vt(this,me.NEED_MUTE_TRACK,this):await vt(this,me.NEED_UNMUTE_TRACK,this))}async setSaveEncodeBitrateRatio(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this._saveEncodeBitrateRatio;if(this._saveEncodeBitrateRatio!==1&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*t),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*t),_.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(t)),this._saveEncodeBitrateRatio=1;try{await vt(this,me.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(_)}}}async setEncoderConfiguration(t,n){if(!this._enabled)throw new F(w.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t=hr(t),b("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const i=Nh({encoderConfig:t});(En()||Fn()||ar())&&(i.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(r){const s=new F(w.UNEXPECTED_ERROR,r.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}}this._encoderConfig=t,this._hints.indexOf(ct.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await vt(this,me.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(_)}}getStats(){return io((()=>{_.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning"),vi(this,me.GET_STATS)||bt({},YE)}async setBeautyEffect(t){_.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,n):await tg(t)}async findClosestProfile(){const{width:t,height:n,frameRate:i}=this.getMediaStreamTrackSettings(),{width:r,height:s,frameRate:o}=this._encoderConfig||{},a=uc(this._videoWidth||t||r||0),c=uc(this._videoHeight||n||s||0),d=(function(l,u,h){if(!Array.isArray(b("VIDEO_ENCODER_CONFIG_LIST"))||b("VIDEO_ENCODER_CONFIG_LIST").length===0)return!1;const p=Math.min(l,u);return!(p>=480)&&bt(bt({},b("VIDEO_ENCODER_CONFIG_LIST").find((R=>R.height>p))),{},{frameRate:h})})(a,c,uc(i||o||15));if(d)return _.debug("[".concat(this.getTrackId(),"] find closest profile, ").concat(a,"x").concat(c," => ").concat(JSON.stringify(d))),this.setEncoderConfiguration(d)}async setBitrateLimit(t){_.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t&&(this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate))}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void _.error(w.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const n=this._optimizationMode;try{this._optimizationMode=t,await vt(this,me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(i){throw this._optimizationMode=n,_.error("[".concat(this.getTrackId(),"] set optimization mode failed"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return _.error(w.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,_.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){UA(this._originMediaStreamTrack).then((t=>{let[n,i]=t;this._videoHeight=i,this._videoWidth=n})).catch(Wd)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new F(w.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");_.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=hr(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf(ct.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await vt(this,me.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(_)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:n,frameRate:i}=this.getMediaStreamTrackSettings();if(!t||!n||!i)return;const{bitrateMax:r,bitrateMin:s}=this._encoderConfig;if(s==null||r==null){const{max:o,min:a}=(function(c,d,l,u,h){const p=b("BITRATE_ADAPTER_TYPE");if(p==="DEFAULT_BITRATE")return{min:u,max:h};if(h===void 0){const R=Math.floor(200*Math.pow(l/15,.6)*Math.pow(c*d/640/360,.75));h=p==="STANDARD_BITRATE"?4*R:2*R,u=u??R}else u=u??Math.floor(h/10);return{min:u,max:h}})(t,n,i,s,r);if(this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=o,b("VIDEO_STANDARD_BITRATE_VERSION")&&s==null&&r==null){const[c,d]=(function(l,u,h){const p=4*Math.floor(2e5*Math.pow(h/15,.6)*Math.pow(l*u/230400,.75)),R=l*u,T=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),y=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]);let I=Si(T).call(T).next().value,A=1;if(T.has(R))I=T.get(R);else{var N;const de=ko(N=Array.from(T.entries())).call(N,((Ce,Ue)=>{let[Pe]=Ce,[nt]=Ue;return Pe-nt})),Ie=de.find((Ce=>{let[Ue]=Ce;return Ue>R}));if(Ie){const Ce=de.indexOf(Ie);if(Ce>0){const Ue=de[Ce-1],Pe=(R-Ue[0])/(Ie[0]-Ue[0]);I=Ue[1]+Pe*(Ie[1]-Ue[1])}else I=Ie[1]}else I=de[de.length-1][1]}if(y.has(R))A=y.get(R);else{var k;const de=ko(k=Array.from(y.entries())).call(k,((Ce,Ue)=>{let[Pe]=Ce,[nt]=Ue;return Pe-nt})),Ie=de.find((Ce=>{let[Ue]=Ce;return Ue>R}));if(Ie){const Ce=de.indexOf(Ie);if(Ce>0){const Ue=de[Ce-1],Pe=(R-Ue[0])/(Ie[0]-Ue[0]);A=Ue[1]+Pe*(Ie[1]-Ue[1])}else A=Ie[1]}else A=de[de.length-1][1]}const x=b("VIDEO_NEW_BITRATE_RATIO");x&&x>0&&(I=x/100);const P=Math.floor(p*I),M=Math.floor(65e4*Math.pow(l*u/230400,.5)*Math.pow(h/15,.69));let G=P;const Y=b("VIDEO_STANDARD_BITRATE_VERSION");return Y&&Y>0&&(Y===1?G=p:Y===2?G=P:Y===3&&(G=M)),[Math.floor(G/1e3),A]})(t,n,i);this._encoderConfig.bitrateMax=c,this._encoderConfig.bitrateMin=a?Math.min(a,c):c,this._saveEncodeBitrateRatio=d,_.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(t,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else _.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(o,", brMin: ").concat(a,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var t,n;const i=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),r={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:i?.parentElement},{element:s,slot:o}=r;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const a=Mw.checkOneElementVisible(s),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=pe.reportApiInvoke(null,{tag:Tt.TRACER,name:Nt.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new F(w.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new F(w.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;t&&(i=bt(bt({},i),hr(t))),i=zo(i);const r=ut(8,"track-video-cloned-"),s=new Ok(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,zo(this._scalabilityMode),this._optimizationMode,r,zo(this._hints));return t&&i&&s.setEncoderConfiguration(i),_.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),s}async replaceTrack(t,n){if(!(t instanceof MediaStreamTrack))throw new F(w.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new F(w.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,n,!0),this.updateMediaStreamTrackResolution()}sendSeiData(t){if(io((()=>{pe.reportApiInvoke(null,{name:Nt.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:Tt.TRACER}).onSuccess("")}),this._mediaStreamTrack.id||this.getTrackId()),!b("ENABLE_VIDEO_SEI")||!b("ENABLE_ENCODED_TRANSFORM"))return void _.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(t instanceof Uint8Array==0)return new F(w.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const n=this.getRTCRtpTransceiver();if(!n)return void _.warning("Video track is not published, SEI can not be send");const i=n.sender.getParameters();if(i.codecs.length===0)return;const r=i.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"||r==="video/h265"?this.safeEmit("sei-to-send",t):_.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(Qn.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await vt(this,me.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await vt(this,me.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Qn.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Pi.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Pi.REQUEST_CONSTRAINTS)}},ze(Ge.prototype,"play",[O0,N0],Object.getOwnPropertyDescriptor(Ge.prototype,"play"),Ge.prototype),ze(Ge.prototype,"stop",[D0],Object.getOwnPropertyDescriptor(Ge.prototype,"stop"),Ge.prototype),ze(Ge.prototype,"setEnabled",[P0,L0,k0],Object.getOwnPropertyDescriptor(Ge.prototype,"setEnabled"),Ge.prototype),ze(Ge.prototype,"setMuted",[x0,M0,U0],Object.getOwnPropertyDescriptor(Ge.prototype,"setMuted"),Ge.prototype),ze(Ge.prototype,"setSaveEncodeBitrateRatio",[V0,j0],Object.getOwnPropertyDescriptor(Ge.prototype,"setSaveEncodeBitrateRatio"),Ge.prototype),ze(Ge.prototype,"setEncoderConfiguration",[F0,B0],Object.getOwnPropertyDescriptor(Ge.prototype,"setEncoderConfiguration"),Ge.prototype),ze(Ge.prototype,"getStats",[W0],Object.getOwnPropertyDescriptor(Ge.prototype,"getStats"),Ge.prototype),ze(Ge.prototype,"setBeautyEffect",[G0,H0],Object.getOwnPropertyDescriptor(Ge.prototype,"setBeautyEffect"),Ge.prototype),ze(Ge.prototype,"getCurrentFrameData",[K0],Object.getOwnPropertyDescriptor(Ge.prototype,"getCurrentFrameData"),Ge.prototype),ze(Ge.prototype,"getCurrentFrameImage",[Y0],Object.getOwnPropertyDescriptor(Ge.prototype,"getCurrentFrameImage"),Ge.prototype),ze(Ge.prototype,"findClosestProfile",[z0,q0],Object.getOwnPropertyDescriptor(Ge.prototype,"findClosestProfile"),Ge.prototype),ze(Ge.prototype,"setBitrateLimit",[X0],Object.getOwnPropertyDescriptor(Ge.prototype,"setBitrateLimit"),Ge.prototype),ze(Ge.prototype,"setOptimizationMode",[J0],Object.getOwnPropertyDescriptor(Ge.prototype,"setOptimizationMode"),Ge.prototype),ze(Ge.prototype,"setScalabiltyMode",[Q0],Object.getOwnPropertyDescriptor(Ge.prototype,"setScalabiltyMode"),Ge.prototype),ze(Ge.prototype,"updateMediaStreamTrackResolution",[Z0],Object.getOwnPropertyDescriptor(Ge.prototype,"updateMediaStreamTrackResolution"),Ge.prototype),ze(Ge.prototype,"pipe",[$0],Object.getOwnPropertyDescriptor(Ge.prototype,"pipe"),Ge.prototype),ze(Ge.prototype,"unpipe",[eO],Object.getOwnPropertyDescriptor(Ge.prototype,"unpipe"),Ge.prototype),ze(Ge.prototype,"close",[tO],Object.getOwnPropertyDescriptor(Ge.prototype,"close"),Ge.prototype),ze(Ge.prototype,"replaceTrack",[nO],Object.getOwnPropertyDescriptor(Ge.prototype,"replaceTrack"),Ge.prototype),Ge),Ph=(iO=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),rO=Bt(),sO=hc("CameraVideoTrack","_enabledMutex"),oO=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),aO=Bt(),cO=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),dO=Bt(),lO=ve({argsMap:e=>[e.getTrackId()]}),Mi=class Nk extends yt{get __className__(){return"CameraVideoTrack"}constructor(t,n,i,r,s,o){super(t,hr(n.encoderConfig),r,s,o),j(this,"_config",void 0),j(this,"_originalConstraints",void 0),j(this,"_constraints",void 0),j(this,"_enabled",!0),j(this,"_deviceName","default"),j(this,"tryResumeVideoForIOS15_16WeChat",(async()=>{(cc()||gE())&&!(function(){const a=Ze();if(a.os!==un.IOS||!a.osVersion)return!1;const c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2})()&&Ow()&&this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())})),this._config=n,this._originalConstraints=i,this._constraints=i,this._deviceName=t.label,this._encoderConfig=hr(this._config.encoderConfig),Et.on(In.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Et.on(In.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(_.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const n=await xi.getDeviceById(t),i={};i.video=bt({},this._constraints),i.video.deviceId={exact:t},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await ki(i,this.getTrackId())}catch(s){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),s.toString()),r=await ki({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),s}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(n){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await xi.getDeviceById(t);this._deviceName=n.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(n){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){_.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));const n={video:bt(bt({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let i=null;try{i=await ki(n,this.getTrackId())}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),i=await ki({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=bt({},n.video),_.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const i=await ki({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}await vt(this,me.NEED_ENABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await vt(this,me.NEED_DISABLE_TRACK,this)}catch(i){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,n){if(!this._enabled)throw new F(w.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t=hr(t),b("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate||t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate||t.bitrateMin);const i=wt(this._config);i.encoderConfig=t;const r=Nh(i);(En()||Fn()||ar())&&(r.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(s){const o=new F(w.UNEXPECTED_ERROR,s.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}this._config=i,this._constraints=r,this._originalConstraints=r,this._encoderConfig=t,this._hints.indexOf(ct.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await vt(this,me.NEED_UPDATE_VIDEO_ENCODER,this)}catch(s){return s.throw(_)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Fn()||ar())&&this._enabled&&!this._isClosed&&Et.duringInterruption){const t=async()=>{Et.off(In.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Et.on(In.IOS_INTERRUPTION_END,t)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(gc.TRACK_ENDED)}async renewMediaStreamTrack(t){const n=t||this._constraints,i=xi.searchDeviceIdByName(this._deviceName);if(i&&!n.deviceId&&(n.deviceId={exact:i}),this._enabled){const r=await ki({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Et.off(In.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Et.off(In.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;t&&(i=bt(bt({},i),hr(t))),i=zo(i);const r=ut(8,"track-cam-cloned-"),s=new Nk(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,zo(bt(bt({},this._config),{},{encoderConfig:i})),zo(this._constraints),zo(this._scalabilityMode),this._optimizationMode,r);return t&&i&&s.setEncoderConfiguration(i),_.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),s}bindProcessorContextEvents(){this.processorContext.on(Pi.REQUEST_UPDATE_CONSTRAINTS,(async(t,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}})),this.processorContext.on(Pi.REQUEST_CONSTRAINTS,(async t=>{t(this._originMediaStreamTrack.getSettings())}))}},ze(Mi.prototype,"setDevice",[iO,rO],Object.getOwnPropertyDescriptor(Mi.prototype,"setDevice"),Mi.prototype),ze(Mi.prototype,"setEnabled",[sO,oO,aO],Object.getOwnPropertyDescriptor(Mi.prototype,"setEnabled"),Mi.prototype),ze(Mi.prototype,"setEncoderConfiguration",[cO,dO],Object.getOwnPropertyDescriptor(Mi.prototype,"setEncoderConfiguration"),Mi.prototype),ze(Mi.prototype,"close",[lO],Object.getOwnPropertyDescriptor(Mi.prototype,"close"),Mi.prototype),Mi);function uO(e){const t=ut(8,"track-cus-"),n=pe.reportApiInvoke(null,{id:t,tag:Tt.TRACER,name:Nt.CREATE_CUSTOM_AUDIO_TRACK,options:[e]}),i=new Wt(e.mediaStreamTrack,e.encoderConfig?wh(e.encoderConfig):{},t,!1);return _.info("create custom audio track success with config",e,"trackId",i.getTrackId()),n.onSuccess(i.getTrackId()),i}function ig(e,t,n,i){n.optimizationMode&&(i&&i.width&&i.height?(n.encoderConfig=bt(bt({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(t.contentHint=n.optimizationMode,t.contentHint===n.optimizationMode?_.debug("[".concat(e,"] set content hint to"),n.optimizationMode):_.debug("[".concat(e,"] set content hint failed")))):_.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}var hO,pO,mO,fO,Yi,_O,EO,gO,SO,TO,yO,vO,Pn;class RO extends RA{getUserId(){return this._userId}constructor(t,n,i,r){super(t,"track-".concat(t.kind,"-").concat(n,"-").concat(r.clientId,"_").concat(ut(5,""))),j(this,"_userId",void 0),j(this,"_uintId",void 0),j(this,"_isDestroyed",!1),j(this,"store",void 0),j(this,"processor",void 0),j(this,"processorContext",void 0),this._userId=n,this._uintId=i,this.store=r}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,_.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let Rc=(hO=ve({argsMap:(e,t,n)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),pO=ve({argsMap:e=>[e.getTrackId()]}),mO=ve({argsMap:(e,t)=>[e.getTrackId(),t.name]}),fO=ve({argsMap:e=>[e.getTrackId()]}),ze((Yi=class extends RO{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Ln.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,n,i,r){super(e,t,n,i),j(this,"_videoVisibleTimer",null),j(this,"_previousVideoVisibleStatus",void 0),j(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),j(this,"trackMediaType",Sc.VIDEO),j(this,"_videoWidth",void 0),j(this,"_videoHeight",void 0),j(this,"_player",void 0),j(this,"_prePlayer",void 0),j(this,"processorDestination",void 0),j(this,"processorContext",void 0),this._prePlayer=r,this.updateMediaStreamTrackResolution(),this.processorContext=new kA(this.getTrackId(),"remote"),this.processorDestination=new LA(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return io((()=>{_.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),vi(this,me.GET_STATS)||bt({},yA)}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.safeEmit(Ki.PLAY_START),typeof e=="string"){const i=document.getElementById(e);i?e=i:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const n=bt(bt({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});if(this._player)this._player.updateConfig(n);else{let i=!1,r=!1;e instanceof HTMLVideoElement?(this._player=new ng(n),this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0,r=!0)):this._prePlayer&&!this._prePlayer.isDestroyed?(this._player=this._prePlayer,this._prePlayer=void 0,i=this._player.videoState>0,this._player.updateConfig(n)):this._player=new Dh(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Ki.FIRST_FRAME_DECODED),r&&this.safeEmit(Ki.FIRST_FRAME_RENDER)},this._player.onVideoStateChanged=s=>{this.safeEmit(Ki.VIDEO_STATE_CHANGED,s)},i&&(this._player.onFirstVideoFrameDecoded(),this._player.onVideoStateChanged(this._player.videoState))}this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const i=this.getVideoElementVisibleStatus();this.safeEmit(Ki.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}}),b("CHECK_VIDEO_VISIBLE_INTERVAL")),this.safeEmit(Ki.PLAY_END)}stop(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(e),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){UA(this._originMediaStreamTrack).then((e=>{let[t,n]=e;this._videoHeight=n,this._videoWidth=t})).catch(Wd)}_updatePlayerSource(){_.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const n=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),i={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:n?.parentElement},{element:r,slot:s}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&s instanceof HTMLElement){const o=Mw.checkOneElementVisible(r),a=Object.assign({},o);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;const c=pe.reportApiInvoke(null,{tag:Tt.TRACER,name:Nt.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(n){throw new F(w.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new F(w.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Qn.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Qn.ON_TRACK)}_destroy(){this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0),super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit($o.SEI_RECEIVED,e)}}).prototype,"play",[hO],Object.getOwnPropertyDescriptor(Yi.prototype,"play"),Yi.prototype),ze(Yi.prototype,"stop",[pO],Object.getOwnPropertyDescriptor(Yi.prototype,"stop"),Yi.prototype),ze(Yi.prototype,"pipe",[mO],Object.getOwnPropertyDescriptor(Yi.prototype,"pipe"),Yi.prototype),ze(Yi.prototype,"unpipe",[fO],Object.getOwnPropertyDescriptor(Yi.prototype,"unpipe"),Yi.prototype),Yi),Cc=(_O=ve({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),EO=ve({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),gO=ve({argsMap:(e,t)=>[e.getTrackId(),t]}),SO=ve({argsMap:e=>[e.getTrackId()]}),TO=ve({argsMap:e=>[e.getTrackId()]}),yO=ve({argsMap:(e,t)=>[e.getTrackId(),t.name]}),vO=ve({argsMap:e=>[e.getTrackId()]}),ze((Pn=class extends RO{get isPlaying(){return this._useAudioElement?Gn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,n,i){super(e,t,n,i),j(this,"trackMediaType",Sc.AUDIO),j(this,"_source",void 0),j(this,"_useAudioElement",!0),j(this,"_volume",100),j(this,"processorContext",void 0),j(this,"processorDestination",void 0),j(this,"_played",!1),j(this,"_bypassWebAudio",!1),b("DISABLE_WEBAUDIO")?(this._source=new eg,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new QE(e,!0),b("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Di.RECEIVE_TRACK_BUFFER,(()=>{this.safeEmit(Ki.FIRST_FRAME_DECODED)})),this.processorContext=new MA(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new xA(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Di.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Di.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Di.ON_AUDIO_BUFFER),this._source.on(Di.ON_AUDIO_BUFFER,(n=>e(n)))}setVolume(e){this._volume=e,this._useAudioElement?Gn.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}setAmplifiedVolume(e){this._useAudioElement&&this._played&&(Gn.stop(this.getTrackId()),this._source.play()),this._useAudioElement=!1,e=Math.min(e,b("MAX_WEBAUDIO_VOLUME")),this._volume=e,this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!mA())throw new F(w.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Gn.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getVolume(){return this._useAudioElement?Gn.getVolume(this.getTrackId()):this._source instanceof QE?this._source.getAudioVolume():0}getStats(){return io((()=>{_.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),vi(this,me.GET_STATS)||bt({},TA)}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] use audio element to play")),Gn.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):(_.debug("[".concat(this.getTrackId(),"] use audio context to play")),this._source.play())}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Gn.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Gn.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new F(w.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new F(w.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new F(w.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Qn.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(Qn.ON_NODE,(e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Qn.ON_TRACK),this.processorDestination.removeAllListeners(Qn.ON_NODE)}}).prototype,"setVolume",[_O],Object.getOwnPropertyDescriptor(Pn.prototype,"setVolume"),Pn.prototype),ze(Pn.prototype,"setAmplifiedVolume",[EO],Object.getOwnPropertyDescriptor(Pn.prototype,"setAmplifiedVolume"),Pn.prototype),ze(Pn.prototype,"setPlaybackDevice",[gO],Object.getOwnPropertyDescriptor(Pn.prototype,"setPlaybackDevice"),Pn.prototype),ze(Pn.prototype,"play",[SO],Object.getOwnPropertyDescriptor(Pn.prototype,"play"),Pn.prototype),ze(Pn.prototype,"stop",[TO],Object.getOwnPropertyDescriptor(Pn.prototype,"stop"),Pn.prototype),ze(Pn.prototype,"pipe",[yO],Object.getOwnPropertyDescriptor(Pn.prototype,"pipe"),Pn.prototype),ze(Pn.prototype,"unpipe",[vO],Object.getOwnPropertyDescriptor(Pn.prototype,"unpipe"),Pn.prototype),Pn);const Ri=new class extends kt{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),j(this,"_lastHiddenTime",0),j(this,"_lastVisibleTime",0),j(this,"needUploadStats",[]),j(this,"isCollectingStats",!1),document.addEventListener("visibilitychange",(()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),this.isCollectingStats&&this.needUploadStats.push(document.visibilityState==="visible"?1:0),_.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}startCollectStats(){this.isCollectingStats=!0,this.needUploadStats.push(this.visibility==="visible"?1:0)}stopCollectStats(){this.isCollectingStats=!1,this.needUploadStats.length=0}};class CO extends kt{constructor(t,n){super(),j(this,"trackMediaType",Sc.DATA),j(this,"_version",1),j(this,"_type",3),j(this,"_config",void 0),j(this,"_originDataChannel",void 0),j(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),j(this,"_dataStreamPacketHandler",{serialize:i=>i,deserialize:i=>i}),j(this,"_datachannelEventMap",new Map),this._config=t,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader()}useDataStream(t){this._dataStreamPacketHandler=t}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return b("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,n;return(t=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,n;return(t=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new ie(((t,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();const i=setTimeout((()=>{var r;n(new F(w.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))}),1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new F(w.DATACHANNEL_CONNECTION_TIMEOUT)}}else n(new F(w.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))}))}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){const t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[Ah.OPEN,Ah.CLOSE,Ah.ERROR].forEach((n=>{const i=()=>{this.emit(n)};this._datachannelEventMap.set(n,i),t.addEventListener(n,i)}))}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach((n=>{let[i,r]=n;t.removeEventListener(i,r)})),this._datachannelEventMap.clear()}}class w6 extends CO{constructor(t){super(t),j(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const i=n.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(i).getUint8(3);if(r!==this.id)return void(b("SHOW_DATASTREAM2_LOG")&&_.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let s=n.data.slice(this._dataStreamPacketHeader.byteLength);s=this._dataStreamPacketHandler.deserialize(s),this.emit(Ah.MESSAGE,s)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class A6 extends CO{send(t){if(this._originDataChannel){let n=t;n=this._dataStreamPacketHandler.serialize(t);const i=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}}function Lh(){const e=new Blob([atob("Y29uc3QgdD0idmlkZW8vaDI2NCIsZT0idmlkZW8vaDI2NSI7ZnVuY3Rpb24gbih0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLHI9W10sbz0wO2Zvcig7ci5sZW5ndGg8bjspbyszPG4mJjA9PT1hW29dJiYwPT09YVtvKzFdJiYzPT09YVtvKzJdJiYoMD09PWFbbyszXXx8MT09PWFbbyszXXx8Mj09PWFbbyszXXx8Mz09PWFbbyszXSk/KHIucHVzaChhW29dLGFbbysxXSxhW28rM10pLG8rPTQpOihyLnB1c2goYVtvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkocil9ZnVuY3Rpb24gYShhLHIpe3N3aXRjaChyKXtjYXNlIHQ6cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IERhdGFWaWV3KHQuZGF0YSk7bGV0IGE9MDtmb3IoO2ErNDx0LmRhdGEuYnl0ZUxlbmd0aDspe2lmKDA9PT1lLmdldFVpbnQ4KGErMCkmJjA9PT1lLmdldFVpbnQ4KGErMSkmJjA9PT1lLmdldFVpbnQ4KGErMikmJjE9PT1lLmdldFVpbnQ4KGErMykmJjY9PT1lLmdldFVpbnQ4KGErNCkpe2xldCByPWErNixvPTAsaT0wO2Zvcig7MjU1PT09KGk9ZS5nZXRVaW50OChyKyspKTspbys9MjU1O28rPWk7Y29uc3Qgcz1uKHQuZGF0YSxyLG8pO3JldHVybiBuZXcgVWludDhBcnJheShzKX1hKyt9cmV0dXJuIG51bGx9KGEpO2Nhc2UgZTpyZXR1cm4gZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRGF0YVZpZXcodC5kYXRhKTtsZXQgYT0wO2Zvcig7YSs1PHQuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PWUuZ2V0VWludDgoYSswKSYmMD09PWUuZ2V0VWludDgoYSsxKSYmMD09PWUuZ2V0VWludDgoYSsyKSYmMT09PWUuZ2V0VWludDgoYSszKSYmNzg9PT1lLmdldFVpbnQ4KGErNCkmJjE9PT1lLmdldFVpbnQ4KGErNSkmJjEwMT09PWUuZ2V0VWludDgoYSs2KSl7bGV0IHI9YSs3LG89MCxpPTA7Zm9yKDsyNTU9PT0oaT1lLmdldFVpbnQ4KHIrKykpOylvKz0yNTU7bys9aTtjb25zdCBzPW4odC5kYXRhLHIsbyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KHMpfWErK31yZXR1cm4gbnVsbH0oYSk7ZGVmYXVsdDpyZXR1cm4gbnVsbH19ZnVuY3Rpb24gcih0KXtjb25zdCBlPXQubGVuZ3RoO2xldCBuPVtdLGE9MDtmb3IoO2E8ZTspYSsyPGUmJjA9PT10W2FdJiYwPT09dFthKzFdJiYoMD09PXRbYSsyXXx8MT09PXRbYSsyXXx8Mj09PXRbYSsyXXx8Mz09PXRbYSsyXSk/KG4ucHVzaCh0W2FdLHRbYSsxXSwzLHRbYSsyXSksYSs9Myk6KG4ucHVzaCh0W2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShuKX1mdW5jdGlvbiBvKG4sYSxvKXtzd2l0Y2gobyl7Y2FzZSB0OnJldHVybiBmdW5jdGlvbih0LGUpe2NvbnN0IG49cihlKSxhPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihhLzI1NSksaT1hJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK2ErdC5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNitmXT0yNTUsZisrO3JldHVybiBzWzYrZl09aSxmKysscy5zZXQobiw2K2YpLHMuc2V0KG5ldyBVaW50OEFycmF5KHQpLDYrZithKSxzLmJ1ZmZlcn0obixhKTtjYXNlIGU6cmV0dXJuIGZ1bmN0aW9uKHQsZSl7Y29uc3Qgbj1yKGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxpPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNytvKzErYSsxK3QuYnl0ZUxlbmd0aCk7c1swXT0wLHNbMV09MCxzWzJdPTAsc1szXT0xLHNbNF09Nzgsc1s1XT0xLHNbNl09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNytmXT0yNTUsZisrO3JldHVybiBzWzcrZl09aSxmKysscy5zZXQobiw3K2YpLGYrPWEsc1s3K2ZdPTEyOCxmKysscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNytmKSxzLmJ1ZmZlcn0obixhKTtkZWZhdWx0OnJldHVybiBudWxsfX1mdW5jdGlvbiBpKG4pe2lmKG4ubGVuZ3RoPDUpcmV0dXJuIiI7bGV0IGE9LTE7Zm9yKGxldCB0PTA7dDxuLmxlbmd0aC0zO3QrKyl7aWYoMD09PW5bdF0mJjA9PT1uW3QrMV0mJjE9PT1uW3QrMl0pe2E9dDticmVha31pZih0PG4ubGVuZ3RoLTQmJjA9PT1uW3RdJiYwPT09blt0KzFdJiYwPT09blt0KzJdJiYxPT09blt0KzNdKXthPXQ7YnJlYWt9fWlmKC0xPT09YSlyZXR1cm4iIjtjb25zdCByPWErKDA9PT1uW2ErMl0/NDozKTtpZihyPj1uLmxlbmd0aClyZXR1cm4iIjtjb25zdCBvPW5bcl07aWYoMTI4Jm8pcmV0dXJuIiI7aWYoKG8+PjEmNjMpPj0zMilyZXR1cm4gZTtpZihyKzE8bi5sZW5ndGgpe2lmKDA9PSgyNDgmbltyKzFdKSlyZXR1cm4gZX1yZXR1cm4oMzEmbyk8PTMxP3Q6IiJ9Y29uc3Qgcz03MSxmPTEsbD0yLHU9MSxnPTI7dmFyIGM7ZnVuY3Rpb24gZCh0LGU9ITEpe2NvbnN0IG49dC5nZXRVaW50OCgwKTtpZihuIT09cylyZXR1cm47Y29uc3QgYT10LmdldFVpbnQxNigxKSxyPWYrbCthLG89bmV3IFVpbnQ4QXJyYXkodC5ieXRlTGVuZ3RoLXIpO28uc2V0KG5ldyBVaW50OEFycmF5KHQuYnVmZmVyLHIsdC5ieXRlTGVuZ3RoLXIpKTtjb25zdCBpPXttOm4sdGx2TGVuOmEsdGx2OltdLGZyYW1lOm99O2xldCBkPWYrbDtmb3IoO2Q8cjspe2NvbnN0IG49dC5nZXRVaW50OChkKSxhPXQuZ2V0VWludDE2KGQrdSkscj11K2c7aWYobj09PWMuQVVESU9fTEVWRUwpe2xldCBvPXQuZ2V0VWludDgoZCtyKTtmb3IobGV0IGU9MTtlPGE7ZSsrKW89bzw8OHx0LmdldFVpbnQ4KGQrcitlKTtpLnRsdi5wdXNoKHt0YWc6bixsZW5ndGg6YSx2YWx1ZTplPzEyN15vPj4xOjEyNyZvfSl9ZWxzZSBpZihuPT09Yy5NRVRBREFUQXx8bj09PWMuQVVESU9fNjRfQklUX1BUUyl7Y29uc3QgZT1uZXcgVWludDhBcnJheShhKTtmb3IobGV0IG49MDtuPGE7bisrKWVbbl09dC5nZXRVaW50OChkK3Irbik7aS50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZX0pfWQrPXIrYX1yZXR1cm4gaX0hZnVuY3Rpb24odCl7dFt0LkFVRElPX0xFVkVMPTFdPSJBVURJT19MRVZFTCIsdFt0Lk1FVEFEQVRBPTJdPSJNRVRBREFUQSIsdFt0LkFVRElPXzY0X0JJVF9QVFM9M109IkFVRElPXzY0X0JJVF9QVFMifShjfHwoYz17fSkpLHNlbGYub25ydGN0cmFuc2Zvcm09dD0+e2NvbnN0IGU9dC50cmFuc2Zvcm1lcixuPVtdLHI9W107bGV0IGg9bnVsbDtlLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9dD0+e3QuZGF0YS5zZWkmJm4ucHVzaCh0LmRhdGEuc2VpKSx0LmRhdGEubWV0YWRhdGEmJnIucHVzaCh0LmRhdGEubWV0YWRhdGEpfSxzZWxmLnBvc3RNZXNzYWdlKCJzdGFydGVkIik7Y29uc3QgcD1lLnJlYWRhYmxlLmdldFJlYWRlcigpLFU9ZS53cml0YWJsZS5nZXRXcml0ZXIoKTsic2VpLXJ4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KG4udmFsdWUuZGF0YSkpLHI9YShuLnZhbHVlLHQpO2lmKHImJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtzZWk6cn0pLCFoKXtjb25zdCB0PW4udmFsdWUuZ2V0TWV0YWRhdGEoKXx8e307aD17dHlwZTpuLnZhbHVlLnR5cGUscnRwVGltZXN0YW1wOm4udmFsdWUudGltZXN0YW1wLHBheWxvYWRUeXBlOnQucGF5bG9hZFR5cGV8fDAsc3NyYzp0LnN5bmNocm9uaXphdGlvblNvdXJjZXx8MCxsZW5ndGg6bi52YWx1ZS5kYXRhLmJ5dGVMZW5ndGgsLi4uIm1pbWVUeXBlImluIHQ/e21pbWVUeXBlOnQubWltZVR5cGV9Ont9fSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7Zmlyc3RGcmFtZUluZm86aH0pfX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToic2VpLXR4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigoYT0+e2lmKCFhLmRvbmUpe2lmKGEudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KGEudmFsdWUuZGF0YSkpLGU9bi5zaGlmdCgpO2lmKGUpe2NvbnN0IG49byhhLnZhbHVlLmRhdGEsZSx0KTtuJiYoYS52YWx1ZS5kYXRhPW4pfX1VLndyaXRlKGEudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtcngiPT09ZS5vcHRpb25zLm5hbWU/ZnVuY3Rpb24gdChlKXtwLnJlYWQoKS50aGVuKChuPT57aWYoIW4uZG9uZSl7aWYobi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PW5ldyBEYXRhVmlldyhuLnZhbHVlLmRhdGEpLGE9dC5nZXRVaW50OCgwKTtsZXQgcjtpZigwIT0oMTI4JmEpJiY3MSE9PWEpe2NvbnN0IGU9ZnVuY3Rpb24odCl7aWYodC5ieXRlTGVuZ3RoPD0wKXJldHVybltdO2NvbnN0IGU9W107bGV0IG49MDtmb3IoO248dC5ieXRlTGVuZ3RoOyl7Y29uc3QgYT0oMTI4JnQuZ2V0VWludDgobikpPj43LHI9MTI3JnQuZ2V0VWludDgobik7aWYoIShhJiZuKzQ8PXQuYnl0ZUxlbmd0aCkpe24rKzticmVha317Y29uc3QgYT10LmdldFVpbnQzMihuLCExKSxvPSgxNjc3NjE5MiZhKT4+MTAsaT0xMDIzJmE7ZS5wdXNoKHtwdDpyLHRzX29mZnNldDpvLGxlbmd0aDppLGRhdGE6bmV3IFVpbnQ4QXJyYXl9KSxuKz00fX1sZXQgYT10LmJ5dGVMZW5ndGgtbjtmb3IoY29uc3QgciBvZiBlKXtpZihyLmxlbmd0aD5hKXJldHVybiBjb25zb2xlLndhcm4oIkJyb2tlbiByZWQgcGF5bG9hZCIpLFtdO3IubGVuZ3RoPjAmJihyLmRhdGE9bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sci5sZW5ndGgpLG4rPXIubGVuZ3RoLGEtPXIubGVuZ3RoKX1pZihhPjApe2NvbnN0IHI9e3B0OmUubGVuZ3RoPjA/ZVtlLmxlbmd0aC0xXS5wdDowLHRzX29mZnNldDowLGxlbmd0aDphLGRhdGE6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sYSl9O2UucHVzaChyKX1yZXR1cm4gZX0odCk7aWYoZS5sZW5ndGg+MCl7Y29uc3QgdD1mdW5jdGlvbih0KXtsZXQgZT0wO2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKWUrPW48dC5sZW5ndGgtMT80OjEsZSs9dFtuXS5sZW5ndGg7Y29uc3Qgbj1uZXcgVWludDhBcnJheShlKTtsZXQgYT0wO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKWlmKGU8dC5sZW5ndGgtMSl7Y29uc3Qgcj0oMjE0NzQ4MzY0OHwoMTI3JnRbZV0ucHQpPDwyNHwoMjYyMTQzJnRbZV0udHNfb2Zmc2V0KTw8MTB8MTAyMyZ0W2VdLmxlbmd0aCk+Pj4wO25bYSsrXT1yPj4yNCYyNTUsblthKytdPXI+PjE2JjI1NSxuW2ErK109cj4+OCYyNTUsblthKytdPTI1NSZyfWVsc2UgblthKytdPTEyNyZ0W2VdLnB0O2Zvcihjb25zdCBlIG9mIHQpbi5zZXQoZS5kYXRhLGEpLGErPWUubGVuZ3RoO3JldHVybiBufShlLm1hcCgodD0+e2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkodC5sZW5ndGgpO2Uuc2V0KHQuZGF0YSk7Y29uc3Qgbj1kKG5ldyBEYXRhVmlldyhlLmJ1ZmZlcikpO3JldHVybiBuPy5mcmFtZSYmKHQuZGF0YT1uPy5mcmFtZSkscj1uLHR9KSkpO24udmFsdWUuZGF0YT10LmJ1ZmZlcn19ZWxzZSByPWQodCksciYmKG4udmFsdWUuZGF0YT1yLmZyYW1lLmJ1ZmZlcik7aWYocil7bGV0IHQ9ci50bHYuZmluZCgodD0+dC50YWc9PT1jLk1FVEFEQVRBKSk7aWYodCYmdC52YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkmJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHttZXRhZGF0YTp0LnZhbHVlfSksdD1yLnRsdi5maW5kKCh0PT50LnRhZz09PWMuQVVESU9fNjRfQklUX1BUUykpLHQmJnQudmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5JiY4PT10LnZhbHVlLmxlbmd0aCl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcodC52YWx1ZS5idWZmZXIpLmdldEJpZ1VpbnQ2NCgwLCEwKTt0JiZ0LnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3B0czpufSl9fX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtdHgiPT09ZS5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtnZXRNZXRhZGF0YTohMH0pLG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1yLnNoaWZ0KCk7dCYmKG4udmFsdWUuZGF0YT1mdW5jdGlvbih0LGUsbil7Y29uc3QgYT1uLmJ5dGVMZW5ndGgscj1hK3UrZyxvPWYrbCtyLGk9bmV3IEFycmF5QnVmZmVyKHQuYnl0ZUxlbmd0aCtvKSxjPW5ldyBEYXRhVmlldyhpKTtjLnNldFVpbnQ4KDAscyksYy5zZXRVaW50MTYoMSxyKSxjLnNldFVpbnQ4KDMsZSksYy5zZXRVaW50MTYoNCxhKTtmb3IobGV0IHQ9MDt0PGE7dCsrKWMuc2V0VWludDgoNit0LG5bdF0pO2NvbnN0IGQ9bmV3IFVpbnQ4QXJyYXkoYy5idWZmZXIpO3JldHVybiBkLnNldChuZXcgVWludDhBcnJheSh0KSxvKSxkLmJ1ZmZlcn0obi52YWx1ZS5kYXRhLGMuQVVESU9fNjRfQklUX1BUUyx0KSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSl9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKTsK")],{type:"text/javascript"});return setTimeout((()=>Pu.revokeObjectURL(e)),0),new Worker(Pu.createObjectURL(e))}const bO=71,rg=1,sg=2,og=1,IO=2;var so=(function(e){return e[e.AUDIO_LEVEL=1]="AUDIO_LEVEL",e[e.METADATA=2]="METADATA",e[e.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",e})(so||{});function ag(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=e.getUint8(0);if(n!==bO)return;const i=e.getUint16(1),r=rg+sg+i,s=new Uint8Array(e.byteLength-r);s.set(new Uint8Array(e.buffer,r,e.byteLength-r));const o={m:n,tlvLen:i,tlv:[],frame:s};let a=rg+sg;for(;a<r;){const c=e.getUint8(a),d=e.getUint16(a+og),l=og+IO;if(c===so.AUDIO_LEVEL){let u=e.getUint8(a+l);for(let h=1;h<d;h++)u=u<<8|e.getUint8(a+l+h);o.tlv.push({tag:c,length:d,value:t?127^u>>1:127&u})}else if(c===so.METADATA||c===so.AUDIO_64_BIT_PTS){const u=new Uint8Array(d);for(let h=0;h<d;h++)u[h]=e.getUint8(a+l+h);o.tlv.push({tag:c,length:d,value:u})}a+=l+d}return o}const kh=new Map,xh=127,na=1e-10,cg=139/13,Mh=new Map;function dg(e,t,n){const i="".concat(e,"-").concat(t,"-").concat(n);let r=0;return Mh.has(i)?r=Mh.get(i):(r=Math.log((function(o,a){const c=o-a;a<c&&(a=c);let d=1;for(let l=o,u=1;l>a;l--,u++)d=d*l/u;return d})(t,e))+e*Math.log(.5)+(t-e)*Math.log(1-.5)-Math.log(n)+n*e,Mh.set(i,r)),r<na&&(r=na),r}function wO(e,t,n){const i=t.length,r=e.length/i;let s=!1;for(let o=0,a=0;o<i;o++){let c=0;for(let d=a+r;a<d;a++)e[a]>n&&c++;t[o]!==c&&(t[o]=c,s=!0)}return s}window.cache=Mh;let O6=0;class AO{constructor(t){j(this,"id",void 0),j(this,"immediates",[]),j(this,"lastNonSilence",-1),j(this,"immediateSpeechActivityScore",na),j(this,"lastLevelChangedTime",Date.now()),j(this,"levels",[]),j(this,"longs",[]),j(this,"longSpeechActivityScore",na),j(this,"mediums",[]),j(this,"mediumSpeechActivityScore",na),j(this,"minLevel",0),j(this,"nextMinLevel",0),j(this,"nextMinLevelWindowLength",0),j(this,"energyScore",0),this.id=t||"".concat(O6++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){const t=this.immediates,n=this.levels,i=this.minLevel+cg;let r=!1;for(let s=0;s<t.length;++s){let o=n[s];o<i&&(o=0);const a=Math.floor(o/cg);t[s]!==a&&(t[s]=a,r=!0)}return r}computeLongs(){return wO(this.mediums,this.longs,4)}computeMediums(){return wO(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=dg(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(t){this.longSpeechActivityScore=dg(this.longs[0],10,47),this.longSpeechActivityScore>na&&(this.lastNonSilence=t)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=dg(this.mediums[0],5,24)}evaluateSpeechActivityScores(t){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(t)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var t;return"[".concat(XT(t=[...this.levels]).call(t).join(),"]")}getSpeechActivityScore(t){switch(t){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+t)}}levelChanged(t,n){if(this.lastLevelChangedTime<=n){this.lastLevelChangedTime=n;let i=t;return t<0&&(i=0),t>xh&&(i=xh),this.levels.unshift(i),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(i),i>=this.minLevel+cg?i:i/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(t){if(t!==0){if(this.minLevel===0||this.minLevel>t)return this.minLevel=t,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=t,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>t&&(this.nextMinLevel=t),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let n=Math.sqrt(this.minLevel*this.nextMinLevel);n<0?n=0:n>xh&&(n=xh),this.minLevel=n,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class N6{constructor(t){j(this,"algorithm",void 0),this.algorithm=t}execute(){let t=!this.algorithm;if(!t)try{const n=this.algorithm.runInDecisionMaker(this);n<=0?t=!0:setTimeout(this.execute.bind(this),n)}catch{t=!0}t&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class lg{constructor(t,n,i){j(this,"isDominant",void 0),j(this,"energyRanking",void 0),j(this,"energyScore",void 0),this.isDominant=t,this.energyRanking=n,this.energyScore=i}}class D6 extends kt{constructor(t){super(),j(this,"dominantId",null),j(this,"lastDecisionTime",0),j(this,"lastLevelChangedTime",0),j(this,"lastLevelIdleTime",0),j(this,"relativeSpeechActivities",[]),j(this,"speakers",new Map),j(this,"enableSilence",!1),j(this,"timeoutToSilenceInterval",0),j(this,"decisionMaker",null),j(this,"loudest",[]),j(this,"numLoudestToTrack",3),j(this,"energyExpireTimeMs",250),j(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=t,this.enableSilence=t>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,n=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=t,n!=null&&(this.energyExpireTimeMs=n),i!=null&&(this.energyAlphaPct=i),this.loudest.length>t&&this.loudest.splice(t)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(t){return this.loudest.some((n=>n.id===t))}levelChanged(t,n){const i=Date.now(),r=this.getOrCreateSpeaker(t);this.lastLevelChangedTime<i&&(this.lastLevelChangedTime=i,this.maybeStartDecisionMaker());const s=r.levelChanged(n,i);return this.updateLoudestList(r,s,i)}runInDecisionMaker(t){return this.decisionMaker!==t||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(t){this.decisionMaker===t&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(t){t.forEach((n=>{this.speakers.has(n.id)||this.speakers.set(n.id,n)}))}removeSpeakers(t){t.forEach((n=>{this.speakers.delete(n.id)}))}getOrCreateSpeaker(t){let n=this.speakers.get(t);return n||(n=new AO(t),this.speakers.set(t,n),this.maybeStartDecisionMaker()),n}updateLoudestList(t,n,i){const r=t.id===this.dominantId;if(n<0){let c=0;for(;c<this.loudest.length&&this.loudest[c]!==t;)++c;return new lg(r,c,t.energyScore)}if(t.energyScore=Math.floor((this.energyAlphaPct*n+(100-this.energyAlphaPct)*t.energyScore+50)/100),this.numLoudestToTrack===0)return new lg(r,0,t.energyScore);const s=i-this.energyExpireTimeMs;let o=0;for(;o<this.loudest.length;){const c=this.loudest[o];if(c.getLastLevelChangedTime()<s&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(o,1);else if(c.id!==t.id)++o;else if(this.loudest.splice(o,1),this.loudest.length<this.numLoudestToTrack)break}let a=0;for(;a<this.loudest.length&&!(this.loudest[a].energyScore<t.energyScore);)++a;return a<this.numLoudestToTrack&&(this.loudest.splice(a,0,t),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new lg(r,a,t.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new N6(this),this.decisionMaker.execute())}makeDecision(t){let n=null,i=null;const r=this.speakers.size;let s=null;if(r===0)s=null;else if(r===1){var o;const a=Si(o=this.speakers).call(o).next().value;this.enableSilence&&a&&(s=a.id,a.evaluateSpeechActivityScores(t),t-a.lastNonSilence>this.timeoutToSilenceInterval&&(s=null))}else{let a=this.dominantId==null?null:this.speakers.get(this.dominantId);if(a==null){const l=this.speakers.entries().next();l.value&&(s=l.value[0],a=l.value[1])}else s=a.id;a?.evaluateSpeechActivityScores(t);const c=this.relativeSpeechActivities;let d=2;for(const l of this.speakers.entries()){const[u,h]=l;if(h===a)continue;h.evaluateSpeechActivityScores(t);for(let y=0;y<c.length;++y){const I=a==null?na:a.getSpeechActivityScore(y);c[y]=Math.log(h.getSpeechActivityScore(y)/I)}const p=c[0],R=c[1],T=c[2];p>3&&R>2&&T>0&&R>d&&(d=R,s=u)}this.enableSilence&&a!=null&&s===a.id&&t-a.lastNonSilence>this.timeoutToSilenceInterval&&(s=null)}s==null&&!this.enableSilence||s===this.dominantId||(n=this.dominantId,this.dominantId=s,i=this.dominantId),i==null&&!this.enableSilence||i===n||this.emit("ActiveSpeakerChanged",i)}_runInDecisionMaker(){const t=Date.now(),n=300-(t-this.lastLevelIdleTime);let i=0;n<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(t),this.lastLevelIdleTime=t):i=n;let r=300-(t-this.lastDecisionTime);return r<=0&&(this.lastDecisionTime=t,this.makeDecision(t),r=300-(Date.now()-t)),r>0&&i>r&&(i=r),i}timeoutIdleLevels(t){const n=[];for(const r of Si(i=this.speakers).call(i)){var i;const s=t-r.getLastLevelChangedTime();36e5<s&&(this.dominantId==null||r.id!==this.dominantId)?n.push(r.id):300<s&&r.levelTimedOut()}n.forEach((r=>this.speakers.delete(r)))}}const bc=new Map;let Lr=null,Uh=null;const OO=3;let ia=[];const kr=new Map,Vh=new Map;class P6{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(t,n){j(this,"id",void 0),j(this,"track",void 0),j(this,"score",0),j(this,"active",!0),j(this,"muted",!1),j(this,"timer",0),j(this,"actives",0),j(this,"inactives",0),this.id=t,this.track=n,this.setActive(kr.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){const t=this.active;this.active=this.activeRate>=.8;const{actives:n,inactives:i}=(function(){const r=[],s=[];return Array.from(Si(kr).call(kr)).forEach((o=>{o.active?r.push(o):s.push(o)})),{actives:r,inactives:s}})();if(n.length>3){let r;n.forEach((s=>{(!r||r.score>s.score)&&(r=s)})),r&&r.setActive(!1)}if(n.length<3&&i.length>0){let r;i.forEach((s=>{(!r||r.score<s.score)&&s.id!==this.id&&(r=s)})),r&&t&&!this.active&&(r.samples>40&&r.activeRate-this.activeRate>.4?r.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(t){this.active=t,this.resetTimer(),this.setMuted(!t)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){const t=(function(n){let i;return Array.from(Si(kr).call(kr)).forEach((r=>{!r.active||r.id===n||r.samples<40||(!i||r.score<i.score)&&(i=r)})),i})(this.id);t&&this.activeRate-t.activeRate>.4&&(t.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){const t=(function(n){let i;return Array.from(Si(kr).call(kr)).forEach((r=>{r.active||r.id===n||r.samples<40||(!i||r.score>i.score)&&(i=r)})),i})(this.id);t&&t.activeRate-this.activeRate>.4&&(t.setActive(!0),this.setActive(!1))}addSample(t){t?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(t){this.track&&(this.track.enabled=!t,this.muted=t)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout((()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()}),1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let jh;function NO(e){const t=kr.get(e);t&&(kr.delete(e),t.clearTimer())}const Fh=new Map,L6=new Map,ug="video/h264",hg="video/h265";function DO(e,t,n){let i=new Uint8Array(e,t,n),r=[],s=0;for(;r.length<n;)s+3<n&&i[s]===0&&i[s+1]===0&&i[s+2]===3&&(i[s+3]===0||i[s+3]===1||i[s+3]===2||i[s+3]===3)?(r.push(i[s],i[s+1],i[s+3]),s+=4):(r.push(i[s]),s++);return new Uint8Array(r)}function PO(e){const t=e.length;let n=[],i=0;for(;i<t;)i+2<t&&e[i]===0&&e[i+1]===0&&(e[i+2]===0||e[i+2]===1||e[i+2]===2||e[i+2]===3)?(n.push(e[i],e[i+1],3,e[i+2]),i+=3):(n.push(e[i]),i++);return new Uint8Array(n)}function LO(e){if(e.length<5)return"";let t=-1;for(let r=0;r<e.length-3;r++){if(e[r]===0&&e[r+1]===0&&e[r+2]===1){t=r;break}if(r<e.length-4&&e[r]===0&&e[r+1]===0&&e[r+2]===0&&e[r+3]===1){t=r;break}}if(t===-1)return"";const n=t+(e[t+2]===0?4:3);if(n>=e.length)return"";const i=e[n];return 128&i?"":(i>>1&63)>=32||n+1<e.length&&(248&e[n+1])==0?hg:(31&i)<=31?ug:""}const Bh=new Map,Xd=new Map;(function(){const e=Ze();pn.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),pn.getStreamFromExtension=e.name===tt.CHROME&&Number(e.version)>34,pn.supportUnifiedPlan=(function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let n=!1;try{t.addTransceiver("audio"),n=!0}catch{}return t.close(),n})(),pn.supportMinBitrate=e.name===tt.CHROME||e.name===tt.EDGE,pn.supportSetRtpSenderParameters=(function(){const t=Ze();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!is()||!(!En()&&!mh())||t.name===tt.FIREFOX&&Number(t.version)>=64)})(),e.name===tt.SAFARI&&(Number(e.version)>=14?pn.supportDualStream=!0:pn.supportDualStream=!1),pn.webAudioMediaStreamDest=(function(){const t=Ze();return!(t.name===tt.SAFARI&&Number(t.version)<12)})(),pn.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",pn.supportWebGL=typeof WebGLRenderingContext<"u",pn.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,is()||(pn.webAudioWithAEC=!0),pn.supportShareAudio=(function(){const t=Ze();return(t.os===un.WIN_10||t.os===un.WIN_81||t.os===un.WIN_7||t.os===un.LINUX||t.os===un.MAC_OS||t.os===un.CHROMIUM_OS)&&t.name===tt.CHROME&&Number(t.version)>=74})(),pn.supportDataChannel=!!(Dr(76)||_E(68)||Cw(14)),pn.supportPCSetConfiguration=(function(){const t=window.RTCPeerConnection;return!It()&&!!t&&t.prototype.setConfiguration instanceof Function})(),pn.supportWebRTCEncodedTransform=Dr(87)||yw()||_E(117),pn.supportWebRTCInsertableStream=(function(){const t=Ze();return(t.name===tt.CHROME||t.name===tt.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window})(),pn.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,pn.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,pn.supportSuppressLocalAudioPlayback=EA(),pn.supportRestrictOwnAudio=gA(),_h((()=>{pn.supportDualStreamEncoding=(function(){const t=Ze();return!!b("DISABLE_WEBAUDIO")||t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&b("CHROME_DUAL_STREAM_USE_ENCODING"))})(),_.debug("browser ua: ",navigator.userAgent),_.info("browser info: ",e),_.info("browser compatibility: ",pn)}))})();const k6=["CHINA","GLOBAL"],kO=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],ra=[],Ic=[];function sa(e,t){return!!t&&ra.some((n=>n.uid===e&&n.channelName===t))}function pg(){return Ic.length>0}var x6=Bb.forEach,xO=Hl("forEach")?[].forEach:function(e){return x6(this,e,arguments.length>1?arguments[1]:void 0)};lt({target:"Array",proto:!0,forced:[].forEach!==xO},{forEach:xO});var M6=Fi("Array","forEach"),U6=zs,V6=Vn,j6=q,F6=M6,mg=Array.prototype,B6={DOMTokenList:!0,NodeList:!0},W6=function(e){var t=e.forEach;return e===mg||j6(mg,e)&&t===mg.forEach||V6(B6,U6(e))?F6:t},G6=D(W6),H6=Qr,MO=Jl;lt({target:"Object",stat:!0,forced:U((function(){MO(1)}))},{keys:function(e){return MO(H6(e))}});var K6=D(bi.Object.keys),Y6=D(YT),z6=D(qT),q6=lt,UO=ad,X6=lu,J6=Yn,VO=Im,Q6=Ys,Z6=Hs,$6=Yf,eH=$t,tH=Xs,nH=Db("slice"),iH=eH("species"),fg=Array,rH=Math.max;q6({target:"Array",proto:!0,forced:!nH},{slice:function(e,t){var n,i,r,s=Z6(this),o=Q6(s),a=VO(e,o),c=VO(t===void 0?o:t,o);if(UO(s)&&(n=s.constructor,(X6(n)&&(n===fg||UO(n.prototype))||J6(n)&&(n=n[iH])===null)&&(n=void 0),n===fg||n===void 0))return tH(s,a,c);for(i=new(n===void 0?fg:n)(rH(c-a,0)),r=0;a<c;a++,r++)a in s&&$6(i,r,s[a]);return i.length=r,i}});var sH=Fi("Array","slice"),oH=q,aH=sH,_g=Array.prototype,cH=function(e){var t=e.slice;return e===_g||oH(_g,e)&&t===_g.slice?aH:t},dH=D(cH);function re(e,t,n,i,r){var s,o,a,c={};return G6(s=K6(i)).call(s,(function(d){c[d]=i[d]})),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=Y6(o=z6(a=dH(n).call(n)).call(a)).call(o,(function(d,l){return l(e,t,d)||d}),c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0?(wb(e,t,c),null):c}let Wh=(function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e})({}),Eg=(function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e})({}),zi=(function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e[e.REQ_DOWNGRADE_FALLBACK=27]="REQ_DOWNGRADE_FALLBACK",e})({}),Zn=(function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e})({}),ye=(function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.K_VOS_FALLBACK=30]="K_VOS_FALLBACK",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e})({}),Ye=(function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e})({}),fe=(function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.PRE_CONNECT_PC="pre_connect_pc",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e.RECOVER_NOTIFICATION="recover_notification",e.VOS_FALLBACK="vos_fallback",e.VOS_FALLBACK_PROMISE="vos_fallback_promise",e})({}),Ee=(function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SET_DUAL_STREAM_MODE="set_dual_stream_mode",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.CONFIGURE="configure",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e.DOWNGRADE_CODEC="downgrade_codec",e})({}),oa=(function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e})({}),Ae=(function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e.ENABLE_MULTI_STREAM="enable_multi_stream",e})({}),$n=(function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e})({}),Le=(function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e.ON_FALLBACK="websocket:on_fallback",e})({});function Gh(e){if(typeof e!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw _.error("Invalid Channel Name ".concat(e)),new V(w.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Hh(e){if(t=e,!(typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295||Lw(e,1,255)))throw new V(w.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;typeof e=="string"&&_.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Ps=(function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e})({});const lH={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},gg={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Sg(e,t){bn(e.url,"".concat(t,".url"),1,1e3,!1),Vt(e.x)||St(e.x,"".concat(t,".x"),0,1e4),Vt(e.y)||St(e.y,"".concat(t,".y"),0,1e4),Vt(e.width)||St(e.width,"".concat(t,".width"),0,1e4),Vt(e.height)||St(e.height,"".concat(t,".height"),0,1e4),Vt(e.zOrder)||St(e.zOrder,"".concat(t,".zOrder"),0,255),Vt(e.alpha)||St(e.alpha,"".concat(t,".alpha"),0,1,!1)}const uH={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let oo=(function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e})({}),Tg=(function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e})({}),on=(function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e})({});function jO(e){if(!e.channelName)throw new V(w.INVALID_PARAMS,"invalid channelName in info");if(typeof e.uid!="number")throw new V(w.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&bn(e.token,"info.token",1,2047),Hh(e.uid),Gh(e.channelName),!0}let oi=(function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e})({}),Ls=(function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e})({}),hi=(function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e})({}),wc=(function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e})({}),pt=(function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e})({}),Kt=(function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.PRE_CONNECT_PC="pre-connect_pc",e.UPDATE_GATEWAY_CONFIG="update-gateway-config",e.VOS_FALLBACK="vos-fallback",e.VOS_FALLBACK_PROMISE="vos-fallback-promise",e.RESET_SIGNAL="reset-signal",e.DATACHANNEL_FAILBACK="datachannel-failback",e})({}),Kh=(function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e})({}),mn=(function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e})({}),rt=(function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e})({});const FO=[rt.AFRICA,rt.ASIA,rt.CHINA,rt.EUROPE,rt.GLOBAL,rt.INDIA,rt.JAPAN,rt.NORTH_AMERICA,rt.OCEANIA,rt.OVERSEA,rt.SOUTH_AMERICA];let kn=(function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e})({});const Yh={CHINA:{},ASIA:{CODE:kn.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:kn.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:kn.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:kn.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:kn.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:kn.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:kn.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:kn.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:kn.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:kn.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:kn.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:kn.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:kn.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};ME&&(Yh.CHINA={CODE:kn.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let xr=(function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",e.UPDATE_REMOTE_VIDEO_STREAM_TYPE="update_remote_video_stream_type",e.FALLBACK_TO_HLS="fallback_to_hls",e.UPDATE_VOS_CONFIGURE="update_vos_configure",e})({});function BO(e){return!!e&&!(!e.uplink||!e.id)&&e.uplink.max_bitrate!==void 0&&e.uplink.min_bitrate!==void 0}class WO extends kt{constructor(t,n){super(),v(this,"onICEConnectionStateChange",void 0),v(this,"onConnectionStateChange",void 0),v(this,"onDTLSTransportStateChange",void 0),v(this,"onDTLSTransportError",void 0),v(this,"onICETransportStateChange",void 0),v(this,"onFirstAudioReceived",void 0),v(this,"onFirstVideoReceived",void 0),v(this,"onFirstAudioDecoded",void 0),v(this,"onFirstVideoDecoded",void 0),v(this,"onFirstVideoRender",void 0),v(this,"onFirstVideoBufferReady",void 0),v(this,"onFirstVideoDecodedTimeout",void 0),v(this,"onSelectedLocalCandidateChanged",void 0),v(this,"onSelectedRemoteCandidateChanged",void 0),v(this,"onICECandidateError",void 0),v(this,"getLocalVideoStats",void 0)}}class zh extends WO{constructor(t,n){super(t,n),v(this,"establishPromise",void 0)}}let ue=(function(e){return e.VIDEO="video",e.AUDIO="audio",e})({}),Sn=(function(e){return e.UDP_RELAY="udp_relay",e.UDP_TCP_RELAY="udp_tcp_relay",e.TCP_RELAY="tcp_relay",e.RELAY="relay",e})({}),ks=(function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.TCP_RESTART=3]="TCP_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e})({});const GO=["disconnected","failed"];let J=(function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e})({}),st=(function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e})({}),ge=(function(e){return e.AudioMetadata="audioMetadata",e.AudioPts="audioPts",e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e.FirstVideoPreRender="FirstVideoPreRender",e.FirstVideoBufferReady="FirstVideoBufferReady",e})({}),pr=(function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e})({}),mr=(function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e})({}),Tn=(function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e})({}),ao=(function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e})({}),an=(function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e})({}),as=(function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e})({}),qi=(function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e})({}),Mr=(function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e})({}),Ac=(function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e})({}),Yt=(function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e})({}),Oc=(function(e){return e.ABORT="abort",e})({}),co=(function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e})({}),hH=(function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e})({});const pH={[Wh.ACCESS_POINT]:{[Zn.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Zn.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Zn.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Zn.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Zn.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Zn.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Zn.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Wh.UNILBS]:{[zi.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[zi.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[zi.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[zi.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[zi.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[zi.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[zi.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[zi.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[zi.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[zi.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[zi.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[zi.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1},[zi.REQ_DOWNGRADE_FALLBACK]:{desc:"request downgrade fallback",retry:!1}},[Wh.STRING_UID_ALLOCATOR]:{[Eg.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[Eg.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[Eg.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Nc(e){const t=pH[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};const n=t[e%1e4];if(!n){if(Math.floor(e/1e4)===Wh.ACCESS_POINT){const i=e%1e4;if(i.toString()[0]==="1")return{desc:e.toString(),retry:!1};if(i.toString()[0]==="2")return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}const mH={[ye.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[ye.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[ye.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[ye.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[ye.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[ye.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[ye.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[ye.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[ye.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[ye.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[ye.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[ye.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[ye.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[ye.K_VOS_FALLBACK]:{desc:"K_VOS_FALLBACK",action:"tryNext"},[ye.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[ye.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[ye.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[ye.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[ye.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[ye.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[ye.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[ye.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[ye.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[ye.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[ye.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[ye.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[ye.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[ye.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[ye.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[ye.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[ye.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[ye.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[ye.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[ye.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[ye.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[ye.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[ye.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[ye.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[ye.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[ye.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[ye.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[ye.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[ye.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ye.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[ye.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[ye.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[ye.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[ye.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[ye.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[ye.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[ye.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[ye.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[ye.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[ye.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[ye.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[ye.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[ye.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[ye.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[ye.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[ye.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[ye.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[ye.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[ye.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[ye.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[ye.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function aa(e){return mH[e]||{desc:"UNKNOWN_ERROR_".concat(e),action:"failed"}}function HO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function yg(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?HO(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):HO(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function vg(e,t){if(typeof e=="string")return e;const{proxy:n,host:i,port:r}=e;if(t){const s=b("JOIN_GATEWAY_FALLBACK_PORT")||443;return s===443?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(s,"/ws/?p=").concat(Number(r)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}const fH=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,_H=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,EH=/wss:\/\/(.+):([0-9]+)\/?/,gH=/wss:\/\/(.[^\/]+)\/?/;let SH=0;class TH{constructor(t,n){v(this,"id",0),v(this,"store",void 0),v(this,"recordIndex",void 0),v(this,"websockets",[]),v(this,"try443PortDuration",2e3),v(this,"forceCloseWSDuration",5e3),v(this,"try443PortTimeout",null),v(this,"forceCloseTimeout",null),v(this,"isTry443PortFailed",!1),v(this,"isNormalPortFailed",!1),v(this,"useDoubleDomain",!1),v(this,"useProxy",!1),v(this,"startTime",Date.now()),this.id=++SH,this.try443PortDuration=b("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach((t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var t;const n=Date.now()-this.startTime;for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];_.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...r)}createWebSocket(t,n,i){this.logger("createWebSocket:",t,{isTry443Port:n,hasTimeoutDetection:i});const r=b("GATEWAY_DOMAINS"),s=Date.now(),o=[],a=r.find((h=>{var p;return X(p=t.host).call(p,h)}));a||(this.useDoubleDomain=!1);const c=[];if(this.useDoubleDomain)r.forEach((h=>{c.push(vg(yg(yg({},t),{},{host:t.host.replace(a,h)}),n))}));else{const h=yg({},t);if(n&&a){const p=r.find((R=>R!==a));p&&(h.host=h.host.replace(a,p))}c.push(vg(h,n))}try{c.forEach((h=>{const p=new WebSocket(h);p.binaryType="arraybuffer",o.push(p),this.logger("ws is connecting:",p.url)}))}catch(h){if(this.logger("ws create failed"),o.forEach((p=>p.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,n,i);if(!n&&Number(t.port)!==443)return this.createWebSocket(t,!0,i);throw new V(w.WS_ERR,"init websocket failed! Error: ".concat(h.toString()))}const d=Ud();this.store&&this.store.recordJoinChannelService({urls:o.map((h=>h.url)),service:"gateway"},this.recordIndex),o.forEach((h=>{h.onopen=()=>{this.logger("onopen: ws ".concat(h.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((p=>{p!==h&&(p.onopen=null,p.onclose=null,p.onmessage=null,p.close(),this.logger("close backup websocket: ".concat(p.url)))})),this.websockets.length=0,d.resolve(h)},h.onclose=p=>{this.logger("onclose: ws ".concat(h.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(h.readyState));const R=o.every((T=>T.readyState===WebSocket.CLOSED||T.readyState===WebSocket.CLOSING));this.logger("".concat(n?"443":"47xx"," websocket closed, all failed: ").concat(R)),R&&(n||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(p.reason)),d.reject({code:p.code,reason:Kh.A_ROUND_WS_FAILED})):!n&&R&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),u()),n?this.isTry443PortFailed=R:this.isNormalPortFailed=R},h.onmessage=p=>this.logger("".concat(h.url," onmessage: ").concat(p.data))})),this.websockets.push(...o);const l=()=>{this.websockets.forEach((h=>h.readyState!==WebSocket.OPEN&&h.close()))},u=()=>{if(d.isResolved)return l();Ze().os===un.MAC_OS&&It()&&l(),this.createWebSocket(t,!0,!0).then((h=>{d.resolve(h)})).catch((h=>{this.isNormalPortFailed&&d.reject(h),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout((()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.forceCloseTimeout=null,l()}),this.forceCloseWSDuration)};return i||(()=>{if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout((()=>{this.forceCloseTimeout=null,l()}),this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{this.logger("2s timeout, isWebsocket created: ",d.isResolved),this.try443PortTimeout=null,u()}),this.try443PortDuration)})(),d.promise}chooseBestWebsocket(t,n,i,r){return this.useDoubleDomain=!!n,typeof t=="string"&&(t=(function(s){let o,a,c;return[,o,a,c]=s.match(fH)||[],o||([,a,c]=s.match(_H)||[]),a&&c||([,a,c]=s.match(EH)||[]),a&&c||([,a]=s.match(gH)||[]),a||_.warning("un-destructible url: ",s),{proxy:o,host:a,port:c||"443"}})(t)),this.recordIndex=r,this.useProxy=!!t.proxy,i&&this.useProxy&&(_.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(t,!!i,!1).finally((()=>this.clearTimeout()))}}function KO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}class YO extends kt{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var n;X(n=["tryNext","recover"]).call(n,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(Le.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Le.CONNECTED):this._state==="closed"?this.emit(Le.CLOSED):this._state==="failed"&&this.emit(Le.FAILED))}resetReconnectCount(t){_.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],s=arguments.length>4&&arguments[4]!==void 0&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),v(this,"_websocketUrl",null),v(this,"connectionID",0),v(this,"currentURLIndex",0),v(this,"urls",[]),v(this,"_reconnectMode","tryNext"),v(this,"reconnectReason",void 0),v(this,"_initMutex",void 0),v(this,"name",void 0),v(this,"_state","closed"),v(this,"reconnectInterrupter",void 0),v(this,"websocket",void 0),v(this,"retryConfig",void 0),v(this,"reconnectCount",0),v(this,"forceCloseTimeout",5e3),v(this,"onlineReconnectListener",void 0),v(this,"useCompress",void 0),v(this,"tryDoubleDomain",!1),v(this,"use443PortOnly",!1),v(this,"wsInflateLength",0),v(this,"wsDeflateLength",0),v(this,"closeEstablishingWs",(()=>{})),v(this,"store",void 0),v(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=t,this.retryConfig=(function(u){for(var h=1;h<arguments.length;h++){var p=arguments[h]!=null?arguments[h]:{};h%2?KO(Object(p),!0).forEach((function(R){v(u,R,p[R])})):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(p)):KO(Object(p)).forEach((function(R){Object.defineProperty(u,R,Object.getOwnPropertyDescriptor(p,R))}))}return u})({},n),this.useCompress=i,this.tryDoubleDomain=r,this.use443PortOnly=s,this._initMutex=new gn("websocket",o?o.clientId:void 0);const{timeout:a,timeoutFactor:c}=n,d=Math.max(300,Math.floor(3*a/5)),l=Math.max(1.2,Math.floor(8*c)/10);Xn.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l),jt.on(Ko.NETWORK_STATE_CHANGE,((u,h)=>{u!==h&&(this.resetReconnectCount("network state change: ".concat(h," -> ").concat(u)),u===Xn.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))}))}getConnection(){return this.websocket||void 0}async init(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=n,this.urls=t,this.state="connecting";try{var r;const s=Ud(),o=this.urls[this.currentURLIndex];(r=this.store)===null||r===void 0||r.beforeConnect(),(function(a){return!(bh()||b("USE_NEW_TOKEN")||!b("ENABLE_PREALLOC_PC")&&(a==null||!a.autoSubscribe||b("FORCE_DISABLE_AUTO_SUB")))})(this.store)&&this.emit(an.PRE_CONNECT_PC),this.createWebSocketConnection(o).then(s.resolve).catch(s.reject),this.once(Le.CLOSED,(()=>{s.reject(new F(w.WS_DISCONNECT))})),this.once(Le.CONNECTED,s.resolve),await s.promise}catch{}finally{i()}}close(t,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const i=this.websocket;n?setTimeout((()=>i.close()),500):i.close(),this.websocket=void 0,this._websocketUrl=null}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,n){if(!this.websocket)return void _.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),_.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);const i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:n})}sendMessage(t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new F(w.WS_ABORT,"websocket is not ready");try{n||(t=JSON.stringify(t)),this.websocket.send(t)}catch(i){throw new F(w.WS_ERR,"send websocket message error"+i.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var n;const i=Ud();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const r=l=>{var u;(u=this.store)===null||u===void 0||u.signalChannelOpen(),_.debug("[".concat(this.name,"] websocket opened:"),l),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},s=async l=>{var u;if(_.debug("[".concat(this.name,"] websocket close ").concat((u=this.websocket)===null||u===void 0?void 0:u.url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new F(w.WS_DISCONNECT,"websocket close: ".concat(l.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");const h=vi(this,Le.WILL_RECONNECT,this.reconnectMode,l.reason)||this.reconnectMode,p=await this.reconnectWithAction(h);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!p)return i.reject(new F(w.WS_DISCONNECT,"websocket reconnect failed: ".concat(l.code))),this.close(!0);i.resolve()}},o=l=>{this.emit(Le.ON_MESSAGE,l)},a=l=>{_.warn("[".concat(this.connectionID,"] ws open error ").concat(l))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),b("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=b("GATEWAY_WSS_ADDRESS")),_.debug("[".concat(this.name,"] start connect, url:"),t);const c=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;this._websocketUrl=vg(t);const l=await this.chooseBestWebsocketConnection(t);this.websocket=l,r&&r(this.websocket.url),this.websocket.onclose=s,this.websocket.onmessage=o,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(l){const u=this.state==="closed",h=l instanceof F,p=h&&l.code===w.WS_ABORT,R=h&&l.code===w.WS_ERR,T=h?l.message:l&&(l.reason||l.toString());_.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(T)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:p?"aborted":"error",errors:[l]},c),u||R?(i.reject(u?new F(w.WS_DISCONNECT,"websocket is closed: ".concat(T)):new F(w.WS_ERR,"init websocket failed: ".concat(T))),R&&_.error("[".concat(this.name,"] init websocket failed: ").concat(T))):s&&s(l)}return i.promise}async reconnectWithAction(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;_.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||jt.isOnline||!jt.onlineWaiter||(this.onlineReconnectListener=jt.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let i=!0;if(this.reconnectInterrupter=()=>i=!1,n){const o=Eh(this.reconnectCount,this.retryConfig);_.debug("[".concat(this.name,"] wait ").concat(o,"ms to reconnect websocket, mode: ").concat(t)),await ie.race([hn(o),this.onlineReconnectListener||new ie((()=>{}))])}if(this._state==="closed"||!i)return!1;this.reconnectCount+=1;const r=async(o,a)=>{this.emit(Le.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(o)};try{if(t==="retry")await r(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);_.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await r(this.urls[this.currentURLIndex],t)}else t==="recover"&&(_.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await en(this,Le.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],t))}catch(o){var s;_.error("[".concat(this.name,"] reconnect failed ").concat(o&&o.toString()));const a=o==null||(s=o.data)===null||s===void 0?void 0:s.desc;if(Array.isArray(a)){if(X(a).call(a,"dynamic key expired"))return this.emit(Le.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1;if(X(a).call(a,"request downgrade fallback"))return this.emit(Le.ON_FALLBACK),!1}return this.reconnectWithAction(t,n)}return!0}}class Rg extends YO{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,n){const i=Ud(),r=(function(o,a){return new TH(o,a)})(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),i.reject(new F(w.WS_ABORT,"choose best websocket aborted"))};const s=b("GATEWAY_DOMAINS");return _.debug("[choose-best-ws] currentDomain: ",t,", domains: ",s,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,n).then(i.resolve).catch(i.reject),i.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class Jd extends YO{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,n){return new ie(((i,r)=>{let s=!1;const o=[];this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),o.forEach((R=>{R.onclose=null,R.onopen=null,R.onmessage=null,R.close()})),r(new F(w.WS_ABORT,"choose best websocket aborted"))};const a=b("GATEWAY_DOMAINS");let c;const d=t.indexOf("?h="),l=a.find((R=>d!==-1?X(t).call(t,R,d):X(t).call(t,R)));_.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let u=!this.tryDoubleDomain||!l;if(!u&&l){var h;const R=Date.now();try{a.forEach((T=>{const y=d===-1?t.replace(l,T):t.substr(0,d)+t.substr(d).replace(l,T),I=new WebSocket(y);I.binaryType="arraybuffer",o.push(I),_.debug("[choose-best-ws] ws is connecting:",I.url)}))}catch{for(_.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach((y=>y.close()));o.length;)o.pop();u=!0}(h=this.store)===null||h===void 0||h.recordJoinChannelService({urls:o.map((T=>T.url)),service:"gateway"},n),o.forEach((T=>{T.onopen=()=>{if(s)return;const y=Date.now()-R;_.debug("[choose-best-ws] ws open cost ".concat(y,"ms")),o.filter((I=>I!==T)).forEach((I=>{_.debug("[choose-best-ws]close backup websocket: ".concat(I.url)),I.close()})),s=!0,i(T)},T.onclose=y=>{c=y,!s&&(o.find((I=>!(I.readyState===WebSocket.CLOSED||I.readyState===WebSocket.CLOSING)))||(_.debug("[choose-best-ws] all websocket is closed"),s=!0,r(c)))},T.onmessage=y=>{_.debug("[choose-best-ws]".concat(T.url," onmessage: ").concat(y.data))}})),hn(this.forceCloseTimeout).then((()=>{o.forEach((T=>{T.readyState!==WebSocket.OPEN&&T.close()}))}))}if(u){var p;let R;_.debug("[choose-best-ws] use single url: ",t),(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:[t],service:"gateway"},n);try{R=new WebSocket(t),o.push(R),R.binaryType="arraybuffer"}catch(T){const y=new F(w.WS_ERR,"init websocket failed! Error: ".concat(T.toString()));return _.error("[".concat(this.name,"]").concat(y)),void r(y)}R.onopen=()=>{i(R)},R.onclose=T=>{r(T)},R.onmessage=T=>{_.debug("[choose-best-ws]".concat(R.url," onmessage: ").concat(T.data))},hn(this.forceCloseTimeout).then((()=>{R&&R.readyState!==WebSocket.OPEN&&R.close()}))}})).then((i=>(this.closeEstablishingWs=void 0,i))).catch((i=>{throw this.closeEstablishingWs=void 0,i}))}}class zO extends kt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Ye.CONNECTED?this.emit(fe.WS_CONNECTED):t===Ye.RECONNECTING?this.emit(fe.WS_RECONNECTING,this._websocketReconnectReason):t===Ye.CLOSED&&this.emit(fe.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,n){super(),v(this,"__name__","AgoraRTCSignal"),v(this,"_disconnectedReason",void 0),v(this,"_websocketReconnectReason",void 0),v(this,"_connectionState",Ye.CLOSED),v(this,"reconnectToken",void 0),v(this,"websocket",void 0),v(this,"openConnectionTime",void 0),v(this,"clientId",void 0),v(this,"lastMsgTime",Date.now()),v(this,"uploadCache",[]),v(this,"uploadCacheInterval",void 0),v(this,"rttRolling",new OE(5)),v(this,"pingpongTimer",void 0),v(this,"wsInflateDataTimer",void 0),v(this,"pingpongTimeoutCount",0),v(this,"ortc",void 0),v(this,"joinResponse",void 0),v(this,"multiIpOption",void 0),v(this,"initError",void 0),v(this,"spec",void 0),v(this,"store",void 0),v(this,"onWebsocketMessage",(i=>{if(i.data instanceof ArrayBuffer)return void this.emit(fe.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===Ae.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Ae.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ke.UID_BANNED);break;case 15:this.close(Ke.IP_BANNED);break;case 16:this.close(Ke.CHANNEL_BANNED)}if(r._type===Ae.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case ye.ERR_LICENSE_MISSING:this.close(Ke.LICENSE_MISSING);break;case ye.ERR_LICENSE_EXPIRED:this.close(Ke.LICENSE_EXPIRED);break;case ye.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ke.LICENSE_MINUTES_EXCEEDED);break;case ye.ERR_LICENSE_PERIOD_INVALID:this.close(Ke.LICENSE_PERIOD_INVALID);break;case ye.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ke.LICENSE_MULTIPLE_SDK_SERVICE);break;case ye.ERR_LICENSE_ILLEGAL:this.close(Ke.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new Rg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,b("JOIN_GATEWAY_USE_DUAL_DOMAIN"),b("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===Ye.CONNECTED&&this.reconnect("retry",On.OFFLINE)}))}async request(t,n,i,r){const s=ut(6,""),o={_id:s,_type:t,_message:n},a=this.websocket.connectionID,c=()=>new ie(((R,T)=>{if(this.connectionState===Ye.CONNECTED)return R();const y=()=>{this.off(fe.WS_CLOSED,I),R()},I=()=>{this.off(fe.WS_CONNECTED,y),T(new V(w.WS_ABORT))};this.once(fe.WS_CONNECTED,y),this.once(fe.WS_CLOSED,I),t!==Ee.PUBLISH&&t!==Ee.PUBLISH_DATASTREAM&&t!==Ee.SUBSCRIBE&&t!==Ee.SUBSCRIBE_DATASTREAM&&t!==Ee.UNSUBSCRIBE&&t!==Ee.UNSUBSCRIBE_DATASTREAM&&t!==Ee.UNPUBLISH&&t!==Ee.UNPUBLISH_DATASTREAM&&t!==Ee.CONTROL&&t!==Ee.RESTART_ICE||this.once(fe.DISCONNECT_P2P,(()=>{T(new V(w.DISCONNECT_P2P))})),t!==Ee.PUBLISH&&t!==Ee.RESTART_ICE||this.once(fe.ABORT_P2P_EXECUTION,(()=>{T(new V(w.DISCONNECT_P2P))}))}));if(this.connectionState!==Ye.CONNECTING&&this.connectionState!==Ye.RECONNECTING||t===Ee.JOIN||t===Ee.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const d=new ie(((R,T)=>{let y=!1;const I=(N,k)=>{y=!0,R({isSuccess:N==="success",message:k||{}}),this.off(fe.WS_CLOSED,A),this.off(fe.WS_RECONNECTING,A),this.emit(fe.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(s),I);const A=()=>{T(new V(w.WS_ABORT,"type: ".concat(t))),this.off(fe.WS_CLOSED,A),this.off(fe.WS_RECONNECTING,A),this.off("res-@".concat(s),I)};this.once(fe.WS_CLOSED,A),this.once(fe.WS_RECONNECTING,A),hn(b("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||y||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(fe.REQUEST_TIMEOUT,t,n))}))}));let l=null;try{l=await d}catch(R){if(this.connectionState===Ye.CLOSED||t===Ee.LEAVE)throw new V(w.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?R.throw():t===Ee.JOIN||t===Ee.REJOIN?null:(await c(),await this.request(t,n))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),h=aa(u),p=new V(w.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message,desc:h.desc});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===ye.ERR_TOO_MANY_BROADCASTERS?((t===Ee.JOIN||t===Ee.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===ye.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",On.MULTI_IP)):this.reconnect(h.action,On.SERVER_ERROR),t===Ee.JOIN||t===Ee.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new ie((i=>{const r=s=>{(!n||n(s))&&(this.off(t,r),i(s))};this.on(t,r)}))}uploadWRTCStats(t){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(oa.WRTC_STATS,n)}upload(t,n){const i={_type:t,_message:n};try{this.websocket.sendMessage(i)}catch{const s=b("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==Ye.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)}),b("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,n){const i={_type:t,_message:n};this.websocket.sendMessage(i)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ie(((n,i)=>{this.once(fe.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(fe.WS_CLOSED,(r=>i(this.initError||new V(w.WS_ABORT,r)))),this.connectionState=Ye.CONNECTING,this.websocket.init(t).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||Ke.LEAVE,this.connectionState=Ye.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(fe.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await en(this,fe.REQUEST_JOIN_INFO);this.store.joinReq();const n=await this.request(Ee.JOIN,t);if(this.ortc=t?.ortc,this.store.joinRep(),!n)return this.emit(fe.REPORT_JOIN_GATEWAY,Kh.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(fe.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Ye.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new V(w.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=Yo(this,fe.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const n=await this.request(Ee.REJOIN,t);return!!n&&(this.connectionState=Ye.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach((i=>{this.emit(Ae.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Ae.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Ae.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Ae.MUTE_AUDIO,{uid:i.uid}):this.emit(Ae.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Ae.MUTE_VIDEO,{uid:i.uid}):this.emit(Ae.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Ae.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Ae.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Ae.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Ae.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Ae.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})})),!0)}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}async downgradeCodec(t){if(!this.ortc)return!1;const n={downgrade_codec:t,ortc:this.ortc};return!!await this.request(Ee.DOWNGRADE_CODEC,n)}handleNotification(t){_.debug("[".concat(this.clientId,"] receive notification: "),t);const n=aa(t.code);if(t.code===28&&"detail"in t&&(_.info("[".concat(this.clientId,"] receive recover notification: "),t.detail),this.emit(fe.RECOVER_NOTIFICATION,t.detail)),n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?t.code===ye.ERR_REPEAT_JOIN_CHANNEL&&b("IGNORE_UID_CHECK")?void this.close(Ke.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ke.UID_BANNED),void this.close()):t.code===ye.K_VOS_FALLBACK&&"detail"in t?(_.info("[".concat(this.clientId,"] receive vos fallback notification: "),t.detail),t.detail==="FALLBACKCN"&&b("ENABLE_QUALITY_FALLBACK")?void en(this,fe.VOS_FALLBACK_PROMISE,t.detail).then((()=>{this.reconnect("recover",n.desc)})).catch((i=>{_.debug("[".concat(this.clientId,"] cancel vos fallback cn, error: "),i)})):t.detail==="fallback_hls"&&b("ENABLE_FALLBACK_TO_HLS")?(this.emit(fe.VOS_FALLBACK,t.detail),void this.close(Ke.FALLBACK_TO_HLS)):this.reconnect(n.action,n.desc)):void this.reconnect(n.action,On.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=b("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(_.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>b("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",On.TIMEOUT):this.request(Ee.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),b("REPORT_STATS")&&this.send(Ee.PING_BACK,{pingpongElapse:i})})).catch((i=>{}))}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:n}=this.websocket.getWsInflateData();t!==0&&n!==0&&this.upload(oa.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(Le.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(fe.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(Le.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Le.CLOSED,(()=>{this.connectionState=Ye.CLOSED})),this.websocket.on(Le.FAILED,(()=>{this._disconnectedReason=Ke.NETWORK_ERROR,this.connectionState=Ye.CLOSED})),this.websocket.on(Le.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Ye.CONNECTED?this.connectionState=Ye.RECONNECTING:this.connectionState=Ye.CONNECTING})),this.websocket.on(Le.WILL_RECONNECT,((t,n,i)=>{const r=Yo(this,fe.IS_P2P_DISCONNECTED),s=r||t!=="retry";r&&t==="retry"&&(_.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",n=Kh.P2P_DISCONNECTED),s&&(_.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(fe.REPORT_JOIN_GATEWAY,n||Kh.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(fe.DISCONNECT_P2P)),i(t)})),this.websocket.on(Le.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",On.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(fe.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof V){if(t.code===w.UNEXPECTED_RESPONSE&&t.data.code===ye.ERR_NO_AUTHORIZED)return this.initError=new V(w.TOKEN_EXPIRE,"dynamic key expired"),void this.close(Ke.TOKEN_EXPIRE);_.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",On.SERVER_ERROR):(this.initError=t,this.close())}}))})),this.websocket.on(Le.REQUEST_NEW_URLS,((t,n)=>{en(this,fe.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)})),this.websocket.on(Le.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(an.PRE_CONNECT_PC,(()=>{this.emit(fe.PRE_CONNECT_PC)})),this.websocket.on(Le.ON_FALLBACK,(()=>{b("ENABLE_FALLBACK_TO_HLS")&&this.emit(fe.VOS_FALLBACK,"fallback_hls")}))}}let yH=(function(e){return e.NATIVE_RTC="native_rtc",e.NATIVE_RTM="native_rtm",e.WEB_RTC="web_rtc",e.WEB_RTM="web_rtm",e})({}),Jt=(function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e})({});function qO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function qh(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?qO(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qO(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let Cg=0;function fr(e){const t=b("TURN_DOMAINS");Cg=(Cg+1)%t.length;const n=t[Cg]||"edge.agora.io";return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(n):(_.debug("Cannot recognized as ip address: ".concat(e,", use as host2")),e)}function Xh(e){try{const t=b("TURN_DOMAINS"),n=b("GATEWAY_DOMAINS").concat(t).find((i=>X(e).call(e,i)));return n?e.split(".".concat(n))[0].replace(/-/g,"."):e}catch{return _.debug("serverUrlToIp error, fallback to url",e),e}}function bg(e,t){e.addresses||(e.addresses=[]);const n=(function(a,c){if(b("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return a.map((u=>{let{ip:h,port:p}=u;return{address:"".concat(h,":").concat(p)}}));const d=b("GATEWAY_DOMAINS");let l=d[1]&&X(c).call(c,d[1])?1:0;return a.map((u=>{let{domain_prefix:h,port:p,ip:R}=u;if(h)return{address:"".concat(h,".").concat(d[l++%d.length],":").concat(p)};const T=/^[\.\:\d]+$/.test(R),y=T?"".concat(R.replace(/[^\d]/g,"-"),".").concat(d[l++%d.length],":").concat(p):"".concat(R,":").concat(p);return T||_.debug("Cannot recognized as ip address: ".concat(R,", use as host3")),{ip:R,port:p,address:y}}))})(e.addresses,t),i=Array.isArray(e.detail)&&e.detail[18];if(i&&typeof i=="string"){const a=i.split(";");for(let c=0;c<a.length;c++){var r;const d=zn(r=a[c]).call(r);n[c]&&d&&(n[c].ip6=d)}}const s=e.detail&&e.detail.candidate;let o;if(s){const[a,c]=s.split(":");a&&c&&(o={port:Number(c),ip:a,address:"".concat(a,":").concat(c)})}return{gatewayAddrs:n,apGatewayAddress:o,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function ai(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function XO(e){const t=e._encoderConfig;if(!t)return{};const n={resolution:t.width&&t.height?"".concat(ai(t.width),"x").concat(ai(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(n.maxFrameRate=t.frameRate,n.minFrameRate=t.frameRate):t.frameRate&&(n.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,n.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),n}function Jh(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function Qd(e,t){let n,i,r;switch(t){case Jt.CHOOSE_SERVER:i=4096,r="choose server";break;case Jt.CLOUD_PROXY:i=1048576,r="proxy";break;case Jt.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case Jt.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new V(w.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((s=>{s.buffer&&s.buffer.flag===i&&(n={code:s.buffer.code,addresses:(s.buffer.edges_services||[]).map((o=>qh(qh({},o),{},{ticket:s.buffer.cert}))),server_ts:e.enter_ts,uid:s.buffer.uid,cid:s.buffer.cid,cname:s.buffer.cname,detail:qh(qh({},s.buffer.detail),e.detail),flag:s.buffer.flag,opid:e.opid,cert:s.buffer.cert})})),!n)throw new V(w.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return n}async function JO(e,t){return await ie.all(e.addresses.map((async n=>({address:fr(n.ip),tcpport:n.port,udpport:n.port,username:t&&b("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():Nn.username,password:t&&b("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await vE(t.toString()):Nn.password}))))}function Ig(e,t){const n=t.getMediaStreamTrack(!0).getSettings(),i=t.videoHeight||n.height,r=t.videoWidth||n.width;return i&&r?Math.max(Math.min(i,r)/Math.min(ai(e.height),ai(e.width)),1):(_.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function lo(e){let{candidateType:t,relayProtocol:n,type:i,address:r,port:s,protocol:o}=e;const a={candidateType:t,relayProtocol:n,protocol:o};if(i!=="local-candidate"){const c=r.split(".");c.length>=4&&(c[1]="*",c[2]="*"),a.address=c.join("."),a.port=s}return a}function cs(e){const t=e.split(":"),n=e.split(/[-.]/),i=X(e).call(e,"-")?"-":".";let r=e;return t.length>1?n.length>1?(n[1]="**",r=n[0]+i+"**:"+t[t.length-1]):r=t.length>2?t[0]+i+"**:"+t[t.length-1]:"**:"+t[t.length-1]:n.length>1&&(r=n[0]+i+"**"),r}function QO(e,t){return e.getTransceivers().find((n=>n.sender.track===t||n.receiver.track===t))}function Zd(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:b("SVC_MODE");if(b("ENABLE_SVC"))return(function(t){return t in Th})(e)?e:Th.L1T3}const ZO={[ue.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[ue.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function $O(e){e.send&&(Dc(ue.VIDEO,e.send.videoExtensions),Dc(ue.AUDIO,e.send.audioExtensions)),e.recv&&(Dc(ue.VIDEO,e.recv.videoExtensions),Dc(ue.AUDIO,e.recv.audioExtensions)),e.sendrecv&&(Dc(ue.VIDEO,e.sendrecv.videoExtensions),Dc(ue.AUDIO,e.sendrecv.audioExtensions))}function eN(e,t){e.send&&(Qh(ue.VIDEO,e.send.videoExtensions,t.send.videoExtensions),Qh(ue.AUDIO,e.send.audioExtensions,t.send.audioExtensions)),e.recv&&(Qh(ue.VIDEO,e.recv.videoExtensions,t.recv.videoExtensions),Qh(ue.AUDIO,e.recv.audioExtensions,t.recv.audioExtensions))}function Qh(e,t,n){t.forEach((i=>{var r;const s=ZO[e].find((a=>{var c;let{key:d}=a;return X(c=i.extensionName).call(c,d)}));if(!s)return;const o=n.find((a=>{let{extensionName:c}=a;return X(c).call(c,s.key)}));o&&X(r=o.extensionName).call(r,"gdpr_forbidden")&&(i.extensionName=o.extensionName)}))}function Dc(e,t){t.forEach((n=>{var i;const r=ZO[e].find((s=>{var o;let{key:a}=s;return X(o=n.extensionName).call(o,a)}));X(i=n.extensionName).call(i,"gdpr_forbidden")&&r&&(n.extensionName=r.extensionName)}))}function tN(e){return e==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||X(e).call(e,"abs-send-time")}function Zh(e){return e==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||X(e).call(e,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function nN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function iN(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?nN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function $d(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:s,filterAudioFec:o,filterAudioCodec:a,filterVideoCodec:c,unsupportedVideoUplinkCodec:d,unsupportedVideoDownlinkCodec:l}=t,{useXR:u}=n;let h=[],p=[],R=[],T=[],y=!1,I=!1;if(Jn(e).mediaDescriptions.forEach((N=>{i&&i!==N.attributes.direction||(N.media.mediaType!=="video"||y||(p=N.attributes.payloads,T=N.attributes.extmaps,y=!0),N.media.mediaType!=="audio"||I||(h=N.attributes.payloads,R=N.attributes.extmaps,I=!0))})),!T||p.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!R||h.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(p.forEach((N=>{var k;(k=N.rtpMap)!==null&&k!==void 0&&k.clockRate&&(N.rtpMap.clockRate=parseInt(N.rtpMap.clockRate)),u&&N.rtcpFeedbacks.push({type:"rrtr"})})),h.forEach((N=>{var k;(k=N.rtpMap)!==null&&k!==void 0&&k.clockRate&&(N.rtpMap.clockRate=parseInt(N.rtpMap.clockRate)),u&&N.rtcpFeedbacks.push({type:"rrtr"})})),r&&(h=h.filter((N=>{var k;return((k=N.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())!=="rtx"})),p=p.filter((N=>{var k;return((k=N.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())!=="rtx"}))),s){const N=p.filter((P=>{var M;return/(red)|(ulpfec)|(flexfec)/i.test(((M=P.rtpMap)===null||M===void 0?void 0:M.encodingName)||"")})),k=uo(N,p).map((P=>P.payloadType)),x=[...N.map((P=>P.payloadType)),...k];p=p.filter((P=>!X(x).call(x,P.payloadType)))}if(o&&(h=h.filter((N=>{var k;return!/(red)|(ulpfec)|(flexfec)/i.test(((k=N.rtpMap)===null||k===void 0?void 0:k.encodingName)||"")}))),a&&a?.length>0&&(h=h.filter((N=>{var k;return X(a).call(a,((k=N.rtpMap)===null||k===void 0?void 0:k.encodingName.toLowerCase())||"")}))),c&&c?.length>0){const N=p.filter((k=>{var x;return X(c).call(c,((x=k.rtpMap)===null||x===void 0?void 0:x.encodingName.toLowerCase())||"")}));p=N.concat(r?[]:uo(N,p))}const A=b("UNSUPPORTED_VIDEO_CODEC");if(A&&A.length>0){const N=p.filter((P=>P.rtpMap&&X(A).call(A,P.rtpMap.encodingName.toLowerCase()))),k=uo(N,p),x=N.concat(k).map((P=>P.payloadType));p=p.filter((P=>!X(x).call(x,P.payloadType))),_.debug("unsupportedVideoCodec: ".concat(A,", toBeRemoved: ").concat(x))}if(d&&d.length>0&&i==="sendonly"){const N=p.filter((P=>P.rtpMap&&X(d).call(d,P.rtpMap.encodingName.toLowerCase()))),k=uo(N,p),x=N.concat(k).map((P=>P.payloadType));p=p.filter((P=>!X(x).call(x,P.payloadType))),_.debug("unsupportedVideoUplinkCodec: ".concat(d,", toBeRemoved: ").concat(x))}if(l&&l.length>0&&i==="recvonly"){const N=p.filter((P=>P.rtpMap&&X(l).call(l,P.rtpMap.encodingName.toLowerCase()))),k=uo(N,p),x=N.concat(k).map((P=>P.payloadType));p=p.filter((P=>!X(x).call(x,P.payloadType))),_.debug("unsupportedVideoDownlinkCodec: ".concat(l,", toBeRemoved: ").concat(x))}return{audioCodecs:h,videoCodecs:p,audioExtensions:R,videoExtensions:T}}function ds(e){const t=Jn(e);let n,i;for(const r of t.mediaDescriptions){if(!n){const s=r.attributes.iceUfrag,o=r.attributes.icePwd;if(!s||!o)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:s,icePwd:o}}if(!i){const s=r.attributes.fingerprints;s.length>0&&(i={fingerprints:s})}}if(!i&&t.attributes.fingerprints.length>0&&(i={fingerprints:t.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:i}}function wg(e,t){const n=[],i=e.attributes.ssrcGroups.filter((o=>o.semantic==="FID")),r=e.attributes.ssrcGroups.find((o=>o.semantic==="SIM")),s=e.attributes.ssrcs;if(r)r.ssrcIds.forEach((o=>{var a;const c=(a=i.find((d=>d.ssrcIds[0]===o)))===null||a===void 0?void 0:a.ssrcIds[1];n.push({ssrcId:o,rtx:t?c:void 0})}));else if(i.length>0){const o=i[0].ssrcIds[0],a=i[0].ssrcIds[1];n.push({ssrcId:o,rtx:t?a:void 0})}else{if(s.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:s[0].ssrcId})}return n}function rN(e,t,n){const{cname:i}=e;let r=[];t&&(r=sN(t)),r.length===0&&(r=e.iceParameters.candidates.map((l=>({foundation:l.foundation,componentId:"1",transport:l.protocol,priority:l.priority.toString(),connectionAddress:l.ip,port:l.port.toString(),type:l.type,extension:{}}))),_.debug("Using candidates from gateway."));const s={fingerprints:e.dtlsParameters.fingerprints.map((l=>({hashFunction:l.algorithm,fingerprint:l.fingerprint})))},o={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let a;switch(e.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}const c=tl(e.rtpCapabilities),d=[];return Array.isArray(n)&&n.length>0&&n.forEach((l=>{d.push({kind:ue.VIDEO,ssrcMsg:[{ssrcId:l.v,rtx:l.v_rtx}],mslabel:"".concat(l.v,"_").concat(l.a)},{kind:ue.AUDIO,ssrcMsg:[{ssrcId:l.a}],mslabel:"".concat(l.v,"_").concat(l.a)})})),{dtlsParameters:s,iceParameters:o,candidates:r,rtpCapabilities:c,setup:a,cname:i,preSSRCs:d}}function sN(e){let t=[];return e.ip&&typeof e.port=="number"&&(t=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],_.debug("Using remote candidate from AP ".concat(cs(e.ip),":").concat(e.port)),e.ip6&&(t.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),_.debug("Using IPV6 remote candidate from AP ".concat(cs(e.ip6),":").concat(e.port)))),t}function el(e,t,n){const i=[],r=[];return e.forEach((s=>{let{ssrcId:o,rtx:a}=s;const c=ut(8,"track-"),d={ssrcId:o,attributes:iN({label:c,mslabel:n=n||ut(10,""),msid:"".concat(n," ").concat(c)},t&&{cname:t})};if(i.push(d),a!==void 0){const l={ssrcId:a,attributes:iN({label:c,mslabel:n,msid:"".concat(n," ").concat(c)},t&&{cname:t})};i.push(l),r.push({semantic:"FID",ssrcIds:[o,a]})}})),e.length>1&&r.push({semantic:"SIM",ssrcIds:e.map((s=>{let{ssrcId:o}=s;return o}))}),{ssrcs:i,ssrcGroups:r}}function ca(e,t){t instanceof Wt&&e.attributes.payloads.forEach((n=>{var i;const r=(i=n.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),r==="opus"&&typeof b("OPUS_PTIME")=="number"?n.fmtp.parameters.ptime=b("OPUS_PTIME"):n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&(r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(s.bitrate&&!It()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1")),t instanceof qd&&r==="opus"&&t._config.DTX&&(n.fmtp.parameters.usedtx="1"))}))}function Ag(e){const t=e.attributes.unrecognized.findIndex((n=>n.attField==="x-google-flag"&&n.attValue==="conference"));t!==-1&&e.attributes.unrecognized.splice(t,1)}function Og(e,t){var n;if(e.attributes.payloads.forEach((r=>{var s;((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())==="h264"&&r.fmtp&&r.fmtp.parameters&&b("ENABLE_UP_SPS_PPS")&&(r.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")})),!(t instanceof yt&&t._encoderConfig&&t._hints.indexOf(ct.SCREEN_TRACK)===-1))return;const i=t._encoderConfig;We().supportMinBitrate&&i.bitrateMin&&e.attributes.payloads.forEach((r=>{var s,o;X(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),We().supportMinBitrate&&!X(n=t._hints).call(n,ct.LOW_STREAM)&&i.bitrateMax&&e.attributes.payloads.forEach((r=>{var s,o;X(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(b("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function oN(e){if(e.media.mediaType!=="video")return;const t=Ze();if(t.name!==tt.SAFARI&&t.os!==un.IOS)return;const n=e.attributes.extmaps.findIndex((i=>/video-orientation/g.test(i.extensionName)));n!==-1&&e.attributes.extmaps.splice(n,1)}function $h(e,t,n){if(!t)return;let i,r;if(e.media.mediaType==="video"?(i=n.videoExtensions,r=n.videoCodecs):(i=n.audioExtensions,r=n.audioCodecs),t.twcc===!0){const s=i.find((o=>Zh(o.extensionName)));if(s){const o=s.extensionName;e.attributes.extmaps.find((c=>Zh(c.extensionName)))||e.attributes.extmaps.push({entry:s.entry,extensionName:o}),(function(c,d){return d.filter((l=>!!c.find((u=>u.payloadType===l.payloadType&&!!u.rtcpFeedbacks.find((h=>h.type==="transport-cc"))))))})(r,e.attributes.payloads).forEach((c=>{c.rtcpFeedbacks.find((d=>d.type==="transport-cc"))||c.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(t.twcc===!1){const s=e.attributes.extmaps.findIndex((o=>Zh(o.extensionName)));s!==-1&&e.attributes.extmaps.splice(s,1),e.attributes.payloads.forEach((o=>{const a=o.rtcpFeedbacks.findIndex((c=>c.type==="transport-cc"));a!==-1&&o.rtcpFeedbacks.splice(a,1)}))}if(t.remb===!0){const s=i.find((o=>tN(o.extensionName)));if(s){const o=s.extensionName;e.attributes.extmaps.find((c=>c.extensionName===o))||e.attributes.extmaps.push({entry:s.entry,extensionName:o}),(function(c,d){return d.filter((l=>!!c.find((u=>u.payloadType===l.payloadType&&!!u.rtcpFeedbacks.find((h=>h.type==="goog-remb"))))))})(r,e.attributes.payloads).forEach((c=>{c.rtcpFeedbacks.find((d=>d.type==="goog-remb"))||c.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(t.remb===!1){const s=e.attributes.extmaps.findIndex((o=>tN(o.extensionName)));s!==-1&&e.attributes.extmaps.splice(s,1),e.attributes.payloads.forEach((o=>{const a=o.rtcpFeedbacks.findIndex((c=>c.type==="goog-remb"));a!==-1&&o.rtcpFeedbacks.splice(a,1)}))}}function Ng(e,t,n){if(It()||e.media.mediaType!=="video"||!(t instanceof yt)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!b("SIMULCAST")||n==="vp9"&&b("ENABLE_SVC")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;const i=n==="vp8"?2:t._scalabilityMode.numSpatialLayers,r=e.attributes.ssrcs[0],s=e.attributes.ssrcGroups.find((a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId)),o={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)e.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:wt(r.attributes)}),o.ssrcIds.push(r.ssrcId+a),s&&(e.attributes.ssrcs.push({ssrcId:s.ssrcIds[1]+a,attributes:wt(r.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,s.ssrcIds[1]+a]}));e.attributes.ssrcGroups.unshift(o)}async function aN(){try{const e=new RTCPeerConnection;e.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:Th.L1T3}]});const t=await e.createOffer();if(!t.sdp)return void e.close();const n=Jn(t.sdp).mediaDescriptions[0];if(!n)return;const i=n.attributes.extmaps.find((r=>r.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension"));return e.close(),i}catch{return}}async function Dg(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const i=(await n.createOffer()).sdp,{send:r,recv:s,sendrecv:o}=(function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0;const l=$d(d,a,c,"sendonly"),u=$d(d,a,c,"recvonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},R={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(_r(l,u,"videoExtensions",h,p,R),_r(l,u,"videoCodecs",h,p,R),_r(l,u,"audioExtensions",h,p,R),_r(l,u,"audioCodecs",h,p,R),b("RAISE_H264_BASELINE_PRIORITY")){const T=[],y=[];if(R.videoCodecs.forEach(((I,A)=>{var N;if(((N=I.rtpMap)===null||N===void 0?void 0:N.encodingName.toLocaleLowerCase())==="h264"){var k,x;const P=R.videoCodecs[A+1],M=P&&uN(I,P),G=(k=I.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"],Y=(x=I.fmtp)===null||x===void 0?void 0:x.parameters["packetization-mode"];!G||G!==b("FIRST_H264_PROFILE_LEVEL_ID")||b("FIRST_PACKETIZATION_MODE")&&Y!==b("FIRST_PACKETIZATION_MODE")?M?y.push([I,P]):y.push([I]):M?T.push([I,P]):T.push([I])}})),T.length>0&&y.length>0){_.debug("raising H264 baseline profile priority"),R.videoCodecs.forEach(((A,N)=>{var k;if(((k=A.rtpMap)===null||k===void 0?void 0:k.encodingName.toLocaleLowerCase())==="h264"){const x=uN(A,R.videoCodecs[N+1]),P=T.shift()||y.shift()||[];P.length>0&&(x?R.videoCodecs.splice(N,2,...P):R.videoCodecs.splice(N,1,...P))}}));const I=p.videoCodecs.filter((A=>{var N,k;return((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName.toLocaleLowerCase())==="h264"&&((k=A.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"])!==b("FIRST_H264_PROFILE_LEVEL_ID")}));if(I.length>0){const A=uo(I,p.videoCodecs).map((k=>k.payloadType)),N=[...I.map((k=>k.payloadType)),...A];p.videoCodecs=p.videoCodecs.filter((k=>!X(N).call(N,k.payloadType)))}b("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter((A=>{var N,k;return!(((N=A.rtpMap)===null||N===void 0?void 0:N.encodingName.toLocaleLowerCase())==="h264"&&((k=A.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"])!==b("FIRST_H264_PROFILE_LEVEL_ID"))})))}return{send:h,recv:p,sendrecv:R}}return{send:h,recv:p,sendrecv:R}})(e,t,i);try{n.close()}catch{}return{send:r,recv:s,sendrecv:o}}function cN(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=$d(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(_r(e,t,"videoExtensions",n,i,r),_r(e,t,"videoCodecs",n,i,r),_r(e,t,"audioExtensions",n,i,r),_r(e,t,"audioCodecs",n,i,r),b("RAISE_H264_BASELINE_PRIORITY")){const s=r.videoCodecs.findIndex((o=>o.rtpMap&&o.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&o.fmtp&&o.fmtp.parameters["profile-level-id"]==="42001f"));if(s!==-1){const o=r.videoCodecs.findIndex((a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"));if(o<s){_.debug("raising H264 baseline profile priority");const a=r.videoCodecs[s];r.videoCodecs.splice(s,1),r.videoCodecs.splice(o,0,a)}o!==-1&&(i.videoCodecs=i.videoCodecs.filter((a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f"))))}}return{send:n,recv:i,sendrecv:r}}function _r(e,t,n,i,r,s){if(n==="videoExtensions"||n==="audioExtensions"){const o=[];return e[n].forEach((a=>{t[n].some(((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return o.push(d),!0}))?s[n].push(a):i[n].push(a)})),void t[n].forEach(((a,c)=>{o.indexOf(c)===-1&&r[n].push(a)}))}if(n==="videoCodecs"||n==="audioCodecs"){const o=[];return e[n].forEach((a=>{t[n].some(((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return o.push(d),!0}))?s[n].push(a):i[n].push(a)})),void t[n].forEach(((a,c)=>{o.indexOf(c)===-1&&r[n].push(a)}))}}function tl(e){const{send:t,recv:n,sendrecv:i}=e;if(!i){if(!t||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:n}}let r,s;return t?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...t.audioCodecs,...i.audioCodecs],r.videoCodecs=[...t.videoCodecs,...i.videoCodecs],r.audioExtensions=[...t.audioExtensions,...i.audioExtensions],r.videoExtensions=[...t.videoExtensions,...i.videoExtensions]):r=wt(i),n?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...n.audioCodecs,...i.audioCodecs],s.videoCodecs=[...n.videoCodecs,...i.videoCodecs],s.audioExtensions=[...n.audioExtensions,...i.audioExtensions],s.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):s=wt(i),{send:r,recv:s}}function Pc(e){e.media.mediaType==="audio"&&e.attributes.payloads.filter((t=>{var n;return((n=t.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"})).forEach((t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"}))}function nl(e,t,n,i){let r=[];if(e===ue.VIDEO){if(b("H264_PROFILE_LEVEL_ID")&&i==="h264"&&(r=t.videoCodecs.filter((s=>{var o;return X(o=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(o,i)&&s&&s.fmtp&&s.fmtp.parameters["profile-level-id"]===b("H264_PROFILE_LEVEL_ID")}))),!Array.isArray(r)||r.length===0){let s=[];const o=[],a=[],c=[];if(n.videoCodecs.forEach((d=>{const l=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";X(l).call(l,i)?s.push(d):X(l).call(l,"vp9")?o.push(d):X(l).call(l,"vp8")?a.push(d):X(l).call(l,"h264")&&c.push(d)})),s.length===0){let d="";o.length!==0?(s=o,d="vp9"):a.length!==0?(s=a,d="vp8"):c.length!==0&&(s=c,d="h264"),_.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}s.length!==0&&(r=t.videoCodecs.filter((d=>s.some((l=>l.payloadType===d.payloadType)))))}if(r.length===0&&(_.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),r=t.videoCodecs),b("USE_PUB_RTX")||b("USE_SUB_RTX")){const s=uo(r,t.videoCodecs);r=[...r,...s]}}else{r=t.audioCodecs.filter((o=>{var a;return X(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,i)}));const s=t.audioCodecs.filter((o=>{var a;return X(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,"red")}));r.length===0&&(_.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=t.audioCodecs.filter((o=>{var a;return X(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,"opus")}))),b("ENABLE_AUDIO_RED")&&s.length!==0&&(r=[...s,...r])}return r}function uo(e,t){const n=e.map((i=>i.payloadType.toString()));return t.filter((i=>i.rtpMap&&i.rtpMap.encodingName==="rtx"&&i.fmtp&&i.fmtp.parameters.apt&&X(n).call(n,i.fmtp&&i.fmtp.parameters.apt)))}async function pi(e,t,n){const i=t.toString(),r=dN(i,"offer","remote","exchangeSDP");await e.setRemoteDescription({type:"offer",sdp:i});const s=await e.createAnswer();if(!s.sdp)throw new Error("cannot get answer sdp");let o=s.sdp;o=Pg(o,n||{}),r?.(o||""),await e.setLocalDescription({type:"answer",sdp:o})}function Pg(e,t,n){if(b("FORBID_MODIFY_LOCAL_OFFER_SDP"))return e;const i=Jn(e),{useXR:r}=t;return i.mediaDescriptions.forEach((s=>{var o;s.attributes.mid&&(Array.isArray(n)&&!X(n).call(n,s.attributes.mid)||(s.media.mediaType==="audio"&&Pc(s),s.media.mediaType==="video"&&(function(a){a.media.mediaType==="video"&&b("ENABLE_DOWN_SPS_PPS")&&a.attributes.payloads.filter((c=>{var d;return((d=c.rtpMap)===null||d===void 0?void 0:d.encodingName.toLowerCase())==="h264"})).forEach((c=>{c.fmtp||(c.fmtp={parameters:{}}),c.fmtp.parameters["sps-pps-idr-in-keyframe"]="1"}))})(s),r&&X(o=["audio","video"]).call(o,s.media.mediaType)&&s.attributes.payloads.forEach((a=>{a.rtcpFeedbacks.findIndex((c=>c.type==="rrtr"))===-1&&a.rtcpFeedbacks.push({type:"rrtr"})}))))})),Ds(i)}function dN(e,t,n,i){if(b("SDP_LOGGING"))return _.upload("exchanging ".concat(n," ").concat(t," SDP during P2PConnection.").concat(i,`
`),e),t==="offer"?r=>{dN(r,"answer",n==="local"?"remote":"local",i)}:void 0}async function lN(e,t,n){try{var i;if(!We().supportSetRtpSenderParameters||!(function(c){return c==="vp9"||c==="av1"})(e)||!b("ENABLE_SVC"))return;const r={},s={},o=t.getParameters(),a=(i=o.encodings)===null||i===void 0?void 0:i[0];s.scalabilityMode=Zd(n),a&&Object.assign(a,s),Object.assign(o,r),await t.setParameters(o),_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(o.encodings)))}catch(r){_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",r)}}function ep(e){const t=b("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(t)&&t.length>0)&&t.some((n=>X(e).call(e,n)))}function uN(e,t){try{var n;return((n=e.fmtp)===null||n===void 0?void 0:n.parameters.apt)===t.payloadType.toString()}catch{return!1}}function hN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Ci(e,t){return typeof b(e)===t?b(e):void 0}function vH(){try{const e=b("EXPERIMENTS")||{};return typeof e=="string"||Array.isArray(e)?{}:(function(t){for(var n=1;n<arguments.length;n++){var i=arguments[n]!=null?arguments[n]:{};n%2?hN(Object(i),!0).forEach((function(r){v(t,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):hN(Object(i)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(i,r))}))}return t})({},e)}catch(e){return _.debug("handle gateway attributes failed: ",e),{}}}const pN={};function ls(e){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&_.debug("install service ".concat(e.name)),pN[e.name]=e}function Ur(e){const t=pN[e];if(!t)throw new F(w.INVALID_OPERATION,"".concat(e," not found, please use AgoraRTC.use(").concat(e,"Service) to load it first"));return t}function mN(e,t){return Ur("DataStream").create(e,t)}function tp(){return Ur("InterceptFrame").create()}function fN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function yn(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?fN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const Lg=new Map;class RH extends kt{get state(){return this._state}set state(t){if(t===this._state)return;const n=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(Kt.CONNECTION_STATE_CHANGE,t,n,this._disconnectedReason):this.emit(Kt.CONNECTION_STATE_CHANGE,t,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){_.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,n){var i,r,s;super(),v(this,"store",void 0),v(this,"joinInfo",void 0),v(this,"key",void 0),v(this,"ntpOffset",0),v(this,"usingProxy",!1),v(this,"signal",void 0),v(this,"role",void 0),v(this,"isPreallocation",void 0),v(this,"isPreSub",void 0),v(this,"inChannelInfo",{joinAt:null,duration:0}),v(this,"spec",void 0),v(this,"_state","DISCONNECTED"),v(this,"_statsCollector",void 0),v(this,"_disconnectedReason",void 0),v(this,"isSignalRecover",!1),v(this,"hasChangeBGPAddress",!1),v(this,"trafficStatsInterval",void 0),v(this,"networkQualityInterval",void 0),v(this,"_joinGatewayStartTime",0),v(this,"_signalTimeout",!1),v(this,"_clientRoleOptions",void 0),v(this,"_isProactiveJoin",!1),this.store=t,this.spec=n,this.signal=this.store.useP2P?(i={spec:yn(yn({},n),{},{retryConfig:n.websocketRetryConfig}),store:t},(r=(s=Ur("P2PChannel")).createSubmodule)===null||r===void 0?void 0:r.call(s,i)):this.store.useDcSignal?(function(o){return Ur("DataChannelSignal").create(o)})({spec:yn(yn({},n),{},{retryConfig:n.websocketRetryConfig}),store:t}):new zO(yn(yn({},n),{},{retryConfig:n.websocketRetryConfig}),t),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}setUsingProxy(t){this.usingProxy=t}async join(t,n,i){if(this.store.useDcSignal){let l=!1;t.cloudProxyServer!=="disabled"?(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),l=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),l=!0):t.apResponse.addresses.some((u=>u.fingerprint))||b("FINGERPRINT")||(_.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),l=!0),l&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const r=Date.now();let s=Lg.get(t.cname);if(s||(s=new Map,Lg.set(t.cname,s)),this._isProactiveJoin=!0,s.has(t.uid)){const l=new V(w.UID_CONFLICT);throw pe.joinGateway(t.sid,{lts:r,succ:!1,ec:l.code,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!t.proxyServer||this.usingProxy,signalChannel:this.store.useDcSignal?"1":"0",preload:t.preload}),l}s.set(t.uid,!0),this.joinInfo=t,this.key=n;let o=0;this.joinGatewayStartTime=r;const a=t.proxyServer,c=this.store.useDcSignal?"datachannel":"websocket";try{_.debug("[".concat(this.store.clientId,"] use ").concat(c," join uid ").concat(o));const l=t.gatewayAddrs.map((h=>{let{address:p}=h;const[R,T]=p.split(":"),y={host:R,port:T};return t.proxyServer&&(y.proxy=t.proxyServer),y}));let u;u=this.store.useDcSignal?await this.signal.init(t.apResponse.addresses):await this.signal.init(l),o=u.uid,_.debug("[".concat(this.store.clientId,"] ").concat(c," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(l){var d;throw l.code===w.INIT_DATACHANNEL_TIMEOUT&&this.signal.__name__==="AgoraRTCSignal"||pe.joinGateway(t.sid,{lts:r,succ:!1,ec:((d=l.data)===null||d===void 0?void 0:d.desc)||l.code,errorMsg:l.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!a||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:t.preload}),l&&l.code===w.INIT_DATACHANNEL_TIMEOUT?(_.warning("[".concat(this.store.clientId,"] User join datachannel failed"),l.toString()),this.resetSignal(),l):(_.error("[".concat(this.store.clientId,"] User join failed"),l.toString()),s.delete(t.uid),this.signal.close(),l)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),_.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((l=>{_.warning("[".concat(this.store.clientId,"] get traffic stats error"),l.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Kt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Kt.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Kt.NETWORK_QUALITY,{uplinkNetworkQuality:Jh(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:Jh(this._statsCollector.trafficStats.B_dnq)}):this.emit(Kt.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),o}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==Ke.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==Ye.CONNECTED||await(function(i,r){return r===1/0?i:ie.race([i,J4(r)])})(this.signal.request(Ee.LEAVE,void 0,!0),3e3)}catch(i){_.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),i)}this.signal.close(n),n!==Ke.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:b("PUB_EXTEND"),twcc:!!b("PUBLISH_TWCC"),rtx:!!b("USE_PUB_RTX")};try{return(await this.signal.request(Ee.PUBLISH,r,!0))._message}catch(s){if(i&&s.data&&s.data.code===ye.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(t,n),this.publish(t,n,!1);throw s}}async publishDataChannel(t,n,i){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(r=n.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request(Ee.PUBLISH_DATASTREAM,s,!0)}catch(o){if(i&&o.data&&o.data.code===ye.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),o.toString()),await this.tryUnpubDataChannelBeforeRepub(t,n),this.publishDataChannel(t,n,!1);throw o}}async unpublish(t,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Ee.UNPUBLISH,{stream_id:n,ortc:t},!0)}catch(i){_.warning("[".concat(this.store.clientId,"] unpublish warning: "),i)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await ie.all(t.map((n=>this.signal.request(Ee.UNPUBLISH_DATASTREAM,{channel_id:n},!0))))}catch(n){_.warning("unpublish datachannels warning: ",n)}}async presubscribe(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!b("SUBSCRIBE_TWCC"),rtx:!!b("USE_SUB_RTX")||void 0,extend:b("SUB_EXTEND"),svc:Array.isArray(b("SVC"))&&b("SVC").length!==0?b("SVC"):void 0};try{return await this.signal.request(Ee.PRE_SUBSCRIBE,r,!0)}catch(s){if(i&&s.data&&s.data.code===ye.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),s.toString()),this.presubscribe(t,n,!1);throw s}}async subscribe(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!b("SUBSCRIBE_TWCC"),rtx:!!b("USE_SUB_RTX"),extend:b("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(b("SVC"))&&b("SVC").length!==0?b("SVC"):void 0};try{return(await this.signal.request(Ee.SUBSCRIBE,r,!0))._message}catch(s){if(i&&s.data&&s.data.code===ye.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(t,n),await this.subscribe(t,n,!1);throw s}}async subscribeDataChannel(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const r={uid:t,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request(Ee.SUBSCRIBE_DATASTREAM,r,!0)}catch(s){if(i&&s.data&&s.data.code===ye.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(t,n),await this.subscribeDataChannel(t,n,!1);throw s}}async subscribeAll(t,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!b("USE_SUB_RTX"),twcc:!!b("SUBSCRIBE_TWCC"),svc:Array.isArray(b("SVC"))&&b("SVC").length!==0?b("SVC"):void 0};try{return await this.signal.request(Ee.SUBSCRIBE_STREAMS,i,!0)}catch(r){if(n&&r.data&&r.data.code===ye.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw r}}async setVideoProfile(t){const n=(function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let r=i.frameRate,s=i.width,o=i.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,s||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,r||(a=!1)),a?{stream_type:0,width:s,height:o,fps:r,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0})(t);if(n)return this.signal.request(Ee.SET_VIDEO_PROFILE,n);_.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,n){try{await this.signal.request(Ee.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:n},!0)}catch(i){_.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),i)}}async unsubscribeDataChannel(t,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await ie.all(t.map((i=>this.signal.request(Ee.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:n},!0))))}catch(i){_.warning("unsubscribeDataChannel warning: ",i)}}async massUnsubscribe(t){try{await this.signal.request(Ee.UNSUBSCRIBE_STREAMS,t,!0)}catch(n){_.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n)}}async reconnectPC(t){const{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=t;return{gatewayEstablishParams:await this.signal.request(Ee.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Ee.GATEWAY_INFO)}async renewToken(t){await this.signal.request(Ee.RENEW_TOKEN,t),this.key=t.token}updateClientRole(t,n){n&&(this._clientRoleOptions=Object.assign({},n)),b("CLIENT_ROLE_OPTIONS")&&(_.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(b("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},b("CLIENT_ROLE_OPTIONS"))),this.role=t}async setClientRole(t,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),b("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},b("CLIENT_ROLE_OPTIONS")),_.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(b("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=t);let i,r=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0;const s=Object.assign({},n);delete s.delay,delete s.level,await this.signal.request(Ee.SET_CLIENT_ROLE,yn(yn({role:t,level:r,delay:i},s),{},{client_ts:Date.now()})),this.role=t}async setDualStreamMode(t,n,i){await this.signal.request(Ee.SET_DUAL_STREAM_MODE,{mode:t},i,n)}async setRemoteVideoStreamType(t,n){await this.signal.request(Ee.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:n})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(Ee.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,n){await this.signal.request(Ee.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:n})}async pickSVCLayer(t,n){await this.signal.request(Ee.PICK_SVC_LAYER,{stream_id:t,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})}async setRTM2Flag(t){await this.signal.request(Ee.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,n,i){if(this.store.useP2P)return this.signal.sendExtensionMessage(t,n,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),yn({},this.inChannelInfo)}async setConfigure(t){if(t&&Array.isArray(t)&&t.length!==0)return this.signal.request(Ee.CONFIGURE,t)}async getGatewayVersion(){return(await this.signal.request(Ee.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=Lg.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0),this.usingProxy=!1}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=(function(n){let i;return i=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),i?{username:Nn.username,password:Nn.password,turnServerURL:i[2],tcpport:parseInt(i[3])+30,udpport:parseInt(i[3])+30,forceturn:!1}:null})((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(yn(yn({},Nn),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const t=await this.signal.request(Ee.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach((n=>{const i=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((r=>r.peer_uid===n.peer_uid));i&&i.B_st!==n.B_st&&_h((()=>{this.emit(Kt.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st)}))})),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){var n,i,r,s;if(!this.joinInfo||!this.key)throw new V(w.UNEXPECTED_ERROR,"can not generate join message, no join info");const o=Object.assign({},this.joinInfo.apResponse);let a=b("REPORT_APP_SCENARIO");if(typeof a!="string")try{a=JSON.stringify(a)}catch{a=void 0}var c;a&&a.length>128&&(a=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(Kt.UPDATE_GATEWAY_CONFIG),c=this.store.clientId,X(Ic).call(Ic,c)||Ic.push(c);const d=Yd(this.store),l=!((n=this.isPreallocation)===null||n===void 0||!n.call(this)),u=fA(this.store),h=vH(),p=Dr(87)||yw()||_E(117),R=((function(){const A=Ze();if(A.name!==tt.SAFARI||!A.browserVersion)return!1;const N=A.browserVersion.split(".");return Number(N[0])>18||Number(N[0])===18&&Number(N[1])>=4})()||bw(18,4,!1))&&EE(18,6,!0)&&this.spec.codec==="h264"&&b("ENABLE_ABSSENDTIME_AS_SENTTS"),T=!(((i=o.detail)===null||i===void 0?void 0:i[3])!=="CN"||!b("ENABLE_QUALITY_FALLBACK"))&&b("ENABLE_QUALITY_FALLBACK"),y=!!b("ENABLE_AP_MULTI_IP")&&((r=o.detail)===null||r===void 0?void 0:r[5])==="multi-ip",I=yn({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Gi,browser:navigator.userAgent,process_id:b("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:y||this.hasChangeBGPAddress,ap_response:o,extend:b("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:a,attributes:{userAttributes:yn(yn({enableEncodedTransform:(!!b("ENABLE_AUDIO_METADATA")||!!b("ENABLE_AUDIO_PTS"))&&p||!!b("ENABLE_AUDIO_TOPN")&&fE(tt.CHROME,87,116)||void 0,enableAudioMetadata:!!b("ENABLE_AUDIO_METADATA")&&p,enableAudioPts:!!b("ENABLE_AUDIO_PTS")&&p,topnSmoothLevel:b("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:b("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:b("TOPN_SWITCH_HOLD_MS"),topnAudioGain:b("TOPN_AUDIO_GAIN"),enableNetworkQualityProbe:this.store.networkQualityProbe,enablePublishedUserList:b("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:b("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:Ci("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:Ci("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:Ci("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:b("USE_PUB_RTX")===!0||b("USE_SUB_RTX")===!0||void 0,disableFEC:b("DISABLE_FEC"),enableNTPReport:!!b("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:u,enableFulllinkAvSync:!!b("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:Ci("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!b("FORCE_ENABLE_AUT_CC")||!bh()&&(!!b("ENABLE_AUT_FEEDBACK")||void 0),rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!b("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:Ci("USE_XR","boolean"),enableLossbasedBwe:Ci("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!b("FORCE_ENABLE_AUT_CC")||!bh()&&(!!b("ENABLE_AUT_CC")||void 0),enableCCFallback:Ci("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:l,preSubNum:d?Ci("PRE_SUB_NUM","number"):void 0,enablePubTWCC:Ci("PUBLISH_TWCC","boolean"),enableSubTWCC:Ci("SUBSCRIBE_TWCC","boolean"),enablePubRTX:Ci("USE_PUB_RTX","boolean"),enableSubRTX:Ci("USE_SUB_RTX","boolean"),enableSubSVC:b("ENABLE_SVC")?b("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(b("SVC"))&&b("SVC").length!==0?b("SVC"):void 0,enableSvcExtended:b("ENABLE_SVC")&&Array.isArray(b("SVC_EXTENDED"))&&b("SVC_EXTENDED").length!==0?b("SVC_EXTENDED"):void 0,enableVosFallback:b("ENABLE_VOS_FALLBACK"),enableQualityFallback:T},h),{},{audioDuplicate:Ci("ENABLE_AUDIO_RED","boolean")?(s=Ci("AUDIO_DUPLICATE_NUM","number"))!==null&&s!==void 0?s:2:void 0,senttsUsesAbsSendTime:!!R||void 0,enableDualStreamFlag:Ci("ENABLE_DUAL_STREAM_FLAG","boolean")})},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(I.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(I.aes_mode=this.joinInfo.aesmode,b("ENCRYPT_AES")?(I.aes_secret=this.joinInfo.aespassword,I.aes_encrypt=!0):I.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(I.aes_salt=this.joinInfo.aessalt)),o.addresses[this.signal.websocket.currentURLIndex]&&(I.ap_response.ticket=o.addresses[this.signal.websocket.currentURLIndex].ticket,delete o.addresses),this.joinInfo.defaultVideoStream!==void 0&&(I.default_video_stream=this.joinInfo.defaultVideoStream),I}getRejoinMessage(){if(!this.joinInfo)throw new V(w.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(fe.WS_RECONNECT_CREATE_CONNECTION,(t=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(fe.WS_RECONNECTING,(t=>{this.joinInfo&&pe.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||On.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",pe.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(fe.WS_CLOSED,(t=>{let n;switch(t){case Ke.LEAVE:n=On.LEAVE;break;case Ke.UID_BANNED:case Ke.IP_BANNED:case Ke.CHANNEL_BANNED:case Ke.SERVER_ERROR:n=On.SERVER_ERROR;break;case Ke.FALLBACK:n=On.FALLBACK;break;case Ke.LICENSE_MISSING:case Ke.LICENSE_EXPIRED:case Ke.LICENSE_MINUTES_EXCEEDED:case Ke.LICENSE_PERIOD_INVALID:case Ke.LICENSE_MULTIPLE_SDK_SERVICE:case Ke.LICENSE_ILLEGAL:case Ke.TOKEN_EXPIRE:n=t;break;default:n=On.NETWORK_ERROR}_.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+On.NETWORK_ERROR)),this.joinInfo&&pe.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===Ke.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=t,t!==Ke.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(fe.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){const t=b("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;t&&(t.level||t.delay)&&(_.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(t.level,", delay: ").concat(t.delay)),this.setClientRole(this.role,t))}if(pe.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void _.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));_t("EVENT_REPORT_DOMAIN",t[1]),_t("EVENT_REPORT_BACKUP_DOMAIN",t[1]),_t("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}})),this.signal.on(Ae.ON_UPLINK_STATS,(t=>{this._statsCollector.updateUplinkStats(t)})),this.signal.on(fe.REQUEST_RECOVER,((t,n,i)=>{if(!this.joinInfo)return i(new V(w.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,en(this,Kt.REQUEST_NEW_GATEWAY_LIST).then(n).catch(i)})),this.signal.on(fe.REQUEST_JOIN_INFO,(async(t,n,i)=>{var r,s,o;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));const a=wt((r=this.joinInfo)===null||r===void 0?void 0:r.turnServer);if(b("NEW_TURN_MODE")&&a&&((s=this.joinInfo)===null||s===void 0?void 0:s.cloudProxyServer)==="disabled"){var c;let h=a.servers.map((T=>"turnServerURL"in T&&b("USE_TURN_IP")?yn(yn({},T),{},{turnServerURL:Xh(T.turnServerURL)}):T)),p=(c=a.serversFromGateway)===null||c===void 0?void 0:c.map((T=>b("USE_TURN_IP")?yn(yn({},T),{},{turnServerURL:Xh(T.turnServerURL)}):T));const R=this.signal.currentURLIndex;h.length>0&&(h=[h[R%h.length]],a.servers=h),Array.isArray(p)&&p.length>0&&(p=[p[0]],a.serversFromGateway=p),_.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(R))}const{iceParameters:d,dtlsParameters:l,rtpCapabilities:u}=await en(this,Kt.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:a,cloudProxyServer:(o=this.joinInfo)===null||o===void 0?void 0:o.cloudProxyServer});try{t(this.getJoinMessage({ortc:{iceParameters:d,dtlsParameters:l,rtpCapabilities:u,version:"2"}}))}catch(h){n(h)}})),this.signal.on(fe.REQUEST_REJOIN_INFO,(t=>{t(this.getRejoinMessage())})),this.signal.on(fe.REPORT_JOIN_GATEWAY,((t,n)=>{if(!this.joinInfo)return;let i,r="";var s;t instanceof V?(i=((s=t.data)===null||s===void 0?void 0:s.desc)||t.code,r=t.message):i=t,pe.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:i,errorMsg:r,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload})})),this.signal.on(fe.IS_P2P_DISCONNECTED,(t=>{t(Yo(this,Kt.IS_P2P_DISCONNECTED))})),this.signal.on(fe.DISCONNECT_P2P,(()=>{this.emit(Kt.DISCONNECT_P2P)})),this.signal.on(fe.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(fe.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(fe.JOIN_RESPONSE,(t=>{const n=this.getCurrentGatewayAddress();this.emit(Kt.JOIN_RESPONSE,t,n)})),this.signal.on(fe.PRE_CONNECT_PC,(async(t,n)=>{if(this.joinInfo){var i,r;this.updateTurnConfigFromSignal();const o=this.getCurrentGatewayAddress(),a=wt((i=this.joinInfo)===null||i===void 0?void 0:i.turnServer);if(b("NEW_TURN_MODE")&&a&&((r=this.joinInfo)===null||r===void 0?void 0:r.cloudProxyServer)==="disabled"){var s;let d=a.servers.map((h=>"turnServerURL"in h&&b("USE_TURN_IP")?yn(yn({},h),{},{turnServerURL:Xh(h.turnServerURL)}):h)),l=(s=a.serversFromGateway)===null||s===void 0?void 0:s.map((h=>b("USE_TURN_IP")?yn(yn({},h),{},{turnServerURL:Xh(h.turnServerURL)}):h));const u=this.signal.currentURLIndex;d.length>0&&(d=[d[u%d.length]],a.servers=d),Array.isArray(l)&&l.length>0&&(l=[l[0]],a.serversFromGateway=l),_.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(u,",in pre pc"))}const c=b("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(o&&c){const d=sN(o);en(this,Kt.PRE_CONNECT_PC,{candidates:d,fingerprint:c,turnServer:a}).then((l=>{t?.(l)})).catch(n||(()=>{}))}}})),this.signal.on(fe.RECOVER_NOTIFICATION,(t=>{this.joinInfo&&typeof b("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(b("AP_REQUEST_DETAIL"),";").concat(t))})),this.signal.on(fe.VOS_FALLBACK,(t=>{this.emit(Kt.VOS_FALLBACK,t)})),this.signal.on(fe.DATACHANNEL_FAILBACK,(t=>{_.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Kt.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(t,n){try{await this.signal.request(Ee.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[n]},!0)}catch(i){throw _.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),i),i}}async tryUnsubDataChannelBeforeResub(t,n){try{await this.signal.request(Ee.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(i){throw _.warning("unsubscribe datachannel warning",i),i}}async tryUnpubBeforeRepub(t,n){try{await this.signal.request(Ee.UNPUBLISH,{stream_id:t,ortc:n},!0)}catch(i){throw _.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}}async tryUnpubDataChannelBeforeRepub(t,n){try{await this.signal.request(Ee.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(i){throw _.warning("unpublish datastream warning: ",i),i}}async tryMassUnsubBeforeResub(t){const n={users:t.map((i=>({stream_id:i.stream_id,stream_type:i.stream_type})))};try{await this.signal.request(Ee.UNSUBSCRIBE_STREAMS,n,!0)}catch(i){throw _.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}}async muteLocal(t,n){const i={action:t.find((r=>r.stream_type===pt.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:n};try{await this.signal.request(Ee.CONTROL,i,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(t,n){const i={action:t.find((r=>r.stream_type===pt.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:n};try{await this.signal.request(Ee.CONTROL,i,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(t,n){const i={action:t===ue.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Ee.CONTROL,i,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(t,n){const i={action:t===ue.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Ee.CONTROL,i,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,n){this.signal.upload(t,n)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(Ee.RESTART_ICE,n,!0)}catch(i){throw _.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),i),i}}reconnect(t,n){this.state==="CONNECTED"&&this.signal.reconnect(t||void 0,n||On.P2P_FAILED)}getCurrentGatewayAddress(){var t,n;if(!b("GATEWAY_WSS_ADDRESS"))return b("USE_CANDIDATE_FROM_AP_DETAIL")&&(t=this.joinInfo)!==null&&t!==void 0&&t.apGatewayAddress?(_.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(n=this.joinInfo)!==null&&n!==void 0&&n.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(Ee.SET_PARAMETER,{enablePublishAudioFilter:t})}downgradeCodec(t){this.signal.downgradeCodec(t)}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Ke.FALLBACK)),this.store.useDcSignal=!1,this.signal=new zO(yn(yn({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Kt.RESET_SIGNAL)}}let np=0,kg=0;function Vr(e,t,n,i){return new ie(((r,s)=>{t.timeout=t.timeout||b("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),np+=rs(t.data)):n&&(t.data.size?np+=t.data.size:t.data instanceof FormData?np+=Kw(t.data):np+=rs(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ii.request(t).then((o=>{typeof o.data=="string"?kg+=rs(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?kg+=o.data.byteLength:kg+=rs(JSON.stringify(o.data)),i&&r({data:o.data,headers:o.headers}),r(o.data)})).catch((o=>{ii.isCancel(o)?s(new V(w.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new V(w.NETWORK_TIMEOUT,o.message)):o.response?s(new V(w.NETWORK_RESPONSE_ERROR,o.response.status)):s(new V(w.NETWORK_ERROR,o.message))}))}))}(function(){var e;function t(H){var $=0;return function(){return $<H.length?{done:!1,value:H[$++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(H,$,he){return H==Array.prototype||H==Object.prototype||(H[$]=he.value),H},i,r=(function(H){H=[typeof globalThis=="object"&&globalThis,H,typeof window=="object"&&window,typeof self=="object"&&self,typeof C=="object"&&C];for(var $=0;$<H.length;++$){var he=H[$];if(he&&he.Math==Math)return he}throw Error("Cannot find global object")})(this);function s(H,$){if($)e:{var he=r;H=H.split(".");for(var K=0;K<H.length-1;K++){var S=H[K];if(!(S in he))break e;he=he[S]}($=$(K=he[H=H[H.length-1]]))!=K&&$!=null&&n(he,H,{configurable:!0,writable:!0,value:$})}}function o(H){return(H={next:H})[Symbol.iterator]=function(){return this},H}function a(H){var $=typeof Symbol<"u"&&Symbol.iterator&&H[Symbol.iterator];return $?$.call(H):{next:t(H)}}if(s("Symbol",(function(H){function $(S,O){this.A=S,n(this,"description",{configurable:!0,writable:!0,value:O})}if(H)return H;$.prototype.toString=function(){return this.A};var he="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",K=0;return function S(O){if(this instanceof S)throw new TypeError("Symbol is not a constructor");return new $(he+(O||"")+"_"+K++,O)}})),s("Symbol.iterator",(function(H){if(H)return H;H=Symbol("Symbol.iterator");for(var $="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),he=0;he<$.length;he++){var K=r[$[he]];typeof K=="function"&&typeof K.prototype[H]!="function"&&n(K.prototype,H,{configurable:!0,writable:!0,value:function(){return o(t(this))}})}return H})),typeof Object.setPrototypeOf=="function")i=Object.setPrototypeOf;else{var c;e:{var d={};try{d.__proto__={a:!0},c=d.a;break e}catch{}c=!1}i=c?function(H,$){if(H.__proto__=$,H.__proto__!==$)throw new TypeError(H+" is not extensible");return H}:null}var l=i;function u(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function h(H){if(H.m)throw new TypeError("Generator is already running");H.m=!0}function p(H,$){return H.h=3,{value:$}}function R(H){this.g=new u,this.G=H}function T(H,$,he,K){try{var S=$.call(H.g.j,he);if(!(S instanceof Object))throw new TypeError("Iterator result "+S+" is not an object");if(!S.done)return H.g.m=!1,S;var O=S.value}catch(L){return H.g.j=null,H.g.s(L),y(H)}return H.g.j=null,K.call(H.g,O),y(H)}function y(H){for(;H.g.h;)try{var $=H.G(H.g);if($)return H.g.m=!1,{value:$.value,done:!1}}catch(he){H.g.v=void 0,H.g.s(he)}if(H.g.m=!1,H.g.l){if($=H.g.l,H.g.l=null,$.F)throw $.D;return{value:$.return,done:!0}}return{value:void 0,done:!0}}function I(H){this.next=function($){return H.o($)},this.throw=function($){return H.s($)},this.return=function($){return(function(he,K){h(he.g);var S=he.g.j;return S?T(he,"return"in S?S.return:function(O){return{value:O,done:!0}},K,he.g.return):(he.g.return(K),y(he))})(H,$)},this[Symbol.iterator]=function(){return this}}function A(H,$){return $=new I(new R($)),l&&H.prototype&&l($,H.prototype),$}if(u.prototype.o=function(H){this.v=H},u.prototype.s=function(H){this.l={D:H,F:!0},this.h=this.C||this.u},u.prototype.return=function(H){this.l={return:H},this.h=this.u},R.prototype.o=function(H){return h(this.g),this.g.j?T(this,this.g.j.next,H,this.g.o):(this.g.o(H),y(this))},R.prototype.s=function(H){return h(this.g),this.g.j?T(this,this.g.j.throw,H,this.g.o):(this.g.s(H),y(this))},s("Array.prototype.entries",(function(H){return H||function(){return(function($,he){$ instanceof String&&($+="");var K=0,S=!1,O={next:function(){if(!S&&K<$.length){var L=K++;return{value:he(L,$[L]),done:!1}}return S=!0,{done:!0,value:void 0}}};return O[Symbol.iterator]=function(){return O},O})(this,(function($,he){return[$,he]}))}})),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var N=function(H,$){for(var he=0;he<H.length;he++)$(H[he])},k=function(H){return H.replace(/\r?\n|\r/g,`\r
`)},x=function(H,$,he){return $ instanceof Blob?(he=he!==void 0?he+"":typeof $.name=="string"?$.name:"blob",$.name===he&&Object.prototype.toString.call($)!=="[object Blob]"||($=new File([$],he)),[String(H),$]):[String(H),String($)]},P=function(H,$){if(H.length<$)throw new TypeError($+" argument required, but only "+H.length+" present.")},M=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,G=M.FormData,Y=M.XMLHttpRequest&&M.XMLHttpRequest.prototype.send,de=M.Request&&M.fetch,Ie=M.navigator&&M.navigator.sendBeacon,Ce=M.Element&&M.Element.prototype,Ue=M.Symbol&&Symbol.toStringTag;Ue&&(Blob.prototype[Ue]||(Blob.prototype[Ue]="Blob"),"File"in M&&!File.prototype[Ue]&&(File.prototype[Ue]="File"));try{new File([],"")}catch{M.File=function($,he,K){return $=new Blob($,K||{}),Object.defineProperties($,{name:{value:he},lastModified:{value:+(K&&K.lastModified!==void 0?new Date(K.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Ue&&Object.defineProperty($,Ue,{value:"File"}),$}}var Pe=function(H){return H.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},nt=function(H){this.i=[];var $=this;H&&N(H.elements,(function(he){if(he.name&&!he.disabled&&he.type!=="submit"&&he.type!=="button"&&!he.matches("form fieldset[disabled] *"))if(he.type==="file"){var K=he.files&&he.files.length?he.files:[new File([],"",{type:"application/octet-stream"})];N(K,(function(S){$.append(he.name,S)}))}else he.type==="select-multiple"||he.type==="select-one"?N(he.options,(function(S){!S.disabled&&S.selected&&$.append(he.name,S.value)})):he.type==="checkbox"||he.type==="radio"?he.checked&&$.append(he.name,he.value):(K=he.type==="textarea"?k(he.value):he.value,$.append(he.name,K))}))};if((e=nt.prototype).append=function(H,$,he){P(arguments,2),this.i.push(x(H,$,he))},e.delete=function(H){P(arguments,1);var $=[];H=String(H),N(this.i,(function(he){he[0]!==H&&$.push(he)})),this.i=$},e.entries=function H(){var $,he=this;return A(H,(function(K){if(K.h==1&&($=0),K.h!=3)return $<he.i.length?K=p(K,he.i[$]):(K.h=0,K=void 0),K;$++,K.h=2}))},e.forEach=function(H,$){P(arguments,1);for(var he=a(this),K=he.next();!K.done;K=he.next()){var S=a(K.value);K=S.next().value,S=S.next().value,H.call($,S,K,this)}},e.get=function(H){P(arguments,1);var $=this.i;H=String(H);for(var he=0;he<$.length;he++)if($[he][0]===H)return $[he][1];return null},e.getAll=function(H){P(arguments,1);var $=[];return H=String(H),N(this.i,(function(he){he[0]===H&&$.push(he[1])})),$},e.has=function(H){P(arguments,1),H=String(H);for(var $=0;$<this.i.length;$++)if(this.i[$][0]===H)return!0;return!1},e.keys=function H(){var $,he,K,S,O=this;return A(H,(function(L){if(L.h==1&&($=a(O),he=$.next()),L.h!=3)return he.done?void(L.h=0):(K=he.value,S=a(K),p(L,S.next().value));he=$.next(),L.h=2}))},e.set=function(H,$,he){P(arguments,2),H=String(H);var K=[],S=x(H,$,he),O=!0;N(this.i,(function(L){L[0]===H?O&&(O=!K.push(S)):K.push(L)})),O&&K.push(S),this.i=K},e.values=function H(){var $,he,K,S,O=this;return A(H,(function(L){if(L.h==1&&($=a(O),he=$.next()),L.h!=3)return he.done?void(L.h=0):(K=he.value,(S=a(K)).next(),p(L,S.next().value));he=$.next(),L.h=2}))},nt.prototype._asNative=function(){for(var H=new G,$=a(this),he=$.next();!he.done;he=$.next()){var K=a(he.value);he=K.next().value,K=K.next().value,H.append(he,K)}return H},nt.prototype._blob=function(){var H="----formdata-polyfill-"+Math.random(),$=[],he="--"+H+`\r
Content-Disposition: form-data; name="`;return this.forEach((function(K,S){return typeof K=="string"?$.push(he+Pe(k(S))+`"\r
\r
`+k(K)+`\r
`):$.push(he+Pe(k(S))+'"; filename="'+Pe(K.name)+`"\r
Content-Type: `+(K.type||"application/octet-stream")+`\r
\r
`,K,`\r
`)})),$.push("--"+H+"--"),new Blob($,{type:"multipart/form-data; boundary="+H})},nt.prototype[Symbol.iterator]=function(){return this.entries()},nt.prototype.toString=function(){return"[object FormData]"},Ce&&!Ce.matches&&(Ce.matches=Ce.matchesSelector||Ce.mozMatchesSelector||Ce.msMatchesSelector||Ce.oMatchesSelector||Ce.webkitMatchesSelector||function(H){for(var $=(H=(this.document||this.ownerDocument).querySelectorAll(H)).length;0<=--$&&H.item($)!==this;);return-1<$}),Ue&&(nt.prototype[Ue]="FormData"),Y){var Pt=M.XMLHttpRequest.prototype.setRequestHeader;M.XMLHttpRequest.prototype.setRequestHeader=function(H,$){Pt.call(this,H,$),H.toLowerCase()==="content-type"&&(this.B=!0)},M.XMLHttpRequest.prototype.send=function(H){H instanceof nt?(H=H._blob(),this.B||this.setRequestHeader("Content-Type",H.type),Y.call(this,H)):Y.call(this,H)}}de&&(M.fetch=function(H,$){return $&&$.body&&$.body instanceof nt&&($.body=$.body._blob()),de.call(this,H,$)}),Ie&&(M.navigator.sendBeacon=function(H,$){return $ instanceof nt&&($=$._asNative()),Ie.call(this,H,$)}),M.FormData=nt}})();const il=()=>{const e=b("AREAS");return e.length===0&&e.push(rt.GLOBAL),Bi(e).call(e,((t,n,i)=>{const r=_N(n);return r?i===0?r:"".concat(t,",").concat(r):t}),"")},_N=e=>e===rt.OVERSEA?"".concat(kn.ASIA,",").concat(kn.EUROPE,",").concat(kn.AFRICA,",").concat(kn.NORTH_AMERICA,",").concat(kn.SOUTH_AMERICA,",").concat(kn.OCEANIA):kn[e],CH=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((n=>{const i=Yh[n],r=Object.keys(i);r&&r.map((s=>{s!=="CODE"&&(t[s]=t[s].concat(i[s]))}))})),t},ip={GLOBAL:{ASIA:[rt.CHINA,rt.JAPAN,rt.INDIA,rt.KOREA,rt.HKMC],EUROPE:[],NORTH_AMERICA:[rt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},rp=Object.keys(ip[rt.GLOBAL]),xg=[rt.CHINA,rt.NORTH_AMERICA,rt.EUROPE,rt.ASIA,rt.JAPAN,rt.INDIA,rt.OCEANIA,rt.SOUTH_AMERICA,rt.AFRICA,rt.KOREA,rt.HKMC,rt.US],bH=function(e,t){let n=[];if(X(e).call(e,rt.GLOBAL)){const s=[rt.GLOBAL,rt.OVERSEA],o=Object.keys(Yh);if(t===rt.GLOBAL)throw new V(w.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===rt.CHINA)n=[rt.OVERSEA];else if(r=t,X(rp).call(rp,r)){const a=(i=t,ip[rt.GLOBAL][i]||[]),c=[...s,t,...a];n=o.filter((d=>!X(c).call(c,d)))}else if((function(a){let c=!1;return rp.forEach((d=>{var l;X(l=ip[rt.GLOBAL][d]).call(l,a)&&(c=!0)})),c})(t)){const a=(function(d){let l;return rp.forEach((u=>{var h;X(h=ip[rt.GLOBAL][u]).call(h,d)&&(l=u)})),l})(t),c=[...s,a,t];n=o.filter((d=>!X(c).call(c,d)))}else n=e;n=(function(a){const c=[];return xg.forEach((d=>{X(a).call(a,d)&&c.push(d)})),c.concat(a.filter((d=>!X(xg).call(xg,d))))})(n)}else n=e;var i,r;return n};function EN(e){var t,n;if(!e&&X(t=b("AREAS")).call(t,rt.EXTENSIONS))return _.debug("update area from ap : reset"),void Mg(k6,!0);if(!X(n=b("AREAS")).call(n,rt.GLOBAL)||!e)return;let i=Yh.EXTENSIONS;i&&(i={CODE:_N(rt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},_.debug("update area from ap success: ".concat(e,",config is "),i),_t("AREAS",[rt.EXTENSIONS],!0),Object.keys(i).map((r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?_t(r,i[r][0]):_t(r,i[r])})))}function Mg(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=pe.reportApiInvoke(null,{name:Nt.SET_AREA,options:e,tag:Tt.TRACER});try{let i=[];if(typeof e=="string"&&(i=[e]),Array.isArray(e)&&(e.forEach((s=>{if(!X(FO).call(FO,s))throw new V(w.INVALID_PARAMS,"invalid area code")})),i=e),Object.prototype.toString.call(e)==="[object Object]"){const{areaCode:s,excludedArea:o}=e;if(!s)throw new V(w.INVALID_PARAMS,"area code is needed");let a=s;typeof s=="string"&&(a=[s]),i=o?bH(a,o):a}if(!t){if(Ni.AREAS){const s=new V(w.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(s),void _.warning("setArea is prohibited because of config-distribute")}if(X(i).call(i,rt.GLOBAL)&&b("AREAS")===rt.EXTENSIONS){const s=new V(w.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(s),void _.warning("setArea is prohibited because of ap extensions")}}_t("AREAS",i,t);const r=CH(i);Object.keys(r).map((s=>{s==="LOG_UPLOAD_SERVER"||s==="EVENT_REPORT_DOMAIN"||s==="EVENT_REPORT_BACKUP_DOMAIN"||s==="PROXY_SERVER_TYPE3"?_t(s,r[s][0]):_t(s,r[s])})),_.debug("set area success:",i.join(","))}catch(i){throw n.onError(i),i}n.onSuccess()}function gN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function us(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?gN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):gN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let Ug=1;function IH(e,t,n,i,r){Ug+=1;const s={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:Ug,requestId:Ug,version:Gi,cname:n.cname},o={service_name:t,json_body:JSON.stringify(s)};let a,c,d=e[0];return Pr((async()=>{a=Date.now();const l=await Vr(d,{data:o,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,l.code!==0){const p=new V(w.UNEXPECTED_RESPONSE,"live streaming ap error, code"+l.code,{retry:!0,responseTime:c});throw _.error(p.toString()),p}const u=JSON.parse(l.json_body);if(u.code!==200){const p=new V(w.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(u.code,", reason: ").concat(u.reason),{code:u.code,responseTime:c});throw _.error(p.toString()),p}if(!u.servers||u.servers.length===0){const p=new V(w.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:u.code,responseTime:c});throw _.error(p.toString()),p}const h=(function(p,R){return{addressList:p.servers.map((T=>"wss://".concat(T.address.replace(/\./g,"-"),".").concat(b("WORKER_DOMAIN"),":").concat(T.wss,"?serviceName=").concat(encodeURIComponent(R)))),workerToken:p.workerToken,vid:p.vid}})(u,t);return b("LIVE_STREAMING_ADDRESS")&&(h.addressList=b("LIVE_STREAMING_ADDRESS")instanceof Array?b("LIVE_STREAMING_ADDRESS"):[b("LIVE_STREAMING_ADDRESS")]),us(us({},h),{},{responseTime:c})}),((l,u)=>(pe.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(l.addressList),firstSuccess:u===0,responseTime:c,serverIp:e[u%e.length]}),!1)),((l,u)=>(pe.apworkerEvent(n.sid,{success:!1,sc:l.data&&l.data.code||200,serviceName:t,responseTime:c,serverIp:e[u%e.length]}),!!(l.code!==w.OPERATION_ABORTED&&l.code!==w.UNEXPECTED_RESPONSE||l.data&&l.data.retry)&&(d=e[(u+1)%e.length],!0))),r)}let Vg=1;function SN(e,t,n,i){let{url:r,areaCode:s}=e;const{clientId:o,sid:a}=t,c=Date.now();let d;const l=t.role,[u,h]=Fg(t,s,[Jt.CHOOSE_SERVER]);let p=jt.networkState;return Pr((async()=>{p&&jt.networkState===Xn.OFFLINE&&jt.onlineWaiter&&await ie.race([jt.onlineWaiter,hn(i&&i.maxRetryTimeout||Xt.maxRetryTimeout)]),p=jt.networkState;const{data:R,headers:T}=await Vr(r,{data:u,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=T.http3==="1"?1:-1,pe.reportResourceTiming(r,a),yN(R,r,t,c,[Jt.CHOOSE_SERVER],d);const y=Qd(R,Jt.CHOOSE_SERVER);return jg(y),bg(y,r)}),(R=>(R&&pe.joinChooseServer(a,{role:l,lts:c,succ:!0,csAddr:r,opid:h,serverList:R.gatewayAddrs.map((T=>T.address)),ec:null,cid:R.cid.toString(),uid:R.uid.toString(),csIp:R.csIp,unilbsServerIds:[Jt.CHOOSE_SERVER].toString(),isHttp3:d,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:R.res.detail&&R.res.detail[38],vid:R.vid}),!1)),(R=>R.code!==w.OPERATION_ABORTED&&(R.code===w.CAN_NOT_GET_GATEWAY_SERVER?R.data.retry:(pe.joinChooseServer(a,{role:l,lts:c,succ:!1,csAddr:r,serverList:null,opid:h,ec:R.code,csIp:R.data&&R.data.csIp,unilbsServerIds:[Jt.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:p}),isHttp3:d,corssRegionTagReq:t.apRequestDetail}),_.warning("[".concat(o||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),R),!0))),i)}function TN(e,t,n,i){let r,{url:s,areaCode:o,serviceIds:a}=e;const c=Date.now(),d=t.role,[l,u]=Fg(t,o,a);let h;return Pr((async()=>{h&&jt.networkState===Xn.OFFLINE&&jt.onlineWaiter&&await ie.race([jt.onlineWaiter,hn(i&&i.maxRetryTimeout||Xt.maxRetryTimeout)]),h=jt.networkState;const{data:p,headers:R}=await Vr(s,{data:l,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=R.http3==="1"?1:-1,pe.reportResourceTiming(s,t.sid),yN(p,s,t,c,a,r);const T=Qd(p,Jt.CHOOSE_SERVER),y=Qd(p,t.cloudProxyServer==="proxy5"?Jt.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Jt.CLOUD_PROXY:Jt.CLOUD_PROXY_FALLBACK),I=performance.getEntriesByName(s),A=I[I.length-1];let N;return A&&(N={name:A.name,protocol:"nextHopProtocol"in A?A.nextHopProtocol:"",dnscost:"domainLookupEnd"in A&&"domainLookupStart"in A&&typeof A.domainLookupEnd=="number"&&typeof A.domainLookupStart=="number"?A.domainLookupEnd-A.domainLookupStart:-1,tcpTlsCost:"connectEnd"in A&&"connectStart"in A&&typeof A.connectEnd=="number"&&typeof A.connectStart=="number"?A.connectEnd-A.connectStart:-1,reqCost:"requestStart"in A&&typeof A.requestStart=="number"&&"responseEnd"in A&&typeof A.responseEnd=="number"?A.responseEnd-A.requestStart:-1,handleCost:"leave_ts"in p&&"enter_ts"in p&&typeof p.leave_ts=="number"&&typeof p.enter_ts=="number"?p.leave_ts-p.enter_ts:-1}),jg(T),{gatewayInfo:bg(T,s),proxyInfo:y,url:s,resourceTimingInfo:N}}),(p=>{var R;return p.gatewayInfo&&pe.joinChooseServer(t.sid,{role:d,lts:c,succ:!0,csAddr:s,serverList:p.gatewayInfo.gatewayAddrs.map((T=>T.address)),ec:null,opid:u,cid:p.gatewayInfo.cid.toString(),uid:p.gatewayInfo.uid.toString(),csIp:p.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:p.gatewayInfo.res.detail&&p.gatewayInfo.res.detail[38],vid:(R=p.gatewayInfo)===null||R===void 0?void 0:R.vid,resourceTimingInfo:p.resourceTimingInfo?JSON.stringify(p.resourceTimingInfo):void 0}),p.proxyInfo&&pe.joinWebProxyAP(t.sid,{lts:c,sucess:1,apServerAddr:s,turnServerAddrList:p.proxyInfo.addresses.map((T=>T.ip)).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:a.toString()}),!1}),(p=>p.code!==w.OPERATION_ABORTED&&(p.code===w.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(pe.joinWebProxyAP(t.sid,{lts:c,sucess:0,apServerAddr:s,turnServerAddrList:null,errorCode:p.code,eventType:t.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:h})}),_.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),p),!0))),i)}const yN=(e,t,n,i,r,s)=>{const{sid:o,clientId:a,cloudProxyServer:c}=n,d=[],l=u=>{u.flag===4096?pe.joinChooseServer(o,{role:n.role,lts:i,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:u.error.message,csIp:u.error.data&&u.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:s,corssRegionTagReq:n.apRequestDetail}):u.flag!==1048576&&u.flag!==4194304&&u.flag!==4194310||pe.joinWebProxyAP(o,{lts:i,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:u.error.code,eventType:c,unilbsServerIds:r.toString()})};if(e.response_body.forEach((u=>{const h=u.buffer.code;if(u.uri===23&&h===0&&!u.buffer.edges_services)if(u.buffer.flag===4194310)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),u.buffer.edges_services=[];else{const p={error:new V(w.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:b("NO_EDGES_RETRY"),csIp:e.detail[502]}),flag:u.buffer.flag};d.push(p),l(p)}if(h!==0){const p=Nc(h),R={error:new V(w.CAN_NOT_GET_GATEWAY_SERVER,p.desc,{desc:p.desc,retry:p.retry,csIp:e.detail[502]}),flag:u.buffer.flag};u.buffer.flag===4194310?_.warning(R.error.toString()):d.push(R),l(R)}})),d.length)throw _.warning("[".concat(a||"sid-".concat(o.slice(0,6)),"] multi unilbs ").concat(t," failed, ").concat(d.map((u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message,", retry: ").concat(u.error.data.retry))).join(" | "))),new V(w.CAN_NOT_GET_GATEWAY_SERVER,d.map((u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message))).join(" | "),{retry:!!d.find((u=>u.error.data.retry)),csIp:e.detail[502],desc:[...new Set(d.map((u=>{var h;return u==null||(h=u.error)===null||h===void 0||(h=h.data)===null||h===void 0?void 0:h.desc})).filter((u=>!!u)))]})},jg=e=>{var t,n,i,r;if(e.addresses&&e.addresses.length===0&&e.code===0)throw new V(w.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(b("AP_AREA")&&((i=e.detail)!==null&&i!==void 0&&i[23]&&typeof((r=e.detail)===null||r===void 0?void 0:r[23])=="string"?EN(e.detail[23].toLowerCase()):EN()),(t=e.detail)!==null&&t!==void 0&&t[19]&&typeof((n=e.detail)===null||n===void 0?void 0:n[19])=="string"){const o=e.detail[19],a=o?.split(";");for(let c=0;c<a.length;c++){var s;const d=zn(s=a[c]).call(s);e.addresses[c]&&a&&(e.addresses[c].fingerprint=d)}}if(b("GATEWAY_ADDRESS")&&b("GATEWAY_ADDRESS").length>0){_.debug("assign gateway address to",b("GATEWAY_ADDRESS"));const o=b("GATEWAY_ADDRESS").map((a=>{var c,d;const l=(c=(d=e.addresses.find((u=>u.ip===a.ip&&u.port===a.port)))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:a.fingerprint||l}}));e.addresses=o}},wH=(e,t)=>{if(e.response_body&&e.response_body.length){const n=e.response_body[0];if(n.buffer.code!==0){const i=Nc(n.buffer.code);throw new V(w.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(i.desc),{retry:i.retry})}return n.buffer.ticket}throw _.debug("update ticket request received ap response without response body:",t),new V(w.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},Fg=(e,t,n)=>{const i=Math.floor(Math.random()*1e12),r=e.role==="host"?"1":e.role==="audience"?"2":void 0,s={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:us(us(us({6:e.stringUid,11:t,12:b("USE_NEW_TOKEN")?"1":void 0},r?{17:r}:{}),{},{22:t},e.apRequestDetail?{33:e.apRequestDetail}:{}),e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:n,uid:e.uid||0}}]};s.request_bodies.forEach((a=>{e.multiIP&&e.multiIP.gateway_ip&&(a.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,i]},AH=(e,t)=>{const n=Math.floor(Math.random()*1e12),i={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((s=>({ip:s.ip,port:s.port})))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,n]};let Lc=0;function kc(e){return ie.all(e.map((t=>t.then((n=>{throw n}),(n=>n))))).then((t=>{throw t}),(t=>t))}const rl=async e=>{let{fragementLength:t,referenceList:n,asyncMapHandler:i,allFailedhandler:r,promisesCollector:s}=e,o=0;const a=t;let c,d=0;const l=async()=>{const u=(()=>{const h=o*a,p=h+a;return n.slice(h,p).map(i)})();s&&s.push(...u);try{c=await kc(u)}catch(h){if(d+=a,o++,!(d>=n.length))return void await l();r(h)}u.forEach((h=>h.cancel()))};return await l(),c},vN=async e=>{let{referenceList:t,asyncMapHandler:n,closeFn:i}=e;const r=t.length;let s=0;const o=async()=>{const a=n(t.shift());try{return await a}catch(c){if(s++,s>=r||i!=null&&i(c))throw c;return o()}};return o()};async function OH(){if(typeof VideoDecoder>"u")return!0;let e;const t=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,85,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,149,160,133,4,144,43,122,168,159,120,159,205,39,82,131,57,52,87,187,68,23,248,134,204,226,97,17,49,183,55,236,219,249,221,98,208,215,190,59,179,167,213,47,1,246,150,14,194,245,159,83,35,64,103,218,38,21,82,3,135,21,185,84,248,134],n=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,148,62,134,140,92,172,141,77,35,94,181,164,65,169,65,156,154,43,221,162,11,252,67,102,113,48,136,137,219,62,43,113,239,23,126,250,186,252,10,138,218,25,193,244,74,68,194,209,107,23,52,206,199,78,72,98,103,151,71,96,62,51,210,158,72,231,158],i=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,143,233,163,51,196,98,95,151,224,22,134,33,240,150,248,67,18,34,196,142,81,238,173,140,80,205,232,132,144,67,12,131,157,4,171,243,86,122,35,6,166,184,243,85,126,13,206,103,152,62,168,160,187,2,241,138,52,211,72,121,128,151,63,147,128,19,42],r=[18,0,50,138,1,48,192,64,253,248,65,17,67,192,32,0,16,0,0,0,0,0,0,0,195,12,48,144,64,32,0,209,75,61,9,204,25,115,79,226,115,63,63,208,70,210,220,153,126,241,237,37,107,195,153,1,99,112,230,189,209,169,130,10,11,22,167,215,159,205,197,7,183,162,26,48,254,141,134,103,32,16,235,45,1,15,18,119,169,110,206,251,51,115,202,60,148,1,46,39,109,25,28,86,168,15,77,211,239,2,58,43,146,26,230,184,81,48,140,226,226,250,222,146,171,133,164,13,188,180,64,122,142,146,32,208,238,170,193,35,53,44,225],s=[18,0,50,107,48,0,133,125,248,65,26,195,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,204,24,122,65,56,165,18,52,206,218,4,187,51,97,9,29,191,90,253,106,185,31,197,155,52,205,245,185,203,131,20,226,25,124,95,113,220,113,141,15,15,104,211,144,152,237,150,157,127,51,143,24,231,218,171,255,176,241,128,229,149,150,148,66,245,228,91,27,182,228,136,61,182,237,133,45,220,24,103,214,152],o=[18,0,50,122,48,1,9,253,248,65,26,67,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,198,182,231,242,220,235,163,140,12,36,36,166,46,132,210,4,71,23,218,132,27,30,17,45,244,79,31,243,195,136,100,169,76,88,142,85,204,217,121,168,29,163,198,17,251,223,73,12,212,244,139,123,151,179,75,216,96,208,136,40,229,42,59,149,10,116,228,85,99,93,221,108,255,140,248,20,30,167,122,109,206,164,108,197,110,251,23,243,133,160,63,13,207,177,12,128];return await new ie(((c,d)=>{let l;(async function(){e&&e.state!=="closed"||await(async function(){e=new VideoDecoder({output:h=>{h.close(),clearTimeout(l),c(!0)},error:h=>{clearTimeout(l),c(!1)}}),await e.configure({codec:"av01.0.05M.08",width:160,height:90})})();const u=[t,n,i,r,s,o];for(let h=0;h<u.length;h++){const p=new EncodedVideoChunk({type:h==0?"key":"delta",timestamp:33333*h,duration:33333,data:new Uint8Array(u[h])});try{await e.decode(p)}catch{return void c(!1)}}})(),l=setTimeout((()=>{c(!1)}),5e3)}))}async function sp(e,t,n,i){return{gatewayInfo:await(async function(s,o,a,c){let d=null;const l=[],u=async()=>{const p=b("WEBCS_DOMAIN").slice(0,b("AJAX_REQUEST_CONCURRENT")).map((y=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(y+"/api/v2/transpond/webrtc?v=2"):"https://".concat(y,"/api/v2/transpond/webrtc?v=2"),areaCode:il()}))),R=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map((y=>y.url))}),T=await rl({fragementLength:b("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:y=>(_.debug("[".concat(s.clientId,"] Connect to choose_server:"),y.url),SN(y,s,o,a)),allFailedhandler:y=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:y},R),y[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},R),T},h=async()=>{if(await hn(1e3),d!==null)return d;const p=b("WEBCS_DOMAIN_BACKUP_LIST").map((y=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(y+"/api/v2/transpond/webrtc?v=2"):"https://".concat(y,"/api/v2/transpond/webrtc?v=2"),areaCode:il()}))),R=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map((y=>y.url))}),T=await rl({fragementLength:b("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:y=>(_.debug("[".concat(s.clientId,"] Connect to backup choose_server:"),y.url),SN(y,s,o,a)),allFailedhandler:y=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:y},R),y[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},R),T};try{return d=await kc([u(),h()]),l.length&&l.forEach((p=>p.cancel&&typeof p.cancel=="function"&&p.cancel())),d}catch(p){throw p[0]}})(e,t,n,i)}}async function RN(e,t,n,i,r){const s=e.cloudProxyServer;if(s==="disabled"){if(e.useLocalAccessPoint)return await sp(e,t,n,r);if(b("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:h,proxyInfo:p}=await IN(e,t,n,r);if(e.turnServer&&e.turnServer.mode!=="auto")return{gatewayInfo:h};const R=p.map((T=>({turnServerURL:T.address,tcpport:T.tcpport||Nn.tcpport,udpport:T.udpport||Nn.udpport,username:T.username||Nn.username,password:T.password||Nn.password,forceturn:!1,security:!0})));if(r.useP2P){var o;const T=(o=e.uid)!==null&&o!==void 0?o:h.uid,y="glb:".concat(T.toString()),I=await vE(y),A=p.map((N=>({turnServerURL:N.address,tcpport:N.tcpport||Nn.tcpport,udpport:N.udpport||Nn.udpport,username:y,password:I,forceturn:!1,security:!0})));R.push(...A)}return e.turnServer={mode:"manual",servers:R},{gatewayInfo:h}}return await sp(e,t,n,r)}const{proxyInfo:a,gatewayInfo:c}=await IN(e,t,n,r),d={gatewayInfo:c},l=a.map((h=>({turnServerURL:h.address,tcpport:s==="proxy3"?void 0:h.tcpport?h.tcpport:Nn.tcpport,udpport:s==="proxy4"?void 0:h.udpport?h.udpport:Nn.udpport,username:h.username||Nn.username,password:h.password||Nn.password,forceturn:s!=="proxy4",security:s==="proxy5"})));if(r.useP2P){var u;const h=(u=e.uid)!==null&&u!==void 0?u:c.uid,p="glb:".concat(h.toString()),R=await vE(p),T=a.map((y=>({turnServerURL:y.address,tcpport:s==="proxy3"?void 0:y.tcpport||Nn.tcpport,udpport:s==="proxy4"?void 0:y.udpport||Nn.udpport,username:p,password:R,forceturn:s!=="proxy4",security:s==="proxy5"})));l.push(...T)}return e.turnServer={mode:"manual",servers:l},_.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(s)),d}async function CN(e,t,n,i,r){const s=b("ACCOUNT_REGISTER").slice(0,b("AJAX_REQUEST_CONCURRENT"));let o=[];o=t.proxyServer?s.map((c=>"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1"))):s.map((c=>"https://".concat(c,"/api/v1")));const a=r?.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:o});try{const c=await(async function(d,l,u,h,p){const R=Date.now(),T={sid:u.sid,opid:10,appid:u.appId,string_uid:l};let y=d[0];const I=await Pr((()=>Vr(y+"".concat(y.indexOf("?")===-1?"?":"&","action=stringuid"),{data:T,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((A,N)=>{if(A.code===0){if(A.uid<=0||A.uid>=Math.pow(2,32))throw _.error("Invalid Uint Uid ".concat(l," => ").concat(A.uid),A),pe.reqUserAccount(T.sid,{lts:R,success:!1,serverAddr:y,stringUid:T.string_uid,uid:A.uid,errorCode:w.INVALID_UINT_UID_FROM_STRING_UID,extend:T}),new V(w.INVALID_UINT_UID_FROM_STRING_UID);return pe.reqUserAccount(T.sid,{lts:R,success:!0,serverAddr:y,stringUid:T.string_uid,uid:A.uid,errorCode:null,extend:T}),!1}const k=Nc(A.code);return k.retry&&(y=d[(N+1)%d.length]),pe.reqUserAccount(T.sid,{lts:R,success:!1,serverAddr:y,stringUid:T.string_uid,uid:A.uid,errorCode:k.desc,extend:T}),k.retry}),((A,N)=>A.code!==w.OPERATION_ABORTED&&(pe.reqUserAccount(T.sid,{lts:R,success:!1,serverAddr:y,stringUid:T.string_uid,uid:null,errorCode:A.code,extend:T}),y=d[(N+1)%d.length],!0)),p);if(I.code!==0){const A=Nc(I.code);throw new V(w.UNEXPECTED_RESPONSE,A.desc)}return I})(o,e,t,n,i);return r?.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r?.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function NH(e,t,n){const i=b("ACCOUNT_REGISTER");let r=[];r=t.proxyServer?i.map((s=>"https://".concat(t.proxyServer,"/ap/?url=").concat(s+"/api/v1"))):i.map((s=>"https://".concat(s,"/api/v1")));try{return await vN({referenceList:r,asyncMapHandler:o=>(async function(a,c,d,l){const u=Date.now(),h={sid:d.sid,opid:10,appid:d.appId,string_uid:c};try{const p=await Vr(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:h,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(p.code!==0){const R=Nc(p.code);throw new V(w.UNEXPECTED_RESPONSE,"preload sua error:".concat(R.desc),R)}if(p.uid<=0||p.uid>=Math.pow(2,32))throw new V(w.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:u,url:a,req:h,uid:p.uid,elapse:Date.now()-u}}catch(p){throw p}})(o,e,t,n),closeFn:o=>o.code===w.OPERATION_ABORTED||o.code===w.UNEXPECTED_RESPONSE&&!o.data.retry})}catch(s){throw s}}async function DH(e,t,n){const i=b("CDS_AP").slice(0,b("AJAX_REQUEST_CONCURRENT")).map((c=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config"))),r=i.map((c=>(function(d,l,u,h){const p=Ze(),R={flag:64,cipher_method:0,features:us(us(us(us(us({install_id:xE(),device:p.name,system:p.os,system_general:navigator.userAgent,vendor:l.appId,version:Gi,cname:l.cname,session_id:l.sid,proxyServer:l.proxyServer,sdk_type:yH.WEB_RTC,browser_name:p.name,browser_version:p.version,user_agent:navigator.userAgent,channel_name:l.cname},l.stringUid&&{string_uid:l.stringUid}),l.uid&&{uid:l.uid+""}),p.os&&{os_name:p.os}),p.osVersion&&{os_version:p.osVersion}),{},{detail:""})};return Pr((()=>Vr(d,{data:R,timeout:1e3,cancelToken:u,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(T=>T.code!==w.OPERATION_ABORTED),h)})(c,e,t,n)));let s=null,o=null,a={};try{s=await kc(r)}catch(c){if(c.code===w.OPERATION_ABORTED)throw c;o=c}if(r.forEach((c=>c.cancel())),pe.reportApiInvoke(e.sid,{name:Nt.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:s}}).onSuccess(),s&&s.test_tags)try{a=(function(c){if(!c.test_tags)return{};const d=c.test_tags,l=Object.keys(d),u={};return l.forEach((h=>{var p;const R=zn(p=h.slice(4)).call(p),T=JSON.parse(d[h]),y=T[1];u[R]={tag:T[0]||"",value:y}})),u})(s)}catch{}return a}async function bN(e,t){const n=b("WEBCS_DOMAIN").concat(b("WEBCS_DOMAIN_BACKUP_LIST")).map((i=>({url:"https://".concat(i,"/api/v2/transpond/webrtc?v=2"),areaCode:il(),serviceIds:[Jt.CHOOSE_SERVER,Jt.CLOUD_PROXY_FALLBACK]})));try{return await vN({referenceList:n,asyncMapHandler:r=>(async function(s,o,a){let c,{url:d,areaCode:l,serviceIds:u}=s;const h=Date.now(),[p,R]=Fg(o,l,u);let T=jt.networkState;try{T&&jt.networkState===Xn.OFFLINE&&jt.onlineWaiter&&await ie.race([jt.onlineWaiter,hn(Xt.maxRetryTimeout)]),T=jt.networkState;const{data:y,headers:I}=await Vr(d,{data:p,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=I.http3==="1"?1:-1,(x=>{const P=[];if(x.response_body.forEach((M=>{const G=M.buffer.code;if(M.uri===23&&G===0&&!M.buffer.edges_services)if(M.buffer.flag===4194310)M.buffer.edges_services=[];else{const Y={error:new V(w.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:b("NO_EDGES_RETRY"),csIp:x.detail[502]}),flag:M.buffer.flag};P.push(Y)}if(G!==0){const Y=Nc(G),de={error:new V(w.CAN_NOT_GET_GATEWAY_SERVER,Y.desc,{desc:Y.desc,retry:Y.retry,csIp:x.detail[502]}),flag:M.buffer.flag};M.buffer.flag===4194310?_.warning(de.error.toString()):P.push(de)}})),P.length)throw new V(w.CAN_NOT_GET_GATEWAY_SERVER,P.map((M=>"flag: ".concat(M.flag,", message: ").concat(M.error.message))).join(" | "),{retry:!!P.find((M=>M.error.data.retry)),csIp:x.detail[502],desc:[...new Set(P.map((M=>{var G;return M==null||(G=M.error)===null||G===void 0||(G=G.data)===null||G===void 0?void 0:G.desc})).filter((M=>!!M)))]})})(y);const N=Qd(y,Jt.CHOOSE_SERVER),k=Qd(y,Jt.CLOUD_PROXY_FALLBACK);return jg(N),{gatewayInfo:bg(N,d),proxyInfo:k,opid:R,requestTime:h,url:d,isHttp3:c,elapse:Date.now()-h}}catch(y){throw y}})(r,e,t),closeFn:r=>r.code===w.OPERATION_ABORTED||r.code===w.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(i){throw i}}async function IN(e,t,n,i){const r=b("PROXY_SERVER_TYPE3"),s=(p,R,T)=>{let y=T||r;return Array.isArray(y)&&(y=R%2==0&&r[1]||r[0]),"https://".concat(y,"/ap/?url=").concat(p)};let o=null;const a=[],c=async()=>{const p=b("WEBCS_DOMAIN").slice(0,b("AJAX_REQUEST_CONCURRENT")).map(((y,I)=>{let A;return A=e.cloudProxyServer==="disabled"&&e.proxyServer?s("".concat(y,"/api/v2/transpond/webrtc?v=2"),I,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(y,"/api/v2/transpond/webrtc?v=2"):s("".concat(y,"/api/v2/transpond/webrtc?v=2"),I),{url:A,areaCode:il(),serviceIds:[Jt.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?Jt.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?Jt.CLOUD_PROXY:Jt.CLOUD_PROXY_FALLBACK]}})),R=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map((y=>y.url))}),T=await rl({fragementLength:b("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:y=>(_.debug("[".concat(e.clientId,"] Connect to choose_server:"),y.url),TN(y,e,t,n)),allFailedhandler:y=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:y},R),y[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},R),T},d=async()=>{if(await hn(1e3),o!==null)return o;const p=b("WEBCS_DOMAIN_BACKUP_LIST").map(((y,I)=>{let A;return A=e.cloudProxyServer==="disabled"&&e.proxyServer?s("".concat(y,"/api/v2/transpond/webrtc?v=2"),I,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(y,"/api/v2/transpond/webrtc?v=2"):s("".concat(y,"/api/v2/transpond/webrtc?v=2"),I),{url:A,areaCode:il(),serviceIds:[Jt.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?Jt.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?Jt.CLOUD_PROXY:Jt.CLOUD_PROXY_FALLBACK]}})),R=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map((y=>y.url))}),T=await rl({fragementLength:b("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:y=>(_.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),y.url),TN(y,e,t,n)),allFailedhandler:y=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:y},R),y[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},R),T};let l,u,h;try{({gatewayInfo:l,proxyInfo:u,url:h}=await kc([c(),d()]))}catch(p){throw p[0]}if(a.length&&a.forEach((p=>p.cancel&&typeof p.cancel=="function"&&p.cancel())),!l||!u)throw new V(w.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=h,e.cloudProxyServer!=="disabled"&&Array.isArray(r)&&h){const p=/^https?:\/\/(.+?)(\/.*)?$/.exec(h)[1];X(r).call(r,p)&&(e.proxyServer=p,_.setProxyServer(p),pe.setProxyServer(p))}return o={gatewayInfo:l,proxyInfo:await JO(u,l.uid)},o}async function PH(e,t,n){const i=b("UAP_AP").slice(0,b("AJAX_REQUEST_CONCURRENT")).map((s=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(s+"/api/v1?action=uap"):"https://".concat(s,"/api/v1?action=uap"))),r=i.map((s=>(function(o,a,c,d){const l={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:Gi,cname:a.cname,uid:a.uid.toString(),requestId:Vg,seq:Vg};Vg+=1;const u={service_name:"tele_channel",json_body:JSON.stringify(l)};return Pr((async()=>{const h=await Vr(o,{data:u,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(h.code!==0){const R=new V(w.UNEXPECTED_RESPONSE,"cross channel ap error, code"+h.code,{retry:!0});throw _.error(R.toString()),R}const p=JSON.parse(h.json_body);if(p.code!==200){const R=new V(w.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(p.code,", reason: ").concat(p.reason));throw _.error(R.toString()),R}if(!p.servers||p.servers.length===0){const R=new V(w.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw _.error(R.toString()),R}return{vid:p.vid,workerToken:p.workerToken,addressList:(b("CHANNEL_MEDIA_RELAY_SERVERS")||p.servers).map((R=>"wss://".concat(R.address.replace(/\./g,"-"),".").concat(b("WORKER_DOMAIN"),":").concat(R.wss)))}}),void 0,(h=>!!(h.code!==w.OPERATION_ABORTED&&h.code!==w.UNEXPECTED_RESPONSE||h.data&&h.data.retry)),d)})(s,e,t,n)));try{const s=await kc(r);return r.forEach((o=>o.cancel())),s}catch(s){throw s[0]}}async function LH(e,t,n){let i=null;const r=[],s=async o=>{const a=b(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((c=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2")));return o&&(await hn(1e3),i!==null)?i:await rl({fragementLength:b("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(_.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),c),(function(d,l,u,h){const[p]=AH(l,[Jt.CHOOSE_SERVER]);let R=jt.networkState;return Pr((async()=>{R&&jt.networkState===Xn.OFFLINE&&jt.onlineWaiter&&await ie.race([jt.onlineWaiter,hn(h&&h.maxRetryTimeout||Xt.maxRetryTimeout)]),R=jt.networkState;const T=await Vr(d,{data:p,cancelToken:u,headers:{"Content-Type":"multipart/form-data;"}},!0);return wH(T,d)}),(()=>!1),(T=>T.code!==w.OPERATION_ABORTED&&(T.code===w.UPDATE_TICKET_FAILED?T.data.retry:(_.warning("[".concat(l.clientId,"] update ticket network error, retry"),T),!0))),h)})(c,e,t,n)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return i=await kc([s(!1),s(!0)]),r.length&&r.forEach((o=>o.cancel&&typeof o.cancel=="function"&&o.cancel())),i}catch(o){throw o[0]}}function wN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Bg(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?wN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class kH extends kt{get isSuccess(){return!!this.configs}constructor(t,n){super(),v(this,"configs",void 0),v(this,"store",void 0),v(this,"joinInfo",void 0),v(this,"cancelToken",void 0),v(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),v(this,"interval",void 0),v(this,"mutex",void 0),v(this,"mutableParamsRead",!1),v(this,"configCache",{}),v(this,"limit_bitrate",void 0),this.mutex=new gn("config-distribute",t),this.store=n}startGetConfigDistribute(t,n){this.joinInfo=t,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),b("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),b("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,pe.reportApiInvoke(null,{options:void 0,name:Nt.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Tt.TRACER}).onSuccess(JSON.stringify(Ni))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void _.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const n=await this.mutex.lock();try{t=await DH(this.joinInfo,this.cancelToken,this.retryConfig),_.debug("[config-distribute] get config distribute",JSON.stringify(t));const i=(function(r){var s;const o=ko(s=Object.keys(r).filter((d=>/^webrtc_ng_global_parameter/.test(d)))).call(s);for(let d=0;d<o.length;d++)for(let l=o.length-1;l>d;l--){const u=o[l],h=r[u].value;if(typeof h.__priority=="number"){const p=h.__priority,R=o[l-1],T=r[R].value;if(typeof T.__priority=="number"){if(!(p>T.__priority))continue;{const y=u;o[l]=o[l-1],o[l-1]=y}}else{const y=u;o[l]=o[l-1],o[l-1]=y}}}const a=Date.now(),c={};return o.forEach((d=>{const l=r[d].value.__expires;l&&l<=a||(c[d]=r[d])})),c})(t);this.cacheGlobalParameterConfig(i),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=i}catch(i){const r=new V(w.NETWORK_RESPONSE_ERROR,i);_.warning("[config-distribute] ".concat(r.toString()))}finally{n()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(t){BO(t)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==t.id&&this.emit(xr.UPDATE_BITRATE_LIMIT,t):this.emit(xr.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.limit_bitrate&&Bg({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(t){try{const n={},i=Object.keys(t),r=[];i.forEach((s=>{const o=t[s].value;n[s]=o;const a=o.__id;if(a&&this.configCache[s]&&this.configCache[s].__id===a)return;const c=o.__type,d=t[s].value,l=t[s].tag;let u=0;c?c===oA.REALTIME&&(u=1):Object.keys(d).some((h=>Object.prototype.hasOwnProperty.call(jE,h)||!pg()&&Object.prototype.hasOwnProperty.call(vh,h)?(u=1,!0):void 0)),r.push({tag:l,isApplied:u,feature:s,params:JSON.stringify(o)})})),r.forEach((s=>{let{tag:o,feature:a,params:c,isApplied:d}=s;this.store.sessionId&&pe.abTest(this.store.sessionId,{intSucc:1,isApplied:d,tag:o,feature:a,params:c,cid:this.store.cid,uid:this.store.intUid})})),this.configCache=n}catch(n){_.debug("handleABTestConfigDistribute error",n)}}cacheGlobalParameterConfig(t){const n=(function(r){const s={};return Object.keys(r).forEach((o=>{const a=r[o].value,c=a.__expires,d=a.__type;Object.keys(a).forEach((l=>{l==="__id"||l==="__type"||l==="__priority"||l==="__expires"||Object.prototype.hasOwnProperty.call(s,l)||(s[l]=Bg(Bg({value:a[l]},c&&{expires:c}),d&&{type:d}))}))})),s})(t);try{var i;const r=(i=n.LIMIT_BITRATE)===null||i===void 0?void 0:i.value;delete n.LIMIT_BITRATE,r&&BO(r)&&this.handleBitrateLimit(r),this.limit_bitrate=r,this.handleGlobalParameterConfig(n),this.handleABTestConfigDistribute(t),(function(a){try{const c=Date.now();Object.keys(a).forEach((d=>{const{value:l,type:u,expires:h}=a[d];h&&h<=c||((u===oA.REALTIME||Object.prototype.hasOwnProperty.call(jE,d))&&(Ni[d]=l,ht[d]=l,_.debug("Update realtime parameters from config distribute",d,l)),u||pg()||!Object.prototype.hasOwnProperty.call(vh,d)||(Ni[d]=l,ht[d]=l,_.debug("Update gateway parameters from config distribute",d,l)))}))}catch(c){_.error("Error update config immediately: ".concat(a),c.message)}})(n);const s=JSON.stringify(n),o=window.btoa(s);window.localStorage.setItem("websdk_ng_global_parameter",o),_.debug("Caching global parameters ".concat(s))}catch(r){_.error("Error caching global parameters:",r.message)}}handleGlobalParameterConfig(t){try{const n=Date.now();Object.keys(t).forEach((i=>{switch(i){case"CLIENT_ROLE_OPTIONS":if(Object.prototype.hasOwnProperty.call(ht,i)){const{value:s,expires:o}=t[i];if(o&&o<=n)return;wE(ht[i],s)||(Ni[i]=s,ht[i]=s,this.emit(xr.UPDATE_CLIENT_ROLE_OPTIONS,s),_.debug("Updating client role options: ".concat(JSON.stringify(s))))}break;case"REMOTE_VIDEO_STREAM_TYPE":if(Object.prototype.hasOwnProperty.call(ht,i)){var r;const{value:s,expires:o}=t[i];if(o&&o<=n)return;typeof s=="number"&&X(r=[0,1,4,5,6,7,8,9]).call(r,s)&&(Ni[i]={value:s},ht[i]=s,this.emit(xr.UPDATE_REMOTE_VIDEO_STREAM_TYPE,s),_.debug("Updating client remote stream type: ".concat(JSON.stringify(s))))}break;case"ENABLE_FORCE_HLS":if(Object.prototype.hasOwnProperty.call(ht,i)){const{value:s,expires:o}=t[i];if(o&&o<=n)return;wE(ht[i],s)||(Ni[i]=s,ht[i]=s,this.emit(xr.FALLBACK_TO_HLS,s),_.debug("Updating enable force hls: ".concat(JSON.stringify(s))))}break;case"VOS_CONFIGURE":if(Object.prototype.hasOwnProperty.call(ht,i)){const{value:s,expires:o}=t[i];if(o&&o<=n)return;wE(ht[i],s)||(Ni[i]=s,ht[i]=s,this.emit(xr.UPDATE_VOS_CONFIGURE,s),_.debug("Updating vos configure: ".concat(JSON.stringify(s))))}}}))}catch(n){_.error("Error handling global parameter config:",n.message)}}}class xH extends kt{constructor(){super(...arguments),v(this,"resultStorage",new Map)}setLocalAudioStats(t,n,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(i,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(i,n))}setLocalVideoStats(t,n,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(i,n)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(i,n)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(i)),!n.muted&&this.record("VIDEO_ENCODE_FAILED",t,this.checResolutionSent(i))}setRemoteAudioStats(t,n){const i=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(n))}setRemoteVideoStats(t,n){const i=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(n))}record(t,n,i){if(b("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const r=this.resultStorage.get(t);if(!r)return;r.result.push(i);const s=t==="VIDEO_ENCODE_FAILED"?b("ENCODE_EXCEPTION_TIMES"):5;if(r.result.length>=s){var o;const a=X(o=r.result).call(o,!0);r.isPrevNormal&&!a&&this.emit("exception",Wg[t],t,n),!r.isPrevNormal&&a&&this.emit("exception",Wg[t]+2e3,t+"_RECOVER",n),r.isPrevNormal=a,r.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,n){return n instanceof sn&&!n.isActive||!!n.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,n){let i=null;n._encoderConfig&&n._encoderConfig.frameRate&&(i=ai(n._encoderConfig.frameRate));const r=t.captureFrameRate;return!i||!r||!(i>10&&r<5||i<10&&i>=5&&r<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checResolutionSent(t){var n;return!(!t.codecType||X(n=b("ENCODE_EXCEPTION_VALIDATE_CODEC")).call(n,t.codecType.toLocaleLowerCase()))||!t.captureFrameRate||t.sendFrameRate!==0||t.sendResolutionWidth!==0||t.sendResolutionHeight!==0}checkSendVideoBitrate(t,n){return!!n.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,n){return n instanceof sn&&!n.isActive||!!n.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}const Wg={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003,VIDEO_ENCODE_FAILED:2004},xn=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}measureFromPublishStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}};function AN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function da(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?AN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):AN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class sl{constructor(t){v(this,"store",void 0),v(this,"onStatsException",void 0),v(this,"onUploadPublishDuration",void 0),v(this,"onStatsChanged",void 0),v(this,"onVideoCodecChanged",void 0),v(this,"localStats",new Map),v(this,"remoteStats",new Map),v(this,"updateStatsInterval",void 0),v(this,"trafficStats",void 0),v(this,"trafficStatsPeerList",[]),v(this,"uplinkStats",void 0),v(this,"exceptionMonitor",void 0),v(this,"p2pChannel",void 0),v(this,"scalabilityMode",Th.L1T1),v(this,"updateStats",(()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))})),this.store=t,this.exceptionMonitor=new xH,this.exceptionMonitor.on("exception",((n,i,r)=>{this.onStatsException&&this.onStatsException(n,i,r)}))}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(J.LocalAudioTrack)||da({},KE)}getLocalVideoTrackStats(){return this.localStats.get(J.LocalVideoTrack)||da({},YE)}getRemoteAudioTrackStats(t){const n=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find((c=>c.peer_uid===s));return a&&(o.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),o},i={};if(t){var r;const s=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.audioStats;s&&(i[t]=n(t,s))}else Array.from(this.remoteStats.entries()).forEach((s=>{let[o,{audioStats:a}]=s;a&&(i[o]=n(o,a))}));return i}getRemoteNetworkQualityStats(t){const n={};if(t){var i;const r=(i=this.remoteStats.get(t))===null||i===void 0?void 0:i.networkStats;r&&(n[t]=r)}else Array.from(this.remoteStats.entries()).forEach((r=>{let[s,{networkStats:o}]=r;o&&(n[s]=o)}));return n}getNetworkQuality(){let t=0,n=0;return this.trafficStats&&(t=Jh(this.trafficStats.B_unq),n=Jh(this.trafficStats.B_dnq)),{uplinkNetworkQuality:t,downlinkNetworkQuality:n}}getRemoteVideoTrackStats(t){const n=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find((c=>c.peer_uid===s));return a&&(o.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),o},i={};if(t){var r;const s=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.videoStats;s&&(i[t]=n(t,s))}else Array.from(this.remoteStats.entries()).forEach((s=>{let[o,{videoStats:a}]=s;a&&(i[o]=n(o,a))}));return i}getRTCStats(){let t=0,n=0,i=0,r=0;const s=this.localStats.get(J.LocalAudioTrack);s&&(t+=s.sendBytes,n+=s.sendBitrate);const o=this.localStats.get(J.LocalVideoTrack);o&&(t+=o.sendBytes,n+=o.sendBitrate);const a=this.localStats.get(J.LocalVideoLowTrack);a&&(t+=a.sendBytes,n+=a.sendBitrate),this.remoteStats.forEach((d=>{let{audioStats:l,videoStats:u}=d;l&&(i+=l.receiveBytes,r+=l.receiveBitrate),u&&(i+=u.receiveBytes,r+=u.receiveBitrate)}));let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:n,SendBytes:t,RecvBytes:i,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter((n=>n.B_ppad!==void 0||n.B_ppvd!==void 0)),t.peer_delay.filter((n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1)).forEach((n=>{var i;const r=(i=this.p2pChannel)===null||i===void 0?void 0:i.getRemoteMedia(n.peer_uid),s=r!=null&&r.videoSSRC?xn.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,o=r!=null&&r.audioSSRC?xn.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,s>o?s:o),this.trafficStatsPeerList.push(n.peer_uid))})),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&_.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,n,i){if(!t)return!1;const r=!!i&&n.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||n.framesDecodeCount>i.framesDecodeCount;return r||!s}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach((n=>{let[i,r]=n;switch(i){case J.LocalVideoTrack:case J.LocalVideoLowTrack:{const a=r,c=da({},YE),d=t.getStats(),l=t.getLocalMedia(i);if(d){const u=d.videoSend.find((h=>h.ssrc===l?.ssrcs[0].ssrcId));if(u){const h=t.getLocalVideoSize(),p=t.getEncoderConfig(J.LocalVideoTrack);var s;(u.codec==="H264"||u.codec==="H265"||u.codec==="VP8"||u.codec==="VP9"||u.codec==="AV1X"||u.codec==="AV1")&&(c.codecType=u.codec,a?.codecType!==u.codec&&((s=this.onVideoCodecChanged)===null||s===void 0||s.call(this,u.codec.toLocaleLowerCase()))),c.sendBytes=u.bytes,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0,u.inputFrame?(c.captureFrameRate=u.inputFrame.frameRate,c.captureResolutionHeight=u.inputFrame.height,c.captureResolutionWidth=u.inputFrame.width):h&&(c.captureResolutionWidth=h.width,c.captureResolutionHeight=h.height),u.sentFrame?(c.sendFrameRate=u.sentFrame.frameRate,c.sendResolutionHeight=u.sentFrame.height,c.sendResolutionWidth=u.sentFrame.width):h&&(c.sendResolutionWidth=h.width,c.sendResolutionHeight=h.height),u.avgEncodeMs&&(c.encodeDelay=u.avgEncodeMs),p&&p.bitrateMax?c.targetSendBitrate=1e3*p.bitrateMax:u.targetBitrate&&(c.targetSendBitrate=u.targetBitrate),c.sendPackets=u.packets,c.sendPacketsLost=u.packetsLost,c.sendJitterMs=u.jitterMs,c.sendRttMs=u.rttMs,c.totalDuration=a?a.totalDuration+1:1,c.totalFreezeTime=a?a.totalFreezeTime:0,this.isLocalVideoFreeze(u)&&(c.totalFreezeTime+=1),u.scalabilityMode&&this.scalabilityMode!==u.scalabilityMode&&(_.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(u.scalabilityMode)),this.scalabilityMode=u.scalabilityMode)}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;this.localStats.set(i,c),(a?.sendResolutionWidth!==c.sendResolutionWidth||a?.sendResolutionHeight!==c.sendResolutionHeight)&&((o=this.onStatsChanged)===null||o===void 0||o.call(this,"resolution",{width:c.sendResolutionWidth,height:c.sendResolutionHeight})),c&&l&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,l.track,c);break}case J.LocalAudioTrack:{const a=r,c=da({},KE),d=t.getStats(),l=t.getLocalMedia(i);if(d){const u=d.audioSend.find((h=>h.ssrc===l?.ssrcs[0].ssrcId));if(u){if(u.codec!=="opus"&&u.codec!=="aac"&&u.codec!=="PCMU"&&u.codec!=="PCMA"&&u.codec!=="G722"||(c.codecType=u.codec),u.inputLevel)c.sendVolumeLevel=Math.round(32767*u.inputLevel);else{const h=t.getLocalAudioVolume();h&&(c.sendVolumeLevel=Math.round(32767*h))}c.sendBytes=u.bytes,c.sendPackets=u.packets,c.sendPacketsLost=u.packetsLost,c.sendJitterMs=u.jitterMs,c.sendRttMs=u.rttMs,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0}}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(J.LocalAudioTrack,c),c&&l&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,l.track,c);break}}}))}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach((n=>{var i,r;let[s,{videoStats:o,audioStats:a,videoPcStats:c}]=n;const d=a,l=o,u=c,h=da({},TA),p=da({},yA),R=da({},T6),{audioTrack:T,videoTrack:y,audioSSRC:I,videoSSRC:A}=t.getRemoteMedia(s);let N;N=this.store.useP2P?t.getStats(!0):t.getStats();const k=(i=N)===null||i===void 0?void 0:i.audioRecv.find((G=>G.ssrc===I)),x=(r=N)===null||r===void 0?void 0:r.videoRecv.find((G=>G.ssrc===A)),P=this.trafficStats&&this.trafficStats.peer_delay.find((G=>G.peer_uid===s));if(k&&(k.codec!=="opus"&&k.codec!=="aac"&&k.codec!=="PCMU"&&k.codec!=="PCMA"&&k.codec!=="G722"||(h.codecType=k.codec),k.outputLevel?h.receiveLevel=Math.round(32767*k.outputLevel):T&&(h.receiveLevel=Math.round(32767*T.getVolumeLevel())),h.receiveBytes=k.bytes,h.receivePackets=k.packets,h.receivePacketsLost=k.packetsLost,h.receivePacketsDiscarded=k.packetsDiscarded,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.receiveBitrate=d?8*Math.max(0,h.receiveBytes-d.receiveBytes):0,h.totalDuration=d?d.totalDuration+1:1,h.totalFreezeTime=d?d.totalFreezeTime:0,h.freezeRate=h.totalFreezeTime/h.totalDuration,h.receiveDelay=k.jitterBufferMs,h.totalDuration>10&&sl.isRemoteAudioFreeze(T)&&(h.totalFreezeTime+=1)),x){var M;x.codec!=="H264"&&x.codec!=="H265"&&x.codec!=="VP8"&&x.codec!=="VP9"&&x.codec!=="AV1X"&&x.codec!=="AV1"||(p.codecType=x.codec),p.receiveBytes=x.bytes,p.receiveBitrate=l?8*Math.max(0,p.receiveBytes-l.receiveBytes):0,p.decodeFrameRate=x.decodeFrameRate<0?0:x.decodeFrameRate,p.renderFrameRate=x.decodeFrameRate<0?0:x.decodeFrameRate,x.outputFrame&&(p.renderFrameRate=x.outputFrame.frameRate),x.receivedFrame?(p.receiveFrameRate=x.receivedFrame.frameRate,p.receiveResolutionHeight=x.receivedFrame.height,p.receiveResolutionWidth=x.receivedFrame.width):y&&(p.receiveResolutionHeight=y._videoHeight||0,p.receiveResolutionWidth=y._videoWidth||0),x.framesRateFirefox!==void 0&&(p.receiveFrameRate=Math.round(x.framesRateFirefox)),p.receivePackets=x.packets,p.receivePacketsLost=x.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost);const G=l?l.totalFreezeTime:0,Y=l?l.totalDuration:0;p.totalDuration=l?l.totalDuration+1:1,p.totalFreezeTime=(M=x.totalFreezesDuration)!==null&&M!==void 0?M:G||0,p.receiveDelay=x.jitterBufferMs||0;const de=!!A&&t.getRemoteVideoIsReady(A);x.totalFreezesDuration===void 0&&y&&de&&sl.isRemoteVideoFreeze(y,x,u)&&(p.totalFreezeTime+=1),p.freezeRate=Math.max(0,Math.min((p.totalFreezeTime-G)/(p.totalDuration-Y),1))}P&&(h.end2EndDelay=P.B_ad,p.end2EndDelay=P.B_vd,h.transportDelay=P.B_ed,p.transportDelay=P.B_ed,h.currentPacketLossRate=P.B_ealr4/100,p.currentPacketLossRate=P.B_evlr4/100,R.uplinkNetworkQuality=P.B_punq?P.B_punq:0,R.downlinkNetworkQuality=P.B_pdnq?P.B_pdnq:0),this.remoteStats.set(s,{audioStats:h,videoStats:p,videoPcStats:x,networkStats:R}),T&&this.exceptionMonitor.setRemoteAudioStats(T,h),y&&this.exceptionMonitor.setRemoteVideoStats(y,p)}))}}class ON{constructor(){v(this,"destChannelMediaInfos",new Map),v(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){jO(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){jO(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){Gh(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function NN(e){if(!(e instanceof ON))return new V(w.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),n=e.getDestChannelMediaInfo();if(!t)return new V(w.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new V(w.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class ho{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,n){v(this,"uid",void 0),v(this,"_uintid",void 0),v(this,"_trust_in_room_",!0),v(this,"_trust_audio_enabled_state_",!0),v(this,"_trust_video_enabled_state_",!0),v(this,"_trust_audio_mute_state_",!0),v(this,"_trust_video_mute_state_",!0),v(this,"_audio_muted_",!1),v(this,"_video_muted_",!1),v(this,"_audio_enabled_",!0),v(this,"_video_enabled_",!0),v(this,"_audio_added_",!1),v(this,"_video_added_",!1),v(this,"_is_pre_created",!1),v(this,"_video_pre_subscribed",!1),v(this,"_audio_pre_subscribed",!1),v(this,"_trust_video_stream_added_state_",!0),v(this,"_trust_audio_stream_added_state_",!0),v(this,"_audioTrack",void 0),v(this,"_videoTrack",void 0),v(this,"_dataChannels",[]),v(this,"_audioSSRC",void 0),v(this,"_videoSSRC",void 0),v(this,"_audioOrtc",void 0),v(this,"_videoOrtc",void 0),v(this,"_cname",void 0),v(this,"_rtxSsrcId",void 0),v(this,"_videoMid",void 0),v(this,"_audioMid",void 0),this.uid=t,this._uintid=n}}function DN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Gg(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?DN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):DN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const MH=e=>`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1 2
a=msid-semantic: WMS
a=ice-lite`.concat(e?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:2
`),op="9",Hg=2e4,ap=4e4;let PN=class{get localCapabilities(){return wt(this._localCapabilities)}get rtpCapabilities(){return wt(this._rtpCapabilities)}get candidates(){return wt(this._candidates)}get iceParameters(){return wt(this._iceParameters)}get dtlsParameters(){return wt(this._dtlsParameters)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],i=arguments.length>3&&arguments[3]!==void 0&&arguments[3];v(this,"sessionDesc",void 0),v(this,"_localCapabilities",void 0),v(this,"_rtpCapabilities",void 0),v(this,"_candidates",void 0),v(this,"_originCandidates",void 0),v(this,"_iceParameters",void 0),v(this,"_isUseExtmapAllowMixed",void 0),v(this,"_isUseLocalCodecs",void 0),v(this,"_isUseDataChannel",void 0),v(this,"_dtlsParameters",void 0),v(this,"setup",void 0),v(this,"currentMidIndex",void 0),v(this,"cname",void 0),v(this,"useLocalCodecsMids",[]),v(this,"preloadSsrcs",[]),v(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=t,this._isUseLocalCodecs=n,this._isUseDataChannel=i,e=wt(e);const{iceParameters:r,dtlsParameters:s,candidates:o,rtpCapabilities:a,setup:c,localCapabilities:d,cname:l}=e;this._rtpCapabilities=a,this._candidates=o,this._originCandidates=wt(o),this._iceParameters=r,this._dtlsParameters=s,this._localCapabilities=d,this.setup=c,this.cname=l,[this.sessionDesc]=this.updateRemoteRTPCapabilities(a),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(e){return e.length===this.preloadSsrcs.length&&e.every((t=>{var n;return X(n=this.preloadSsrcs).call(n,t)}))}preloadRemoteMedia(e){let t=0;const n=[],i=[];for(;e>0;){const r=[Gg({ssrcId:ap+t},b("USE_SUB_RTX")?{rtx:ap+t+1}:{})],s="".concat(ap+t,"_").concat(Hg+t),{ssrcs:o,ssrcGroups:a}=el(r,this.cname,b("SYNC_GROUP")?s:void 0),c=this.preCreateOrRecycleSendMedia("video",o,a,void 0),d=[{ssrcId:Hg+t}],l="".concat(ap+t,"_").concat(Hg+t),{ssrcs:u,ssrcGroups:h}=el(d,this.cname,b("SYNC_GROUP")?l:void 0),p=this.preCreateOrRecycleSendMedia("audio",u,h,void 0);e--,t+=2,n.push(c,p),i.push(o[0].ssrcId,u[0].ssrcId)}return this.useLocalCodecsMids.push(...n),this.preloadSsrcs=i,{mids:n,preSSRCs:i,isAvailable:!0}}preCreateOrRecycleSendMedia(e,t,n,i){const r=this.rtpCapabilities.send.videoCodecs,s=this._isUseLocalCodecs||r.length===0?this.localCapabilities.recv:this.rtpCapabilities.send;_.debug("create or recycle send media without remote rtp capabilities, ssrcs ",t[0].ssrcId);const o=e===ue.VIDEO?s.videoCodecs:s.audioCodecs,a=e===ue.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let d={media:{mediaType:e,port:op,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.map((l=>l.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:o,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};return d=this.mungSendMediaDesc(d,i),this.sessionDesc.mediaDescriptions.push(d),this.updateBundleMids(),c}toString(){return Ds(this.sessionDesc)}send(e,t,n,i){const{ssrcs:r,ssrcGroups:s}=el(t,this.cname,b("SYNC_GROUP")?n:void 0),o=this.findPreloadMediaDesc(r);if(o){if(It()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,o.attributes.mid),i&&(i.twcc||i.remb)){const a=this.sessionDesc.mediaDescriptions.indexOf(o);return this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(o,i),{mid:o.attributes.mid,needExchangeSDP:!0}}return{mid:o.attributes.mid,needExchangeSDP:!1}}{const a=this.findAvailableMediaIndex(e,r);let c;return a===-1||a===1&&(En()||(function(){const d=Ze();return!(d.name!==tt.CHROME||!d.osVersion)&&Number(d.version)<=90})()||Dr(143)||no(143)||b("RESERVE_MID_1_MLINE")||b("ENABLE_ENCODED_TRANSFORM")&&Os())||a===0&&!(function(d){const l=Ze();return!(l.name!==tt.FIREFOX||!l.osVersion)&&Number(l.version)===d})(138)&&b("USE_SUB_RTX")||ww()?(c=this.createOrRecycleSendMedia(e,r,s,"sendonly",i),this.updateBundleMids()):(c=wt(this.sessionDesc.mediaDescriptions[a]),c.attributes.direction="sendonly",c.attributes.ssrcs=r,c.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(c,i)),It()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,c.attributes.mid),{mid:c.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((r=>{let{kind:s,ssrcMsg:o,mslabel:a}=r;return this.send(s,o,a)})),n=[];let i=!1;return t.forEach((r=>{let{mid:s,needExchangeSDP:o}=r;o&&(i=!0),n.push(s)})),{mids:n,needExchangeSDP:i}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>n.attributes.mid&&e.indexOf(n.attributes.mid)!==-1));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((n=>{n.attributes.mid==="0"||It()||ww()?n.attributes.ssrcs=[]:(n.attributes.ssrcs=[],n.attributes.direction="inactive",n.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((n=>n.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((n=>n.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>X(e).call(e,n.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((n=>{n.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>X(e).call(e,n.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((n=>{n.attributes.direction="recvonly"}))}receive(e,t,n,i){e.forEach(((r,s)=>{this.createOrRecycleRecvMedia(r,[],"recvonly",t,n,i[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>e.indexOf(n.attributes.mid)!==-1));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((n=>{n.media.port="0",n.attributes.direction="inactive"})),this.updateBundleMids()}updateRemoteRTPCapabilities(e){const t=this.sessionDesc||Jn((n=this._isUseExtmapAllowMixed,this._isUseDataChannel?MH(n):`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(n?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var n;this._rtpCapabilities=e;let i=!1;const r=this.rtpCapabilities.send,s=this.localCapabilities.send,o=this.localCapabilities.recv,a=o.videoCodecs,c=o.audioCodecs,d=o.videoExtensions,l=o.audioExtensions;for(const R of t.mediaDescriptions){var u;if(R.attributes.direction!=="sendonly"||typeof R.attributes.mid!="string"||!X(u=this.useLocalCodecsMids).call(u,R.attributes.mid)){if(i=!0,R.attributes.iceUfrag=this._iceParameters.iceUfrag,R.attributes.icePwd=this._iceParameters.icePwd,R.attributes.fingerprints=this._dtlsParameters.fingerprints,R.attributes.candidates=this._candidates,R.attributes.setup=this.setup,R.media.mediaType==="application"&&(R.attributes.sctpPort="5000"),R.media.mediaType==="video")if(this._isUseLocalCodecs&&R.attributes.direction==="sendonly"){var h;R.media.fmts=a.map((y=>y.payloadType.toString(10))),R.attributes.payloads=a,R.attributes.extmaps=d;const T=R.attributes.mid;typeof T!="string"||X(h=this.useLocalCodecsMids).call(h,T)||this.useLocalCodecsMids.push(T)}else if(r.videoCodecs.length===0){const T=s.videoCodecs.filter((y=>{var I,A;return(I=y.rtpMap)===null||I===void 0?void 0:X(A=I.encodingName.toLowerCase()).call(A,"vp8")}));T.length===0&&T.push(s.videoCodecs[0]),R.media.fmts=T.map((y=>y.payloadType.toString(10))),R.attributes.payloads=T,R.attributes.extmaps=[]}else R.media.fmts=r.videoCodecs.map((T=>T.payloadType.toString(10))),R.attributes.payloads=r.videoCodecs,R.attributes.extmaps=r.videoExtensions;if(R.media.mediaType==="audio")if(this._isUseLocalCodecs&&R.attributes.direction==="sendonly"){var p;R.media.fmts=c.map((y=>y.payloadType.toString(10))),R.attributes.payloads=c,R.attributes.extmaps=l;const T=R.attributes.mid;typeof T!="string"||X(p=this.useLocalCodecsMids).call(p,T)||this.useLocalCodecsMids.push(T)}else if(r.audioCodecs.length===0){const T=s.audioCodecs.filter((y=>{var I,A;return(I=y.rtpMap)===null||I===void 0?void 0:X(A=I.encodingName.toLowerCase()).call(A,"opus")}))||[s.audioCodecs[0]];R.media.fmts=T.map((y=>y.payloadType.toString(10))),R.attributes.payloads=T,R.attributes.extmaps=[]}else R.media.fmts=r.audioCodecs.map((T=>T.payloadType.toString(10))),R.attributes.payloads=r.audioCodecs,R.attributes.extmaps=r.audioExtensions,Pc(R)}}return this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1,[this.sessionDesc,i]}updateCandidates(e){const t=this._originCandidates.filter((i=>i.transport==="udp")),n=[];if(t.forEach((i=>{n.push(Gg(Gg({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))})),t.length!==0){switch(e){case Sn.TCP_RELAY:this._candidates=n;break;case Sn.UDP_TCP_RELAY:case Sn.RELAY:this._candidates=[...t,...n];break;default:this._candidates=t}for(const i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}}restartICE(e){e=wt(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const i=n.media.mediaType===e&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(It()){if(i){const r=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(r||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!r||r!==n.attributes.mid)}return!1}return i}))}createOrRecycleDataChannel(){for(const n of this.sessionDesc.mediaDescriptions)if(n.media.mediaType==="application")return{mediaDesc:n,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:op,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,n,i,r,s){const o=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=nl(o,a,this.localCapabilities.send,o===ue.VIDEO?i:r),d=o===ue.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let u={media:{mediaType:o,port:op,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((p=>p.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};u=this.mungRecvMediaDsec(u,e,s);const h=this.findFirstClosedMedia(o);if(h){const p=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[p]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}updateRemoteDtlsParameters(e){const t=new Set(this._dtlsParameters.fingerprints.map((r=>r.fingerprint))),n=new Set(e.map((r=>r.fingerprint)));let i=!1;t.size!==n.size&&(i=!0);for(const r of t)n.has(r)||(i=!0);return i}updateRemoteCodec(e,t,n){const i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((u=>u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"")).filter((u=>{var h;return X(h=Object.keys(Qo)).call(h,u)})))],r=new Set(t);if(i.every((u=>r.has(u))))return _.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const s=this._rtpCapabilities.recv.videoCodecs.filter((u=>t.some((h=>{var p;return X(p=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"").call(p,h)}))));if(s.length===0)return _.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(t)),!1;const o=[...new Set(s.map((u=>u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"")))];let a;if(_.debug("updateRemoteCodec, from ".concat(i," to ").concat(o)),e.length===0)a=this.sessionDesc.mediaDescriptions.filter((u=>u.media.mediaType==="video"&&u.attributes.direction==="recvonly"));else if(a=this.sessionDesc.mediaDescriptions.filter((u=>u.attributes.mid&&u.media.mediaType==="video"&&X(e).call(e,u.attributes.mid)&&u.attributes.direction==="recvonly")),a.length!==e.length)return _.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;if(b("USE_PUB_RTX")||b("USE_SUB_RTX")){const u=uo(s,this.rtpCapabilities.recv.videoCodecs);s.push(...u)}this._rtpCapabilities.recv.videoCodecs=s;const c=this.localCapabilities.send,d=this.rtpCapabilities.recv,l=nl(ue.VIDEO,d,c,n);return a.forEach((u=>{const h=l.map((p=>p.payloadType.toString(10)));_.debug("updateRemoteCodec mid: ".concat(u.attributes.mid,", from"),u.attributes.payloads,"to",l),u.attributes.payloads=l,u.media.fmts=h})),_.debug("updateRemoteCodec success, mids: ".concat(e,", codecs: ").concat(t,", remote recv: ").concat(this._rtpCapabilities.recv.videoCodecs.length,", remote send: ").concat(this._rtpCapabilities.send.videoCodecs.length)),!0}createOrRecycleSendMedia(e,t,n,i,r){const s=this.rtpCapabilities.send.videoCodecs,o=this._isUseLocalCodecs||s.length===0?this.localCapabilities.recv:this.rtpCapabilities.send,a=e===ue.VIDEO?o.videoCodecs:o.audioCodecs,c=e===ue.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let l={media:{mediaType:e,port:op,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((h=>h.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungSendMediaDesc(l,r);const u=this.findFirstClosedMedia(e);if(u){const h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>e.media.port!=="0")).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,n){const i=wt(e);return Ag(i),ca(i,t),Og(i,t),oN(i),$h(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=wt(e);return n.attributes&&n.attributes.payloads&&Array.isArray(n.attributes.payloads)&&n.attributes.payloads.length>0&&n.attributes.payloads.forEach((i=>{i.rtpMap&&i.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&b("ENABLE_DOWN_SPS_PPS")&&(i.fmtp&&i.fmtp.parameters||(i.fmtp={parameters:{}}),i.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")})),$h(n,t,this.localCapabilities.recv),Pc(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((i=>i.attributes.mid===e));if(n!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=i}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>It()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0"))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return((n=t.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return(t=this.sessionDesc.mediaDescriptions.find((n=>n.attributes.mid===e)))===null||t===void 0?void 0:t.attributes.ssrcs}};function LN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function xs(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?LN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):LN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}var xc=(function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e})(xc||{});const cp=new Map;function kN(e,t,n,i){let{scale:r}=e;if(r===0&&i===xc.UP||r>=t.length-1&&i===xc.DOWN)return e;let s=xs(xs({},e),{},{scale:i===xc.DOWN?++r:--r});switch(n){case"maintain-framerate":s=xs(xs({},s),t[r].motion);break;case"maintain-resolution":s=xs(xs({},s),t[r].detail);break;case"balanced":s=xs(xs({},s),t[r].balanced)}return s}function xN(e,t){if(t){const n={overUse:0,underUse:0,adaptationList:MN(t)};cp.set(e,n)}else cp.delete(e)}function MN(e){const t=xs({},e),{bitrateMax:n,frameRate:i,scaleResolutionDownBy:r,bitrateMin:s}=t,{MIN_FRAME_RATE:o,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:u,BWE_SCALE_DOWN_THRESHOLD:h,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:R,BALANCE_BITRATE_FACTOR:T,BALANCE_FRAMERATE_FACTOR:y,BALANCE_RESOLUTION_FACTOR:I,MOTION_RESOLUTION_FACTOR:A,MOTION_BITRATE_FACTOR:N,DETAIL_FRAMERATE_FACTOR:k,DETAIL_BITRATE_FACTOR:x}=UE,P=Math.min(t.frameRate,a),M=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(h,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(p,1)*P),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:s},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:s},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:s}}];for(let G=1;G<=c;G++){const Y={bwe_up:Math.round(Math.pow(u,G)*n),bwe_down:Math.round(Math.pow(h,G+1)*n),fps_up:Math.round(Math.pow(R,G)*P),fps_down:Math.round(Math.pow(p,G+1)*P)},de={scaleResolutionDownBy:r/Math.pow(I,G),frameRate:Math.max(Math.round(Math.pow(y,G)*i),o),bitrateMax:Math.max(Math.round(Math.pow(T,G)*n),l),bitrateMin:Math.max(Math.round(Math.pow(T,G)*s),d)},Ie={scaleResolutionDownBy:r/Math.pow(A,G),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(N,G)*n),l),bitrateMin:Math.max(Math.round(Math.pow(N,G)*s),d)},Ce={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(k,G)*i),o),bitrateMax:Math.max(Math.round(Math.pow(x,G)*n),l),bitrateMin:Math.max(Math.round(Math.pow(x,G)*s),d)};M.push({scale:G,threshold:Y,balanced:de,motion:Ie,detail:Ce})}return M}function UH(e,t,n,i,r,s){const o=cp.get(e)||{overUse:0,underUse:0,adaptationList:MN(r)},{adaptationList:a}=o;cp.set(e,o);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=UE,{scale:l}=i;let u,h;return typeof t=="number"&&t>0&&(function(p,R,T,y){if(R>=T.length)return!1;let{threshold:{fps_down:I}}=T[R];return b("FORCE_AG_HIGH_FRAMERATE")&&y==="maintain-framerate"&&(I=T[0].threshold.fps_down),p<I})(t,l,a,s)&&(o.overUse++,h=pc.CPU,o.overUse>c)||typeof n=="number"&&n>0&&(function(p,R,T){if(R>=T.length)return!1;const{threshold:{bwe_down:y}}=T[R];return p<y})(n,l,a)&&(o.overUse++,h=pc.BANDWIDTH,o.overUse>c)?(o.overUse=0,o.underUse=0,u=kN(i,a,s,xc.DOWN),[u,h]):(typeof t=="number"&&t>0&&typeof n=="number"&&n>0&&(function(p,R,T,y){if(R===0)return;let{threshold:{fps_up:I}}=T[R];return b("FORCE_AG_HIGH_FRAMERATE")&&y==="maintain-framerate"&&(I=T[1].threshold.fps_up),p>I})(t,l,a,s)&&(function(p,R,T){if(R===0)return;const{threshold:{bwe_up:y}}=T[R];return p>y})(n,l,a)&&(o.underUse++,o.underUse>d&&(o.overUse=0,o.underUse=0,u=kN(i,a,s,xc.UP),u.scale===0&&(h=pc.NONE))),[u,h])}function UN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Kg(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?UN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):UN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function VN(e){var t;return!!b("ENABLE_AG_ADAPTATION")&&!!(e instanceof Ph||X(t=e._hints).call(t,ct.CUSTOM_TRACK))&&(!!b("FORCE_SUPPORT_AG_ADAPTATION")||!!(bw(14,0,!1)&&Iw(17,4,!0)||Cw(14)&&EE(17,4,!0)))}const dp=new Map;function jN(e,t,n,i,r,s){if(Mc(e,n),r(t),i!=="balanced"&&i!=="maintain-framerate"&&i!=="maintain-resolution")return;let o=-1;xN(e,t);const a=window.setInterval((()=>{const d=dp.get(e);if(!b("ENABLE_AG_ADAPTATION")||!d)return Mc(e,n),void r(t);const l=s();if(l.sendPackets>0&&l.OutgoingAvailableBandwidth>0){if(o===-1)return void(o=Date.now());if(Date.now()-o<1e3)return;const u=l.sendFrameRate,h=l.OutgoingAvailableBandwidth,[p,R]=UH(e,u,h,d.adaptationConfig,t,i);R&&(n.qualityLimitationReason=R),p&&d.adaptationConfig.scale!==p.scale&&(_.debug("[".concat(e,"] applyAdaptation: ").concat(n.qualityLimitationReason,`
           sendFps `).concat(u,", bwe ").concat(h,", switch from ").concat(d.adaptationConfig.scale," to ").concat(p.scale," ")),d.adaptationConfig=Kg(Kg({},d.adaptationConfig),p),r(p))}}),b("CHECK_LOCAL_STATS_INTERVAL")),c=Kg({},t);dp.set(e,{timer:a,adaptationConfig:c,originConfig:t,adaptationFunc:r}),_.debug("[".concat(e,"] start adaptation, originConfig: ").concat(JSON.stringify(t),", degradationPreference: ").concat(i))}function Mc(e,t){const n=dp.get(e);if(n){const{timer:i}=n;window.clearTimeout(i),dp.delete(e)}t.qualityLimitationReason=pc.NONE,xN(e)}function VH(e,t){var n;let i;switch(t){case J.LocalAudioTrack:i=pt.Audio;break;case J.LocalVideoTrack:i=X(n=e._hints).call(n,ct.SCREEN_TRACK)?pt.Screen:pt.High;break;case J.LocalVideoLowTrack:i=pt.Low}return i}function Yg(e){const t=We();if(e.some((n=>n._bypassWebAudio)))throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function zg(e,t){Yg(e);const n=new sn;return e.forEach((i=>n.addAudioTrack(i))),n}const jH=!We().supportUnifiedPlan||b("CHROME_FORCE_PLAN_B")&&is();function ol(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(e.useDcSignal)return n={spec:t,store:e},Ur("DataChannelConnection").create(n);var n;return jH?(function(r){return Ur("PlanBConnection").create(r)})({spec:t,store:e}):new Ui(t,e)}function qg(e){return e&&(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")}function Xg(e){try{if(e.iceServers)return!1;if(e.turnServer&&e.turnServer.mode!=="off"){if(Ho(e.turnServer.servers))return!1;if(b("FORCE_TURN_TCP")||e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).some((t=>t.forceturn)))return!0}return!1}catch{return!1}}var qe;function FN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function jr(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?FN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):FN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let Ui=(qe=class Ca extends zh{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var n;return X(n=Object.keys(Qo)).call(n,t)})))]}constructor(t,n){super(t,n),v(this,"id",ut(5,"connection-")),v(this,"store",void 0),v(this,"peerConnection",void 0),v(this,"forceTurn",!1),v(this,"remoteSDP",void 0),v(this,"initialOffer",void 0),v(this,"transportEventReceiver",void 0),v(this,"statsFilter",void 0),v(this,"extension",{useXR:b("USE_XR")}),v(this,"localCapabilities",void 0),v(this,"remoteCodecs",void 0),v(this,"localCandidateCount",0),v(this,"allCandidatesReceived",!1),v(this,"isPreallocation",!1),v(this,"isPreRender",!1),v(this,"preMediaMap",new Map),v(this,"dataStreamChannelMap",new Map),v(this,"establishPromise",void 0),v(this,"recoveredDataChannelIds",[]),v(this,"currentDataChannelId",1),v(this,"supportAV1RtpSpec",!1),v(this,"mutex",void 0),v(this,"qualityLimitationReason",pc.NONE),v(this,"isFirstConnected",!1),this.store=n,this.forceTurn=Xg(t),this.mutex=new gn("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Ca.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=yh(this.peerConnection,b("STATS_UPDATE_INTERVAL"),void 0,It()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void _.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else _.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=ds(n.sdp),r=await Dg({filterRTX:!b("USE_PUB_RTX")&&!b("USE_SUB_RTX"),filterVideoFec:b("FILTER_VIDEO_FEC"),filterAudioFec:b("FILTER_AUDIO_FEC"),filterVideoCodec:b("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:b("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:b("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=tl(r),this.initialOffer=n,b("ENABLE_SVC")&&this.store.codec=="av1"){const o=await aN();var t;o&&(this.supportAV1RtpSpec=!0,(t=r.send)===null||t===void 0||t.videoExtensions.push(o))}let s;return n.sdp&&ep(n.sdp)&&(s=wt(r),$O(s)),jr(jr({},i),{},{rtpCapabilities:s||r,offerSDP:n.sdp})}catch(n){throw new F(w.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&ep(this.initialOffer.sdp)&&eN(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new PN(jr(jr({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!b("ENABLE_PRE_SUB_WITH_PRE_PC")||!b("PRE_USE_LOCAL_CODECS"))&&Yd(this.store)),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),i=Pg(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r?.(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const s=this.peerConnection.getTransceivers()[0];if(s!=null&&s.receiver&&this.tryBindTransportEvents(s.receiver),Yd(this.store))if(t.preallocation&&b("ENABLE_PRE_SUB_WITH_PRE_PC")){const o=b("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(o);await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{const{preSSRCs:o=[]}=t,a=o.map((d=>d.ssrcMsg[0].ssrcId));if(o.length===0)return;const{mids:c}=this.remoteSDP.batchSend(o.map((d=>Object.assign({},d))));await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}presetMedia(t,n){t.forEach(((i,r)=>{this.peerConnection.getTransceivers().forEach((s=>{if(s.mid!=null&&i===s.mid&&s.receiver.track){const o=s.receiver.track;let a;o.kind==="video"&&b("ENABLE_PRE_RENDER")&&(a=new Dh({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(ut(5,""))},!0),a.updateVideoTrack(o),a.onFirstVideoFrameRender=()=>{var c;const d=this.preMediaMap.get(n[r]);d&&(d.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,n[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,n[r])},a.play(this.store.sessionId||void 0),this.isPreRender=!0),this.preMediaMap.set(n[r],{mid:i,track:o,player:a,transceiver:s})}})),this.store.peerReceiver()}))}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let n=!1;const{rtpCapabilities:i}=t;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const o=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||o}const{preSSRCs:r=[]}=t,s=r.map((o=>o.ssrcMsg[0].ssrcId));if(!this.remoteSDP.checkPreloadSsrcs(s)){const o=[],a=[];if(Array.from(this.preMediaMap.entries()).every((c=>{let[d,{mid:l,player:u,track:h}]=c;return o.push(l),a.push(d),this.preMediaMap.delete(d),u&&u.destroy(),!0})),o.length>0&&(this.remoteSDP.stopSending(o),await pi(this.peerConnection,this.remoteSDP,this.extension),_.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),pe.reportApiInvoke(this.store.sessionId,{name:Nt.PRELOAD_MEDIA_FAILED,options:[r,a],tag:Tt.TRACER}).onSuccess()),r.length>0){const{mids:c}=this.remoteSDP.batchSend(r.map((d=>Object.assign({},d))));await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(c,s)}}n?(await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):_.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(n.toString()))}}send(t,n,i){var r=this;return ni((function*(){const s=yield Ve(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=Zd();t.forEach((y=>{const I=r.peerConnection.addTransceiver(y._mediaStreamTrack,jr({direction:"sendonly"},y.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));o.push(I),y._updateRtpTransceiver(I)})),It()&&b("SIMULCAST")===!0&&(yield Ve(r.applySimulcastForFirefox(o,t)));const c=yield Ve(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(t.length),l=r.mungSendOfferSDP(c.sdp,t,d),u=Jn(l),h=d.map((y=>{const I=u.mediaDescriptions.find((A=>A.attributes.mid===y));if(!I)throw new Error("Cannot extract ssrc from mediaDescription.");return wg(I,b("USE_PUB_RTX"))}));let p;try{p=yield h}catch(y){p=[],r.remoteSDP.receive(t,n,i,p);const I=r.remoteSDP.toString();throw yield Ve(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ve(r.peerConnection.setRemoteDescription({type:"answer",sdp:I})),yield Ve(r.stopSending(d,!0)),y}r.remoteSDP.receive(t,n,i,p);const R=r.remoteSDP.toString(),T=r.logSDPExchange(l,"offer","local","send");return yield Ve(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ve(r.applySimulcastEncodings(o,t)),yield Ve(r.applySendEncodings(o,t)),T?.(R),yield Ve(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),o.map(((y,I)=>{const A=d[I];return{localSSRC:h[I],id:A,transceiver:y}}))}catch(o){throw o instanceof F?o:new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}}))()}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);if(i&&i.readyState==="open")_.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const s=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof s!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:b("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)}n.forEach((s=>{s._updateOriginDataChannel(i)}));const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),_.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else _.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof F?i:new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(t){try{const n=this.dataStreamChannelMap.get(t);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(t)}catch(n){throw n instanceof F?n:new F(w.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(t,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter((c=>t.indexOf(c.mid)!==-1));if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map((c=>{var d;Mc(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)}));const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,n,i,r);o&&(await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP.")));const a=this.peerConnection.getTransceivers().find((c=>c.mid===s));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:s,transceiver:a}}catch(s){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(t);return i&&(await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),n.map((r=>{const s=this.peerConnection.getTransceivers().find((o=>o.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}}))}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");t.forEach((s=>{Array.from(this.preMediaMap.entries()).some((o=>{let[a,{mid:c,player:d}]=o;if(c===s)return this.preMediaMap.delete(a),d&&d.destroy(),!0}))})),this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((o=>{o.direction="inactive"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((async(o,a)=>{o.direction="sendonly"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return ni((function*(){const i=yield Ve(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=We().supportPCSetConfiguration,s=b("FORCE_TURN_TCP")||n.forceTurn;if(t===Sn.RELAY&&!r)return;if(r&&!s){const u=t===Sn.RELAY?"relay":"all",h=n.peerConnection.getConfiguration();h.iceTransportPolicy!==u&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(h.iceTransportPolicy,"] to [").concat(u,"]")),h.iceTransportPolicy=u,n.peerConnection.setConfiguration(h))}n.remoteSDP.updateCandidates(t);const o=yield Ve(n.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=ds(o.sdp),{remoteIceParameters:c}=yield a.iceParameters;n.remoteSDP.restartICE(c);const d=n.remoteSDP.toString(),l=n.logSDPExchange(o.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield Ve(n.peerConnection.setLocalDescription(o)),l?.(d),yield Ve(n.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}}))()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(Sn.TCP_RELAY),await pi(this.peerConnection,this.remoteSDP,this.extension)}catch(n){_.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach((n=>{Mc(this.id+n.mid,this)})),this.preMediaMap.forEach((n=>{let{player:i}=n;i&&i.destroy()})),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return jr(jr({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new F(w.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getTransceivers().filter((r=>r.mid===t));i.length===1&&(this.isVP8Simulcast(n)?It()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getTransceivers().find((r=>r.mid===n));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:jr(jr({},lr),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:jr(jr({},lr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var n;const i="code: ".concat(t.errorCode,", message: ").concat(t.errorText),r=t.port?"local: ".concat(t.port):"",s=cs(t.url||"");_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(i,"), url: ").concat(s||"",", host_candidate:").concat(r)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),b("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]},i=t.cloudProxyServer||"disabled";return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&(Ho(t.turnServer.servers)?n.iceServers=t.turnServer.servers:b("NEW_TURN_MODE")&&n.iceServers&&i==="disabled"?(b("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&n.iceServers.push(...Ca.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):n.iceServers.push(...Ca.newTurnServerConfigToIceServers(t.turnServer.servers)),b("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...Ca.turnServerConfigToIceServers(t.turnServer.servers)),b("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...Ca.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),b("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((r=>{r.forceturn&&(n.iceTransportPolicy="relay")})))),b("ENABLE_ENCODED_TRANSFORM")&&We().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(fr(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!b("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}static newTurnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{const r=b("NEW_TURN_MODE");r===1?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(fr(i.turnServerURL),":443?transport=tcp")}):r===4&&(n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(fr(i.turnServerURL),":443?transport=tcp")}))})),n}tryBindTransportEvents(t){const n=t.transport;if(n){this.transportEventReceiver=t,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in r?r.error:r)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const r=n?.iceTransport.state;var s;r&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:s}=i.getSelectedCandidatePair()||{};if(r&&s){const o=r.address+":"+r.port,a=s.address+":"+s.port;_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(cs(o)),", remote ").concat(JSON.stringify(cs(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i,r;if(n||(n=this.peerConnection.getSenders().find((y=>y.track===t._mediaStreamTrack))),!n)return _.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!We().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const a=QO(this.peerConnection,t._mediaStreamTrack),c=FA(t);if(VN(t)&&a&&n&&c&&this.getLocalVideoStats&&X(i=["vp8","vp9"]).call(i,this.store.codec)){var d;const T=s.degradationPreference||(X(d=t._hints).call(d,ct.CUSTOM_TRACK)?b("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");jN(this.id+a.mid,c,this,T,(y=>{n&&this.updateAdaptation(n,y)}),this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var l;const{bitrateMax:T,frameRate:y,scaleResolutionDownBy:I}=t._encoderConfig;T&&(o.maxBitrate=1e3*T),(X(l=t._hints).call(l,ct.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(y&&(o.maxFramerate=ai(y)),I&&I>=1&&(o.scaleResolutionDownBy=I))}const{maxFramerate:u}=b("ENCODER_CONFIG_LIMIT");if(u&&typeof u=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,u):u),b("DSCP_TYPE")&&is()){var h;const T=b("DSCP_TYPE");X(h=["very-low","low","medium","high"]).call(h,T)&&(o.networkPriority=T)}const p=n.getParameters(),R=(r=p.encodings)===null||r===void 0?void 0:r[0];It()&&!R&&(s.encodings=[o]),R&&Object.assign(R,o),Object.assign(p,s),_.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(p.encodings))),await n.setParameters(p),await lN(this.store.codec,n,b("SVC_MODE"))}async updateAdaptation(t,n){var i,r;if(!t)return _.debug("[updateAdaptation] no rtpSender found");if(!We().supportSetRtpSenderParameters)return _.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:o,frameRate:a,scaleResolutionDownBy:c}=n;o&&(s.maxBitrate=1e3*o),a&&(s.maxFramerate=ai(a)),c&&c>=1&&X(i=["vp8","vp9"]).call(i,this.store.codec)&&(s.scaleResolutionDownBy=c);const d=t.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,s),Object.assign(d,{});try{await t.setParameters(d),_.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(u){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?_.debug("[updateAdaptation] peerConnection not connected}"):_.debug("[updateAdaptation] updateRtpSenderEncodings failed",u):_.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,n){try{if(!We().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=n[i];s instanceof yt&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,i){if(b("FORBID_MODIFY_LOCAL_OFFER_SDP"))return t;const r=Jn(t);return n.forEach(((s,o)=>{const a=i[o],c=r.mediaDescriptions.find((d=>d.attributes.mid===a));c&&(ca(c,s),Ng(c,s,this.store.codec))})),Ds(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let c=0;c<t.length;c++){var i,r,s,o,a;const d=t[c],l=n[c];if(l instanceof yt&&!X(i=l._hints).call(i,ct.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=l._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];const p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u))}}}async applySimulcastEncodings(t,n){if(!It()&&t.length===n.length)for(let i=0;i<t.length;i++){const r=n[i];if(r instanceof yt&&this.isVP8Simulcast(r)){const s=t[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var n,i,r,s,o;return!!(t instanceof yt&&b("SIMULCAST")&&this.store.codec==="vp8"&&!X(n=t._hints).call(n,ct.LOW_STREAM)&&(i=t._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,r){if(b("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),t),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(t){if(We().supportPCSetConfiguration){const n=Ca.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}t.isPreallocation&&(this.isPreallocation=!0)}},re(qe.prototype,"updateRemoteRTPCapabilities",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"updateRemoteRTPCapabilities"),qe.prototype),re(qe.prototype,"connect",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"connect"),qe.prototype),re(qe.prototype,"updateRemoteConnect",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"updateRemoteConnect"),qe.prototype),re(qe.prototype,"createDataChannels",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"createDataChannels"),qe.prototype),re(qe.prototype,"receive",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"receive"),qe.prototype),re(qe.prototype,"batchReceive",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"batchReceive"),qe.prototype),re(qe.prototype,"stopReceiving",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"stopReceiving"),qe.prototype),re(qe.prototype,"muteRemote",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"muteRemote"),qe.prototype),re(qe.prototype,"unmuteRemote",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"unmuteRemote"),qe.prototype),re(qe.prototype,"muteLocal",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"muteLocal"),qe.prototype),re(qe.prototype,"unmuteLocal",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"unmuteLocal"),qe.prototype),re(qe.prototype,"close",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"close"),qe.prototype),re(qe.prototype,"updateEncoderConfig",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"updateEncoderConfig"),qe.prototype),re(qe.prototype,"updateSendParameters",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"updateSendParameters"),qe.prototype),re(qe.prototype,"replaceTrack",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"replaceTrack"),qe.prototype),re(qe.prototype,"updateAdaptation",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"updateAdaptation"),qe.prototype),re(qe.prototype,"getRemoteSSRC",[ci],Object.getOwnPropertyDescriptor(qe.prototype,"getRemoteSSRC"),qe.prototype),qe);function ci(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}function Jg(e,t){let n=document.createElement("video"),i=document.createElement("canvas");n.setAttribute("style","display:none"),i.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),i.width=ai(t.width),i.height=ai(t.height);const r=ai(t.framerate||15);document.body.append(n),document.body.append(i);let s=e._mediaStreamTrack;n.srcObject=new MediaStream([s]),n.play().catch(Wd);const o=i.getContext("2d");if(!o)throw new V(w.UNEXPECTED_ERROR,"can not get canvas context");const a=We(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!n)return i.stopCapture&&i.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const l=n.videoWidth,u=n.videoHeight/l,h=i.width*u;Math.abs(h-i.height)>=2&&(_.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(h)),i.height=h)}o.drawImage(n,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),s!==e._mediaStreamTrack&&(s=e._mediaStreamTrack,n.srcObject=new MediaStream([s]))},i.stopCapture=JE((()=>i.startCapture&&i.startCapture()),r);const d=c.stop;return c.stop=()=>{d.call(c),n&&(n.remove(),n.srcObject=null,n=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),_.debug("clean low stream renderer")},c}var BN=(function(e){return e[e.Video_Send_Type=190]="Video_Send_Type",e})(BN||{}),Fr=(function(e){return e[e.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",e[e.Video_Send_Freeze=2082]="Video_Send_Freeze",e[e.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",e[e.Video_Recv_Freeze=2084]="Video_Recv_Freeze",e[e.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",e[e.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",e[e.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",e[e.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",e})(Fr||{}),De=(function(e){return e[e.Video_Send_Retransmit=2062]="Video_Send_Retransmit",e[e.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",e[e.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",e[e.Video_Send_Transmit=2066]="Video_Send_Transmit",e[e.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",e[e.Video_Capture_Height=2033]="Video_Capture_Height",e[e.Video_Capture_Width=2035]="Video_Capture_Width",e[e.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",e[e.Video_Send_Low_Height=2073]="Video_Send_Low_Height",e[e.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",e[e.Video_Send_Low_Width=2077]="Video_Send_Low_Width",e[e.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",e[e.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",e[e.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",e[e.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",e[e.Video_Send_Width=2003]="Video_Send_Width",e[e.Video_Send_Height=2004]="Video_Send_Height",e[e.Video_Send_Disabled=2095]="Video_Send_Disabled",e[e.Video_Send_Adaptation=2032]="Video_Send_Adaptation",e[e.Video_Send_Player_Status=2128]="Video_Send_Player_Status",e[e.Video_Send_Nacks=2009]="Video_Send_Nacks",e[e.Video_Send_Plis=2010]="Video_Send_Plis",e[e.Video_Send_Firs=2011]="Video_Send_Firs",e[e.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",e[e.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",e[e.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",e[e.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",e[e.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",e[e.Video_Send_Bitrate=2012]="Video_Send_Bitrate",e[e.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",e[e.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",e[e.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",e[e.Audio_Send_Level=2038]="Audio_Send_Level",e[e.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",e[e.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",e[e.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",e[e.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",e[e.Audio_Send_Freeze=2081]="Audio_Send_Freeze",e[e.Audio_Send_Disabled=2096]="Audio_Send_Disabled",e[e.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",e[e.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",e[e.Video_Recv_Height=2019]="Video_Recv_Height",e[e.Video_Recv_Width=2018]="Video_Recv_Width",e[e.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",e[e.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",e[e.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",e[e.Video_Recv_Nacks=2026]="Video_Recv_Nacks",e[e.Video_Recv_Plis=2027]="Video_Recv_Plis",e[e.Video_Recv_Firs=2028]="Video_Recv_Firs",e[e.Video_Recv_Disabled=2101]="Video_Recv_Disabled",e[e.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",e[e.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",e[e.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",e[e.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",e[e.Audio_Render_Level=2043]="Audio_Render_Level",e[e.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",e[e.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",e[e.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",e[e.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",e[e.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",e[e.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",e[e.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",e[e.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",e[e.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",e[e.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",e[e.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",e[e.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",e})(De||{}),fn=(function(e){return e[e.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",e[e.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",e[e.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",e[e.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",e[e.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",e[e.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",e[e.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",e[e.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",e[e.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",e[e.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",e[e.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",e[e.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",e[e.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",e[e.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",e[e.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",e[e.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",e[e.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",e[e.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",e[e.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",e[e.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",e[e.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",e[e.Audio_Recv_AV_Sync_TIME=2237]="Audio_Recv_AV_Sync_TIME",e})(fn||{}),wn=(function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e[e.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",e})(wn||{}),Uc=(function(e){return e[e.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",e[e.PAGE_VISIBILITY=2233]="PAGE_VISIBILITY",e})(Uc||{}),Qg=(function(e){return e[e.Transport_Send_Bitrate=2234]="Transport_Send_Bitrate",e[e.Transport_Recv_Bitrate=2235]="Transport_Recv_Bitrate",e})(Qg||{});const la=1e3,lp=6,al=3,FH=Math.max(lp,al,60);function Re(e,t,n){n!=null&&Number.isFinite(n)&&(e[t]=Math.round(Math.max(0,n)))}function WN(e){const t={[wn.CONN_TYPE]:0,[wn.RTT]:e.rtt,[wn.STATS_UPDATE_INTERVAL]:e.updateInterval?Math.round(Math.max(0,e.updateInterval)):void 0};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=e.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(t[wn.CONN_TYPE]=1),n==="tcp"&&(t[wn.CONN_TYPE]=3),n==="tls"&&(t[wn.CONN_TYPE]=4);break}case"srflx":t[wn.CONN_TYPE]=2;break;case"unknown":t[wn.CONN_TYPE]=5;break;default:t[wn.CONN_TYPE]=0}return t}function GN(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class HN extends kt{constructor(t){super(),v(this,"store",void 0),v(this,"uploadWRTCStatsTimer",void 0),v(this,"uploadOutboundDenoiserStatsTimer",void 0),v(this,"uploadExtStatsTimer",void 0),v(this,"uploadExtUsageStatsTimer",void 0),v(this,"uploadInboundExtStatsTimer",void 0),v(this,"requestStats",void 0),v(this,"requestTransportStats",void 0),v(this,"requestLocalMedia",void 0),v(this,"requestRemoteMedia",void 0),v(this,"requestAllTracks",void 0),v(this,"requestVideoIsReady",void 0),v(this,"requestUploadStats",void 0),v(this,"requestUpload",void 0),v(this,"uploadOutboundStarted",!1),v(this,"uploadInboundStarted",!1),v(this,"uploadTransportStarted",!1),v(this,"uploadBaseStatsStarted",!1),v(this,"uploadExtensionUsageStarted",!1),v(this,"lastRecvStats",void 0),v(this,"lastSendStats",void 0),v(this,"lastRefRecvStats",void 0),v(this,"lastRefSendStats",void 0),v(this,"lastNormalRecvStats",void 0),v(this,"lastNormalSendStats",void 0),v(this,"lastExtendStats",{}),v(this,"needUploadStats",{}),v(this,"needUploadRenderFreezeTime",!0),v(this,"lastUploadCompensateTime",-1),v(this,"uploadCompensateDeltaTime",0),this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;const n=t%al==0,i=t%lp==0,r=t%60==0;let s,o;if(this.uploadTransportStarted&&(s=this.requestStats(),this.store.useP2P&&(o=this.requestStats(!0))),!s&&this.uploadOutboundStarted&&(s=this.requestStats()),!o&&this.uploadInboundStarted&&(o=this.requestStats(!0)),s||o){var a;const c={};if(this.uploadTransportStarted&&s){const l=this.getTransportStats(s,n?this.lastRefSendStats:void 0,o,n);l&&(c.misc=[l])}if(this.uploadOutboundStarted&&s){const l=this.getOutboundStats(s,i?this.lastNormalSendStats:void 0,n?this.lastRefSendStats:void 0,this.lastSendStats,r);l&&(c.outbound=[l])}if(this.uploadInboundStarted&&o){this.uploadCompensateStats(t);const l=this.getInboundStats(o,i?this.lastNormalRecvStats:void 0,n?this.lastRefRecvStats:void 0,this.lastRecvStats);l&&(c.inbound=l)}const d=(a=this.requestTransportStats)===null||a===void 0?void 0:a.call(this).connectState;if(d&&(Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[Uc.RTC_PEER_CONNECTION_STATE]=kE[d]):c.misc=[{addition:{[Uc.RTC_PEER_CONNECTION_STATE]:kE[d]}}]),Ri.needUploadStats.length>0||i){const l=Ri.needUploadStats.shift()||(Ri.visibility==="visible"?1:0);Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[Uc.PAGE_VISIBILITY]=l):c.misc=[{addition:{[Uc.PAGE_VISIBILITY]:l}}]}this.needUploadStats.sendType&&(Array.isArray(c.outbound)&&c.outbound[0]&&c.outbound[0].high&&(c.outbound[0].high[BN.Video_Send_Type]=this.needUploadStats.sendType),this.needUploadStats.sendType=void 0),this.requestUploadStats(c)}this.lastRecvStats=o,this.lastSendStats=s,i&&(this.lastNormalRecvStats=o,this.lastNormalSendStats=s),n&&(this.lastRefRecvStats=o,this.lastRefSendStats=s)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0,Ri.startCollectStats();let t=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var n,i;const r=(n=this.requestTransportStats)===null||n===void 0?void 0:n.call(this);return void(r&&((i=this.requestUploadStats)===null||i===void 0||i.call(this,{misc:[{addition:{[Uc.RTC_PEER_CONNECTION_STATE]:kE[r.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(t),++t===FH+1&&(t=1)}),la)}uploadCompensateStats(t){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const n=t%al==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!n)return;if(this.lastUploadCompensateTime===-1)return void(this.lastUploadCompensateTime=Date.now());const i=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=i,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;const r=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*r;const s=this.requestStats(!0);new Array(r).fill(0).forEach((()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const o={};if(this.uploadInboundStarted&&s){const a=this.requestRemoteMedia()||[],c=[];a.forEach((d=>{let[l,u]=d;const h={peer:l.uid};if(l._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(l._videoSSRC)&&u.has(ue.VIDEO)&&l.videoTrack){const p=(function(R,T,y){if(!T.videoRecv.find((A=>A.ssrc===R)))return;const I={};if(y&&y._player){const A=y._player,{renderFreezeAccTime2:N,videoElementStatus:k}=A;if(Ri.visibility==="visible"&&k===Ln.PLAYING&&We().supportRequestVideoFrameCallback){const x=Math.min(6e3,N);A.renderFreezeAccTime2=Math.max(0,N-x),Re(I,Fr.Video_Render_Freeze_Time_Render2,x),b("USE_NEW_RENDER_FREEZE_TIME")&&Re(I,Fr.Video_Render_Freeze_Time_Render,x)}}return I})(l._videoSSRC,s,l.videoTrack);p&&(h.video=p)}h.video&&c.push(h)})),c.length>0&&(o.inbound=c,this.requestUploadStats(o))}}))}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(t,n,i,r){if(!this.requestStats)return;if(!r)return t.rtt==null?void 0:{addition:{[wn.RTT]:t.rtt,[wn.CONN_TYPE]:void 0,[wn.STATS_UPDATE_INTERVAL]:t.updateInterval||void 0}};const s=WN(t);if(this.store.useP2P){if(i){const o=WN(i);s[wn.CONN_TYPE]&&o[wn.CONN_TYPE]&&(s[wn.CONN_TYPE]+=o[wn.CONN_TYPE]<<3)}s[wn.CONN_TYPE]?s[wn.CONN_TYPE]+=110:s[wn.CONN_TYPE]=110}else{s[wn.CONN_TYPE]?s[wn.CONN_TYPE]+=100:s[wn.CONN_TYPE]=100;const o=(function(a,c){return c?[Math.ceil(8*(a.transport.bytesSent-c.transport.bytesSent)/(a.timestamp-c.timestamp)),Math.ceil(8*(a.transport.bytesReceived-c.transport.bytesReceived)/(a.timestamp-c.timestamp))]:[0,0]})(t,n);s[Qg.Transport_Send_Bitrate]=o[0],s[Qg.Transport_Recv_Bitrate]=o[1]}return{addition:s}}getOutboundStats(t,n,i,r,s){if(!this.requestUploadStats||!this.requestLocalMedia)return;const o=this.requestLocalMedia();if(!o||o.length===0)return;let a,c,d;return o.forEach((l=>{let[u,{track:h,ssrcs:p}]=l;switch(u){case J.LocalVideoLowTrack:case J.LocalVideoTrack:if(u===J.LocalVideoTrack){var R;const T=(function(N,k,x,P,M,G){const Y=k.videoSend.find((Ue=>Ue.ssrc===N));if(!Y)return;const de={},{sentFrame:Ie,inputFrame:Ce}=Y;if(P&&(Re(de,Fr.Video_Send_Qp_Sum,Y.qpSumPerFrame),Ce&&Ie)){const Ue=Ce.frameRate,Pe=Ie.frameRate;de[Fr.Video_Send_Freeze]=(function(nt,Pt){let H=!0;return H=!(nt<=5)&&(nt<=10?Pt<3:nt<=20?Pt<4:Pt<5),H})(Ue,Pe)?1:0}if(M){switch(Ie&&(Re(de,De.Video_Send_Height,Ie.height),Re(de,De.Video_Send_Width,Ie.width),Re(de,De.Video_Send_Frame_Rate,Ie.frameRate)),de[De.Video_Send_Disabled]=x._originMediaStreamTrack&&!x._originMediaStreamTrack.enabled||x._mediaStreamTrack&&!x._mediaStreamTrack.enabled?1:0,Y.adaptionChangeReason){case"none":de[De.Video_Send_Adaptation]=0;break;case"cpu":de[De.Video_Send_Adaptation]=1;break;case"bandwidth":de[De.Video_Send_Adaptation]=2;break;case"other":de[De.Video_Send_Adaptation]=3}let Ue=0;Y.adaptionChangeReason&&(Ue+=GN(Y.adaptionChangeReason)),k.qualityLimitationReason&&(Ue+=GN(k.qualityLimitationReason)<<3),de[De.Video_Send_Adaptation]=Ue,de[De.Video_Send_Player_Status]=zE[x._player?x._player.videoElementStatus:"uninit"],Re(de,De.Video_Send_Nacks,Y.nacksCount),Re(de,De.Video_Send_Plis,Y.plisCount),Re(de,De.Video_Send_Firs,Y.firsCount),Re(de,De.Video_Send_Avg_Encode,Y.avgEncodeMs),Re(de,De.Video_Send_Huge_Frame_Sent,Y.hugeFramesSent),Re(de,De.Video_Send_Bytes_Retransmit,Y.retransmittedBytesSent),Re(de,De.Video_Send_Packages_Retransmit,Y.retransmittedPacketsSent),Re(de,De.Video_Send_Key_Frames_Encoded,Y.keyFramesEncoded);const Pe=M.videoSend.find((nt=>nt.ssrc===N));if(Pe){let nt=la*al;Pe.timestamp&&Y.timestamp&&(nt=Y.timestamp-Pe.timestamp),Pe.packets!=null&&Y.packets!=null&&Re(de,De.Video_Send_Package_Rate,1e3*(Y.packets-Pe.packets)/nt),Y.packetsLost!=null&&Pe.packetsLost!=null&&Re(de,De.Video_Send_Package_Lost,Y.packetsLost-Pe.packetsLost),Pe.bytes!=null&&Y.bytes!=null&&Re(de,De.Video_Send_Bitrate,8*(Y.bytes-Pe.bytes)/nt)}}return de})(p[0].ssrcId,t,h,n,i),y=h.__className__==="CameraVideoTrack"?3:X(R=h._hints).call(R,ct.SCREEN_TRACK)?7:10;(this.lastExtendStats.sendType!==y||s)&&(this.needUploadStats={sendType:y},this.lastExtendStats.sendType=y);const I=h&&(function(N,k,x,P){const M=k.videoSend.find((Y=>Y.ssrc===N));if(!M)return null;const G={};if(P){const Y=M.inputFrame,de=Y&&Y.height||x.videoHeight||0,Ie=Y&&Y.width||x.videoWidth||0,Ce=Y&&Y.frameRate||0;Re(G,De.Video_Capture_Height,de),Re(G,De.Video_Capture_Width,Ie),Re(G,De.Video_Capture_Frame_Rate,Ce)}return G})(p[0].ssrcId,t,h,!!i),A=(function(N,k){const x={};return k&&(Re(x,De.Video_Send_Retransmit,N.bitrate.retransmit),Re(x,De.Video_Send_Target_Encoded,N.bitrate.targetEncoded),Re(x,De.Video_Send_Actual_Encoded,N.bitrate.actualEncoded),Re(x,De.Video_Send_Transmit,N.bitrate.transmit),Re(x,De.Video_Send_Bandwidth,N.sendBandwidth)),x})(t,!!i);c=Object.assign({},T,I,A)}else d=(function(T,y,I,A,N){const k=y.videoSend.find((P=>P.ssrc===T));if(!k)return;const x={};if(A){const P=k.sentFrame;P&&(Re(x,De.Video_Send_Low_Height,P.height),Re(x,De.Video_Send_Low_Width,P.width),Re(x,De.Video_Send_Low_Frame_Rate,P.frameRate));const M=A.videoSend.find((G=>G.ssrc===T));if(M){let G=la*lp;M.timestamp&&k.timestamp&&(G=k.timestamp-M.timestamp),M.packets!=null&&k.packets!=null&&Re(x,De.Video_Send_Low_Package_Rate,1e3*(k.packets-M.packets)/G),k.packetsLost!=null&&M.packetsLost!=null&&Re(x,De.Video_Send_Low_Package_Lost,k.packetsLost-M.packetsLost),M.bytes!=null&&k.bytes!=null&&Re(x,De.Video_Send_Low_Bitrate,8*(k.bytes-M.bytes)/G)}}return x})(p[0].ssrcId,t,0,i);break;case J.LocalAudioTrack:a=h&&(function(T,y,I,A,N,k){const x=y.audioSend.find((M=>M.ssrc===T));if(!x)return;const P={};if(N){P[De.Audio_Send_Disabled]=I._originMediaStreamTrack&&!I._originMediaStreamTrack.enabled||I._mediaStreamTrack&&!I._mediaStreamTrack.enabled?1:0;const M=100*I._source.getAccurateVolumeLevel(),G=x.inputLevel;if(G!=null){const de=Math.ceil(50*Math.log10(100*G+1));Re(P,De.Audio_Send_Level,de)}Re(P,De.Audio_Capture_PCM_Level,M),Re(P,De.Audio_Send_AEC_Return_Loss,x.aecReturnLoss),Re(P,De.Audio_Send_AEC_Return_Loss_Enhancement,x.aecReturnLossEnhancement),Re(P,De.Audio_Send_Bytes_Retransmit,x.retransmittedBytesSent),Re(P,De.Audio_Send_Packages_Retransmit,x.retransmittedPacketsSent),P[De.Audio_Send_Freeze]=0;const Y=N.audioSend.find((de=>de.ssrc===T));if(Y){let de=la*lp;Y.timestamp&&x.timestamp&&(de=x.timestamp-Y.timestamp),Y.bytes!=null&&x.bytes!=null&&Re(P,De.Audio_Send_Bitrate,8*(x.bytes-Y.bytes)/de),Y.packets!=null&&x.packets!=null&&Re(P,De.Audio_Send_Package_Rate,1e3*(x.packets-Y.packets)/de)}}return P})(p[0].ssrcId,t,h,0,i)}})),{high:c,low:d,audio:a}}getInboundStats(t,n,i,r){if(!this.requestRemoteMedia)return;const s=this.requestRemoteMedia()||[],o=[];return s.forEach((a=>{let[c,d]=a;const l={peer:c.uid};let u;if(d.has(ue.VIDEO)&&c.videoTrack){const h=c._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(c._videoSSRC)||!1,p=c.videoTrack?(function(R,T,y,I,A,N,k,x){const P=T.videoRecv.find((Pe=>Pe.ssrc===R));if(!P)return;const M={},{receivedFrame:G,outputFrame:Y,decodeFrameRate:de}=P;Re(M,fn.Video_Render_Frame_Rate_Decode,de),P.framesRateFirefox&&Re(M,fn.Video_Recv_Frame_Rate,P.framesRateFirefox),G&&Re(M,fn.Video_Recv_Frame_Rate,G.frameRate),Re(M,fn.Video_Recv_Frame_Dropped,P.framesDroppedCount),Re(M,fn.Video_Recv_Bytes_Retransmit,P.retransmittedBytesReceived),Re(M,fn.Video_Recv_Packages_Retransmit,P.retransmittedPacketsReceived),Re(M,fn.Video_Recv_Packages_Discarded,P.packetsDiscarded),Re(M,fn.Video_Recv_Avg_Decode,P.avgDecodeMs),Re(M,fn.Video_Recv_Avg_Processing_Delay,P.avgProcessingDelayMs),Re(M,fn.Video_Recv_Avg_Assembly_Time,P.avgFramesAssembledFromMultiplePacketsMs),Re(M,fn.Video_Recv_Avg_Inter_Frame_Delay,P.avgInterFrameDelayMs),Re(M,fn.Video_Recv_Key_Frames_Decoded,P.keyFramesDecoded);const Ie=x&&x.videoRecv.find((Pe=>Pe.ssrc===R));if(Ie){const Pe=T.timestamp-x.timestamp||la;P.packetsLost!=null&&Ie.packetsLost!=null&&Re(M,fn.Video_Recv_Package_Lost,P.packetsLost-Ie.packetsLost),Ie.bytes!=null&&P.bytes!=null&&Re(M,fn.Video_Recv_Bitrate,8*(P.bytes-Ie.bytes)/Pe),Ie.packets!=null&&P.packets!=null&&Re(M,fn.Video_Recv_Package_Rate,1e3*(P.packets-Ie.packets)/Pe)}const Ce=N&&N.videoRecv.find((Pe=>Pe.ssrc===R));if(Ce&&(Re(M,Fr.Video_Recv_Qp_Sum,P.qpSumPerFrame),M[Fr.Video_Recv_Freeze]=I&&sl.isRemoteVideoFreeze(y,P,Ce)?1:0),k){var Ue;const Pe=k.videoRecv.find((Pt=>Pt.ssrc===R));G?(Re(M,De.Video_Recv_Height,G.height),Re(M,De.Video_Recv_Width,G.width)):y&&(Re(M,De.Video_Recv_Height,y._videoHeight||0),Re(M,De.Video_Recv_Width,y._videoWidth||0)),Y&&Re(M,De.Video_Recv_Frame_Rate_Output,Y.frameRate);const nt=(Ue=y._player)===null||Ue===void 0?void 0:Ue.rendFrameRate.toFixed(0);if(nt&&Re(M,De.Video_Render_Frame_Rate_Render,+nt),Re(M,De.Video_Recv_Jitter_Buffer,P.jitterBufferMs),Re(M,De.Video_Recv_Current_Delay,P.currentDelayMs),Re(M,De.Video_Recv_Firs,P.firsCount),Re(M,De.Video_Recv_Nacks,P.nacksCount),Re(M,De.Video_Recv_Plis,P.plisCount),y){M[De.Video_Recv_Disabled]=y._originMediaStreamTrack.enabled&&y._mediaStreamTrack.enabled?0:1;const Pt=y._player;if(Pt){const{freezeTimeCounterList:H,renderFreezeAccTime:$,renderFreezeAccTime2:he,videoElementStatus:K}=Pt;if(H&&H.length>0&&Re(M,Fr.Video_Render_Freeze_Time,H.splice(0,1)[0]),A&&Ri.visibility==="visible"&&K===Ln.PLAYING&&We().supportRequestVideoFrameCallback){const S=Math.min(6e3,he);Pt.renderFreezeAccTime2=Math.max(0,he-S),Re(M,Fr.Video_Render_Freeze_Time_Render2,S);const O=Math.min(6e3,$);Pt.renderFreezeAccTime=Math.max(0,$-O),Re(M,Fr.Video_Render_Freeze_Time_Render,b("USE_NEW_RENDER_FREEZE_TIME")?S:O)}if(typeof P.totalFreezesDuration=="number"){const S=Pe&&Pe.totalFreezesDuration?P.totalFreezesDuration-Pe.totalFreezesDuration:P.totalFreezesDuration;Re(M,De.Video_Render_Freeze_Duration,1e3*S)}}}if(M[De.Video_Recv_Player_Status]=zE[y._player?y._player.videoElementStatus:"uninit"],Pe&&P.totalInterFrameDelay!==void 0&&P.totalSquaredInterFrameDelay!==void 0&&Pe.totalInterFrameDelay!==void 0&&Pe.totalSquaredInterFrameDelay!==void 0){const Pt=P.totalInterFrameDelay-Pe.totalInterFrameDelay,H=P.totalSquaredInterFrameDelay-Pe.totalSquaredInterFrameDelay,$=P.framesDecodeCount-Pe.framesDecodeCount,he=Pt/$*1e3,K=Math.round(1e3*Math.sqrt((H-Math.pow(Pt,2)/$)/$));!isNaN(K)&&he+K>Math.max(3*he,he+150)&&(M[De.Video_Recv_I_Frame_Delay]=K)}}return M})(c._videoSSRC,t,c.videoTrack,h===!0,this.needUploadRenderFreezeTime,n,i,r):void 0;if(p&&(l.video=p),c.videoTrack){const R=t.videoRecv.find((T=>T.ssrc===c._videoSSRC));R&&R.estimatedPlayoutTimestamp&&(u=R.estimatedPlayoutTimestamp)}}if(d.has(ue.AUDIO)&&c.audioTrack){const h=c.audioTrack?(function(p,R,T,y,I,A){const N=R.audioRecv.find((M=>M.ssrc===p));if(!N)return;const k={};Re(k,fn.Audio_Recv_Jitter,N.jitterMs),Re(k,fn.Audio_Recv_Bytes_Retransmit,N.retransmittedBytesReceived),Re(k,fn.Audio_Recv_Packages_Retransmit,N.retransmittedPacketsReceived),Re(k,fn.Audio_Recv_Packages_Discarded,N.packetsDiscarded),Re(k,fn.Audio_Recv_Avg_Processing_Delay,N.avgProcessingDelayMs);const x=A&&A.audioRecv.find((M=>M.ssrc===p));if(x){const M=la;N.packets!=null&&x.packets!=null&&Re(k,fn.Audio_Recv_Package_Rate,1e3*(N.packets-x.packets)/M),N.packetsLost!=null&&x.packetsLost!=null&&Re(k,fn.Audio_Recv_Package_Lost,N.packetsLost-x.packetsLost)}if(y){const{receivedFrames:M,droppedFrames:G}=N;M!=null&&G!=null&&(k[Fr.Audio_Recv_Freeze]=(P=M)===0||100*G/P>20?1:0)}var P;if(I){const M=100*T._source.getAccurateVolumeLevel(),G=N.outputLevel;if(G!=null){const de=Math.ceil(50*Math.log10(100*G+1));Re(k,De.Audio_Render_Level,de)}Re(k,De.Audio_Recv_PCM_Level,M),T&&(k[De.Audio_Recv_Disabled]=T._originMediaStreamTrack.enabled&&T._mediaStreamTrack.enabled?0:1),Re(k,De.Audio_Recv_Jitter_Buffer,N.jitterBufferMs),Re(k,De.Audio_Recv_Current_Delay,N.jitterBufferMs),k[De.Audio_Recv_Player_Status]=zE[Gn.getPlayerState(T.getTrackId())];const Y=I.audioRecv.find((de=>de.ssrc===p));if(Y){Y.bytes!=null&&N.bytes!=null&&Re(k,De.Audio_Recv_Bitrate,8*(N.bytes-Y.bytes)/(la*al));const de=N.concealedSamples-Y.concealedSamples;de>0&&Re(k,De.Audio_Recv_Concealed_Samples,de);const Ie=N.totalSamplesReceived-Y.totalSamplesReceived;Ie>0&&Re(k,De.Audio_Recv_Total_Samples_Received,Ie);const Ce=N.freezeSamples80-Y.freezeSamples80;Ce>0&&Re(k,De.Audio_Render_Freeze_Samples_80ms,Ce);const Ue=N.freezeSamples200-Y.freezeSamples200;Ue>0&&Re(k,De.Audio_Render_Freeze_Samples_200ms,Ue);const Pe=N.freezeMs80-Y.freezeMs80;Re(k,De.Audio_Render_Freeze_Time_80ms,Pe<0?0:Pe);const nt=N.freezeMs200-Y.freezeMs200;Re(k,De.Audio_Render_Freeze_Time_200ms,nt<0?0:nt)}}return k})(c._audioSSRC,t,c.audioTrack,n,i,r):void 0;if(h&&(l.audio=h),c.audioTrack&&u){const p=t.audioRecv.find((R=>R.ssrc===c._audioSSRC));if(p&&p.estimatedPlayoutTimestamp){const R=p.estimatedPlayoutTimestamp-u;l.audio?l.audio[fn.Audio_Recv_AV_Sync_TIME]=R:l.audio={[fn.Audio_Recv_AV_Sync_TIME]:R}}}}(l.video||l.audio)&&o.push(l)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const t=(this.requestAllTracks()||[]).find((n=>n instanceof qd));if(t&&t._external.getDenoiserStats){const n=t._external.getDenoiserStats();n&&this.requestUpload(oa.DENOISER_STATS,n)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach((t=>{t.getProcessorStats().forEach((n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach((t=>{let[n,i]=t;i.has(ue.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach((r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})),i.has(ue.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach((r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}))}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const t=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const n=Date.now(),i={connectionInterval:b("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n};let r=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const d of s)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[d,l]of o)l.has(ue.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),l.has(ue.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;i.details=(function(d,l){const u={};for(const{id:T,value:y,level:I,direction:A}of d){var h;const N=(h=l.get(T))!==null&&h!==void 0?h:0,k=y===2?N+b("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:N;var p,R;l.set(T,k),u[T]?(y===2&&(u[T].value=y),I>u[T].level&&(u[T].level=I),A==="remote"&&(u[T].remoteUidCount+=1),u[T].totalTs=(p=l.get(T))!==null&&p!==void 0?p:0):u[T]={value:y,level:I,remoteUidCount:A==="local"?0:1,totalTs:(R=l.get(T))!==null&&R!==void 0?R:0}}return Object.keys(u).map((T=>{const{level:y,value:I,totalTs:A}=u[T];return{id:T,level:y,value:I,totalTs:A}}))})(r,t);const a=Date.now(),c=a>n?a:n+1;this.requestUpload&&this.requestUpload(oa.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c})}),b("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1,Ri.stopCollectStats()}}const BH=b("ICE_RESTART_INTERVAL");let up=new Map,Vc=new Map,po=[Sn.UDP_TCP_RELAY,Sn.TCP_RELAY,Sn.RELAY],Zg=b("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&We().supportPCSetConfiguration;function KN(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=up.get(e.id);n&&(window.clearTimeout(n),up.delete(e.id));const i=Vc.get(e.id);t&&i&&i.index===po.length-1&&(_.debug("[".concat(e.id,"] reset ICE restart policy")),Vc.delete(e.id))}function YN(e,t,n){if(up.size===0&&Vc.size===0&&(Array.isArray(b("RESTART_SEQUENCE"))&&b("RESTART_SEQUENCE").length>0&&!(function(a,c){if(a.length!==c.length)return!1;for(let d=0;d<a.length;d+=1){const l=a[d];if(a.filter((u=>u===l)).length!==c.filter((u=>u===l)).length)return!1}return!0})(po,b("RESTART_SEQUENCE"))&&(po=b("RESTART_SEQUENCE").filter((a=>{var c;if(X(c=Object.values(Sn)).call(c,a))return!0})),_.debug("use reconnection policy from config distribution, queues: ".concat(po.join(" => ")))),Zg=b("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&We().supportPCSetConfiguration),po.length===0)return void n();let i,{index:r=0,type:s}=Vc.get(e.id)||{};if(Zg&&s===Sn.RELAY)return void n();let o=s&&r>=po.length-1;if(Zg)s=Sn.RELAY;else{if(o)return void n();s?(r++,s=po[r]):(s=po[0],r=0)}_.debug("[".concat(e.id,"] choose ICE restart policy: ").concat(s,", index: ").concat(r)),t(s),Vc.set(e.id,{index:r,type:s}),i=window.setTimeout((()=>YN(e,t,n)),BH),up.set(e.id,i)}var He;function zN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function hs(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?zN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):zN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function qN(e){var t,n,i,r=2;for(typeof Symbol<"u"&&(n=rh,i=Symbol.iterator);r--;){if(n&&(t=e[n])!=null)return t.call(e);if(i&&(t=e[i])!=null)return new hp(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function hp(e){function t(n){if(Object(n)!==n)return ie.reject(new TypeError(n+" is not an object."));var i=n.done;return ie.resolve(n.value).then((function(r){return{value:r,done:i}}))}return hp=function(n){this.s=n,this.n=n.next},hp.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?ie.resolve({value:n,done:!0}):t(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?ie.reject(n):t(i.apply(this.s,arguments))}},new hp(e)}let ua=(He=class extends kt{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(ge.StateChange,t,this._state)}constructor(e,t){super(),v(this,"isPlanB",void 0),v(this,"store",void 0),v(this,"statsUploader",void 0),v(this,"connection",void 0),v(this,"localTrackMap",new Map),v(this,"remoteUserMap",new Map),v(this,"localDataChannels",[]),v(this,"remoteDataChannelMap",new Map),v(this,"pendingLocalTracks",[]),v(this,"pendingRemoteTracks",[]),v(this,"pendingLocalDataChannels",[]),v(this,"pendingRemoteDataChannels",[]),v(this,"statsCollector",void 0),v(this,"shouldForwardP2PCreation",void 0),v(this,"iceFailedCount",0),v(this,"dtlsFailedCount",0),v(this,"mutex",void 0),v(this,"_state",st.Disconnected),v(this,"_pcStatsUploadType",b("NEW_ICE_RESTART")?ks.FIRST_CONNECTION:ks.OLD_FIRST_CONNECTION),v(this,"_isStartRestartIce",!1),v(this,"_restartTimer",void 0),v(this,"_isTryConnecting",!1),v(this,"_iceError",null),v(this,"_forceTurn",!1),v(this,"_isWaitPcToRePub",!1),v(this,"handleMuteLocalTrack",(async(n,i,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==st.Connected)return void r(new F(w.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const o=this.filterTobeMutedTracks(n);if(o.length===0)return void i();const a=o.find((d=>d[0]==="videoLowTrack"));if(a){const d=a[1];this.store.enableInstantMuteRestore?(d.track._originMediaStreamTrack.enabled=!1,_.info("[".concat(this.store.clientId,"] P2PChannel muteLocalLowTrack without close sender because enableInstantMuteRestore is true"))):d.track._originMediaStreamTrack.stop()}this.store.enableInstantMuteRestore?_.info("[".concat(this.store.clientId,"] P2PChannel muteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.muteLocal(o.map((d=>{let[,{id:l}]=d;return l})));const c=this.createMuteMessage(o);await vt(this,ge.RequestMuteLocal,c),i()}catch(o){r(o)}finally{s()}})),v(this,"handleUnmuteLocalTrack",(async(n,i,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==st.Connected)return void r(new F(w.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const o=this.filterTobeUnmutedTracks(n);if(o.length===0)return void i();const a=o.find((d=>d[0]==="videoLowTrack"));if(a){const d=a[1];if(this.store.enableInstantMuteRestore)d.track._originMediaStreamTrack.enabled=!0,_.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalLowTrack without close sender because enableInstantMuteRestore is true"));else{if(d.track._originMediaStreamTrack.stop(),!b("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding){const l=n._mediaStreamTrack.clone();d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}else{const l=Jg(n,Yo(this,ge.RequestLowStreamParameter));d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}await new ie(((l,u)=>{this.handleReplaceTrack(d.track,l,u,!0)}))}}this.store.enableInstantMuteRestore?_.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.unmuteLocal(o.map((d=>{let[,{id:l}]=d;return l})));const c=this.createUnmuteMessage(o);await vt(this,ge.RequestUnmuteLocal,c),i()}catch(o){r(o)}finally{s()}})),v(this,"handleUpdateVideoEncoder",(async(n,i,r,s)=>{let o;s||(o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{const c=this.localTrackMap.get(J.LocalVideoTrack);if(!this.connection||!c||c.track!==n||this.state!==st.Connected)return void i();const{id:d,track:l}=c;await this.connection.updateSendParameters(d,l),await this.connection.updateEncoderConfig(d,l),this.emit(ge.UpdateVideoEncoder,l),i()}catch(c){r(c)}finally{var a;(a=o)===null||a===void 0||a()}})),v(this,"handleUpdateVideoSendParameters",(async(n,i,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(J.LocalVideoTrack);if(!this.connection||!o||o.track!==n||this.state!==st.Connected)return void i();const{id:a,track:c}=o;await this.connection.updateSendParameters(a,c),i()}catch(o){r(o)}finally{s()}})),v(this,"handleReplaceMixingTrack",(async(n,i,r,s)=>{if(!this.connection||this.state!==st.Connected)return void i();const o=zg([n]);let a;_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(o.getTrackId(),"]")),typeof s=="boolean"&&s||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(n,o),i()}catch(d){r(d)}finally{var c;(c=a)===null||c===void 0||c()}})),v(this,"handleReplaceTrack",(async(n,i,r,s)=>{let o;_.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof s=="boolean"&&s||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find((l=>{let[,{track:u}]=l;return n===u}));if(!this.connection||!d||this.state!==st.Connected)return void i();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),this.isPlanB){const l=d[1];l.id=n._mediaStreamTrack.id,this.localTrackMap.set(d[0],l)}if(d[0]===J.LocalVideoTrack&&!b("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding){const l=this.localTrackMap.get(J.LocalVideoLowTrack);if(l){const u=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new ie(((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)}))}}i()}catch(d){r(d)}finally{var c;(c=o)===null||c===void 0||c()}})),v(this,"handleGetRTCStats",(n=>{n(this.statsCollector.getRTCStats())})),v(this,"handleGetLocalVideoStats",(n=>{n(this.statsCollector.getLocalVideoTrackStats())})),v(this,"handleGetLocalAudioStats",(n=>{n(this.statsCollector.getLocalAudioTrackStats())})),v(this,"handleGetRemoteVideoStats",(n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid])),v(this,"handleGetRemoteAudioStats",(n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid])),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new HN(this.store),this.bindStatsUploaderEvents(),this.mutex=new gn("P2PChannel-mutex",this.store.clientId),this.isPlanB=!We().supportUnifiedPlan||b("CHROME_FORCE_PLAN_B")&&is(),this.shouldForwardP2PCreation=b("FORWARD_P2P_CREATION")&&We().supportPCSetConfiguration&&Dw(),this.shouldForwardP2PCreation&&(this.connection=ol(this.store),this.emit(ge.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var n;this.state=st.New,this._forceTurn=Xg(e),_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));const i=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if((!this.shouldForwardP2PCreation||i||t)&&((i||t)&&this.connection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=ol(this.store,e),this.emit(ge.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new F(w.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=b("NEW_ICE_RESTART")?ks.FIRST_CONNECTION:ks.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e){if(!this.connection)throw new F(w.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");if(!this.isPreallocation()||this.state!==st.Connected){this.store.peerConnectionStart();const t=await this.connection.connect(e);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=st.Connected,t}if(this.connection instanceof Ui&&this.connection.checkDtlsParameters(e.dtlsParameters.fingerprints))return _.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] dtls parameters mismatch, try next.")),pe.reportApiInvoke(this.store.sessionId,{name:Nt.MISMATCH_DTLS_PARAMETERS,options:[e.dtlsParameters.fingerprints],tag:Tt.TRACER}).onSuccess(),void setTimeout((()=>{this.emit(ge.RequestReconnect)}));await this.connection.updateRemoteConnect(e)}updateRemoteRTPCapabilities(e){const t=Array.from(this.localTrackMap.entries()).filter((r=>{var s;let[o]=r;return X(s=[J.LocalVideoLowTrack,J.LocalVideoTrack]).call(s,o)})),n=t.map((r=>{let[,{id:s}]=r;return s})),i=t.map((r=>{let[s]=r;return s}));if(this.connection instanceof Ui||this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"){if(pe.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!X(e).call(e,this.store.codec)){const r=["vp9","vp8","h264"].find((s=>X(e).call(e,s)));r&&(this.store.codec=r,_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(n,e)}}async getEstablishParams(){var e;return this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof Ui&&this.connection.peerConnectionState!=="closed"&&X(e=[st.New,st.Connected]).call(e,this.state)?this.connection.establishPromise:void 0}async publishDataChannel(e){if(!this.connection||this.state!==st.Connected){if(this.state===st.Disconnected)throw new F(w.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return e.forEach((n=>{var i;X(i=this.pendingLocalDataChannels).call(i,n)||this.pendingLocalDataChannels.push(n)})),[]}const t=this.filterTobePublishedDataChannels(e);return t.length===0?[]:(t.forEach((n=>{const i=Date.now();this.store.publish(n.id.toString(),"datachannel",i)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((n=>{this.localDataChannels.push(n);const i=Date.now();this.store.publish(n.id+"","datachannel",void 0,i)})),e.map((n=>({streamId:n.id,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:n.metadata,channelId:n._originDataChannelId}))))}publish(e,t,n){var i=this;return ni((function*(){const r=yield Ve(i.mutex.lock("From P2PChannel.publish"));try{var s;const o=i.connection&&X(s=["disconnected","failed"]).call(s,i.connection.peerConnectionState);if(!i.connection||i.state!==st.Connected||o){if(i.state===st.Disconnected)throw new F(w.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(e);const c=e.filter((d=>i.pendingLocalTracks.indexOf(d)===-1));return i.pendingLocalTracks=i.pendingLocalTracks.concat(c),void(o&&(i._isWaitPcToRePub=!0))}i.store.pubId=i.store.pubId+1,xn.markPublishStart(i.store.clientId,i.store.pubId);const a=i.filterTobePublishedTracks(e,t,n);if(a.length===0)return void(yield Ve(i.tryToUnmuteAudio(e)));yield*ac(qN(i.doPublish(i.connection,a)))}finally{r()}}))()}doPublish(e,t){var n=this;return ni((function*(){t.forEach((h=>{let{track:p,type:R}=h;const T=Date.now();n.store.publish(p.getTrackId(),R===J.LocalAudioTrack?"audio":"video",T)})),n.bindLocalTrackEvents(t);const i=t.map((h=>{let{track:p}=h;return p})),r=yield Ve(e.send(i,n.store.codec,n.store.audioCodec)),s=(yield Ve(r.next())).value,o=n.createGatewayPublishMessage(t,s);let a;try{a=yield o}catch(h){throw r.throw(h),h?.code===w.WS_ABORT&&t.forEach((p=>{let{track:R}=p;n.pendingLocalTracks.indexOf(R)===-1&&n.pendingLocalTracks.push(R)})),n.unbindLocalTrackEvents(t),h}const c=n.mapPubResToRemoteConfig(o,a,i),d=(yield Ve(r.next(c))).value;if(n.state===st.Disconnected)throw new F(w.UNEXPECTED_ERROR,"PeerConnection already disconnected.");b("ENABLE_VIDEO_SEI");const l=b("ENABLE_ENCODED_TRANSFORM"),u=b("ENABLE_AUDIO_METADATA");i.forEach((async h=>{const p=h.getRTCRtpTransceiver();if(!p||!l)return;const{interceptLocalVideoFrame:R,interceptLocalAudioFrame:T}=tp();h.trackMediaType===ue.VIDEO?await R(p.sender,h):h.trackMediaType===ue.AUDIO&&await T(p.sender,{metadata:u?()=>{const y=h.metadata.shift();return y&&y.value}:void 0})})),t.forEach((h=>{let{type:p}=h;n.statsCollector.addLocalStats(p)})),n.assignLocalTracks(t,d),n.statsUploader.startUploadOutboundStats(),t.forEach((h=>{let{track:p,type:R}=h;const T=Date.now();n.store.publish(p.getTrackId(),R===J.LocalAudioTrack?"audio":"video",void 0,T)}))}))()}async updateVideoStreamParameter(e,t){const n=this.localTrackMap.get(t);if(!n||!this.connection)return;if(!(n.track instanceof yt))return _.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");const{track:i}=n,r=(function(s,o){const a={};return s.height&&s.width&&(a.scaleResolutionDownBy=Ig(s,o)),a.maxFramerate=s.framerate?ai(s.framerate):void 0,a.maxBitrate=s.bitrate?1e3*s.bitrate:void 0,a})(e,i);if(i._encoderConfig||(i._encoderConfig={}),t!==J.LocalVideoLowTrack||!b("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const s=i._originMediaStreamTrack;if(!s.canvas)return _.warn("[".concat(i.getTrackId(),"] no canvas on track"));(function(o,a){const c=o.canvas;a.width&&(c.width=ai(a.width)),a.height&&(c.height=ai(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=JE((()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture()}),ai(a.framerate)))})(s,e)}r.maxBitrate!=null&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(i._encoderConfig.frameRate&&typeof i._encoderConfig.frameRate=="object"?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),_.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i)}publishLowStream(e){var t=this;return ni((function*(){if(!t.connection||t.state!==st.Connected)return;const n=yield Ve(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const r=t.localTrackMap.get(J.LocalVideoTrack);if(!r)throw new F(w.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(J.LocalVideoLowTrack))throw new F(w.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const s=[{track:t.getLowVideoTrack(r.track,e),type:J.LocalVideoLowTrack}];if(yield*ac(qN(t.doPublish(t.connection,s))),r.track.muted||!r.track.enabled){var i;const o=(i=t.localTrackMap.get(J.LocalVideoLowTrack))===null||i===void 0?void 0:i.id;o!==void 0&&(yield Ve(t.connection.muteLocal([o])))}}finally{n()}}))()}async republish(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await en(this,ge.RequestRePublish,this.pendingLocalTracks),this.emit(ge.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(_.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await en(this,ge.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:n,kind:i}=this.pendingRemoteTracks[t];(i!==ue.AUDIO||n._audio_added_&&n._audioSSRC)&&(i!==ue.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await en(this,ge.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:n}of this.pendingRemoteTracks)await this.subscribe(t,n,n===ue.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach((t=>{let{user:n}=t;this.emit(ge.MediaReconnectEnd,n.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==st.Connected)return void e.forEach((i=>{const r=this.pendingLocalTracks.indexOf(i);r!==-1&&this.pendingLocalTracks.splice(r,1)}));const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const n=t.find((i=>i[0]==="videoLowTrack"));return n&&n[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==st.Connected)return void e.forEach((n=>{const i=this.pendingLocalDataChannels.indexOf(n);i!==-1&&this.pendingLocalDataChannels.splice(i,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return t.length!==0?(t.forEach((n=>{const i=this.localDataChannels.indexOf(n);i!==-1&&this.localDataChannels.splice(i,1)})),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),t.map((n=>n.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==st.Connected)return;const e=this.localTrackMap.get(J.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[J.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const n=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((i=>{let[,{id:r}]=i;return r}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((i=>{let[r,{track:s}]=i;return{type:r,track:s}}))),t.forEach((i=>{let[r]=i;this.statsCollector.removeLocalStats(r)})),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(e,t){if(!this.connection||this.state!==st.Connected)throw new F(w.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=t.filter((i=>{var r;return!((r=this.remoteDataChannelMap.get(e))!==null&&r!==void 0&&r.get(i.id))}));if(n.length!==0)return await this.connection.createDataChannels(e.uid,n),n.forEach((i=>{var r;this.remoteDataChannelMap.has(e)?(r=this.remoteDataChannelMap.get(e))===null||r===void 0||r.set(i.id,i):this.remoteDataChannelMap.set(e,new Map([[i.id,i]]));const s=this.pendingRemoteDataChannels.findIndex((o=>{let{user:a,id:c}=o;return a.uid===e.uid&&c===i.id}));s!==-1&&this.pendingRemoteDataChannels.splice(s,1)})),n.map((i=>i.id))}async subscribe(e,t,n,i,r){var s;if(!this.connection||this.state!==st.Connected)throw new F(w.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((s=this.remoteUserMap.get(e))!==null&&s!==void 0&&s.has(t))return;let o,a,c,d;const l=this.connection.getPreMedia(n);if(l)_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(n,", no need to send sub to gateway.")),c=l.transceiver,o=l.track,a=l.mid,d=l.player,l.firstVideoRender&&this.store.firstVideoFrameDecoded(e.uid,{firstPreRender:l.firstVideoRender});else if(r){const p=r.find((T=>{let{stream_type:y}=T;return y===t}));if(!p)throw new F(w.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const R=await this.connection.receive(t,p.ssrcs,String(e._uintid),p.attributes);(this.connection instanceof Ui||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=R.transceiver),o=R.track,a=R.id}else{const p=await this.connection.receive(t,[{ssrcId:n,rtx:i}],String(e._uintid),void 0);(this.connection instanceof Ui||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=p.transceiver),o=p.track,a=p.id}if(t===ue.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new Cc(o,e.uid,e._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new Rc(o,e.uid,e._uintid,this.store,d),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId())),e._videoTrack.once(Ki.PLAY_START,(()=>{this.store.firstVideoFrameDecoded(e.uid,{playStart:Date.now()})})),e._videoTrack.once(Ki.PLAY_END,(()=>{this.store.firstVideoFrameDecoded(e.uid,{playEnd:Date.now()}),this.reportVideoFirstFrameRender(e)})),d?e._videoTrack.once(Ki.FIRST_FRAME_RENDER,(()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)})):e._videoTrack.once(Ki.FIRST_FRAME_DECODED,(()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)}))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack)),c&&b("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:p,interceptRemoteAudioFrame:R}=tp();t==ue.VIDEO?await p(c.receiver,{onSei:b("ENABLE_VIDEO_SEI")&&(T=>{var y;return(y=e._videoTrack)===null||y===void 0?void 0:y._onSei(T)}),onFirstFrame:T=>{var y;const I=Array.from(Bn(y=this.remoteUserMap).call(y)).find((A=>A._videoSSRC===T.ssrc));I&&this.store.firstVideoFrameDecoded(I.uid,{firstReceivedEncodedFrame:Date.now(),frameType:T.type,rtpTimestamp:T.rtpTimestamp,framePayloadType:T.payloadType,frameDataLength:T.length,mimeType:T.mimeType})}}):t==ue.AUDIO&&await R(c.receiver,{enableTopn:!!b("ENABLE_AUDIO_TOPN"),enableMetadata:!!b("ENABLE_AUDIO_METADATA"),enablePts:!!b("ENABLE_AUDIO_PTS"),onMetadata:T=>{this.safeEmit(ge.AudioMetadata,T)},onPts:T=>{this.safeEmit(ge.AudioPts,T)}})}const u=this.remoteUserMap.get(e);u?u.set(t,a):this.remoteUserMap.set(e,new Map([[t,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const h=this.pendingRemoteTracks.findIndex((p=>{let{user:R,kind:T}=p;return R.uid===e.uid&&t===T}));h!==-1&&(this.pendingRemoteTracks.splice(h,1),this.emit(ge.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==st.Connected)throw new F(w.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((r=>{var s;let{user:o,mediaType:a}=r;return!((s=this.remoteUserMap.get(o))!==null&&s!==void 0&&s.has(a))}));const t=[],n=new Map;e.forEach((r=>{if(!this.connection)return;const s=this.connection.getPreMedia(r.ssrcId);if(s){const{track:o,mid:a,transceiver:c,player:d}=s;n.set(r.ssrcId,{track:o,id:a,transceiver:c,player:d})}else t.push(r)}));const i=await this.connection.batchReceive(t.map((r=>{let{user:s,mediaType:o,ssrcId:a,rtxSsrcId:c}=r;return{kind:o,ssrcMsg:[{ssrcId:a,rtx:c}],mslabel:String(s._uintid)}})));t.forEach(((r,s)=>{n.set(r.ssrcId,i[s])}));for(const{user:r,mediaType:s,ssrcId:o}of e){const a=n.get(o);if(!a)return void _.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(r.uid," subscribe data,").concat(s,", ").concat(o));const{track:c,id:d,transceiver:l,player:u}=a;if(l&&b("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:R,interceptRemoteAudioFrame:T}=tp();s==ue.VIDEO?await R(l.receiver,{onSei:b("ENABLE_VIDEO_SEI")&&(y=>{var I;return(I=r._videoTrack)===null||I===void 0?void 0:I._onSei(y)}),onFirstFrame:y=>{var I;const A=Array.from(Bn(I=this.remoteUserMap).call(I)).find((N=>N._videoSSRC===y.ssrc));A&&this.store.firstVideoFrameDecoded(A.uid,{firstReceivedEncodedFrame:Date.now(),frameType:y.type,rtpTimestamp:y.rtpTimestamp,framePayloadType:y.payloadType,frameDataLength:y.length,mimeType:y.mimeType})}}):s==ue.AUDIO&&await T(l.receiver,{enableTopn:!!b("ENABLE_AUDIO_TOPN"),enableMetadata:!!b("ENABLE_AUDIO_METADATA"),enablePts:!!b("ENABLE_AUDIO_PTS"),onMetadata:y=>{this.safeEmit(ge.AudioMetadata,y)},onPts:y=>{this.safeEmit(ge.AudioPts,y)}})}if(s===ue.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(c):(r._audioTrack=new Cc(c,r.uid,r._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),l&&r._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(c):(r._videoTrack=new Rc(c,r.uid,r._uintid,this.store,u),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),l&&r._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._videoTrack)),b("ENABLE_VIDEO_SEI")&&l){const{interceptRemoteVideoFrame:R,interceptRemoteAudioFrame:T}=tp();s==ue.VIDEO?await R(l.receiver,{onSei:y=>{var I;(I=r._videoTrack)===null||I===void 0||I._onSei(y)},onFirstFrame:y=>{var I;const A=Array.from(Bn(I=this.remoteUserMap).call(I)).find((N=>N._videoSSRC===y.ssrc));A&&this.store.firstVideoFrameDecoded(A.uid,{firstReceivedEncodedFrame:Date.now(),frameType:y.type,rtpTimestamp:y.rtpTimestamp,framePayloadType:y.payloadType,frameDataLength:y.length,mimeType:y.mimeType})}}):s==ue.AUDIO&&await T(l.receiver)}const h=this.remoteUserMap.get(r);h?h.set(s,d):this.remoteUserMap.set(r,new Map([[s,d]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();const p=this.pendingRemoteTracks.findIndex((R=>{let{user:T,kind:y}=R;return T.uid===r.uid&&s===y}));p!==-1&&(this.pendingRemoteTracks.splice(p,1),this.emit(ge.MediaReconnectEnd,r.uid))}}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter((o=>{let{user:a,kind:c}=o;return t!==void 0?a.uid===e.uid&&t===c:a.uid===e.uid}));if(i.forEach((o=>{const a=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(a,1)})),this.connection&&this.state===st.Connected||n||i.forEach((o=>{let{kind:a}=o;var c;if(a===ue.AUDIO)(c=e._audioTrack)===null||c===void 0||c._destroy(),e._audioTrack=void 0;else if(a===ue.VIDEO){var d;(d=e._videoTrack)===null||d===void 0||d._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==st.Connected)return;const r=this.filterTobeUnSubscribedTracks(e,t);if(r.length===0)return;await this.connection.stopReceiving(r.map((o=>{let[,{id:a}]=o;return a})));const s=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach((o=>{let[a,{kind:c}]=o;var d,l;if(c===ue.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===ue.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),n||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===ue.AUDIO){var u;this.unbindRemoteTrackEvents(a._audioTrack),!n&&((u=a._audioTrack)===null||u===void 0||u._destroy(),a._audioTrack=void 0)}})),s}async unsubscribeDataChannel(e,t){if(t.forEach((r=>{const s=this.pendingRemoteDataChannels.findIndex((o=>o.id===r.id));s!==-1&&this.pendingRemoteDataChannels.splice(s,1)})),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(e,t);if(n.length===0)return;t.forEach((r=>{r._close()}));const i=this.remoteDataChannelMap.get(e);return n.forEach((r=>{i&&i.delete(r.id)})),i&&i.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),n.map((r=>r.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:r,mediaType:s}of e){const o=this.pendingRemoteTracks.filter((a=>{let{user:c,kind:d}=a;return s!==void 0?c.uid===r.uid&&s===d:c.uid===r.uid}));o.forEach((a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)})),t=t.concat(o)}if(!this.connection||this.state!==st.Connected)return void t.forEach((r=>{let{user:s,kind:o}=r;var a;if(o===ue.AUDIO)(a=s._audioTrack)===null||a===void 0||a._destroy(),s._audioTrack=void 0;else if(o===ue.VIDEO){var c;(c=s._videoTrack)===null||c===void 0||c._destroy(),s._videoTrack=void 0}}));const n=Bi(e).call(e,((r,s)=>{let{user:o,mediaType:a}=s;const c=this.filterTobeUnSubscribedTracks(o,a);return r.concat(c)}),[]);if(n.length===0)return;await this.connection.stopReceiving(n.map((r=>{let[,{id:s}]=r;return s})));const i=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach((r=>{let[s,{kind:o}]=r;var a,c;if(o===ue.VIDEO&&s._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),o===ue.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),(c=s._videoTrack)===null||c===void 0||c._destroy(),s._videoTrack=void 0;else if(o===ue.AUDIO){var d;this.unbindRemoteTrackEvents(s._audioTrack),(d=s._audioTrack)===null||d===void 0||d._destroy(),s._audioTrack=void 0}})),i}isPreSubScribe(e){return!this.connection||this.state!==st.Connected?!1:!!this.connection.getPreMedia(e)}async muteRemote(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===ue.VIDEO?e._videoSSRC:e._audioSSRC;i!==void 0&&this.connection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(t)||_.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}addAudioMetadata(e){const t=this.localTrackMap.get(J.LocalAudioTrack),n=t&&t.track;n&&n.metadata.push(e)}getAllTracks(e){const t=this.localTrackMap.get(J.LocalAudioTrack);if(t?.track instanceof sn){const n=t.track;return Array.from(this.localTrackMap.entries()).filter((i=>{let[r]=i;return r!==J.LocalAudioTrack})).filter((i=>{let[r]=i;return!(e&&r===J.LocalVideoLowTrack)})).map((i=>{let[,{track:r}]=i;return r})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((n=>{let[i]=n;return!(e&&i===J.LocalVideoLowTrack)})).map((n=>{let[,{track:i}]=n;return i}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,i,r){if(e){const o=this.localTrackMap.get(J.LocalAudioTrack),a=i?this.localTrackMap.get(J.LocalVideoLowTrack):this.localTrackMap.get(J.LocalVideoTrack);pe.publish(this.store.sessionId,{eventElapse:xn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(ct.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var s;n||(n=[]);const o=n.find((c=>c instanceof Wt)),a=i?(s=this.localTrackMap.get(J.LocalVideoTrack))===null||s===void 0?void 0:s.track:n.find((c=>c instanceof yt));pe.publish(this.store.sessionId,{eventElapse:xn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(ct.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===ue.VIDEO?n._videoSSRC:n._audioSSRC;r&&pe.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===ue.VIDEO,audio:i===ue.AUDIO,peerid:n.uid,subscribeRequestid:r,p2pid:this.store.p2pId,eventElapse:xn.measureFromSubscribeStart(this.store.clientId,r),preSsrc:this.isPreSubScribe(r)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new gn("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=ol(this.store),this.emit(ge.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(J.LocalAudioTrack);if(e?.track instanceof sn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((n=>{t.removeAudioTrack(n)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=st.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.connection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(J.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(J.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof yt||t&&t.track instanceof Wt?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(Bn(t=this.remoteUserMap).call(t)).find((i=>i.uid===e));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(J.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=ko(e).call(e,((n,i)=>n.level-i.level)),e}async disconnectForReconnect(){this.connection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=st.Reconnecting,b("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&((n=t._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=ol(this.store),this.emit(ge.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[n,{track:i}]=e;switch(n){case J.LocalVideoTrack:X(t=i._hints).call(t,ct.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case J.LocalAudioTrack:i instanceof sn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case J.LocalVideoLowTrack:}})),this.emit(ge.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;Array.from(Bn(n).call(n)).forEach((i=>{this.setPendingRemoteMedia(t,i)})),this.emit(ge.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,n]=e;Array.from(Bn(n).call(n)).forEach((i=>{this.setPendingRemoteDataChannel(t,i)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const n of this.pendingRemoteDataChannels){const{user:i,id:r}=n;if((e instanceof ho?e.uid:e)===i.uid&&r===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof ho?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return ni((function*(){if(!t.connection||t.state!==st.Connected)return;const n=yield Ve(t.mutex.lock("From P2PChannel.restartICE"));let i;try{i=yield Ve(t.connection.restartICE(e));const s=yield Ve(i.next());if(s.done)return;const o=s.value,a=yield o;switch(qg(t.connection)&&t.reportPCStats(Date.now(),!1,t._pcStatsUploadType),e){case Sn.UDP_TCP_RELAY:t._pcStatsUploadType=ks.UDP_TCP_RESTART;break;case Sn.TCP_RELAY:t._pcStatsUploadType=ks.TCP_RESTART;break;case Sn.RELAY:t._pcStatsUploadType=ks.RELAY_RESTART;break;default:t._pcStatsUploadType=ks.OLD_RESTART}t._isTryConnecting=!0,i.next(a)}catch(s){var r;(r=i)===null||r===void 0||r.throw(s)}finally{n()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(J.LocalVideoTrack),n=this.localTrackMap.get(J.LocalAudioTrack),i=e.videoSend.find((p=>p.ssrc===t?.ssrcs[0].ssrcId)),r=e.audioSend.find((p=>p.ssrc===n?.ssrcs[0].ssrcId));if(!i||!r)return 1;const s=vi(this,ge.NeedSignalRTT),o=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=o&&a?(o+a)/2:o||a,d=(c&&s?(c+s)/2:c||s)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=t?.track;if(h&&h._encoderConfig&&h._hints.indexOf(ct.SCREEN_TRACK)===-1){const p=h._encoderConfig.bitrateMax,R=e.bitrate.actualEncoded;if(p&&R){const T=(1e3*p-R)/(1e3*p);return kO[T<.15?0:T<.3?1:T<.45?2:T<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,s=i._videoSSRC,o=e.audioRecv.find((R=>R.ssrc===r)),a=e.videoRecv.find((R=>R.ssrc===s));if(!o&&!a)return void(t+=1);const c=vi(this,ge.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=o?o.jitterMs:void 0,h=e.recvPacketLossRate;let p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new ie(((t,n)=>{this.handleMuteLocalTrack(e,t,n)}))}async replaceTrack(e,t){var n;if(_.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(t.getTrackId(),"]")),!this.connection||this.state!==st.Connected)return;const i=Array.from(this.localTrackMap.entries()).find((s=>{let[,{track:o}]=s;return e===o}));if(!i)return;const r=i[0];if(e!==t&&(this.unbindLocalTrackEvents([{track:e,type:r}]),this.bindLocalTrackEvents([{track:t,type:r}]),i[1].track=t),await((n=this.connection)===null||n===void 0?void 0:n.replaceTrack(t,i[1].id)),this.isPlanB){const s=i[1];s.id=t._mediaStreamTrack.id,this.localTrackMap.set(r,s)}if(r===J.LocalVideoTrack&&!b("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding){const s=this.localTrackMap.get(J.LocalVideoLowTrack);if(s){const o=e._mediaStreamTrack.clone();s.track._originMediaStreamTrack.stop(),s.track._mediaStreamTrack=o,s.track._originMediaStreamTrack=o,await new ie(((a,c)=>{this.handleReplaceTrack(s.track,a,c,!0)}))}}}filterTobePublishedTracks(e,t,n){const i=[],r=this.getAllTracks();e=lc(e=e.filter((c=>r.indexOf(c)===-1)));let s,o=!1;const a=this.localTrackMap.get(J.LocalAudioTrack);for(const c of e){if(c instanceof yt&&(this.localTrackMap.has(J.LocalVideoTrack)||o?new F(w.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:J.LocalVideoTrack}),o=!0),t)){const d=this.getLowVideoTrack(c,n);i.push({track:d,type:J.LocalVideoLowTrack})}if(c instanceof Wt)if(a){const d=a.track;if(d instanceof sn)Yg([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{const l=zg([d,c]);_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(l.getTrackId(),"]")),this.replaceTrack(d,l)}}else s instanceof sn?(Yg([c]),s.addAudioTrack(c)):s||!c._useAudioElement&&We().webAudioMediaStreamDest&&!c._bypassWebAudio?s=zg(s?[c,s]:[c]):s=c}return s&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(s.getTrackId(),"]")),i.push({track:s,type:J.LocalAudioTrack})),i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=lc(e=e.filter((i=>n.indexOf(i)!==-1)));for(const i of e){if(i instanceof Wt){const r=this.localTrackMap.get(J.LocalAudioTrack);if(!r)continue;r.track instanceof sn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(t.push([J.LocalAudioTrack,r]),r.track.close())):t.push([J.LocalAudioTrack,r])}if(i instanceof yt){const r=this.localTrackMap.get(J.LocalVideoTrack);if(!r)continue;t.push([J.LocalVideoTrack,r]);const s=this.localTrackMap.get(J.LocalVideoLowTrack);s&&t.push([J.LocalVideoLowTrack,s])}}return t}filterTobePublishedDataChannels(e){return e=(e=lc(e)).filter((t=>this.localDataChannels.findIndex((n=>n.id===t.id))===-1))}filterTobeUnpublishedDataChannels(e){return e=(e=(e=lc(e)).filter((t=>this.localDataChannels.indexOf(t)!==-1))).filter((t=>t._originDataChannel))}bindLocalTrackEvents(e){e.forEach((t=>{let{track:n,type:i}=t;switch(i){case J.LocalVideoTrack:n.addListener(me.GET_STATS,this.handleGetLocalVideoStats),n.addListener(me.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(me.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case J.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case J.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof sn?e.trackList.forEach((n=>{n.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(me.GET_STATS,this.handleGetLocalAudioStats),n.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(me.GET_STATS,this.handleGetLocalAudioStats),e.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(me.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((t=>{let[n,{track:i}]=t;return{track:i,type:n}}))),e.forEach((t=>{let{track:n,type:i}=t;switch(i){case J.LocalVideoTrack:n.off(me.GET_STATS,this.handleGetLocalVideoStats),n.off(me.GET_RTC_STATS,this.handleGetRTCStats),n.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(me.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case J.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case J.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof sn?e.trackList.forEach((t=>{t.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(me.GET_STATS,this.handleGetLocalAudioStats),t.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(me.GET_STATS,this.handleGetLocalAudioStats),e.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(me.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Rc&&t.addListener(me.GET_STATS,(n=>{n(this.handleGetRemoteVideoStats(e))})),t instanceof Cc&&t.addListener(me.GET_STATS,(n=>{n(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(me.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;n.has(ue.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(ue.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((n,i)=>{var r;let s,o,{track:a,type:c}=n;switch(c){case J.LocalAudioTrack:s=pt.Audio,o={dtx:a instanceof qd&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case J.LocalVideoTrack:s=X(r=a._hints).call(r,ct.SCREEN_TRACK)?pt.Screen:pt.High,o=hs(hs({},XO(a)),{},{codec:this.store.codec,svc_mode:Zd()});break;case J.LocalVideoLowTrack:s=pt.Low,o=hs(hs({},XO(a)),{},{codec:this.store.codec,svc_mode:Zd()})}return{stream_type:s,attributes:o,ssrcs:t[i]}}))}createGatewayUnpublishMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case J.LocalVideoTrack:i=X(n=s._hints).call(n,ct.SCREEN_TRACK)?pt.Screen:pt.High;break;case J.LocalAudioTrack:i=pt.Audio;break;case J.LocalVideoLowTrack:i=pt.Low}return{stream_type:i,ssrcs:o,mid:a}}))}assignLocalTracks(e,t){e.forEach(((n,i)=>{let{track:r,type:s}=n;this.localTrackMap.set(s,{track:r,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((t=>{let[n]=t;this.localTrackMap.delete(n)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(ge.PeerConnectionStateChange,t),t==="connecting"&&e instanceof Ui&&!It()&&b("FIRST_TCP_CANDIDATE")&&window.setTimeout((()=>{t==="connecting"&&e.extendCandidate()}),b("FIRST_TCP_CANDIDATE_INTERVAL")),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),e instanceof Ui&&KN(e,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=ks.DISCONNECTED_OR_FAILED,vi(this,ge.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){const n=this.pendingLocalTracks.map((r=>r.getTrackId())),i=this.pendingLocalDataChannels.map((r=>"dc_".concat(r.id)));pe.reportApiInvoke(this.store.sessionId,{name:Nt.REPUB_AFTER_PC_CONNECTED,options:n.concat(i),tag:Tt.TRACER}).onSuccess(),this.republish()}if(b("NEW_ICE_RESTART")&&e instanceof Ui&&!It()&&!this._forceTurn&&!this.store.useDcSignal){if(X(GO).call(GO,t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const n=r=>{qg(e)&&(_.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(r)),vi(this,ge.QueryClientConnectionState)==="CONNECTED"&&this.emit(ge.RequestRestartICE,r))},i=()=>{qg(e)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),_.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(ge.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout((()=>{YN(e,n,i)}),800))}}else{if(t==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout((()=>{e.iceConnectionState==="disconnected"&&b("ICE_RESTART")&&vi(this,ge.QueryClientConnectionState)==="CONNECTED"&&this.emit(ge.RequestRestartICE)}),800),void setTimeout((()=>{e.peerConnectionState==="disconnected"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout((()=>this.emit(ge.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);t==="failed"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout((()=>this.emit(ge.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),pe.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:Tt.TRACER}).onSuccess(),this.emit(ge.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var n;const i=Array.from(Bn(n=this.remoteUserMap).call(n)).find((s=>s._audioSSRC===t));var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Ki.FIRST_FRAME_DECODED),pe.firstRemoteFrame(this.store.sessionId,rn.FIRST_AUDIO_DECODE,Dt.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:xn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var n;const i=Array.from(Bn(n=this.remoteUserMap).call(n)).find((r=>r._audioSSRC===t));i&&pe.firstRemoteFrame(this.store.sessionId,rn.FIRST_AUDIO_RECEIVED,Dt.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:xn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,n,i)=>{var r;const s=Array.from(Bn(r=this.remoteUserMap).call(r)).find((o=>o._videoSSRC===t));s&&this.store.firstVideoFrameDecoded(s.uid,{firstDecoded:Date.now()}),this.reportVideoFirstFrameDecoded(t,n,i)},e.onFirstVideoRender=t=>{var n;const i=Array.from(Bn(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===t));i&&(this.store.firstVideoFrameDecoded(i.uid,{firstPreRender:Date.now()}),this.reportVideoFirstFrameRender(i),this.emit(ge.FirstVideoPreRender,i.uid,t))},e.onFirstVideoReceived=t=>{var n;const i=Array.from(Bn(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===t));i&&(this.store.firstVideoFrameDecoded(i.uid,{firstReceived:Date.now()}),pe.firstRemoteFrame(this.store.sessionId,rn.FIRST_VIDEO_RECEIVED,Dt.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:xn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstVideoBufferReady=t=>{var n;const i=Array.from(Bn(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===t));i&&this.emit(ge.FirstVideoBufferReady,i.uid,t)},e.onSelectedLocalCandidateChanged=(t,n)=>{const i=t.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(ge.ConnectionTypeChange,i),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(lo(n))," -> ").concat(JSON.stringify(lo(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,n)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(lo(n))," -> ").concat(JSON.stringify(lo(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.getLocalVideoStats=()=>{const t=this.statsCollector.getLocalVideoTrackStats(),n=this.statsCollector.getRTCStats();return hs(hs({},t),n)},e.onICECandidateError=t=>{this._iceError=t}}fallbackConnection(){_.debug("[".concat(this.store.clientId,"] [P2PChannel] try to fallback connection")),this.state===st.Connected?(_.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&this.resetConnection(this.connection),this.shouldForwardP2PCreation&&(this.connection=ol(this.store),this.emit(ge.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)))}resetConnection(e){e instanceof Ui&&(function(t){Vc.delete(t.id),KN(t)})(e),e.close(),this.emit(ge.PeerConnectionStateChange,"closed"),(function(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.getLocalVideoStats=void 0})(e),this._isWaitPcToRePub=!1}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const n=this.localTrackMap.get(J.LocalAudioTrack);if(e instanceof Wt&&n?.track instanceof sn)return n.track.isActive||t.push([J.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return e===s}));if(i&&(t.push(i),i[0]===J.LocalVideoTrack)){const r=this.localTrackMap.get(J.LocalVideoLowTrack);r&&t.push([J.LocalVideoLowTrack,r])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(J.LocalAudioTrack);if(e instanceof Wt&&n?.track instanceof sn)return n.track.isActive&&t.push([J.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return e===s}));if(i)if(i[0]===J.LocalVideoTrack){t.push(i);const r=this.localTrackMap.get(J.LocalVideoLowTrack);r&&t.push([J.LocalVideoLowTrack,r])}else t.push(i);return t}createMuteMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case J.LocalAudioTrack:i=pt.Audio;break;case J.LocalVideoTrack:i=X(n=s._hints).call(n,ct.SCREEN_TRACK)?pt.Screen:pt.High;break;case J.LocalVideoLowTrack:i=pt.Low}return{stream_type:i,ssrcs:o,mid:a}}))}createUnmuteMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case J.LocalAudioTrack:i=pt.Audio;break;case J.LocalVideoTrack:i=X(n=s._hints).call(n,ct.SCREEN_TRACK)?pt.Screen:pt.High;break;case J.LocalVideoLowTrack:i=pt.Low}return{stream_type:i,ssrcs:o,mid:a}}))}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach((r=>{let[s,o]=r;n.push([e,{kind:s,id:o}])}));return n}filterTobeUnSubscribedDataChannels(e,t){const n=[];return t.forEach((i=>{var r;(r=this.remoteDataChannelMap.get(e))!==null&&r!==void 0&&r.has(i.id)&&n.push(i)})),n}createUnsubscribeMessage(e){const t=[];return e.forEach((n=>{let[i,{kind:r,id:s}]=n;switch(r){case ue.VIDEO:return void(i._videoSSRC&&t.push({stream_type:ue.VIDEO,ssrcId:i._videoSSRC}));case ue.AUDIO:return void(i._audioSSRC&&t.push({stream_type:ue.AUDIO,ssrcId:i._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((n=>{let[i,{kind:r}]=n;if(t.has(i)){let s=t.get(i);r===ue.VIDEO?s|=mn.Video:s|=mn.Audio,t.set(i,s)}else r===ue.VIDEO?t.set(i,mn.Video):t.set(i,mn.Audio)})),{users:Array.from(t.entries()).map((n=>{let[i,r]=n;return{stream_id:i.uid,stream_type:r}}))}}withdrawRemoteTracks(e){e.forEach((t=>{let[n,{kind:i}]=t;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(J.LocalVideoTrack),n=this.localTrackMap.get(J.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new ie(((i,r)=>{this.handleUpdateVideoEncoder(t.track,i,r,!0)}))),n&&e.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new ie(((i,r)=>{this.handleUpdateVideoEncoder(n.track,i,r,!0)})))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}isPreallocation(){return!(!this.connection||!("name"in this.connection)||this.connection.name!=="DataChannelConnection"||this.connection.peerConnectionState==="closed")||this.connection instanceof Ui&&this.connection.isPreallocation}isPreSub(){return(this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof Ui)&&this.connection.isPreSub()}isPreRender(){return this.connection instanceof Ui&&this.connection.isPreRender}mapPubResToRemoteConfig(e,t,n){return e.map(((i,r)=>{var s;let{stream_type:o}=i;const a=(s=t.find((c=>{let{stream_type:d}=c;return o===d})))===null||s===void 0?void 0:s.attributes;if(a&&b("DISABLE_SCREEN_SHARE_REMB")){const c=n[r]._hints;(X(c).call(c,ct.SCREEN_TRACK)||X(c).call(c,ct.SCREEN_LOW_TRACK))&&(a.remb=!1,_.debug("disable remb for screen share, hints:",c))}return a}))}async tryToUnmuteAudio(e){for(let n=0;n<e.length;n++)if(e[n]instanceof Wt){var t;const i=this.filterTobeUnmutedTracks(e[n]);if(i.length===0)continue;await((t=this.connection)===null||t===void 0?void 0:t.unmuteLocal(i.map((s=>{let[,{id:o}]=s;return o}))));const r=this.createUnmuteMessage(i);return void await vt(this,ge.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.connection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(ge.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(ge.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var e;return{connectState:((e=this.connection)===null||e===void 0?void 0:e.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await hn(Eh(this.dtlsFailedCount,Xt)),this.emit(ge.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await en(this,ge.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(ge.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(J.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof yt))}throwIfTrackTypeNotMatch(e){if(e.filter((t=>t instanceof yt)).length>1)throw new F(w.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((t=>t instanceof Wt)).length>1&&(e.some((t=>t instanceof Wt&&t._bypassWebAudio))||!We().webAudioMediaStreamDest))throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof yt&&this.pendingLocalTracks.some((n=>n instanceof yt)))throw new F(w.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Wt&&this.pendingLocalTracks.some((n=>n instanceof Wt))&&(!We().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((n=>n instanceof Wt&&n._bypassWebAudio))))throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){var n;const i=!b("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding,r=hs(hs({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():Jg(e,r);const o=ut(8,"track-low-"),a=new yt(s,hs(hs({},i&&{scaleResolutionDownBy:Ig(r,e)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return a.on($o.TRANSCEIVER_UPDATED,(c=>{e._updateRtpTransceiver(c,Ec.LOW_STREAM)})),a._hints.push(ct.LOW_STREAM),X(n=e._hints).call(n,ct.SCREEN_TRACK)&&a._hints.push(ct.SCREEN_LOW_TRACK),e.on("sei-to-send",(c=>{a.emit("sei-to-send",c)})),e.addListener(me.NEED_CLOSE,(()=>{a.close()})),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof Ui){var r,s,o,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:u}=this.connection,{local:h,remote:p}=await this.connection.getSelectedCandidatePair();pe.pcStats(this.store.sessionId,{startTime:c,eventElapse:e-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:u,intSucc:t?1:2,error:this._iceError||i||"",selectedLocalCandidateProtocol:(r=h?.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(s=h.candidateType)!==null&&s!==void 0?s:"",selectedLocalCandidateAddress:"".concat(h.address,":").concat(h.port),selectedRemoteCandidateProtocol:(o=p.protocol)!==null&&o!==void 0?o:"",selectedRemoteCandidateType:(a=p.candidateType)!==null&&a!==void 0?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:n,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameRender(e){const t=this.store.keyMetrics,n=t.firstVideoFrameDecoded.find((l=>l.userId===e.uid));if(!n)return;const{isInternalUpload:i,isExternalUpload:r}=n;if(i&&r)return;const{subscribeEnd:s,firstPreRender:o,peerPublishDuration:a,peerPubStatusMs:c}=n;let{firstRender:d=0}=n;if(s&&(d||o)&&a&&c){n.isInternalUpload=!0;const{playEnd:l}=n;l&&(n.isExternalUpload=!0);const{firstPreRender:u=0}=n;d=u||d;const h=e.videoTrack,p={peer:e._uintid,width:h?._videoWidth||0,height:h?._videoHeight||0,ssrc:e._videoSSRC||0,p2pid:this.store.p2pId,peerPublishDuration:a,peerPubStatusMs:c,joinChannelStart:t.joinStart||0,preloadStart:t.preloadStart||0,preloadEnd:t.preloadEnd||0,apStart:t.requestAPStart||0,apEnd:t.requestAPEnd||0,suaEnd:t.requestSUAEnd||0,beforeConnect:t.beforeConnect||0,peerReceiver:t.peerReceiver||0,ice:t.iceConnectionEnd||0,pc:t.peerConnectionEnd||0,signalConnected:t.signalConnected||0,joinReq:t.joinReq||0,joinRes:t.joinRep||0,userJoinNotify:n.userJoinNotify||0,videoAddNotify:n.videoAddNotify||0,subscribeStart:n.subscribeStart||0,subscribeEnd:n.subscribeEnd||0,firstReceived:n.firstReceived||0,firstDecoded:n.firstDecoded||0,firstPreRender:u||0,firstRender:l?Math.max(d,l):Math.max(d,s),playStart:n.playStart||0,playEnd:n.playEnd||0,isPreSub:!(!e._videoSSRC||!this.isPreSubScribe(e._videoSSRC)),isPrePc:this.isPreallocation(),isPreInstantVideo:fA(this.store),firstReceivedEncodedFrame:n.firstReceivedEncodedFrame||0,frameType:n.frameType||"",rtpTimestamp:n.rtpTimestamp||0,framePayloadType:n.framePayloadType||0,frameDataLength:n.frameDataLength||0,mimeType:n.mimeType||""};pe.firstXLAPeerFirstVideoFrame(this.store.sessionId,p)}}reportVideoFirstFrameDecoded(e,t,n,i){var r;const s=Array.from(Bn(r=this.remoteUserMap).call(r)).find((o=>o._videoSSRC===e));if(s){i||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,a=o.subscribe.find((c=>c.userId===s.uid&&c.type==="video"));pe.firstRemoteVideoDecode(this.store.sessionId,rn.FIRST_VIDEO_DECODE,Dt.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:t,videoheight:n,subscribeElapse:xn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0,firstFrame:a?.firstFrame||0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.connection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const s=await this.connection.getRemoteSSRC(r);return s!==void 0&&s!==n}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:n}]=e;t===J.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,Ec.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}},re(He.prototype,"startP2PConnection",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"startP2PConnection"),He.prototype),re(He.prototype,"connect",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"connect"),He.prototype),re(He.prototype,"updateRemoteRTPCapabilities",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"updateRemoteRTPCapabilities"),He.prototype),re(He.prototype,"publishDataChannel",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"publishDataChannel"),He.prototype),re(He.prototype,"unpublish",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"unpublish"),He.prototype),re(He.prototype,"unpublishDataChannel",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"unpublishDataChannel"),He.prototype),re(He.prototype,"unpublishLowStream",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"unpublishLowStream"),He.prototype),re(He.prototype,"subscribeDataChannel",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"subscribeDataChannel"),He.prototype),re(He.prototype,"subscribe",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"subscribe"),He.prototype),re(He.prototype,"massSubscribe",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"massSubscribe"),He.prototype),re(He.prototype,"unsubscribe",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"unsubscribe"),He.prototype),re(He.prototype,"unsubscribeDataChannel",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"unsubscribeDataChannel"),He.prototype),re(He.prototype,"massUnsubscribe",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"massUnsubscribe"),He.prototype),re(He.prototype,"muteRemote",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"muteRemote"),He.prototype),re(He.prototype,"unmuteRemote",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"unmuteRemote"),He.prototype),re(He.prototype,"hasRemoteMediaWithLock",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"hasRemoteMediaWithLock"),He.prototype),re(He.prototype,"disconnectForReconnect",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"disconnectForReconnect"),He.prototype),re(He.prototype,"updateBitrateLimit",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"updateBitrateLimit"),He.prototype),re(He.prototype,"remoteMediaSsrcChanged",[Hn],Object.getOwnPropertyDescriptor(He.prototype,"remoteMediaSsrcChanged"),He.prototype),He);function Hn(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From P2PChannel.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}function XN(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function JN(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?XN(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):XN(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const WH=Date.now(),GH=20,$g=new Map,pp=new Map;async function QN(e){const t=$g.get(e),n=Array.isArray(t)&&t[t.length-1],i=pp.get(e);if(!n)return void(i.isSyncing=!1);const r={uid:n.uid,payload:n.payload};i.firstRecvTs===0&&(i.firstRecvTs=n.recvTs,i.firstSendTs=n.sendTs);const s=n.sendTs-i.firstSendTs,o=s-(Date.now()-i.firstRecvTs);o>0&&(i.firstRecvTs=Date.now()-s);let a=n.mediaDelay+o;a<=0?(t.pop(),ZN(n.context,r),a=0):a=Math.min(a,GH),setTimeout((()=>t.length&&QN(e)),a)}function ZN(e,t){e.safeEmit(Be.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function HH(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return ZN(n,{uid:e.uid,payload:e.payload});const i="".concat(n.id,"-").concat(e.uid),r=$g.get(i)||[],s=r.findIndex((d=>e.sendTs>=d.sendTs)),o=JN(JN({},e),{},{context:n,mediaDelay:t,recvTs:Date.now()});s===-1?r.push(o):r.splice(s,0,o),$g.set(i,r);let a=!1;var c;pp.has(i)?a=!((c=pp.get(i))===null||c===void 0||!c.isSyncing):pp.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||QN(i)}const KH=Ze().name;function $N(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function eD(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?$N(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$N(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const jc="websdk_ng_cache_parameter",YH=b("MAX_PRELOAD_ASYNC_LENGTH"),zH=1e4,ha=new Map,pa=[];let eS=null,tS=0,nS=0;const mp=new Map,tD=new Uint8Array([241,141,127,212,103,139,200,225,251,157,127,139,143,2,22,163]),qH=(function(e,t){const n=[];let i=0;const r=async()=>{const s=n.shift();s&&await s(),n.length>0&&i<t?r():i--};return async function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return new ie((async(c,d)=>{n.push((async()=>{try{const l=await e(...o);c(l)}catch(l){d(l)}})),i<t&&(i++,r())}))}})(rS,YH),iS=ii.CancelToken.source();class XH{constructor(){v(this,"_audioContext",null)}createMuteAudioTrack(){this._audioContext=new AudioContext;const t=this._audioContext.sampleRate,n=10*t,i=this._audioContext.createBuffer(2,n,t),r=this._audioContext.createBufferSource();r.buffer=i;const s=this._audioContext.createMediaStreamDestination();return r.connect(s),r.start(),s.stream.getAudioTracks()[0]}close(){this._audioContext&&(this._audioContext.close(),this._audioContext=null)}}async function rS(e,t,n,i,r,s,o){try{if(!b("ENABLE_PRELOAD"))return;if(!We().supportWebCrypto)return void io((()=>{_.warn("Your browser does not support preloading, this feature  be run in a secure environment")}),"preload_webcrypto_not_supported");if(!n&&n!==null)throw new F(w.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&bn(n,"token",1,2047),bn(e,"appid",1,2047),Gh(t),i&&Hh(i);const a=Xo();_.debug("preload channel ".concat(t,", uid is ").concat(i));const c={appId:e,cname:t,token:n||e,uid:typeof i!="string"?i:null,sid:a,proxyServer:r,role:o};let d,l;typeof i=="string"?(c.stringUid=i,[l,d]=await ie.all([NH(i,{sid:a,appId:e},iS.token),bN(eD(eD({},c),{},{token:n||e,uid:0}),iS.token)]),c.uid=l.uid,d.gatewayInfo.uid=c.uid,d.gatewayInfo.res.uid=c.uid):(s&&(c.stringUid=s),d=await bN(c,iS.token));const u={sid:a,appId:e,cname:t,token:n||e,uid:c.stringUid||i,intUid:c.uid||d.gatewayInfo.uid,stringUid:c.stringUid,ts:Date.now(),sua:l,ap:d};await oS(u),tS++}catch(a){throw nS++,(function(c){eS||(eS=window.setTimeout((()=>{let l="";mp.forEach(((u,h)=>{l+="".concat(h,": ").concat(u," ;")})),pe.reportApiInvoke(null,{name:Nt.PRELOAD,options:{success:tS,failed:nS,err:l}}).onError(c),tS=0,nS=0,mp.clear(),eS=null}),zH));const d=mp.get(c.code)||0;mp.set(c.code,d+1)})(a),a}}async function sS(e){try{if(b("AP_REQUEST_DETAIL")||b("ENABLE_ROLE_SELECT_EDGE"))return;const t=nD(e);if(!t||e.cloudProxyServer!=="disabled")return;const n=await(async function(i,r){try{const s=await window.crypto.subtle.importKey("raw",Gw(r),"AES-GCM",!1,["decrypt"]),o=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:tD},s,qo(i));return JSON.parse(window.atob(ro(new Uint8Array(o))))}catch{return}})(t,e.token||e.appId);if(!n||!(function(i,r){return i.cname===r.cname&&i.appId===r.appId&&i.token===r.token?r.stringUid?i.stringUid===r.stringUid:typeof r.uid=="number"?i.uid===r.uid:i.uid==r.uid:!1})(n,e))return;if(n&&Date.now()-n.ts<b("AP_CACHE_LIFETIME"))return n}catch(t){_.warn("Error get preloadInfo",t.message)}}function nD(e){let t;try{if(t=sD(jc),!t)return;const n=JSON.parse(t),i=oD(e),r=(function(o,a){for(let c=o.length-1;c>=0;c--)if(a(o[c]))return c;return-1})(n,(o=>i in o));if(r===-1)return;const s=n.splice(r,1)[0];return fp(jc,JSON.stringify(n)),s[i]}catch(n){_.warn("Error delete preload info: ".concat(t),n.message),fp(jc,"")}}async function oS(e){let t;try{e.uid&&nD({appId:e.appId,cname:e.cname,token:e.token,uid:e.uid,stringUid:e.stringUid});const n=oD(e),i=await(async function(s,o){try{const a=await window.crypto.subtle.importKey("raw",Gw(o),"AES-GCM",!1,["encrypt"]),c=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:tD},a,qo(window.btoa(JSON.stringify(s))));return ro(new Uint8Array(c))}catch{return}})(e,e.token||e.appId);if(!i)return;t=sD(jc);const r=t?JSON.parse(t):[];r.push({[n]:i}),r.length>b("AP_CACHE_NUM")&&r.shift(),fp(jc,JSON.stringify(r))}catch(n){_.warn("Error caching server parameters:",n.message),fp(jc,"")}}function aS(e){if(e){let t=ha.get(e);t&&(window.clearTimeout(t),t=null,ha.delete(e)),X(pa).call(pa,e)||e.cloudProxyServer!=="disabled"||pa.push(e)}if(ha.size<b("AP_CACHE_NUM")&&pa.length>0){const t=pa.shift();ha.set(t,window.setTimeout((async()=>{const{appId:n,cname:i,token:r,stringUid:s,uid:o,proxyServer:a,role:c}=t;try{await qH(n,i,r,o,a,s,c),ha.has(t)&&aS(t)}catch(d){_.warn("update preload failed",d.message),iD(t)}}),b("AP_UPDATE_INTERVAL")))}}function iD(e){const t=pa.indexOf(e);t!==-1&&pa.splice(t,1);let n=ha.get(e);n&&(window.clearTimeout(n),n=null,ha.delete(e),aS())}function rD(e,t){const n=e.sua,i=e.ap;t&&n&&pe.reqUserAccount(e.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:t,uid:e.intUid,errorCode:null,extend:n.req}),pe.reportResourceTiming(e.ap.url,e.sid),pe.joinWebProxyAP(e.sid,{lts:i.requestTime,elapse:i.elapse,sucess:1,apServerAddr:i.url,turnServerAddrList:i.proxyInfo.addresses.map((r=>r.ip)).join(","),eventType:"disabled",unilbsServerIds:[Jt.CHOOSE_SERVER,Jt.CLOUD_PROXY_FALLBACK].toString()}),pe.joinChooseServer(e.sid,{lts:i.requestTime,elapse:i.elapse,succ:!0,csAddr:i.url,opid:i.opid,serverList:i.gatewayInfo.gatewayAddrs.map((r=>r.address)),ec:null,cid:i.gatewayInfo.cid.toString(),uid:i.gatewayInfo.uid.toString(),csIp:i.gatewayInfo.csIp,unilbsServerIds:[Jt.CHOOSE_SERVER].toString(),isHttp3:i.isHttp3})}function sD(e){return window.atob(window.localStorage.getItem(e)||"")}function fp(e,t){window.localStorage.setItem(e,window.btoa(t))}function oD(e){let t="".concat(e.appId,"_").concat(e.cname);return typeof e.uid=="string"&&(t+="_s_".concat(e.uid)),typeof e.uid=="number"&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),Jw(t)}function JH(e){let t=(function(){const n=$H.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}})();return(function(n,i){let r=n.appId;r!==void 0&&(Qt(i,10),mo(i,r));let s=n.cid;s!==void 0&&(Qt(i,16),Qt(i,s));let o=n.cname;o!==void 0&&(Qt(i,26),mo(i,o));let a=n.deviceId;a!==void 0&&(Qt(i,34),mo(i,a));let c=n.elapse;c!==void 0&&(Qt(i,40),fo(i,c));let d=n.fileSize;d!==void 0&&(Qt(i,48),fo(i,Fc(d)));let l=n.height;l!==void 0&&(Qt(i,56),fo(i,Fc(l)));let u=n.jpg;u!==void 0&&(Qt(i,66),Qt(i,u.length),cD(i,u));let h=n.networkType;h!==void 0&&(Qt(i,72),fo(i,Fc(h)));let p=n.osType;p!==void 0&&(Qt(i,80),fo(i,Fc(p)));let R=n.requestId;R!==void 0&&(Qt(i,90),mo(i,R));let T=n.sdkVersion;T!==void 0&&(Qt(i,98),mo(i,T));let y=n.sequence;y!==void 0&&(Qt(i,104),fo(i,Fc(y)));let I=n.sid;I!==void 0&&(Qt(i,114),mo(i,I));let A=n.timestamp;A!==void 0&&(Qt(i,120),fo(i,A));let N=n.uid;N!==void 0&&(Qt(i,128),Qt(i,N));let k=n.vid;k!==void 0&&(Qt(i,136),Qt(i,k));let x=n.width;x!==void 0&&(Qt(i,144),fo(i,Fc(x)));let P=n.service;P!==void 0&&(Qt(i,152),Qt(i,P));let M=n.callbackData;M!==void 0&&(Qt(i,162),Qt(i,M.length),cD(i,M));let G=n.ticket;G!==void 0&&(Qt(i,170),mo(i,G));let Y=n.vendorConfigs;Y!==void 0&&(Qt(i,178),mo(i,Y))})(e,t),(function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)})(t)}function QH(e){return(function(n){let i={};e:for(;!eK(n);){let r=cl(n);switch(r>>>3){case 0:break e;case 1:i.code=cl(n);break;case 2:i.msg=dD(n,cl(n));break;case 3:i.requestId=dD(n,cl(n));break;case 4:i.timestamp=tK(n,!1);break;default:ZH(n,7&r)}}return i})({bytes:t=e,offset:0,limit:t.length});var t}function ZH(e,t){switch(t){case 0:for(;128&Er(e););break;case 2:cS(e,cl(e));break;case 5:cS(e,4);break;case 1:cS(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function Fc(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let $H=[];function cS(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function eK(e){return e.offset>=e.limit}function _p(e,t){let n=e.bytes,i=e.offset,r=e.limit,s=i+t;if(s>n.length){let o=new Uint8Array(2*s);o.set(n),e.bytes=o}return e.offset=s,s>r&&(e.limit=s),i}function aD(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function cD(e,t){let n=_p(e,t.length);e.bytes.set(t,n)}function dD(e,t){let n=aD(e,t),i=String.fromCharCode,r=e.bytes,s="",o="";for(let a=0;a<t;a++){let c,d,l,u,h=r[a+n];(128&h)==0?o+=i(h):(224&h)==192?a+1>=t?o+=s:(c=r[a+n+1],(192&c)!=128?o+=s:(u=(31&h)<<6|63&c,u<128?o+=s:(o+=i(u),a++))):(240&h)==224?a+2>=t?o+=s:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?o+=s:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?o+=s:(o+=i(u),a+=2))):(248&h)==240?a+3>=t?o+=s:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?o+=s:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?o+=s:(u-=65536,o+=i(55296+(u>>10),56320+(1023&u)),a+=3))):o+=s}return o}function mo(e,t){let n=t.length,i=0;for(let o=0;o<n;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+t.charCodeAt(++o)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}Qt(e,i);let r=_p(e,i),s=e.bytes;for(let o=0;o<n;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+t.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function Er(e){return e.bytes[aD(e,1)]}function lD(e,t){let n=_p(e,1);e.bytes[n]=t}function cl(e){let t,n=0,i=0;do t=Er(e),n<32&&(i|=(127&t)<<n),n+=7;while(128&t);return i}function Qt(e,t){for(t>>>=0;t>=128;)lD(e,127&t|128),t>>>=7;lD(e,t)}function tK(e,t){let n,i=0,r=0,s=0;return n=Er(e),i=127&n,128&n&&(n=Er(e),i|=(127&n)<<7,128&n&&(n=Er(e),i|=(127&n)<<14,128&n&&(n=Er(e),i|=(127&n)<<21,128&n&&(n=Er(e),r=127&n,128&n&&(n=Er(e),r|=(127&n)<<7,128&n&&(n=Er(e),r|=(127&n)<<14,128&n&&(n=Er(e),r|=(127&n)<<21,128&n&&(n=Er(e),s=127&n,128&n&&(n=Er(e),s|=(127&n)<<7))))))))),{low:i|r<<28,high:r>>>4|s<<24,unsigned:t}}function fo(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,s=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,o=_p(e,s),a=e.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?i>>>21|128:i>>>21&127;case 7:a[o+6]=s!==7?i>>>14|128:i>>>14&127;case 6:a[o+5]=s!==6?i>>>7|128:i>>>7&127;case 5:a[o+4]=s!==5?128|i:127&i;case 4:a[o+3]=s!==4?n>>>21|128:n>>>21&127;case 3:a[o+2]=s!==3?n>>>14|128:n>>>14&127;case 2:a[o+1]=s!==2?n>>>7|128:n>>>7&127;case 1:a[o]=s!==1?128|n:127&n}}const uD={},hD={},Ep=4294967296,nK=Ep*Ep,pD=nK/2;fD(0,!0);const mD=fD(0),iK=dl(0,-2147483648,!1),rK=dl(-1,2147483647,!1);function fD(e,t){let n,i,r;return t?(r=0<=(e>>>=0)&&e<256)&&(i=hD[e],i)?i:(n=dl(e,0,!0),r&&(hD[e]=n),n):(r=-128<=(e|=0)&&e<128)&&(i=uD[e],i)?i:(n=dl(e,e<0?-1:0,!1),r&&(uD[e]=n),n)}function dl(e,t,n){return{low:0|e,high:0|t,unsigned:!!n}}function _D(e,t){if(isNaN(e))return mD;{if(e<=-pD)return iK;if(e+1>=pD)return rK}return e<0?mD:dl(e%Ep|0,e/Ep|0,t)}function ED(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}class dS extends kt{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const n=this._connectionState;this._connectionState=t,this.emit(Mr.CONNECTION_STATE_CHANGE,t,n)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(t){var n;super(),v(this,"name","AgoraRTCImageModeration"),v(this,"_connectionState",qi.CONNECTING),v(this,"_sequence",0),v(this,"_moderationStartTime",void 0),v(this,"_workerConnection",void 0),v(this,"_workerMessageLengthLimit",void 0),v(this,"_qualityRatio",void 0),v(this,"_connectInfo",void 0),v(this,"_cancelTokenSource",ii.CancelToken.source()),v(this,"_retryConfig",void 0),v(this,"_moderationInterval",void 0),v(this,"_moderationTimer",null),v(this,"_moderationMode",1),v(this,"_quality",1),v(this,"_qualityTimer",null),v(this,"_ticket",void 0),v(this,"_moderationIntervalMinimum",void 0),v(this,"_uploadFailedNum",0),v(this,"_uploadNum",0),v(this,"_uploadTimer",null),v(this,"_extraInfo",void 0),v(this,"_vendor",""),v(this,"_encoder",new TextEncoder),v(this,"_moderationId",void 0),v(this,"inspectImage",(()=>{if(this.connectionState!==qi.CONNECTED)throw new V(w.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===qi.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()})),this._moderationId=ut(5,"image-moderation-"),this._workerMessageLengthLimit=b("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=b("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=t.interval)!==null&&n!==void 0?n:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=b("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Jd("worker-"+this._moderationId,Xt),this.on(Mr.STATE_CHANGE,((i,r)=>{_.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Ac[i]," ").concat(r||""))})),this.handleWorkerEvents()}async init(t,n){this.emit(Mr.STATE_CHANGE,Ac.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=n,new ie(((r,s)=>{this.on(Mr.CONNECTION_STATE_CHANGE,((o,a)=>{o===qi.CONNECTED&&r()})),this.requestAP(t,i,n).then((o=>{this.connectWorker(o)})).catch((o=>{s(o)}))}))}updateConfig(t){var n;this._moderationInterval=(n=t.interval)!==null&&n!==void 0?n:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),_.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===qi.CONNECTED&&this.inspectImage()}async requestAP(t,n,i){const r=b("WEBCS_DOMAIN").map((c=>"https://".concat(c,"/api/v1"))),s=await(function(c,d,l,u){let{appId:h,areaCode:p,cname:R,sid:T,token:y,uid:I}=d;Lc++;const A="moderation_plugin",N={service_name:A,json_body:JSON.stringify({appId:h,areaCode:p,cname:R,command:"allocateEdge",requestId:Lc,seq:Lc,sid:T,appToken:y,ts:Date.now(),uid:I+""})};let k,x,P=c[0];return Pr((async()=>{k=Date.now();const M=await Vr(P,{data:N,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(x=Date.now()-k,M.code!==0){const Ce=new V(w.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+M.code,{retry:!0,responseTime:x});throw _.error(Ce.toString()),Ce}const G=JSON.parse(M.json_body);if(G.code!==200){const Ce=new V(w.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(G.code,", reason: ").concat(G.reason),{code:G.code,responseTime:x});throw _.error(Ce.toString()),Ce}if(!G.servers||!Array.isArray(G.servers)||G.servers.length===0){const Ce=new V(w.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:G.code,responseTime:x});throw _.error(Ce.toString()),Ce}if(!G.servers.some((Ce=>!!Ce.wss))){const Ce=new V(w.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:G.code,responseTime:x});throw _.error(Ce.toString()),Ce}const Y=b("IMAGE_MODERATION_WORKER_WSS");if(Y)return{addressList:[Y],workerToken:G.workerToken,vid:G.vid,responseTime:x};const de=b("IMAGE_MODERATION_WORKER_HOST");return{addressList:G.servers.map((Ce=>{let{address:Ue,wss:Pe}=Ce;if(Ue&&Pe)return"wss://".concat(Ue.replace(/\./g,"-"),".").concat(de,":").concat(Pe,"/moderation")})).filter((Ce=>!!Ce)),workerToken:G.workerToken,vid:G.vid,ticket:G.appTicket,responseTime:x}}),((M,G)=>(pe.apworkerEvent(T,{success:!0,sc:200,serviceName:A,responseDetail:JSON.stringify(M.addressList),firstSuccess:G===0,responseTime:x,serverIp:c[G%c.length]}),!1)),((M,G)=>(pe.apworkerEvent(T,{success:!1,sc:M.data&&M.data.code||200,serviceName:A,responseTime:x,serverIp:c[G%c.length]}),!!(M.code!==w.OPERATION_ABORTED&&M.code!==w.UNEXPECTED_RESPONSE||M.data&&M.data.retry)&&(P=c[(G+1)%c.length],!0))),u)})(r,t,n,i);this.emit(Mr.STATE_CHANGE,Ac.AP_CONNECTED);const{addressList:o,ticket:a}=s;return this._ticket=a,o}async connectWorker(t){this.emit(Mr.STATE_CHANGE,Ac.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(Le.CONNECTED,(async()=>{this.emit(Mr.STATE_CHANGE,Ac.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=qi.CONNECTED})),this._workerConnection.on(Le.CLOSED,(()=>{this.connectionState=qi.CLOSED})),this._workerConnection.on(Le.FAILED,(()=>{this.connectionState=qi.CLOSED})),this._workerConnection.on(Le.RECONNECTING,(()=>{this.connectionState=this.connectionState===qi.CONNECTED?qi.RECONNECTING:qi.CONNECTING})),this._workerConnection.on(Le.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const n=QH(new Uint8Array(t.data));b("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,_.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{pe.reportApiInvoke(this._connectInfo.sid||null,{name:Nt.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:Tt.TRACER}).onError(new V(w.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null}),b("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else _.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(Le.WILL_RECONNECT,((t,n,i)=>{t==="recover"&&i(t),i("tryNext")})),this._workerConnection.on(Le.REQUEST_NEW_URLS,((t,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(n)}))}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=vi(this,Mr.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(b("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being played can be inspected"));this._sequence++;const i=await this.generateRequestData(t,n);this._workerConnection.sendMessage(i,!0,!0)}else b("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being published can be inspected")}async generateRequestData(t,n){let{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c}=n;const d=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),u=await BA(l,i,r),h=this._sequence+"-"+s+"-"+c+"-"+d+"-"+ut(12,""),p={appId:i,cid:s,cname:r,deviceId:"",elapse:dS.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.24.2",sequence:this._sequence,sid:a,timestamp:_D(d),uid:c,vid:o,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete p.callbackData;const R=JH(p);if(R.byteLength<this._workerMessageLengthLimit){if(b("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const T=(function(y){for(var I=1;I<arguments.length;I++){var A=arguments[I]!=null?arguments[I]:{};I%2?ED(Object(A),!0).forEach((function(N){v(y,N,A[N])})):Object.getOwnPropertyDescriptors?Object.defineProperties(y,Object.getOwnPropertyDescriptors(A)):ED(Object(A)).forEach((function(N){Object.defineProperty(y,N,Object.getOwnPropertyDescriptor(A,N))}))}return y})({},p);delete T.jpg,_.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(T))}return R}{const T=this.quality*this._qualityRatio;return this.quality=T,await this.generateRequestData(t,{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ii.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=qi.CLOSED,this.emit(Mr.STATE_CHANGE,Ac.CLOSED)}}function gD(e){if(St(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new V(w.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(e&&e.vendor&&e.vendor.length>1024)throw new V(w.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const sK={name:"ImageModeration",create:function(e){let{config:t}=e;return gD(t),new dS(t)}};var SD,TD,yD,vD,RD,CD,bD,ID,wD,AD,OD,ND,DD,PD,LD,kD,xD,MD,UD,VD,jD,FD,BD,WD,GD,HD,KD,YD,zD,qD,XD,JD,QD,ZD,$D,eP,tP,nP,iP,rP,sP,oP,le;function aP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function gr(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?aP(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):aP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}gn.setLogger(_);let oK=(SD=ve(),TD=ve({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof Tc))return[t];t=[t]}return t.map((n=>n?Object(n).toString():"null"))}}),yD=ve({argsMap:(e,t)=>(t||(t=[]),Array.isArray(t)||t.trackMediaType!==Sc.DATA?(Array.isArray(t)||(t=[t]),t.map((n=>n.getTrackId()))):[t.getChannelId()])}),vD=ve({argsMap:(e,t,n,i)=>[typeof t=="object"?t.uid:t,n,i]}),RD=ve({argsMap:(e,t,n)=>[t,n]}),CD=ve({argsMap:(e,t)=>t.map((n=>{let{user:i,mediaType:r}=n;return[i?.uid,r]}))}),bD=ve({argsMap:(e,t,n,i)=>[typeof t=="object"?t.uid:t,n,i]}),ID=ve({argsMap:(e,t)=>t.map((n=>{let{user:i,mediaType:r}=n;return{uid:i?.uid,mediaType:r}}))}),wD=ve(),AD=ve(),OD=ve(),ND=ve(),DD=ve(),PD=ve(),LD=ve(),kD=ve(),xD=ve(),MD=ve(),UD=ve(),VD=ve(),jD=ve(),FD=ve(),BD=ve(),WD=ve(),GD=ve({argsMap:(e,t)=>[t]}),HD=ve(),KD=ve(),YD=ve(),zD=ve(),qD=ve(),XD=ve(),JD=ve(),QD=ve(),ZD=ve({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),$D=ve(),eP=ve(),tP=ve(),nP=ve(),iP=ve(),rP=ve(),sP=ve({reportResult:!0}),oP=ve(),le=class extends kt{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e,t){let n;if(super(),v(this,"store",void 0),v(this,"_uid",void 0),v(this,"_channelName",void 0),v(this,"_uintUid",void 0),v(this,"_users",[]),v(this,"_config",void 0),v(this,"_clientId",void 0),v(this,"_appId",void 0),v(this,"_sessionId",null),v(this,"_key",void 0),v(this,"_rtmConfig",{}),v(this,"_joinInfo",void 0),v(this,"_gateway",void 0),v(this,"_statsCollector",void 0),v(this,"_configDistribute",void 0),v(this,"_leaveMutex",void 0),v(this,"_publishMutex",void 0),v(this,"_renewTokenMutex",void 0),v(this,"_subscribeMutex",void 0),v(this,"_encryptionMode","none"),v(this,"_encryptionSecret",null),v(this,"_encryptionSalt",null),v(this,"_encryptDataStream",!1),v(this,"_encryptDataStreamKey",null),v(this,"_encryptDataStreamIv",null),v(this,"_proxyServer",void 0),v(this,"_turnServer",{servers:[],mode:"auto"}),v(this,"_cloudProxyServerMode","disabled"),v(this,"_isDualStreamEnabled",!1),v(this,"_defaultStreamFallbackType",void 0),v(this,"_lowStreamParameter",void 0),v(this,"_streamFallbackTypeCacheMap",new Map),v(this,"_remoteStreamTypeCacheMap",new Map),v(this,"_axiosCancelSource",ii.CancelToken.source()),v(this,"_audioVolumeIndicationInterval",void 0),v(this,"_networkQualityInterval",void 0),v(this,"_userOfflineTimeout",void 0),v(this,"_streamRemovedTimeout",void 0),v(this,"_rteDetailInterval",void 0),v(this,"_liveTranscodeStreamingClient",void 0),v(this,"_liveRawStreamingClient",void 0),v(this,"_channelMediaRelayClient",void 0),v(this,"_networkQualitySensitivity","normal"),v(this,"_p2pChannel",void 0),v(this,"_useLocalAccessPoint",!1),v(this,"_setLocalAPVersion",void 0),v(this,"_joinAndNotLeaveYet",!1),v(this,"_numberOfJoinCount",0),v(this,"_joinResponse",null),v(this,"_remoteDefaultVideoStreamType",void 0),v(this,"_inspect",void 0),v(this,"_moderation",void 0),v(this,"_license",void 0),v(this,"_pendingPublishedUsers",[]),v(this,"ntpAlignErrorCount",0),v(this,"remoteInboundOffset",0),v(this,"_peerConnectionState",void 0),v(this,"_pendingRtpCapabilityChange",void 0),v(this,"_fallbackServerInfo",void 0),v(this,"_dualStreamMode",void 0),v(this,"_handleLocalTrackEnable",((r,s,o)=>{this.publish(r,!1).then(s).catch(o)})),v(this,"_handleLocalTrackDisable",((r,s,o)=>{this.unpublish(r).then(s).catch(o)})),v(this,"_handleUserOnline",(r=>{if(b("BLOCK_LOCAL_CLIENT")&&sa(r.uid,this.channelName))return void _.debug("[".concat(r.uid,"] will be ignored in local"));this.isStringUID&&typeof r.uid!="string"&&_.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const s=this._users.find((o=>o.uid===r.uid));if(s)s._trust_in_room_=!0,s._is_pre_created&&(s._is_pre_created=!1,this.safeEmit(Be.USER_JOINED,s));else{const o=new ho(r.uid,r.uint_id||r.uid);this._users.push(o),_.debug("[".concat(this._clientId,"] user online"),r.uid),this.store.firstVideoFrameDecoded(o.uid,{userJoinNotify:Date.now()}),this.safeEmit(Be.USER_JOINED,o)}})),v(this,"_handleUserOffline",(r=>{if(b("BLOCK_LOCAL_CLIENT")&&sa(r.uid,this.channelName))return;const s=this._users.find((o=>o.uid===r.uid));s&&(this._handleRemoveStream(r),this._handleRemoveDataChannels(r),s._audio_pre_subscribed||s._video_pre_subscribed?s._is_pre_created=!0:fh(this._users,s),this._remoteStreamTypeCacheMap.delete(s.uid),this._streamFallbackTypeCacheMap.delete(s.uid),_.debug("[".concat(this._clientId,"] user offline"),r.uid,"reason:",r.reason),this.safeEmit(Be.USER_LEAVED,s,r.reason))})),v(this,"_handleAddAudioOrVideoStream",((r,s,o,a,c,d,l,u)=>{if(b("BLOCK_LOCAL_CLIENT")&&sa(s,this.channelName))return;const h=this._users.find((T=>T.uid===s));if(!h)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(r)),this.store.subscribe(h.uid,r,void 0,void 0,void 0,Date.now()),r==="video"&&this.store.firstVideoFrameDecoded(h.uid,{videoAddNotify:Date.now()});const p=r==="audio"?h.hasAudio:h.hasVideo;h._uintid||(h._uintid=d||s),r==="audio"?h._trust_audio_stream_added_state_=!0:h._trust_video_stream_added_state_=!0,r==="audio"?(h._audio_added_=!0,o!==void 0&&(h._audioSSRC=o),a!==void 0&&(h._cname=a),l&&(h._audioOrtc=l)):(h._video_added_=!0,o!==void 0&&(h._videoSSRC=o),a!==void 0&&(h._cname=a),u!==void 0&&(h._rtxSsrcId=u),l&&(h._videoOrtc=l)),(r==="audio"?h.hasAudio:h.hasVideo)&&!p&&(_.info("[".concat(this._clientId,"] remote user ").concat(h.uid," published ").concat(r)),this.safeEmit(Be.USER_PUBLISHED,h,r)),r==="video"?pe.onGatewayStream(this._sessionId,rn.ON_ADD_VIDEO_STREAM,Dt.ON_ADD_VIDEO_STREAM,{peer:d||s,ssrc:h._videoSSRC}):pe.onGatewayStream(this._sessionId,rn.ON_ADD_AUDIO_STREAM,Dt.ON_ADD_AUDIO_STREAM,{peer:d||s,ssrc:h._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(h,r,o).then((T=>{if(T&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(h.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof ua))return this._p2pChannel.unsubscribe(h,r,!0).then((()=>this._subscribe(h,r,!0).catch((y=>{_.error("[".concat(this._clientId,"] resubscribe error"),y.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(h,r)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(h.uid," after reconnect.")),this._subscribe(h,r,!0).catch((T=>{_.error("[".concat(this._clientId,"] resubscribe error"),T.toString())})));const R=this._getEncodingName(c);r==="video"&&(R==="unknown"?this.safeEmit(Be.AV1_DECODABLE_RESULT,!1):En()||Fn()||R?.toLocaleLowerCase()!==Qo.av1||OH().then((T=>{b("FLS_ENABLE_AV1_DECODE_DETECT")&&this.safeEmit(Be.AV1_DECODABLE_RESULT,T),T||this._gateway.downgradeCodec(R)})))})),v(this,"_handleRemoveStream",(r=>{if(b("BLOCK_LOCAL_CLIENT")&&sa(r.uid,this.channelName))return;const s=this._users.find((a=>a.uid===r.uid));if(!s)return void _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));_.debug("[".concat(this._clientId,"] stream removed with uid ").concat(r.uid));let o=()=>{};s.hasAudio&&s.hasVideo?o=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(Be.USER_UNPUBLISHED,s,"audio"),_.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(Be.USER_UNPUBLISHED,s,"video")}:s.hasVideo?o=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(Be.USER_UNPUBLISHED,s,"video")}:s.hasAudio&&(o=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(Be.USER_UNPUBLISHED,s,"audio")}),s._video_pre_subscribed||s._audio_pre_subscribed||(s._trust_audio_stream_added_state_=!0,s._trust_video_stream_added_state_=!0,s._audio_added_=!1,s._video_added_=!1,this._p2pChannel instanceof ua&&this._p2pChannel.unsubscribe(s).then((a=>{if(a)return this._gateway.unsubscribe(a,s.uid)})),s._audioSSRC=void 0,s._videoSSRC=void 0,s._audioOrtc=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),pe.onGatewayStream(this._sessionId,rn.ON_REMOVE_STREAM,Dt.ON_REMOVE_STREAM,{peer:r.uint_id||r.uid}),o()})),v(this,"_handleSetStreamLocalEnable",((r,s,o)=>{if(b("BLOCK_LOCAL_CLIENT")&&sa(s,this.channelName))return;const a=this._users.find((l=>l.uid===s));if(!a)return void _.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));_.debug("[".concat(this._clientId,"] local ").concat(r," ").concat(o?"enabled":"disabled"," with uid ").concat(s));const c=r==="audio"?a.hasAudio:a.hasVideo;if(r==="audio"){a._trust_audio_enabled_state_=!0;const l=a._audio_enabled_;if(a._audio_enabled_=o,a._audio_enabled_===l)return;{const u=a._audio_enabled_?"enable-local-audio":"disable-local-audio";_.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(s,", msg: ").concat(u)),this.safeEmit(Be.USER_INFO_UPDATED,s,u)}}else{a._trust_video_enabled_state_=!0;const l=a._video_enabled_;if(a._video_enabled_=o,a._video_enabled_===l)return;{const u=a._video_enabled_?"enable-local-video":"disable-local-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(s,", msg: ").concat(u)),this.safeEmit(Be.USER_INFO_UPDATED,s,u)}}const d=r==="audio"?a.hasAudio:a.hasVideo;return c!==d?!c&&d?(_.info("[".concat(this._clientId,"] remote user ").concat(s," published ").concat(r)),void this.safeEmit(Be.USER_PUBLISHED,a,r)):(r==="video"&&a._videoTrack&&a._videoTrack._destroy(),r==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,r),_.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished ").concat(r)),void this.safeEmit(Be.USER_UNPUBLISHED,a,r)):void 0})),v(this,"_handleMuteStream",((r,s,o)=>{if(b("BLOCK_LOCAL_CLIENT")&&sa(r,this.channelName))return;_.debug("[".concat(this._clientId,"] receive mute message"),r,s,o);const a=this._users.find((l=>l.uid===r));if(!a)return void _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r));const c=s==="audio"?a.hasAudio:a.hasVideo;if(s==="audio"){a._trust_audio_mute_state_=!0;const l=a._audio_muted_;if(a._audio_muted_=o,a._audio_muted_===l)return;{const u=a._audio_muted_?"mute-audio":"unmute-audio";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(Be.USER_INFO_UPDATED,r,u)}}else{a._trust_video_mute_state_=!0;const l=a._video_muted_;if(a._video_muted_=o,a._video_muted_===l)return;{const u=a._video_muted_?"mute-video":"unmute-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(Be.USER_INFO_UPDATED,r,u)}}const d=s==="audio"?a.hasAudio:a.hasVideo;if(c!==d){if(!c&&d)return(s==="audio"?a._audioSSRC:a._videoSSRC)?(_.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(s)),void this.safeEmit(Be.USER_PUBLISHED,a,s)):void _.warning("[".concat(this._clientId,"] remote user ").concat(r," receive ").concat(s," unmute message  before add stream message, ").concat(s," SSRC doesn't exist yet."));s==="video"&&a._videoTrack&&!a._video_pre_subscribed&&a._videoTrack._destroy(),s==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,s),_.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(s)),this.safeEmit(Be.USER_UNPUBLISHED,a,s)}})),v(this,"_handleP2PLost",(async r=>{_.debug("[".concat(this._clientId,"] receive p2p lost"),r),parseInt(r.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():_.warning("[".concat(this._clientId,"] P2PLost stream not found"),r)})),v(this,"_handleTokenWillExpire",(()=>{_.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Be.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)})),v(this,"_handleBeforeUnload",(r=>{r.type==="beforeunload"&&r.returnValue!==void 0&&r.returnValue!==""||(this.leave(),_.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))})),v(this,"_handleUpdateNetworkQuality",(()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(Be.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const r={downlinkNetworkQuality:0,uplinkNetworkQuality:0};r.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),r.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Be.NETWORK_QUALITY,r)})),v(this,"_handleP2PAddAudioOrVideoStream",((r,s,o,a)=>{const c=this._users.find((l=>l.uid===s));if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(r)),this.store.subscribe(c.uid,r,void 0,void 0,void 0,Date.now());const d=r==="audio"?c.hasAudio:c.hasVideo;r==="audio"?c._trust_audio_stream_added_state_=!0:c._trust_video_stream_added_state_=!0,r==="audio"?(c._audio_added_=!0,o!==void 0&&(c._audioSSRC=o),a!==void 0&&(c._audioMid=a)):(c._video_added_=!0,o!==void 0&&(c._videoSSRC=o),a!==void 0&&(c._videoMid=a)),(r==="audio"?c.hasAudio:c.hasVideo)&&!d&&(_.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published ").concat(r)),this.safeEmit(Be.USER_PUBLISHED,c,r)),this._p2pChannel.hasPendingRemoteMedia(c,r)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(c.uid," after reconnect.")),this._subscribe(c,r,!0).catch((l=>{_.error("[".concat(this._clientId,"] resubscribe error"),l.toString())})))})),this._config=e,this._clientId=t||ut(5,"client-"),this.store=new class{constructor(r,s,o,a,c){Ne(this,"state",void 0),this.state={codec:r,audioCodec:s,mode:o,clientId:a,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[],firstVideoFrameDecoded:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:Jo.Default,hasStartJoinChannel:!1,isABTestSuccess:!1,rteUrl:void 0,rteSid:void 0,autoSubscribe:!1,enableInstantMuteRestore:!1,networkQualityProbe:!1,useDcSignal:!!c}}dispatch(r){this.state=(function(s,o){switch(o.type){case we.SET_SESSION_ID:return Z(Z({},s),{},{sessionId:o.sessionId});case we.SET_P2P_ID:return Z(Z({},s),{},{p2pId:o.p2pId});case we.SET_UID:return Z(Z({},s),{},{uid:o.uid});case we.SET_INT_UID:return Z(Z({},s),{},{intUid:o.intUid});case we.SET_PUB_ID:return Z(Z({},s),{},{pubId:o.pubId});case we.KEY_METRIC_CLIENT_CREATED:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{clientCreated:o.metric})});case we.KEY_METRIC_JOIN_START:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{joinStart:o.metric})});case we.KEY_METRIC_PRELOAD_START:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{preloadStart:o.metric})});case we.KEY_METRIC_PRELOAD_END:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{preloadEnd:o.metric})});case we.KEY_METRIC_JOIN_END:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{joinEnd:o.metric})});case we.KEY_METRIC_REQUEST_AP_START:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{requestAPStart:o.metric})});case we.KEY_METRIC_REQUEST_AP_END:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{requestAPEnd:o.metric})});case we.KEY_METRIC_REQUEST_SUA_END:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{requestSUAEnd:o.metric})});case we.KEY_METRIC_BEFORE_CONNECT:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{beforeConnect:o.metric})});case we.KEY_METRIC_PEER_RECEIVER:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{peerReceiver:o.metric})});case we.KEY_METRIC_SIGNAL_CONNECTED:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{signalConnected:o.metric})});case we.KEY_METRIC_JOIN_REQ:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{joinReq:o.metric})});case we.KEY_METRIC_JOIN_REP:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{joinRep:o.metric})});case we.KEY_METRIC_JOIN_GATEWAY_START:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{joinGatewayStart:o.metric})});case we.KEY_METRIC_JOIN_GATEWAY_END:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{joinGatewayEnd:o.metric})});case we.KEY_METRIC_PEER_CONNECTION_START:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{peerConnectionStart:o.metric})});case we.KEY_METRIC_PEER_CONNECTION_END:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{peerConnectionEnd:o.metric})});case we.KEY_METRIC_DESCRIPTION_START:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{descriptionStart:o.metric})});case we.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{signalChannelOpen:o.metric})});case we.KEY_METRIC_ICE_CONNECTION_END:return Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{iceConnectionEnd:o.metric})});case we.KEY_METRIC_PUBLISH:{const a=s.keyMetrics.publish,c=a.findIndex((d=>d.trackId===o.metric.trackId));return c!==-1?(a[c]=Z(Z({},a[c]),o.metric),Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{publish:[...a]})})):Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{publish:[...s.keyMetrics.publish,o.metric]})})}case we.KEY_METRIC_SUBSCRIBE:{const a=s.keyMetrics.subscribe,c=a.findIndex((d=>d.userId===o.metric.userId&&d.type===o.metric.type));return c!==-1?(a[c]=Z(Z({},a[c]),o.metric),Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{subscribe:[...a]})})):Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{subscribe:[...s.keyMetrics.subscribe,o.metric]})})}case we.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED:{const a=s.keyMetrics.firstVideoFrameDecoded,c=a.findIndex((d=>d.userId===o.metric.userId));return c!==-1?(a[c]=Z(Z({},a[c]),o.metric),Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{firstVideoFrameDecoded:[...a]})})):Z(Z({},s),{},{keyMetrics:Z(Z({},s.keyMetrics),{},{firstVideoFrameDecoded:[...s.keyMetrics.firstVideoFrameDecoded,o.metric]})})}case we.RESET_FIRST_VIDEO_FRAME_DECODED:return s.keyMetrics.firstVideoFrameDecoded=[],s;case we.SET_CLOUD_PROXY_SERVER_MODE:return s.cloudProxyServerMode=o.mode,s;case we.RECORD_JOIN_CHANNEL_SERVICE:return typeof o.index!="number"?s.joinChannelServiceRecords=[...s.joinChannelServiceRecords,o.record]:(s.joinChannelServiceRecords[o.index]=Z(Z({},s.joinChannelServiceRecords[o.index]),o.record),s.joinChannelServiceRecords=[...s.joinChannelServiceRecords]),s;case we.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return s.joinChannelServiceRecords=[],s;case we.RESET_KEY_METRICS:return s.keyMetrics={publish:[],subscribe:[],firstVideoFrameDecoded:[]},s;case we.SET_USE_P2P:return Z(Z({},s),{},{useP2P:o.val});case we.SET_TRANSPORT_TYPE:return Z(Z({},s),{},{p2pTransport:o.val});case we.SET_RTE_URL:return Z(Z({},s),{},{rteUrl:o.rteUrl});case we.SET_RTE_SID:return Z(Z({},s),{},{rteSid:o.rteSid});default:return s}})(this.state,r)}get useDcSignal(){return this.state.useDcSignal}set useDcSignal(r){this.state.useDcSignal=r}set autoSubscribe(r){this.state.autoSubscribe=r}get autoSubscribe(){return this.state.autoSubscribe}set enableInstantMuteRestore(r){this.state.enableInstantMuteRestore=r}get enableInstantMuteRestore(){return this.state.enableInstantMuteRestore}set networkQualityProbe(r){this.state.networkQualityProbe=r}get networkQualityProbe(){return this.state.networkQualityProbe}set sessionId(r){this.dispatch({type:we.SET_SESSION_ID,sessionId:r})}get sessionId(){return this.state.sessionId}set rteUrl(r){this.dispatch({type:we.SET_RTE_URL,rteUrl:r})}get rteUrl(){return this.state.rteUrl}set rteSid(r){this.dispatch({type:we.SET_RTE_SID,rteSid:r})}get rteSid(){return this.state.rteSid}set cid(r){this.state.cid=r}get cid(){return this.state.cid}set codec(r){this.state.codec=r}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(r){this.dispatch({type:we.SET_P2P_ID,p2pId:r})}get p2pId(){return this.state.p2pId}set dcId(r){this.dispatch({type:we.SET_DC_ID,dcId:r})}get dcId(){return this.state.dcId}set uid(r){this.dispatch({type:we.SET_UID,uid:r})}get uid(){return this.state.uid}set intUid(r){this.dispatch({type:we.SET_INT_UID,intUid:r})}get intUid(){return this.state.intUid}set pubId(r){this.dispatch({type:we.SET_PUB_ID,pubId:r})}get pubId(){return this.state.pubId}set cloudProxyServerMode(r){this.dispatch({type:we.SET_CLOUD_PROXY_SERVER_MODE,mode:r})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(r){this.dispatch({type:we.SET_USE_P2P,val:r})}get useP2P(){return this.state.useP2P}set p2pTransport(r){this.dispatch({type:we.SET_TRANSPORT_TYPE,val:r})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(r){this.state.hasStartJoinChannel=r}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(r){this.state.isABTestSuccess=r}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:we.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:we.KEY_METRIC_JOIN_START,metric:Date.now()})}preloadStart(){this.dispatch({type:we.KEY_METRIC_PRELOAD_START,metric:Date.now()})}preloadEnd(){this.dispatch({type:we.KEY_METRIC_PRELOAD_END,metric:Date.now()})}joinEnd(){this.dispatch({type:we.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:we.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:we.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}requestSUAEnd(){this.dispatch({type:we.KEY_METRIC_REQUEST_SUA_END,metric:Date.now()})}beforeConnect(){this.dispatch({type:we.KEY_METRIC_BEFORE_CONNECT,metric:Date.now()})}peerReceiver(){this.dispatch({type:we.KEY_METRIC_PEER_RECEIVER,metric:Date.now()})}signalConnected(){this.dispatch({type:we.KEY_METRIC_SIGNAL_CONNECTED,metric:Date.now()})}joinReq(){this.dispatch({type:we.KEY_METRIC_JOIN_REQ,metric:Date.now()})}joinRep(){this.dispatch({type:we.KEY_METRIC_JOIN_REP,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:we.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:we.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:we.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:we.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}firstVideoFrameDecoded(r,s){this.dispatch({type:we.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED,metric:Z({userId:r},s)})}descriptionStart(){this.dispatch({type:we.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:we.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:we.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(r,s,o,a){this.dispatch({type:we.KEY_METRIC_PUBLISH,metric:Z(Z({trackId:r,type:s},o&&{publishStart:o}),a&&{publishEnd:a})})}subscribe(r,s,o,a,c,d,l){this.dispatch({type:we.KEY_METRIC_SUBSCRIBE,metric:Z(Z(Z(Z(Z({userId:r,type:s},o&&{subscribeStart:o}),a&&{subscribeEnd:a}),c&&{firstFrame:c}),d&&{streamAdded:d}),l&&{firstDecoded:l})})}massSubscribe(r,s,o,a){r.forEach((c=>{this.dispatch({type:we.KEY_METRIC_SUBSCRIBE,metric:Z(Z(Z({userId:c.userId,type:c.type},s&&{subscribeStart:s}),o&&{subscribeEnd:o}),a&&{firstFrame:a})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(r,s){r.service==="gateway"&&Array.isArray(r.urls)&&(r.urls=r.urls.map((o=>o.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return typeof s!="number"?(this.dispatch({type:we.RECORD_JOIN_CHANNEL_SERVICE,record:Z(Z({},r),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(s<0||s>=this.state.joinChannelServiceRecords.length||this.dispatch({type:we.RECORD_JOIN_CHANNEL_SERVICE,record:r,index:s}),s)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:we.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:we.RESET_KEY_METRICS})}resetFirstVideoFrameDecoded(){this.dispatch({type:we.RESET_FIRST_VIDEO_FRAME_DECODED})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}}(e.codec,e.audioCodec,e.mode,this._clientId,b("SIGNAL_CHANNEL")===1),this._leaveMutex=new gn("client-leave",this._clientId),this._publishMutex=new gn("client-publish",this._clientId),this._renewTokenMutex=new gn("client-renewtoken",this._clientId),this._subscribeMutex=new gn("client-subscribe",this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),_.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Gi," build: ").concat(VE,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{RE(e.clientRoleOptions),n=Object.assign({},e.clientRoleOptions)}catch(r){_.warning("[".concat(this._clientId,"] ").concat(r.toString()))}var i;this._statsCollector=new sl(this.store),this._statsCollector.onStatsException=(r,s,o)=>{_.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(r,", msg: ").concat(s,", uid: ").concat(o)),r===Wg.VIDEO_ENCODE_FAILED&&this.localTracks.forEach((a=>{a instanceof Ph&&b("ENABLE_ENCODE_EXCEPTION")&&a.findClosestProfile()})),this.safeEmit(Be.EXCEPTION,{code:r,msg:s,uid:o})},this._statsCollector.onUploadPublishDuration=(r,s,o,a)=>{const c=this._users.find((d=>d.uid===r));c&&(this.store.keyMetrics&&(this.store.firstVideoFrameDecoded(c.uid,{peerPublishDuration:o,peerPubStatusMs:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(c)),pe.peerPublishStatus(this._sessionId,{subscribeElapse:a,audioPublishDuration:s,videoPublishDuration:o,peer:c._uintid}))},this._statsCollector.onVideoCodecChanged=r=>{if(b("VIDEO_STANDARD_BITRATE_VERSION")&&(r==="av1"||r==="h265"||r==="h264")){const s=this.localTracks.find((o=>o instanceof yt));s&&s._saveEncodeBitrateRatio!==1&&s.setSaveEncodeBitrateRatio(r==="h264"?b("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P=e.mode==="p2p",this._gateway=new RH(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||Xt,httpRetryConfig:e.httpRetryConfig||Xt,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:n}),this._configDistribute=new kH(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(i={store:this.store,statsCollector:this._statsCollector},Ur("P2PChannel").create(i)),this._handleP2PEvents()):this._p2pChannel=new ua(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,n,i,r){let s=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],o=arguments.length>6&&arguments[6]!==void 0&&arguments[6];_t("JOIN_GATEWAY_USE_443PORT_ONLY",s),_t("JOIN_GATEWAY_USE_DUAL_DOMAIN",o);const a=this._gateway.signal.websocket;return a instanceof Rg&&(a.use443PortOnly=s,a.tryDoubleDomain=o),(async function(c,d,l){uh.get(c)||uh.set(c,[]),hh.get(c)||hh.set(c,d),ns.get(c)||ns.set(c,0);const u=uh.get(c),h=hh.get(c);if(!u||!h)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(ns.get(c)===h){const I=Ud();u.push(I),await I.promise}ns.set(c,ns.get(c)+1);for(var p=arguments.length,R=new Array(p>3?p-3:0),T=3;T<p;T++)R[T-3]=arguments[T];const y=await l(...R);return ns.set(c,ns.get(c)-1),ns.get(c)===h-1&&u.length>0&&(u[0].resolve(),u.shift()),ns.get(c)===0&&(uh.set(c,[]),hh.set(c,0),ns.set(c,0)),y})("client.join",b("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,n,i,r)}async join(e,t,n,i,r){const s=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);const o=(gh||gh||(gh=(window.location.protocol.split(":")[0]||"").toUpperCase(),gh))==="HTTPS",a=Zw()?window.isSecureContext:"Browser Not Support";(!Zw()&&!o||!window.isSecureContext)&&_.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let c;pe.setAppId(e);try{if(!n&&n!==null)throw new V(w.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));if(n&&bn(n,"token",1,2047),bn(e,"appid",1,2047),Gh(t),i&&Hh(i),r)if(typeof r=="string")bn(r,"optionalInfo",1,256),c=r;else{if(typeof r!="object")throw new V(w.INVALID_PARAMS,"Invalid options: options is not a string or object");{const{autoSubscribe:y,enableInstantMuteRestore:I,networkQualityProbe:A}=r;y&&(cr(y,"autoSubscribe"),_.info("[".concat(this._clientId,"] join: autoSubscribe: ").concat(y)),this.store.autoSubscribe=y),I&&(cr(I,"enableInstantMuteRestore"),_.info("[".concat(this._clientId,"] join: enableInstantMuteRestore: ").concat(I)),this.store.enableInstantMuteRestore=I),A&&(cr(A,"networkQualityProbe"),_.info("[".concat(this._clientId,"] join: networkQualityProbe: ").concat(A)),this.store.networkQualityProbe=A)}}}catch(y){throw pe.reportApiInvoke(Xo(),{name:Nt.JOIN,options:[e,t,n,i],states:{isHttps:o,isSecureContext:a},tag:Tt.TRACER}).onError(y),y}if(this._leaveMutex.isLocked&&(_.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),_.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const y=new V(w.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw pe.reportApiInvoke(Xo(),{name:Nt.JOIN,options:[e,t,n,i],states:{isHttps:o,isSecureContext:a},tag:Tt.TRACER}).onError(y),y}this._gateway.state="CONNECTING",this.store.preloadStart();const d=await sS({appId:e,cname:t,uid:i,stringUid:typeof i=="string"?i:void 0,token:n||e,cloudProxyServer:this._cloudProxyServerMode});if(this.store.preloadEnd(),!this._joinAndNotLeaveYet)throw new V(w.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const l=d?.sid||Xo();_.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(s)),this._sessionId||(this._sessionId=l,this.store.sessionId=this._sessionId);const u=pe.reportApiInvoke(this._sessionId,{id:this._clientId,name:Nt.JOIN,options:[e,t,n,i],states:{isHttps:o,isSecureContext:a},tag:Tt.TRACER}),h=gr(gr(gr({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:typeof i!="string"?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:c,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!d},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:b("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(h.setLocalAPVersion=this._setLocalAPVersion),typeof i=="string"&&(h.stringUid=i,this._uintUid?(h.uid=this._uintUid,this._uintUid=void 0):h.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(h.aesmode=this._encryptionMode,h.aespassword=await(async y=>{const I=(function(x){const P=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),M=new Uint8Array(new ArrayBuffer(P.length));for(let G=0;G<P.length;G+=1)M[G]=P.charCodeAt(G);return M})(),A=await window.crypto.subtle.importKey("spki",I,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),N=yE(y),k=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},A,N);return(function(x){let P="";for(let M=0;M<x.length;M+=1)P+=String.fromCharCode(x[M]);return window.btoa(P)})(new Uint8Array(k))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new V(w.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(h.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const y=new TextEncoder,I=b("USE_PURE_ENCRYPTION_MASTER_KEY")?y.encode(h.appId+this._encryptionSecret+this._encryptionSecret):y.encode(h.appId+h.cname+this._encryptionSecret);this._encryptDataStreamIv=await(async function(A,N,k){const x=await window.crypto.subtle.importKey("raw",N,"PBKDF2",!1,["deriveBits","deriveKey"]),P=A==="aes-128-gcm2"?128:256,M=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:cA,hash:"SHA-256",salt:k},x,P+t6);return new Uint8Array(M).subarray(P/8)})(this._encryptionMode,I,qo(this._encryptionSalt)),this._encryptDataStreamKey=await(async function(A,N,k){const x=await window.crypto.subtle.importKey("raw",N,"PBKDF2",!1,["deriveBits","deriveKey"]),P=A==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:cA,hash:"SHA-256",salt:k},x,{name:"AES-GCM",length:P},!0,["encrypt","decrypt"])})(this._encryptionMode,I,qo(this._encryptionSalt))}else a?_.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):_.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,_.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:t,appId:e,stringUid:h.stringUid});const p=this._sessionId;setTimeout((()=>{this.connectionState==="CONNECTING"&&p===this._sessionId&&pe.joinChannelTimeout(this._sessionId,5)}),5e3);try{var R;let y;const I=h.cloudProxyServer;if(X(R=["proxy3","proxy4","proxy5"]).call(R,I)){const P=b("PROXY_SERVER_TYPE3");Array.isArray(P)?h.proxyServer=P[0]:h.proxyServer=P}if(pe.setProxyServer(h.proxyServer),_.setProxyServer(h.proxyServer),this.store.requestAPStart(),d){if(_.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(h.stringUid?", ".concat(h.stringUid," => ").concat(d.intUid):""," ")),h.stringUid&&!h.uid&&(h.uid=d.intUid),y={gatewayInfo:d.ap.gatewayInfo},b("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&h.turnServer.mode==="auto")if(d.ap.proxyInfo.addresses.length===0)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const P=(await JO(d.ap.proxyInfo,d.ap.gatewayInfo.uid)).map((M=>({turnServerURL:M.address,tcpport:M.tcpport||Nn.tcpport,udpport:M.udpport||Nn.udpport,username:M.username||Nn.username,password:M.password||Nn.password,forceturn:!1,security:!0})));h.turnServer={mode:"manual",servers:P}}rD(d,h.stringUid)}else{if(h.stringUid&&!h.uid){let P;[P,y]=await ie.all([CN(h.stringUid,h,this._axiosCancelSource.token,this._config.httpRetryConfig||Xt,this.store).finally((()=>{this.store.requestSUAEnd()})),RN(h,this._axiosCancelSource.token,this._config.httpRetryConfig||Xt,!0,this.store).finally((()=>{this.store.requestAPEnd()}))]),_.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(h.stringUid," => ").concat(P)),h.uid=P,y.gatewayInfo.uid=P,y.gatewayInfo.res.uid=P}else y=await RN(h,this._axiosCancelSource.token,this._config.httpRetryConfig||Xt,!0,this.store);if(!this._joinAndNotLeaveYet)throw new V(w.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(h,this._axiosCancelSource.token),this._configDistribute.on(xr.UPDATE_BITRATE_LIMIT,(P=>{this._p2pChannel.updateBitrateLimit(P)})),this._configDistribute.on(xr.UPDATE_CLIENT_ROLE_OPTIONS,(P=>{this._setClientRoleOptions(P)})),this._configDistribute.on(xr.UPDATE_REMOTE_VIDEO_STREAM_TYPE,(P=>{var M;X(M=[0,1,4,5,6,7,8,9]).call(M,P)&&(this.remoteUsers.forEach((G=>{this._remoteStreamTypeCacheMap.get(G.uid)!==P&&this.setRemoteVideoStreamType(G.uid,P)})),this.setRemoteDefaultVideoStreamType(P))})),this._configDistribute.on(xr.FALLBACK_TO_HLS,(P=>{P&&this.safeEmit(Be.FALLBACK_TO_HLS,CE.CONFIG)})),this._configDistribute.on(xr.UPDATE_VOS_CONFIGURE,(P=>{this._gateway.setConfigure(P).catch((M=>{_.debug("[".concat(this._clientId,"] auto set vos config failed"),M)}))}))}),0),this._key=n||e;const A=y.gatewayInfo,N=h.uid?h.uid:A.uid;this._joinInfo=gr(gr({},h),{},{cid:A.cid,uid:N,vid:A.vid,apResponse:A.res,apGatewayAddress:A.apGatewayAddress,uni_lbs_ip:A.uni_lbs_ip,gatewayAddrs:A.gatewayAddrs}),this.store.intUid=N,this.store.cid=A.cid;const k=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new V(w.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));u.onSuccess(k),this._appId=e,this._channelName=h.cname,this._uid=k,this.store.uid=k,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),!En()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(En()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()}),0);const x=h.stringUid?"string uid: ".concat(h.stringUid,",uid: ").concat(h.uid):"uid: ".concat(this._uid);return _.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(x)),setTimeout((()=>{_.startUpload()}),5e3),this.store.joinEnd(),T=this,X(ra).call(ra,T)||ra.push(T),this._cloudProxyServerMode==="disabled"&&We().supportWebCrypto&&b("ENABLE_PRELOAD")&&aS(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0),this._sessionId&&pe.reportRteDetail(this._sessionId),this._rteDetailInterval=window.setInterval((()=>{this._sessionId&&pe.reportRteDetail(this._sessionId)}),b("RTE_DETAIL_REPORT_INTERVAL")||6e4),k}catch(y){const I=Array.isArray(y)?y[0]:y;throw I&&I.code===w.OPERATION_ABORTED?_.warning("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),I):_.error("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),I),I.code!==w.OPERATION_ABORTED&&this._numberOfJoinCount===s&&(this._gateway.state="DISCONNECTED",this._reset()),u.onError(I),I}var T}async _joinGateway(){if(!this._joinInfo||!this._key)throw new V(w.INVALID_OPERATION);try{return await this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!b("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}catch(e){if(e.code===w.INIT_DATACHANNEL_TIMEOUT){if(this._gateway.leave(!0,Ke.FALLBACK),_.debug("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new V(w.INVALID_OPERATION);return pe.reportApiInvoke(this._sessionId,{name:Nt.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:Tt.TRACER}).onSuccess(),await this._joinGateway()}throw e}}async leave(){_.info("[".concat(this._clientId,"] Leaving channel"));const e=()=>{!En()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(En()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),(function(n){const i=ra.indexOf(n);i!==-1&&ra.splice(i,1)})(this),this._statsCollector.stopUpdateStats()};this.store.useDcSignal||e();const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return _.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED",Ke.LEAVE),_.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t(),this.store.useDcSignal&&e()}async publish(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof Tc))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new V(w.INVALID_PARAMS,"param list is empty");const n=e;if(this._gateway.role==="audience")throw new V(w.INVALID_OPERATION,"audience can not publish stream");for(const r of n){if(!(r instanceof Tc))throw new V(w.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&t)throw new V(w.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}_.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((r=>"".concat(r.getTrackId()," ")))));const i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&n.forEach((r=>{const s=this._configDistribute.getBitrateLimit();r instanceof yt&&s&&r.setBitrateLimit(s.uplink)}));try{await this._publishHighStream(n),_.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((r=>"".concat(r.getTrackId()," ")))))}catch(r){throw _.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{i()}}async _publishDataChannel(e){if(e==null)throw new V(w.INVALID_PARAMS,"parameter is not local track or datachannel config, config is ".concat(JSON.stringify(e)));St(e.id,"id",0,65535,!0),cr(e.ordered,"ordered"),bn(e.metadata,"metadata",0,512),_.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const t=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex((r=>r.id===e.id))!==-1)throw new V(w.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new V(w.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&b("FORCE_TURN")&&!b("TURN_ENABLE_TCP")&&!b("TURN_ENABLE_UDP"))throw new V(w.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=(function(r){return mN(r,!1)})(e),i=await this._p2pChannel.publishDataChannel([n]);if(i.length>0){if(typeof n._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new V(w.CREATE_DATACHANNEL_ERROR);try{await ie.all(i.map((r=>this._uid&&this._gateway.publishDataChannel(this._uid,r,!0)))),await n._waitTillOpen()}catch(r){if(r.code!==w.DISCONNECT_P2P)throw r}}return _.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw _.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{t()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new V(w.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof Tc))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);_.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map((i=>"".concat(i.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{if(this.store.useP2P){const i=await this._p2pChannel.unpublish(t);i&&await this._gateway.sendExtensionMessage(Yt.UNPUBLISH,{unpubMsg:i},!0)}else{const i=await this._p2pChannel.unpublish(t);i&&await this._gateway.unpublish(i,this._uid),_.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map((r=>"".concat(r.getTrackId())))))}}catch(i){throw _.error("[".concat(this._clientId,"] unpublish error"),i.toString()),i}finally{n&&n()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),_.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map((n=>"".concat(n.id," ")))," "));const t=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(e);n&&await this._gateway.unpublishDataChannel(n),_.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map((i=>"".concat(i.id)))))}catch(n){throw _.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{t&&t()}}async subscribe(e,t,n){if(!(e instanceof ho)){const i=this.remoteUsers.find((r=>r.uid===e));if(!i)throw new V(w.INVALID_REMOTE_USER,"user is not in the channel");e=i}return t==="datachannel"?this._subscribeDataChannel(e,n):this._subscribe(e,t)}async presubscribe(e,t){if(qt(t,"mediaType",["audio","video"]),this.store.useP2P)throw new V(w.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new V(w.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=t===ue.AUDIO,i=t===ue.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:s,ortc:o,rtxSsrcId:a,cname:c,uint_id:d}=await this._gateway.presubscribe(e,t,!0);if(s==null)throw new V(w.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find((h=>h.uid===e));l||(l=new ho(e,d||e),l._is_pre_created=!0,this._users.push(l)),c&&(l._cname=c),l._uintid||(l._uintid=d||e),n&&(l._audioSSRC=s,l._audio_pre_subscribed=!0,o&&(l._audioOrtc=o)),i&&(l._videoSSRC=s,l._video_pre_subscribed=!0,o&&(l._videoOrtc=o),a!=null&&(l._rtxSsrcId=a)),_.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(s)),await this._p2pChannel.subscribe(l,t,s,a,o);const u=n?l._audioTrack:l._videoTrack;if(!u)throw new V(w.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),i&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),u}catch(s){throw _.error("[".concat(this._clientId,"] presub user ").concat(e," error"),s),s}finally{r()}}async _subscribeDataChannel(e,t){var n;if(St(t,"channelId",0,65535,!0),!this._joinInfo)throw new V(w.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((a=>a===e)))throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new V(w.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new V(w.INVALID_REMOTE_USER,"user is not published");const r=(n=e._dataChannels)===null||n===void 0?void 0:n.find((a=>a.id===t));if(!r)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new V(w.REMOTE_USER_IS_NOT_PUBLISHED);const s=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const a=await this._p2pChannel.subscribeDataChannel(e,[r]);if(a&&X(a).call(a,r.id))try{var o;if(typeof r._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new V(w.CREATE_DATACHANNEL_ERROR);const c={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(o=r.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(e.uid,c,!0),await r._waitTillOpen()}catch(c){if(c?.code!==w.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[r]),c;await this._p2pChannel.unsubscribeDataChannel(e,[r]),this._p2pChannel.setPendingRemoteDataChannel(e,r.id)}return _.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),r}finally{s()}}async _p2pSubscribe(e,t,n){if(qt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new V(w.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((s=>s===e))){const s=new V(w.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),s}if(!e.hasAudio&&!e.hasVideo){const s=new V(w.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),s}if(!n&&(t==="audio"&&!e.hasAudio||t==="video"&&!e.hasVideo)){const s=new V(w.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),s}const r=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const o=t==="audio"?e._audioSSRC:e._videoSSRC,a=t==="audio"?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(e,t,o,a)}catch(o){throw o}_.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((o=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),o)}));const s=t==="audio"?e._audioTrack:e._videoTrack;if(!s)throw new V(w.UNEXPECTED_ERROR,"can not find remote track in user object");return s}catch(s){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),s),s}finally{r()}}async _subscribe(e,t,n){if(this.store.useP2P)return this._p2pSubscribe(e,t);if(qt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new V(w.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((d=>d===e))){const d=new V(w.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),d}if(!e.hasAudio&&!e.hasVideo){const d=new V(w.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),d}if(!(n||(t!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(t!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){const d=new V(w.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),d}let r=t==="audio"?e._audioSSRC:e._videoSSRC,s=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,a={stream_type:t==="audio"?ue.AUDIO:ue.VIDEO,ssrcId:r};t==="video"&&this.store.firstVideoFrameDecoded(e.uid,{subscribeStart:Date.now()});const c=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const l=t==="audio"?e._audioSSRC:e._videoSSRC;l!==void 0&&l!==r&&(r=l,s=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,a={stream_type:t==="audio"?ue.AUDIO:ue.VIDEO,ssrcId:r}),xn.markSubscribeStart(this.store.clientId,r),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,r,o,s);try{this._p2pChannel.isPreSubScribe(r)||await this._gateway.subscribe(e.uid,a,!0)}catch(u){if(u?.code!==w.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),u;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(l){throw this._p2pChannel.reportSubscribeEvent(!1,l?.code,e,t),l}_.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((l=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),l)}));const d=t==="audio"?e._audioTrack:e._videoTrack;if(!d)throw new V(w.UNEXPECTED_ERROR,"can not find remote track in user object");return t==="video"&&(this.store.firstVideoFrameDecoded(e.uid,{subscribeEnd:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(e)),d}catch(d){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),d),d}finally{c()}}async massSubscribe(e){if(Ns(e,"subscribeList"),!this._joinInfo)throw new V(w.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),n=new Map,i=await this._subscribeMutex.lock();_.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((a=>{let{user:c,mediaType:d}=a;return"user: ".concat(c?.uid,", mediaType: ").concat(d)})).join("; ")));const r=(e=[...e]).map((a=>{let{user:c,mediaType:d}=a;return{user:c,mediaType:d}})),s=await this._p2pChannel.globalLock();try{var o;for(let c=e.length-1;c>=0;c--){const d=e[c],{user:l,mediaType:u}=d;if(qt(u,"mediaType",["audio","video"]),!l){const T=new V(w.INVALID_PARAMS,"user property does not exist in subscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),T}if(!this._users.find((T=>T===l))){const T=new V(w.INVALID_REMOTE_USER,"user is not in the channel");_.error("[".concat(this._clientId,"] can not massSubscribe ").concat(l.uid,", this user is not in the channel")),r[c].error=T,e.splice(c,1);continue}if(u==="audio"&&(!l.hasAudio||l._audioSSRC===void 0)||u==="video"&&(!l.hasVideo||l._videoSSRC===void 0)){const T=new V(w.REMOTE_USER_IS_NOT_PUBLISHED);_.error("[".concat(this._clientId,"] can not subscribe ").concat(l.uid," with mediaType ").concat(u,", remote user is not published")),r[c].error=T,e.splice(c,1);continue}const p=mn.Video|mn.LwoVideo,R=n.get(l);if(R){if(u==="video"?R&p:R&mn.Audio){e.splice(c,1),_.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(l.uid,", mediaType:").concat(u," twice"));continue}n.set(l,R|(u==="video"?p:mn.Audio))}else n.set(l,u==="video"?p:mn.Audio)}for(let c=e.length-1;c>=0;c--){const d=e[c],{user:l,mediaType:u}=d,h=mn.Video|mn.LwoVideo;if(this._p2pChannel.hasRemoteMedia(l,u)){await this._p2pChannel.unmuteRemoteNoLock(l,u);const p=n.get(l);n.set(l,u==="video"?p^h:p^mn.Audio),e.splice(c,1)}}this.store.massSubscribe(e.map((c=>({userId:c.user.uid,type:c.mediaType}))),t);let a=Bi(o=Array.from(n.entries())).call(o,((c,d)=>{let[l,u]=d;if(u===0)return c;const h={stream_id:l.uid,stream_type:u};return u&mn.Audio&&(h.audio_ssrc=l._audioSSRC),u&mn.Video&&(h.video_ssrc=l._videoSSRC),c.push(h),c}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((d=>{let{user:l,mediaType:u}=d;return{user:l,mediaType:u,ssrcId:u===ue.VIDEO?l._videoSSRC:l._audioSSRC,rtxSsrcId:u===ue.VIDEO?l._rtxSsrcId:void 0}})));const c=new Map;if(a=a.filter((d=>d.video_ssrc&&!this._p2pChannel.isPreSubScribe(d.video_ssrc)||d.audio_ssrc&&!this._p2pChannel.isPreSubScribe(d.audio_ssrc)||!d.video_ssrc&&!d.audio_ssrc)),a.length>0){const d=await this._gateway.subscribeAll(a,!0);(d?.users||[]).forEach((l=>{let{stream_id:u,video_error_code:h,audio_error_code:p,error_code:R}=l;(h||p||R)&&c.set(u,{video_error_code:h,audio_error_code:p,error_code:R})}))}if(Array.from(c.entries()).length>0){const d=[];Array.from(c.entries()).forEach((l=>{let[u,h]=l;const p=this.remoteUsers.find((R=>R.uid===u));if(p){let R;h.error_code||h.video_error_code&&h.audio_error_code?R=void 0:h.video_error_code?R=ue.VIDEO:h.audio_error_code&&(R=ue.AUDIO),d.push({user:p,mediaType:R})}})),d.length>0&&await this._p2pChannel.massUnsubscribeNoLock(d)}for(const d of r){const l=c.get(d.user.uid);if(l){const u=l.error_code||d.mediaType==="audio"&&l.audio_error_code||d.mediaType==="video"&&l.video_error_code;if(u){const h=aa(u);_.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(h.desc)),d.error=new V(w.SUBSCRIBE_FAILED,"code ".concat(u,": ").concat(h.desc))}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack)}return this.store.massSubscribe(r.filter((d=>!d.error)).map((d=>({userId:d.user.uid,type:d.mediaType}))),void 0,Date.now()),r.forEach((d=>{var l;pe.subscribe(this.store.sessionId,{succ:!!d.error,ec:((l=d.error)===null||l===void 0?void 0:l.code)||null,video:d.mediaType===ue.VIDEO,audio:d.mediaType===ue.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===ue.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t),preSsrc:this._p2pChannel.isPreSubScribe(d.user._videoSSRC)},!0)})),_.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((d=>{let{user:l,mediaType:u}=d;return"user: ".concat(l?.uid,", mediaType: ").concat(u)})).join("; "))),r}catch(c){throw await this._p2pChannel.massUnsubscribeNoLock(e),c}}finally{s(),i()}}async unsubscribe(e,t,n){if(!(e instanceof ho)){const s=this.remoteUsers.find((o=>o.uid===e));if(!s)throw new V(w.INVALID_REMOTE_USER,"user is not in the channel");e=s}if(t||this.store.useP2P){if(t==="datachannel")return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(t&&qt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new V(w.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((s=>s===e))){const s=new V(w.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),s}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));const r=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(e,t);else{const s=await this._p2pChannel.unsubscribe(e,t);s&&await this._gateway.unsubscribe(s,e.uid),t&&t!=="audio"||(e._audio_pre_subscribed=!1),t&&t!=="video"||(e._video_pre_subscribed=!1),e._is_pre_created&&fh(this._users,e),_.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(s){if(s.code===w.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),s.toString()),s}finally{r()}}async _unsubscribeDataChannel(e,t){if(t&&St(t,"id",0,65535,!0),!this._joinInfo)throw new V(w.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((r=>r===e))){const r=new V(w.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),r}let i;if(typeof t=="number"){const r=e._dataChannels.find((s=>s.id===t));r&&(i=[r])}else i=e._dataChannels;if(i===void 0){const r=new V(w.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),r}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i.map((r=>r.id))));try{const r=await this._p2pChannel.unsubscribeDataChannel(e,i);r&&await this._gateway.unsubscribeDataChannel(r,e.uid),_.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===w.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),r.toString()),r}}async massUnsubscribe(e){if(Ns(e,"unsubscribeList"),!this._joinInfo)throw new V(w.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");_.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((n=>{let{user:i,mediaType:r}=n;return"user: ".concat(i?.uid,", mediaType: ").concat(r,";")})).join())),e=[...e];const t=new Map;for(let n=e.length-1;n>=0;n--){const{user:i,mediaType:r}=e[n];if(!i){const a=new V(w.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(qt(r,"mediaType",["video","audio",void 0]),!this._users.find((a=>a===i))){_.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),e.splice(n,1);continue}const o=mn.Video|mn.LwoVideo;if(t.has(i)){const a=t.get(i);let c;switch(r){case"video":c=a&o;break;case"audio":c=a&mn.Audio;break;default:c=a&(mn.Audio|o)}if(c){_.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),e.splice(n,1);continue}r?r==="audio"?t.set(i,a|mn.Audio):r==="video"&&t.set(i,a|o):t.set(i,a|mn.Audio|o)}else r?r==="audio"?t.set(i,mn.Audio):r==="video"&&t.set(i,o):t.set(i,mn.Audio|o)}try{const n=await this._p2pChannel.massUnsubscribe(e);n&&await this._gateway.massUnsubscribe(n),_.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((i=>{let{user:r,mediaType:s}=i;return"user: ".concat(r?.uid,", mediaType: ").concat(s,";")})).join()))}catch(n){if(n.code===w.DISCONNECT_P2P)return void _.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw _.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(e){(function(n){if(!n)throw new F(w.INVALID_PARAMS);Vt(n.width)||SE(n.width,"streamParameter.width"),Vt(n.height)||SE(n.height,"streamParameter.height"),Vt(n.framerate)||SE(n.framerate,"streamParameter.framerate"),Vt(n.bitrate)||St(n.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&_.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),_.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,J.LocalVideoLowTrack)}async setDualStreamMode(e,t){qt(e,"mode",[0,1,-1]);try{switch(t&&await this.setLowStreamParameter(t),this._dualStreamMode=e,this._joinInfo?this._gateway.setDualStreamMode(e).catch((n=>{_.warning("[".concat(this._clientId,"] set dual stream mode failed"),n.toString())})):_.debug("[".concat(this._clientId,"] haven't joined yet, cache dual stream mode ").concat(e)),e){case dc.AUTO_SIMULCAST_STREAM:_.info("[".concat(this._clientId,"] set dual stream mode to ").concat(e));break;case dc.DISABLE_SIMULCAST_STREM:return this.disableDualStream();case dc.ENABLE_SIMULCAST_STREAM:return this.enableDualStream()}}catch(n){throw _.error("[".concat(this._clientId,"] set dual stream mode error"),n.toString()),n}}async enableDualStream(){if(!We().supportDualStream)throw pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new V(w.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new V(w.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,this._dualStreamMode=dc.ENABLE_SIMULCAST_STREAM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch((e=>{_.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())})),pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),_.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)return this._isDualStreamEnabled=!1,void _.info("[".concat(this._clientId,"] disable dual stream before join"));if(this._p2pChannel.getLocalMedia(J.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,this._dualStreamMode=dc.DISABLE_SIMULCAST_STREM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch((e=>{_.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())})),pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),_.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if((function(i){qt(i,"role",["audience","host"])})(e),t&&RE(t),this.mode==="rtc"||this.mode==="p2p")throw _.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new V(w.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&e==="host")throw new V(w.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new V(w.INVALID_OPERATION,"can not set client role to audience when publishing stream");const n=this._config.role;if(this._joinInfo&&(this._joinInfo.role=e),e!==n&&b("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(e,t),this._config.role=e,this._gateway.reconnect("recover",On.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(e,t),this._config.role=e),_.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level)),n==="audience"&&e!=="audience"&&this._pendingRtpCapabilityChange&&this._p2pChannel instanceof ua){const{video_codec:i}=this._pendingRtpCapabilityChange;this._p2pChannel.updateRemoteRTPCapabilities(i.map((r=>r.toLowerCase())).filter((r=>{var s;return X(s=Object.keys(Qo)).call(s,r)})))}}async _setClientRoleOptions(e){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let t=!1;try{e&&RE(e),await this._gateway.setClientRole(this._config.role,e),t=!0}catch{}finally{_.info("[".concat(this._clientId,"] set client role options ").concat(t?"succeed":"failed",", options is ").concat(e))}}getRemoteInboundOffset(){var e;const t=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const n=t.timestamp-Date.now();return Math.abs(n)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(bn(e,"proxyServer"),!t){if(this.connectionState!=="DISCONNECTED")throw new V(w.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new V(w.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,pe.setProxyServer(this._proxyServer),_.setProxyServer(this._proxyServer),_.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if(this.connectionState!=="DISCONNECTED")throw new V(w.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new V(w.INVALID_OPERATION,"You have already set the proxy")}if(Ho(e))return this._turnServer={servers:e,mode:"original-manual"},void _.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map((n=>n.urls)).join(","),"."));e.forEach((n=>Fw(n))),this._turnServer={servers:e,mode:"manual"},_.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new V(w.INVALID_OPERATION,"you should set license before join channel");if(bn(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new V(w.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,_.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new V(w.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new V(w.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let n;switch(e===void 0&&(e=3),e){case 1:case 2:throw new V(w.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new V(w.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new V(w.INVALID_OPERATION,"Stop proxy server after leave channel");pe.setProxyServer(),_.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new V(w.INVALID_PARAMS,"accessPoints is required.");Ns(e.accessPoints.serverList,"accessPoints.serverList"),bn(e.accessPoints.domain,"accessPoints.domain");const t=(h,p)=>{St(h,p,0,65535,!0)};let n=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new V(w.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");b("CLOSE_AFB_FOR_LOCAL_AP")&&(_t("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),_t("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=e.accessPoints.domain,s=e.accessPoints.serverList.map((h=>i.test(h)?"".concat(h.replace(/\./g,"-"),".").concat(r):h)),o=s.map((h=>"".concat(h,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,_t("WEBCS_DOMAIN",o),_t("WEBCS_DOMAIN_BACKUP_LIST",o),_t("GATEWAY_DOMAINS",[r]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(Ns(e.report.hostname,"report.hostname"),_t("EVENT_REPORT_DOMAIN",e.report.hostname[0]),_t("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(_t("EVENT_REPORT_DOMAIN",s[0]),_t("EVENT_REPORT_BACKUP_DOMAIN",s[1]||s[0]));let a=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),a=e.report.port),_t("STATS_COLLECTOR_PORT",a),e.report?_t("ENABLE_EVENT_REPORT",!0):_t("ENABLE_EVENT_REPORT",!1);let c="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(Ns(e.log.hostname,"log.hostname"),c=e.log.hostname[0]):c=s[0];let d=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),d=e.log.port),_t("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(Ns(e.cds.hostname,"cds.hostname"),l=e.cds.hostname):l=s;let u=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),u=e.cds.port),_t("CDS_AP",l.map((h=>"".concat(h,":").concat(u)))),e.cds?_t("ENABLE_CONFIG_DISTRIBUTE",!0):_t("ENABLE_CONFIG_DISTRIBUTE",!1),_.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(Ns(e,"serverList"),bn(t,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new V(w.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((i=>n.test(i)?"".concat(i.replace(/\./g,"-"),".").concat(t):i)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,_t("WEBCS_DOMAIN",e),_t("WEBCS_DOMAIN_BACKUP_LIST",e),_t("GATEWAY_DOMAINS",[t]),_t("EVENT_REPORT_DOMAIN",e[0]),_t("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),_t("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),_.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(qt(e,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw _.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else _.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){qt(t,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout((()=>{const n=this._users.find((i=>i.uid===e));n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(n){throw _.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}_.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){qt(t,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(n){throw _.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}_.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,n,i){(function(s){qt(s,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),bn(t,"secret");const r=["aes-128-gcm2","aes-256-gcm2"];if(X(r).call(r,e)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new V(w.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new V(w.INVALID_PARAMS,"current encrypt mode does not need salt");if(i){if(cr(i,"encryptDataStream"),!X(r).call(r,e))throw new V(w.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(t)||_.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=t,n&&(this._encryptionSalt=ro(n))}async renewToken(e){if(bn(e,"token",1,2047),!this._key||!this._joinInfo)throw new V(w.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(b("USE_NEW_TOKEN")){_.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await LH(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Xt);_.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:i})}else _.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});_.debug("[".concat(this._clientId,"] renewToken success"))}catch(i){throw this._key=t,this._joinInfo.token=t,_.error("[".concat(this._clientId,"] renewToken failed"),i.toString()),i}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?_.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(Be.VOLUME_INDICATOR,e)}),b("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if(this.codec!=="h264")throw new V(w.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new V(w.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new V(w.LIVE_STREAMING_TASK_CONFLICT);const n=t?Ps.TRANSCODE:Ps.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(e,n)}setLiveTranscoding(e){return this._createLiveStreamingClient(Ps.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((n=>n&&n.hasUrl(e)));if(!t.length)throw new V(w.INVALID_PARAMS,"can not find live streaming url to stop");await ie.all(t.map((n=>n&&n.stopLiveStreamingTask(e))))}async startChannelMediaRelay(e){NN(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){NN(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(e){this._p2pChannel instanceof ua&&this._p2pChannel.addAudioMetadata(e)}async sendStreamMessage(e){var t;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new V(w.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){const r=new TextEncoder;e.payload=r.encode(e.payload)}let i=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&X(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)&&(i=!0,e.payload=await(async function(r,s,o){var a;const c=Bi(a=Array.from(o)).call(a,((T,y)=>T+y),0),d={serverTs:0,seq:n6++,length:o.length,checkSum:c},l=new Uint8Array(Xw(c,2)),u=new ArrayBuffer(fc),h=new DataView(u);h.setUint32(0,d.serverTs),h.setUint16(4,d.seq),h.setUint16(6,d.length),h.setUint16(8,d.checkSum);const p=16-o.length%16;o=Hw(o,new Uint8Array(p));const R=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:aA,additionalData:l},s,o);return Hw(new Uint8Array(u),new Uint8Array(R))})(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new V(w.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(Ee.DATA_STREAM,{payload:ro(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-WH},!n)}sendMetadata(e){if(!this._joinInfo)throw new V(w.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new V(w.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Ee.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:ro(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(u6),!this._joinInfo)throw new V(w.INVALID_OPERATION,"can not send custom report, not joined");await pe.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){const e=this._statsCollector.getRemoteNetworkQualityStats();if(b("DELETE_NEQ_AFTER_USER_LEAVE")){const t=this._users.map((n=>n.uid+""));Object.keys(e).forEach((n=>{X(t).call(t,n)||delete e[n]}))}return e}getNetworkQuality(){return this._statsCollector.getNetworkQuality()}async pickSVCLayer(e,t){qt(t.spatialLayer,"spatialLayer",[0,1,2,3]),qt(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(n){throw _.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(e){const{apRTM:t=!1,rtmFlag:n}=e;if(cr(t,"apRTM"),St(n,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=n,_.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(_.debug("[".concat(this._clientId,"] reset client")),(function(e){const t=Ic.indexOf(e);t!==-1&&Ic.splice(t,1)})(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this.store.autoSubscribe=!1,this._pendingRtpCapabilityChange=void 0,this._axiosCancelSource.cancel(),this._axiosCancelSource=ii.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&iD(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0,this._sessionId&&pe.reportRteDetail(this._sessionId)),this._fallbackServerInfo=void 0,this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&pe.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this.store.resetFirstVideoFrameDecoded(),this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((t=>t._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new gn("client-publish",this._clientId),this._subscribeMutex=new gn("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,t){var n;const i=e||Xo();e?_.debug("[".concat(this._clientId,"] new Session ").concat(i)):_.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));const r=e?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i,pe.addSid(i);const s={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:t?.stringUid||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1,rteUrl:this.store.rteUrl,rteSid:this.store.rteSid};pe.sessionInit(this._sessionId,gr({cname:t.channel,appid:t.appId},s)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new V(w.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&b("FORCE_TURN")&&!b("TURN_ENABLE_TCP")&&!b("TURN_ENABLE_UDP"))throw new V(w.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");_.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){const i=(await n.next()).value;if(i){try{await this._gateway.sendExtensionMessage(Yt.PUBLISH,i,!0)}catch(r){throw n.throw(r),r}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const i=(await n.next()).value;if(i){var t;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(s){if(s.code!==w.DISCONNECT_P2P)throw n.throw(s),s}await n.next(((t=r)===null||t===void 0?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const r of e)r instanceof yt&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig).catch((s=>{_.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))})),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,e),n?.code===w.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new V(w.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new V(w.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));_.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await n.next()).value;if(i){var t;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(s){if(s.code!==w.DISCONNECT_P2P)throw n.throw(s),s}n.next(((t=r)===null||t===void 0?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,void 0,!0),n?.code===w.WS_ABORT)return;throw n}}_createLiveStreamingClient(e){const t=()=>{if(!this._joinInfo||!this._appId)return new V(w.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const n=(i={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},Ur("LiveStreaming").create(i));var i;return n.onLiveStreamError=(r,s)=>{pe.reportApiInvoke(this._sessionId,{name:Nt.ON_LIVE_STREAM_ERROR,options:[r,s],tag:Tt.TRACER}).onSuccess(),this.safeEmit(Be.LIVE_STREAMING_ERROR,r,s)},n.onLiveStreamWarning=(r,s)=>{pe.reportApiInvoke(this._sessionId,{name:Nt.ON_LIVE_STREAM_WARNING,options:[r,s],tag:Tt.TRACER}).onSuccess(),this.safeEmit(Be.LIVE_STREAMING_WARNING,r,s)},n.on(Tg.REQUEST_WORKER_MANAGER_LIST,((r,s,o)=>{if(!this._joinInfo)return o(new V(w.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(a,c,d,l){const u=b("UAP_AP").slice(0,b("AJAX_REQUEST_CONCURRENT")).map((h=>c.proxyServer?"https://".concat(c.proxyServer,"/ap/?url=").concat(h+"/api/v1?action=uap"):"https://".concat(h,"/api/v1?action=uap")));return await IH(u,a,c,d,l)})(r,this._joinInfo,this._axiosCancelSource.token,Xt).then(s).catch(o)})),n};return e===Ps.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||t(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||t(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new V(w.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:n}=this.getLocalVideoStats(),i=(e={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:t,height:n}},Ur("ChannelMediaRelay").create(e));i.on("state",(r=>{r===hi.RELAY_STATE_FAILURE&&i&&i.dispose(),this.safeEmit(Be.CHANNEL_MEDIA_RELAY_STATE,r)})),i.on("event",(r=>{this.safeEmit(Be.CHANNEL_MEDIA_RELAY_EVENT,r)})),this._channelMediaRelayClient=i,this._statsCollector.onStatsChanged=(r,s)=>{var o;r==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(s))}}var e;return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){const{added:n,deleted:i}=e,r=[];if(t){const s=[];this._users.forEach((o=>{o._dataChannels.forEach((a=>{n.every((c=>c.uid!==o._uintid||c.stream_id!==a.id))&&s.push({uid:o._uintid,stream_id:a.id,ordered:a.ordered,max_retrans_times:a.maxRetransmits,metadata:a.metadata})}))})),s.length>0&&this._handleUpdateDataChannel({added:[],deleted:s})}Array.isArray(n)&&n.length>0&&n.forEach((s=>{const{uid:o,stream_id:a,ordered:c,max_retrans_times:d,metadata:l}=s,u=this._users.find((h=>h._uintid===o));if(!u)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(_.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(o)),X(r).call(r,u)||r.push(u),u._uintid||(u._uintid=o),u._dataChannels.findIndex((h=>h.id===s.stream_id))===-1){const h={id:a,ordered:!!c,maxRetransmits:d,metadata:l},p=(function(R){return mN(R,!0)})(h);u._dataChannels.push(p),_.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published datachannel")),t||this.safeEmit(Be.USER_PUBLISHED,u,"datachannel",h)}this._p2pChannel.hasPendingRemoteDataChannel(u,s.stream_id)&&(_.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(u.uid," after reconnect.")),this._subscribeDataChannel(u,s.stream_id).catch((h=>{_.error("[".concat(this._clientId,"] resubscribe datachannel error"),h.toString())})))})),t&&(this.safeEmit(Be.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach((s=>{const{uid:o,stream_id:a}=s,c=this._users.find((l=>l._uintid===o));if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const d=c._dataChannels.find((l=>l.id===s.stream_id));d&&(_.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(o)),this._p2pChannel.unsubscribeDataChannel(c,[d]).then((l=>{if(c._dataChannels=c._dataChannels.filter((u=>u!==d)),l)return this._gateway.unsubscribeDataChannel(l,c.uid)})),_.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(Be.USER_UNPUBLISHED,c,"datachannel",d._config))}))}_getEncodingName(e){var t,n;if(!this._joinResponse)return;const i=(t=this._joinResponse.ortc.rtpCapabilities.sendrecv)===null||t===void 0?void 0:t.videoCodecs;if(!i)return;for(const a of i){var r;if(a.payloadType===e)return a==null||(r=a.rtpMap)===null||r===void 0?void 0:r.encodingName}const s=(n=this._joinResponse.ortc.rtpCapabilities.recv)===null||n===void 0?void 0:n.videoCodecs;if(s)for(const a of s){var o;if(a.payloadType===e)return a==null||(o=a.rtpMap)===null||o===void 0?void 0:o.encodingName}return e===0?"unknown":void 0}_handleRemoveDataChannels(e){const t=this._users.find((n=>n.uid===e.uid));if(t){if(t._dataChannels!==void 0&&t._dataChannels.length>0){_.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach((i=>{this.safeEmit(Be.USER_UNPUBLISHED,t,"datachannel",i._config)}))};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then((i=>{if(i)return this._gateway.unsubscribeDataChannel(i,t.uid)})),n()}}else _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Kt.UPDATE_GATEWAY_CONFIG,(()=>{(function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void _.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),n=Date.now();Object.keys(t).forEach((i=>{const{value:r,type:s,expires:o}=t[i];o&&o<=n||s||pg()||!Object.prototype.hasOwnProperty.call(vh,i)||(Ni[i]=r,ht[i]=r,_.debug("Update gateway parameters from config distribute",i,r))}))}catch(t){_.error("Error update config from local cache",t.message)}})()})),this._gateway.on(Kt.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(Kt.CONNECTION_STATE_CHANGE,((e,t,n)=>{var i;if(n===Ke.FALLBACK)return;const r=()=>{this.safeEmit(Be.CONNECTION_STATE_CHANGE,e,t,n)};if(pe.reportApiInvoke(this._sessionId||((i=this._gateway.joinInfo)===null||i===void 0?void 0:i.sid)||null,{name:Nt.CONNECTION_STATE_CHANGE,options:[e,t,n],tag:Tt.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:n})),_.info("[".concat(this._clientId,"] signal connection state change: ").concat(t," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void r();if(e==="RECONNECTING")this._users.forEach((o=>{o._trust_in_room_=!1,o._trust_audio_enabled_state_=!1,o._trust_video_enabled_state_=!1,o._trust_audio_mute_state_=!1,o._trust_video_mute_state_=!1,o._trust_audio_stream_added_state_=!1,o._trust_video_stream_added_state_=!1,o._is_pre_created||(o._audio_pre_subscribed||(o._audioSSRC=void 0,o._audioOrtc=void 0),o._video_pre_subscribed||(o._videoSSRC=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),o._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var s;this._streamFallbackTypeCacheMap.forEach(((o,a)=>{this._gateway.setStreamFallbackOption(a,o).catch((c=>{_.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)}))})),this._remoteStreamTypeCacheMap.forEach(((o,a)=>{this._gateway.setRemoteVideoStreamType(a,o).catch((c=>{_.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)}))})),b("VOS_CONFIGURE")&&Array.isArray(b("VOS_CONFIGURE"))&&b("VOS_CONFIGURE").length>0&&(this._gateway.setConfigure(b("VOS_CONFIGURE")).catch((o=>{_.debug("[".concat(this._clientId,"] auto set vos config failed"),o)})),_.debug("[".concat(this._clientId,"] ws connected auto set vos config"))),this._remoteDefaultVideoStreamType!==void 0&&((s=this._joinInfo)===null||s===void 0?void 0:s.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{_.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((o=>{_.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(o))})),this._dualStreamMode&&this._gateway.setDualStreamMode(this._dualStreamMode).catch((o=>{_.warning("[".concat(this._clientId,"] auto set dual stream mode failed"),o)})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter((o=>!o._trust_in_room_)).forEach((o=>{_.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(o.uid)),this._handleUserOffline({uid:o.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach((o=>{o._trust_audio_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,ue.AUDIO,!1)),o._trust_video_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,ue.VIDEO,!1)),o._trust_audio_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(o.uid)),this._handleSetStreamLocalEnable("audio",o.uid,!0)),o._trust_video_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(o.uid)),this._handleSetStreamLocalEnable("video",o.uid,!0)),o._trust_video_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(o.uid)),this._handleResetAddStream(o,"video")),o._trust_audio_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(o.uid)),this._handleResetAddStream(o,"audio")),o._video_added_||o._audio_added_||(_.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(o.uid)),this._handleRemoveStream({uid:o.uid,uint_id:o._uintid}))})))}),1e3))}r()})),this._gateway.on(Kt.REQUEST_NEW_GATEWAY_LIST,(async(e,t)=>{if(!this._joinInfo)return t(new V(w.UNEXPECTED_ERROR,"can not recover, no join info"));try{let n;if(this._fallbackServerInfo)n=this._fallbackServerInfo,this._fallbackServerInfo=void 0,this._joinInfo.preload=!1,pe.reportApiInvoke(this._sessionId,{name:Nt.VOS_FALLBACK_CN,options:{cur:n.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!0},tag:Tt.TRACER}).onSuccess(),_.info("[".concat(this._clientId,"] use fallback cn server info"));else{const r=await sS(gr(gr({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));r?(n=r.ap,rD(r),this._joinInfo.preload=!0):(n=await sp(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Xt,this.store),this._joinInfo.preload=!1)}this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);const i=[];n.gatewayInfo.gatewayAddrs.forEach((r=>{let{address:s}=r;const[o,a]=s.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:o,port:a}):i.push({host:o,port:a})})),e(i)}catch(n){t(n)}})),this._gateway.on(Kt.NETWORK_QUALITY,(e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(Be.NETWORK_QUALITY,e)})),this._gateway.on(Kt.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(Be.STREAM_TYPE_CHANGED,e,t),pe.reportApiInvoke(this._sessionId,{name:Nt.STREAM_TYPE_CHANGE,options:[e,t],tag:Tt.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.isPreSub=()=>"isPreSub"in this._p2pChannel&&this._p2pChannel.isPreSub(),this._gateway.isPreallocation=()=>"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation(),this._gateway.on(Kt.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(Kt.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,n)=>{try{let i=await this._p2pChannel.getEstablishParams();i&&"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation()||(i=await this._p2pChannel.startP2PConnection(e)),t(i)}catch(i){n(i)}})),this._gateway.on(Kt.JOIN_RESPONSE,((e,t)=>{if(this.store.useP2P)return;let n;this._joinResponse=e,e.attributes?n=e.attributes.userAttributes.preSubSsrcs:_.debug("no attributes in joinResponse");const i=rN(e.ortc,t,n);this._p2pChannel.connect(i)})),this._gateway.on(Kt.PRE_CONNECT_PC,(async(e,t,n)=>{const{candidates:i,fingerprint:r,turnServer:s}=e;if(this._joinInfo&&i.length>0&&!this._p2pChannel.isPlanB){const{cert:a,cid:c}=this._joinInfo.apResponse,d="".concat(c,"_").concat(a);if(d.length<4||d.length>256)return void _.debug("[".concat(this._clientId,"] ufrag length is not valid, length: ").concat(d.length));await this._p2pChannel.startP2PConnection({turnServer:s,cloudProxyServer:this._joinInfo.cloudProxyServer,isPreallocation:!0});try{var o;t(await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(c,"_").concat(a),icePwd:"".concat(c,"_").concat(a)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(o=b("FINGERPRINT"))!==null&&o!==void 0?o:r}]},candidates:i,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0}))}catch(l){l.code&&l.code===w.EXCHANGE_SDP_FAILED&&await this._p2pChannel.startP2PConnection({turnServer:s,cloudProxyServer:this._joinInfo.cloudProxyServer},!0),n(l)}}})),this._gateway.on(Kt.VOS_FALLBACK,(e=>{e==="fallback_hls"&&this.safeEmit(Be.FALLBACK_TO_HLS,CE.VOSERROR)})),this._gateway.on(Kt.RESET_SIGNAL,(()=>{this._p2pChannel instanceof ua&&this._p2pChannel.fallbackConnection(),this._handleGatewaySignalEvents()})),this._gateway.on(Kt.DATACHANNEL_FAILBACK,(()=>{pe.reportApiInvoke(this._sessionId,{name:Nt.DATACHANNEL_FAILBACK,options:{},tag:Tt.TRACER}).onSuccess(),this._joinGateway()}))}_handleGatewaySignalEvents(){this._gateway.signal.on(Ae.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Ae.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Ae.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc))),this._gateway.signal.on(Ae.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(Ae.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(Ae.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams||[],deleted:[]},!0)})),this._gateway.signal.on(Ae.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Ae.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Ae.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,ue.AUDIO,!0))),this._gateway.signal.on(Ae.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,ue.AUDIO,!1))),this._gateway.signal.on(Ae.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,ue.VIDEO,!0))),this._gateway.signal.on(Ae.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,ue.VIDEO,!1))),this._gateway.signal.on(Ae.RECEIVE_METADATA,(e=>{const t=qo(e.metadata);this.safeEmit(Be.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(Ae.ON_DATA_STREAM,(async e=>{var t;if(!e)return;let n=qo(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&X(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)){if(e.payload.length<fc)throw new V(w.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(fc));n=await(async function(s,o,a){const c=a.subarray(0,fc),d=c.slice(8,fc),l=(d[0]<<8)+d[1],u=(c[6]<<8)+c[7],h=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:s,tagLength:aA,additionalData:new Uint8Array(Xw(l,2))},o,a.subarray(fc));return new Uint8Array(h).subarray(0,u)})(this._encryptDataStreamIv,this._encryptDataStreamKey,n)}let i=0;if(e.ordered||e.syncWithAudio){const r=this._p2pChannel.getStats(),s=this.remoteUsers.find((a=>a.uid===e.uid)),o=r?.audioRecv.find((a=>a.ssrc===s?._audioSSRC));i=o?.jitterBufferMs}(i==null||Number.isNaN(i))&&(i=0),HH(gr(gr({},e),{},{payload:n}),i,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(Ae.ON_CRYPT_ERROR,(()=>{io((()=>{_.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Be.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(Ae.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{_.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Ke.TOKEN_EXPIRE),this.safeEmit(Be.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(Ae.ON_STREAM_FALLBACK_UPDATE,(e=>{_.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(Be.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")})),this._gateway.signal.on(Ae.ENABLE_MULTI_STREAM,(e=>{this._dualStreamMode===dc.AUTO_SIMULCAST_STREAM&&this.enableDualStream().catch((t=>{_.debug("[".concat(this._clientId,"] set dual stream mode error"),t.toString())}))})),this._gateway.signal.on(Ae.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),_.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(Ae.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(Ae.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(fe.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case Ee.PUBLISH:{if(!t)return;const r=t.ortc;if(r){var n,i;const s=r.some((c=>{let{stream_type:d}=c;return d===pt.Audio})),o=r.some((c=>{let{stream_type:d}=c;return d!==pt.Audio})),a=r.some((c=>{let{stream_type:d}=c;return d===pt.Screen||d===pt.ScreenLow}));t.state==="offer"&&pe.publish(this._joinInfo.sid,{eventElapse:xn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:w.TIMEOUT,audio:s,video:o,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:s?(n=r.find((c=>{let{stream_type:d}=c;return d===pt.Audio})))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:o?(i=r.find((c=>{let{stream_type:d}=c;return d!==pt.Audio})))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0})}break}case Ee.SUBSCRIBE:t&&pe.subscribe(this._joinInfo.sid,{succ:!1,ec:w.TIMEOUT,audio:t.stream_type===ue.AUDIO,video:t.stream_type===ue.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:xn.measureFromSubscribeStart(this.store.clientId,t.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(t.ssrcId)})}})),this._gateway.signal.on(Ae.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(Ae.ON_PUBLISHED_USER_LIST,(e=>{if(e==null||!e.users)return;b("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((i=>!sa(i.string_id||i.stream_id,this.channelName))));const t=[],n=[];for(const i of e.users){let r=this._users.find((l=>l._uintid===i.stream_id));r?r._trust_in_room_=!0:(r=new ho(i.string_id||i.stream_id,i.stream_id),this._users.push(r),this.store.firstVideoFrameDecoded(r.uid,{userJoinNotify:Date.now()}),this.getListeners(Be.PUBLISHED_USER_LIST).length===0&&(_.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(Be.USER_JOINED,r)));const s=mn.Audio&i.stream_type,o=(mn.Video|mn.LwoVideo)&i.stream_type,a=(65280&i.stream_type)!=0,c=s&&r.hasAudio,d=o&&r.hasVideo;o&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=i.video_ssrc,r._rtxSsrcId=i.video_rtx),s&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=i.audio_ssrc),s&&!c&&this.getListeners(Be.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(Be.USER_PUBLISHED,r,"audio")),o&&!d&&this.getListeners(Be.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(Be.USER_PUBLISHED,r,"video")),(s&&!c||o&&!d||a)&&t.push(r),o&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&n.push({user:r,mediaType:"video"}),s&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&n.push({user:r,mediaType:"audio"})}n.length>0&&(_.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((i=>"user: ".concat(i.user.uid,", mediaType: ").concat(i.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((i=>{_.error("[".concat(this._clientId,"] mass resubscribe error"),i.toString())}))),this.getListeners(Be.PUBLISHED_USER_LIST).length>0?b("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(_.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map((i=>i.uid)).join(", "))),this.safeEmit(Be.PUBLISHED_USER_LIST,t)):_.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map((i=>i.uid)).join(", ")))})),this._gateway.signal.on(Ae.ON_RTP_CAPABILITY_CHANGE,(e=>{const{video_codec:t}=e;if(this._p2pChannel instanceof ua){if(this.role==="audience"&&b("UPDATE_RTP_CAP_IN_HOST"))return this._pendingRtpCapabilityChange=e,void _.debug("[".concat(this._clientId,"] no need to change rtp capability because of audience, params: ").concat(JSON.stringify(e)));this._p2pChannel.updateRemoteRTPCapabilities(t.map((n=>n.toLowerCase())).filter((n=>{var i;return X(i=Object.keys(Qo)).call(i,n)})))}})),this._gateway.signal.on(fe.VOS_FALLBACK_PROMISE,(async(e,t,n)=>{if(e==="FALLBACKCN"&&b("ENABLE_QUALITY_FALLBACK")){if(!this._joinInfo)return n(new V(w.UNEXPECTED_ERROR,"can not recover, no join info"));_.info("[".concat(this._clientId,"] try fallback to cn, start request new server info"));const r=this._joinInfo.apRequestDetail;try{this._joinInfo.apRequestDetail=e;const s=await sp(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Xt,this.store);if(b("QUALITY_FALLBACK_REHEARSAL"))return pe.reportApiInvoke(this._sessionId,{name:Nt.VOS_FALLBACK_CN,options:{cur:s.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:Tt.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r,void n();this._fallbackServerInfo=s,t()}catch(s){var i;const o=s==null||(i=s.data)===null||i===void 0?void 0:i.desc;b("QUALITY_FALLBACK_REHEARSAL")?(pe.reportApiInvoke(this._sessionId,{name:Nt.VOS_FALLBACK_CN,options:{cur:"failed, errorReason: "+o||"unknown",prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:Tt.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r):Array.isArray(o)&&X(o).call(o,"request downgrade fallback")&&this.safeEmit(Be.FALLBACK_TO_HLS,CE.AP_ERROR),n(s)}}else n()}))}_handleP2PEvents(){this._gateway.signal.on(Ae.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(Yt.PUBLISH,((e,t,n)=>{const{uid:i}=e;e.forEach((r=>{const{kind:s,ssrcs:o,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(s,i,o[0].ssrcId,a);const d=this._users.find((l=>l.uid===i));return d&&this.store.useP2P?this._p2pChannel.mockSubscribe(d,s,o[0].ssrcId,a).then((()=>{t()})).catch(n):t(),this._handleMuteStream(i,s,!!c)}))})),this._gateway.signal.on(Yt.CALL,(async(e,t,n)=>{if(this.store.useP2P)try{var i;t(await this._p2pChannel.startP2P({turnServer:(i=this._joinInfo)===null||i===void 0?void 0:i.turnServer},e))}catch(r){n(r)}})),this._gateway.signal.on(fe.P2P_CONNECTION,(async e=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(e)})),this._gateway.signal.on(Yt.UNPUBLISH,(async(e,t,n)=>{if(this.store.useP2P){const{unpubMsg:i,uid:r}=e,s=this._users.find((o=>o.uid===r));if(!s)return _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void t();try{i.forEach((async o=>{let{stream_type:a}=o;const c=a===pt.Audio?ue.AUDIO:ue.VIDEO;await this._p2pChannel.unsubscribe(s,c),this._handleMuteStream(r,c,!0)})),t()}catch(o){n(o)}}})),this._gateway.signal.on(Yt.CONTROL,(async(e,t)=>{const{action:n}=e;switch(n){case co.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,ue.VIDEO,!0);break;case co.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,ue.AUDIO,!0);break;case co.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,ue.VIDEO,!1);break;case co.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,ue.AUDIO,!1)}})),this._gateway.signal.on(Yt.RESTART_ICE,(async(e,t,n)=>{if(this.store.useP2P)try{const{direction:i,iceParameter:r}=e;i!==$n.SEND_ONLY||r?t(await this._p2pChannel.restartICE(i,r)):(this._p2pChannel.handleDisconnect(i),t())}catch(i){n(i)}})),this._gateway.signal.on(Yt.CANDIDATE,(e=>{if(this.store.useP2P){const{candidate:t,direction:n}=e;this._p2pChannel.addRemoteCandidate(t,n)}})),this._p2pChannel.on(ge.RequestP2PRestartICE,(async(e,t,n)=>{try{const{direction:i}=e;t(await this._gateway.sendExtensionMessage(Yt.RESTART_ICE,e,i===$n.SEND_ONLY))}catch(i){n(i)}})),this._p2pChannel.on(ge.LocalCandidate,(e=>{this._gateway.sendExtensionMessage(Yt.CANDIDATE,JSON.stringify(e),!0)})),this._p2pChannel.on(ge.RequestP2PMuteLocal,(async(e,t,n)=>{try{await this._gateway.sendExtensionMessage(Yt.CONTROL,e,!0),t()}catch(i){n(i)}})),this._p2pChannel.on(ge.RequestP2PUnmuteRemote,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===w.DISCONNECT_P2P?t():n(i)}else t()})),this._p2pChannel.on(ge.RequestP2PMuteRemote,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===w.DISCONNECT_P2P?t():n(i)}else t()})),this._p2pChannel.on(ge.StateChange,((e,t)=>{t===st.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(ge.PeerConnectionStateChange,(e=>{const t=this._peerConnectionState;e!==t&&(this.safeEmit(Be.PEERCONNECTION_STATE_CHANGE,e,t),this._peerConnectionState=e)})),this._p2pChannel.on(ge.RequestMuteLocal,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===w.DISCONNECT_P2P?t():n(i)}else t()})),this._p2pChannel.on(ge.RequestUnmuteLocal,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===w.DISCONNECT_P2P?t():n(i)}else t()})),this._p2pChannel.on(ge.RequestRePublish,((e,t,n)=>{this.publish(e,!1).then(t).catch(n)})),this._p2pChannel.on(ge.RequestRePublishDataChannel,((e,t,n)=>{ie.all(e.map((async i=>{const r=await this._p2pChannel.publishDataChannel([i]);try{r.forEach((s=>{this._uid&&this._gateway.publishDataChannel(this._uid,s,!0)}))}catch(s){if(s.code!==w.DISCONNECT_P2P)throw s}}))).then(t).catch(n)})),this._p2pChannel.on(ge.RequestReSubscribe,(async(e,t,n)=>{try{for(const{user:i,kind:r}of e)r===ue.VIDEO?await this.subscribe(i,"video"):await this.subscribe(i,"audio");t()}catch(i){n(i)}})),this._p2pChannel.on(ge.RequestUpload,((e,t)=>{this._gateway.upload(e,t)})),this._p2pChannel.on(ge.RequestUploadStats,(e=>{this._gateway.uploadWRTCStats(e)})),this._p2pChannel.on(ge.MediaReconnectStart,(e=>{this.safeEmit(Be.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(ge.MediaReconnectEnd,(e=>{this.safeEmit(Be.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(ge.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(ge.RequestRestartICE,(async e=>{if(this.store.useP2P)return;const t=await this._p2pChannel.restartICE(e),n=await t.next();if(n.done)return;const i=n.value;let r;try{r=await this._gateway.restartICE({iceParameters:i})}catch(o){return void t.throw(o)}const{iceParameters:s}=(function(o){const a=o.iceParameters;return{iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}})(r);await t.next({remoteIceParameters:s})})),this._p2pChannel.on(ge.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(ge.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:r,gatewayAddress:s}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:n,rtpCapabilities:i}),o=rN(r,s);await this._p2pChannel.connect(o),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(ge.RequestUnpublishForReconnectPC,(async(e,t,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),t()):n()})),this._p2pChannel.on(ge.P2PLost,(()=>{this.safeEmit(Be.P2P_LOST,this.store.uid)})),this._p2pChannel.on(ge.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(ge.ConnectionTypeChange,(e=>{this.safeEmit(Be.IS_USING_CLOUD_PROXY,e),this._gateway.setUsingProxy(e)})),this._p2pChannel.on(ge.FirstVideoBufferReady,((e,t)=>{this.safeEmit(Be.FIRST_VIDEO_BUFFER_READY,e,t)})),this._p2pChannel.on(ge.FirstVideoPreRender,((e,t)=>{this.safeEmit(Be.FIRST_VIDEO_PRE_RENDER,e,t)})),this._p2pChannel.on(ge.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(ge.QueryClientConnectionState,(e=>{e(this.connectionState)})),this._p2pChannel.on(ge.AudioMetadata,(e=>{this.safeEmit(Be.AUDIO_METADATA,e)})),this._p2pChannel.on(ge.AudioPts,(e=>{this.safeEmit(Be.AUDIO_PTS,Number(e))}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new V(w.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new V(w.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const n=(t={config:e},Ur("ContentInspect").create(t));this._inspect=n,this.handleVideoInspectEvents(n);const{appId:i,cname:r,sid:s,token:o,uid:a,cid:c,vid:d}=this._joinInfo;await n.init({appId:i,areaCode:"",cname:r,sid:s,token:o,uid:a,cid:c,vid:d?Number(d):0},Xt)}catch(n){throw Array.isArray(n)?n[0]:n}var t}handleVideoInspectEvents(e){e.on(Tn.CONNECTION_STATE_CHANGE,((t,n)=>{if(this.safeEmit(Be.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,n),n===pr.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(Be.CONTENT_INSPECT_ERROR,new V(w.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(Tn.INSPECT_RESULT,((t,n)=>{var i;if(n?.code===w.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return _.debug("Stop inspect content because that has left channel"),this==null||(i=this._inspect)===null||i===void 0||i.close(),void(this._inspect=void 0);this.safeEmit(Be.CONTENT_INSPECT_RESULT,t,n)})),e.on(Tn.CLIENT_LOCAL_VIDEO_TRACK,(t=>{t(this.localTracks.filter((n=>n.trackMediaType==="video"))[0])}))}async disableContentInspect(){if(!this._inspect)throw new V(w.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(cr(e,"enabled"),e){if(!t)throw new V(w.INVALID_PARAMS,"config is required");if(gD(t),!this._joinInfo)throw new V(w.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(t);else{const i=(n={config:t},Ur("ImageModeration").create(n));this._moderation=i,this.handleImageModerationEvents(i);const{appId:r,cname:s,sid:o,token:a,uid:c,cid:d,vid:l}=this._joinInfo;await i.init({appId:r,areaCode:"",cname:s,sid:o,token:a,uid:c,cid:d,vid:l?Number(l):0},Xt)}}catch(i){throw Array.isArray(i)?i[0]:i}}else{var n;if(!this._moderation)throw new V(w.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(i){throw Array.isArray(i)?i[0]:i}}}handleImageModerationEvents(e){e.on(Mr.CONNECTION_STATE_CHANGE,((t,n)=>{if(this.safeEmit(Be.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,n),t===qi.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new V(w.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(Mr.CLIENT_LOCAL_VIDEO_TRACK,(t=>{t(this.localTracks.filter((n=>n.trackMediaType==="video"))[0])}))}setP2PTransport(e){if((function(t){qt(t,"transport",["default","auto","relay","sd-rtn"])})(e),this.mode!=="p2p")throw new V(w.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,_.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}getJoinChannelServiceRecords(){return _.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){cr(e,"enabled"),_t("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_setRteInfo(e,t){this.store.rteUrl=e,this.store.rteSid=t}_isPreRender(){return"isPreRender"in this._p2pChannel&&this._p2pChannel.isPreRender()}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}},re(le.prototype,"leave",[SD],Object.getOwnPropertyDescriptor(le.prototype,"leave"),le.prototype),re(le.prototype,"publish",[TD],Object.getOwnPropertyDescriptor(le.prototype,"publish"),le.prototype),re(le.prototype,"unpublish",[yD],Object.getOwnPropertyDescriptor(le.prototype,"unpublish"),le.prototype),re(le.prototype,"subscribe",[vD],Object.getOwnPropertyDescriptor(le.prototype,"subscribe"),le.prototype),re(le.prototype,"presubscribe",[RD],Object.getOwnPropertyDescriptor(le.prototype,"presubscribe"),le.prototype),re(le.prototype,"massSubscribe",[CD],Object.getOwnPropertyDescriptor(le.prototype,"massSubscribe"),le.prototype),re(le.prototype,"unsubscribe",[bD],Object.getOwnPropertyDescriptor(le.prototype,"unsubscribe"),le.prototype),re(le.prototype,"massUnsubscribe",[ID],Object.getOwnPropertyDescriptor(le.prototype,"massUnsubscribe"),le.prototype),re(le.prototype,"setLowStreamParameter",[wD],Object.getOwnPropertyDescriptor(le.prototype,"setLowStreamParameter"),le.prototype),re(le.prototype,"setDualStreamMode",[AD],Object.getOwnPropertyDescriptor(le.prototype,"setDualStreamMode"),le.prototype),re(le.prototype,"enableDualStream",[OD],Object.getOwnPropertyDescriptor(le.prototype,"enableDualStream"),le.prototype),re(le.prototype,"disableDualStream",[ND],Object.getOwnPropertyDescriptor(le.prototype,"disableDualStream"),le.prototype),re(le.prototype,"setClientRole",[DD],Object.getOwnPropertyDescriptor(le.prototype,"setClientRole"),le.prototype),re(le.prototype,"_setClientRoleOptions",[PD],Object.getOwnPropertyDescriptor(le.prototype,"_setClientRoleOptions"),le.prototype),re(le.prototype,"setProxyServer",[LD],Object.getOwnPropertyDescriptor(le.prototype,"setProxyServer"),le.prototype),re(le.prototype,"setTurnServer",[kD],Object.getOwnPropertyDescriptor(le.prototype,"setTurnServer"),le.prototype),re(le.prototype,"setLicense",[xD],Object.getOwnPropertyDescriptor(le.prototype,"setLicense"),le.prototype),re(le.prototype,"startProxyServer",[MD],Object.getOwnPropertyDescriptor(le.prototype,"startProxyServer"),le.prototype),re(le.prototype,"stopProxyServer",[UD],Object.getOwnPropertyDescriptor(le.prototype,"stopProxyServer"),le.prototype),re(le.prototype,"setLocalAccessPointsV2",[VD],Object.getOwnPropertyDescriptor(le.prototype,"setLocalAccessPointsV2"),le.prototype),re(le.prototype,"setLocalAccessPoints",[jD],Object.getOwnPropertyDescriptor(le.prototype,"setLocalAccessPoints"),le.prototype),re(le.prototype,"setRemoteDefaultVideoStreamType",[FD],Object.getOwnPropertyDescriptor(le.prototype,"setRemoteDefaultVideoStreamType"),le.prototype),re(le.prototype,"setRemoteVideoStreamType",[BD],Object.getOwnPropertyDescriptor(le.prototype,"setRemoteVideoStreamType"),le.prototype),re(le.prototype,"setStreamFallbackOption",[WD],Object.getOwnPropertyDescriptor(le.prototype,"setStreamFallbackOption"),le.prototype),re(le.prototype,"setEncryptionConfig",[GD],Object.getOwnPropertyDescriptor(le.prototype,"setEncryptionConfig"),le.prototype),re(le.prototype,"renewToken",[HD],Object.getOwnPropertyDescriptor(le.prototype,"renewToken"),le.prototype),re(le.prototype,"enableAudioVolumeIndicator",[KD],Object.getOwnPropertyDescriptor(le.prototype,"enableAudioVolumeIndicator"),le.prototype),re(le.prototype,"startLiveStreaming",[YD],Object.getOwnPropertyDescriptor(le.prototype,"startLiveStreaming"),le.prototype),re(le.prototype,"setLiveTranscoding",[zD],Object.getOwnPropertyDescriptor(le.prototype,"setLiveTranscoding"),le.prototype),re(le.prototype,"stopLiveStreaming",[qD],Object.getOwnPropertyDescriptor(le.prototype,"stopLiveStreaming"),le.prototype),re(le.prototype,"startChannelMediaRelay",[XD],Object.getOwnPropertyDescriptor(le.prototype,"startChannelMediaRelay"),le.prototype),re(le.prototype,"updateChannelMediaRelay",[JD],Object.getOwnPropertyDescriptor(le.prototype,"updateChannelMediaRelay"),le.prototype),re(le.prototype,"stopChannelMediaRelay",[QD],Object.getOwnPropertyDescriptor(le.prototype,"stopChannelMediaRelay"),le.prototype),re(le.prototype,"sendCustomReportMessage",[ZD],Object.getOwnPropertyDescriptor(le.prototype,"sendCustomReportMessage"),le.prototype),re(le.prototype,"pickSVCLayer",[$D],Object.getOwnPropertyDescriptor(le.prototype,"pickSVCLayer"),le.prototype),re(le.prototype,"setRTMConfig",[eP],Object.getOwnPropertyDescriptor(le.prototype,"setRTMConfig"),le.prototype),re(le.prototype,"enableContentInspect",[tP],Object.getOwnPropertyDescriptor(le.prototype,"enableContentInspect"),le.prototype),re(le.prototype,"disableContentInspect",[nP],Object.getOwnPropertyDescriptor(le.prototype,"disableContentInspect"),le.prototype),re(le.prototype,"setImageModeration",[iP],Object.getOwnPropertyDescriptor(le.prototype,"setImageModeration"),le.prototype),re(le.prototype,"setP2PTransport",[rP],Object.getOwnPropertyDescriptor(le.prototype,"setP2PTransport"),le.prototype),re(le.prototype,"getJoinChannelServiceRecords",[sP],Object.getOwnPropertyDescriptor(le.prototype,"getJoinChannelServiceRecords"),le.prototype),re(le.prototype,"setPublishAudioFilterEnabled",[oP],Object.getOwnPropertyDescriptor(le.prototype,"setPublishAudioFilterEnabled"),le.prototype),le);function cP(){var e;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=ut(5,"client-"),i=pe.reportApiInvoke(null,{id:n,name:Nt.CREATE_CLIENT,options:[t],tag:Tt.TRACER});try{(function(r){qt(r.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),qt(r.mode,"config.mode",["rtc","live","p2p"]),r.audioCodec!==void 0&&qt(r.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),r.proxyServer!==void 0&&bn(r.proxyServer,"config.proxyServer",1,1e4),r.turnServer!==void 0&&Fw(r.turnServer),r.httpRetryConfig!==void 0&&jw(r.httpRetryConfig),r.websocketRetryConfig!==void 0&&jw(r.websocketRetryConfig)})(t)}catch(r){throw i.onError(r),r}return(Iw(16,0,!0)||EE(16,0,!0))&&(t.codec==="vp9"&&(t.codec="vp8",_.debug("browser not support vp9, force use vp8")),_t("UNSUPPORTED_VIDEO_CODEC",["vp9"])),t.audioCodec===void 0&&(t.audioCodec="opus"),i.onSuccess(),new oK(gr(gr({forceWaitGatewayResponse:!0},t),{},{role:X(e=["rtc","p2p"]).call(e,t.mode)?"host":t.role||"audience"}),n)}function aK(){let e=!1;const t=Ze();return(t.name===tt.CHROME&&Number(t.version)>=58&&(Nr.engine.name!=="WebKit"||(function(){const n=Ze();if(mh()){if(n.os===un.MAC_OS)return!0;if(n.os===un.IOS){const i=Nr.os.version&&Nr.os.version.split(".");if(i&&Number(i[0])===14&&i[1]&&Number(i[1])>=3||i&&Number(i[0])>14)return!0}}return!1})())||t.name===tt.FIREFOX&&Number(t.version)>=56||t.name===tt.OPERA&&Number(t.version)>=45||t.name===tt.SAFARI&&Number(t.version)>=11||t.name==="WebKit"&&(Fn()||ar())&&t.osVersion&&Number(t.osVersion.split(".")[0])>=11||Ow()||Ze().name===tt.QQ)&&(e=!0),e}class ll{constructor(t,n){v(this,"id",0),v(this,"element",void 0),v(this,"peerPair",void 0),v(this,"context",void 0),v(this,"audioPlayerElement",void 0),v(this,"audioTrack",void 0),ll.count+=1,this.id=ll.count,this.element=t,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const n=document.createElement("audio");n.srcObject=new MediaStream([t.track]),n.play(),this.audioPlayerElement=n}}async switchSdp(){if(!this.peerPair)return;const t=async(i,r)=>{const s=r==="offer"?await i.createOffer():await i.createAnswer();return await i.setLocalDescription(s),i.iceGatheringState==="complete"?i.localDescription:new ie((o=>{i.onicegatheringstatechange=()=>{i.iceGatheringState==="complete"&&o(i.localDescription)}}))},n=async(i,r)=>await i.setRemoteDescription(r);try{const i=await t(this.peerPair[0],"offer");await n(this.peerPair[1],i);const r=await t(this.peerPair[1],"answer");await n(this.peerPair[0],r)}catch(i){throw new V(w.LOCAL_AEC_ERROR,i.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let n;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(n)}catch(r){throw new V(w.LOCAL_AEC_ERROR,r.toString()).print()}if(!n)throw new V(w.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=n.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,n=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp()}close(){_.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((t=>{t.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var dP,gp;v(ll,"count",0);const cK=window.AudioContext||window.webkitAudioContext,dK=new(dP=ve({report:pe}),re((gp=class{constructor(){v(this,"units",[]),v(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return _.debug("the system does not need to process local aec"),-1;this.context||(this.context=new cK);let t=this.units.find((n=>n&&n.getElement()===e));return t||(t=new ll(e,this.context),this.units.push(t)),t.startEchoCancellation(),_.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return Ze().name!==tt.SAFARI}}).prototype,"processExternalMediaAEC",[dP],Object.getOwnPropertyDescriptor(gp.prototype,"processExternalMediaAEC"),gp.prototype),gp);function lP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function uP(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?lP(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):lP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const lS=window||document;function hP(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!lS)return;const n=tn._cspEventHandlerPointer;if(n&&t)return void console.error(n,t);const i=r=>{if(!(r&&r.blockedURI&&(tn.onSecurityPolicyViolation||tn.getListeners(as.SECURITY_POLICY_VIOLATION).length>0)))return;const s=r.blockedURI;b("CSP_DETECTED_HOSTNAME_LIST").some((o=>X(s).call(s,o)))&&(tn.onSecurityPolicyViolation&&typeof tn.onSecurityPolicyViolation=="function"&&tn.onSecurityPolicyViolation(r),tn.getListeners(as.SECURITY_POLICY_VIOLATION).length>0&&tn.safeEmit(as.SECURITY_POLICY_VIOLATION,r))};n&&lS.removeEventListener("securitypolicyviolation",n),(t||e&&typeof e=="function"||tn.getListeners(as.SECURITY_POLICY_VIOLATION).length>0)&&lS.addEventListener("securitypolicyviolation",i),tn._cspEventHandlerPointer=i}var lK=q,uK=R_,pP=RegExp.prototype,hK=function(e){return e===pP||lK(pP,e)?uK(e):e.flags},Kn=D(hK);function Bc(e){let t=e.length;for(;--t>=0;)e[t]=0}const uS=256,mP=286,ul=30,hl=15,hS=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Sp=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),pK=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),fP=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ms=new Array(576);Bc(Ms);const pl=new Array(60);Bc(pl);const ml=new Array(512);Bc(ml);const fl=new Array(256);Bc(fl);const pS=new Array(29);Bc(pS);const Tp=new Array(ul);function mS(e,t,n,i,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=e&&e.length}let _P,EP,gP;function fS(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}Bc(Tp);const SP=e=>e<256?ml[e]:ml[256+(e>>>7)],_l=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},Vi=(e,t,n)=>{e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,_l(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)},ps=(e,t,n)=>{Vi(e,n[2*t],n[2*t+1])},TP=(e,t)=>{let n=0;do n|=1&e,e>>>=1,n<<=1;while(--t>0);return n>>>1},yP=(e,t,n)=>{const i=new Array(16);let r,s,o=0;for(r=1;r<=hl;r++)o=o+n[r-1]<<1,i[r]=o;for(s=0;s<=t;s++){let a=e[2*s+1];a!==0&&(e[2*s]=TP(i[a]++,a))}},vP=e=>{let t;for(t=0;t<mP;t++)e.dyn_ltree[2*t]=0;for(t=0;t<ul;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},RP=e=>{e.bi_valid>8?_l(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},CP=(e,t,n,i)=>{const r=2*t,s=2*n;return e[r]<e[s]||e[r]===e[s]&&i[t]<=i[n]},_S=(e,t,n)=>{const i=e.heap[n];let r=n<<1;for(;r<=e.heap_len&&(r<e.heap_len&&CP(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!CP(t,i,e.heap[r],e.depth));)e.heap[n]=e.heap[r],n=r,r<<=1;e.heap[n]=i},bP=(e,t,n)=>{let i,r,s,o,a=0;if(e.sym_next!==0)do i=255&e.pending_buf[e.sym_buf+a++],i+=(255&e.pending_buf[e.sym_buf+a++])<<8,r=e.pending_buf[e.sym_buf+a++],i===0?ps(e,r,t):(s=fl[r],ps(e,s+uS+1,t),o=hS[s],o!==0&&(r-=pS[s],Vi(e,r,o)),i--,s=SP(i),ps(e,s,n),o=Sp[s],o!==0&&(i-=Tp[s],Vi(e,i,o)));while(a<e.sym_next);ps(e,256,t)},ES=(e,t)=>{const n=t.dyn_tree,i=t.stat_desc.static_tree,r=t.stat_desc.has_stree,s=t.stat_desc.elems;let o,a,c,d=-1;for(e.heap_len=0,e.heap_max=573,o=0;o<s;o++)n[2*o]!==0?(e.heap[++e.heap_len]=d=o,e.depth[o]=0):n[2*o+1]=0;for(;e.heap_len<2;)c=e.heap[++e.heap_len]=d<2?++d:0,n[2*c]=1,e.depth[c]=0,e.opt_len--,r&&(e.static_len-=i[2*c+1]);for(t.max_code=d,o=e.heap_len>>1;o>=1;o--)_S(e,n,o);c=s;do o=e.heap[1],e.heap[1]=e.heap[e.heap_len--],_S(e,n,1),a=e.heap[1],e.heap[--e.heap_max]=o,e.heap[--e.heap_max]=a,n[2*c]=n[2*o]+n[2*a],e.depth[c]=(e.depth[o]>=e.depth[a]?e.depth[o]:e.depth[a])+1,n[2*o+1]=n[2*a+1]=c,e.heap[1]=c++,_S(e,n,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((l,u)=>{const h=u.dyn_tree,p=u.max_code,R=u.stat_desc.static_tree,T=u.stat_desc.has_stree,y=u.stat_desc.extra_bits,I=u.stat_desc.extra_base,A=u.stat_desc.max_length;let N,k,x,P,M,G,Y=0;for(P=0;P<=hl;P++)l.bl_count[P]=0;for(h[2*l.heap[l.heap_max]+1]=0,N=l.heap_max+1;N<573;N++)k=l.heap[N],P=h[2*h[2*k+1]+1]+1,P>A&&(P=A,Y++),h[2*k+1]=P,k>p||(l.bl_count[P]++,M=0,k>=I&&(M=y[k-I]),G=h[2*k],l.opt_len+=G*(P+M),T&&(l.static_len+=G*(R[2*k+1]+M)));if(Y!==0){do{for(P=A-1;l.bl_count[P]===0;)P--;l.bl_count[P]--,l.bl_count[P+1]+=2,l.bl_count[A]--,Y-=2}while(Y>0);for(P=A;P!==0;P--)for(k=l.bl_count[P];k!==0;)x=l.heap[--N],x>p||(h[2*x+1]!==P&&(l.opt_len+=(P-h[2*x+1])*h[2*x],h[2*x+1]=P),k--)}})(e,t),yP(n,d,e.bl_count)},IP=(e,t,n)=>{let i,r,s=-1,o=t[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),t[2*(n+1)+1]=65535,i=0;i<=n;i++)r=o,o=t[2*(i+1)+1],++a<c&&r===o||(a<d?e.bl_tree[2*r]+=a:r!==0?(r!==s&&e.bl_tree[2*r]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,s=r,o===0?(c=138,d=3):r===o?(c=6,d=3):(c=7,d=4))},wP=(e,t,n)=>{let i,r,s=-1,o=t[1],a=0,c=7,d=4;for(o===0&&(c=138,d=3),i=0;i<=n;i++)if(r=o,o=t[2*(i+1)+1],!(++a<c&&r===o)){if(a<d)do ps(e,r,e.bl_tree);while(--a!=0);else r!==0?(r!==s&&(ps(e,r,e.bl_tree),a--),ps(e,16,e.bl_tree),Vi(e,a-3,2)):a<=10?(ps(e,17,e.bl_tree),Vi(e,a-3,3)):(ps(e,18,e.bl_tree),Vi(e,a-11,7));a=0,s=r,o===0?(c=138,d=3):r===o?(c=6,d=3):(c=7,d=4)}};let AP=!1;const OP=(e,t,n,i)=>{Vi(e,0+(i?1:0),3),RP(e),_l(e,n),_l(e,~n),n&&e.pending_buf.set(e.window.subarray(t,t+n),e.pending),e.pending+=n};var mK=e=>{AP||((()=>{let t,n,i,r,s;const o=new Array(16);for(i=0,r=0;r<28;r++)for(pS[r]=i,t=0;t<1<<hS[r];t++)fl[i++]=r;for(fl[i-1]=r,s=0,r=0;r<16;r++)for(Tp[r]=s,t=0;t<1<<Sp[r];t++)ml[s++]=r;for(s>>=7;r<ul;r++)for(Tp[r]=s<<7,t=0;t<1<<Sp[r]-7;t++)ml[256+s++]=r;for(n=0;n<=hl;n++)o[n]=0;for(t=0;t<=143;)Ms[2*t+1]=8,t++,o[8]++;for(;t<=255;)Ms[2*t+1]=9,t++,o[9]++;for(;t<=279;)Ms[2*t+1]=7,t++,o[7]++;for(;t<=287;)Ms[2*t+1]=8,t++,o[8]++;for(yP(Ms,287,o),t=0;t<ul;t++)pl[2*t+1]=5,pl[2*t]=TP(t,5);_P=new mS(Ms,hS,257,mP,hl),EP=new mS(pl,Sp,0,ul,hl),gP=new mS(new Array(0),pK,0,19,7)})(),AP=!0),e.l_desc=new fS(e.dyn_ltree,_P),e.d_desc=new fS(e.dyn_dtree,EP),e.bl_desc=new fS(e.bl_tree,gP),e.bi_buf=0,e.bi_valid=0,vP(e)},fK=(e,t,n,i)=>{let r,s,o=0;e.level>0?(e.strm.data_type===2&&(e.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<uS;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(e)),ES(e,e.l_desc),ES(e,e.d_desc),o=(a=>{let c;for(IP(a,a.dyn_ltree,a.l_desc.max_code),IP(a,a.dyn_dtree,a.d_desc.max_code),ES(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*fP[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(e),r=e.opt_len+3+7>>>3,s=e.static_len+3+7>>>3,s<=r&&(r=s)):r=s=n+5,n+4<=r&&t!==-1?OP(e,t,n,i):e.strategy===4||s===r?(Vi(e,2+(i?1:0),3),bP(e,Ms,pl)):(Vi(e,4+(i?1:0),3),((a,c,d,l)=>{let u;for(Vi(a,c-257,5),Vi(a,d-1,5),Vi(a,l-4,4),u=0;u<l;u++)Vi(a,a.bl_tree[2*fP[u]+1],3);wP(a,a.dyn_ltree,c-1),wP(a,a.dyn_dtree,d-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),bP(e,e.dyn_ltree,e.dyn_dtree)),vP(e),i&&RP(e)},_K=(e,t,n)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=n,t===0?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(fl[n]+uS+1)]++,e.dyn_dtree[2*SP(t)]++),e.sym_next===e.sym_end),EK=e=>{Vi(e,2,3),ps(e,256,Ms),(t=>{t.bi_valid===16?(_l(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(e)},gK={_tr_init:mK,_tr_stored_block:OP,_tr_flush_block:fK,_tr_tally:_K,_tr_align:EK},El=(e,t,n,i)=>{let r=65535&e|0,s=e>>>16&65535|0,o=0;for(;n!==0;){o=n>2e3?2e3:n,n-=o;do r=r+t[i++]|0,s=s+r|0;while(--o);r%=65521,s%=65521}return r|s<<16|0};const SK=new Uint32Array((()=>{let e,t=[];for(var n=0;n<256;n++){e=n;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t})());var ei=(e,t,n,i)=>{const r=SK,s=i+n;e^=-1;for(let o=i;o<s;o++)e=e>>>8^r[255&(e^t[o])];return-1^e},ma={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},yp={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:TK,_tr_stored_block:gS,_tr_flush_block:yK,_tr_tally:_o,_tr_align:vK}=gK,{Z_NO_FLUSH:Eo,Z_PARTIAL_FLUSH:RK,Z_FULL_FLUSH:CK,Z_FINISH:Sr,Z_BLOCK:NP,Z_OK:di,Z_STREAM_END:DP,Z_STREAM_ERROR:ms,Z_DATA_ERROR:bK,Z_BUF_ERROR:SS,Z_DEFAULT_COMPRESSION:IK,Z_FILTERED:wK,Z_HUFFMAN_ONLY:vp,Z_RLE:AK,Z_FIXED:OK,Z_DEFAULT_STRATEGY:NK,Z_UNKNOWN:DK,Z_DEFLATED:Rp}=yp,TS=286,PK=30,LK=19,kK=2*TS+1,xK=15,fa=258,fs=262,Wc=42,_a=113,gl=666,Ea=(e,t)=>(e.msg=ma[t],t),PP=e=>2*e-(e>4?9:0),go=e=>{let t=e.length;for(;--t>=0;)e[t]=0},MK=e=>{let t,n,i,r=e.w_size;t=e.hash_size,i=t;do n=e.head[--i],e.head[i]=n>=r?n-r:0;while(--t);t=r,i=t;do n=e.prev[--i],e.prev[i]=n>=r?n-r:0;while(--t)};let So=(e,t,n)=>(t<<e.hash_shift^n)&e.hash_mask;const Xi=e=>{const t=e.state;let n=t.pending;n>e.avail_out&&(n=e.avail_out),n!==0&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+n),e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,t.pending===0&&(t.pending_out=0))},Ji=(e,t)=>{yK(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Xi(e.strm)},Gt=(e,t)=>{e.pending_buf[e.pending++]=t},Sl=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},yS=(e,t,n,i)=>{let r=e.avail_in;return r>i&&(r=i),r===0?0:(e.avail_in-=r,t.set(e.input.subarray(e.next_in,e.next_in+r),n),e.state.wrap===1?e.adler=El(e.adler,t,r,n):e.state.wrap===2&&(e.adler=ei(e.adler,t,r,n)),e.next_in+=r,e.total_in+=r,r)},LP=(e,t)=>{let n,i,r=e.max_chain_length,s=e.strstart,o=e.prev_length,a=e.nice_match;const c=e.strstart>e.w_size-fs?e.strstart-(e.w_size-fs):0,d=e.window,l=e.w_mask,u=e.prev,h=e.strstart+fa;let p=d[s+o-1],R=d[s+o];e.prev_length>=e.good_match&&(r>>=2),a>e.lookahead&&(a=e.lookahead);do if(n=t,d[n+o]===R&&d[n+o-1]===p&&d[n]===d[s]&&d[++n]===d[s+1]){s+=2,n++;do;while(d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&d[++s]===d[++n]&&s<h);if(i=fa-(h-s),s=h-fa,i>o){if(e.match_start=t,o=i,i>=a)break;p=d[s+o-1],R=d[s+o]}}while((t=u[t&l])>c&&--r!=0);return o<=e.lookahead?o:e.lookahead},Gc=e=>{const t=e.w_size;let n,i,r;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-fs)&&(e.window.set(e.window.subarray(t,t+t-i),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),MK(e),i+=t),e.strm.avail_in===0)break;if(n=yS(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=n,e.lookahead+e.insert>=3)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=So(e,e.ins_h,e.window[r+1]);e.insert&&(e.ins_h=So(e,e.ins_h,e.window[r+3-1]),e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<fs&&e.strm.avail_in!==0)},kP=(e,t)=>{let n,i,r,s=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,o=0,a=e.strm.avail_in;do{if(n=65535,r=e.bi_valid+42>>3,e.strm.avail_out<r||(r=e.strm.avail_out-r,i=e.strstart-e.block_start,n>i+e.strm.avail_in&&(n=i+e.strm.avail_in),n>r&&(n=r),n<s&&(n===0&&t!==Sr||t===Eo||n!==i+e.strm.avail_in)))break;o=t===Sr&&n===i+e.strm.avail_in?1:0,gS(e,0,0,o),e.pending_buf[e.pending-4]=n,e.pending_buf[e.pending-3]=n>>8,e.pending_buf[e.pending-2]=~n,e.pending_buf[e.pending-1]=~n>>8,Xi(e.strm),i&&(i>n&&(i=n),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+i),e.strm.next_out),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i,e.block_start+=i,n-=i),n&&(yS(e.strm,e.strm.output,e.strm.next_out,n),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n)}while(o===0);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),o?4:t!==Eo&&t!==Sr&&e.strm.avail_in===0&&e.strstart===e.block_start?2:(r=e.window_size-e.strstart,e.strm.avail_in>r&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,r+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),r>e.strm.avail_in&&(r=e.strm.avail_in),r&&(yS(e.strm,e.window,e.strstart,r),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.high_water<e.strstart&&(e.high_water=e.strstart),r=e.bi_valid+42>>3,r=e.pending_buf_size-r>65535?65535:e.pending_buf_size-r,s=r>e.w_size?e.w_size:r,i=e.strstart-e.block_start,(i>=s||(i||t===Sr)&&t!==Eo&&e.strm.avail_in===0&&i<=r)&&(n=i>r?r:i,o=t===Sr&&e.strm.avail_in===0&&n===i?1:0,gS(e,e.block_start,n,o),e.block_start+=n,Xi(e.strm)),o?3:1)},vS=(e,t)=>{let n,i;for(;;){if(e.lookahead<fs){if(Gc(e),e.lookahead<fs&&t===Eo)return 1;if(e.lookahead===0)break}if(n=0,e.lookahead>=3&&(e.ins_h=So(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),n!==0&&e.strstart-n<=e.w_size-fs&&(e.match_length=LP(e,n)),e.match_length>=3)if(i=_o(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do e.strstart++,e.ins_h=So(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!=0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=So(e,e.ins_h,e.window[e.strstart+1]);else i=_o(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(Ji(e,!1),e.strm.avail_out===0))return 1}return e.insert=e.strstart<2?e.strstart:2,t===Sr?(Ji(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(Ji(e,!1),e.strm.avail_out===0)?1:2},Hc=(e,t)=>{let n,i,r;for(;;){if(e.lookahead<fs){if(Gc(e),e.lookahead<fs&&t===Eo)return 1;if(e.lookahead===0)break}if(n=0,e.lookahead>=3&&(e.ins_h=So(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,n!==0&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-fs&&(e.match_length=LP(e,n),e.match_length<=5&&(e.strategy===wK||e.match_length===3&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,i=_o(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=r&&(e.ins_h=So(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!=0);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(Ji(e,!1),e.strm.avail_out===0))return 1}else if(e.match_available){if(i=_o(e,0,e.window[e.strstart-1]),i&&Ji(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=_o(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===Sr?(Ji(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(Ji(e,!1),e.strm.avail_out===0)?1:2};function _s(e,t,n,i,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=r}const Tl=[new _s(0,0,0,0,kP),new _s(4,4,8,4,vS),new _s(4,5,16,8,vS),new _s(4,6,32,32,vS),new _s(4,4,16,16,Hc),new _s(8,16,32,32,Hc),new _s(8,16,128,128,Hc),new _s(8,32,128,256,Hc),new _s(32,128,258,1024,Hc),new _s(32,258,258,4096,Hc)];function UK(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Rp,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*kK),this.dyn_dtree=new Uint16Array(2*(2*PK+1)),this.bl_tree=new Uint16Array(2*(2*LK+1)),go(this.dyn_ltree),go(this.dyn_dtree),go(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(xK+1),this.heap=new Uint16Array(2*TS+1),go(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*TS+1),go(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const yl=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==Wc&&t.status!==57&&t.status!==69&&t.status!==73&&t.status!==91&&t.status!==103&&t.status!==_a&&t.status!==gl?1:0},xP=e=>{if(yl(e))return Ea(e,ms);e.total_in=e.total_out=0,e.data_type=DK;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?57:t.wrap?Wc:_a,e.adler=t.wrap===2?0:1,t.last_flush=-2,TK(t),di},MP=e=>{const t=xP(e);return t===di&&(n=>{n.window_size=2*n.w_size,go(n.head),n.max_lazy_match=Tl[n.level].max_lazy,n.good_match=Tl[n.level].good_length,n.nice_match=Tl[n.level].nice_length,n.max_chain_length=Tl[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0})(e.state),t},UP=(e,t,n,i,r,s)=>{if(!e)return ms;let o=1;if(t===IK&&(t=6),i<0?(o=0,i=-i):i>15&&(o=2,i-=16),r<1||r>9||n!==Rp||i<8||i>15||t<0||t>9||s<0||s>OK||i===8&&o!==1)return Ea(e,ms);i===8&&(i=9);const a=new UK;return e.state=a,a.strm=e,a.status=Wc,a.wrap=o,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=s,a.method=n,MP(e)};var VK=(e,t)=>{if(yl(e)||t>NP||t<0)return e?Ea(e,ms):ms;const n=e.state;if(!e.output||e.avail_in!==0&&!e.input||n.status===gl&&t!==Sr)return Ea(e,e.avail_out===0?SS:ms);const i=n.last_flush;if(n.last_flush=t,n.pending!==0){if(Xi(e),e.avail_out===0)return n.last_flush=-1,di}else if(e.avail_in===0&&PP(t)<=PP(i)&&t!==Sr)return Ea(e,SS);if(n.status===gl&&e.avail_in!==0)return Ea(e,SS);if(n.status===Wc&&n.wrap===0&&(n.status=_a),n.status===Wc){let r=Rp+(n.w_bits-8<<4)<<8,s=-1;if(s=n.strategy>=vp||n.level<2?0:n.level<6?1:n.level===6?2:3,r|=s<<6,n.strstart!==0&&(r|=32),r+=31-r%31,Sl(n,r),n.strstart!==0&&(Sl(n,e.adler>>>16),Sl(n,65535&e.adler)),e.adler=1,n.status=_a,Xi(e),n.pending!==0)return n.last_flush=-1,di}if(n.status===57){if(e.adler=0,Gt(n,31),Gt(n,139),Gt(n,8),n.gzhead)Gt(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),Gt(n,255&n.gzhead.time),Gt(n,n.gzhead.time>>8&255),Gt(n,n.gzhead.time>>16&255),Gt(n,n.gzhead.time>>24&255),Gt(n,n.level===9?2:n.strategy>=vp||n.level<2?4:0),Gt(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(Gt(n,255&n.gzhead.extra.length),Gt(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=ei(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(Gt(n,0),Gt(n,0),Gt(n,0),Gt(n,0),Gt(n,0),Gt(n,n.level===9?2:n.strategy>=vp||n.level<2?4:0),Gt(n,3),n.status=_a,Xi(e),n.pending!==0)return n.last_flush=-1,di}if(n.status===69){if(n.gzhead.extra){let r=n.pending,s=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+s>n.pending_buf_size;){let a=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>r&&(e.adler=ei(e.adler,n.pending_buf,n.pending-r,r)),n.gzindex+=a,Xi(e),n.pending!==0)return n.last_flush=-1,di;r=0,s-=a}let o=new Uint8Array(n.gzhead.extra);n.pending_buf.set(o.subarray(n.gzindex,n.gzindex+s),n.pending),n.pending+=s,n.gzhead.hcrc&&n.pending>r&&(e.adler=ei(e.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0}n.status=73}if(n.status===73){if(n.gzhead.name){let r,s=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>s&&(e.adler=ei(e.adler,n.pending_buf,n.pending-s,s)),Xi(e),n.pending!==0)return n.last_flush=-1,di;s=0}r=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,Gt(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>s&&(e.adler=ei(e.adler,n.pending_buf,n.pending-s,s)),n.gzindex=0}n.status=91}if(n.status===91){if(n.gzhead.comment){let r,s=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>s&&(e.adler=ei(e.adler,n.pending_buf,n.pending-s,s)),Xi(e),n.pending!==0)return n.last_flush=-1,di;s=0}r=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,Gt(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>s&&(e.adler=ei(e.adler,n.pending_buf,n.pending-s,s))}n.status=103}if(n.status===103){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(Xi(e),n.pending!==0))return n.last_flush=-1,di;Gt(n,255&e.adler),Gt(n,e.adler>>8&255),e.adler=0}if(n.status=_a,Xi(e),n.pending!==0)return n.last_flush=-1,di}if(e.avail_in!==0||n.lookahead!==0||t!==Eo&&n.status!==gl){let r=n.level===0?kP(n,t):n.strategy===vp?((s,o)=>{let a;for(;;){if(s.lookahead===0&&(Gc(s),s.lookahead===0)){if(o===Eo)return 1;break}if(s.match_length=0,a=_o(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++,a&&(Ji(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===Sr?(Ji(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Ji(s,!1),s.strm.avail_out===0)?1:2})(n,t):n.strategy===AK?((s,o)=>{let a,c,d,l;const u=s.window;for(;;){if(s.lookahead<=fa){if(Gc(s),s.lookahead<=fa&&o===Eo)return 1;if(s.lookahead===0)break}if(s.match_length=0,s.lookahead>=3&&s.strstart>0&&(d=s.strstart-1,c=u[d],c===u[++d]&&c===u[++d]&&c===u[++d])){l=s.strstart+fa;do;while(c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&d<l);s.match_length=fa-(l-d),s.match_length>s.lookahead&&(s.match_length=s.lookahead)}if(s.match_length>=3?(a=_o(s,1,s.match_length-3),s.lookahead-=s.match_length,s.strstart+=s.match_length,s.match_length=0):(a=_o(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++),a&&(Ji(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===Sr?(Ji(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(Ji(s,!1),s.strm.avail_out===0)?1:2})(n,t):Tl[n.level].func(n,t);if(r!==3&&r!==4||(n.status=gl),r===1||r===3)return e.avail_out===0&&(n.last_flush=-1),di;if(r===2&&(t===RK?vK(n):t!==NP&&(gS(n,0,0,!1),t===CK&&(go(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),Xi(e),e.avail_out===0))return n.last_flush=-1,di}return t!==Sr?di:n.wrap<=0?DP:(n.wrap===2?(Gt(n,255&e.adler),Gt(n,e.adler>>8&255),Gt(n,e.adler>>16&255),Gt(n,e.adler>>24&255),Gt(n,255&e.total_in),Gt(n,e.total_in>>8&255),Gt(n,e.total_in>>16&255),Gt(n,e.total_in>>24&255)):(Sl(n,e.adler>>>16),Sl(n,65535&e.adler)),Xi(e),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?di:DP)},jK=(e,t)=>{let n=t.length;if(yl(e))return ms;const i=e.state,r=i.wrap;if(r===2||r===1&&i.status!==Wc||i.lookahead)return ms;if(r===1&&(e.adler=El(e.adler,t,n,0)),i.wrap=0,n>=i.w_size){r===0&&(go(i.head),i.strstart=0,i.block_start=0,i.insert=0);let c=new Uint8Array(i.w_size);c.set(t.subarray(n-i.w_size,n),0),t=c,n=i.w_size}const s=e.avail_in,o=e.next_in,a=e.input;for(e.avail_in=n,e.next_in=0,e.input=t,Gc(i);i.lookahead>=3;){let c=i.strstart,d=i.lookahead-2;do i.ins_h=So(i,i.ins_h,i.window[c+3-1]),i.prev[c&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=c,c++;while(--d);i.strstart=c,i.lookahead=2,Gc(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=o,e.input=a,e.avail_in=s,i.wrap=r,di},vl={deflateInit:(e,t)=>UP(e,t,Rp,15,8,NK),deflateInit2:UP,deflateReset:MP,deflateResetKeep:xP,deflateSetHeader:(e,t)=>yl(e)||e.state.wrap!==2?ms:(e.state.gzhead=t,di),deflate:VK,deflateEnd:e=>{if(yl(e))return ms;const t=e.state.status;return e.state=null,t===_a?Ea(e,bK):di},deflateSetDictionary:jK,deflateInfo:"pako deflate (from Nodeca project)"};const FK=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var Cp={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const n=t.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const i in n)FK(n,i)&&(e[i]=n[i])}}return e},flattenChunks:e=>{let t=0;for(let i=0,r=e.length;i<r;i++)t+=e[i].length;const n=new Uint8Array(t);for(let i=0,r=0,s=e.length;i<s;i++){let o=e[i];n.set(o,r),r+=o.length}return n}};let VP=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{VP=!1}const Rl=new Uint8Array(256);for(let e=0;e<256;e++)Rl[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;Rl[254]=Rl[254]=1;var Cl={string2buf:e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let t,n,i,r,s,o=e.length,a=0;for(r=0;r<o;r++)n=e.charCodeAt(r),(64512&n)==55296&&r+1<o&&(i=e.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Uint8Array(a),s=0,r=0;s<a;r++)n=e.charCodeAt(r),(64512&n)==55296&&r+1<o&&(i=e.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?t[s++]=n:n<2048?(t[s++]=192|n>>>6,t[s++]=128|63&n):n<65536?(t[s++]=224|n>>>12,t[s++]=128|n>>>6&63,t[s++]=128|63&n):(t[s++]=240|n>>>18,t[s++]=128|n>>>12&63,t[s++]=128|n>>>6&63,t[s++]=128|63&n);return t},buf2string:(e,t)=>{const n=t||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,t));let i,r;const s=new Array(2*n);for(r=0,i=0;i<n;){let o=e[i++];if(o<128){s[r++]=o;continue}let a=Rl[o];if(a>4)s[r++]=65533,i+=a-1;else{for(o&=a===2?31:a===3?15:7;a>1&&i<n;)o=o<<6|63&e[i++],a--;a>1?s[r++]=65533:o<65536?s[r++]=o:(o-=65536,s[r++]=55296|o>>10&1023,s[r++]=56320|1023&o)}}return((o,a)=>{if(a<65534&&o.subarray&&VP)return String.fromCharCode.apply(null,o.length===a?o:o.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(o[d]);return c})(s,r)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let n=t-1;for(;n>=0&&(192&e[n])==128;)n--;return n<0||n===0?t:n+Rl[e[n]]>t?n:t}},jP=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const FP=Object.prototype.toString,{Z_NO_FLUSH:BK,Z_SYNC_FLUSH:WK,Z_FULL_FLUSH:GK,Z_FINISH:HK,Z_OK:bp,Z_STREAM_END:KK,Z_DEFAULT_COMPRESSION:YK,Z_DEFAULT_STRATEGY:zK,Z_DEFLATED:qK}=yp;function Ip(e){this.options=Cp.assign({level:YK,method:qK,chunkSize:16384,windowBits:15,memLevel:8,strategy:zK},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new jP,this.strm.avail_out=0;let n=vl.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==bp)throw new Error(ma[n]);if(t.header&&vl.deflateSetHeader(this.strm,t.header),t.dictionary){let i;if(i=typeof t.dictionary=="string"?Cl.string2buf(t.dictionary):FP.call(t.dictionary)==="[object ArrayBuffer]"?new Uint8Array(t.dictionary):t.dictionary,n=vl.deflateSetDictionary(this.strm,i),n!==bp)throw new Error(ma[n]);this._dict_set=!0}}function BP(e,t){const n=new Ip(t);if(n.push(e,!0),n.err)throw n.msg||ma[n.err];return n.result}Ip.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize;let r,s;if(this.ended)return!1;for(s=t===~~t?t:t===!0?HK:BK,typeof e=="string"?n.input=Cl.string2buf(e):FP.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;)if(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(s===WK||s===GK)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(r=vl.deflate(n,s),r===KK)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=vl.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===bp;if(n.avail_out!==0){if(s>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(n.avail_in===0)break}else this.onData(n.output)}return!0},Ip.prototype.onData=function(e){this.chunks.push(e)},Ip.prototype.onEnd=function(e){e===bp&&(this.result=Cp.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var XK={deflate:BP,deflateRaw:function(e,t){return(t=t||{}).raw=!0,BP(e,t)}};const wp=16209;var JK=function(e,t){let n,i,r,s,o,a,c,d,l,u,h,p,R,T,y,I,A,N,k,x,P,M,G,Y;const de=e.state;n=e.next_in,G=e.input,i=n+(e.avail_in-5),r=e.next_out,Y=e.output,s=r-(t-e.avail_out),o=r+(e.avail_out-257),a=de.dmax,c=de.wsize,d=de.whave,l=de.wnext,u=de.window,h=de.hold,p=de.bits,R=de.lencode,T=de.distcode,y=(1<<de.lenbits)-1,I=(1<<de.distbits)-1;e:do{p<15&&(h+=G[n++]<<p,p+=8,h+=G[n++]<<p,p+=8),A=R[h&y];t:for(;;){if(N=A>>>24,h>>>=N,p-=N,N=A>>>16&255,N===0)Y[r++]=65535&A;else{if(!(16&N)){if((64&N)==0){A=R[(65535&A)+(h&(1<<N)-1)];continue t}if(32&N){de.mode=16191;break e}e.msg="invalid literal/length code",de.mode=wp;break e}k=65535&A,N&=15,N&&(p<N&&(h+=G[n++]<<p,p+=8),k+=h&(1<<N)-1,h>>>=N,p-=N),p<15&&(h+=G[n++]<<p,p+=8,h+=G[n++]<<p,p+=8),A=T[h&I];n:for(;;){if(N=A>>>24,h>>>=N,p-=N,N=A>>>16&255,!(16&N)){if((64&N)==0){A=T[(65535&A)+(h&(1<<N)-1)];continue n}e.msg="invalid distance code",de.mode=wp;break e}if(x=65535&A,N&=15,p<N&&(h+=G[n++]<<p,p+=8,p<N&&(h+=G[n++]<<p,p+=8)),x+=h&(1<<N)-1,x>a){e.msg="invalid distance too far back",de.mode=wp;break e}if(h>>>=N,p-=N,N=r-s,x>N){if(N=x-N,N>d&&de.sane){e.msg="invalid distance too far back",de.mode=wp;break e}if(P=0,M=u,l===0){if(P+=c-N,N<k){k-=N;do Y[r++]=u[P++];while(--N);P=r-x,M=Y}}else if(l<N){if(P+=c+l-N,N-=l,N<k){k-=N;do Y[r++]=u[P++];while(--N);if(P=0,l<k){N=l,k-=N;do Y[r++]=u[P++];while(--N);P=r-x,M=Y}}}else if(P+=l-N,N<k){k-=N;do Y[r++]=u[P++];while(--N);P=r-x,M=Y}for(;k>2;)Y[r++]=M[P++],Y[r++]=M[P++],Y[r++]=M[P++],k-=3;k&&(Y[r++]=M[P++],k>1&&(Y[r++]=M[P++]))}else{P=r-x;do Y[r++]=Y[P++],Y[r++]=Y[P++],Y[r++]=Y[P++],k-=3;while(k>2);k&&(Y[r++]=Y[P++],k>1&&(Y[r++]=Y[P++]))}break}}break}}while(n<i&&r<o);k=p>>3,n-=k,p-=k<<3,h&=(1<<p)-1,e.next_in=n,e.next_out=r,e.avail_in=n<i?i-n+5:5-(n-i),e.avail_out=r<o?o-r+257:257-(r-o),de.hold=h,de.bits=p};const Ap=15,QK=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),ZK=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),$K=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),e8=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var bl=(e,t,n,i,r,s,o,a)=>{const c=a.bits;let d,l,u,h,p,R,T=0,y=0,I=0,A=0,N=0,k=0,x=0,P=0,M=0,G=0,Y=null;const de=new Uint16Array(16),Ie=new Uint16Array(16);let Ce,Ue,Pe,nt=null;for(T=0;T<=Ap;T++)de[T]=0;for(y=0;y<i;y++)de[t[n+y]]++;for(N=c,A=Ap;A>=1&&de[A]===0;A--);if(N>A&&(N=A),A===0)return r[s++]=20971520,r[s++]=20971520,a.bits=1,0;for(I=1;I<A&&de[I]===0;I++);for(N<I&&(N=I),P=1,T=1;T<=Ap;T++)if(P<<=1,P-=de[T],P<0)return-1;if(P>0&&(e===0||A!==1))return-1;for(Ie[1]=0,T=1;T<Ap;T++)Ie[T+1]=Ie[T]+de[T];for(y=0;y<i;y++)t[n+y]!==0&&(o[Ie[t[n+y]]++]=y);if(e===0?(Y=nt=o,R=20):e===1?(Y=QK,nt=ZK,R=257):(Y=$K,nt=e8,R=0),G=0,y=0,T=I,p=s,k=N,x=0,u=-1,M=1<<N,h=M-1,e===1&&M>852||e===2&&M>592)return 1;for(;;){Ce=T-x,o[y]+1<R?(Ue=0,Pe=o[y]):o[y]>=R?(Ue=nt[o[y]-R],Pe=Y[o[y]-R]):(Ue=96,Pe=0),d=1<<T-x,l=1<<k,I=l;do l-=d,r[p+(G>>x)+l]=Ce<<24|Ue<<16|Pe|0;while(l!==0);for(d=1<<T-1;G&d;)d>>=1;if(d!==0?(G&=d-1,G+=d):G=0,y++,--de[T]==0){if(T===A)break;T=t[n+o[y]]}if(T>N&&(G&h)!==u){for(x===0&&(x=N),p+=I,k=T-x,P=1<<k;k+x<A&&(P-=de[k+x],!(P<=0));)k++,P<<=1;if(M+=1<<k,e===1&&M>852||e===2&&M>592)return 1;u=G&h,r[u]=N<<24|k<<16|p-s|0}}return G!==0&&(r[p+G]=T-x<<24|64<<16|0),a.bits=N,0};const{Z_FINISH:WP,Z_BLOCK:t8,Z_TREES:Op,Z_OK:ga,Z_STREAM_END:n8,Z_NEED_DICT:i8,Z_STREAM_ERROR:Tr,Z_DATA_ERROR:GP,Z_MEM_ERROR:HP,Z_BUF_ERROR:r8,Z_DEFLATED:KP}=yp,Np=16180,Dp=16190,Us=16191,RS=16192,CS=16194,Pp=16199,Lp=16200,bS=16206,vn=16209,YP=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function s8(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Sa=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<Np||t.mode>16211?1:0},zP=e=>{if(Sa(e))return Tr;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=Np,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,ga},qP=e=>{if(Sa(e))return Tr;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,zP(e)},XP=(e,t)=>{let n;if(Sa(e))return Tr;const i=e.state;return t<0?(n=0,t=-t):(n=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Tr:(i.window!==null&&i.wbits!==t&&(i.window=null),i.wrap=n,i.wbits=t,qP(e))},JP=(e,t)=>{if(!e)return Tr;const n=new s8;e.state=n,n.strm=e,n.window=null,n.mode=Np;const i=XP(e,t);return i!==ga&&(e.state=null),i};let IS,wS,QP=!0;const o8=e=>{if(QP){IS=new Int32Array(512),wS=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(bl(1,e.lens,0,288,IS,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;bl(2,e.lens,0,32,wS,0,e.work,{bits:5}),QP=!1}e.lencode=IS,e.lenbits=9,e.distcode=wS,e.distbits=5},ZP=(e,t,n,i)=>{let r;const s=e.state;return s.window===null&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),i>=s.wsize?(s.window.set(t.subarray(n-s.wsize,n),0),s.wnext=0,s.whave=s.wsize):(r=s.wsize-s.wnext,r>i&&(r=i),s.window.set(t.subarray(n-i,n-i+r),s.wnext),(i-=r)?(s.window.set(t.subarray(n-i,n),0),s.wnext=i,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0};var a8=(e,t)=>{let n,i,r,s,o,a,c,d,l,u,h,p,R,T,y,I,A,N,k,x,P,M,G=0;const Y=new Uint8Array(4);let de,Ie;const Ce=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Sa(e)||!e.output||!e.input&&e.avail_in!==0)return Tr;n=e.state,n.mode===Us&&(n.mode=RS),o=e.next_out,r=e.output,c=e.avail_out,s=e.next_in,i=e.input,a=e.avail_in,d=n.hold,l=n.bits,u=a,h=c,M=ga;e:for(;;)switch(n.mode){case Np:if(n.wrap===0){n.mode=RS;break}for(;l<16;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if(2&n.wrap&&d===35615){n.wbits===0&&(n.wbits=15),n.check=0,Y[0]=255&d,Y[1]=d>>>8&255,n.check=ei(n.check,Y,2,0),d=0,l=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&d)<<8)+(d>>8))%31){e.msg="incorrect header check",n.mode=vn;break}if((15&d)!==KP){e.msg="unknown compression method",n.mode=vn;break}if(d>>>=4,l-=4,P=8+(15&d),n.wbits===0&&(n.wbits=P),P>15||P>n.wbits){e.msg="invalid window size",n.mode=vn;break}n.dmax=1<<n.wbits,n.flags=0,e.adler=n.check=1,n.mode=512&d?16189:Us,d=0,l=0;break;case 16181:for(;l<16;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if(n.flags=d,(255&Kn(n))!==KP){e.msg="unknown compression method",n.mode=vn;break}if(57344&Kn(n)){e.msg="unknown header flags set",n.mode=vn;break}n.head&&(n.head.text=d>>8&1),512&Kn(n)&&4&n.wrap&&(Y[0]=255&d,Y[1]=d>>>8&255,n.check=ei(n.check,Y,2,0)),d=0,l=0,n.mode=16182;case 16182:for(;l<32;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}n.head&&(n.head.time=d),512&Kn(n)&&4&n.wrap&&(Y[0]=255&d,Y[1]=d>>>8&255,Y[2]=d>>>16&255,Y[3]=d>>>24&255,n.check=ei(n.check,Y,4,0)),d=0,l=0,n.mode=16183;case 16183:for(;l<16;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}n.head&&(n.head.xflags=255&d,n.head.os=d>>8),512&Kn(n)&&4&n.wrap&&(Y[0]=255&d,Y[1]=d>>>8&255,n.check=ei(n.check,Y,2,0)),d=0,l=0,n.mode=16184;case 16184:if(1024&Kn(n)){for(;l<16;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}n.length=d,n.head&&(n.head.extra_len=d),512&Kn(n)&&4&n.wrap&&(Y[0]=255&d,Y[1]=d>>>8&255,n.check=ei(n.check,Y,2,0)),d=0,l=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&Kn(n)&&(p=n.length,p>a&&(p=a),p&&(n.head&&(P=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(s,s+p),P)),512&Kn(n)&&4&n.wrap&&(n.check=ei(n.check,i,p,s)),a-=p,s+=p,n.length-=p),n.length))break e;n.length=0,n.mode=16186;case 16186:if(2048&Kn(n)){if(a===0)break e;p=0;do P=i[s+p++],n.head&&P&&n.length<65536&&(n.head.name+=String.fromCharCode(P));while(P&&p<a);if(512&Kn(n)&&4&n.wrap&&(n.check=ei(n.check,i,p,s)),a-=p,s+=p,P)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&Kn(n)){if(a===0)break e;p=0;do P=i[s+p++],n.head&&P&&n.length<65536&&(n.head.comment+=String.fromCharCode(P));while(P&&p<a);if(512&Kn(n)&&4&n.wrap&&(n.check=ei(n.check,i,p,s)),a-=p,s+=p,P)break e}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&Kn(n)){for(;l<16;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if(4&n.wrap&&d!==(65535&n.check)){e.msg="header crc mismatch",n.mode=vn;break}d=0,l=0}n.head&&(n.head.hcrc=Kn(n)>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=Us;break;case 16189:for(;l<32;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}e.adler=n.check=YP(d),d=0,l=0,n.mode=Dp;case Dp:if(n.havedict===0)return e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,n.hold=d,n.bits=l,i8;e.adler=n.check=1,n.mode=Us;case Us:if(t===t8||t===Op)break e;case RS:if(n.last){d>>>=7&l,l-=7&l,n.mode=bS;break}for(;l<3;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}switch(n.last=1&d,d>>>=1,l-=1,3&d){case 0:n.mode=16193;break;case 1:if(o8(n),n.mode=Pp,t===Op){d>>>=2,l-=2;break e}break;case 2:n.mode=16196;break;case 3:e.msg="invalid block type",n.mode=vn}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){e.msg="invalid stored block lengths",n.mode=vn;break}if(n.length=65535&d,d=0,l=0,n.mode=CS,t===Op)break e;case CS:n.mode=16195;case 16195:if(p=n.length,p){if(p>a&&(p=a),p>c&&(p=c),p===0)break e;r.set(i.subarray(s,s+p),o),a-=p,s+=p,c-=p,o+=p,n.length-=p;break}n.mode=Us;break;case 16196:for(;l<14;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if(n.nlen=257+(31&d),d>>>=5,l-=5,n.ndist=1+(31&d),d>>>=5,l-=5,n.ncode=4+(15&d),d>>>=4,l-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=vn;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;l<3;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}n.lens[Ce[n.have++]]=7&d,d>>>=3,l-=3}for(;n.have<19;)n.lens[Ce[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,de={bits:n.lenbits},M=bl(0,n.lens,0,19,n.lencode,0,n.work,de),n.lenbits=de.bits,M){e.msg="invalid code lengths set",n.mode=vn;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;G=n.lencode[d&(1<<n.lenbits)-1],y=G>>>24,I=G>>>16&255,A=65535&G,!(y<=l);){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if(A<16)d>>>=y,l-=y,n.lens[n.have++]=A;else{if(A===16){for(Ie=y+2;l<Ie;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if(d>>>=y,l-=y,n.have===0){e.msg="invalid bit length repeat",n.mode=vn;break}P=n.lens[n.have-1],p=3+(3&d),d>>>=2,l-=2}else if(A===17){for(Ie=y+3;l<Ie;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}d>>>=y,l-=y,P=0,p=3+(7&d),d>>>=3,l-=3}else{for(Ie=y+7;l<Ie;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}d>>>=y,l-=y,P=0,p=11+(127&d),d>>>=7,l-=7}if(n.have+p>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=vn;break}for(;p--;)n.lens[n.have++]=P}}if(n.mode===vn)break;if(n.lens[256]===0){e.msg="invalid code -- missing end-of-block",n.mode=vn;break}if(n.lenbits=9,de={bits:n.lenbits},M=bl(1,n.lens,0,n.nlen,n.lencode,0,n.work,de),n.lenbits=de.bits,M){e.msg="invalid literal/lengths set",n.mode=vn;break}if(n.distbits=6,n.distcode=n.distdyn,de={bits:n.distbits},M=bl(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,de),n.distbits=de.bits,M){e.msg="invalid distances set",n.mode=vn;break}if(n.mode=Pp,t===Op)break e;case Pp:n.mode=Lp;case Lp:if(a>=6&&c>=258){e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,n.hold=d,n.bits=l,JK(e,h),o=e.next_out,r=e.output,c=e.avail_out,s=e.next_in,i=e.input,a=e.avail_in,d=n.hold,l=n.bits,n.mode===Us&&(n.back=-1);break}for(n.back=0;G=n.lencode[d&(1<<n.lenbits)-1],y=G>>>24,I=G>>>16&255,A=65535&G,!(y<=l);){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if(I&&(240&I)==0){for(N=y,k=I,x=A;G=n.lencode[x+((d&(1<<N+k)-1)>>N)],y=G>>>24,I=G>>>16&255,A=65535&G,!(N+y<=l);){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}d>>>=N,l-=N,n.back+=N}if(d>>>=y,l-=y,n.back+=y,n.length=A,I===0){n.mode=16205;break}if(32&I){n.back=-1,n.mode=Us;break}if(64&I){e.msg="invalid literal/length code",n.mode=vn;break}n.extra=15&I,n.mode=16201;case 16201:if(n.extra){for(Ie=n.extra;l<Ie;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;G=n.distcode[d&(1<<n.distbits)-1],y=G>>>24,I=G>>>16&255,A=65535&G,!(y<=l);){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if((240&I)==0){for(N=y,k=I,x=A;G=n.distcode[x+((d&(1<<N+k)-1)>>N)],y=G>>>24,I=G>>>16&255,A=65535&G,!(N+y<=l);){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}d>>>=N,l-=N,n.back+=N}if(d>>>=y,l-=y,n.back+=y,64&I){e.msg="invalid distance code",n.mode=vn;break}n.offset=A,n.extra=15&I,n.mode=16203;case 16203:if(n.extra){for(Ie=n.extra;l<Ie;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=vn;break}n.mode=16204;case 16204:if(c===0)break e;if(p=h-c,n.offset>p){if(p=n.offset-p,p>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=vn;break}p>n.wnext?(p-=n.wnext,R=n.wsize-p):R=n.wnext-p,p>n.length&&(p=n.length),T=n.window}else T=r,R=o-n.offset,p=n.length;p>c&&(p=c),c-=p,n.length-=p;do r[o++]=T[R++];while(--p);n.length===0&&(n.mode=Lp);break;case 16205:if(c===0)break e;r[o++]=n.length,c--,n.mode=Lp;break;case bS:if(n.wrap){for(;l<32;){if(a===0)break e;a--,d|=i[s++]<<l,l+=8}if(h-=c,e.total_out+=h,n.total+=h,4&n.wrap&&h&&(e.adler=n.check=Kn(n)?ei(n.check,r,h,o-h):El(n.check,r,h,o-h)),h=c,4&n.wrap&&(Kn(n)?d:YP(d))!==n.check){e.msg="incorrect data check",n.mode=vn;break}d=0,l=0}n.mode=16207;case 16207:if(n.wrap&&Kn(n)){for(;l<32;){if(a===0)break e;a--,d+=i[s++]<<l,l+=8}if(4&n.wrap&&d!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=vn;break}d=0,l=0}n.mode=16208;case 16208:M=n8;break e;case vn:M=GP;break e;case 16210:return HP;default:return Tr}return e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,n.hold=d,n.bits=l,(n.wsize||h!==e.avail_out&&n.mode<vn&&(n.mode<bS||t!==WP))&&ZP(e,e.output,e.next_out,h-e.avail_out),u-=e.avail_in,h-=e.avail_out,e.total_in+=u,e.total_out+=h,n.total+=h,4&n.wrap&&h&&(e.adler=n.check=Kn(n)?ei(n.check,r,h,e.next_out-h):El(n.check,r,h,e.next_out-h)),e.data_type=n.bits+(n.last?64:0)+(n.mode===Us?128:0)+(n.mode===Pp||n.mode===CS?256:0),(u===0&&h===0||t===WP)&&M===ga&&(M=r8),M},Vs={inflateReset:qP,inflateReset2:XP,inflateResetKeep:zP,inflateInit:e=>JP(e,15),inflateInit2:JP,inflate:a8,inflateEnd:e=>{if(Sa(e))return Tr;let t=e.state;return t.window&&(t.window=null),e.state=null,ga},inflateGetHeader:(e,t)=>{if(Sa(e))return Tr;const n=e.state;return(2&n.wrap)==0?Tr:(n.head=t,t.done=!1,ga)},inflateSetDictionary:(e,t)=>{const n=t.length;let i,r,s;return Sa(e)?Tr:(i=e.state,i.wrap!==0&&i.mode!==Dp?Tr:i.mode===Dp&&(r=1,r=El(r,t,n,0),r!==i.check)?GP:(s=ZP(e,t,n,n),s?(i.mode=16210,HP):(i.havedict=1,ga)))},inflateInfo:"pako inflate (from Nodeca project)"},c8=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const $P=Object.prototype.toString,{Z_NO_FLUSH:d8,Z_FINISH:l8,Z_OK:Il,Z_STREAM_END:AS,Z_NEED_DICT:OS,Z_STREAM_ERROR:u8,Z_DATA_ERROR:eL,Z_MEM_ERROR:h8}=yp;function kp(e){this.options=Cp.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(15&t.windowBits)==0&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new jP,this.strm.avail_out=0;let n=Vs.inflateInit2(this.strm,t.windowBits);if(n!==Il)throw new Error(ma[n]);if(this.header=new c8,Vs.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=Cl.string2buf(t.dictionary):$P.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(n=Vs.inflateSetDictionary(this.strm,t.dictionary),n!==Il)))throw new Error(ma[n])}function tL(e,t){const n=new kp(t);if(n.push(e),n.err)throw n.msg||ma[n.err];return n.result}kp.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let s,o,a;if(this.ended)return!1;for(o=t===~~t?t:t===!0?l8:d8,$P.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),s=Vs.inflate(n,o),s===OS&&r&&(s=Vs.inflateSetDictionary(n,r),s===Il?s=Vs.inflate(n,o):s===eL&&(s=OS));n.avail_in>0&&s===AS&&n.state.wrap>0&&e[n.next_in]!==0;)Vs.inflateReset(n),s=Vs.inflate(n,o);switch(s){case u8:case eL:case OS:case h8:return this.onEnd(s),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(n.avail_out===0||s===AS))if(this.options.to==="string"){let c=Cl.utf8border(n.output,n.next_out),d=n.next_out-c,l=Cl.buf2string(n.output,c);n.next_out=d,n.avail_out=i-d,d&&n.output.set(n.output.subarray(c,c+d),0),this.onData(l)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(s!==Il||a!==0){if(s===AS)return s=Vs.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,!0;if(n.avail_in===0)break}}return!0},kp.prototype.onData=function(e){this.chunks.push(e)},kp.prototype.onEnd=function(e){e===Il&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Cp.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var p8={inflate:tL,inflateRaw:function(e,t){return(t=t||{}).raw=!0,tL(e,t)}};const{deflate:m8,deflateRaw:f8}=XK,{inflate:_8,inflateRaw:E8}=p8;var g8=m8,S8=f8,T8=_8,y8=E8,nL=(function(e){return e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE",e})(nL||{});class v8{constructor(){v(this,"_sequence",0),v(this,"_startTime",Date.now()),v(this,"isUseOneByte",!0)}get startTime(){const t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){const n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){const a=new Uint8Array(4);a.set([1,0,0,0]);const c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};n.commonPacketHeader.extension=1,n.extension=d,n.payload=this.compress(t),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;b("SHOW_DATASTREAM2_LOG")&&_.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));const i=new ArrayBuffer(n.commonPacketHeader.length),r=new Uint8Array(i),s=new DataView(i);let o=0;if(s.setUint16(o,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),o+=2,s.setUint32(o,n.commonPacketHeader.sequence,!0),o+=4,s.setUint16(o,n.commonStreamHeader,!0),o+=2,n.extension){const a=this.serializeExtension(n.extension);r.set(new Uint8Array(a),o),o+=a.byteLength}if(r.set(new Uint8Array(n.payload),o),o+=n.payload.byteLength,o!==n.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);const n=new DataView(t);let i=0;const r=n.getUint16(i,!0);i+=2;const s={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:n.getUint16(i+2,!0)<<16|n.getUint16(i,!0)};let o,a;if(i+=4,b("SHOW_DATASTREAM2_LOG")&&_.debug("receive data header: ".concat(JSON.stringify(s))),n.getUint16(i,!0),i+=2,s.extension){a=this.deserializeExtension(t.slice(i)),i+=2+a.length,o=t.slice(i);let c=!1;if(a.datas.length>0){const d=a.datas.find((l=>l.id===0));d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1)}o=c?this.decompress(o):o}else o=t.slice(8);return o}serializeExtension(t){const{profile:n,length:i,datas:r}=t,s=new ArrayBuffer(i+2),o=new Uint8Array(s),a=new DataView(s);let c=0;if(a.setUint8(c++,n),a.setUint8(c++,i),r.forEach((d=>{n?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),o.set(new Uint8Array(d.data),c),c+=d.data.byteLength)})),c!==i+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(i+2));return s}deserializeExtension(t){const n=new DataView(t);let i=0;const r=n.getUint8(i);i++;const s=n.getUint8(i);i++;const o=r===nL.TWO_BYTE,a=[],c=new DataView(t,2);let d=0;for(;d<s;){let l=0,u=0,h=new ArrayBuffer(0);o?(l=c.getUint8(d),d++,u=c.getUint8(d),d++):(l=15&c.getUint8(d),u=c.getUint8(d)>>4,d++),u>0&&(h=c.buffer.slice(d+2,d+2+u),d+=h.byteLength),a.push({id:l,length:u,data:h})}if(d!==s)throw Error("parse error");return{profile:r,length:s,datas:a}}decompress(t){return T8(new Uint8Array(t))}compress(t){return g8(new Uint8Array(t))}}const R8={name:"DataStream",create:(e,t)=>{const n=t?new w6(e):new A6(e);return n.useDataStream(new v8),n}};class C8 extends kt{constructor(t,n,i){super(),v(this,"ws",void 0),v(this,"requestId",1),v(this,"heartBeatTimer",void 0),v(this,"joinInfo",void 0),v(this,"clientId",void 0),v(this,"onOpen",(()=>{this.emit("open"),this.startHeartBeatCheck()})),v(this,"onClose",(r=>{this.emit("close"),this.dispose()})),v(this,"onMessage",(r=>{const s=JSON.parse(r.data);if(!s||s.command!=="serverResponse"||!s.requestId)return s&&s.command==="serverStatus"&&s.serverStatus&&s.serverStatus.command?(this.emit("status",s.serverStatus),void this.emit(s.serverStatus.command,s.serverStatus)):void 0;this.emit("req_".concat(s.requestId),s)})),this.joinInfo=t,this.clientId=n,this.ws=new Jd("cross-channel-".concat(this.clientId),i),this.ws.on(Le.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(Le.CONNECTED,this.onOpen),this.ws.on(Le.ON_MESSAGE,this.onMessage),this.ws.on(Le.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){const n=this.requestId++;return t.requestId=n,t.seq=n,this.ws.sendMessage(t),n}waitStatus(t){return new ie(((n,i)=>{const r=window.setTimeout((()=>{i(new V(w.TIMEOUT,"wait status timeout, status: ".concat(t)))}),5e3);this.once(t,(s=>{window.clearTimeout(r),s.state&&s.state!==0?i(new V(w.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):n(void 0)})),this.once("dispose",(()=>{window.clearTimeout(r),i(new V(w.WS_ABORT))}))}))}async request(t){if(this.ws.state==="closed")throw new V(w.WS_DISCONNECT);const n=()=>new ie(((o,a)=>{this.ws.once(Le.CLOSED,(()=>a(new V(w.WS_ABORT)))),this.ws.once(Le.CONNECTED,o)}));this.ws.state!=="connected"&&await n();const i=this.sendMessage(t),r=new ie(((o,a)=>{const c=()=>{a(new V(w.WS_ABORT))};this.ws.once(Le.RECONNECTING,c),this.ws.once(Le.CLOSED,c),this.once("req_".concat(i),o),hn(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(Le.RECONNECTING,c),this.ws.off(Le.CLOSED,c),a(new V(w.TIMEOUT,"cross channel ws request timeout"))}))})),s=await r;if(!s||s.code!==200)throw new V(w.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(t){this.ws.removeAllListeners(Le.REQUEST_NEW_URLS),this.ws.on(Le.REQUEST_NEW_URLS,(n=>{n(t)})),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const n=this.requestId++;return t.requestId=n,this.ws.sendMessage(t),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class b8 extends kt{set state(t){t!==this._state&&(t!==hi.RELAY_STATE_FAILURE&&(this.errorCode=wc.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,n,i,r,s){super(),v(this,"joinInfo",void 0),v(this,"sid",void 0),v(this,"clientId",void 0),v(this,"cancelToken",ii.CancelToken.source()),v(this,"workerToken",void 0),v(this,"requestId",0),v(this,"signal",void 0),v(this,"prevChannelMediaConfig",void 0),v(this,"httpRetryConfig",void 0),v(this,"_resolution",void 0),v(this,"_state",hi.RELAY_STATE_IDLE),v(this,"errorCode",wc.RELAY_OK),v(this,"onStatus",(o=>{_.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(o))),o&&o.command&&(o.command==="onAudioPacketReceived"&&this.emit("event",Ls.PACKET_RECEIVED_AUDIO_FROM_SRC),o.command==="onVideoPacketReceived"&&this.emit("event",Ls.PACKET_RECEIVED_VIDEO_FROM_SRC),o.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=wc.SRC_TOKEN_EXPIRED,this.state=hi.RELAY_STATE_FAILURE),o.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=wc.DEST_TOKEN_EXPIRED,this.state=hi.RELAY_STATE_FAILURE))})),v(this,"onReconnect",(async()=>{_.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Ls.NETWORK_DISCONNECTED),this.state=hi.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((o=>{this.state!==hi.RELAY_STATE_IDLE&&(_.error("auto restart channel media relay failed",o.toString()),this.errorCode=wc.SERVER_CONNECTION_LOST,this.state=hi.RELAY_STATE_FAILURE)}))})),this.joinInfo=t,this.clientId=n,this.sid=Xo(),this.signal=new C8(this.joinInfo,this.clientId,i),this.httpRetryConfig=r,this._resolution=s}async startChannelMediaRelay(t){if(this.state!==hi.RELAY_STATE_IDLE)throw new V(w.INVALID_OPERATION);this.state=hi.RELAY_STATE_CONNECTING,await this.connect(),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new V(w.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new V(w.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new V(w.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==hi.RELAY_STATE_RUNNING)throw new V(w.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==hi.RELAY_STATE_RUNNING)throw new V(w.INVALID_OPERATION);const n=this.genMessage(oi.SetVideoProfile);await this.signal.request(n),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),_.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=hi.RELAY_STATE_IDLE,this.dispose()}dispose(){_.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=ii.CancelToken.source(),this.state=hi.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await PH(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",Ls.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const n=this.genMessage(oi.SetSdkProfile,t);await this.signal.request(n),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const i=this.genMessage(oi.SetSourceChannel,t);await this.signal.request(i),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Ls.PACKET_JOINED_SRC_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const r=this.genMessage(oi.SetSourceUserId,t);await this.signal.request(r),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const s=this.genMessage(oi.SetDestChannel,t);await this.signal.request(s),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Ls.PACKET_JOINED_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const o=this.genMessage(oi.StartPacketTransfer,t);await this.signal.request(o),this.emit("event",Ls.PACKET_SENT_TO_DEST_CHANNEL),this.state=hi.RELAY_STATE_RUNNING,_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const n=this.genMessage(oi.UpdateDestChannel,t);await this.signal.request(n),this.emit("event",Ls.PACKET_UPDATE_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(oi.StopPacketTransfer);await this.signal.request(t),_.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,n){const i=[],r=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Gi,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};o.sdkVersion==="4.24.2"&&(o.sdkVersion="0.0.1");let a=null,c=null;switch(t){case oi.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case oi.SetSourceChannel:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new V(w.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},o;case oi.SetSourceUserId:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new V(w.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:c.uid+""},o;case oi.SetDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new V(w.UNEXPECTED_ERROR,"can not find dest config");return a.forEach((d=>{i.push(d.channelName),r.push(d.uid+""),s.push(d.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:i,uid:r,token:s},o;case oi.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case oi.Reconnect:return o.clientRequest={command:"Reconnect"},o;case oi.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case oi.UpdateDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new V(w.UNEXPECTED_ERROR,"can not find dest config");return a.forEach((d=>{i.push(d.channelName),r.push(d.uid+""),s.push(d.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:r,token:s},o;case oi.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}const I8={name:"ChannelMediaRelay",create:function(e){return new b8(e.joinInfo,e.clientId,e.websocketRetryConfig||Xt,e.httpRetryConfig||Xt,e.resolution)}};function iL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function wl(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?iL(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class w8 extends kt{constructor(t,n,i,r){super(),v(this,"spec",void 0),v(this,"token",void 0),v(this,"websocket",void 0),v(this,"pingpongTimer",void 0),v(this,"reconnectMode","retry"),v(this,"serviceMode",void 0),v(this,"reqId",0),v(this,"commandReqId",0),v(this,"handleWebSocketOpen",(()=>{this.reconnectMode="retry",this.startPingPong()})),v(this,"handleWebSocketMessage",(s=>{if(!s.data)return;const o=JSON.parse(s.data);o.requestId?this.emit("@".concat(o.requestId,"-").concat(o.sid),o):(pe.workerEvent(this.spec.sid,{actionType:"status",serverCode:o.code,workerType:this.serviceMode===Ps.TRANSCODE?1:2}),this.emit(oo.PUBLISH_STREAM_STATUS,o))})),this.spec=n,this.token=t,this.serviceMode=r,this.websocket=new Jd("live-streaming",i),this.websocket.on(Le.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Le.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Le.REQUEST_NEW_URLS,((s,o)=>{en(this,oo.REQUEST_NEW_ADDRESS).then(s).catch(o)})),this.websocket.on(Le.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(t){return this.websocket.init(t)}async request(t,n,i,r){this.reqId+=1,t==="request"&&(this.commandReqId+=1);const s=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new V(w.UNEXPECTED_ERROR);const a=wl({command:t,sdkVersion:Gi==="4.24.2"?"0.0.1":Gi,seq:o,requestId:o,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new V(w.WS_DISCONNECT);const c=()=>new ie(((h,p)=>{this.websocket.once(Le.CLOSED,(()=>p(new V(w.WS_ABORT)))),this.websocket.once(Le.CONNECTED,h)}));this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new ie(((h,p)=>{const R=()=>{p(new V(w.WS_ABORT))};this.websocket.once(Le.RECONNECTING,R),this.websocket.once(Le.CLOSED,R),this.once("@".concat(o,"-").concat(this.spec.sid),(T=>{h(T)}))}));r&&pe.workerEvent(this.spec.sid,wl(wl({},r),{},{requestId:s,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));const l=Date.now();this.websocket.sendMessage(a);let u=null;try{u=await d}catch(h){if(this.websocket.state==="closed")throw h;return await c(),await this.request(t,n,i)}return r&&pe.workerEvent(this.spec.sid,wl(wl({},r),{},{requestId:s,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:u.code===200,responseTime:Date.now()-l})),u.code!==200&&this.handleResponseError(u),u}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t=Gi==="4.24.2"?"0.0.1":Gi;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case on.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void _.warning("live stream response already exists stream");case on.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case on.LIVE_STREAM_RESPONSE_BAD_STREAM:case on.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new V(w.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case on.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream")return;throw new V(w.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case on.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new V(w.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case on.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const n=new V(w.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(oo.WARNING,n,t.serverResponse.url)}case on.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const n=new V(w.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(oo.WARNING,n,t.serverResponse.url)}case on.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new V(w.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case on.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new V(w.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case on.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const n=new V(w.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(oo.WARNING,n,t.serverResponse.url)}case on.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new V(w.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case on.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new V(w.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case on.LIVE_STREAM_RESPONSE_WORKER_LOST:case on.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream")return;throw new V(w.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case on.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new V(w.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new V(w.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case on.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case on.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case on.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case on.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new V(w.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(Wd)}),6e3)}}function rL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function mi(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?rL(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class A8 extends kt{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Xt,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Xt;super(),v(this,"onLiveStreamWarning",void 0),v(this,"onLiveStreamError",void 0),v(this,"spec",void 0),v(this,"retryTimeout",1e4),v(this,"connection",void 0),v(this,"httpRetryConfig",void 0),v(this,"wsRetryConfig",void 0),v(this,"streamingTasks",new Map),v(this,"isStartingStreamingTask",!1),v(this,"taskMutex",new gn("live-streaming")),v(this,"cancelToken",ii.CancelToken.source()),v(this,"transcodingConfig",void 0),v(this,"uapResponse",void 0),v(this,"lastTaskId",1),v(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=i,this.wsRetryConfig=n}async setTranscodingConfig(t){const n=mi(mi({},uH),t);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(_.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map((o=>mi(mi(mi({},lH),o),{},{zOrder:o.zOrder?o.zOrder+1:1})))),(function(o){Vt(o.width)||St(o.width,"config.width",0,1e4),Vt(o.height)||St(o.height,"config.height",0,1e4),Vt(o.videoBitrate)||St(o.videoBitrate,"config.videoBitrate",1,1e6),Vt(o.videoFrameRate)||St(o.videoFrameRate,"config.videoFrameRate"),Vt(o.lowLatency)||cr(o.lowLatency,"config.lowLatency"),Vt(o.audioSampleRate)||qt(o.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Vt(o.audioBitrate)||St(o.audioBitrate,"config.audioBitrate",1,128),Vt(o.audioChannels)||qt(o.audioChannels,"config.audioChannels",[1,2,3,4,5]),Vt(o.videoGop)||St(o.videoGop,"config.videoGop"),Vt(o.videoCodecProfile)||qt(o.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Vt(o.userCount)||St(o.userCount,"config.userCount",0,17),Vt(o.backgroundColor)||St(o.backgroundColor,"config.backgroundColor",0,16777215),Vt(o.userConfigExtraInfo)||bn(o.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),o.transcodingUsers&&!Vt(o.transcodingUsers)&&(Ns(o.transcodingUsers,"config.transcodingUsers"),o.transcodingUsers.forEach(((a,c)=>{Hh(a.uid),Vt(a.x)||St(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),Vt(a.y)||St(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),Vt(a.width)||St(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),Vt(a.height)||St(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),Vt(a.zOrder)||St(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),Vt(a.alpha)||St(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)}))),Vt(o.watermark)||Sg(o.watermark,"watermark"),Vt(o.backgroundImage)||Sg(o.backgroundImage,"backgroundImage"),o.images&&!Vt(o.images)&&(Ns(o.images,"config.images"),o.images.forEach(((a,c)=>{Sg(a,"images[".concat(c,"]"))})))})(n);const i=[];n.images&&i.push(...n.images.map((o=>mi(mi(mi({},gg),o),{},{zOrder:255})))),n.backgroundImage&&(i.push(mi(mi(mi({},gg),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(i.push(mi(mi(mi({},gg),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=i,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map((o=>mi({},o))),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);const r=(n.userConfigs||[]).map((o=>typeof o.uid=="number"?ie.resolve(o.uid):CN(o.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await ie.all(r)).forEach(((o,a)=>{n.userConfigs&&n.userConfigs[a]&&(n.userConfigs[a].uid=o)})),this.transcodingConfig=n,this.connection)try{var s;const o=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Si(s=this.streamingTasks).call(s)).map((a=>a.taskId)).join("#")});_.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(o.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(o){if(!o.data||!o.data.retry)throw o;o.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((a=>{_.warning("[".concat(this.spec.clientId,"] live streaming receive error"),o.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,o).then((()=>{_.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))})).catch((c=>{_.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}))}))}}async startLiveStreamingTask(t,n,i){if(!this.transcodingConfig&&n===Ps.TRANSCODE)throw new V(w.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const r={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};_.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(n));const s=await this.taskMutex.lock();if(!this.connection&&i)return void s();if(this.streamingTasks.get(t)&&!i)return s(),new V(w.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n))}catch(a){throw s(),a}n===Ps.TRANSCODE&&(r.transcodingConfig=mi({},this.transcodingConfig)),this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const o=this.lastTaskId++;try{const a=new ie(((d,l)=>{hn(this.retryTimeout).then((()=>{if(i)return l(i);const u=this.statusError.get(t);return u?(this.statusError.delete(t),l(u)):void 0}))})),c=await ie.race([this.connection.request("request",{clientRequest:r},!0,{url:t,command:"PublishStream",workerType:n===Ps.TRANSCODE?1:2,requestByUser:!i,tid:o.toString()}),a]);this.isStartingStreamingTask=!1,_.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(t,{clientRequest:r,mode:n,url:t,taskId:o}),s()}catch(a){if(s(),this.isStartingStreamingTask=!1,!a.data||!a.data.retry||i)throw a;return a.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,n,a)):await this.startLiveStreamingTask(t,n,a)}}stopLiveStreamingTask(t){return new ie(((n,i)=>{const r=this.streamingTasks.get(t);if(!r||!this.connection)return new V(w.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const s=r.mode;r.abortTask=()=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),n()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:r.url}},!1,{url:t,command:"UnPublishStream",workerType:s===Ps.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((o=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(o.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),n()})).catch(i)}))}resetAllTask(){var t;const n=Array.from(Si(t=this.streamingTasks).call(t));this.terminate();for(const i of n)this.startLiveStreamingTask(i.url,i.mode).catch((r=>{this.onLiveStreamError&&this.onLiveStreamError(i.url,r)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=ii.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new V(w.UNEXPECTED_ERROR,"live streaming connection has already connected");const n=await en(this,Tg.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=n,this.connection=new w8(n.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(oo.WARNING,((i,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,i))),this.connection.on(oo.PUBLISH_STREAM_STATUS,(i=>this.handlePublishStreamServer(i))),this.connection.on(oo.REQUEST_NEW_ADDRESS,((i,r)=>{if(!this.connection)return r(new V(w.UNEXPECTED_ERROR,"can not get new live streaming address list"));en(this,Tg.REQUEST_WORKER_MANAGER_LIST,t).then((s=>{this.uapResponse=s,i(s.addressList)})).catch(r)})),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(t){const n=t.serverStatus&&t.serverStatus.url||"empty_url",i=this.streamingTasks.get(n),r=t.reason;switch(t.code){case on.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case on.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case on.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case on.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const o=new V(w.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(i)return _.error(o.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,o);if(!this.isStartingStreamingTask)return;this.statusError.set(n,o)}case on.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const o=new V(w.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,o)}case on.LIVE_STREAM_RESPONSE_WORKER_LOST:case on.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var s;if(!this.connection)return;this.connection.tryNextAddress();const o=Array.from(Si(s=this.streamingTasks).call(s));for(const a of o)a.abortTask?a.abortTask():(_.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new V(w.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then((()=>{_.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)})).catch((c=>{_.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})));return}}}hasUrl(t){return this.streamingTasks.has(t)}}const O8={name:"LiveStreaming",create:function(e){return new A8(e.joinInfo,e.websocketRetryConfig||Xt,e.httpRetryConfig||Xt)}};function N8(e){let t=aL();return(function(n,i){let r=n.appId;r!==void 0&&(mt(i,10),Es(i,r));let s=n.cid;s!==void 0&&(mt(i,16),mt(i,s));let o=n.cname;o!==void 0&&(mt(i,26),Es(i,o));let a=n.deviceId;a!==void 0&&(mt(i,34),Es(i,a));let c=n.elapse;c!==void 0&&(mt(i,40),To(i,c));let d=n.fileSize;d!==void 0&&(mt(i,48),To(i,Kc(d)));let l=n.height;l!==void 0&&(mt(i,56),To(i,Kc(l)));let u=n.jpg;u!==void 0&&(mt(i,66),mt(i,u.length),(function(Pt,H){let $=Yc(Pt,H.length);Pt.bytes.set(H,$)})(i,u));let h=n.networkType;h!==void 0&&(mt(i,72),To(i,Kc(h)));let p=n.osType;p!==void 0&&(mt(i,80),To(i,Kc(p)));let R=n.requestId;R!==void 0&&(mt(i,90),Es(i,R));let T=n.sdkVersion;T!==void 0&&(mt(i,98),Es(i,T));let y=n.sequence;y!==void 0&&(mt(i,104),To(i,Kc(y)));let I=n.sid;I!==void 0&&(mt(i,114),Es(i,I));let A=n.timestamp;A!==void 0&&(mt(i,120),To(i,A));let N=n.uid;N!==void 0&&(mt(i,128),mt(i,N));let k=n.vid;k!==void 0&&(mt(i,136),mt(i,k));let x=n.width;x!==void 0&&(mt(i,144),To(i,Kc(x)));let P=n.service;P!==void 0&&(mt(i,152),mt(i,P));let M=n.callbackData;M!==void 0&&(mt(i,162),Es(i,M));let G=n.jpgEncryption;G!==void 0&&(mt(i,168),mt(i,G));let Y=n.requestType;Y!==void 0&&(mt(i,176),mt(i,Y));let de=n.scorePorn;de!==void 0&&(mt(i,185),kS(i,de));let Ie=n.scoreSexy;Ie!==void 0&&(mt(i,193),kS(i,Ie));let Ce=n.scoreNeutral;Ce!==void 0&&(mt(i,201),kS(i,Ce));let Ue=n.scene;Ue!==void 0&&(mt(i,208),mt(i,Ue));let Pe=n.ossFilePrefix;Pe!==void 0&&(mt(i,218),Es(i,Pe));let nt=n.serviceVendor;if(nt!==void 0)for(let Pt of nt){mt(i,226);let H=aL();L8(Pt,H),mt(i,H.limit),U8(i,H),M8(H)}})(e,t),(function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)})(t)}function D8(e){return(function(n){let i={};e:for(;!cL(n);){let r=gs(n);switch(r>>>3){case 0:break e;case 1:i.code=gs(n);break;case 2:i.msg=dL(n,gs(n));break;case 3:{let s=k8(n);i.data=P8(n),n.limit=s;break}default:sL(n,7&r)}}return i})({bytes:t=e,offset:0,limit:t.length});var t}function P8(e){let t={};e:for(;!cL(e);){let n=gs(e);switch(n>>>3){case 0:break e;case 1:t.requestId=dL(e,gs(e));break;case 2:t.requestType=gs(e)>>>0;break;case 3:t.scorePorn=LS(e);break;case 4:t.scoreSexy=LS(e);break;case 5:t.scoreNeutral=LS(e);break;case 6:t.requestScene=gs(e)>>>0;break;case 7:t.scene=gs(e)>>>0;break;default:sL(e,7&n)}}return t}function L8(e,t){let n=e.service;n!==void 0&&(mt(t,8),mt(t,n));let i=e.vendor;i!==void 0&&(mt(t,16),mt(t,i));let r=e.token;r!==void 0&&(mt(t,26),Es(t,r));let s=e.callbackUrl;s!==void 0&&(mt(t,34),Es(t,s))}function k8(e){let t=gs(e),n=e.limit;return e.limit=e.offset+t,n}function sL(e,t){switch(t){case 0:for(;128&lL(e););break;case 2:DS(e,gs(e));break;case 5:DS(e,4);break;case 1:DS(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let x8=new Float32Array(1);new Uint8Array(x8.buffer);let NS=new Float64Array(1),fi=new Uint8Array(NS.buffer);function Kc(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let oL=[];function aL(){const e=oL.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function M8(e){oL.push(e)}function DS(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function cL(e){return e.offset>=e.limit}function Yc(e,t){let n=e.bytes,i=e.offset,r=e.limit,s=i+t;if(s>n.length){let o=new Uint8Array(2*s);o.set(n),e.bytes=o}return e.offset=s,s>r&&(e.limit=s),i}function PS(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function dL(e,t){let n=PS(e,t),i=String.fromCharCode,r=e.bytes,s="",o="";for(let a=0;a<t;a++){let c,d,l,u,h=r[a+n];(128&h)==0?o+=i(h):(224&h)==192?a+1>=t?o+=s:(c=r[a+n+1],(192&c)!=128?o+=s:(u=(31&h)<<6|63&c,u<128?o+=s:(o+=i(u),a++))):(240&h)==224?a+2>=t?o+=s:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?o+=s:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?o+=s:(o+=i(u),a+=2))):(248&h)==240?a+3>=t?o+=s:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?o+=s:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?o+=s:(u-=65536,o+=i(55296+(u>>10),56320+(1023&u)),a+=3))):o+=s}return o}function Es(e,t){let n=t.length,i=0;for(let o=0;o<n;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+t.charCodeAt(++o)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}mt(e,i);let r=Yc(e,i),s=e.bytes;for(let o=0;o<n;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+t.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function U8(e,t){let n=Yc(e,t.limit),i=e.bytes,r=t.bytes;for(let s=0,o=t.limit;s<o;s++)i[s+n]=r[s]}function lL(e){return e.bytes[PS(e,1)]}function uL(e,t){let n=Yc(e,1);e.bytes[n]=t}function LS(e){let t=PS(e,8),n=e.bytes;return fi[0]=n[t++],fi[1]=n[t++],fi[2]=n[t++],fi[3]=n[t++],fi[4]=n[t++],fi[5]=n[t++],fi[6]=n[t++],fi[7]=n[t++],NS[0]}function kS(e,t){let n=Yc(e,8),i=e.bytes;NS[0]=t,i[n++]=fi[0],i[n++]=fi[1],i[n++]=fi[2],i[n++]=fi[3],i[n++]=fi[4],i[n++]=fi[5],i[n++]=fi[6],i[n++]=fi[7]}function gs(e){let t,n=0,i=0;do t=lL(e),n<32&&(i|=(127&t)<<n),n+=7;while(128&t);return i}function mt(e,t){for(t>>>=0;t>=128;)uL(e,127&t|128),t>>>=7;uL(e,t)}function To(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,s=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,o=Yc(e,s),a=e.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?i>>>21|128:i>>>21&127;case 7:a[o+6]=s!==7?i>>>14|128:i>>>14&127;case 6:a[o+5]=s!==6?i>>>7|128:i>>>7&127;case 5:a[o+4]=s!==5?128|i:127&i;case 4:a[o+3]=s!==4?n>>>21|128:n>>>21&127;case 3:a[o+2]=s!==3?n>>>14|128:n>>>14&127;case 2:a[o+1]=s!==2?n>>>7|128:n>>>7&127;case 1:a[o]=s!==1?128|n:127&n}}function hL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}const V8=new Map([["moderation",1],["supervise",2]]);class j8 extends kt{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const n=this._connectionState;this._connectionState=t,this.emit(Tn.CONNECTION_STATE_CHANGE,n,t)}get inspectType(){return this._inspectType}set inspectType(t){var n;this._inspectMode=Bi(n=t.map((i=>V8.get(i)||0))).call(n,((i,r)=>i+r)),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(t){super(),v(this,"name","AgoraRTCVideoContentInspect"),v(this,"_connectionState",pr.CONNECTING),v(this,"_innerConnectionState",void 0),v(this,"sequence",0),v(this,"inspectStartTime",void 0),v(this,"workerManagerConnection",void 0),v(this,"workerConnection",void 0),v(this,"workerMessageLengthLimit",void 0),v(this,"inspectIntervalMinimum",void 0),v(this,"qualityRatio",void 0),v(this,"_connectInfo",void 0),v(this,"_cancelTokenSource",ii.CancelToken.source()),v(this,"_retryConfig",void 0),v(this,"wmSequence",0),v(this,"inspectInterval",void 0),v(this,"inspectTimer",null),v(this,"ossFilePrefix",void 0),v(this,"extraInfo",void 0),v(this,"_inspectType",void 0),v(this,"_inspectMode",void 0),v(this,"_quality",1),v(this,"qualityTimer",null),v(this,"_inspectId",void 0),v(this,"_needWorkUrlOnly",!1),v(this,"inspectImage",(()=>{if(this.connectionState!==pr.CONNECTED)throw new V(w.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===pr.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()})),this._inspectId=ut(5,"inspect-"),this.workerMessageLengthLimit=b("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=b("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=b("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Jd("worker-manager-"+this._inspectId,Xt),this.on(Tn.STATE_CHANGE,((n,i)=>{this._innerConnectionState=n,_.debug("[".concat(this._inspectId,"] Inspect operation :").concat(mr[n]," ").concat(i||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new Jd("worker-"+this._inspectId,Xt),this.handleWorkerEvents()}async init(t,n){this.emit(Tn.STATE_CHANGE,mr.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=n,new ie(((r,s)=>{this.on(Tn.CONNECTION_STATE_CHANGE,((o,a)=>{a===pr.CONNECTED&&r()})),this.requestAP(t,i,n).then((o=>{this.connectWorkerManager(o)})).catch((o=>{s(o)}))}))}async requestAP(t,n,i){const r=b("WEBCS_DOMAIN").map((a=>"https://".concat(a,"/api/v1"))),s=await(function(a,c,d,l){let{appId:u,areaCode:h,cname:p,sid:R,token:T,uid:y}=c;Lc++;const I="image_moderation_api",A={service_name:I,json_body:JSON.stringify({appId:u,areaCode:h,cname:p,command:"allocateEdge",requestId:Lc,seq:Lc,sid:R,token:T,ts:Date.now(),uid:y+""})};let N,k,x=a[0];return Pr((async()=>{N=Date.now();const P=await Vr(x,{data:A,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(k=Date.now()-N,P.code!==0){const Ce=new V(w.UNEXPECTED_RESPONSE,"image inspect ap error, code"+P.code,{retry:!0,responseTime:k});throw _.error(Ce.toString()),Ce}const M=JSON.parse(P.json_body);if(M.code!==200){const Ce=new V(w.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(M.code,", reason: ").concat(M.reason),{code:M.code,responseTime:k});throw _.error(Ce.toString()),Ce}if(!M.servers||!Array.isArray(M.servers)||M.servers.length===0){const Ce=new V(w.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:M.code,responseTime:k});throw _.error(Ce.toString()),Ce}const G=b("VIDEO_INSPECT_WORKER_MANAGER_WSS");if(G)return{addressList:[G],workerToken:M.workerToken,vid:M.vid,responseTime:k};const Y=b("VIDEO_INSPECT_WORKER_MANAGER_HOST"),de=b("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:M.servers.map((Ce=>{let{address:Ue,wss:Pe}=Ce;if(Ue&&Pe)return"wss://".concat(Ue.replace(/\./g,"-"),".").concat(Y,":").concat(de||Pe)})).filter((Ce=>!!Ce)),workerToken:M.workerToken,vid:M.vid,responseTime:k}}),((P,M)=>(pe.apworkerEvent(R,{success:!0,sc:200,serviceName:I,responseDetail:JSON.stringify(P.addressList),firstSuccess:M===0,responseTime:k,serverIp:a[M%a.length]}),!1)),((P,M)=>(pe.apworkerEvent(R,{success:!1,sc:P.data&&P.data.code||200,serviceName:I,responseTime:k,serverIp:a[M%a.length]}),!!(P.code!==w.OPERATION_ABORTED&&P.code!==w.UNEXPECTED_RESPONSE||P.data&&P.data.retry)&&(x=a[(M+1)%a.length],!0))),l)})(r,t,n,i);this.emit(Tn.STATE_CHANGE,mr.AP_CONNECTED);const{addressList:o}=s;return this.wmSequence++,o}async connectWorkerManager(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(Tn.STATE_CHANGE,mr.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Le.CONNECTED,(async()=>{this.emit(Tn.STATE_CHANGE,mr.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.24.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(Le.CLOSED,(()=>{this._innerConnectionState<mr.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(Le.FAILED,(()=>{this._innerConnectionState<mr.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(Le.RECONNECTING,(()=>{this._innerConnectionState<mr.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(Le.ON_MESSAGE,(async t=>{this.emit(Tn.STATE_CHANGE,mr.GET_WORKER_MANAGER_RESPONSE);const n=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(t.data);if(i.code!==200)throw _.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new V(w.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&n))throw _.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new V(w.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const r=b("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,s=n.replace(/:\d+\/?$/,":".concat(r));this.emit(Tn.STATE_CHANGE,mr.CONNECT_WORKER,s),this._needWorkUrlOnly?this.emit(Tn.REQUEST_NEW_WORKER_URL,s):await this.connectWorker(s)}})),this.workerManagerConnection.on(Le.WILL_RECONNECT,((t,n,i)=>{i(t)})),this.workerManagerConnection.on(Le.REQUEST_NEW_URLS,((t,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(n)}))}handleWorkerEvents(){this.workerConnection.on(Le.CONNECTED,(async()=>{this.emit(Tn.STATE_CHANGE,mr.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=pr.CONNECTED})),this.workerConnection.on(Le.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const i=D8(new Uint8Array(t.data));if(b("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&_.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),i.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Tn.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var n;const r={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},s=Bi(n=Object.keys(r)).call(n,((a,c)=>r[a]>r[c]?a:c),"porn"),o=Object.keys(r).find((a=>a===s));this.emit(Tn.INSPECT_RESULT,o)}else this.emit(Tn.INSPECT_RESULT,void 0,new V(w.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(Tn.INSPECT_RESULT,void 0,new V(w.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else _.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Tn.INSPECT_RESULT,void 0,new V(w.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(Le.CLOSED,(()=>{this.connectionState=pr.CLOSED})),this.workerConnection.on(Le.FAILED,(()=>{this.connectionState=pr.CLOSED})),this.workerConnection.on(Le.RECONNECTING,(()=>{this.connectionState=this.connectionState===pr.CONNECTED?pr.RECONNECTING:pr.CONNECTING})),this.workerConnection.on(Le.WILL_RECONNECT,((t,n,i)=>{t==="recover"&&i(t),i("tryNext")})),this.workerConnection.on(Le.REQUEST_NEW_URLS,((t,n)=>{this.workerManagerConnection.close(),this.once(Tn.REQUEST_NEW_WORKER_URL,(i=>{t([i])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((i=>{this.connectWorkerManager(i,!0)})).catch((i=>{n(i)}))}))}async requestToInspectImage(){this.sequence++;const t=vi(this,Tn.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(Tn.INSPECT_RESULT,void 0,new V(w.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(t,n);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(Tn.INSPECT_RESULT,void 0,new V(w.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,n){let{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c}=n;const d=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),u=await BA(l,i,r),h=this.sequence+"-"+s+"-"+c+"-"+d+"-"+ut(12,""),p={appId:i,cid:s,cname:r,deviceId:"",elapse:(R=Number(d-this.inspectStartTime),{low:R|=0,high:R>>31,unsigned:R>=0}),fileSize:u.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.24.2",sequence:this.sequence,sid:a,timestamp:_D(d),uid:c,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var R;this.extraInfo===void 0&&delete p.callbackData,this.ossFilePrefix===void 0&&delete p.ossFilePrefix;const T=N8(p);if(T.byteLength<this.workerMessageLengthLimit){if(b("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const y=(function(I){for(var A=1;A<arguments.length;A++){var N=arguments[A]!=null?arguments[A]:{};A%2?hL(Object(N),!0).forEach((function(k){v(I,k,N[k])})):Object.getOwnPropertyDescriptors?Object.defineProperties(I,Object.getOwnPropertyDescriptors(N)):hL(Object(N)).forEach((function(k){Object.defineProperty(I,k,Object.getOwnPropertyDescriptor(N,k))}))}return I})({},p);delete y.jpg,_.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(y))}return T}{const y=this.quality*this.qualityRatio;return this.quality=y,await this.generateRequestData(t,{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ii.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=pr.CLOSED,this.emit(Tn.STATE_CHANGE,mr.CLOSED)}}const F8={name:"ContentInspect",create:function(e){let{config:t}=e;return(function(n){if(!n)throw new V(w.INVALID_PARAMS,"inspectConfig is necessary.");if(!n.inspectType||!Array.isArray(n.inspectType))throw new V(w.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const i=[...new Set(n.inspectType)];i.forEach((r=>{var s;if(!X(s=["supervise","moderation"]).call(s,r))throw new V(w.INVALID_PARAMS,"".concat(r," is not a valid inspect type."))})),n.inspectType=i}if(n&&n.extraInfo&&n.extraInfo.length>1024)throw new V(w.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")})(t),new j8(t)}};var pL=D(bi.Object.getOwnPropertySymbols),B8=lt,W8=wm.indexOf,G8=Hl,xS=Rn([].indexOf),mL=!!xS&&1/xS([1],1,-0)<0;B8({target:"Array",proto:!0,forced:mL||!G8("indexOf")},{indexOf:function(e){var t=arguments.length>1?arguments[1]:void 0;return mL?xS(this,e,t)||0:W8(this,e,t)}});var H8=Fi("Array","indexOf"),K8=q,Y8=H8,MS=Array.prototype,z8=function(e){var t=e.indexOf;return e===MS||K8(MS,e)&&t===MS.indexOf?Y8:t},fL=D(z8);function q8(e,t){if(e==null)return{};var n,i,r=(function(o,a){if(o==null)return{};var c={};for(var d in o)if({}.hasOwnProperty.call(o,d)){if(fL(a).call(a,d)!==-1)continue;c[d]=o[d]}return c})(e,t);if(pL){var s=pL(e);for(i=0;i<s.length;i++)n=s[i],fL(t).call(t,n)===-1&&{}.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}let _L=class{get localCapabilities(){return wt(this._localCapabilities)}get rtpCapabilities(){return wt(this._rtpCapabilities)}get candidates(){return wt(this._candidates)}get iceParameters(){return wt(this._iceParameters)}get dtlsParameters(){return wt(this._dtlsParameters)}constructor(e){v(this,"sessionDesc",void 0),v(this,"_localCapabilities",void 0),v(this,"_rtpCapabilities",void 0),v(this,"_candidates",void 0),v(this,"_iceParameters",void 0),v(this,"_dtlsParameters",void 0),v(this,"setup",void 0),v(this,"currentMidIndex",void 0),v(this,"cname","o/i14u9pJrxRKAsu"),v(this,"firefoxSsrcMidMap",new Map),e=wt(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,localCapabilities:s,direction:o,setup:a,videoCodec:c,audioCodec:d}=e;let l;this.setup=a,l=o===$n.RECEIVE_ONLY?Jn(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Jn(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=s;const u=o===$n.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,h=o===$n.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=o===$n.RECEIVE_ONLY?r.send.videoCodecs:nl(ue.VIDEO,u,h,c),R=o===$n.RECEIVE_ONLY?r.send.audioCodecs:nl(ue.AUDIO,u,h,d);for(const T of l.mediaDescriptions)T.attributes.iceUfrag=t.iceUfrag,T.attributes.icePwd=t.icePwd,T.attributes.fingerprints=n.fingerprints,T.attributes.candidates=i,T.attributes.setup=this.setup,T.media.mediaType==="application"&&(T.attributes.sctpPort="5000"),T.media.mediaType==="video"&&(T.media.fmts=p.map((y=>y.payloadType.toString(10))),T.attributes.payloads=p,T.attributes.extmaps=u.videoExtensions),T.media.mediaType==="audio"&&(T.media.fmts=R.map((y=>y.payloadType.toString(10))),T.attributes.payloads=R,T.attributes.extmaps=u.audioExtensions,Pc(T));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return Ds(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every((t=>this.hasMid(t))):this.sessionDesc.mediaDescriptions.some((t=>t.attributes.mid===e))}send(e,t,n,i,r){n=n.replace(/ /g,"-");const{ssrcs:s,ssrcGroups:o}=el(t,this.cname,b("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(s);if(a){if(It()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,s,i);let d;return c===-1?(d=this.createOrRecycleSendMedia(e,s,o,"sendonly",i,r),this.updateBundleMids()):(d=wt(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=s,d.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),It()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>n.attributes.mid&&e.indexOf(n.attributes.mid)!==-1));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((n=>{n.attributes.ssrcs=[]})),this.updateBundleMids()}receive(e,t,n){const i=[];return e.forEach((r=>{const s=r._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(s);let a,c=!1;o===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",t,n),this.updateBundleMids()):(a=wt(this.sessionDesc.mediaDescriptions[o]),a.attributes.direction="recvonly"),i.push({mid:a.attributes.mid,needCreateTransceiver:c})})),i}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>e.indexOf(n.attributes.mid)!==-1));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((n=>{n.media.port="0",n.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:n,address:i,port:r,type:s,relatedAddress:o,relatedPort:a,priority:c}=new RTCIceCandidate(e),d={foundation:t??"",componentId:"1",transport:n??"",priority:c?c+"":"",connectionAddress:i??"",port:r?r+"":"",type:s?s+"":"",relAddr:o??"",relPort:a?a+"":"",extension:{}};this.candidates.some((l=>l.priority===d.priority&&l.connectionAddress===d.connectionAddress&&l.port===d.port))||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach((l=>{l.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,n,i,r){const s=e._mediaStreamTrack.kind,o=this.rtpCapabilities.recv,a=nl(s,o,this.localCapabilities.send,s===ue.AUDIO?r:i),c=s===ue.VIDEO?o.videoExtensions:o.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:s,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((h=>h.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,e);const u=this.findFirstClosedMedia(s);if(u){const h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>X(e).call(e,n.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((n=>{n.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>X(e).call(e,n.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((n=>{n.attributes.direction="recvonly"}))}findAvailableMediaIndex(e,t,n){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const r=i.media.mediaType===e&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(It()){if(r){const s=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(s||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!s||s!==i.attributes.mid)}return!1}return r&&i.attributes.mid===n}))}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex((t=>{const n=t.media.mediaType===e&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&n}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}restartICE(e){e=wt(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}createOrRecycleSendMedia(e,t,n,i,r,s){const o=this.rtpCapabilities.send,a=e===ue.VIDEO?o.videoCodecs:o.audioCodecs,c=e===ue.VIDEO?o.videoExtensions:o.audioExtensions;It()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((u=>u.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,s);const l=this.findFirstClosedMedia(e);if(l){const u=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[u]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(e,t,n){const i=wt(e);return Ag(i),ca(i,t),Og(i,t),oN(i),$h(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=wt(e);return $h(n,t,this.localCapabilities.recv),Pc(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((i=>i.attributes.mid===e));if(n!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=i}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>e.media.port!=="0")).map((e=>e.attributes.mid))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return((n=t.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===e[0].ssrcId}))}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>It()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0"))}};const X8=["sdp"];var At;function EL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function yo(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?EL(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):EL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let gL=(At=class Jc extends WO{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,n,i){super(t,n),v(this,"direction",void 0),v(this,"name",void 0),v(this,"store",void 0),v(this,"spec",void 0),v(this,"peerConnection",void 0),v(this,"initialOffer",void 0),v(this,"transport",void 0),v(this,"statsFilter",void 0),v(this,"localCandidateCount",0),v(this,"_isInRestartIce",!1),v(this,"mutex",void 0),v(this,"onLocalCandidate",void 0),v(this,"remoteSDP",void 0),v(this,"pendingCandidates",[]),v(this,"localCapabilities",void 0),v(this,"isReady",!1),v(this,"restartCnt",0),v(this,"curTurnServerIndex",0),this.store=n,this.spec=t,this.mutex=new gn("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Jc.resolvePCConfiguration(t,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=i??$n.SEND_ONLY,this.name=this.direction===$n.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=yh(this.peerConnection,b("STATS_UPDATE_INTERVAL"),void 0,It()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{const n=await Dg();if(this.localCapabilities=tl(n),t){const{sdp:i}=t,r=q8(t,X8),s=(function(){const l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},u=$d(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},R={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(_r(u,l,"videoExtensions",h,p,R),_r(u,l,"videoCodecs",h,p,R),_r(u,l,"audioExtensions",h,p,R),_r(u,l,"audioCodecs",h,p,R),b("RAISE_H264_BASELINE_PRIORITY")){const T=R.videoCodecs.findIndex((y=>y.rtpMap&&y.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&y.fmtp&&y.fmtp.parameters["profile-level-id"]==="42001f"));if(T!==-1){const y=R.videoCodecs.findIndex((I=>I.rtpMap&&I.rtpMap.encodingName.toLocaleLowerCase()==="h264"));if(y<T){_.debug("raising H264 baseline profile priority");const I=R.videoCodecs[T];R.videoCodecs.splice(T,1),R.videoCodecs.splice(y,0,I)}y!==-1&&b("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter((I=>!(I.rtpMap&&I.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&I.fmtp&&I.fmtp.parameters["profile-level-id"]!=="42001f"))))}}return{send:h,recv:p,sendrecv:R}})({},{},i);this.remoteSDP=new _L({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=ds(o.sdp);await this.peerConnection.setLocalDescription(o);const c=await cN({},{},o.sdp);this.localCapabilities=tl(c);const d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),yo(yo({},a),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=ds(i.sdp);return this.initialOffer=i,yo(yo({},r),{},{sdp:i.sdp})}}catch(n){throw new F(w.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:n,iceParameters:i,dtlsParameters:r}=t,s=await cN({},{},n);this.remoteSDP=new _L({remoteIceParameters:i,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];o!=null&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((n=>{this.peerConnection.addIceCandidate(n)})),this.pendingCandidates=[])}catch(n){throw new F(w.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(t,n,i){var r=this;return ni((function*(){const s=yield Ve(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=r.remoteSDP.receive(t,n,i);t.forEach(((y,I)=>{if(a[I].needCreateTransceiver){const A=r.peerConnection.addTransceiver(y._mediaStreamTrack,{direction:"sendonly"});o.push(A),y._updateRtpTransceiver(A)}else{const A=r.peerConnection.getTransceivers().find((N=>N.mid===a[I].mid));if(!A)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[I].mid));o.push(A),y._updateRtpTransceiver(A)}})),It()&&b("SIMULCAST")===!0&&(yield Ve(r.applySimulcastForFirefox(o,t)));const c=a.map((y=>y.mid)),d=yield Ve(r.peerConnection.createOffer()),l=r.mungSendOfferSDP(d.sdp,t,c),u=Jn(l),h=c.map((y=>{const I=u.mediaDescriptions.find((A=>A.attributes.mid===y));if(!I)throw new Error("Cannot extract ssrc from mediaDescription.");return wg(I,b("USE_PUB_RTX"))})),p=o.map(((y,I)=>{const A=c[I];return{localSSRC:h[I],id:A}}));yield Ve(r.peerConnection.setLocalDescription({type:"offer",sdp:l}));try{yield p}catch(y){const I=r.remoteSDP.toString();throw yield Ve(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ve(r.peerConnection.setRemoteDescription({type:"answer",sdp:I})),yield Ve(r.stopSending(c,!0)),y}yield Ve(r.applySimulcastEncodings(o,t)),yield Ve(r.applySendEncodings(o,t));const R=r.remoteSDP.toString(),T=r.logSDPExchange(l,"offer","local","send");return T?.(R),yield Ve(r.setRemoteDescription({type:"answer",sdp:R})),o.map(((y,I)=>{const A=c[I];return{localSSRC:h[I],id:A}}))}catch(o){throw o instanceof F?o:new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}}))()}async stopSending(t,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter((c=>t.indexOf(c.mid)!==-1));if(r.length!==t.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));r.map((c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)}));const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o?.(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,n,i,r);if(o){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,s,t);d?.(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((c=>c.mid===s));if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(s){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async mockReceive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,n,i,r);if(o){const a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});const d=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(d.sdp,s,t);c?.(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(s){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===Jo.Auto&&(this.store.p2pTransport=Jo.SdRtn,We().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Jc.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,We().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Jc.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:i}=ds(n.sdp);return this.store.descriptionStart(),this.direction===$n.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),i}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===$n.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:i}=ds(n.sdp);return await this.peerConnection.setLocalDescription(n),i}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new F(w.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getTransceivers().filter((r=>r.mid===t));i.length===1&&(this.isVP8Simulcast(n)?It()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getTransceivers().find((r=>r.mid===n));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:yo(yo({},lr),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:yo(yo({},lr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t,n;X(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var n;t.candidate.candidate&&((n=this.onLocalCandidate)===null||n===void 0||n.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else _.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r={iceServers:[]};var s;return t.iceServers?r.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Ho(t.turnServer.servers)?r.iceServers=t.turnServer.servers:(r.iceServers&&r.iceServers.push(...Jc.turnServerConfigToIceServers(t.turnServer.servers,n,i)),b("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&t.turnServer.serversFromGateway&&r.iceServers.push(...Jc.turnServerConfigToIceServers(t.turnServer.serversFromGateway,n,i)),X(s=[Jo.Relay,Jo.SdRtn]).call(s,n)&&(r.iceTransportPolicy="relay"),b("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((o=>{o.forceturn&&(r.iceTransportPolicy="relay")})))),b("ENABLE_ENCODED_TRANSFORM")&&We().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),_.debug("P2PConnection p2pTransport is ".concat(n)),r}static turnServerConfigToIceServers(t,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r=[],s=t.filter((a=>a.tcpport));_.debug("P2PConnection turnServers is ".concat(s,", current index is ").concat(i));const o=s.length>i?s[i]:s[0];switch(n){case Jo.SdRtn:const a=t.filter((d=>{var l;return X(l=d.username).call(l,"glb:")&&d.turnServerURL==d.turnServerURL})),c=a.length>i?a[i]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(fr(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(fr(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case Jo.Relay:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(fr(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(fr(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return r}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var i;t!=null&&t.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,t.state))},t.onerror=i=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in i?i.error:i)};const n=t.iceTransport;n&&(n.onstatechange=()=>{const i=t?.iceTransport.state;var r;i&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,i))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:i,remote:r}=n.getSelectedCandidatePair()||{};if(i&&r){const s=i.address+":"+i.port,o=r.address+":"+r.port;_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(cs(s)),", remote ").concat(JSON.stringify(cs(o))))}}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i;if(n||(n=this.peerConnection.getSenders().find((l=>l.track===t._mediaStreamTrack))),!n)return _.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!We().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},s={};switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(t._encoderConfig){var o;const{bitrateMax:l,frameRate:u,scaleResolutionDownBy:h}=t._encoderConfig;l&&(s.maxBitrate=1e3*l),X(o=t._hints).call(o,ct.LOW_STREAM)&&(u&&(s.maxFramerate=ai(u)),h&&h>=1&&(s.scaleResolutionDownBy=h))}if(b("DSCP_TYPE")&&is()){var a;const l=b("DSCP_TYPE");X(a=["very-low","low","medium","high"]).call(a,l)&&(s.networkPriority=l)}const c=n.getParameters(),d=(i=c.encodings)===null||i===void 0?void 0:i[0];It()&&!d&&(r.encodings=[s]),d&&Object.assign(d,s),Object.assign(c,r),_.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await n.setParameters(c)}async applySendEncodings(t,n){try{if(!We().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=n[i];s instanceof yt&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,i){const r=Jn(t);return n.forEach(((s,o)=>{const a=i[o],c=r.mediaDescriptions.find((d=>d.attributes.mid===a));c&&(ca(c,s),Ng(c,s,this.store.codec))})),Ds(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let c=0;c<t.length;c++){var i,r,s,o,a;const d=t[c],l=n[c];if(l instanceof yt&&!X(i=l._hints).call(i,ct.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=l._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];const p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u))}}}async applySimulcastEncodings(t,n){if(!It()&&t.length===n.length)for(let i=0;i<t.length;i++){const r=n[i];if(r instanceof yt&&this.isVP8Simulcast(r)){const s=t[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var n,i,r,s,o;return!!(t instanceof yt&&b("SIMULCAST")&&this.store.codec==="vp8"&&!X(n=t._hints).call(n,ct.LOW_STREAM)&&(i=t._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,r){if(b("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),t),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((o=>{o.direction="inactive"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();r?.(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((async o=>{o.direction="sendonly"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();r?.(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(t,n){var i;if(n=n??((i=this.currentRemoteDescription)===null||i===void 0?void 0:i.sdp)){var r;const s=(r=Jn(n).mediaDescriptions.find((o=>o.attributes.mid===t)))===null||r===void 0?void 0:r.attributes.ssrcs;return s?.[0].ssrcId}}async setRemoteDescription(t){var n;await this.peerConnection.setRemoteDescription(t),X(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,n,i){const r=Jn(t),s=r.mediaDescriptions.find((o=>o.attributes.mid===n));return s&&i===ue.AUDIO&&s.media.mediaType==="audio"&&Pc(s),Ds(r)}},re(At.prototype,"establish",[yr],Object.getOwnPropertyDescriptor(At.prototype,"establish"),At.prototype),re(At.prototype,"connect",[yr],Object.getOwnPropertyDescriptor(At.prototype,"connect"),At.prototype),re(At.prototype,"receive",[yr],Object.getOwnPropertyDescriptor(At.prototype,"receive"),At.prototype),re(At.prototype,"mockReceive",[yr],Object.getOwnPropertyDescriptor(At.prototype,"mockReceive"),At.prototype),re(At.prototype,"stopReceiving",[yr],Object.getOwnPropertyDescriptor(At.prototype,"stopReceiving"),At.prototype),re(At.prototype,"restartICE",[yr],Object.getOwnPropertyDescriptor(At.prototype,"restartICE"),At.prototype),re(At.prototype,"close",[yr],Object.getOwnPropertyDescriptor(At.prototype,"close"),At.prototype),re(At.prototype,"updateEncoderConfig",[yr],Object.getOwnPropertyDescriptor(At.prototype,"updateEncoderConfig"),At.prototype),re(At.prototype,"updateSendParameters",[yr],Object.getOwnPropertyDescriptor(At.prototype,"updateSendParameters"),At.prototype),re(At.prototype,"replaceTrack",[yr],Object.getOwnPropertyDescriptor(At.prototype,"replaceTrack"),At.prototype),re(At.prototype,"muteLocal",[yr],Object.getOwnPropertyDescriptor(At.prototype,"muteLocal"),At.prototype),re(At.prototype,"unmuteLocal",[yr],Object.getOwnPropertyDescriptor(At.prototype,"unmuteLocal"),At.prototype),At);function yr(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}let Br=(function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e})({});var SL,TL,yL,vL,RL,CL,bL,IL,wL,AL,OL,xt;function NL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function xp(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?NL(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):NL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let J8=(SL=Wr(Br.SEND_ONLY),TL=Wr(Br.SEND_ONLY),yL=Wr(),vL=Wr(Br.RECEIVE_ONLY),RL=Wr(Br.RECEIVE_ONLY),CL=Wr(Br.RECEIVE_ONLY),bL=Wr(Br.RECEIVE_ONLY),IL=Wr(Br.RECEIVE_ONLY),wL=Wr(Br.RECEIVE_ONLY),AL=Wr(),OL=Wr(Br.RECEIVE_ONLY),xt=class extends kt{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(ge.StateChange,t,this._state)}constructor(e,t){super(),v(this,"isPlanB",!1),v(this,"store",void 0),v(this,"statsUploader",void 0),v(this,"sendConnection",void 0),v(this,"recvConnection",void 0),v(this,"localTrackMap",new Map),v(this,"remoteUserMap",new Map),v(this,"localDataChannels",[]),v(this,"pendingLocalTracks",[]),v(this,"pendingRemoteTracks",[]),v(this,"statsCollector",void 0),v(this,"dtlsFailedCount",0),v(this,"sendMutex",void 0),v(this,"recvMutex",void 0),v(this,"_state",st.Disconnected),v(this,"_restartStates",["disconnected","failed"]),v(this,"reconnectInterval",void 0),v(this,"uploadUnplinkStarted",!1),v(this,"uploadDownlinkStarted",!1),v(this,"uplinkStateUploadInterval",void 0),v(this,"downlinkStatsUploadInterval",void 0),v(this,"handleMuteLocalTrack",(async(n,i,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==st.Connected)return void r(new F(w.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const c=this.filterTobeMutedTracks(n);if(c.length===0)return void i();const d=c.find((p=>p[0]==="videoLowTrack"));d&&d[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(c.map((p=>{let[,{id:R}]=p;return R})));let l=!1;var o,a;n.trackMediaType==="video"?l=!((o=this.localTrackMap.get(J.LocalAudioTrack))===null||o===void 0||!o.track._muted):l=((a=this.localTrackMap.get(J.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;const u=this.createMuteMessage(c);await vt(this,ge.RequestMuteLocal,u);const h=n.trackMediaType==="video"?co.MUTE_LOCAL_VIDEO:co.MUTE_LOCAL_AUDIO;await vt(this,ge.RequestP2PMuteLocal,{action:h,message:u,isMuteAll:l}),i()}catch(c){r(c)}finally{s()}})),v(this,"handleUnmuteLocalTrack",(async(n,i,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==st.Connected)return void r(new F(w.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const o=this.filterTobeUnmutedTracks(n);if(o.length===0)return void i();await this.sendConnection.unmuteLocal(o.map((d=>{let[,{id:l}]=d;return l})));const a=this.createUnmuteMessage(o),c=n.trackMediaType==="video"?co.UNMUTE_LOCAL_VIDEO:co.UNMUTE_LOCAL_AUDIO;await vt(this,ge.RequestP2PMuteLocal,{action:c,message:a}),i()}catch(o){r(o)}finally{s()}})),v(this,"handleUpdateVideoEncoder",(async(n,i,r,s)=>{let o;typeof s=="boolean"&&s||(o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{const c=this.localTrackMap.get(J.LocalVideoTrack);if(!this.sendConnection||!c||c.track!==n||this.state!==st.Connected)return void i();const{id:d,track:l}=c;d&&(await this.sendConnection.updateSendParameters(d,l),await this.sendConnection.updateEncoderConfig(d,l),this.emit(ge.UpdateVideoEncoder,l)),i()}catch(c){r(c)}finally{var a;(a=o)===null||a===void 0||a()}})),v(this,"handleUpdateVideoSendParameters",(async(n,i,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(J.LocalVideoTrack);if(!this.sendConnection||!o||o.track!==n||this.state!==st.Connected)return void i();const{id:a,track:c}=o;a&&await this.sendConnection.updateSendParameters(a,c),i()}catch(o){r(o)}finally{s()}})),v(this,"handleReplaceTrack",(async(n,i,r,s)=>{let o;_.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof s=="boolean"&&s||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find((l=>{let[,{track:u}]=l;return n===u}));if(!this.sendConnection||!d||d[1].id===void 0||this.state!==st.Connected)return void i();if(await((a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),d[0]===J.LocalVideoTrack&&We().supportDualStreamEncoding){const l=this.localTrackMap.get(J.LocalVideoLowTrack);if(l){const u=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new ie(((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)}))}}i()}catch(d){r(d)}finally{var c;(c=o)===null||c===void 0||c()}})),v(this,"handleGetLocalVideoStats",(n=>{n(this.statsCollector.getLocalVideoTrackStats())})),v(this,"handleGetLocalAudioStats",(n=>{n(this.statsCollector.getLocalAudioTrackStats())})),v(this,"handleGetRemoteVideoStats",(n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid])),v(this,"handleGetRemoteAudioStats",(n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid])),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new HN(e),this.bindStatsUploaderEvents(),this.sendMutex=new gn("P2PChannel2-send-mutex",e.clientId),this.recvMutex=new gn("P2PChannel2-recv-mutex",e.clientId),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))}))}),b("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new F(w.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e){throw new F(w.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let n;try{if(t){this.recvConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new gL(e,this.store,$n.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const i=await this.recvConnection.establish(t);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=st.New,this.sendConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new gL(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n()}}async p2pConnect(e){if(!this.sendConnection)throw new F(w.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=st.Connected}async addRemoteCandidate(e,t){if(t===$n.RECEIVE_ONLY){if(!this.sendConnection)throw new F(w.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new F(w.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,n){var i=this;return ni((function*(){const r=yield Ve(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==st.Connected){i.throwIfTrackTypeNotMatch(e);const d=e.filter((l=>i.pendingLocalTracks.indexOf(l)===-1));return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(d))}i.store.pubId=i.store.pubId+1,xn.markPublishStart(i.store.clientId,i.store.pubId);const s=i.filterTobePublishedTracks(e,t,n);if(s.length===0)return void(yield Ve(i.tryToUnmuteAudio(e)));s.forEach((d=>{let{track:l,type:u}=d;const h=Date.now();i.store.publish(l.getTrackId(),u===J.LocalAudioTrack?"audio":"video",h)})),i.bindLocalTrackEvents(s);const o=yield Ve(i.sendConnection.send(s.map((d=>{let{track:l}=d;return l})),i.store.codec,i.store.audioCodec)),a=(yield Ve(o.next())).value,c=i.createGatewayPublishMessage(s,a);try{yield c}catch(d){throw o.throw(d),d?.code===w.WS_ABORT&&s.forEach((l=>{let{track:u}=l;i.pendingLocalTracks.indexOf(u)===-1&&i.pendingLocalTracks.push(u)})),i.unbindLocalTrackEvents(s),d}yield Ve(o.next()),s.forEach((d=>{let{type:l}=d;i.statsCollector.addLocalStats(l)})),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(s,a),s.forEach((d=>{let{track:l,type:u}=d;const h=Date.now();i.store.publish(l.getTrackId(),u===J.LocalAudioTrack?"audio":"video",void 0,h)})),i.startUploadUplinkState()}finally{r()}}))()}async unpublish(e){if(!this.sendConnection||this.state!==st.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((r=>!X(e).call(e,r))));const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const n=t.find((r=>r[0]==="videoLowTrack"));n&&n[1].track.close();const i=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map((r=>{let[,{id:s}]=r;return s}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((r=>{let[s,{track:o}]=r;return{type:s,track:o}}))),t.forEach((r=>{let[s]=r;this.statsCollector.removeLocalStats(s)})),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===st.Connected)return n&&n[1].track.close(),i;e.forEach((r=>{const s=this.pendingLocalTracks.indexOf(r);s!==-1&&this.pendingLocalTracks.splice(s,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const t=[],n=[];Array.from(this.localTrackMap.entries()).forEach((i=>{let[r,{track:s,ssrcs:o}]=i;const a={stream_type:VH(s,r),ssrcs:o};s._muted||!s._enabled?t.push(a):n.push(a)})),t.length>0&&t.forEach((i=>{vt(this,ge.RequestMuteLocal,[i])})),n.length>0&&n.forEach((i=>{vt(this,ge.RequestUnmuteLocal,[i])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return ni((function*(){throw new F(w.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await en(this,ge.RequestRePublish,this.pendingLocalTracks),this.emit(ge.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new F(w.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,n,i){var r;if(!this.recvConnection)throw new F(w.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(e))!==null&&r!==void 0&&r.has(t))return;const{track:s,mid:o,transceiver:a}=await this.recvConnection.receive(t,[{ssrcId:n}],String(e.uid),i);t===ue.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(s):(e._audioTrack=new Cc(s,e.uid,e._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),a&&e._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(s):(e._videoTrack=new Rc(s,e.uid,e._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),a&&e._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._videoTrack));const c=this.remoteUserMap.get(e);c?c.set(t,o):this.remoteUserMap.set(e,new Map([[t,o]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const d=this.pendingRemoteTracks.findIndex((l=>{let{user:u,kind:h}=l;return u.uid===e.uid&&t===h}));d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(ge.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,n,i){if(!this.recvConnection)throw new F(w.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:n}],String(e.uid),i)}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter((s=>{let{user:o,kind:a}=s;return t!==void 0?o.uid===e.uid&&t===a:o.uid===e.uid}));if(i.forEach((s=>{const o=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(o,1)})),this.recvConnection||n||i.forEach((s=>{let{kind:o}=s;var a;if(o===ue.AUDIO)(a=e._audioTrack)===null||a===void 0||a._destroy(),e._audioTrack=void 0;else if(o===ue.VIDEO){var c;(c=e._videoTrack)===null||c===void 0||c._destroy(),e._videoTrack=void 0}})),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(e,t);r.length!==0&&(await this.recvConnection.stopReceiving(r.map((s=>{let[,{id:o}]=s;return o}))),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach((s=>{let[o,{kind:a}]=s;var c,d;if(a===ue.VIDEO&&o._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),a===ue.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),n||((d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0);else if(a===ue.AUDIO){var l;this.unbindRemoteTrackEvents(o._audioTrack),!n&&((l=o._audioTrack)===null||l===void 0||l._destroy(),o._audioTrack=void 0)}})),r.forEach((s=>{let[,{kind:o}]=s;vt(this,ge.RequestP2PMuteRemote,o)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((t=>{let[,n]=t;[ue.VIDEO,ue.AUDIO].forEach((i=>{n.has(i)?vt(this,ge.RequestP2PUnmuteRemote,i):vt(this,ge.RequestP2PMuteRemote,i)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new F(w.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new F(w.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new F(w.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new F(w.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===ue.VIDEO?e._videoSSRC:e._audioSSRC;i!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(t)||_.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){const t=this.localTrackMap.get(J.LocalAudioTrack);if(t?.track instanceof sn){const n=t.track;return Array.from(this.localTrackMap.entries()).filter((i=>{let[r]=i;return r!==J.LocalAudioTrack})).filter((i=>{let[r]=i;return!(e&&r===J.LocalVideoLowTrack)})).map((i=>{let[,{track:r}]=i;return r})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((n=>{let[i]=n;return!(e&&i===J.LocalVideoLowTrack)})).map((n=>{let[,{track:i}]=n;return i}))}reportPublishEvent(e,t,n,i,r){if(e){const o=this.localTrackMap.get(J.LocalAudioTrack),a=i?this.localTrackMap.get(J.LocalVideoLowTrack):this.localTrackMap.get(J.LocalVideoTrack);pe.publish(this.store.sessionId,{eventElapse:xn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(ct.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var s;n||(n=[]);const o=n.find((c=>c instanceof Wt)),a=i?(s=this.localTrackMap.get(J.LocalVideoTrack))===null||s===void 0?void 0:s.track:n.find((c=>c instanceof yt));pe.publish(this.store.sessionId,{eventElapse:xn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(ct.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===ue.VIDEO?n._videoSSRC:n._audioSSRC;r&&pe.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===ue.VIDEO,audio:i===ue.AUDIO,peerid:n.uid,subscribeRequestid:i===ue.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:xn.measureFromSubscribeStart(this.store.clientId,r)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new gn("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new gn("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(J.LocalAudioTrack);if(e?.track instanceof sn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((n=>{t.removeAudioTrack(n)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=st.Disconnected}getStats(e){var t,n;return e?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(t=this.sendConnection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.recvConnection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(J.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(J.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof yt||t&&t.track instanceof Wt?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(Bn(t=this.remoteUserMap).call(t)).find((i=>i.uid===e));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(J.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=ko(e).call(e,((n,i)=>n.level-i.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=st.Reconnecting,b("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&((n=t._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[n,{track:i}]=e;switch(n){case J.LocalVideoTrack:X(t=i._hints).call(t,ct.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case J.LocalAudioTrack:i instanceof sn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case J.LocalVideoLowTrack:}})),this.emit(ge.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;Array.from(Bn(n).call(n)).forEach((i=>{this.setPendingRemoteMedia(t,i)})),this.emit(ge.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof ho?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let n,i;if(e===$n.SEND_ONLY){if(!this.sendConnection)throw new F(w.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection}else{if(!this.recvConnection)throw new F(w.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection}try{if(t){const r=await i.restartICE(t);return i.isInRestartIce=!1,r}{const r=await i.restartICE();if(r){const s=await en(this,ge.RequestP2PRestartICE,{direction:$n.RECEIVE_ONLY,iceParameter:r});await i.restartICE(s),i.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(J.LocalVideoTrack),n=this.localTrackMap.get(J.LocalAudioTrack),i=e.videoSend.find((p=>{var R;return p.ssrc===(t==null||(R=t.ssrcs)===null||R===void 0?void 0:R[0].ssrcId)})),r=e.audioSend.find((p=>{var R;return p.ssrc===(n==null||(R=n.ssrcs)===null||R===void 0?void 0:R[0].ssrcId)}));if(!i||!r)return 1;const s=vi(this,ge.NeedSignalRTT),o=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=o&&a?(o+a)/2:o||a,d=(c&&s?(c+s)/2:c||s)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=t?.track;if(h&&h._encoderConfig&&h._hints.indexOf(ct.SCREEN_TRACK)===-1){const p=h._encoderConfig.bitrateMax,R=e.bitrate.actualEncoded;if(p&&R){const T=(1e3*p-R)/(1e3*p);return kO[T<.15?0:T<.3?1:T<.45?2:T<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,s=i._videoSSRC,o=e.audioRecv.find((R=>R.ssrc===r)),a=e.videoRecv.find((R=>R.ssrc===s));if(!o&&!a)return void(t+=1);const c=vi(this,ge.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=o?o.jitterMs:void 0,h=e.recvPacketLossRate;let p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new ie(((t,n)=>{this.handleMuteLocalTrack(e,t,n)}))}filterTobePublishedTracks(e,t,n){const i=[],r=We(),s=this.getAllTracks();e=lc(e=e.filter((c=>s.indexOf(c)===-1)));let o=!1,a=!1;for(const c of e){if(c instanceof yt&&(this.localTrackMap.has(J.LocalVideoTrack)||o?new F(w.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:J.LocalVideoTrack}),o=!0),t)){const d=this.getLowVideoTrack(c,n);i.push({track:d,type:J.LocalVideoLowTrack})}if(c instanceof Wt){const d=this.localTrackMap.get(J.LocalAudioTrack);if(d){if(!(d.track instanceof sn))throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const l=i.find((u=>{let{type:h}=u;return h===J.LocalAudioTrack}));if(!(l.track instanceof sn))throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof sn||c._bypassWebAudio)i.push({track:c,type:J.LocalAudioTrack});else{const l=new sn;l.addAudioTrack(c),i.push({track:l,type:J.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=lc(e=e.filter((i=>n.indexOf(i)!==-1)));for(const i of e){if(i instanceof Wt){const r=this.localTrackMap.get(J.LocalAudioTrack);if(!r)continue;r.track instanceof sn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(t.push([J.LocalAudioTrack,r]),r.track.close())):t.push([J.LocalAudioTrack,r])}if(i instanceof yt){const r=this.localTrackMap.get(J.LocalVideoTrack);if(!r)continue;t.push([J.LocalVideoTrack,r]);const s=this.localTrackMap.get(J.LocalVideoLowTrack);s&&t.push([J.LocalVideoLowTrack,s])}}return t}bindLocalTrackEvents(e){e.forEach((t=>{let{track:n,type:i}=t;switch(i){case J.LocalVideoTrack:n.addListener(me.GET_STATS,this.handleGetLocalVideoStats),n.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(me.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case J.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case J.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof sn?e.trackList.forEach((n=>{n.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(me.GET_STATS,this.handleGetLocalAudioStats),n.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(me.GET_STATS,this.handleGetLocalAudioStats),e.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(me.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((t=>{let[n,{track:i}]=t;return{track:i,type:n}}))),e.forEach((t=>{let{track:n,type:i}=t;switch(i){case J.LocalVideoTrack:n.off(me.GET_STATS,this.handleGetLocalVideoStats),n.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(me.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case J.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case J.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof sn?e.trackList.forEach((t=>{t.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(me.GET_STATS,this.handleGetLocalAudioStats),t.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(me.GET_STATS,this.handleGetLocalAudioStats),e.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Rc&&t.addListener(me.GET_STATS,(n=>{n(this.handleGetRemoteVideoStats(e))})),t instanceof Cc&&t.addListener(me.GET_STATS,(n=>{n(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(me.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;n.has(ue.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(ue.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((n,i)=>{var r;let s,{track:o,type:a}=n;switch(a){case J.LocalAudioTrack:s=pt.Audio;break;case J.LocalVideoTrack:s=X(r=o._hints).call(r,ct.SCREEN_TRACK)?pt.Screen:pt.High;break;case J.LocalVideoLowTrack:s=pt.Low}return{kind:a===J.LocalAudioTrack?ue.AUDIO:ue.VIDEO,stream_type:s,mid:t[i].id,ssrcs:t[i].localSSRC,isMuted:o.muted||!o.enabled}}))}createGatewayUnpublishMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case J.LocalVideoTrack:i=X(n=s._hints).call(n,ct.SCREEN_TRACK)?pt.Screen:pt.High;break;case J.LocalAudioTrack:i=pt.Audio;break;case J.LocalVideoLowTrack:i=pt.Low}return{stream_type:i,ssrcs:o,mid:a}}))}assignLocalTracks(e,t){e.forEach(((n,i)=>{let{track:r,type:s}=n;this.localTrackMap.set(s,{track:r,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((t=>{let[n]=t;this.localTrackMap.delete(n)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{var n;_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(ge.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(e.isInRestartIce=!1),X(n=this._restartStates).call(n,t)&&!e.isInRestartIce&&(t==="disconnected"&&await hn(800),e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="failed"||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),pe.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:Tt.TRACER}).onSuccess(),this.emit(ge.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var n;const i=Array.from(Bn(n=this.remoteUserMap).call(n)).find((s=>s._audioSSRC===t));var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(Ki.FIRST_FRAME_DECODED),pe.firstRemoteFrame(this.store.sessionId,rn.FIRST_AUDIO_DECODE,Dt.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:xn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var n;const i=Array.from(Bn(n=this.remoteUserMap).call(n)).find((r=>r._audioSSRC===t));i&&pe.firstRemoteFrame(this.store.sessionId,rn.FIRST_AUDIO_RECEIVED,Dt.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:xn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,n,i)=>{this.reportVideoFirstFrameDecoded(t,n,i)},e.onFirstVideoReceived=t=>{var n;const i=Array.from(Bn(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===t));i&&pe.firstRemoteFrame(this.store.sessionId,rn.FIRST_VIDEO_RECEIVED,Dt.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:xn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,n)=>{const i=t.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(ge.ConnectionTypeChange,i),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(lo(n))," -> ").concat(JSON.stringify(lo(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,n)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(lo(n))," -> ").concat(JSON.stringify(lo(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(ge.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===$n.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,_.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===$n.SEND_ONLY?this.restartICE(e):en(this,ge.RequestP2PRestartICE,{direction:$n.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const n=this.localTrackMap.get(J.LocalAudioTrack);if(e instanceof Wt&&n?.track instanceof sn)return n.track.isActive||t.push([J.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return e===s}));if(i&&(t.push(i),i[0]===J.LocalVideoTrack)){const r=this.localTrackMap.get(J.LocalVideoLowTrack);r&&t.push([J.LocalVideoLowTrack,r])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(J.LocalAudioTrack);if(e instanceof Wt&&n?.track instanceof sn)return n.track.isActive&&t.push([J.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return e===s}));if(i)if(i[0]===J.LocalVideoTrack){t.push(i);const r=this.localTrackMap.get(J.LocalVideoLowTrack);r&&t.push([J.LocalVideoLowTrack,r])}else t.push(i);return t}createMuteMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case J.LocalAudioTrack:i=pt.Audio;break;case J.LocalVideoTrack:i=X(n=s._hints).call(n,ct.SCREEN_TRACK)?pt.Screen:pt.High;break;case J.LocalVideoLowTrack:i=pt.Low}return{stream_type:i,ssrcs:o,mid:a}}))}createUnmuteMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case J.LocalAudioTrack:i=pt.Audio;break;case J.LocalVideoTrack:i=X(n=s._hints).call(n,ct.SCREEN_TRACK)?pt.Screen:pt.High;break;case J.LocalVideoLowTrack:i=pt.Low}return{stream_type:i,ssrcs:o,mid:a}}))}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach((r=>{let[s,o]=r;n.push([e,{kind:s,id:o}])}));return n}createUnsubscribeMessage(e){const t=[];return e.forEach((n=>{let[i,{kind:r,id:s}]=n;switch(r){case ue.VIDEO:return void(i._videoSSRC&&t.push({stream_type:ue.VIDEO,ssrcId:i._videoSSRC}));case ue.AUDIO:return void(i._audioSSRC&&t.push({stream_type:ue.AUDIO,ssrcId:i._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((t=>{let[n,{kind:i}]=t;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(J.LocalVideoTrack),n=this.localTrackMap.get(J.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new ie(((i,r)=>{this.handleUpdateVideoEncoder(t.track,i,r,!0)}))),n&&e.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new ie(((i,r)=>{this.handleUpdateVideoEncoder(n.track,i,r,!0)})))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return e!=="connected"&&t!=="connected"}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof Wt){const n=this.filterTobeUnmutedTracks(e[t]);if(n.length===0)continue;const i=this.createUnmuteMessage(n);return void await vt(this,ge.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.recvConnection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(ge.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(ge.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await hn(Eh(this.dtlsFailedCount,Xt)),this.emit(ge.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(J.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof yt))}throwIfTrackTypeNotMatch(e){if(e.filter((t=>t instanceof yt)).length>1)throw new F(w.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((t=>t instanceof Wt)).length>1&&(e.some((t=>t instanceof Wt&&t._bypassWebAudio))||!We().webAudioMediaStreamDest))throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof yt&&this.pendingLocalTracks.some((n=>n instanceof yt)))throw new F(w.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Wt&&this.pendingLocalTracks.some((n=>n instanceof Wt))&&(!We().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((n=>n instanceof Wt&&n._bypassWebAudio))))throw new F(w.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const n=!b("DISABLE_DUAL_STREAM_USE_ENCODING")&&We().supportDualStreamEncoding,i=xp(xp({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=n?e._mediaStreamTrack.clone():Jg(e,i);const s=ut(8,"track-low-"),o=new yt(r,xp(xp({},n&&{scaleResolutionDownBy:Ig(i,e)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,s);return o.on($o.TRANSCEIVER_UPDATED,(a=>{e._updateRtpTransceiver(a,Ec.LOW_STREAM)})),o._hints.push(ct.LOW_STREAM),e.addListener(me.NEED_CLOSE,(()=>{o.close()})),o}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,n,i){var r;const s=Array.from(Bn(r=this.remoteUserMap).call(r)).find((o=>o._videoSSRC===e));if(s){i||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,a=o.subscribe.find((c=>c.userId===s.uid&&c.type==="video"));pe.firstRemoteVideoDecode(this.store.sessionId,rn.FIRST_VIDEO_DECODE,Dt.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:t,videoheight:n,subscribeElapse:xn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.recvConnection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const s=await this.recvConnection.getRemoteSSRC(r);return s!==void 0&&s!==n}isPreSubScribe(e){return!1}async publishDataChannel(e){throw new F(w.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new F(w.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new F(w.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new F(w.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new F(w.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new F(w.NOT_SUPPORTED)}async preConnect(e){throw new F(w.NOT_SUPPORTED)}getEstablishParams(){throw new F(w.NOT_SUPPORTED)}async reSubscribe(e){throw new F(w.NOT_SUPPORTED)}reportVideoFirstFrameRender(e){}async updateVideoStreamParameter(e,t){throw new F(w.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:n}]=e;t===J.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,Ec.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}},re(xt.prototype,"p2pConnect",[SL],Object.getOwnPropertyDescriptor(xt.prototype,"p2pConnect"),xt.prototype),re(xt.prototype,"unpublish",[TL],Object.getOwnPropertyDescriptor(xt.prototype,"unpublish"),xt.prototype),re(xt.prototype,"unpublishLowStream",[yL],Object.getOwnPropertyDescriptor(xt.prototype,"unpublishLowStream"),xt.prototype),re(xt.prototype,"subscribe",[vL],Object.getOwnPropertyDescriptor(xt.prototype,"subscribe"),xt.prototype),re(xt.prototype,"mockSubscribe",[RL],Object.getOwnPropertyDescriptor(xt.prototype,"mockSubscribe"),xt.prototype),re(xt.prototype,"unsubscribe",[CL],Object.getOwnPropertyDescriptor(xt.prototype,"unsubscribe"),xt.prototype),re(xt.prototype,"muteRemote",[bL],Object.getOwnPropertyDescriptor(xt.prototype,"muteRemote"),xt.prototype),re(xt.prototype,"unmuteRemote",[IL],Object.getOwnPropertyDescriptor(xt.prototype,"unmuteRemote"),xt.prototype),re(xt.prototype,"hasRemoteMediaWithLock",[wL],Object.getOwnPropertyDescriptor(xt.prototype,"hasRemoteMediaWithLock"),xt.prototype),re(xt.prototype,"disconnectForReconnect",[AL],Object.getOwnPropertyDescriptor(xt.prototype,"disconnectForReconnect"),xt.prototype),re(xt.prototype,"remoteMediaSsrcChanged",[OL],Object.getOwnPropertyDescriptor(xt.prototype,"remoteMediaSsrcChanged"),xt.prototype),xt);function Wr(e){return function(t,n,i){const r=t[n];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];switch(e){case Br.SEND_ONLY:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,o)}finally{c()}}case Br.RECEIVE_ONLY:{const c=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,o)}finally{c()}}default:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n)),d=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,o)}finally{c(),d()}}}},i}}class Ta extends kt{constructor(t,n){super(),v(this,"signal",void 0),v(this,"token",void 0),v(this,"tokenTimeout",void 0),v(this,"tokenInterval",void 0),v(this,"_sequence",0),v(this,"userMap",new Map),v(this,"encoder",new TextEncoder),this.signal=t,this.token=n;const i=()=>{this.signal.connectionState===Ye.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*b("P2P_TOKEN_INTERVAL"))};i()}async send(t,n,i,r,s){var o;if(this.userMap.size===0)return;const a=Array.from(Si(o=this.userMap).call(o))[0].token;typeof n!="string"&&(n=JSON.stringify(n)),r=r??ut(6,""),s=s??this._sequence++;const c={_id:r,_type:t,_seq:s,_message:n,token:"".concat(this.token,"_").concat(a)};b("SHOW_P2P_LOG")&&_.debug("send message",c,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(c)).forEach((l=>{this.signal.request(Ee.DATA_STREAM,{payload:ro(this.encoder.encode(l))})}));const d=new ie(((l,u)=>{const h=window.setTimeout((()=>{this.off("res-@".concat(r,"_ack"),p),this.off("res-@".concat(r),T),this.off(Oc.ABORT,R),_.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(r)),this.userMap.size===0?u(new F(w.INVALID_REMOTE_USER)):u(new F(w.TIMEOUT))}),b("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),p=()=>{h&&window.clearTimeout(h),this.off(Oc.ABORT,R),i&&l()},R=()=>{h&&window.clearTimeout(h),this.off("res-@".concat(r,"_ack"),p),this.off("res-@".concat(r),T),u(new F(w.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(r)))};this.once(Oc.ABORT,R),this.once("res-@".concat(r,"_ack"),p);const T=(I,A)=>{y=!0,h&&window.clearTimeout(h),this.off("res-@".concat(r,"_ack"),p),this.off(Oc.ABORT,R),I==="success"?l(A):u(new F(w.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(r)))};let y=!1;i||(this.once("res-@".concat(r),T),hn(b("SIGNAL_REQUEST_TIMEOUT")).then((()=>{y||_.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(r,", ").concat(c))})))}));try{return await d}catch(l){if(l.code===w.TIMEOUT)return await this.send(t,n,i,r,s);throw l}}onMessage(t){var n;const{_uid:i}=t;let r,s=this.userMap.get(i);if(s)r=s.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==Yt.CHECK)return;const{token:d}=t;r=new Map,s={uid:i,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,s),this.signal.emit(Ae.ON_USER_ONLINE,{uid:i}),this.handleUserOnline()}if("id"in t&&"total"in t){var o;const{id:d,total:l}=t,u=(o=r.get(d))!==null&&o!==void 0?o:[];if(u.push(t),r.has(d)||r.set(d,u),u.length!==l)return;{const h=ko(u).call(u,((p,R)=>p.index-R.index)).map((p=>p.payload)).join("");r.delete(d),(t=JSON.parse(h))._uid=i}}const{_type:a,token:c}=t;if(X(n=[Yt.ACK,Yt.CHECK]).call(n,a))return a===Yt.CHECK&&this.handleCheckToken(s,c),void this.receiveMessage(t);c==="".concat(s.token,"_").concat(this.token)?this.handleReceivedMessage(t):_.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(s.token,"_").concat(this.token),t)}check(){const t={_id:ut(6,""),token:this.token,_type:Yt.CHECK};b("SHOW_P2P_LOG")&&_.debug("send message",t),this.signal.request(Ee.DATA_STREAM,{payload:ro(this.encoder.encode(JSON.stringify(t)))})}ack(t){const n={_id:t,_type:Yt.ACK,token:this.token};b("SHOW_P2P_LOG")&&_.debug("send message",n),this.signal.request(Ee.DATA_STREAM,{payload:ro(this.encoder.encode(JSON.stringify(n)))})}response(t,n,i){this.send(Yt.RESPONSE,JSON.stringify({success:!i,message:n}),!0,t)}handleReceivedMessage(t){const n=()=>{this.userMap.forEach((d=>{const{receivedMessagesMap:l,nextExpectedSequenceNumber:u}=d;for(;l.has(u);){const h=l.get(u);l.delete(u),this.receiveMessage(h),d.nextExpectedSequenceNumber++}}))};if(!t)return void n();const{_uid:i,_seq:r}=t,s=this.userMap.get(i),{receivedMessagesMap:o,isStart:a,nextExpectedSequenceNumber:c}=s;if(r<c)return this.ack(t._id),void _.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(t._message));o.set(r,t),a&&r===c&&(this.receiveMessage(t),o.delete(c),s.nextExpectedSequenceNumber++,n())}receiveMessage(t){const{_id:n,_type:i,_message:r,_uid:s}=t;if(b("SHOW_P2P_LOG")&&_.debug("receive message",t),n){let o;switch(t._type!==Yt.ACK&&(r&&(o=JSON.parse(r)),this.ack(t._id)),t._type){case Yt.CANDIDATE:case Yt.CONTROL:this.signal.emit(i,o,s);break;case Yt.PUBLISH:case Yt.UNPUBLISH:case Yt.RESTART_ICE:case Yt.CALL:o.uid=s,en(this.signal,i,o).then((a=>{this.response(t._id,a)})).catch((()=>{this.response(t._id,void 0,!0)}));break;case Yt.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case Yt.RESPONSE:{const{success:a,message:c}=o;this.emit("res-@".concat(n),a?"success":"failed",c);break}}}}splitMessage(t){if(t.length<Ta.MAX_MESSAGE_SIZE)return[t];const n=[],{remoteToken:i}=JSON.parse(t),r=ut(6,"");let s=0,o=800;const a=Math.ceil(t.length/o);for(;t.length>0;){s++;const c={id:r,index:s,total:a,payload:t.slice(0,o),token:"".concat(this.token,"_").concat(i)};JSON.stringify(c).length>Ta.MAX_MESSAGE_SIZE?o-=50:(n.push(c),t=t.slice(o))}return n.map((c=>JSON.stringify(c)))}handleCheckToken(t,n){return t.token!==n?(_.debug("token changed, from ".concat(t.token," to ").concat(n)),this.reset(t.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{_.debug("token timeout, ".concat(n)),this.reset(t.uid)}),b("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const t=await en(this.signal,Yt.CALL,void 0),n=await this.send(Yt.CALL,t);this.signal.emit(fe.P2P_CONNECTION,n,!0)}async reset(t,n){const i=this.userMap.get(t);i&&(this.emit(Oc.ABORT),this.signal.emit(Ae.ON_USER_OFFLINE,{uid:i.uid,reason:hH.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(_.debug("change local token from ".concat(n," to ").concat(n)),this.token=ut(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Oc.ABORT)}}v(Ta,"MAX_SIZE",1),v(Ta,"MAX_MESSAGE_SIZE",1024);class Q8 extends kt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Ye.CONNECTED?this.emit(fe.WS_CONNECTED):t===Ye.RECONNECTING?this.emit(fe.WS_RECONNECTING,this._websocketReconnectReason):t===Ye.CLOSED&&this.emit(fe.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,n){super(),v(this,"__name__","P2PSignal"),v(this,"_disconnectedReason",void 0),v(this,"_websocketReconnectReason",void 0),v(this,"_connectionState",Ye.CLOSED),v(this,"reconnectToken",void 0),v(this,"p2pToken",void 0),v(this,"websocket",void 0),v(this,"openConnectionTime",void 0),v(this,"clientId",void 0),v(this,"lastMsgTime",Date.now()),v(this,"uploadCache",[]),v(this,"uploadCacheInterval",void 0),v(this,"rttRolling",new OE(5)),v(this,"pingpongTimer",void 0),v(this,"pingpongTimeoutCount",0),v(this,"joinResponse",void 0),v(this,"multiIpOption",void 0),v(this,"initError",void 0),v(this,"spec",void 0),v(this,"store",void 0),v(this,"_external_signal",void 0),v(this,"onWebsocketMessage",(i=>{if(i.data instanceof ArrayBuffer)return void this.emit(fe.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case Ae.ON_DATA_STREAM:return void this.handleDataStream(r._message);case Ae.MUTE_AUDIO:case Ae.MUTE_VIDEO:case Ae.ON_P2P_LOST:case Ae.ON_USER_ONLINE:return;case Ae.ON_USER_OFFLINE:const{uid:s}=r._message;return _.debug("[".concat(this.clientId,"] user-offline uid: ").concat(s)),void this._external_signal.reset(s)}if(this.emit(r._type,r._message),r._type===Ae.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Ae.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ke.UID_BANNED);break;case 15:this.close(Ke.IP_BANNED);break;case 16:this.close(Ke.CHANNEL_BANNED)}if(r._type===Ae.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case ye.ERR_LICENSE_MISSING:this.close(Ke.LICENSE_MISSING);break;case ye.ERR_LICENSE_EXPIRED:this.close(Ke.LICENSE_EXPIRED);break;case ye.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ke.LICENSE_MINUTES_EXCEEDED);break;case ye.ERR_LICENSE_PERIOD_INVALID:this.close(Ke.LICENSE_PERIOD_INVALID);break;case ye.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ke.LICENSE_MULTIPLE_SDK_SERVICE);break;case ye.ERR_LICENSE_ILLEGAL:this.close(Ke.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new Rg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,b("JOIN_GATEWAY_USE_DUAL_DOMAIN"),b("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===Ye.CONNECTED&&this.reconnect("retry",On.OFFLINE)})),this.p2pToken=ut(6,""),this._external_signal=new Ta(this,this.p2pToken)}async request(t,n,i,r){const s=ut(6,""),o={_id:s,_type:t,_message:n},a=this.websocket.connectionID,c=()=>new ie(((R,T)=>{if(this.connectionState===Ye.CONNECTED)return R();const y=()=>{this.off(fe.WS_CLOSED,I),R()},I=()=>{this.off(fe.WS_CONNECTED,y),T(new F(w.WS_ABORT))};this.once(fe.WS_CONNECTED,y),this.once(fe.WS_CLOSED,I)}));if(this.connectionState!==Ye.CONNECTING&&this.connectionState!==Ye.RECONNECTING||t===Ee.JOIN||t===Ee.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const d=new ie(((R,T)=>{let y=!1;const I=(N,k)=>{y=!0,R({isSuccess:N==="success",message:k||{}}),this.off(fe.WS_CLOSED,A),this.off(fe.WS_RECONNECTING,A),this.emit(fe.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(s),I);const A=()=>{T(new F(w.WS_ABORT,"type: ".concat(t))),this.off(fe.WS_CLOSED,A),this.off(fe.WS_RECONNECTING,A),this.off("res-@".concat(s),I)};this.once(fe.WS_CLOSED,A),this.once(fe.WS_RECONNECTING,A),hn(b("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||y||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(fe.REQUEST_TIMEOUT,t,n))}))}));let l=null;try{l=await d}catch(R){if(this.connectionState===Ye.CLOSED||t===Ee.LEAVE)throw new F(w.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?R.throw():t===Ee.JOIN||t===Ee.REJOIN?null:(await c(),await this.request(t,n))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),h=aa(u),p=new F(w.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message,desc:h.desc});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===ye.ERR_TOO_MANY_BROADCASTERS?((t===Ee.JOIN||t===Ee.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===ye.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",On.MULTI_IP)):this.reconnect(h.action,On.SERVER_ERROR),t===Ee.JOIN||t===Ee.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new ie((i=>{const r=s=>{(!n||n(s))&&(this.off(t,r),i(s))};this.on(t,r)}))}uploadWRTCStats(t){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(oa.WRTC_STATS,n)}upload(t,n){const i={_type:t,_message:n};try{this.websocket.sendMessage(i)}catch{const s=b("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==Ye.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)}),b("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,n){const i={_type:t,_message:n};this.websocket.sendMessage(i)}async sendExtensionMessage(t,n,i){return await this._external_signal.send(t,n,i)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ie(((n,i)=>{this.once(fe.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(fe.WS_CLOSED,(()=>i(this.initError||new F(w.WS_ABORT)))),this.connectionState=Ye.CONNECTING,this.websocket.init(t).catch(i)}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||Ke.LEAVE,this.connectionState=Ye.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=ut(6,""),this._external_signal.clear(),this._external_signal=new Ta(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(fe.ABORT_P2P_EXECUTION);const t=await en(this,fe.REQUEST_JOIN_INFO),n=await this.request(Ee.JOIN,t);if(!n)return this.emit(fe.REPORT_JOIN_GATEWAY,w.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(fe.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Ye.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}async downgradeCodec(t){return!1}handleDataStream(t){try{var n;const i=qo(t.payload),r=new TextDecoder().decode(i),s=JSON.parse(r);"total"in s&&"id"in s||X(n=Object.values(Yt)).call(n,s._type)?(s._uid=t.uid,this._external_signal.onMessage(s)):this.emit(Ae.ON_DATA_STREAM,t)}catch{this.emit(Ae.ON_DATA_STREAM,t)}}handleNotification(t){_.debug("[".concat(this.clientId,"] receive notification: "),t);const n=aa(t.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?t.code===ye.ERR_REPEAT_JOIN_CHANNEL&&b("IGNORE_UID_CHECK")?void this.close(Ke.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ke.UID_BANNED),void this.close()):void this.reconnect(n.action,On.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=b("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(_.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>b("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",On.TIMEOUT):this.request(Ee.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),b("REPORT_STATS")&&this.send(Ee.PING_BACK,{pingpongElapse:i})})).catch((i=>{}))}handleWebsocketEvents(){this.websocket.on(Le.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(fe.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(Le.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Le.CLOSED,(()=>{this.connectionState=Ye.CLOSED})),this.websocket.on(Le.FAILED,(()=>{this._disconnectedReason=Ke.NETWORK_ERROR,this.connectionState=Ye.CLOSED})),this.websocket.on(Le.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Ye.CONNECTED?this.connectionState=Ye.RECONNECTING:this.connectionState=Ye.CONNECTING})),this.websocket.on(Le.WILL_RECONNECT,((t,n,i)=>{t!=="retry"?(_.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0):_.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(t)})),this.websocket.on(Le.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((t=>{if(this.emit(fe.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof F&&t.code===w.UNEXPECTED_RESPONSE&&t.data.code===ye.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",On.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",On.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(Le.REQUEST_NEW_URLS,((t,n)=>{en(this,fe.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)})),this.websocket.on(Le.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}const Z8={name:"P2PChannel",create:function(e){let{store:t,statsCollector:n}=e;return new J8(t,n)},createSubmodule:function(e){let{store:t,spec:n}=e;return new Q8(n,t)}};function DL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function PL(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?DL(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):DL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class $8{constructor(t){v(this,"sessionDesc",void 0),v(this,"localCapabilities",void 0),v(this,"rtpCapabilities",void 0),v(this,"candidates",void 0),v(this,"_originCandidates",void 0),v(this,"iceParameters",void 0),v(this,"dtlsParameters",void 0),v(this,"setup",void 0),v(this,"currentMidIndex",void 0),v(this,"cname",void 0),t=wt(t);const{iceParameters:n,dtlsParameters:i,candidates:r,rtpCapabilities:s,setup:o,localCapabilities:a,sdkCodec:c,cname:d}=t,l=Jn(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=s,this.candidates=r,this._originCandidates=wt(r),this.iceParameters=n,this.dtlsParameters=i,this.setup=o,this.localCapabilities=a,this.cname=d;for(let u=0;u<l.mediaDescriptions.length;u++){const h=l.mediaDescriptions[u];if(h.attributes.iceUfrag=n.iceUfrag,h.attributes.icePwd=n.icePwd,h.attributes.fingerprints=i.fingerprints,h.attributes.candidates=r,h.attributes.setup=o,h.media.mediaType==="video"){h.media.fmts=s.videoCodecs.map((T=>T.payloadType.toString(10)));const p=s.videoCodecs.filter((T=>{var y,I;return(y=T.rtpMap)===null||y===void 0?void 0:X(I=y.encodingName.toLowerCase()).call(I,c)})),R=s.videoCodecs.filter((T=>!X(p).call(p,T)));h.attributes.payloads=[...p,...R],h.attributes.extmaps=s.videoExtensions}h.media.mediaType==="audio"&&(h.media.fmts=s.audioCodecs.map((p=>p.payloadType.toString(10))),h.attributes.payloads=s.audioCodecs,h.attributes.extmaps=s.audioExtensions),l.mediaDescriptions[u]=this.mungMediaDesc(h)}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return Ds(this.sessionDesc)}send(t,n,i){const{ssrcs:r,ssrcGroups:s}=el(n,this.cname),o=this.sessionDesc.mediaDescriptions.find((d=>t===ue.VIDEO?d.media.mediaType==="video":d.media.mediaType==="audio")),a=r[0].attributes.label,c=r[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(r),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:a,mslabel:c}}batchSend(t){return t.map((n=>{let{kind:i,ssrcMsg:r}=n;return this.send(i,r,void 0)}))}stopSending(t){this.sessionDesc.mediaDescriptions.forEach((n=>{const i=[],r=[],s=[];n.attributes.ssrcs.forEach((o=>{X(t).call(t,o.attributes.label||"")?s.push(o):i.push(o)})),n.attributes.ssrcGroups.forEach((o=>{var a;X(a=s.map((c=>c.ssrcId))).call(a,o.ssrcIds[0])||r.push(o)})),n.attributes.ssrcs=i,n.attributes.ssrcGroups=r}))}mute(t){const n=this.sessionDesc.mediaDescriptions.find((i=>i.attributes.mid===t));if(!n)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(t){const n=this.sessionDesc.mediaDescriptions.find((i=>i.attributes.mid===t));if(!n)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}receive(t,n,i){t.forEach(((r,s)=>{const o=r._mediaStreamTrack,a=this.sessionDesc.mediaDescriptions.findIndex((d=>d.attributes.mid===o.kind)),c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],r);this.sessionDesc.mediaDescriptions[a]=c}))}stopReceiving(t){}updateCandidates(t){const n=this._originCandidates.filter((r=>r.transport==="udp")),i=[];if(n.forEach((r=>{i.push(PL(PL({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))})),n.length!==0){switch(t){case Sn.TCP_RELAY:this.candidates=i;break;case Sn.UDP_TCP_RELAY:case Sn.RELAY:this.candidates=[...n,...i];break;default:this.candidates=n}for(const r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(t){t=wt(t),this.iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((n=>{n.attributes.iceUfrag=t.iceUfrag,n.attributes.icePwd=t.icePwd}))}predictReceivingMids(t){const n=[];for(let i=0;i<t;i++)n.push((this.currentMidIndex+i+1).toString(10));return n}mungRecvMediaDsec(t,n){const i=wt(t);return ca(i,n),Og(i,n),i}updateRecvMedia(t,n){const i=this.sessionDesc.mediaDescriptions.findIndex((r=>r.attributes.mid===t));if(i!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],n);this.sessionDesc.mediaDescriptions[i]=r}}bumpMid(t){this.currentMidIndex+=t}updateTrackLabel(t,n,i){const r=this.sessionDesc.mediaDescriptions.find((o=>t===ue.VIDEO?o.attributes.mid==="video":o.attributes.mid==="audio"));if(r){const o=r.attributes.ssrcs.find((a=>a.attributes.label===n));var s;o&&(o.attributes.label=i,(s=o.attributes.msid)===null||s===void 0||s.replace(n,i))}}mungMediaDesc(t){const n=wt(t);return Ag(n),(function(i){const r=i.attributes.extmaps.find((s=>Zh(s.extensionName)));r&&i.attributes.extmaps.splice(i.attributes.extmaps.indexOf(r),1),i.attributes.payloads.forEach((s=>{const o=s.rtcpFeedbacks.findIndex((a=>a.type==="transport-cc"));o!==-1&&s.rtcpFeedbacks.splice(o,1)}))})(n),n}getSSRC(t){for(const n of this.sessionDesc.mediaDescriptions)for(const i of n.attributes.ssrcs)if(i.attributes.label===t)return[i]}}var Rt;function LL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Mp(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?LL(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):LL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let eY=(Rt=class kl extends zh{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var n;return X(n=Object.keys(Qo)).call(n,t)})))]}constructor(t,n){super(t,n),v(this,"store",void 0),v(this,"peerConnection",void 0),v(this,"remoteSDP",void 0),v(this,"initialOffer",void 0),v(this,"statsFilter",void 0),v(this,"useRTX",!1),v(this,"localCapabilities",void 0),v(this,"localCandidateCount",0),v(this,"allCandidatesReceived",!1),v(this,"establishPromise",void 0),v(this,"mutex",void 0),this.store=n,this.mutex=new gn("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(kl.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=yh(this.peerConnection,b("STATS_UPDATE_INTERVAL"),void 0,It()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=ds(t.sdp),i=$d(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:b("FILTER_VIDEO_FEC"),filterAudioFec:b("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=t,Mp(Mp({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:t.sdp})}catch(t){throw new F(w.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async updateRemoteConnect(){}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new $8(Mp(Mp({},t),{},{rtpCapabilities:t.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async updateRemoteRTPCapabilities(t,n){throw new F(w.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(t){}send(t,n){var i=this;return ni((function*(){const r=yield Ve(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=t.map((h=>i.peerConnection.addTrack(h._mediaStreamTrack))),o=yield Ve(i.peerConnection.createOffer()),a=Jn(o.sdp),c=t.map((h=>{const p=h._mediaStreamTrack,R=a.mediaDescriptions.find((T=>T.attributes.mid===p.kind));if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return(function(T,y,I){const A=T.attributes.ssrcs.filter((k=>k.attributes.label===y)),N=T.attributes.ssrcGroups;if(A.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(N&&A.length>1){const k=N.find((x=>x.ssrcIds.indexOf(A[0].ssrcId)!==-1));return k?[{ssrcId:k.ssrcIds[0],rtx:I?k.ssrcIds[1]:void 0}]:[{ssrcId:A[0].ssrcId}]}return[{ssrcId:A[0].ssrcId}]})(R,p.id,i.useRTX)}));let d;try{d=yield c}catch(h){throw s.forEach((p=>{En()&&p.replaceTrack(null),i.peerConnection.removeTrack(p)})),h}const l=i.mungSendOfferSDP(o.sdp,t);i.remoteSDP.receive(t,n,d);const u=i.remoteSDP.toString();return yield Ve(i.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ve(i.applySendEncodings(s,t)),yield Ve(i.peerConnection.setRemoteDescription({type:"answer",sdp:u})),t.map(((h,p)=>{const R=h._mediaStreamTrack.id;return{localSSRC:c[p],id:R}}))}catch(s){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{r()}}))()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const n=this.peerConnection.getSenders().filter((s=>{var o;return t.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1}));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map((s=>{En()&&s.replaceTrack(null),this.peerConnection.removeTrack(s)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(t);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:s,mslabel:o}=this.remoteSDP.send(t,n,r),a=new ie(((l,u)=>{const h=setTimeout((()=>{u(new Error("Cannot receive track, id: ".concat(s)))}),1e4),p=R=>{const T=Ze();if((T.name==="Safari"&&Number(T.version)===11||Fn())&&R.track.id!==s&&R.streams[0].id===o){var y;const I=R.streams[0].getTracks()[0];return(y=this.remoteSDP)===null||y===void 0||y.updateTrackLabel(t,s,R.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(I)}if(R.track.id===s)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(R.track)};this.peerConnection.addEventListener("track",p)})),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:s}}catch(s){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter((i=>{var r;return t.indexOf(((r=i.track)===null||r===void 0?void 0:r.id)||"")!==-1}));if(n.length!==t.length)throw new Error("sender' length doesn't match mids' length.");n.map((i=>{if(En()&&i.track)i.track.enabled=!1;else{const r=i.getParameters();r.encodings.forEach((s=>s.active=!1)),i.setParameters(r)}}))}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter((s=>{var o;return t.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1}));if(n.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");n.map((async s=>{if(En()&&s.track)s.track.enabled=!0;else{const o=s.getParameters();o.encodings.forEach((a=>a.active=!0)),await s.setParameters(o)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return ni((function*(){const i=yield Ve(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=We().supportPCSetConfiguration;if(t===Sn.RELAY&&!r)return;if(r){const d=n.peerConnection.getConfiguration(),l=t===Sn.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,n.peerConnection.setConfiguration(d))}t!==Sn.RELAY&&n.remoteSDP.updateCandidates(t);const s=yield Ve(n.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=ds(s.sdp),{remoteIceParameters:a}=yield o.iceParameters;n.remoteSDP.restartICE(a);const c=n.remoteSDP.toString();yield Ve(n.peerConnection.setLocalDescription(s)),yield Ve(n.peerConnection.setRemoteDescription({type:"answer",sdp:c}))}catch(r){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}}))()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);const s=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new F(w.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getSenders().filter((r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===t}));i.length===1&&await this.applySendEncodings(i,[n])}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getSenders().find((r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===n}));i&&await i.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,n){throw new F(w.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new F(w.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),b("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Ho(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...kl.turnServerConfigToIceServers(t.turnServer.servers)),b("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...kl.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((i=>{i.forceturn&&(n.iceTransportPolicy="relay")})))),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}async updateRtpSenderEncodings(t,n){var i;if(n||(n=this.peerConnection.getSenders().find((d=>{var l;return((l=d.track)===null||l===void 0?void 0:l.id)===t._mediaStreamTrack.id}))),!n)return _.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!We().supportSetRtpSenderParameters)return _.warn("Browser not support set rtp-sender parameters");const r={},s={};if(t instanceof yt)switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(b("DSCP_TYPE")&&is()){var o;const d=b("DSCP_TYPE");X(o=["very-low","low","medium","high"]).call(o,d)&&(s.networkPriority=d)}const a=n.getParameters(),c=(i=a.encodings)===null||i===void 0?void 0:i[0];c&&Object.assign(c,s),Object.assign(a,r),_.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await n.setParameters(a)}async applySendEncodings(t,n){try{if(!We().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=n[i];r&&s&&await this.updateRtpSenderEncodings(s,r)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n){const i=Jn(t);return n.forEach(((r,s)=>{const o=r._mediaStreamTrack,a=i.mediaDescriptions.find((c=>c.attributes.mid===o.kind));a&&ca(a,r)})),Ds(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const n=this.remoteSDP.batchSend(t).map(((s,o)=>{let{id:a,mslabel:c}=s;const{kind:d}=t[o];return new ie(((l,u)=>{const h=setTimeout((()=>{u(new Error("Cannot receive track, id: ".concat(a)))}),1e4),p=R=>{const T=Ze();if(T.name==="Safari"&&Number(T.version)===11&&R.track.id!==a&&R.streams[0].id===c){var y;const I=R.streams[0].getTracks()[0];return(y=this.remoteSDP)===null||y===void 0||y.updateTrackLabel(d,a,R.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:I,id:a})}if(R.track.id===a)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:R.track,id:a})};this.peerConnection.addEventListener("track",p)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await ie.all(n)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n?.[0].ssrcId}setConfiguration(t){if(We().supportPCSetConfiguration){const n=kl.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}}},re(Rt.prototype,"connect",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"connect"),Rt.prototype),re(Rt.prototype,"stopSending",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"stopSending"),Rt.prototype),re(Rt.prototype,"receive",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"receive"),Rt.prototype),re(Rt.prototype,"stopReceiving",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"stopReceiving"),Rt.prototype),re(Rt.prototype,"muteRemote",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"muteRemote"),Rt.prototype),re(Rt.prototype,"unmuteRemote",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"unmuteRemote"),Rt.prototype),re(Rt.prototype,"muteLocal",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"muteLocal"),Rt.prototype),re(Rt.prototype,"unmuteLocal",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"unmuteLocal"),Rt.prototype),re(Rt.prototype,"close",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"close"),Rt.prototype),re(Rt.prototype,"updateEncoderConfig",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"updateEncoderConfig"),Rt.prototype),re(Rt.prototype,"updateSendParameters",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"updateSendParameters"),Rt.prototype),re(Rt.prototype,"replaceTrack",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"replaceTrack"),Rt.prototype),re(Rt.prototype,"getRemoteSSRC",[Qi],Object.getOwnPropertyDescriptor(Rt.prototype,"getRemoteSSRC"),Rt.prototype),Rt);function Qi(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("Locking from P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}const tY={name:"PlanBConnection",create:function(e){let{store:t,spec:n}=e;return new eY(n,t)}},nY={interceptLocalAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!We().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(kh.has(e)||!e.track)return;const n={track:e.track};if(Os()){if(!e.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(o){return void _.error("create audio-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){n.controller||(n.controller=a),e.track&&e.track.id!==n.track.id&&(_.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const c=t.metadata&&t.metadata();c?(function(d,l){const{chunk:u,controller:h}=l,p=so.METADATA;u.data=(function(R,T,y){const I=y.byteLength,A=I+og+IO,N=rg+sg+A,k=new ArrayBuffer(R.byteLength+N),x=new DataView(k);x.setUint8(0,bO),x.setUint16(1,A),x.setUint8(3,T),x.setUint16(4,I);for(let M=0;M<I;M++)x.setUint8(6+M,y[M]);const P=new Uint8Array(x.buffer);return P.set(new Uint8Array(R),N),P.buffer})(u.data,p,d),h.enqueue(u)})(c,{chunk:o,controller:a}):a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else if(En()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const r=Lh(),s=new MessageChannel;await new ie((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"audio-metadata-tx",port:s.port2},[s.port2]);e.transform=o,await new ie((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),s.port1.onmessage=a=>{var c;if(a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id)_.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i);else if(a.data.getMetadata){const d=t.metadata&&t.metadata();d&&s.port1.postMessage({metadata:d})}},n.worker=r}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}const r=kh.get(e);if(r){kh.delete(e);try{var s,o;(s=r.controller)===null||s===void 0||s.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(a){_.warning(a&&a.message)}}}kh.set(e,n),e.track.addEventListener("ended",i)},interceptRemoteAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!We().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(Fh.has(e))return;const n={track:e.track,onMetadata:t.onMetadata,onPts:t.onPts};if(Os()&&!Fn()){if(!e.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");fE(tt.CHROME,87,116)||(t.enableTopn=!1);let r=null;try{r=e.createEncodedStreams()}catch(o){return void _.error("create audio-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){n.controller||(n.controller=a),e.track&&e.track.id!==n.track.id&&(_.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i)),t.enableTopn?(function(c,d,l){var u;const h=ag(new DataView(d.data));if(!h)return l.enqueue(d);const p=c.track.id;L6.set(p,c.track);const R=(u=h.tlv.find((k=>k.tag===so.AUDIO_LEVEL)))===null||u===void 0?void 0:u.value;let T=0;typeof R=="number"&&(T=127-R);const y=Math.round(Math.pow(10,T/60)-1),{selected:I,speaker:A}=(function(k,x){let P=bc.get(k);if(P||(P=(function(M){const G=new AO;return bc.set(M,G),Lr||(Lr=new D6(b("TOPN_SILENCE_THRESHOLD")||500),Lr.on("ActiveSpeakerChanged",(Y=>{Y!=null&&(Uh=Y)}))),Lr.addSpeakers([G]),G})(k)),bc.size<=OO)return{selected:!0,speaker:P};if(!Lr)throw new Error("no active speaker detector");return Lr.levelChanged(P.id,x),ia=Lr.loudest.map((M=>M.id)),Uh&&!X(ia).call(ia,Uh)&&ia.length>=OO&&ia.pop(),{selected:X(ia).call(ia,P.id)||P.id===Uh,speaker:P}})(c,y),N=(function(k,x,P){const M=kr.get(k)||new P6(k,x);return M.score=P,kr.set(k,M),(function(G){if(Vh.set(G,!0),!jh)return void(jh=Date.now());const Y=Date.now();Y-jh>1e3&&(Vh.get(G)?Vh.set(G,!1):(NO(G),Vh.delete(G)),jh=Y)})(k),M})(p,c.track,A.energyScore);N.addSample(I),N.active&&(d.data=h.frame.buffer,l.enqueue(d))})(e,o,a):t.enableMetadata||t.enablePts?(function(c,d,l,u){const h=new DataView(c.data),p=h.getUint8(0);let R;if((128&p)!=0&&p!==71){const I=(function(A){if(A.byteLength<=0)return[];const N=[];let k=0;for(;k<A.byteLength;){const P=(128&A.getUint8(k))>>7,M=127&A.getUint8(k);if(!(P&&k+4<=A.byteLength)){k++;break}{const G=A.getUint32(k,!1),Y=(16776192&G)>>10,de=1023&G;N.push({pt:M,ts_offset:Y,length:de,data:new Uint8Array}),k+=4}}let x=A.byteLength-k;for(const P of N){if(P.length>x)return console.warn("Broken red payload"),[];P.length>0&&(P.data=new Uint8Array(A.buffer,A.byteOffset+k,P.length),k+=P.length,x-=P.length)}if(x>0){const P={pt:N.length>0?N[N.length-1].pt:0,ts_offset:0,length:x,data:new Uint8Array(A.buffer,A.byteOffset+k,x)};N.push(P)}return N})(h);if(I.length>0){const A=(function(N){let k=0;for(let M=0;M<N.length;M++)k+=M<N.length-1?4:1,k+=N[M].length;const x=new Uint8Array(k);let P=0;for(let M=0;M<N.length;M++)if(M<N.length-1){const G=(2147483648|(127&N[M].pt)<<24|(262143&N[M].ts_offset)<<10|1023&N[M].length)>>>0;x[P++]=G>>24&255,x[P++]=G>>16&255,x[P++]=G>>8&255,x[P++]=255&G}else x[P++]=127&N[M].pt;for(const M of N)x.set(M.data,P),P+=M.length;return x})(I.map((N=>{const k=new Uint8Array(N.length);k.set(N.data);const x=ag(new DataView(k.buffer));return x!=null&&x.frame&&(N.data=x?.frame),R=x,N})));c.data=A.buffer}}else R=ag(h),R&&(c.data=R.frame.buffer);if(d.enqueue(c),!R)return;const T=R.tlv.find((I=>I.tag===so.METADATA));T&&l&&T.value instanceof Uint8Array&&l(T.value);const y=R.tlv.find((I=>I.tag===so.AUDIO_64_BIT_PTS));y&&u&&y.value instanceof Uint8Array&&y.value.length==8&&u(new DataView(y.value.buffer).getBigUint64(0,!0))})(o,a,t.onMetadata,t.onPts):a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else{if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const r=Lh(),s=new MessageChannel;await new ie((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"audio-metadata-rx",port:s.port2},[s.port2]);e.transform=o,await new ie((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),s.port1.onmessage=a=>{var c;a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id?(_.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i)):a.data.metadata&&n.onMetadata?n.onMetadata(a.data.metadata):a.data.pts&&n.onPts&&n.onPts(a.data.pts)},n.worker=r}function i(){e.track.removeEventListener("ended",i),(function(r){const s=Fh.get(r);if(s){(function(c){const d=bc.get(c);d&&(bc.delete(c),Lr&&(Lr.removeSpeakers([d]),bc.size===0&&(Lr.destroy(),Lr=null)))})(r),NO(r.track.id),Fh.delete(r);try{var o,a;(o=s.controller)===null||o===void 0||o.terminate(),(a=s.worker)===null||a===void 0||a.terminate()}catch(c){_.warning(c&&c.message)}}})(e)}Fh.set(e,n),e.track.addEventListener("ended",i)},interceptLocalVideoFrame:async function(e,t){if(!We().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(Bh.has(e)||!e.track)return;const n={track:e.track};if(Os()){if(!e.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(a){return void _.error("create video-encoded-streams error",a&&a.message)}const s=[];t.on("sei-to-send",(a=>{s.push(a)}));const o=new TransformStream({transform(a,c){n.controller||(n.controller=c),e.track&&e.track.id!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const d=LO(new Uint8Array(a.data)),l=s.shift();if(l){const u=(function(h,p,R){switch(R){case ug:return(function(T,y){const I=PO(y),A=I.length,N=Math.floor(A/255),k=A%255,x=new Uint8Array(6+N+1+A+T.byteLength);x[0]=0,x[1]=0,x[2]=0,x[3]=1,x[4]=6,x[5]=101;let P=0;for(;P<N;)x[6+P]=255,P++;return x[6+P]=k,P++,x.set(I,6+P),x.set(new Uint8Array(T),6+P+A),x.buffer})(h,p);case hg:return(function(T,y){const I=PO(y),A=I.length,N=Math.floor(A/255),k=A%255,x=new Uint8Array(7+N+1+A+1+T.byteLength);x[0]=0,x[1]=0,x[2]=0,x[3]=1,x[4]=78,x[5]=1,x[6]=101;let P=0;for(;P<N;)x[7+P]=255,P++;return x[7+P]=k,P++,x.set(I,7+P),P+=A,x[7+P]=128,P++,x.set(new Uint8Array(T),7+P),x.buffer})(h,p);default:return null}})(a.data,l,d);u&&(a.data=u)}c.enqueue(a)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else{if(!En())return;{if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const r=Lh(),s=new MessageChannel;await new ie((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"sei-tx",port:s.port2},[s.port2]);e.transform=o,await new ie((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),t.on("sei-to-send",(a=>{s.port1.postMessage({sei:a})})),s.port1.onmessage=a=>{var c;a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i))},n.worker=r}}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}const r=Bh.get(e);if(r){Bh.delete(e);try{var s,o;(s=r.controller)===null||s===void 0||s.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(a){_.warning(a&&a.message)}}}Bh.set(e,n),e.track.addEventListener("ended",i)},interceptRemoteVideoFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!We().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(!e.track)return;if(Xd.has(e)){const r=Xd.get(e);return void(r&&(r.onSei=t.onSei))}const n={track:e.track,onSei:t.onSei};if(Os()){if(!e.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(o){return void _.error("create video-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){if(n.controller||(n.controller=a),!n.firstFrameInfo){var c;const l=o.getMetadata()||{};n.firstFrameInfo=bt({type:o.type,rtpTimestamp:o.timestamp,payloadType:l.payloadType||0,ssrc:l.synchronizationSource||0,length:o.data.byteLength},"mimeType"in l?{mimeType:l.mimeType}:{}),(c=t.onFirstFrame)===null||c===void 0||c.call(t,n.firstFrameInfo)}e.track&&e.track.id!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const d=(function(l,u){switch(u){case ug:return(function(h){const p=new DataView(h.data);let R=0;for(;R+4<h.data.byteLength;){if(p.getUint8(R+0)===0&&p.getUint8(R+1)===0&&p.getUint8(R+2)===0&&p.getUint8(R+3)===1&&p.getUint8(R+4)===6){let T=R+6,y=0,I=0;for(;(I=p.getUint8(T++))===255;)y+=255;y+=I;const A=DO(h.data,T,y);return new Uint8Array(A)}R++}return null})(l);case hg:return(function(h){const p=new DataView(h.data);let R=0;for(;R+5<h.data.byteLength;){if(p.getUint8(R+0)===0&&p.getUint8(R+1)===0&&p.getUint8(R+2)===0&&p.getUint8(R+3)===1&&p.getUint8(R+4)===78&&p.getUint8(R+5)===1&&p.getUint8(R+6)===101){let T=R+7,y=0,I=0;for(;(I=p.getUint8(T++))===255;)y+=255;y+=I;const A=DO(h.data,T,y);return new Uint8Array(A)}R++}return null})(l);default:return null}})(o,LO(new Uint8Array(o.data)));d&&n.onSei&&n.onSei(d),a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else if(En()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");const r=Lh(),s=new MessageChannel;await new ie((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"sei-rx",port:s.port2},[s.port2]);e.transform=o,await new ie((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),s.port1.onmessage=a=>{var c;if(a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id)_.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i);else if(a.data.sei&&n.onSei)n.onSei(a.data.sei);else if(a.data.firstFrameInfo&&t.onFirstFrame){var d;(d=t.onFirstFrame)===null||d===void 0||d.call(t,a.data.firstFrameInfo)}},n.worker=r}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}(function(r){const s=Xd.get(r);if(s){Xd.delete(r);try{var o,a;(o=s.controller)===null||o===void 0||o.terminate(),(a=s.worker)===null||a===void 0||a.terminate()}catch(c){_.warning(c&&c.message)}}})(e)}Xd.set(e,n),e.track.addEventListener("ended",i)}},iY={name:"InterceptFrame",create:()=>nY};var Xe;function kL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Gr(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?kL(Object(n),!0).forEach((function(i){v(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):kL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let rY=(Xe=class Qc extends zh{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var n;return X(n=Object.keys(Qo)).call(n,t)})))]}constructor(t,n,i){super(t,n),v(this,"id",ut(5,"connection-")),v(this,"store",void 0),v(this,"peerConnection",void 0),v(this,"forceTurn",!1),v(this,"remoteSDP",void 0),v(this,"initialOffer",void 0),v(this,"transportEventReceiver",void 0),v(this,"statsFilter",void 0),v(this,"extension",{useXR:b("USE_XR")}),v(this,"localCapabilities",void 0),v(this,"remoteCodecs",void 0),v(this,"localCandidateCount",0),v(this,"allCandidatesReceived",!1),v(this,"isPreallocation",!1),v(this,"preMediaMap",new Map),v(this,"dataStreamChannelMap",new Map),v(this,"establishPromise",void 0),v(this,"recoveredDataChannelIds",[]),v(this,"currentDataChannelId",1),v(this,"supportAV1RtpSpec",!1),v(this,"mutex",void 0),v(this,"qualityLimitationReason",pc.NONE),v(this,"isFirstConnected",!1),this.store=n,this.forceTurn=Xg(t),this.mutex=new gn("NVConnectionExtension-mutex",n.clientId),this.peerConnection=i,this.isFirstConnected=!1,this.statsFilter=yh(this.peerConnection,b("STATS_UPDATE_INTERVAL"),void 0,It()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void _.debug("[NVConnectionExtension] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else _.debug("[NVConnectionExtension] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=ds(n.sdp),r=await Dg({filterRTX:!b("USE_PUB_RTX")&&!b("USE_SUB_RTX"),filterVideoFec:b("FILTER_VIDEO_FEC"),filterAudioFec:b("FILTER_AUDIO_FEC"),filterVideoCodec:b("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:b("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:b("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=tl(r),this.initialOffer=n,b("ENABLE_SVC")&&this.store.codec=="av1"){const o=await aN();var t;o&&(this.supportAV1RtpSpec=!0,(t=r.send)===null||t===void 0||t.videoExtensions.push(o))}let s;return n.sdp&&ep(n.sdp)&&(s=wt(r),$O(s)),Gr(Gr({},i),{},{rtpCapabilities:s||r,offerSDP:n.sdp})}catch(n){throw new F(w.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnectionExtension without initial offer.");this.initialOffer.sdp&&ep(this.initialOffer.sdp)&&eN(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new PN(Gr(Gr({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!b("ENABLE_PRE_SUB_WITH_PRE_PC")||!b("PRE_USE_LOCAL_CODECS"))&&Yd(this.store),!0),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),i=Pg(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r?.(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const s=this.peerConnection.getTransceivers()[0];if(s!=null&&s.receiver&&this.tryBindTransportEvents(s.receiver),Yd(this.store))if(t.preallocation&&b("ENABLE_PRE_SUB_WITH_PRE_PC")){const o=b("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(o);await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{const{preSSRCs:o=[]}=t,a=o.map((d=>d.ssrcMsg[0].ssrcId));if(o.length===0)return;const{mids:c}=this.remoteSDP.batchSend(o.map((d=>Object.assign({},d))));await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[NVConnectionExtension.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.connect failed; ".concat(n.toString()))}}presetMedia(t,n){t.forEach(((i,r)=>{this.peerConnection.getTransceivers().forEach((s=>{if(s.mid!=null&&i===s.mid&&s.receiver.track){const o=s.receiver.track;let a;o.kind==="video"&&b("ENABLE_PRE_RENDER")&&(a=new Dh({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(ut(5,""))},!0),a.updateVideoTrack(o),a.onFirstVideoFrameRender=()=>{var c;const d=this.preMediaMap.get(n[r]);d&&(d.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,n[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,n[r])},a.play(this.store.sessionId||void 0)),this.preMediaMap.set(n[r],{mid:i,track:o,player:a,transceiver:s})}})),this.store.peerReceiver()}))}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateRemoteConnect before remote SDP created");let n=!1;const{rtpCapabilities:i}=t;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const o=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||o}const{preSSRCs:r=[]}=t,s=r.map((o=>o.ssrcMsg[0].ssrcId));if(!this.remoteSDP.checkPreloadSsrcs(s)){const o=[],a=[];if(Array.from(this.preMediaMap.entries()).every((c=>{let[d,{mid:l,player:u,track:h}]=c;return o.push(l),a.push(d),this.preMediaMap.delete(d),u&&u.destroy(),!0})),o.length>0&&(this.remoteSDP.stopSending(o),await pi(this.peerConnection,this.remoteSDP,this.extension),_.warn("[NVConnectionExtension.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),pe.reportApiInvoke(this.store.sessionId,{name:Nt.PRELOAD_MEDIA_FAILED,options:[r,a],tag:Tt.TRACER}).onSuccess()),r.length>0){const{mids:c}=this.remoteSDP.batchSend(r.map((d=>Object.assign({},d))));await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[NVConnectionExtension.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(c,s)}}n?(await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[NVConnectionExtension] updateRemoteConnect by exchanging SDP.")):_.debug("[NVConnectionExtension] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.updateRemoteConnect failed; ".concat(n.toString()))}}send(t,n,i){var r=this;return ni((function*(){const s=yield Ve(r.mutex.lock("From NVConnectionExtension.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVConnectionExtension.send before remote SDP created");const o=[],a=Zd();t.forEach((y=>{const I=r.peerConnection.addTransceiver(y._mediaStreamTrack,Gr({direction:"sendonly"},y.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));o.push(I),y._updateRtpTransceiver(I)})),It()&&b("SIMULCAST")===!0&&(yield Ve(r.applySimulcastForFirefox(o,t)));const c=yield Ve(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(t.length),l=r.mungSendOfferSDP(c.sdp,t,d),u=Jn(l),h=d.map((y=>{const I=u.mediaDescriptions.find((A=>A.attributes.mid===y));if(!I)throw new Error("Cannot extract ssrc from mediaDescription.");return wg(I,b("USE_PUB_RTX"))}));let p;try{p=yield h}catch(y){p=[],r.remoteSDP.receive(t,n,i,p);const I=r.remoteSDP.toString();throw yield Ve(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ve(r.peerConnection.setRemoteDescription({type:"answer",sdp:I})),yield Ve(r.stopSending(d,!0)),y}r.remoteSDP.receive(t,n,i,p);const R=r.remoteSDP.toString(),T=r.logSDPExchange(l,"offer","local","send");return yield Ve(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Ve(r.applySimulcastEncodings(o,t)),yield Ve(r.applySendEncodings(o,t)),T?.(R),yield Ve(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),o.map(((y,I)=>{const A=d[I];return{localSSRC:h[I],id:A,transceiver:y}}))}catch(o){throw o instanceof F?o:new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.send failed; ".concat(o.toString()))}finally{s()}}))()}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);if(i&&i.readyState==="open")_.debug("[NVConnectionExtension] Channels are already available and can be reused directly.");else{const s=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof s!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:b("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)}n.forEach((s=>{s._updateOriginDataChannel(i)}));const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),_.debug("[NVConnectionExtension] createDataChannels by exchanging SDP.")}else _.debug("[NVConnectionExtension] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof F?i:new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(t){try{const n=this.dataStreamChannelMap.get(t);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(t)}catch(n){throw n instanceof F?n:new F(w.DATACHANNEL_FAILED,"NVConnectionExtension.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(t,n){const i=n?void 0:await this.mutex.lock("From NVConnectionExtension.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter((c=>t.indexOf(c.mid)!==-1));if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVConnectionExtension.stopSending.");r.map((c=>{var d;Mc(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)}));const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,n,i,r);o&&(await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] receive ").concat(t," by exchanging SDP.")));const a=this.peerConnection.getTransceivers().find((c=>c.mid===s));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:s,transceiver:a}}catch(s){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(s.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(t);return i&&(await pi(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] batchReceive by exchanging SDP."))),n.map((r=>{const s=this.peerConnection.getTransceivers().find((o=>o.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}}))}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(n.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopReceiving before remote SDP created.");t.forEach((s=>{Array.from(this.preMediaMap.entries()).some((o=>{let[a,{mid:c,player:d}]=o;if(c===s)return this.preMediaMap.delete(a),d&&d.destroy(),!0}))})),this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((o=>{o.direction="inactive"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((async(o,a)=>{o.direction="sendonly"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new F(w.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return ni((function*(){const i=yield Ve(n.mutex.lock("From NVConnectionExtension.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=We().supportPCSetConfiguration,s=b("FORCE_TURN_TCP")||n.forceTurn;if(t===Sn.RELAY&&!r)return;if(r&&!s){const u=t===Sn.RELAY?"relay":"all",h=n.peerConnection.getConfiguration();h.iceTransportPolicy!==u&&(_.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(h.iceTransportPolicy,"] to [").concat(u,"]")),h.iceTransportPolicy=u,n.peerConnection.setConfiguration(h))}n.remoteSDP.updateCandidates(t);const o=yield Ve(n.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=ds(o.sdp),{remoteIceParameters:c}=yield a.iceParameters;n.remoteSDP.restartICE(c);const d=n.remoteSDP.toString(),l=n.logSDPExchange(o.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield Ve(n.peerConnection.setLocalDescription(o)),l?.(d),yield Ve(n.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){_.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}}))()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From NVConnectionExtension.extendCandidate");try{this.remoteSDP.updateCandidates(Sn.TCP_RELAY),await pi(this.peerConnection,this.remoteSDP,this.extension)}catch(n){_.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach((n=>{Mc(this.id+n.mid,this)})),this.preMediaMap.forEach((n=>{let{player:i}=n;i&&i.destroy()})),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Gr(Gr({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new F(w.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getTransceivers().filter((r=>r.mid===t));i.length===1&&(this.isVP8Simulcast(n)?It()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getTransceivers().find((r=>r.mid===n));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:Gr(Gr({},lr),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Gr(Gr({},lr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var n;const i="code: ".concat(t.errorCode,", message: ").concat(t.errorText),r=t.port?"local: ".concat(t.port):"",s=cs(t.url||"");_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: NVConnectionExtension.onICECandidateError(").concat(i,"), url: ").concat(s||"",", host_candidate:").concat(r)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),b("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]},i=t.cloudProxyServer||"disabled";return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&(Ho(t.turnServer.servers)?n.iceServers=t.turnServer.servers:b("NEW_TURN_MODE")&&n.iceServers&&i==="disabled"?(b("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&n.iceServers.push(...Qc.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):n.iceServers.push(...Qc.newTurnServerConfigToIceServers(t.turnServer.servers)),b("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...Qc.turnServerConfigToIceServers(t.turnServer.servers)),b("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...Qc.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),b("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((r=>{r.forceturn&&(n.iceTransportPolicy="relay")})))),b("ENABLE_ENCODED_TRANSFORM")&&We().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(fr(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!b("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}static newTurnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{const r=b("NEW_TURN_MODE");r===1?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(fr(i.turnServerURL),":443?transport=tcp")}):r===4&&(n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(fr(i.turnServerURL),":443?transport=tcp")}))})),n}tryBindTransportEvents(t){const n=t.transport;if(n){this.transportEventReceiver=t,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in r?r.error:r)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const r=n?.iceTransport.state;var s;r&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:s}=i.getSelectedCandidatePair()||{};if(r&&s){const o=r.address+":"+r.port,a=s.address+":"+s.port;_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(cs(o)),", remote ").concat(JSON.stringify(cs(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i,r;if(n||(n=this.peerConnection.getSenders().find((y=>y.track===t._mediaStreamTrack))),!n)return _.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!We().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const a=QO(this.peerConnection,t._mediaStreamTrack),c=FA(t);if(VN(t)&&a&&n&&c&&this.getLocalVideoStats&&X(i=["vp8","vp9"]).call(i,this.store.codec)){var d;const T=s.degradationPreference||(X(d=t._hints).call(d,ct.CUSTOM_TRACK)?b("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");jN(this.id+a.mid,c,this,T,(y=>{n&&this.updateAdaptation(n,y)}),this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var l;const{bitrateMax:T,frameRate:y,scaleResolutionDownBy:I}=t._encoderConfig;T&&(o.maxBitrate=1e3*T),(X(l=t._hints).call(l,ct.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(y&&(o.maxFramerate=ai(y)),I&&I>=1&&(o.scaleResolutionDownBy=I))}const{maxFramerate:u}=b("ENCODER_CONFIG_LIMIT");if(u&&typeof u=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,u):u),b("DSCP_TYPE")&&is()){var h;const T=b("DSCP_TYPE");X(h=["very-low","low","medium","high"]).call(h,T)&&(o.networkPriority=T)}const p=n.getParameters(),R=(r=p.encodings)===null||r===void 0?void 0:r[0];It()&&!R&&(s.encodings=[o]),R&&Object.assign(R,o),Object.assign(p,s),_.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(p.encodings))),await n.setParameters(p),await lN(this.store.codec,n,b("SVC_MODE"))}async updateAdaptation(t,n){var i,r;if(!t)return _.debug("[updateAdaptation] no rtpSender found");if(!We().supportSetRtpSenderParameters)return _.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:o,frameRate:a,scaleResolutionDownBy:c}=n;o&&(s.maxBitrate=1e3*o),a&&(s.maxFramerate=ai(a)),c&&c>=1&&X(i=["vp8","vp9"]).call(i,this.store.codec)&&(s.scaleResolutionDownBy=c);const d=t.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,s),Object.assign(d,{});try{await t.setParameters(d),_.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(u){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?_.debug("[updateAdaptation] peerConnection not connected}"):_.debug("[updateAdaptation] updateRtpSenderEncodings failed",u):_.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,n){try{if(!We().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=n[i];s instanceof yt&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,i){const r=Jn(t);return n.forEach(((s,o)=>{const a=i[o],c=r.mediaDescriptions.find((d=>d.attributes.mid===a));c&&(ca(c,s),Ng(c,s,this.store.codec))})),Ds(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let c=0;c<t.length;c++){var i,r,s,o,a;const d=t[c],l=n[c];if(l instanceof yt&&!X(i=l._hints).call(i,ct.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=l._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=l._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];const p=d.sender.getParameters();await d.sender.setParameters(Object.assign(p,u))}}}async applySimulcastEncodings(t,n){if(!It()&&t.length===n.length)for(let i=0;i<t.length;i++){const r=n[i];if(r instanceof yt&&this.isVP8Simulcast(r)){const s=t[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var n,i,r,s,o;return!!(t instanceof yt&&b("SIMULCAST")&&this.store.codec==="vp8"&&!X(n=t._hints).call(n,ct.LOW_STREAM)&&(i=t._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,r){if(b("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during NVConnectionExtension.").concat(r,`
`),t),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(t){if(We().supportPCSetConfiguration){const n=Qc.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}t.isPreallocation&&(this.isPreallocation=!0)}},re(Xe.prototype,"updateRemoteRTPCapabilities",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"updateRemoteRTPCapabilities"),Xe.prototype),re(Xe.prototype,"connect",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"connect"),Xe.prototype),re(Xe.prototype,"updateRemoteConnect",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"updateRemoteConnect"),Xe.prototype),re(Xe.prototype,"createDataChannels",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"createDataChannels"),Xe.prototype),re(Xe.prototype,"receive",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"receive"),Xe.prototype),re(Xe.prototype,"batchReceive",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"batchReceive"),Xe.prototype),re(Xe.prototype,"stopReceiving",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"stopReceiving"),Xe.prototype),re(Xe.prototype,"muteRemote",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"muteRemote"),Xe.prototype),re(Xe.prototype,"unmuteRemote",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"unmuteRemote"),Xe.prototype),re(Xe.prototype,"muteLocal",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"muteLocal"),Xe.prototype),re(Xe.prototype,"unmuteLocal",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"unmuteLocal"),Xe.prototype),re(Xe.prototype,"close",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"close"),Xe.prototype),re(Xe.prototype,"updateEncoderConfig",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"updateEncoderConfig"),Xe.prototype),re(Xe.prototype,"updateSendParameters",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"updateSendParameters"),Xe.prototype),re(Xe.prototype,"replaceTrack",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"replaceTrack"),Xe.prototype),re(Xe.prototype,"updateAdaptation",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"updateAdaptation"),Xe.prototype),re(Xe.prototype,"getRemoteSSRC",[li],Object.getOwnPropertyDescriptor(Xe.prototype,"getRemoteSSRC"),Xe.prototype),Xe);function li(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From NVConnectionExtension.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}var ft;function xL(e){var t,n,i,r=2;for(typeof Symbol<"u"&&(n=rh,i=Symbol.iterator);r--;){if(n&&(t=e[n])!=null)return t.call(e);if(i&&(t=e[i])!=null)return new Up(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function Up(e){function t(n){if(Object(n)!==n)return ie.reject(new TypeError(n+" is not an object."));var i=n.done;return ie.resolve(n.value).then((function(r){return{value:r,done:i}}))}return Up=function(n){this.s=n,this.n=n.next},Up.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?ie.resolve({value:n,done:!0}):t(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?ie.reject(n):t(i.apply(this.s,arguments))}},new Up(e)}let sY=(ft=class em extends zh{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,n){super(t,n),v(this,"name","DataChannelConnection"),v(this,"store",void 0),v(this,"peerConnection",void 0),v(this,"cname",void 0),v(this,"mutex",new gn("DataChannelConnection-mutex")),v(this,"dataChannel",void 0),v(this,"_p2pConnection",void 0),v(this,"establishPromise",void 0),v(this,"_nvMedia",void 0),this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(em.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new rY(t,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}getPreMedia(t){var n;return(n=this._p2pConnection)===null||n===void 0?void 0:n.getPreMedia(t)}isPreSub(){var t,n;return(t=(n=this._p2pConnection)===null||n===void 0?void 0:n.isPreSub())!==null&&t!==void 0&&t}async establish(){return await this._p2pConnection.establish()}getP2PConnectionParams(){return this._p2pConnection.establishPromise}updateRtpSenderEncodings(t){return this._p2pConnection.updateRtpSenderEncodings(t)}async connect(t){return this.cname=t.cname,await this._p2pConnection.connect(t),await new ie(((n,i)=>{const r=setTimeout((()=>{this.closeSignal(),i(new V(w.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(t.candidates))))}),b("DC_CONNECTION_TIMEOUT"));this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(r),void n()},this.dataChannel.onerror=s=>{this.closeSignal(),i(s)},this.dataChannel.addEventListener("close",(()=>{i(new V(w.DATACHANNEL_CONNECTION_TIMEOUT))}))})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,n){return this._p2pConnection.updateRemoteRTPCapabilities(t,n)}send(t,n,i){var r=this;return ni((function*(){const s=yield Ve(r.mutex.lock("From DataChannelConnection.send"));try{return yield*ac(xL(r._p2pConnection.send(t,n,i)))}finally{s()}}))()}async stopSending(t,n){return this._p2pConnection.stopSending(t,n)}async createDataChannels(t,n){return this._p2pConnection.createDataChannels(t,n)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,n,i,r){return this._nvMedia?(_.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,n,this.cname)):(_.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,n,i,r))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var n=this;return ni((function*(){return yield*ac(xL(n._p2pConnection.restartICE(t)))}))()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var n;return(n=this._nvMedia)===null||n===void 0||n.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,n){return await this._p2pConnection.updateEncoderConfig(t,n)}async updateSendParameters(t,n){return await this._p2pConnection.updateSendParameters(t,n)}setStatsRemoteVideoIsReady(t,n){this._p2pConnection.setStatsRemoteVideoIsReady(t,n)}async replaceTrack(t,n){return await this._p2pConnection.replaceTrack(t,n)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,n,i,r){if(b("SDP_LOGGING"))return _.upload("exchanging ".concat(i," ").concat(n," SDP during DataChannelConnection.").concat(r,`
`),t),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(t){const n={iceServers:[]};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Ho(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...em.turnServerConfigToIceServers(t.turnServer.servers)),b("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...em.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),b("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((i=>{i.forceturn&&(n.iceTransportPolicy="relay")})))),b("ENABLE_ENCODED_TRANSFORM")&&We().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(fr(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!b("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var n;return(n=this.onICEConnectionStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var n;return(n=this.onConnectionStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var n;return(n=this.onDTLSTransportStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var n;return(n=this.onDTLSTransportError)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var n;return(n=this.onICETransportStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var n;return(n=this.onFirstAudioReceived)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var n;return(n=this.onFirstVideoReceived)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var n;return(n=this.onFirstAudioDecoded)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoRender=t=>{var n;return(n=this.onFirstVideoRender)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoBufferReady=t=>{var n;return(n=this.onFirstVideoBufferReady)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,n,i)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,t,n,i)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var n;return(n=this.onFirstVideoDecodedTimeout)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,n)=>{var i;return(i=this.onSelectedLocalCandidateChanged)===null||i===void 0?void 0:i.call(this,t,n)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,n)=>{var i;return(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0?void 0:i.call(this,t,n)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}},re(ft.prototype,"connect",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"connect"),ft.prototype),re(ft.prototype,"updateRemoteRTPCapabilities",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"updateRemoteRTPCapabilities"),ft.prototype),re(ft.prototype,"createDataChannels",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"createDataChannels"),ft.prototype),re(ft.prototype,"receive",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"receive"),ft.prototype),re(ft.prototype,"stopReceiving",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"stopReceiving"),ft.prototype),re(ft.prototype,"muteRemote",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"muteRemote"),ft.prototype),re(ft.prototype,"unmuteRemote",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"unmuteRemote"),ft.prototype),re(ft.prototype,"muteLocal",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"muteLocal"),ft.prototype),re(ft.prototype,"unmuteLocal",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"unmuteLocal"),ft.prototype),re(ft.prototype,"close",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"close"),ft.prototype),re(ft.prototype,"updateEncoderConfig",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"updateEncoderConfig"),ft.prototype),re(ft.prototype,"updateSendParameters",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"updateSendParameters"),ft.prototype),re(ft.prototype,"replaceTrack",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"replaceTrack"),ft.prototype),re(ft.prototype,"getRemoteSSRC",[ji],Object.getOwnPropertyDescriptor(ft.prototype,"getRemoteSSRC"),ft.prototype),ft);function ji(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From DataChannelConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}function ML(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}class oY extends kt{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var n;X(n=["tryNext","recover"]).call(n,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(an.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(an.CONNECTED):this._state==="closed"?this.emit(an.CLOSED):this._state==="failed"&&this.emit(an.FAILED))}constructor(t,n,i,r){super(),v(this,"connectionID",0),v(this,"currentURLIndex",0),v(this,"reconnectReason",void 0),v(this,"_reconnectMode","tryNext"),v(this,"_initMutex",void 0),v(this,"_name",void 0),v(this,"_state","closed"),v(this,"_reconnectInterrupter",void 0),v(this,"_url",void 0),v(this,"_retryConfig",void 0),v(this,"_reconnectCount",0),v(this,"_forceCloseTimeout",5e3),v(this,"_onlineReconnectListener",void 0),v(this,"_closeEstablishingTransmitter",(()=>{})),v(this,"_store",void 0),v(this,"_joinChannelServiceRecordIndex",void 0),v(this,"_transmitter",void 0),v(this,"_useCompress",void 0),v(this,"_inflateLength",0),v(this,"_deflateLength",0),this._store=r,this._name=t,this._retryConfig=(function(s){for(var o=1;o<arguments.length;o++){var a=arguments[o]!=null?arguments[o]:{};o%2?ML(Object(a),!0).forEach((function(c){v(s,c,a[c])})):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(a)):ML(Object(a)).forEach((function(c){Object.defineProperty(s,c,Object.getOwnPropertyDescriptor(a,c))}))}return s})({},n),this._useCompress=i}resetReconnectCount(t){_.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const i=this._transmitter;n?setTimeout((()=>i.close()),500):i.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,n){if(!this._transmitter)return void _.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;t!==void 0&&(this.reconnectMode=t),_.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((i=this._store)===null||i===void 0||i.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));const r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:n})}getInflateData(){const t=this._inflateLength,n=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:n}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let Hr=(function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e})({});class aY{constructor(t,n,i){v(this,"version",1),v(this,"initialRTO",void 0),v(this,"maxBatchAckCount",void 0),v(this,"maxRTO",void 0),v(this,"initialRTT",void 0),v(this,"ID",void 0),v(this,"rtt",void 0),v(this,"packetNumber",1),v(this,"rtoRatioMap",new Map),v(this,"timeoutMap",new Map),v(this,"unorderedPacketQueue",[]),v(this,"batchAckPacketQueue",[]),v(this,"lastOrderedPacketNumber",0),v(this,"batchAckTimer",void 0),v(this,"sendImpl",void 0),v(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=n,this.ID=ut(7,"transmitter-"),this.initialRTO=i?.initialRTO!==void 0?i.initialRTO:b("TRANSMITTER_INITIAL_RTO"),this.initialRTT=i?.initialRTT!==void 0?i.initialRTT:b("TRANSMITTER_INITIAL_RTT"),this.rtt=i?.initialRTT!==void 0?i.initialRTT:b("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=i?.maxBatchAckCount!==void 0?i.maxBatchAckCount:b("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=i?.maxRTO!==void 0?i.maxRTO:b("TRANSMITTER_MAX_RTO")}packetize(t,n){return{type:Hr.Default,version:this.version,packetNumber:n,payload:t}}serialize(t){switch(t.type){case Hr.Default:{let n;typeof t.payload=="string"?n=new TextEncoder().encode(t.payload):n=t.payload;const i=new ArrayBuffer(n.length+15),r=new DataView(i);return r.setUint16(0,t.version),r.setUint8(2,t.type),r.setUint32(3,t.packetNumber),xw(r,7,BigInt(t.sendTs)),new Uint8Array(r.buffer).set(n,15),i}case Hr.Ack:{const n=new ArrayBuffer(16),i=new DataView(n);return i.setUint16(0,t.version),i.setUint8(2,t.type),i.setUint32(3,t.maxAckPacketNumber),i.setUint8(7,t.shift),xw(i,8,BigInt(t.ackSendTs)),n}}}deserialize(t){const n=new DataView(t),i=n.getUint16(0),r=n.getUint8(2);switch(r){case Hr.Default:{const s=n.getUint32(3),o=kw(n,7),a=t.slice(15),c=new Uint8Array(a);return{version:i,type:r,packetNumber:s,sendTs:Number(o),payload:c}}case Hr.Ack:{const s=n.getUint32(3),o=n.getUint8(7),a=kw(n,8);return{version:i,type:r,maxAckPacketNumber:s,shift:o,ackSendTs:Number(a)}}default:throw _.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(t){b("DC_DEBUG_LOG")&&typeof t=="string"&&_.debug("[".concat(this.ID,"] sending message packet"),JSON.parse(t));const n=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const i=this.calculateRTO(n),r=window.setTimeout((()=>{this.resendMessage(n)}),i);this.timeoutMap.set(n.packetNumber,r),this.sendPacket(n)}onData(t){const n=this.deserialize(t);n.type===Hr.Default?this.ack(n):n.type===Hr.Ack&&(this.updateRTT(n,Math.round(performance.now())),this.clearRTO(n))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((t=>{let[n,i]=t;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const n=this.calculateRTO(t),i=window.setTimeout((()=>{b("DC_DEBUG_LOG")&&typeof t.payload=="string"&&_.debug("[".concat(this.ID,"] resending message packet"),JSON.parse(t.payload),"timeout: ".concat(n)),this.resendMessage(t)}),n);this.timeoutMap.set(t.packetNumber,i),this.sendPacket(t)}calculateRTO(t){const n=this.rtoRatioMap.get(t.packetNumber);if(n===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*n;return this.rtoRatioMap.set(t.packetNumber,n+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(t,n){const i=t.ackSendTs;this.rtt=this.rtt*(7/8)+(n-i-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const n=this.unorderedPacketQueue[0];if(!n){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(n.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Hr.Ack,version:this.version};b("DC_DEBUG_LOG")&&_.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(n)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Hr.Ack,version:this.version};b("DC_DEBUG_LOG")&&_.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(n)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Hr.Ack,version:this.version};b("DC_DEBUG_LOG")&&_.debug("[".concat(this.ID,"] sending batch ack packet"),t,"shift: ".concat(this.batchAckPacketQueue.length-1)),this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===Hr.Default&&(t.sendTs=Math.round(performance.now()));const n=this.serialize(t);this.sendImpl(n)}clearRTO(t){for(let n=t.maxAckPacketNumber-t.shift;n<=t.maxAckPacketNumber;n++){const i=this.timeoutMap.get(n);i!==void 0&&window.clearTimeout(i),this.timeoutMap.delete(n),this.rtoRatioMap.delete(n)}}}class UL extends oY{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),v(this,"_initMutex",void 0),v(this,"_reconnectInterrupter",void 0),v(this,"_url",void 0),v(this,"_transmitter",void 0),v(this,"_addresses",void 0),v(this,"_reliableTransmission",void 0),v(this,"_textEncoder",void 0),v(this,"_textDecoder",void 0),this._textEncoder=new TextEncoder,this._textDecoder=new TextDecoder,this._initMutex=new gn("datachannel");const{timeout:i,timeoutFactor:r}=n,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*r)/10);Xn.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),jt.on(Ko.NETWORK_STATE_CHANGE,((a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===Xn.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=r))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=n;const i=(r,s)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex((a=>a.fingerprint||b("FINGERPRINT")));const o=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(o).then(r).catch(s),this.once(an.CLOSED,(()=>s(new V(w.WS_DISCONNECT)))),this.once(an.CONNECTED,(()=>r()))};return this._initMutex.lock().then((r=>new ie(((s,o)=>{i(s,o)})).then((()=>{r()})).catch((()=>{r()}))))}async sendMessage(t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new V(w.WS_ABORT,"datachannel is not ready");try{n||(t=JSON.stringify(t));const i=this._textEncoder.encode(t),r=S8(i,{raw:!0});this._reliableTransmission.sendMessage(r)}catch(i){throw new V(w.WS_ERR,"send datachannel signal message error"+i.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const n=JSON.stringify(t);return{compressed:n,compressedLength:n.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new ie(((n,i)=>{var r;const s=()=>{_.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="recover",this.state="connected",this.resetReconnectCount("opened"),n()},o=async l=>{var u;if((u=this._closeEstablishingTransmitter)===null||u===void 0||u.call(this),_.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");const h=vi(this,an.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,p=await this.reconnectWithAction(h);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!p)return i(new V(w.WS_DISCONNECT,"datachannel reconnect failed: ".concat(l.code))),void this.close(!0);n()}else i(new V(w.WS_DISCONNECT,"datachannel close: ".concat(l.code))),this.close()},a=async l=>{try{var u;(u=this._reliableTransmission)===null||u===void 0||u.onData(l.data)}catch(h){console.log(h)}};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),_.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();en(this,an.TO_CONNECT_DATACHANNEL).then((l=>{var u,h;if(!l)throw new Error("transmissonInfo not exist yet");const{transmitter:p,close:R}=l;this._transmitter=p,(u=this._store)===null||u===void 0||u.signalChannelOpen();const T=Date.now()-d;_.debug("[choose dc] dc open cost ".concat(T,"ms")),this._reliableTransmission=new aY((y=>{var I;this._transmitter&&this._transmitter.readyState==="open"&&((I=this._transmitter)===null||I===void 0||I.send(y))}),(y=>{if(typeof y=="string")this.emit(an.ON_MESSAGE,y);else{const I=y8(y,{raw:!0}).buffer,A=this._textDecoder.decode(I);this.emit(an.ON_MESSAGE,A)}})),this._closeEstablishingTransmitter=()=>{var y;(y=this._reliableTransmission)===null||y===void 0||y.close(),this._reliableTransmission=void 0,R()},s&&s(),p.onclose=o,p.onmessage=a,(h=this._store)===null||h===void 0||h.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c})).catch((l=>{var u;if((u=this._store)===null||u===void 0||u.recordJoinChannelService({endTs:Date.now(),status:l instanceof V&&l.code===w.WS_ABORT?"aborted":"error",errors:[l]},c),this.state!=="closed"){if(l instanceof V&&l.code===w.WS_ERR){const h=new V(w.WS_ERR,"init datachannel failed! Error: ".concat(l.toString()));return _.error("[".concat(this._name,"]").concat(h)),void i(h)}o&&o(l)}else i(new V(w.WS_DISCONNECT,"datachannel is closed: ".concat(l.toString())))}))}))}async reconnectWithAction(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||jt.networkState!==Xn.OFFLINE||(this._onlineReconnectListener=jt.onlineWaiter&&jt.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},n){const a=Eh(this._reconnectCount,this._retryConfig);_.debug("[".concat(this._name,"] wait ").concat(a,"ms to reconnect datachannel, mode: ").concat(t)),await ie.race([hn(a),this._onlineReconnectListener||new ie((()=>{}))])}if(this.state==="closed"||!i)return!1;this._reconnectCount+=1;const r=async(a,c)=>{this.emit(an.RECONNECT_CREATE_CONNECTION,c),await this.createTransmitterConnection(a)};try{if(t==="retry"){const a=this._addresses[this.currentURLIndex];await r(a,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let c=this.currentURLIndex;c<this._addresses.length;c++){if(this._addresses[c].fingerprint||b("FINGERPRINT")){this.currentURLIndex=c;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return _.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);_.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const a=this._addresses[this.currentURLIndex];await r(a,t)}else t==="recover"&&(_.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(an.FAILBACK));return!0}catch(a){var s,o;return _.error("[".concat(this._name,"] reconnect failed"),a.toString()),a!=null&&(s=a.data)!==null&&s!==void 0&&s.desc&&Array.isArray(a.data.desc)&&a.data.desc.length&&X(o=a.data.desc).call(o,"dynamic key expired")?(this.emit(an.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,n)}}}class cY extends kt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Ye.CONNECTED?this.emit(fe.WS_CONNECTED):t===Ye.RECONNECTING?this.emit(fe.WS_RECONNECTING,this._websocketReconnectReason):t===Ye.CLOSED&&this.emit(fe.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}processPendingNotifications(){this.pendingNotifications.length!==0&&(_.debug("[".concat(this.clientId,"] processing ").concat(this.pendingNotifications.length," pending notifications")),this.pendingNotifications.forEach((t=>{let{type:n,message:i}=t;this.emit(n,i),n===Ae.ON_NOTIFICATION&&this.handleNotification(i),n===Ae.ON_USER_BANNED&&this.handleUserBanned(i)})),this.pendingNotifications=[])}handleUserBanned(t){switch(t.error_code){case 14:this.close(Ke.UID_BANNED);break;case 15:this.close(Ke.IP_BANNED);break;case 16:this.close(Ke.CHANNEL_BANNED)}}constructor(t,n){super(),v(this,"__name__","DataChannelSignal"),v(this,"_disconnectedReason",void 0),v(this,"_websocketReconnectReason",void 0),v(this,"_connectionState",Ye.CLOSED),v(this,"reconnectToken",void 0),v(this,"websocket",void 0),v(this,"openConnectionTime",void 0),v(this,"clientId",void 0),v(this,"lastMsgTime",Date.now()),v(this,"uploadCache",[]),v(this,"uploadCacheInterval",void 0),v(this,"rttRolling",new OE(5)),v(this,"pingpongTimer",void 0),v(this,"inflateDataTimer",void 0),v(this,"pingpongTimeoutCount",0),v(this,"ortc",void 0),v(this,"joinResponse",void 0),v(this,"multiIpOption",void 0),v(this,"initError",void 0),v(this,"spec",void 0),v(this,"store",void 0),v(this,"isJoining",!1),v(this,"pendingNotifications",[]),v(this,"onWebsocketMessage",(i=>{if(i instanceof ArrayBuffer)return void this.emit(fe.ON_BINARY_DATA,i);const r=JSON.parse(i);if(b("DC_DEBUG_LOG")&&_.debug("[datachannel-signal] received packet",r),this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else Object.prototype.hasOwnProperty.call(r,"_type")&&(this.isJoining?r._type===Ae.ON_NOTIFICATION||r._type===Ae.ON_USER_BANNED?(this.emit(r._type,r._message),r._type===Ae.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Ae.ON_USER_BANNED&&this.handleUserBanned(r._message)):(this.pendingNotifications.push({type:r._type,message:r._message}),_.debug("[".concat(this.clientId,"] cached notification during join: ").concat(r._type))):(this.emit(r._type,r._message),r._type===Ae.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Ae.ON_USER_BANNED&&this.handleUserBanned(r._message)))})),this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new UL("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===Ye.CONNECTED&&this.reconnect("retry",ao.OFFLINE)}))}async request(t,n,i,r){const s=ut(6,""),o={_id:s,_type:t,_message:n},a=this.websocket.connectionID,c=()=>new ie(((R,T)=>{if(this.connectionState===Ye.CONNECTED)return R();const y=()=>{this.off(fe.WS_CLOSED,I),R()},I=()=>{this.off(fe.WS_CONNECTED,y),T(new V(w.WS_ABORT))};this.once(fe.WS_CONNECTED,y),this.once(fe.WS_CLOSED,I),t!==Ee.PUBLISH&&t!==Ee.SUBSCRIBE&&t!==Ee.UNSUBSCRIBE&&t!==Ee.UNPUBLISH&&t!==Ee.CONTROL&&t!==Ee.RESTART_ICE||this.once(fe.DISCONNECT_P2P,(()=>{T(new V(w.DISCONNECT_P2P))})),t!==Ee.PUBLISH&&t!==Ee.RESTART_ICE||this.once(fe.ABORT_P2P_EXECUTION,(()=>{T(new V(w.DISCONNECT_P2P))}))}));if(this.connectionState!==Ye.CONNECTING&&this.connectionState!==Ye.RECONNECTING||t===Ee.JOIN||t===Ee.REJOIN||await c(),t===Ee.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),b("DC_DEBUG_LOG")&&_.debug("[datachannel-signal] sendMessage",o),await this.websocket.sendMessage(o,!0,!1),r)return;const d=new ie(((R,T)=>{let y=!1;const I=(N,k)=>{y=!0,R({isSuccess:N==="success",message:k||{}}),this.off(fe.WS_CLOSED,A),this.off(fe.WS_RECONNECTING,A),this.emit(fe.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(s),I);const A=()=>{T(new V(w.WS_ABORT,"type: ".concat(t))),this.off(fe.WS_CLOSED,A),this.off(fe.WS_RECONNECTING,A),this.off("res-@".concat(s),I)};this.once(fe.WS_CLOSED,A),this.once(fe.WS_RECONNECTING,A),hn(b("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||y||(_.warning("dc request timeout, type: ".concat(t)),this.emit(fe.REQUEST_TIMEOUT,t,n))}))}));let l=null;try{l=await d}catch(R){if(this.connectionState===Ye.CLOSED||t===Ee.LEAVE)throw new V(w.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?R.throw():t===Ee.JOIN||t===Ee.REJOIN?null:(await c(),await this.request(t,n))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),h=aa(u),p=new V(w.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return h.action==="success"?l.message:(_.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===ye.ERR_TOO_MANY_BROADCASTERS?((t===Ee.JOIN||t===Ee.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===ye.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",ao.MULTI_IP)):this.reconnect(h.action,ao.SERVER_ERROR),t===Ee.JOIN||t===Ee.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new ie((i=>{const r=s=>{(!n||n(s))&&(this.off(t,r),i(s))};this.on(t,r)}))}uploadWRTCStats(t){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(oa.WRTC_STATS,n)}upload(t,n){const i={_type:t,_message:n};try{this.websocket.sendMessage(i)}catch{const s=b("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==Ye.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)}),b("UPLOAD_CACHE_INTERVAL")||2e3))}}async send(t,n){const i={_type:t,_message:n};await this.websocket.sendMessage(i)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ie(((n,i)=>{this.once(fe.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(fe.WS_CLOSED,(()=>i(this.initError||new V(w.WS_ABORT)))),this.connectionState=Ye.CONNECTING,this.websocket.init(t).catch(i),this.websocket.once(an.FAILBACK,(()=>{i(new V(w.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{this.openConnectionTime===void 0&&(_.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),i(new V(w.INIT_DATACHANNEL_TIMEOUT)))}),b("DC_JOIN_WITH_FAILBACK"))}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this.isJoining=!1,this.pendingNotifications=[],this._disconnectedReason=t||Ke.LEAVE,this.connectionState=Ye.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===Ke.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new UL("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),b("DC_PINGPONG_INTERVAL")),!this.joinResponse){this.emit(fe.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await en(this,fe.REQUEST_JOIN_INFO);this.store.joinReq(),this.isJoining=!0,this.pendingNotifications=[];const n=await this.request(Ee.JOIN,t);if(this.store.joinRep(),this.ortc=t?.ortc,!n)return this.emit(fe.REPORT_JOIN_GATEWAY,w.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(fe.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Ye.CONNECTED,this.isJoining=!1,this.processPendingNotifications(),!0}async rejoin(){if(!this.reconnectToken)throw new V(w.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=Yo(this,fe.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const n=await this.request(Ee.REJOIN,t);return!!n&&(this.connectionState=Ye.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),b("DC_PINGPONG_INTERVAL")),n.peers&&n.peers.forEach((i=>{this.emit(Ae.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Ae.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Ae.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Ae.MUTE_AUDIO,{uid:i.uid}):this.emit(Ae.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Ae.MUTE_VIDEO,{uid:i.uid}):this.emit(Ae.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Ae.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Ae.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Ae.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Ae.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Ae.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})})),!0)}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}async downgradeCodec(t){if(!this.ortc)return!1;const n={downgrade_codec:t,ortc:this.ortc};return!!await this.request(Ee.DOWNGRADE_CODEC,n)}handleNotification(t){_.debug("[".concat(this.clientId,"] receive notification: "),t);const n=aa(t.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ke.UID_BANNED),void this.close()):void this.reconnect(n.action,ao.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1,b("DC_DEBUG_LOG")&&console.debug("[datachannel-signal] pingpongTimeoutCount: ".concat(this.pingpongTimeoutCount));const t=b("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(_.warning("[datachannel-signal] PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>b("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("recover",ao.FALLBACK):this.request(Ee.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),b("REPORT_STATS")&&this.send(Ee.PING_BACK,{pingpongElapse:i})})).catch((i=>{}))}handleInflateData(){const{inflateLength:t,deflateLength:n}=this.websocket.getInflateData();t!==0&&n!==0&&this.upload(oa.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(an.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(fe.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(an.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(an.CLOSED,(()=>{this.connectionState=Ye.CLOSED})),this.websocket.on(an.FAILED,(()=>{this._disconnectedReason=Ke.NETWORK_ERROR,this.connectionState=Ye.CLOSED})),this.websocket.on(an.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Ye.CONNECTED?this.connectionState=Ye.RECONNECTING:this.connectionState=Ye.CONNECTING})),this.websocket.on(an.WILL_RECONNECT,((t,n)=>{if(Yo(this,fe.IS_P2P_DISCONNECTED)&&t==="retry")return _.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(fe.NEED_RENEW_SESSION),this.emit(fe.DISCONNECT_P2P),n("tryNext");t!=="retry"&&(_.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(fe.NEED_RENEW_SESSION),this.emit(fe.DISCONNECT_P2P)),n(t)})),this.websocket.on(an.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",ao.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(fe.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof V&&t.code===w.UNEXPECTED_RESPONSE&&t.data.code===ye.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",ao.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",ao.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(an.REQUEST_NEW_URLS,((t,n)=>{en(this,fe.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)})),this.websocket.on(an.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(an.TO_CONNECT_DATACHANNEL,((t,n)=>{en(this,fe.PRE_CONNECT_PC).then(t).catch(n)})),this.websocket.on(an.FAILBACK,(()=>{this.openConnectionTime!==void 0&&this.emit(fe.DATACHANNEL_FAILBACK)}))}}const dY={name:"DataChannelConnection",create:function(e){let{store:t,spec:n}=e;return new sY(n,t)}},lY={name:"DataChannelSignal",create:function(e){let{store:t,spec:n}=e;return new cY(n,t)}};xE(),_t("PROCESS_ID","process-".concat(ut(8,""),"-").concat(ut(4,""),"-").concat(ut(4,""),"-").concat(ut(4,""),"-").concat(ut(12,""))),(function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void _.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),n=Date.now();_.debug("Loading global parameters from cache",t),Object.keys(t).forEach((i=>{if(Object.prototype.hasOwnProperty.call(ht,i)){const{value:r,expires:s}=t[i];if(s&&s<=n)return;Ni[i]=r,ht[i]=r}}))}catch(t){_.error("Error loading mutableParamsCache: ".concat(e),t.message)}})(),Array.isArray(Ni.AREAS)&&Ni.AREAS.length>0&&Mg(Ni.AREAS,!0);const VL=(e,t,n)=>{_.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(t))),_t(e,t,n)};ls(I8,!1),ls(O8,!1),ls(sK,!1),ls(F8,!1),ls(R8,!1),ls(Z8,!1),ls(tY,!1),ls(iY,!1),ls(dY,!1),ls(lY,!1);const tn=(function(e){const t=new kt,n=e,i={getListeners:t.getListeners.bind(t),on:(r,s)=>((function(o,a){o===as.SECURITY_POLICY_VIOLATION&&hP(a,!0)})(r,s),t.on.bind(t)(r,s)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return uP(uP({},n),i)})({__TRACK_LIST__:Zo,VERSION:Gi,BUILD:VE,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:VL,getParameter:b,getSupportedCodec:async function(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;const n=await(async function(i){let r;return We().supportUnifiedPlan?(i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"}),r=(await i.createOffer()).sdp):r=(await i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r})(t);if(!n)return e;t.close(),t=null,e=(function(i){const r={video:[],audio:[]};return i.match(/ VP8/i)&&r.video.push("VP8"),i.match(/ VP9/i)&&r.video.push("VP9"),i.match(/ AV1/i)&&r.video.push("AV1"),i.match(/ H264/i)&&r.video.push("H264"),i.match(/ H265/i)&&r.video.push("H265"),i.match(/ opus/i)&&r.audio.push("OPUS"),i.match(/ PCMU/i)&&r.audio.push("PCMU"),i.match(/ PCMA/i)&&r.audio.push("PCMA"),i.match(/ G722/i)&&r.audio.push("G722"),r})(n)}catch(t){throw new V(w.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return e},checkSystemRequirements:function(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];const t=pe.reportApiInvoke(null,{name:Nt.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Tt.TRACER}),n=(function(){let s=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],o=!1;try{const a=window.RTCPeerConnection,c=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,d=window.WebSocket;o=!(!a||!d),s&&!c&&(o=!1),o&&Vd()&&Rw(75)&&new a().close()}catch(a){_.error("check system requirement failed: ",a),o=!1}return o})(e),i=aK();_.debug("checkSystemRequirements, api:",n,"browser",i);const r=n&&i;return t.onSuccess(r),b("IGNORE_RTC_DEVICE_CHECK")?n:r},getDevices:function(e){return xi.enumerateDevices(!0,!0,e)},getMicrophones:function(e){return xi.getRecordingDevices(e)},getCameras:function(e){return xi.getCamerasDevices(e)},getElectronScreenSources:AA,getPlaybackDevices:function(e){return xi.getSpeakers(e)},createClient:cP,createCameraVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=b("CAMERA_CAPTURE_CONFIG"),n=ut(8,"track-cam-"),i=pe.reportApiInvoke(null,{id:n,tag:Tt.TRACER,name:Nt.CREATE_CAM_VIDEO_TRACK,options:[bt({},e),t]});t&&(e.encoderConfig=t);const r=Nh(e);let s=null;_.info("start create camera video track with config",JSON.stringify(e),"trackId",n);try{s=(await ki({video:r},n)).getVideoTracks()[0]||null}catch(a){throw i.onError(a),a}if(!s){const a=new F(w.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(a),a.throw(_)}if(e.optimizationMode&&ig(n,s,e,hr(e.encoderConfig)),b("USE_STANDARD_BITRATE_DEFAULT")){const a=hr(e.encoderConfig);e.encoderConfig=a,delete a.bitrateMax,delete a.bitrateMin}const o=new Ph(s,e,r,e.scalabiltyMode?Ih(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,n);return i.onSuccess(o.getTrackId()),_.info("create camera video success, trackId:",n),o},createCustomVideoTrack:function(e){const t=ut(8,"track-cus-"),n=pe.reportApiInvoke(null,{id:t,tag:Tt.TRACER,name:Nt.CREATE_CUSTOM_VIDEO_TRACK,options:[e]});b("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin);const i=new yt(e.mediaStreamTrack,{width:e.width,height:e.height,frameRate:e.frameRate,bitrateMax:e.bitrateMax,bitrateMin:e.bitrateMin},e.scalabiltyMode?Ih(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,t,[ct.CUSTOM_TRACK]);return n.onSuccess(i.getTrackId()),_.info("create custom video track success with config",e,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const n=typeof t=="object"?(function(h){const p=VA(h);return EA()&&h.suppressLocalAudioPlayback&&(p.suppressLocalAudioPlayback=h.suppressLocalAudioPlayback),gA()&&h.restrictOwnAudio&&(p.restrictOwnAudio=!0),p})(t):void 0;n&&(t="auto");const i=ut(8,"track-scr-v-"),r=pe.reportApiInvoke(null,{id:i,tag:Tt.TRACER,name:Nt.CREATE_SCREEN_VIDEO_TRACK,options:[bt({},e),t]});e.encoderConfig?typeof e.encoderConfig=="string"||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";const s=(function(h){const p={};h.screenSourceType&&(p.mediaSource=h.screenSourceType),h.extensionId&&Os()&&(p.extensionId=h.extensionId);const{displaySurface:R,selfBrowserSurface:T,surfaceSwitching:y,systemAudio:I,preferCurrentTab:A,windowAudio:N,monitorTypeSurfaces:k}=h;(Dr(107)||no(107)||Go(93))&&(R&&(qt(R,"displaySurface",["browser","window","monitor"]),p.displaySurface=R),T?(qt(T,"selfBrowserSurface",["exclude","include"]),p.selfBrowserSurface=T):p.selfBrowserSurface="include",y&&(qt(y,"surfaceSwitching",["exclude","include"]),p.surfaceSwitching=y)),(Dr(105)||no(105)||Go(91))&&I&&(qt(I,"systemAudio",["exclude","include"]),p.systemAudio=I),(Dr(94)||no(94)||Go(80))&&A&&(p.preferCurrentTab=!0),(Dr(141)||no(141)||Go(125))&&N&&(qt(N,"windowAudio",["exclude","system"]),p.windowAudio=N),(Dr(119)||no(119)||Go(105))&&k&&(qt(k,"monitorTypeSurfaces",["exclude","include"]),p.monitorTypeSurfaces=k),h.electronScreenSourceId&&(p.sourceId=h.electronScreenSourceId);const x=h.encoderConfig?HE(h.encoderConfig):null;return p.mandatory={chromeMediaSource:"desktop",maxWidth:x?x.width:void 0,maxHeight:x?x.height:void 0},x&&(x.frameRate&&(typeof x.frameRate=="number"?(p.mandatory.maxFrameRate=x.frameRate,p.mandatory.minFrameRate=x.frameRate):(p.mandatory.maxFrameRate=x.frameRate.max||x.frameRate.ideal||x.frameRate.exact||void 0,p.mandatory.minFrameRate=x.frameRate.min||x.frameRate.ideal||x.frameRate.exact||void 0),p.frameRate=x.frameRate),x.width&&(p.width=x.width),x.height&&(p.height=x.height)),p})(e);let o=null,a=null;const c=We();if(!c.supportShareAudio&&t==="enable"){const h=new F(w.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return r.onError(h),h.throw(_)}_.info("start create screen video track with config",e,"withAudio",t,"trackId",i);const d=c.supportShareAudio&&t!=="disable";try{const h=await ki({screen:s,screenAudio:d?n||!0:void 0},i);o=h.getVideoTracks()[0]||null,a=h.getAudioTracks()[0]||null}catch(h){throw r.onError(h),h}if(!o){const h=new F(w.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(h),h.throw(_)}if(!a&&t==="enable"){o&&o.stop();const h=new F(w.SHARE_AUDIO_NOT_ALLOWED);return r.onError(h),h.throw(_)}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(ig(i,o,e,e.encoderConfig&&HE(e.encoderConfig)||void 0),e.encoderConfig&&typeof e.encoderConfig!="string"&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));const l=new yt(o,e.encoderConfig?HE(e.encoderConfig):{},e.scalabiltyMode?Ih(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,i,[ct.SCREEN_TRACK]);if(!a)return r.onSuccess(l.getTrackId()),_.info("create screen video track success","video:",l.getTrackId()),l;const u=new Wt(a,void 0,ut(8,"track-scr-a-"),!1);return r.onSuccess([l.getTrackId(),u.getTrackId()]),_.info("create screen video track success","video:",l.getTrackId(),"audio:",u.getTrackId()),[l,u]},createMicrophoneAndCameraTracks:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=b("CAMERA_CAPTURE_CONFIG"),i=ut(8,"track-mic-"),r=ut(8,"track-cam-"),s=pe.reportApiInvoke(null,{id:"".concat(i,"-").concat(r),tag:Tt.TRACER,name:Nt.CREATE_MIC_AND_CAM_TRACKS,options:[e,t,n]});n&&(t.encoderConfig=n);const o=Nh(t),a=jA(e);let c=null,d=null;_.info("start create camera video track(".concat(r,") and microphone audio track(").concat(i,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(t)));try{const h=await ki({audio:a,video:o},"".concat(i,"-").concat(r));c=h.getAudioTracks()[0],d=h.getVideoTracks()[0]}catch(h){throw s.onError(h),h}if(!c||!d){const h=new F(w.UNEXPECTED_ERROR,"can not find tracks in media stream");return s.onError(h),h.throw(_)}if(t.optimizationMode&&ig(r,d,t,hr(t.encoderConfig)),b("USE_STANDARD_BITRATE_DEFAULT")){const h=hr(t.encoderConfig);t.encoderConfig=h,delete h.bitrateMax,delete h.bitrateMin}const l=new qd(c,e,a,i),u=new Ph(d,t,o,t.scalabiltyMode?Ih(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,r);return s.onSuccess([l.getTrackId(),u.getTrackId()]),_.info("create camera video track(".concat(r,") and microphone audio track(").concat(i,") success")),[l,u]},createMicrophoneAudioTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=ut(8,"track-mic-"),n=pe.reportApiInvoke(null,{id:t,tag:Tt.TRACER,name:Nt.CREATE_MIC_AUDIO_TRACK,options:[e]}),i=jA(e);let r=null;_.info("start create microphone audio track with config",JSON.stringify(e),"trackId",t);try{r=(await ki({audio:i},t)).getAudioTracks()[0]||null}catch(o){throw n.onError(o),o}if(!r){const o=new F(w.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(o),o.throw(_)}const s=new qd(r,e,i,t);return n.onSuccess(s.getTrackId()),_.info("create microphone audio track success, trackId:",t),s},createCustomAudioTrack:uO,createBufferSourceAudioTrack:async function(e){var t;const{cacheOnlineFile:n,encoderConfig:i}=e;let{source:r}=e;const s={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(t=File.name)!==null&&t!==void 0?t:"File":r,cacheOnlineFile:n,encoderConfig:i},o=ut(8,"track-buf-"),a=pe.reportApiInvoke(null,{id:o,tag:Tt.TRACER,name:Nt.CREATE_BUFFER_AUDIO_TRACK,options:[s]});if(b("DISABLE_WEBAUDIO"))throw new F(w.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");_.info("start create buffer source audio track with config",JSON.stringify(s),"trackId",o);const c=r;if(!(r instanceof AudioBuffer))try{r=await(async function(u,h){let p=null;if(typeof u=="string"){const T=I0.get(u);if(T)return _.debug("use cached audio resource: ",u),T;try{p=(await Pr((()=>ii.get(u,{responseType:"arraybuffer"})),void 0,void 0,{maxRetryCount:3})).data}catch(y){throw new F(w.FETCH_AUDIO_FILE_FAILED,y.toString())}}else p=await new ie(((y,I)=>{const A=new FileReader;A.onload=N=>{N.target?y(N.target.result):I(new F(w.READ_LOCAL_AUDIO_FILE_ERROR))},A.onerror=()=>{I(new F(w.READ_LOCAL_AUDIO_FILE_ERROR))},A.readAsArrayBuffer(u)}));const R=await(function(T){const y=yc();return new ie(((I,A)=>{y.decodeAudioData(T,(N=>{I(N)}),(N=>{A(new F(w.DECODE_AUDIO_FILE_FAILED,N.toString()))}))}))})(p);return typeof u=="string"&&h&&I0.set(u,R),R})(r,n)}catch(u){return a.onError(u),u.throw(_)}const d=new I6(r),l=new b6(c,d,i?wh(i):{},o);return _.info("create buffer source audio track success, trackId:",o),a.onSuccess(l.getTrackId()),l},setAppType:function(e){if(_.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw _.debug("Invalid appType"),new V(w.INVALID_PARAMS,"invalid app type",e);_t("APP_TYPE",Math.floor(e))},setLogLevel:function(e){_.setLogLevel(e)},enableLogUpload:function(){b("USE_NEW_LOG")?_t("UPLOAD_LOG",!0):_.enableLogUpload()},disableLogUpload:function(){b("USE_NEW_LOG")?_t("UPLOAD_LOG",!1):_.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new ON},checkAudioTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=pe.reportApiInvoke(null,{tag:Tt.TRACER,name:Nt.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof Wt||e instanceof Cc)){const c=new V(w.INVALID_TRACK,"the parameter is not a audio track");return n.onError(c),c.throw()}t&&t<1e3&&(t=1e3);const i=e instanceof Wt?e.getTrackLabel():"remote_track",r=e.getVolumeLevel();let s=r,o=r;const a=Date.now();return new ie((c=>{const d=setInterval((()=>{const l=e.getVolumeLevel();s=l>s?l:s,o=l<o?l:o;const u=s-o>1e-4,h=Date.now()-a;if(u||h>t){clearInterval(d);const p=u,R={duration:h,deviceLabel:i,maxVolumeLevel:s,result:p};_.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(R))),n.onSuccess(R),c(p)}}),200)}))},checkVideoTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=pe.reportApiInvoke(null,{tag:Tt.TRACER,name:Nt.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof yt||e instanceof Rc)){const u=new V(w.INVALID_TRACK,"the parameter is not a video track");return n.onError(u),u.throw()}t&&t<1e3&&(t=1e3);const i=e instanceof yt?e.getTrackLabel():"remote_track",r=e.getMediaStreamTrack(!0),s=document.createElement("video");s.style.width="1px",s.style.height="1px",s.setAttribute("muted",""),s.muted=!0,s.setAttribute("playsinline",""),s.controls=!1,(En()||mh())&&(s.style.opacity="0.01",s.style.position="fixed",s.style.left="0",s.style.top="0",document.body.appendChild(s)),s.srcObject=new MediaStream([r]),s.play();const o=document.createElement("canvas");o.width=160,o.height=120;let a=0,c=0;try{const u=Date.now();a=await(function(h,p,R,T){let y,I=0,A=null;return new ie(((N,k)=>{function x(){I>T&&y&&(y(),N(I));const P=R.getContext("2d");if(!P){const Y=new V(w.UNEXPECTED_ERROR,"can not get canvas 2d context.");return _.error(Y.toString()),void k(Y)}P.drawImage(h,0,0,160,120);const M=P.getImageData(0,0,R.width,R.height),G=Math.floor(M.data.length/3);if(A){for(let Y=0;Y<G;Y+=3)if(M.data[Y]!==A[Y])return I+=1,void(A=M.data);A=M.data}else A=M.data}setTimeout((()=>{y&&(y(),N(I))}),p),y=JE((()=>{x()}),30)}))})(s,t,o,4),c=Date.now()-u}catch(u){throw n.onError(u),u}KH===tt.SAFARI&&(s.pause(),s.remove()),s.srcObject=null;const d=a>4,l={duration:c,changedPicNum:a,deviceLabel:i,result:d};return _.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(l))),n.onSuccess(l),d},setArea:Mg,audioElementPlayCenter:Gn,resumeAudioContext:function(){return Gn.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(e){dK.processExternalMediaAEC(e)},registerExtensions:function(e){const t=b("PLUGIN_INFO")||[];e.forEach((n=>{"name"in n&&!X(t).call(t,n.name)&&t.push(n.name);const i=n;i.__registered__=!0,i.logger.hookLog=_.extLog,i.reporter.hookApiInvoke=pe.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach((r=>{i.parameters[r]=b(r)}))})),VL("PLUGIN_INFO",t)},ChannelMediaRelayError:wc,ChannelMediaRelayEvent:Ls,ChannelMediaRelayState:hi,RemoteStreamFallbackType:S6,RemoteStreamType:g6,ConnectionDisconnectedReason:Ke,AudienceLatencyLevelType:z4,AREAS:rt,preload:async function(e,t,n,i){return rS(e,t,n,i)},startLastmileProbeTest:async function(e,t,n,i){let r={state:"unavailable"};await rS(e,t,n,i);const s=await sS({appId:e,cname:t,token:n||e,uid:i,cloudProxyServer:"disabled"});if(!s)return r;await oS(s);let o,a=cP({mode:"rtc",codec:"vp8"});try{o=await a.join(e,t,n,i,{networkQualityProbe:!0})}catch{return r}const c=new XH,d=c.createMuteAudioTrack();let l=await uO({mediaStreamTrack:d});await a.publish([l]);let[u,h,p]=await new ie(((N,k)=>{const x=setTimeout((()=>{clearTimeout(x),N([!0,null,"audio"])}),5e3);a.on("user-published",(async(P,M)=>{P.uid===o&&(clearTimeout(x),N([!1,P,M]))}))}));if(u||!h)return await a.unpublish([l]),await a.leave(),l.close(),c.close(),r;await a.subscribe(h,p),await new ie(((N,k)=>{const x=setTimeout((()=>{clearTimeout(x),N(null)}),5e3)}));let R=a.getRTCStats(),T=a.getLocalAudioStats();const y=R.RTT,I=T.sendJitterMs,A=T.currentPacketLossRate;return r={state:"complete",rtt:y,packetLossRate:A,jitter:I,networkQuality:((N,k,x)=>{let P=1;if(x>0){let Ie=Math.log(100*x)/Math.log(2)+1;Ie=Math.min(5,Math.max(0,Ie)),P=1-Ie/5}let M=1;if(N>0){let Ie=Math.log(N/40)/Math.log(2)+1;Ie=Math.min(5,Math.max(0,Ie)),M=1-Ie/5}let G=1;if(k>0){let Ie=Math.log(k/10)/Math.log(2.5)+1;Ie=Math.min(5,Math.max(0,Ie)),G=1-Ie/5}const Y=.5*P+.3*M+.2*G;let de=0;return de=Y>=.8?1:Y>=.6?2:Y>=.4?3:Y>=.2?4:5,de})(y,I,A)},await a.unsubscribe(h),await a.unpublish([l]),await a.leave(),l.close(),c.close(),await oS(s),r}});return Object.defineProperties(tn,{onAudioAutoplayFailed:{get:()=>si.onAudioAutoplayFailed,set:e=>{si.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>si.onAutoplayFailed,set:e=>{si.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>tn._onSecurityPolicyViolation,set(e){tn._onSecurityPolicyViolation=e,hP(e)}},__CLIENT_LIST__:{get:()=>b("SHOW_GLOBAL_CLIENT_LIST")?ra:[]}}),xi.on(ea.CAMERA_DEVICE_CHANGED,(e=>{_.info("camera device changed",JSON.stringify(e)),tn.onCameraChanged&&tn.onCameraChanged(e),tn.safeEmit(as.CAMERA_CHANGED,e)})),xi.on(ea.RECORDING_DEVICE_CHANGED,(e=>{_.info("microphone device changed",JSON.stringify(e)),tn.onMicrophoneChanged&&tn.onMicrophoneChanged(e),tn.safeEmit(as.MICROPHONE_CHANGED,e)})),xi.on(ea.PLAYOUT_DEVICE_CHANGED,(e=>{_.debug("playout device changed",JSON.stringify(e)),tn.onPlaybackDeviceChanged&&tn.onPlaybackDeviceChanged(e),tn.safeEmit(as.PLAYBACK_DEVICE_CHANGED,e)})),Gn.onAutoplayFailed=()=>{_.info("detect audio element autoplay failed"),si.onAudioAutoplayFailed&&si.onAudioAutoplayFailed()},Et.on("autoplay-failed",(()=>{_.info("detect webaudio autoplay failed"),si.onAudioAutoplayFailed&&si.onAudioAutoplayFailed(),tn.safeEmit(as.AUTOPLAY_FAILED)})),Et.on(In.STATE_CHANGE,((e,t)=>{_.info("audio context state changed: ".concat(t," => ").concat(e)),tn.onAudioContextStateChanged&&tn.onAudioContextStateChanged(e,t),tn.safeEmit(as.AUDIO_CONTEXT_STATE_CHANGED,e,t)})),jt.on(Ko.NETWORK_STATE_CHANGE,((e,t)=>{_.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))})),window&&(window.__ARTC__=tn),tn}))})($p)),$p.exports}var oq=sq();const JS=ok(oq);JS.setLogLevel(4);function aq(E){if(!E)return"";const f=Date.now()-new Date(E).getTime(),g=Math.floor(f/6e4);return g<1?"just now":g<60?`${g}m ago`:`${Math.floor(g/60)}h ago`}function cq({session:E,userName:f,isHost:g,onLeave:C,onEnd:D}){const U=W.useRef(null),B=W.useRef(null),te=W.useRef({audio:null,video:null}),[z,_e]=W.useState(!1),[ne,ee]=W.useState(!0),[q,ce]=W.useState(!0),[ae,Te]=W.useState(E.currentViewers??0),[Se,xe]=W.useState("");W.useEffect(()=>{let Fe=!1;return(async()=>{try{const et=JS.createClient({mode:"live",codec:"vp8"});if(B.current=et,await et.setClientRole(g?"host":"audience"),await et.join(E.appId,E.channelName,g?E.hostToken:E.viewerToken,null),g){const[be,oe]=await JS.createMicrophoneAndCameraTracks();if(Fe){be.close(),oe.close();return}te.current={audio:be,video:oe},await et.publish([be,oe]),U.current&&oe.play(U.current),_e(!0)}else et.on("user-published",async(be,oe)=>{await et.subscribe(be,oe),oe==="video"&&U.current&&(be.videoTrack.play(U.current),_e(!0)),oe==="audio"&&be.audioTrack.play()}),et.on("user-unpublished",()=>_e(!1));et.on("user-joined",()=>Te(be=>be+1)),et.on("user-left",()=>Te(be=>Math.max(0,be-1)))}catch(et){Fe||xe(et.message||"Failed to connect to stream")}})(),()=>{Fe=!0;const et=te.current;if(et.audio)try{et.audio.stop(),et.audio.close()}catch{}if(et.video)try{et.video.stop(),et.video.close()}catch{}if(B.current){try{B.current.leave()}catch{}B.current=null}}},[]);const it=async()=>{const Fe=te.current.audio;Fe&&(await Fe.setEnabled(!ne),ee(Ht=>!Ht))},dt=async()=>{const Fe=te.current.video;Fe&&(await Fe.setEnabled(!q),ce(Ht=>!Ht))};return m.jsxs("div",{style:{position:"fixed",inset:0,zIndex:1e3,background:"#000",display:"flex",flexDirection:"column"},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 16px",background:"rgba(0,0,0,0.85)",borderBottom:"1px solid rgba(255,255,255,0.1)",flexShrink:0},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,color:"#fff",fontSize:14},children:[z?m.jsx("span",{style:{background:"#ff3b30",color:"#fff",fontSize:11,fontWeight:700,padding:"2px 7px",borderRadius:4},children:"LIVE"}):m.jsx("span",{style:{color:"rgba(255,255,255,0.5)",fontSize:11},children:"Connecting"}),m.jsx("span",{style:{fontWeight:600},children:E.title||(g?"Your Stream":`${E.hostName||"Host"}'s Stream`)}),m.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4,color:"rgba(255,255,255,0.6)",fontSize:12},children:[m.jsx(GS,{size:13})," ",ae]})]}),m.jsxs("div",{style:{display:"flex",gap:8},children:[g&&m.jsxs(m.Fragment,{children:[m.jsx("button",{onClick:it,style:Kp(ne),children:ne?m.jsx(wY,{size:16}):m.jsx(AY,{size:16})}),m.jsx("button",{onClick:dt,style:Kp(q),children:q?m.jsx(xl,{size:16}):m.jsx(OY,{size:16})}),m.jsxs("button",{onClick:D,style:Kp(!1,"#ff3b30"),children:[m.jsx(uk,{size:16})," End"]})]}),!g&&m.jsxs("button",{onClick:C,style:Kp(!1),children:[m.jsx(nT,{size:16})," Leave"]})]})]}),m.jsxs("div",{ref:U,style:{flex:1,width:"100%",overflow:"hidden",background:"#111",display:"flex",alignItems:"center",justifyContent:"center"},children:[Se&&m.jsx("div",{style:{color:"#ff453a",textAlign:"center",padding:40},children:Se}),!z&&!Se&&m.jsxs("div",{style:{color:"rgba(255,255,255,0.5)",textAlign:"center"},children:[m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto 12px",borderColor:"rgba(255,255,255,0.2)",borderTopColor:"#fff"}}),m.jsx("p",{children:g?"Starting your broadcast":"Waiting for host"})]})]})]})}function Kp(E,f){return{display:"flex",alignItems:"center",gap:5,padding:"6px 12px",borderRadius:8,border:"none",cursor:"pointer",fontSize:13,fontWeight:600,background:f||(E?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.1)"),color:f||E?"#fff":"rgba(255,255,255,0.8)"}}function dq({onStart:E,onCancel:f}){const[g,C]=W.useState(""),[D,U]=W.useState(!1),[B,te]=W.useState(""),z=async()=>{te(""),U(!0);try{const _e=await Me.startLiveStream({title:g.trim()||null});E(_e)}catch(_e){te(_e.message||"Failed to start stream"),U(!1)}};return m.jsx("div",{style:{position:"fixed",inset:0,zIndex:900,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",padding:20},children:m.jsxs("div",{className:"card",style:{width:"100%",maxWidth:400,padding:24},children:[m.jsx("div",{style:{fontWeight:700,fontSize:18,marginBottom:16,color:"var(--text)"},children:"Go Live"}),m.jsx("input",{type:"text",value:g,onChange:_e=>C(_e.target.value),placeholder:"Stream title (optional)",maxLength:100,className:"chat-input",style:{width:"100%",marginBottom:12},onKeyDown:_e=>_e.key==="Enter"&&z(),autoFocus:!0}),B&&m.jsx("div",{className:"login-error",style:{marginBottom:12},children:B}),m.jsxs("div",{style:{display:"flex",gap:8},children:[m.jsxs("button",{onClick:z,disabled:D,className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6},children:[m.jsx(rm,{size:15})," ",D?"Starting":"Start Stream"]}),m.jsx("button",{onClick:f,className:"btn-secondary",children:"Cancel"})]})]})})}function lq(){const{user:E}=$i(),[f,g]=W.useState([]),[C,D]=W.useState(!0),[U,B]=W.useState(!1),[te,z]=W.useState(null),[_e,ne]=W.useState(!1),[ee,q]=W.useState(null),[ce,ae]=W.useState(""),Te=W.useCallback(async()=>{try{const Fe=await Me.getLiveStreams();g(Fe.streams||[])}catch{g([])}finally{D(!1)}},[]);W.useEffect(()=>{Te();const Fe=setInterval(Te,3e4);return()=>clearInterval(Fe)},[Te]);const Se=Fe=>{B(!1),ne(!0),z({...Fe,isHost:!0})},xe=async Fe=>{q(Fe.streamId),ae("");try{const Ht=await Me.joinLiveStream(Fe.streamId);ne(!1),z({...Ht,isHost:!1})}catch(Ht){ae(Ht.message||"Failed to join stream")}finally{q(null)}},it=W.useCallback(async()=>{te&&Me.leaveLiveStream(te.streamId).catch(()=>{}),z(null),Te()},[te,Te]),dt=W.useCallback(async()=>{te&&Me.endLiveStream(te.streamId).catch(()=>{}),z(null),Te()},[te,Te]);return te?m.jsx(cq,{session:te,userName:E?.firstName||E?.username||"Guest",isHost:_e,onLeave:it,onEnd:dt}):m.jsxs(Un,{children:[U&&m.jsx(dq,{onStart:Se,onCancel:()=>B(!1)}),m.jsxs("div",{className:"page-header",children:[m.jsx("h2",{className:"page-title",children:"Live"}),m.jsxs("div",{style:{display:"flex",gap:8},children:[m.jsx("button",{onClick:Te,className:"btn-secondary",style:{padding:"6px 10px"},title:"Refresh",children:m.jsx(om,{size:15})}),m.jsxs("button",{onClick:()=>{B(!0),ae("")},className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6},children:[m.jsx(Ml,{size:16})," Go Live"]})]})]}),ce&&m.jsx("div",{className:"login-error",style:{marginBottom:12},children:ce}),C?m.jsx("div",{style:{textAlign:"center",padding:40},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):f.length===0?m.jsxs("div",{className:"card",style:{textAlign:"center",padding:40},children:[m.jsx(rm,{size:36,style:{margin:"0 auto 12px",display:"block",opacity:.3}}),m.jsx("div",{style:{color:"var(--text-muted)",marginBottom:16},children:"No live streams right now."}),m.jsxs("button",{onClick:()=>B(!0),className:"btn-primary",style:{display:"inline-flex",alignItems:"center",gap:6},children:[m.jsx(Ml,{size:16})," Be the first to go live"]})]}):m.jsx("div",{style:{display:"flex",flexDirection:"column",gap:10},children:f.map(Fe=>m.jsx("div",{className:"card",style:{padding:16},children:m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[m.jsxs("div",{style:{flex:1,minWidth:0},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[m.jsx("span",{style:{background:"#ff3b30",color:"#fff",fontSize:10,fontWeight:700,padding:"2px 6px",borderRadius:4,flexShrink:0},children:"LIVE"}),m.jsx("span",{style:{fontWeight:600,color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:Fe.title||`${Fe.hostName}'s Stream`})]}),m.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,fontSize:13,color:"var(--text-muted)"},children:[m.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[m.jsx(GS,{size:13})," ",Fe.currentViewers??0]}),m.jsxs("span",{children:["by ",Fe.hostName]}),m.jsxs("span",{style:{display:"flex",alignItems:"center",gap:3},children:[m.jsx(IY,{size:12})," ",aq(Fe.startedAt||Fe.createdAt)]})]})]}),m.jsxs("button",{onClick:()=>xe(Fe),disabled:ee===Fe.streamId,className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6,flexShrink:0},children:[m.jsx(GS,{size:14}),ee===Fe.streamId?"Joining":"Watch"]})]})},Fe.streamId))})]})}function uq(){return m.jsxs(Un,{children:[m.jsx("div",{className:"section-label",children:"Videorama"}),m.jsx("div",{className:"feature-page",children:m.jsx("iframe",{className:"feature-iframe",src:"/videorama",title:"Videorama",allow:"autoplay; fullscreen",sandbox:"allow-scripts allow-same-origin allow-forms allow-popups"})})]})}function hq(){const[E,f]=W.useState([]),[g,C]=W.useState(!0),[D,U]=W.useState("all"),[B,te]=W.useState(""),[z,_e]=W.useState(""),[ne,ee]=W.useState(null),q=W.useCallback(async()=>{C(!0),_e("");try{const Se=await fetch(`/api/media/library?type=${D}&limit=100${B?`&search=${encodeURIComponent(B)}`:""}`,{credentials:"include"});if(!Se.ok)throw new Error("Failed to load media");const xe=await Se.json();f(xe.media||[])}catch(Se){_e(Se.message||"Failed to load media library"),f([])}finally{C(!1)}},[D,B]);W.useEffect(()=>{q()},[q]);const ce=Se=>{ee(Se)},ae=()=>{ee(null)},Te=Se=>Se.type==="video";return ne?m.jsx(Un,{children:m.jsxs("div",{style:{padding:"16px"},children:[m.jsx("button",{onClick:ae,style:{marginBottom:"16px",padding:"8px 12px",background:"rgba(255,255,255,0.1)",border:"none",borderRadius:"6px",color:"#fff",cursor:"pointer"},children:" Back"}),Te(ne)?m.jsx("video",{src:ne.file_path||ne.url,controls:!0,autoPlay:!0,style:{width:"100%",maxHeight:"70vh",borderRadius:"8px",background:"#000"}}):m.jsx("audio",{src:ne.file_path||ne.url,controls:!0,autoPlay:!0,style:{width:"100%",marginBottom:"16px"}}),m.jsxs("div",{style:{marginTop:"16px",padding:"16px",background:"rgba(255,255,255,0.05)",borderRadius:"8px"},children:[m.jsx("h3",{style:{margin:"0 0 8px",color:"#fff"},children:ne.title||"Untitled"}),ne.artist&&m.jsxs("p",{style:{margin:"0 0 4px",color:"rgba(255,255,255,0.7)",fontSize:"14px"},children:["by ",ne.artist]}),ne.description&&m.jsx("p",{style:{margin:"8px 0 0",color:"rgba(255,255,255,0.6)",fontSize:"13px"},children:ne.description})]})]})}):m.jsxs(Un,{children:[m.jsxs("div",{className:"page-header",children:[m.jsx("h2",{className:"page-title",children:"Media Library"}),m.jsx("button",{onClick:()=>q(),className:"btn-secondary",style:{padding:"6px 10px"},title:"Refresh",children:m.jsx(om,{size:15})})]}),m.jsxs("div",{style:{padding:"16px",display:"flex",gap:"8px",marginBottom:"12px"},children:[m.jsxs("div",{style:{flex:1,position:"relative"},children:[m.jsx(am,{size:16,style:{position:"absolute",left:"8px",top:"50%",transform:"translateY(-50%)",color:"rgba(255,255,255,0.5)"}}),m.jsx("input",{type:"text",value:B,onChange:Se=>te(Se.target.value),onKeyDown:Se=>Se.key==="Enter"&&q(),placeholder:"Search media...",className:"chat-input",style:{width:"100%",paddingLeft:"32px"}})]}),m.jsxs("select",{value:D,onChange:Se=>U(Se.target.value),style:{padding:"8px 12px",background:"rgba(255,255,255,0.1)",border:"1px solid rgba(255,255,255,0.2)",borderRadius:"6px",color:"#fff"},children:[m.jsx("option",{value:"all",children:"All"}),m.jsx("option",{value:"audio",children:"Audio"}),m.jsx("option",{value:"video",children:"Video"})]})]}),z&&m.jsx("div",{className:"login-error",style:{marginBottom:"12px"},children:z}),g?m.jsx("div",{style:{textAlign:"center",padding:"40px"},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):E.length===0?m.jsxs("div",{className:"card",style:{textAlign:"center",padding:"40px"},children:[m.jsx(WS,{size:36,style:{margin:"0 auto 12px",display:"block",opacity:.3}}),m.jsx("div",{style:{color:"var(--text-muted)"},children:"No media found"})]}):m.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(150px, 1fr))",gap:"12px",padding:"12px"},children:E.map(Se=>m.jsxs("div",{onClick:()=>ce(Se),style:{cursor:"pointer",borderRadius:"8px",overflow:"hidden",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",transition:"all 0.2s"},onMouseEnter:xe=>{xe.currentTarget.style.background="rgba(255,255,255,0.1)",xe.currentTarget.style.borderColor="rgba(255,255,255,0.3)"},onMouseLeave:xe=>{xe.currentTarget.style.background="rgba(255,255,255,0.05)",xe.currentTarget.style.borderColor="rgba(255,255,255,0.1)"},children:[m.jsxs("div",{style:{width:"100%",aspectRatio:"1",background:"linear-gradient(135deg, rgba(59,130,246,0.3), rgba(139,92,246,0.3))",display:"flex",alignItems:"center",justifyContent:"center",position:"relative"},children:[Te(Se)?m.jsx(WS,{size:32,style:{opacity:.5}}):m.jsx(eT,{size:32,style:{opacity:.5}}),m.jsx("div",{style:{position:"absolute",width:"40px",height:"40px",background:"rgba(59,130,246,0.8)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center"},children:m.jsx(hk,{size:18,fill:"#fff",style:{marginLeft:"2px"}})})]}),m.jsxs("div",{style:{padding:"8px"},children:[m.jsx("div",{style:{fontWeight:600,fontSize:"12px",color:"#fff",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",marginBottom:"4px"},children:Se.title||"Untitled"}),Se.artist&&m.jsx("div",{style:{fontSize:"11px",color:"rgba(255,255,255,0.6)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:Se.artist})]})]},Se.id))})]})}function pq(){const[E,f]=W.useState([]),[g,C]=W.useState([]),[D,U]=W.useState(!0),[B,te]=W.useState(""),[z,_e]=W.useState("all");W.useEffect(()=>{ne()},[]),W.useEffect(()=>{ee()},[E,B,z]);async function ne(){U(!0);try{const ce=await fetch("/api/media/library?type=all&limit=100",{credentials:"include"});if(!ce.ok)throw new Error("Failed to load content");const ae=await ce.json(),Se=(Array.isArray(ae)?ae:ae.data||[]).filter(xe=>xe.is_prime===!0);f(Se)}catch(ce){console.error("Error loading prime content:",ce),f([])}finally{U(!1)}}function ee(){let ce=E;if(z!=="all"&&(ce=ce.filter(ae=>ae.category===z)),B){const ae=B.toLowerCase();ce=ce.filter(Te=>Te.title&&Te.title.toLowerCase().includes(ae)||Te.artist&&Te.artist.toLowerCase().includes(ae))}C(ce)}const q=["all",...new Set(E.map(ce=>ce.category).filter(Boolean))];return m.jsxs(Un,{children:[m.jsx("div",{className:"prime-header",children:m.jsxs("div",{className:"prime-title-section",children:[m.jsx(tm,{size:32,className:"prime-icon"}),m.jsxs("div",{children:[m.jsx("h1",{className:"prime-title",children:"PRIME Content"}),m.jsx("p",{className:"prime-subtitle",children:"Exclusive curated content for premium members"})]})]})}),m.jsxs("div",{className:"prime-controls",children:[m.jsxs("div",{className:"prime-search",children:[m.jsx(am,{size:18}),m.jsx("input",{type:"text",placeholder:"Search prime content...",value:B,onChange:ce=>te(ce.target.value),className:"search-input"})]}),m.jsxs("div",{className:"prime-filters",children:[m.jsx(NY,{size:18}),m.jsx("select",{value:z,onChange:ce=>_e(ce.target.value),className:"filter-select",children:q.map(ce=>m.jsx("option",{value:ce,children:ce==="all"?"All Categories":ce.charAt(0).toUpperCase()+ce.slice(1)},ce))})]})]}),m.jsx("div",{className:"prime-content-section",children:D?m.jsxs("div",{className:"loading-container",children:[m.jsx("div",{className:"loading-spinner"}),m.jsx("p",{children:"Loading premium content..."})]}):g.length>0?m.jsx("div",{className:"prime-grid",children:g.map(ce=>m.jsxs("div",{className:"prime-card",children:[m.jsxs("div",{className:"prime-card-image",children:[ce.cover_url?m.jsx("img",{src:ce.cover_url,alt:ce.title}):m.jsx("div",{className:"prime-placeholder",children:m.jsx(WL,{size:48})}),m.jsx("div",{className:"prime-card-overlay",children:m.jsx("button",{className:"play-button",children:m.jsx(hk,{size:24,fill:"white"})})}),m.jsxs("div",{className:"prime-badge",children:[m.jsx(tm,{size:14}),"PRIME"]})]}),m.jsxs("div",{className:"prime-card-info",children:[m.jsx("h3",{className:"prime-card-title",children:ce.title||"Untitled"}),m.jsx("p",{className:"prime-card-artist",children:ce.artist||"Unknown"}),m.jsx("p",{className:"prime-card-category",children:ce.category})]})]},ce.id))}):m.jsxs("div",{className:"empty-state",children:[m.jsx(WL,{size:48}),m.jsx("p",{children:"No prime content found"}),m.jsx("span",{className:"empty-subtitle",children:"Check back soon for exclusive content"})]})})]})}function Dk({onPosted:E}){const{user:f}=$i(),[g,C]=W.useState(""),[D,U]=W.useState(!1),[B,te]=W.useState(""),[z,_e]=W.useState(null),[ne,ee]=W.useState(null),q=W.useRef(null),ce=5e3,ae=xe=>{const it=xe.target.files?.[0];if(!it)return;if(!/^image\/(jpeg|jpg|png|webp|gif)$/i.test(it.type)){te(" Videos are disabled to save storage costs. Please use YouTube or Vimeo and share the link instead.");return}if(it.size>10*1024*1024){te("Image file is too large (max 10MB). Please compress before uploading.");return}te(""),_e(it);const Fe=new FileReader;Fe.onload=Ht=>ee(Ht.target.result),Fe.readAsDataURL(it)},Te=()=>{_e(null),ee(null),q.current&&(q.current.value="")},Se=async()=>{if(!(!g.trim()||D)){U(!0),te("");try{if(z){const xe=await Me.createPostWithMedia(g.trim(),z);C(""),Te(),E&&E(xe.post)}else{const xe=await Me.createPost({content:g.trim()});C(""),E&&E(xe.post)}}catch(xe){te(xe.message||"Failed to post. Please try again.")}finally{U(!1)}}};return m.jsx("div",{className:"post-composer card",children:m.jsxs("div",{style:{display:"flex",gap:12},children:[m.jsx("div",{className:"post-avatar-placeholder",style:{width:40,height:40,fontSize:16,flexShrink:0},children:(f?.firstName||f?.username||"?")[0].toUpperCase()}),m.jsxs("div",{style:{flex:1},children:[m.jsx("textarea",{value:g,onChange:xe=>C(xe.target.value),placeholder:"What's happening?",maxLength:ce,rows:3,className:"composer-textarea"}),B&&m.jsx("div",{style:{color:"#ff453a",fontSize:13,marginBottom:6},children:B}),ne&&m.jsx("div",{className:"composer-media-preview",children:m.jsxs("div",{style:{position:"relative",display:"inline-block"},children:[m.jsx("img",{src:ne,alt:"Preview",style:{maxHeight:150,maxWidth:"100%",borderRadius:8}}),m.jsx("button",{onClick:Te,style:{position:"absolute",top:4,right:4,background:"rgba(0,0,0,0.7)",border:"none",borderRadius:"50%",padding:4,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},title:"Remove media",children:m.jsx(ZS,{size:14,color:"white"})})]})}),m.jsxs("div",{className:"composer-footer",children:[m.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[m.jsx("button",{onClick:()=>q.current?.click(),disabled:D,style:{background:"none",border:"none",color:"var(--accent-pink)",cursor:"pointer",padding:6,display:"flex",alignItems:"center",justifyContent:"center",fontSize:12},title:"Attach image or video",children:m.jsx(DY,{size:16})}),m.jsxs("span",{className:"composer-char-count",style:{color:g.length>ce*.9?"#ff453a":"var(--text-muted)"},children:[g.length,"/",ce]})]}),m.jsxs("button",{onClick:Se,disabled:!g.trim()||D,className:"btn-primary composer-post-btn",children:[m.jsx($S,{size:14}),D?"Posting...":"Post"]})]}),m.jsx("input",{ref:q,type:"file",accept:"image/*,video/*",onChange:ae,style:{display:"none"}})]})]})})}function mq(){const[E,f]=W.useState([]),[g,C]=W.useState(!0),[D,U]=W.useState(null),[B,te]=W.useState(!1),z=W.useCallback(async(q=null)=>{try{const ce=await Me.getFeed(q);f(q?ae=>[...ae,...ce.posts||[]]:ce.posts||[]),U(ce.nextCursor||null)}catch(ce){console.error("Feed error",ce)}},[]);W.useEffect(()=>{C(!0),z().finally(()=>C(!1))},[z]);const _e=q=>{f(ce=>[{...q,liked_by_me:!1,likes_count:0,replies_count:0,reposts_count:0},...ce])},ne=q=>{f(ce=>ce.filter(ae=>ae.id!==q))},ee=async()=>{!D||B||(te(!0),await z(D),te(!1))};return m.jsxs(Un,{children:[m.jsx("div",{className:"page-header",children:m.jsx("h2",{className:"page-title",children:"Feed"})}),m.jsx(Dk,{onPosted:_e}),g?m.jsx("div",{style:{textAlign:"center",padding:32},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):E.length===0?m.jsx("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:"No posts yet. Be the first to post!"}):m.jsxs(m.Fragment,{children:[E.map(q=>m.jsx(cT,{post:q,onDeleted:ne},q.id)),D&&m.jsx("button",{onClick:ee,disabled:B,className:"btn-secondary",style:{width:"100%",marginTop:12},children:B?"Loading...":"Load more"})]})]})}function fq(){const{userId:E}=dk(),{user:f}=$i(),[g,C]=W.useState(null),[D,U]=W.useState([]),[B,te]=W.useState(!0),[z,_e]=W.useState(null),[ne,ee]=W.useState(!1);W.useEffect(()=>{const Se=async()=>{try{const xe=await Me.getWall(E);C(xe.profile),U(xe.posts||[]),_e(xe.nextCursor||null)}catch{}};te(!0),Se().finally(()=>te(!1))},[E]);const q=Se=>U(xe=>[Se,...xe]),ce=Se=>U(xe=>xe.filter(it=>it.id!==Se)),ae=async()=>{if(!(!z||ne)){ee(!0);try{const Se=await Me.getWall(E,z);U(xe=>[...xe,...Se.posts||[]]),_e(Se.nextCursor||null)}catch{}ee(!1)}};if(B)return m.jsx(Un,{children:m.jsx("div",{style:{textAlign:"center",padding:32},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})})});if(!g)return m.jsx(Un,{children:m.jsx("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:"User not found."})});const Te=f?.id===E;return m.jsxs(Un,{children:[m.jsxs("div",{className:"card wall-profile-card",children:[m.jsx("div",{className:"wall-profile-avatar",children:m.jsx("div",{className:"post-avatar-placeholder wall-avatar-big",children:(g.first_name||g.username||"?")[0].toUpperCase()})}),m.jsxs("div",{className:"wall-profile-info",children:[m.jsxs("div",{className:"wall-profile-name",children:[g.first_name," ",g.last_name||""]}),g.username&&m.jsxs("div",{className:"wall-profile-handle",children:["@",g.username]}),g.pnptv_id&&m.jsxs("div",{className:"wall-profile-id",children:["ID: ",g.pnptv_id]}),g.bio&&m.jsx("div",{className:"wall-profile-bio",children:g.bio})]}),!Te&&m.jsxs(dn,{to:`/messages/${E}`,className:"btn-secondary wall-dm-btn",children:[m.jsx(im,{size:16})," DM"]})]}),Te&&m.jsx(Dk,{onPosted:q}),D.length===0?m.jsx("div",{className:"card",style:{textAlign:"center",padding:24,color:"var(--text-muted)"},children:"No posts yet."}):D.map(Se=>m.jsx(cT,{post:Se,onDeleted:ce},Se.id)),z&&m.jsx("div",{style:{textAlign:"center",padding:"12px 0"},children:m.jsx("button",{className:"btn-secondary",onClick:ae,disabled:ne,children:ne?"Loading":"Load more"})})]})}function _q(E){if(!E)return"";const f=Date.now()-new Date(E).getTime(),g=Math.floor(f/6e4);if(g<1)return"now";if(g<60)return`${g}m`;const C=Math.floor(g/60);return C<24?`${C}h`:`${Math.floor(C/24)}d`}function Eq(){const[E,f]=W.useState([]),[g,C]=W.useState(!0),[D,U]=W.useState(""),[B,te]=W.useState([]),[z,_e]=W.useState(!1);W.useEffect(()=>{Me.getDMThreads().then(ee=>f(ee.threads||[])).catch(()=>{}).finally(()=>C(!1))},[]);const ne=async ee=>{if(U(ee),!ee.trim()){te([]);return}_e(!0);try{const q=await Me.searchUsers(ee);te(q.users||[])}catch{}finally{_e(!1)}};return m.jsxs(Un,{children:[m.jsx("div",{className:"page-header",children:m.jsx("h2",{className:"page-title",children:"Messages"})}),m.jsx("div",{className:"card",style:{padding:"12px 16px",marginBottom:12},children:m.jsx("input",{type:"text",value:D,onChange:ee=>ne(ee.target.value),placeholder:"Search users to message...",className:"chat-input",style:{width:"100%"}})}),D.trim()?m.jsx("div",{className:"card",children:z?m.jsx("div",{style:{padding:16,textAlign:"center",color:"var(--text-muted)"},children:"Searching..."}):B.length===0?m.jsx("div",{style:{padding:16,textAlign:"center",color:"var(--text-muted)"},children:"No users found"}):B.map(ee=>m.jsxs(dn,{to:`/messages/${ee.id}`,className:"thread-item",style:{textDecoration:"none"},children:[m.jsx("div",{className:"thread-avatar",children:m.jsx("div",{className:"post-avatar-placeholder",children:(ee.first_name||ee.username||"?")[0].toUpperCase()})}),m.jsxs("div",{className:"thread-info",children:[m.jsxs("div",{className:"thread-name",children:[ee.first_name," ",ee.last_name||""]}),m.jsxs("div",{className:"thread-preview",children:["@",ee.username||ee.pnptv_id]})]})]},ee.id))}):g?m.jsx("div",{style:{textAlign:"center",padding:32},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):E.length===0?m.jsx("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:"No conversations yet. Search for users to start chatting."}):m.jsx("div",{className:"card",children:E.map(ee=>m.jsxs(dn,{to:`/messages/${ee.partner_id}`,className:"thread-item",style:{textDecoration:"none"},children:[m.jsx("div",{className:"thread-avatar",children:m.jsx("div",{className:"post-avatar-placeholder",children:(ee.partner_first_name||ee.partner_username||"?")[0].toUpperCase()})}),m.jsxs("div",{className:"thread-info",children:[m.jsxs("div",{className:"thread-name",children:[ee.partner_first_name," ",m.jsxs("span",{className:"post-author-handle",children:["@",ee.partner_username]})]}),m.jsx("div",{className:"thread-preview",children:ee.last_message||""})]}),m.jsxs("div",{className:"thread-meta",children:[m.jsx("div",{className:"thread-time",children:_q(ee.last_message_at)}),ee.unread>0&&m.jsx("div",{className:"thread-unread",children:ee.unread})]})]},ee.partner_id))})]})}function gq(E){const f=Date.now()-new Date(E).getTime(),g=Math.floor(f/6e4);if(g<1)return"now";if(g<60)return`${g}m`;const C=Math.floor(g/60);return C<24?`${C}h`:`${Math.floor(C/24)}d`}function Sq(){const{partnerId:E}=dk(),{user:f}=$i(),[g,C]=W.useState(null),[D,U]=W.useState([]),[B,te]=W.useState(""),z=W.useRef(null),_e=W.useCallback(Te=>{(Te.sender_id===E||Te.sender?.id===E)&&U(Se=>[...Se,Te])},[E]),{sendDM:ne,sendTyping:ee,connected:q}=Bz(_e);W.useEffect(()=>{Promise.all([Me.getDMPartnerInfo(E),Me.getConversation(E)]).then(([Te,Se])=>{C(Te.user),U(Se.messages||[])}).catch(()=>{})},[E]),W.useEffect(()=>{z.current?.scrollIntoView({behavior:"smooth"})},[D]);const ce=async()=>{const Te=B.trim();if(Te)if(U(Se=>[...Se,{id:`tmp-${Date.now()}`,sender_id:f.id,recipient_id:E,content:Te,created_at:new Date().toISOString()}]),te(""),q)ne(E,Te);else try{await Me.sendDMRest(E,Te)}catch{}},ae=Te=>{Te.key==="Enter"&&!Te.shiftKey?(Te.preventDefault(),ce()):ee(E)};return m.jsxs(Un,{children:[m.jsxs("div",{className:"conv-header",children:[m.jsx(dn,{to:"/messages",className:"conv-back-btn",children:m.jsx(PY,{size:20})}),m.jsxs("div",{className:"conv-partner-name",children:[g?g.first_name||g.username:"Loading...",g?.username&&m.jsxs("span",{className:"post-author-handle",children:[" @",g.username]})]})]}),m.jsxs("div",{className:"conv-messages",children:[D.map((Te,Se)=>m.jsxs("div",{className:`dm-message ${Te.sender_id===f?.id?"own":"other"}`,children:[m.jsx("div",{className:"dm-bubble",children:Te.content}),m.jsx("div",{className:"dm-time",children:gq(Te.created_at)})]},Te.id||Se)),m.jsx("div",{ref:z})]}),m.jsxs("div",{className:"conv-input-row",children:[m.jsx("input",{type:"text",value:B,onChange:Te=>te(Te.target.value),onKeyDown:ae,placeholder:"Message...",maxLength:2e3,className:"chat-input",style:{flex:1}}),m.jsx("button",{onClick:ce,disabled:!B.trim(),className:"chat-send-btn",children:m.jsx($S,{size:16})})]})]})}function Tq(){const[E,f]=W.useState(null),[g,C]=W.useState(!0),[D,U]=W.useState("");if(W.useEffect(()=>{let _e=!1;return Me.getAdminStats().then(ne=>{_e||f(ne.stats)}).catch(ne=>{_e||U(ne.message||"Failed to load stats")}).finally(()=>{_e||C(!1)}),()=>{_e=!0}},[]),g)return m.jsx(Un,{children:m.jsxs("div",{style:{textAlign:"center",padding:48},children:[m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}}),m.jsx("p",{style:{marginTop:12,color:"var(--text-muted)"},children:"Loading admin dashboard..."})]})});if(D)return m.jsx(Un,{children:m.jsxs("div",{className:"card",style:{padding:24,color:"#ff453a"},children:[m.jsx(Zc,{size:24,style:{display:"inline",marginRight:8}}),D]})});const B=E?.payments||{},te=E?.revenue?.monthly||{},z=E?.membership?.totals||{};return m.jsx(Un,{children:m.jsxs("div",{style:{marginBottom:32},children:[m.jsx("h1",{style:{fontSize:24,marginBottom:24},children:"Admin Dashboard"}),m.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:16,marginBottom:32},children:[m.jsx("div",{className:"card",style:{padding:16},children:m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[m.jsxs("div",{children:[m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:4},children:"Total Users"}),m.jsx("div",{style:{fontSize:20,fontWeight:"700"},children:z.total_active_users||0})]}),m.jsx(Ia,{size:32,style:{color:"var(--accent)",opacity:.5}})]})}),m.jsx("div",{className:"card",style:{padding:16},children:m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[m.jsxs("div",{children:[m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:4},children:"Active Subscribers"}),m.jsx("div",{style:{fontSize:20,fontWeight:"700"},children:z.active_subscribers||0})]}),m.jsx(LY,{size:32,style:{color:"#34C759",opacity:.5}})]})}),m.jsx("div",{className:"card",style:{padding:16},children:m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[m.jsxs("div",{children:[m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:4},children:"Monthly Revenue"}),m.jsxs("div",{style:{fontSize:20,fontWeight:"700"},children:["$",(te.monthly_revenue||0).toFixed(0)]})]}),m.jsx(kY,{size:32,style:{color:"#FF9500",opacity:.5}})]})}),m.jsx("div",{className:"card",style:{padding:16},children:m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[m.jsxs("div",{children:[m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:4},children:"Churned"}),m.jsx("div",{style:{fontSize:20,fontWeight:"700"},children:z.churned_users||0})]}),m.jsx(Zc,{size:32,style:{color:"#FF453A",opacity:.5}})]})})]}),m.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:12,marginBottom:32},children:[m.jsxs(dn,{to:"/admin/users",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[m.jsx("span",{style:{fontWeight:"600"},children:"Manage Users"}),m.jsx(Ia,{size:20,style:{color:"var(--accent)"}})]}),m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"Search, ban, edit users"})]}),m.jsxs(dn,{to:"/admin/posts",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[m.jsx("span",{style:{fontWeight:"600"},children:"Moderate Posts"}),m.jsx(Zc,{size:20,style:{color:"#FF9500"}})]}),m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"Delete inappropriate content"})]}),m.jsxs(dn,{to:"/admin/hangouts",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[m.jsx("span",{style:{fontWeight:"600"},children:"Manage Hangouts"}),m.jsx(Ia,{size:20,style:{color:"#34C759"}})]}),m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"View and end rooms"})]}),m.jsxs(dn,{to:"/admin/media",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[m.jsx("span",{style:{fontWeight:"600"},children:"Manage Media"}),m.jsx(eT,{size:20,style:{color:"#5E6BFF"}})]}),m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"Upload, edit, delete media"})]}),m.jsxs(dn,{to:"/admin/radio",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[m.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[m.jsx("span",{style:{fontWeight:"600"},children:"Radio Control"}),m.jsx(rm,{size:20,style:{color:"#FF6B9D"}})]}),m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"Now playing, queue, requests"})]})]}),E?.payments&&m.jsxs("div",{className:"card",style:{padding:16},children:[m.jsx("h3",{style:{fontSize:14,fontWeight:"600",marginBottom:12},children:"Payment Stats"}),m.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(140px, 1fr))",gap:12},children:[m.jsxs("div",{children:[m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Total Payments"}),m.jsx("div",{style:{fontSize:18,fontWeight:"700"},children:B.total_payments||0})]}),m.jsxs("div",{children:[m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Completed"}),m.jsx("div",{style:{fontSize:18,fontWeight:"700",color:"#34C759"},children:B.completed||0})]}),m.jsxs("div",{children:[m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Failed"}),m.jsx("div",{style:{fontSize:18,fontWeight:"700",color:"#FF453A"},children:B.failed||0})]}),m.jsxs("div",{children:[m.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Avg Transaction"}),m.jsxs("div",{style:{fontSize:18,fontWeight:"700"},children:["$",(B.avg_transaction||0).toFixed(2)]})]})]})]})]})})}function yq(){const[E,f]=W.useState([]),[g,C]=W.useState(!0),[D,U]=W.useState(""),[B,te]=W.useState(""),[z,_e]=W.useState(1),[ne,ee]=W.useState({total:0,totalPages:0}),[q,ce]=W.useState(null),[ae,Te]=W.useState(!1),[Se,xe]=W.useState({}),[it,dt]=W.useState(!1),Fe=(oe=1)=>{C(!0),U(""),Me.listAdminUsers(oe,B).then(Lt=>{f(Lt.users||[]),ee(Lt.pagination||{}),_e(oe)}).catch(Lt=>U(Lt.message||"Failed to load users")).finally(()=>C(!1))};W.useEffect(()=>{Fe(1)},[B]);const Ht=oe=>{ce(oe),xe({username:oe.username,email:oe.email,subscriptionStatus:oe.subscription_status}),Te(!0)},et=async()=>{dt(!0);try{await Me.updateAdminUser(q.id,Se),Te(!1),Fe(z)}catch(oe){U(oe.message||"Failed to save user")}finally{dt(!1)}},be=async(oe,Lt)=>{if(confirm(`Are you sure you want to ${Lt?"ban":"unban"} this user?`))try{await Me.banAdminUser(oe,Lt,"Admin action"),Fe(z)}catch(Rn){U(Rn.message||"Failed to ban user")}};return m.jsxs(Un,{children:[m.jsxs("div",{style:{marginBottom:32},children:[m.jsx("h1",{style:{fontSize:24,marginBottom:24},children:"User Management"}),m.jsx("div",{style:{marginBottom:24},children:m.jsxs("div",{style:{position:"relative",marginBottom:16},children:[m.jsx(am,{size:18,style:{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",color:"var(--text-muted)"}}),m.jsx("input",{type:"text",placeholder:"Search users by username, email...",value:B,onChange:oe=>te(oe.target.value),style:{width:"100%",paddingLeft:40,paddingRight:16,paddingTop:12,paddingBottom:12,border:"1px solid var(--border-subtle)",borderRadius:"var(--radius-md)",backgroundColor:"var(--surface-2)",color:"var(--text-primary)",fontSize:14}})]})}),D&&m.jsxs("div",{className:"card",style:{padding:16,marginBottom:24,color:"#ff453a"},children:[m.jsx(Zc,{size:18,style:{display:"inline",marginRight:8}}),D]}),g?m.jsx("div",{style:{textAlign:"center",padding:48},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):E.length===0?m.jsx("div",{className:"card",style:{padding:24,textAlign:"center",color:"var(--text-muted)"},children:"No users found"}):m.jsxs(m.Fragment,{children:[m.jsx("div",{className:"card",style:{overflow:"x-auto"},children:m.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:13},children:[m.jsx("thead",{children:m.jsxs("tr",{style:{borderBottom:"1px solid var(--border-subtle)"},children:[m.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Username"}),m.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Email"}),m.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Role"}),m.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Status"}),m.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Sub Status"}),m.jsx("th",{style:{padding:12,textAlign:"center",color:"var(--text-muted)",fontWeight:"600"},children:"Actions"})]})}),m.jsx("tbody",{children:E.map(oe=>m.jsxs("tr",{style:{borderBottom:"1px solid var(--border-subtle)"},children:[m.jsx("td",{style:{padding:12},children:oe.username}),m.jsx("td",{style:{padding:12,fontSize:12,color:"var(--text-muted)"},children:oe.email}),m.jsx("td",{style:{padding:12},children:m.jsx("span",{style:{fontSize:11,backgroundColor:"var(--surface-2)",padding:"4px 8px",borderRadius:4},children:oe.role||"user"})}),m.jsx("td",{style:{padding:12},children:oe.status||"active"}),m.jsx("td",{style:{padding:12},children:oe.subscription_status||"free"}),m.jsxs("td",{style:{padding:12,display:"flex",gap:8,justifyContent:"center"},children:[m.jsx("button",{onClick:()=>Ht(oe),style:{background:"none",border:"none",color:"var(--accent)",cursor:"pointer",padding:4,display:"flex",alignItems:"center",gap:4},title:"Edit user",children:m.jsx(tT,{size:14})}),m.jsx("button",{onClick:()=>be(oe.id,oe.status!=="banned"),style:{background:"none",border:"none",color:oe.status==="banned"?"#34C759":"#FF453A",cursor:"pointer",padding:4,display:"flex",alignItems:"center",gap:4},title:oe.status==="banned"?"Unban user":"Ban user",children:m.jsx(xY,{size:14})})]})]},oe.id))})]})}),ne.totalPages>1&&m.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginTop:24},children:Array.from({length:ne.totalPages},(oe,Lt)=>Lt+1).map(oe=>m.jsx("button",{onClick:()=>Fe(oe),style:{padding:"8px 12px",border:z===oe?"1px solid var(--accent)":"1px solid var(--border-subtle)",backgroundColor:z===oe?"var(--accent)":"transparent",color:z===oe?"#fff":"var(--text-primary)",borderRadius:4,cursor:"pointer",fontSize:12},children:oe},oe))})]})]}),ae&&q&&m.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:m.jsxs("div",{className:"card",style:{padding:24,maxWidth:400,width:"90%"},children:[m.jsx("h2",{style:{fontSize:18,marginBottom:16},children:"Edit User"}),m.jsxs("div",{style:{marginBottom:12},children:[m.jsx("label",{style:{fontSize:12,color:"var(--text-muted)",display:"block",marginBottom:4},children:"Username"}),m.jsx("input",{type:"text",value:Se.username,onChange:oe=>xe({...Se,username:oe.target.value}),className:"profile-edit-input"})]}),m.jsxs("div",{style:{marginBottom:12},children:[m.jsx("label",{style:{fontSize:12,color:"var(--text-muted)",display:"block",marginBottom:4},children:"Email"}),m.jsx("input",{type:"email",value:Se.email,onChange:oe=>xe({...Se,email:oe.target.value}),className:"profile-edit-input"})]}),m.jsxs("div",{style:{marginBottom:16},children:[m.jsx("label",{style:{fontSize:12,color:"var(--text-muted)",display:"block",marginBottom:4},children:"Subscription Status"}),m.jsxs("select",{value:Se.subscriptionStatus||"",onChange:oe=>xe({...Se,subscriptionStatus:oe.target.value}),className:"profile-edit-input",children:[m.jsx("option",{value:"free",children:"Free"}),m.jsx("option",{value:"active",children:"Active"}),m.jsx("option",{value:"expired",children:"Expired"}),m.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),m.jsxs("div",{style:{display:"flex",gap:8},children:[m.jsx("button",{onClick:()=>Te(!1),className:"btn-secondary",style:{flex:1},disabled:it,children:"Cancel"}),m.jsx("button",{onClick:et,className:"btn-primary",style:{flex:1},disabled:it,children:it?"Saving...":"Save"})]})]})})]})}function vq(){const[E,f]=W.useState([]),[g,C]=W.useState(!0),[D,U]=W.useState(""),[B,te]=W.useState(1),[z,_e]=W.useState({total:0,totalPages:0}),ne=(q=1)=>{C(!0),Me.listAdminPosts(q).then(ce=>{f(ce.posts||[]),_e(ce.pagination||{}),te(q)}).catch(ce=>U(ce.message||"Failed to load posts")).finally(()=>C(!1))};W.useEffect(()=>{ne(1)},[]);const ee=async q=>{if(confirm("Delete this post?"))try{await Me.deleteAdminPost(q),ne(B)}catch(ce){U(ce.message||"Failed to delete post")}};return m.jsx(Un,{children:m.jsxs("div",{style:{marginBottom:32},children:[m.jsx("h1",{style:{fontSize:24,marginBottom:24},children:"Moderate Posts"}),D&&m.jsxs("div",{className:"card",style:{padding:16,marginBottom:24,color:"#ff453a"},children:[m.jsx(Zc,{size:18,style:{display:"inline",marginRight:8}}),D]}),g?m.jsx("div",{style:{textAlign:"center",padding:48},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):E.length===0?m.jsx("div",{className:"card",style:{padding:24,textAlign:"center",color:"var(--text-muted)"},children:"No posts to moderate"}):m.jsxs(m.Fragment,{children:[E.map(q=>m.jsxs("div",{className:"card",style:{padding:16,marginBottom:12},children:[m.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"start",marginBottom:8},children:[m.jsxs("div",{children:[m.jsx("div",{style:{fontWeight:"600",marginBottom:4},children:q.username}),m.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:[new Date(q.created_at).toLocaleDateString()," ",new Date(q.created_at).toLocaleTimeString()]})]}),m.jsx("button",{onClick:()=>ee(q.id),style:{background:"none",border:"none",color:"#FF453A",cursor:"pointer",padding:8},title:"Delete post",children:m.jsx(sm,{size:18})})]}),m.jsxs("div",{style:{color:"var(--text-primary)",lineHeight:1.5,wordBreak:"break-word"},children:[q.content.substring(0,300),q.content.length>300?"...":""]}),m.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:[" ",q.likes||0,"   ",q.replies||0]})]},q.id)),z.totalPages>1&&m.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginTop:24},children:Array.from({length:z.totalPages},(q,ce)=>ce+1).map(q=>m.jsx("button",{onClick:()=>ne(q),style:{padding:"8px 12px",border:B===q?"1px solid var(--accent)":"1px solid var(--border-subtle)",backgroundColor:B===q?"var(--accent)":"transparent",color:B===q?"#fff":"var(--text-primary)",borderRadius:4,cursor:"pointer",fontSize:12},children:q},q))})]})]})})}function Rq(){const[E,f]=W.useState([]),[g,C]=W.useState(!0),[D,U]=W.useState(""),B=()=>{C(!0),Me.listAdminHangouts().then(z=>f(z.hangouts||[])).catch(z=>U(z.message||"Failed to load hangouts")).finally(()=>C(!1))};W.useEffect(()=>{B();const z=setInterval(B,1e4);return()=>clearInterval(z)},[]);const te=async z=>{if(confirm("End this hangout room?"))try{await Me.endAdminHangout(z),B()}catch(_e){U(_e.message||"Failed to end hangout")}};return m.jsx(Un,{children:m.jsxs("div",{style:{marginBottom:32},children:[m.jsx("h1",{style:{fontSize:24,marginBottom:24},children:"Manage Hangouts"}),D&&m.jsxs("div",{className:"card",style:{padding:16,marginBottom:24,color:"#ff453a"},children:[m.jsx(Zc,{size:18,style:{display:"inline",marginRight:8}}),D]}),g?m.jsx("div",{style:{textAlign:"center",padding:48},children:m.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):E.length===0?m.jsx("div",{className:"card",style:{padding:24,textAlign:"center",color:"var(--text-muted)"},children:"No active hangout rooms"}):m.jsx(m.Fragment,{children:E.map(z=>m.jsx("div",{className:"card",style:{padding:16,marginBottom:12},children:m.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"start",marginBottom:8},children:[m.jsxs("div",{style:{flex:1},children:[m.jsx("div",{style:{fontWeight:"600",fontSize:14,marginBottom:4},children:z.title||"Untitled Room"}),m.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:8},children:["Created by: ",z.creatorName]}),m.jsxs("div",{style:{display:"flex",gap:16,fontSize:12},children:[m.jsxs("div",{children:[m.jsx(Ia,{size:14,style:{display:"inline",marginRight:4}}),z.currentParticipants," / ",z.maxParticipants," participants"]}),m.jsx("div",{children:z.isPublic?" Public":" Private"}),m.jsxs("div",{style:{color:"var(--text-muted)"},children:["Created: ",new Date(z.createdAt).toLocaleDateString()]})]})]}),m.jsxs("button",{onClick:()=>te(z.id),style:{background:"none",border:"none",color:"#FF453A",cursor:"pointer",padding:8,display:"flex",alignItems:"center",gap:6,fontSize:12},title:"End hangout",children:[m.jsx(MY,{size:18}),"End Room"]})]})},z.id))})]})})}function Pk({children:E}){const{user:f,loading:g}=$i();return g?m.jsxs("div",{className:"loading-screen",children:[m.jsx("div",{className:"loading-spinner"}),m.jsx("p",{children:"Loading..."})]}):f?["admin","superadmin"].includes(f.role)?E:m.jsx(QS,{to:"/",replace:!0}):(window.location.replace("/"),null)}function Cq(){const[E,f]=W.useState([]),[g,C]=W.useState([]),[D,U]=W.useState(!1),[B,te]=W.useState(1),[z,_e]=W.useState(0),[ne,ee]=W.useState("all"),[q,ce]=W.useState(""),[ae,Te]=W.useState(""),[Se,xe]=W.useState(!1),[it,dt]=W.useState(null),[Fe,Ht]=W.useState({}),et=20;W.useEffect(()=>{be(),oe()},[B,ne,q,ae]);const be=async()=>{U(!0);try{const Qe=new URLSearchParams({page:B.toString(),limit:et.toString(),type:ne,...q&&{category:q},...ae&&{search:ae}}),at=await Me.getAdminMedia(`?${Qe}`);f(at.media||[]),_e(at.pagination?.total||0)}catch(Qe){console.error("Failed to load media:",Qe),alert("Failed to load media library")}finally{U(!1)}},oe=async()=>{try{const Qe=await Me.getAdminMediaCategories();C(Qe.categories||[])}catch(Qe){console.error("Failed to load categories:",Qe)}},Lt=async Qe=>{if(confirm("Are you sure you want to delete this media?"))try{await Me.deleteAdminMedia(Qe),f(E.filter(at=>at.id!==Qe))}catch(at){console.error("Failed to delete media:",at),alert("Failed to delete media")}},Rn=Qe=>{dt(Qe.id),Ht({title:Qe.title,artist:Qe.artist,description:Qe.description,category:Qe.category,isExplicit:Qe.is_explicit})},ot=async Qe=>{try{const at=await Me.updateAdminMedia(Qe,Fe);f(E.map(Rr=>Rr.id===Qe?at.media:Rr)),dt(null)}catch(at){console.error("Failed to update media:",at),alert("Failed to update media")}},ln=async Qe=>{const at=Qe.target.files?.[0];if(!at)return;const Rr=new FormData;Rr.append("file",at),Rr.append("title",prompt("Enter media title:")||at.name),Rr.append("artist",prompt("Enter artist/uploader:")||"Unknown"),Rr.append("category",q||"general"),Rr.append("type",at.type.startsWith("video/")?"video":"audio");try{U(!0);const Fs=await Me.uploadAdminMedia(Rr);f([Fs.media,...E]),xe(!1)}catch(Fs){console.error("Failed to upload media:",Fs),alert("Failed to upload media")}finally{U(!1)}};return m.jsx(Pk,{children:m.jsxs("div",{className:"admin-page",children:[m.jsxs("div",{className:"admin-header",children:[m.jsx("h1",{children:"Media Management"}),m.jsxs("button",{className:"btn btn-primary",onClick:()=>xe(!Se),disabled:D,children:[m.jsx(UY,{size:16}),"Upload Media"]})]}),Se&&m.jsxs("div",{className:"card",style:{marginBottom:"20px"},children:[m.jsx("h3",{children:"Upload Media"}),m.jsx("input",{type:"file",accept:"audio/*,video/*",onChange:ln,disabled:D,style:{marginBottom:"10px"}})]}),m.jsxs("div",{className:"filters",children:[m.jsxs("select",{value:ne,onChange:Qe=>{ee(Qe.target.value),te(1)},children:[m.jsx("option",{value:"all",children:"All Types"}),m.jsx("option",{value:"audio",children:"Audio"}),m.jsx("option",{value:"video",children:"Video"})]}),m.jsxs("select",{value:q,onChange:Qe=>{ce(Qe.target.value),te(1)},children:[m.jsx("option",{value:"",children:"All Categories"}),g.map(Qe=>m.jsx("option",{value:Qe,children:Qe},Qe))]}),m.jsx("input",{type:"text",placeholder:"Search media...",value:ae,onChange:Qe=>{Te(Qe.target.value),te(1)}})]}),m.jsx("div",{className:"media-grid",children:D?m.jsx("p",{children:"Loading..."}):E.length===0?m.jsx("p",{children:"No media found"}):E.map(Qe=>m.jsx("div",{className:"media-card",children:it===Qe.id?m.jsxs("div",{className:"edit-form",children:[m.jsx("input",{type:"text",value:Fe.title,onChange:at=>Ht({...Fe,title:at.target.value}),placeholder:"Title"}),m.jsx("input",{type:"text",value:Fe.artist,onChange:at=>Ht({...Fe,artist:at.target.value}),placeholder:"Artist"}),m.jsx("textarea",{value:Fe.description||"",onChange:at=>Ht({...Fe,description:at.target.value}),placeholder:"Description"}),m.jsx("select",{value:Fe.category,onChange:at=>Ht({...Fe,category:at.target.value}),children:g.map(at=>m.jsx("option",{value:at,children:at},at))}),m.jsxs("label",{children:[m.jsx("input",{type:"checkbox",checked:Fe.isExplicit,onChange:at=>Ht({...Fe,isExplicit:at.target.checked})}),"Explicit Content"]}),m.jsxs("div",{className:"button-group",children:[m.jsx("button",{onClick:()=>ot(Qe.id),className:"btn btn-success",children:"Save"}),m.jsx("button",{onClick:()=>dt(null),className:"btn btn-secondary",children:"Cancel"})]})]}):m.jsxs(m.Fragment,{children:[Qe.cover_url&&m.jsx("img",{src:Qe.cover_url,alt:Qe.title,className:"media-cover"}),m.jsxs("div",{className:"media-info",children:[m.jsx("h4",{children:Qe.title}),m.jsx("p",{className:"artist",children:Qe.artist}),m.jsxs("p",{className:"meta",children:[Qe.type.toUpperCase(),"  ",Qe.category,"  ",Qe.duration||0,"s"]}),Qe.is_explicit&&m.jsx("span",{className:"badge-explicit",children:"Explicit"})]}),m.jsxs("div",{className:"media-actions",children:[m.jsx("button",{onClick:()=>Rn(Qe),className:"btn btn-small",title:"Edit",children:m.jsx(tT,{size:16})}),m.jsx("button",{onClick:()=>Lt(Qe.id),className:"btn btn-small btn-danger",title:"Delete",children:m.jsx(sm,{size:16})})]})]})},Qe.id))}),m.jsxs("div",{className:"pagination",children:[m.jsx("button",{onClick:()=>te(Math.max(1,B-1)),disabled:B===1,children:"Previous"}),m.jsxs("span",{children:["Page ",B," of ",Math.ceil(z/et)]}),m.jsx("button",{onClick:()=>te(B+1),disabled:B>=Math.ceil(z/et),children:"Next"})]}),m.jsx("style",{jsx:!0,children:`
          .admin-page {
            padding: 20px;
          }
          .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          }
          .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
          }
          .filters select,
          .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
          }
          .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
          }
          .media-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            background: white;
          }
          .media-cover {
            width: 100%;
            height: 150px;
            object-fit: cover;
          }
          .media-info {
            padding: 12px;
          }
          .media-info h4 {
            margin: 0 0 4px;
            font-size: 14px;
            font-weight: 600;
          }
          .artist {
            margin: 0 0 8px;
            font-size: 12px;
            color: #666;
          }
          .meta {
            margin: 0;
            font-size: 11px;
            color: #999;
          }
          .badge-explicit {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 4px;
          }
          .media-actions {
            display: flex;
            gap: 5px;
            padding: 8px;
            border-top: 1px solid #eee;
          }
          .edit-form {
            padding: 12px;
          }
          .edit-form input,
          .edit-form textarea,
          .edit-form select {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
          }
          .button-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
          }
          .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
          }
          .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
          }
          .btn-primary {
            background: #0070f3;
            color: white;
          }
          .btn-small {
            padding: 6px 8px;
            font-size: 11px;
          }
          .btn-danger {
            background: #ff6b6b;
            color: white;
          }
          .card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: white;
          }
        `})]})})}function bq(){const[E,f]=W.useState(null),[g,C]=W.useState([]),[D,U]=W.useState([]),[B,te]=W.useState([]),[z,_e]=W.useState("now-playing"),[ne,ee]=W.useState(!1),[q,ce]=W.useState(!1),[ae,Te]=W.useState("");W.useEffect(()=>{Se()},[]);const Se=async()=>{ee(!0);try{const[oe,Lt,Rn]=await Promise.all([Me.getAdminRadioNowPlaying(),Me.getAdminRadioQueue(),Me.getAdminRadioRequests()]);f(oe.nowPlaying),C(Lt.queue||[]),U(Rn.requests||[])}catch(oe){console.error("Failed to load radio data:",oe),alert("Failed to load radio data")}finally{ee(!1)}},xe=async()=>{try{const oe=await Me.getAdminMedia("?limit=50&type=audio");te(oe.media||[])}catch(oe){console.error("Failed to load media:",oe)}},it=async oe=>{try{const Lt=await Me.setAdminRadioNowPlaying({mediaId:oe});f(Lt.nowPlaying),ce(!1)}catch(Lt){console.error("Failed to set now playing:",Lt),alert("Failed to set now playing")}},dt=async oe=>{try{const Lt=await Me.addAdminRadioQueue({mediaId:oe});C([...g,Lt.queueItem])}catch(Lt){console.error("Failed to add to queue:",Lt),alert("Failed to add to queue")}},Fe=async oe=>{try{await Me.removeAdminRadioQueue(oe),C(g.filter(Lt=>Lt.id!==oe))}catch(Lt){console.error("Failed to remove from queue:",Lt),alert("Failed to remove from queue")}},Ht=async()=>{if(confirm("Clear entire queue?"))try{await Me.clearAdminRadioQueue(),C([])}catch(oe){console.error("Failed to clear queue:",oe),alert("Failed to clear queue")}},et=async(oe,Lt)=>{try{await Me.updateAdminRadioRequest(oe,{status:Lt}),U(D.map(Rn=>Rn.id===oe?{...Rn,status:Lt}:Rn))}catch(Rn){console.error("Failed to update request:",Rn),alert("Failed to update request")}},be=B.filter(oe=>oe.title.toLowerCase().includes(ae.toLowerCase())||oe.artist.toLowerCase().includes(ae.toLowerCase()));return m.jsx(Pk,{children:m.jsxs("div",{className:"admin-page",children:[m.jsxs("div",{className:"admin-header",children:[m.jsx("h1",{children:"Radio Management"}),m.jsx("button",{onClick:Se,disabled:ne,className:"btn btn-secondary",children:"Refresh"})]}),m.jsx("div",{className:"tabs",children:["now-playing","queue","requests"].map(oe=>m.jsxs("button",{className:`tab-button ${z===oe?"active":""}`,onClick:()=>_e(oe),children:[oe==="now-playing"&&"Now Playing",oe==="queue"&&"Queue",oe==="requests"&&"Requests"]},oe))}),z==="now-playing"&&m.jsxs("div",{className:"card",children:[m.jsx("h2",{children:"Currently Playing"}),E?m.jsxs("div",{className:"now-playing-display",children:[E.cover_url&&m.jsx("img",{src:E.cover_url,alt:E.title,className:"cover"}),m.jsxs("div",{className:"info",children:[m.jsx("h3",{children:E.title}),m.jsx("p",{className:"artist",children:E.artist}),m.jsxs("p",{className:"duration",children:["Duration: ",E.duration||"N/A","s"]}),m.jsxs("p",{className:"started",children:["Started: ",new Date(E.started_at).toLocaleString()]})]})]}):m.jsx("p",{children:"No track currently playing"}),m.jsxs("button",{onClick:()=>{ce(!q),q||xe()},className:"btn btn-primary",style:{marginTop:"15px"},children:[m.jsx(VY,{size:16}),"Change Now Playing"]}),q&&m.jsxs("div",{className:"media-selection",style:{marginTop:"15px"},children:[m.jsx("input",{type:"text",placeholder:"Search media...",value:ae,onChange:oe=>Te(oe.target.value),className:"search-input"}),m.jsx("div",{className:"media-list",children:be.length===0?m.jsx("p",{children:"No media found"}):be.map(oe=>m.jsxs("div",{className:"media-item",children:[oe.cover_url&&m.jsx("img",{src:oe.cover_url,alt:oe.title}),m.jsxs("div",{className:"details",children:[m.jsx("h4",{children:oe.title}),m.jsx("p",{children:oe.artist})]}),m.jsx("button",{onClick:()=>it(oe.id),className:"btn btn-small btn-primary",children:"Play"})]},oe.id))})]})]}),z==="queue"&&m.jsxs("div",{className:"card",children:[m.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[m.jsxs("h2",{children:["Radio Queue (",g.length,")"]}),m.jsx("button",{onClick:Ht,className:"btn btn-danger",children:"Clear Queue"})]}),g.length===0?m.jsx("p",{children:"Queue is empty"}):m.jsx("div",{className:"queue-list",children:g.map((oe,Lt)=>m.jsxs("div",{className:"queue-item",children:[m.jsx("span",{className:"position",children:Lt+1}),oe.cover_url&&m.jsx("img",{src:oe.cover_url,alt:oe.title}),m.jsxs("div",{className:"queue-info",children:[m.jsx("h4",{children:oe.title}),m.jsx("p",{children:oe.artist})]}),m.jsx("button",{onClick:()=>Fe(oe.id),className:"btn btn-small btn-danger",children:m.jsx(sm,{size:14})})]},oe.id))}),m.jsxs("button",{onClick:()=>{ce(!q),q||xe()},className:"btn btn-primary",style:{marginTop:"15px"},children:[m.jsx(Ml,{size:16}),"Add to Queue"]}),q&&m.jsxs("div",{className:"media-selection",style:{marginTop:"15px"},children:[m.jsx("input",{type:"text",placeholder:"Search media...",value:ae,onChange:oe=>Te(oe.target.value),className:"search-input"}),m.jsx("div",{className:"media-list",children:be.length===0?m.jsx("p",{children:"No media found"}):be.map(oe=>m.jsxs("div",{className:"media-item",children:[oe.cover_url&&m.jsx("img",{src:oe.cover_url,alt:oe.title}),m.jsxs("div",{className:"details",children:[m.jsx("h4",{children:oe.title}),m.jsx("p",{children:oe.artist})]}),m.jsx("button",{onClick:()=>dt(oe.id),className:"btn btn-small btn-primary",children:"Add"})]},oe.id))})]})]}),z==="requests"&&m.jsxs("div",{className:"card",children:[m.jsx("h2",{children:"Song Requests"}),D.length===0?m.jsx("p",{children:"No pending requests"}):m.jsxs("div",{className:"requests-list",children:[D.filter(oe=>oe.status==="pending").map(oe=>m.jsxs("div",{className:"request-item",children:[m.jsxs("div",{children:[m.jsx("h4",{children:oe.song_name}),m.jsx("p",{className:"artist",children:oe.artist||"Unknown Artist"}),m.jsxs("p",{className:"requester",children:["Requested by User ",oe.user_id.substring(0,8)]})]}),m.jsxs("div",{className:"request-actions",children:[m.jsx("button",{onClick:()=>et(oe.id,"approved"),className:"btn btn-small btn-success",children:"Approve"}),m.jsx("button",{onClick:()=>et(oe.id,"rejected"),className:"btn btn-small btn-danger",children:"Reject"})]})]},oe.id)),D.filter(oe=>oe.status!=="pending").length>0&&m.jsxs("div",{style:{marginTop:"20px",paddingTop:"20px",borderTop:"1px solid #eee"},children:[m.jsx("h3",{children:"History"}),D.filter(oe=>oe.status!=="pending").map(oe=>m.jsxs("div",{className:"request-item-history",children:[m.jsx("h4",{children:oe.song_name}),m.jsx("span",{className:`status-badge ${oe.status}`,children:oe.status})]},oe.id))]})]})]}),m.jsx("style",{jsx:!0,children:`
          .admin-page {
            padding: 20px;
          }
          .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          }
          .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
          }
          .tab-button {
            padding: 12px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
          }
          .tab-button.active {
            color: #0070f3;
            border-bottom-color: #0070f3;
          }
          .card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            background: white;
            margin-bottom: 20px;
          }
          .card h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
          }
          .now-playing-display {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 15px;
          }
          .now-playing-display .cover {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
          }
          .now-playing-display .info {
            flex: 1;
          }
          .now-playing-display h3 {
            margin: 0 0 10px;
            font-size: 20px;
          }
          .now-playing-display .artist {
            margin: 0 0 10px;
            color: #666;
          }
          .now-playing-display .duration,
          .now-playing-display .started {
            margin: 0;
            font-size: 12px;
            color: #999;
          }
          .media-selection {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
          }
          .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
          }
          .media-list {
            max-height: 400px;
            overflow-y: auto;
          }
          .media-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
            background: white;
          }
          .media-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
          }
          .media-item .details {
            flex: 1;
          }
          .media-item h4 {
            margin: 0 0 4px;
            font-size: 14px;
          }
          .media-item p {
            margin: 0;
            font-size: 12px;
            color: #666;
          }
          .queue-list {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
          }
          .queue-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            background: white;
          }
          .queue-item:last-child {
            border-bottom: none;
          }
          .queue-item .position {
            width: 30px;
            text-align: center;
            font-weight: 600;
            color: #0070f3;
          }
          .queue-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
          }
          .queue-item .queue-info {
            flex: 1;
          }
          .queue-item h4 {
            margin: 0 0 4px;
            font-size: 14px;
          }
          .queue-item p {
            margin: 0;
            font-size: 12px;
            color: #666;
          }
          .requests-list {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
          }
          .request-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
          }
          .request-item:last-child {
            border-bottom: none;
          }
          .request-item h4 {
            margin: 0 0 4px;
            font-size: 14px;
          }
          .request-item .artist,
          .request-item .requester {
            margin: 0;
            font-size: 12px;
            color: #666;
          }
          .request-actions {
            display: flex;
            gap: 8px;
          }
          .request-item-history {
            padding: 10px;
            border-bottom: 1px solid #eee;
          }
          .request-item-history h4 {
            margin: 0 0 8px;
            font-size: 14px;
          }
          .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
          }
          .status-badge.approved {
            background: #d4edda;
            color: #155724;
          }
          .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
          }
          .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
          }
          .btn-primary {
            background: #0070f3;
            color: white;
          }
          .btn-secondary {
            background: #e0e0e0;
            color: #333;
          }
          .btn-danger {
            background: #ff6b6b;
            color: white;
          }
          .btn-success {
            background: #51cf66;
            color: white;
          }
          .btn-small {
            padding: 6px 8px;
            font-size: 11px;
          }
        `})]})})}function Iq(){const[E,f]=W.useState([]),[g,C]=W.useState([]),[D,U]=W.useState(!0),[B,te]=W.useState(""),[z,_e]=W.useState(1),[ne,ee]=W.useState(null),[q,ce]=W.useState(!1),[ae,Te]=W.useState(""),[Se,xe]=W.useState(""),[it,dt]=W.useState(!1),[Fe,Ht]=W.useState(0);W.useEffect(()=>{et()},[]),W.useEffect(()=>{B&&be()},[B,z]);const et=async()=>{try{const ot=await zp.getAdminRoles();C(ot.data),ot.data.length>0&&te(ot.data[0].name)}catch(ot){console.error("Error loading roles:",ot),alert("Error al cargar roles: "+ot.message)}},be=async()=>{U(!0);try{const ot=await zp.getAdminUsersByRole(B,z,20);f(ot.data.users),Ht(ot.data.total)}catch(ot){console.error("Error loading users:",ot),alert("Error al cargar usuarios: "+ot.message)}finally{U(!1)}},oe=ot=>{ee(ot),Te(ot.role||"user"),xe(""),ce(!0)},Lt=async()=>{if(!(!ne||!ae)){dt(!0);try{await zp.assignAdminUserRole(ne.id,ae,Se),alert(" Rol asignado exitosamente"),ce(!1),be(),et()}catch(ot){alert(" Error al asignar rol: "+ot.message)}finally{dt(!1)}}},Rn=Math.ceil(Fe/20);return m.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[m.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Gestin de Roles"}),m.jsx("p",{className:"text-gray-600 mb-6",children:"Asigna y gestiona roles de usuarios en la plataforma"}),m.jsx("div",{className:"mb-6 flex gap-4",children:m.jsxs("select",{value:B,onChange:ot=>{te(ot.target.value),_e(1)},className:"px-4 py-2 border border-gray-300 rounded-lg bg-white font-medium",children:[m.jsx("option",{value:"",children:"Selecciona un rol"}),g.map(ot=>m.jsxs("option",{value:ot.name,children:[ot.display_name," (",ot.user_count," usuarios)"]},ot.name))]})}),D?m.jsxs("div",{className:"text-center py-12 bg-white rounded-lg",children:[m.jsx("div",{className:"spinner-lg"}),m.jsx("p",{className:"text-gray-600 mt-4",children:"Cargando usuarios..."})]}):m.jsxs(m.Fragment,{children:[m.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:m.jsxs("table",{className:"w-full",children:[m.jsx("thead",{className:"bg-gray-100 border-b",children:m.jsxs("tr",{children:[m.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Email"}),m.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Username"}),m.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Rol Actual"}),m.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Status"}),m.jsx("th",{className:"px-6 py-3 text-right text-sm font-semibold",children:"Acciones"})]})}),m.jsx("tbody",{children:E.length===0?m.jsx("tr",{children:m.jsx("td",{colSpan:"5",className:"px-6 py-8 text-center text-gray-500",children:"No hay usuarios con este rol"})}):E.map(ot=>m.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[m.jsx("td",{className:"px-6 py-4 text-sm font-medium",children:ot.email}),m.jsx("td",{className:"px-6 py-4 text-sm",children:ot.username||"-"}),m.jsx("td",{className:"px-6 py-4 text-sm",children:m.jsx("span",{className:"inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium",children:ot.display_name})}),m.jsx("td",{className:"px-6 py-4 text-sm",children:m.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${ot.status==="active"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:ot.status})}),m.jsx("td",{className:"px-6 py-4 text-right",children:m.jsx("button",{onClick:()=>oe(ot),className:"text-blue-600 hover:text-blue-900 font-medium text-sm",children:"Cambiar Rol"})})]},ot.id))})]})}),E.length>0&&m.jsxs("div",{className:"mt-6 flex justify-between items-center",children:[m.jsxs("p",{className:"text-sm text-gray-600",children:["Mostrando ",(z-1)*20+1," a ",Math.min(z*20,Fe)," de ",Fe," usuarios"]}),m.jsxs("div",{className:"flex gap-2",children:[m.jsx("button",{onClick:()=>_e(Math.max(1,z-1)),disabled:z===1,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:" Anterior"}),m.jsxs("span",{className:"px-4 py-2 font-medium",children:[z," de ",Rn]}),m.jsx("button",{onClick:()=>_e(Math.min(Rn,z+1)),disabled:z===Rn,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:"Siguiente "})]})]})]}),q&&ne&&m.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:m.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[m.jsxs("h2",{className:"text-xl font-bold mb-4",children:["Cambiar rol de ",m.jsx("span",{className:"text-blue-600",children:ne.email})]}),m.jsxs("div",{className:"mb-4",children:[m.jsx("label",{className:"block text-sm font-medium mb-2",children:"Nuevo Rol"}),m.jsx("select",{value:ae,onChange:ot=>Te(ot.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg font-medium",children:g.map(ot=>m.jsx("option",{value:ot.name,children:ot.display_name},ot.name))})]}),m.jsxs("div",{className:"mb-4",children:[m.jsx("label",{className:"block text-sm font-medium mb-2",children:"Razn (Opcional)"}),m.jsx("textarea",{value:Se,onChange:ot=>xe(ot.target.value),placeholder:"Ej: Promocin a moderador por buen comportamiento",className:"w-full px-4 py-2 border border-gray-300 rounded-lg text-sm",rows:"3"})]}),m.jsxs("div",{className:"flex gap-3",children:[m.jsx("button",{onClick:()=>ce(!1),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium",children:"Cancelar"}),m.jsx("button",{onClick:Lt,disabled:it,className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium",children:it?"Guardando...":"Guardar"})]})]})})]})}const Lk=6048e5,wq=864e5,$L=Symbol.for("constructDateFrom");function wo(E,f){return typeof E=="function"?E(f):E&&typeof E=="object"&&$L in E?E[$L](f):E instanceof Date?new E.constructor(f):new Date(f)}function Jr(E,f){return wo(f||E,E)}let Aq={};function lm(){return Aq}function Ul(E,f){const g=lm(),C=f?.weekStartsOn??f?.locale?.options?.weekStartsOn??g.weekStartsOn??g.locale?.options?.weekStartsOn??0,D=Jr(E,f?.in),U=D.getDay(),B=(U<C?7:0)+U-C;return D.setDate(D.getDate()-B),D.setHours(0,0,0,0),D}function nm(E,f){return Ul(E,{...f,weekStartsOn:1})}function kk(E,f){const g=Jr(E,f?.in),C=g.getFullYear(),D=wo(g,0);D.setFullYear(C+1,0,4),D.setHours(0,0,0,0);const U=nm(D),B=wo(g,0);B.setFullYear(C,0,4),B.setHours(0,0,0,0);const te=nm(B);return g.getTime()>=U.getTime()?C+1:g.getTime()>=te.getTime()?C:C-1}function ek(E){const f=Jr(E),g=new Date(Date.UTC(f.getFullYear(),f.getMonth(),f.getDate(),f.getHours(),f.getMinutes(),f.getSeconds(),f.getMilliseconds()));return g.setUTCFullYear(f.getFullYear()),+E-+g}function Oq(E,...f){const g=wo.bind(null,f.find(C=>typeof C=="object"));return f.map(g)}function tk(E,f){const g=Jr(E,f?.in);return g.setHours(0,0,0,0),g}function Nq(E,f,g){const[C,D]=Oq(g?.in,E,f),U=tk(C),B=tk(D),te=+U-ek(U),z=+B-ek(B);return Math.round((te-z)/wq)}function Dq(E,f){const g=kk(E,f),C=wo(E,0);return C.setFullYear(g,0,4),C.setHours(0,0,0,0),nm(C)}function Pq(E){return E instanceof Date||typeof E=="object"&&Object.prototype.toString.call(E)==="[object Date]"}function Lq(E){return!(!Pq(E)&&typeof E!="number"||isNaN(+Jr(E)))}function kq(E,f){const g=Jr(E,f?.in);return g.setFullYear(g.getFullYear(),0,1),g.setHours(0,0,0,0),g}const xq={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},Mq=(E,f,g)=>{let C;const D=xq[E];return typeof D=="string"?C=D:f===1?C=D.one:C=D.other.replace("{{count}}",f.toString()),g?.addSuffix?g.comparison&&g.comparison>0?"in "+C:C+" ago":C};function ed(E){return(f={})=>{const g=f.width?String(f.width):E.defaultWidth;return E.formats[g]||E.formats[E.defaultWidth]}}const Uq={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},Vq={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},jq={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},Fq={date:ed({formats:Uq,defaultWidth:"full"}),time:ed({formats:Vq,defaultWidth:"full"}),dateTime:ed({formats:jq,defaultWidth:"full"})},Bq={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},Wq=(E,f,g,C)=>Bq[E];function Ts(E){return(f,g)=>{const C=g?.context?String(g.context):"standalone";let D;if(C==="formatting"&&E.formattingValues){const B=E.defaultFormattingWidth||E.defaultWidth,te=g?.width?String(g.width):B;D=E.formattingValues[te]||E.formattingValues[B]}else{const B=E.defaultWidth,te=g?.width?String(g.width):E.defaultWidth;D=E.values[te]||E.values[B]}const U=E.argumentCallback?E.argumentCallback(f):f;return D[U]}}const Gq={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},Hq={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},Kq={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},Yq={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},zq={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},qq={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},Xq=(E,f)=>{const g=Number(E),C=g%100;if(C>20||C<10)switch(C%10){case 1:return g+"st";case 2:return g+"nd";case 3:return g+"rd"}return g+"th"},Jq={ordinalNumber:Xq,era:Ts({values:Gq,defaultWidth:"wide"}),quarter:Ts({values:Hq,defaultWidth:"wide",argumentCallback:E=>E-1}),month:Ts({values:Kq,defaultWidth:"wide"}),day:Ts({values:Yq,defaultWidth:"wide"}),dayPeriod:Ts({values:zq,defaultWidth:"wide",formattingValues:qq,defaultFormattingWidth:"wide"})};function ys(E){return(f,g={})=>{const C=g.width,D=C&&E.matchPatterns[C]||E.matchPatterns[E.defaultMatchWidth],U=f.match(D);if(!U)return null;const B=U[0],te=C&&E.parsePatterns[C]||E.parsePatterns[E.defaultParseWidth],z=Array.isArray(te)?Zq(te,ee=>ee.test(B)):Qq(te,ee=>ee.test(B));let _e;_e=E.valueCallback?E.valueCallback(z):z,_e=g.valueCallback?g.valueCallback(_e):_e;const ne=f.slice(B.length);return{value:_e,rest:ne}}}function Qq(E,f){for(const g in E)if(Object.prototype.hasOwnProperty.call(E,g)&&f(E[g]))return g}function Zq(E,f){for(let g=0;g<E.length;g++)if(f(E[g]))return g}function xk(E){return(f,g={})=>{const C=f.match(E.matchPattern);if(!C)return null;const D=C[0],U=f.match(E.parsePattern);if(!U)return null;let B=E.valueCallback?E.valueCallback(U[0]):U[0];B=g.valueCallback?g.valueCallback(B):B;const te=f.slice(D.length);return{value:B,rest:te}}}const $q=/^(\d+)(th|st|nd|rd)?/i,eX=/\d+/i,tX={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},nX={any:[/^b/i,/^(a|c)/i]},iX={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},rX={any:[/1/i,/2/i,/3/i,/4/i]},sX={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},oX={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},aX={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},cX={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},dX={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},lX={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},uX={ordinalNumber:xk({matchPattern:$q,parsePattern:eX,valueCallback:E=>parseInt(E,10)}),era:ys({matchPatterns:tX,defaultMatchWidth:"wide",parsePatterns:nX,defaultParseWidth:"any"}),quarter:ys({matchPatterns:iX,defaultMatchWidth:"wide",parsePatterns:rX,defaultParseWidth:"any",valueCallback:E=>E+1}),month:ys({matchPatterns:sX,defaultMatchWidth:"wide",parsePatterns:oX,defaultParseWidth:"any"}),day:ys({matchPatterns:aX,defaultMatchWidth:"wide",parsePatterns:cX,defaultParseWidth:"any"}),dayPeriod:ys({matchPatterns:dX,defaultMatchWidth:"any",parsePatterns:lX,defaultParseWidth:"any"})},hX={code:"en-US",formatDistance:Mq,formatLong:Fq,formatRelative:Wq,localize:Jq,match:uX,options:{weekStartsOn:0,firstWeekContainsDate:1}};function pX(E,f){const g=Jr(E,f?.in);return Nq(g,kq(g))+1}function mX(E,f){const g=Jr(E,f?.in),C=+nm(g)-+Dq(g);return Math.round(C/Lk)+1}function Mk(E,f){const g=Jr(E,f?.in),C=g.getFullYear(),D=lm(),U=f?.firstWeekContainsDate??f?.locale?.options?.firstWeekContainsDate??D.firstWeekContainsDate??D.locale?.options?.firstWeekContainsDate??1,B=wo(f?.in||E,0);B.setFullYear(C+1,0,U),B.setHours(0,0,0,0);const te=Ul(B,f),z=wo(f?.in||E,0);z.setFullYear(C,0,U),z.setHours(0,0,0,0);const _e=Ul(z,f);return+g>=+te?C+1:+g>=+_e?C:C-1}function fX(E,f){const g=lm(),C=f?.firstWeekContainsDate??f?.locale?.options?.firstWeekContainsDate??g.firstWeekContainsDate??g.locale?.options?.firstWeekContainsDate??1,D=Mk(E,f),U=wo(f?.in||E,0);return U.setFullYear(D,0,C),U.setHours(0,0,0,0),Ul(U,f)}function _X(E,f){const g=Jr(E,f?.in),C=+Ul(g,f)-+fX(g,f);return Math.round(C/Lk)+1}function Zt(E,f){const g=E<0?"-":"",C=Math.abs(E).toString().padStart(f,"0");return g+C}const Co={y(E,f){const g=E.getFullYear(),C=g>0?g:1-g;return Zt(f==="yy"?C%100:C,f.length)},M(E,f){const g=E.getMonth();return f==="M"?String(g+1):Zt(g+1,2)},d(E,f){return Zt(E.getDate(),f.length)},a(E,f){const g=E.getHours()/12>=1?"pm":"am";switch(f){case"a":case"aa":return g.toUpperCase();case"aaa":return g;case"aaaaa":return g[0];default:return g==="am"?"a.m.":"p.m."}},h(E,f){return Zt(E.getHours()%12||12,f.length)},H(E,f){return Zt(E.getHours(),f.length)},m(E,f){return Zt(E.getMinutes(),f.length)},s(E,f){return Zt(E.getSeconds(),f.length)},S(E,f){const g=f.length,C=E.getMilliseconds(),D=Math.trunc(C*Math.pow(10,g-3));return Zt(D,f.length)}},Xc={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},nk={G:function(E,f,g){const C=E.getFullYear()>0?1:0;switch(f){case"G":case"GG":case"GGG":return g.era(C,{width:"abbreviated"});case"GGGGG":return g.era(C,{width:"narrow"});default:return g.era(C,{width:"wide"})}},y:function(E,f,g){if(f==="yo"){const C=E.getFullYear(),D=C>0?C:1-C;return g.ordinalNumber(D,{unit:"year"})}return Co.y(E,f)},Y:function(E,f,g,C){const D=Mk(E,C),U=D>0?D:1-D;if(f==="YY"){const B=U%100;return Zt(B,2)}return f==="Yo"?g.ordinalNumber(U,{unit:"year"}):Zt(U,f.length)},R:function(E,f){const g=kk(E);return Zt(g,f.length)},u:function(E,f){const g=E.getFullYear();return Zt(g,f.length)},Q:function(E,f,g){const C=Math.ceil((E.getMonth()+1)/3);switch(f){case"Q":return String(C);case"QQ":return Zt(C,2);case"Qo":return g.ordinalNumber(C,{unit:"quarter"});case"QQQ":return g.quarter(C,{width:"abbreviated",context:"formatting"});case"QQQQQ":return g.quarter(C,{width:"narrow",context:"formatting"});default:return g.quarter(C,{width:"wide",context:"formatting"})}},q:function(E,f,g){const C=Math.ceil((E.getMonth()+1)/3);switch(f){case"q":return String(C);case"qq":return Zt(C,2);case"qo":return g.ordinalNumber(C,{unit:"quarter"});case"qqq":return g.quarter(C,{width:"abbreviated",context:"standalone"});case"qqqqq":return g.quarter(C,{width:"narrow",context:"standalone"});default:return g.quarter(C,{width:"wide",context:"standalone"})}},M:function(E,f,g){const C=E.getMonth();switch(f){case"M":case"MM":return Co.M(E,f);case"Mo":return g.ordinalNumber(C+1,{unit:"month"});case"MMM":return g.month(C,{width:"abbreviated",context:"formatting"});case"MMMMM":return g.month(C,{width:"narrow",context:"formatting"});default:return g.month(C,{width:"wide",context:"formatting"})}},L:function(E,f,g){const C=E.getMonth();switch(f){case"L":return String(C+1);case"LL":return Zt(C+1,2);case"Lo":return g.ordinalNumber(C+1,{unit:"month"});case"LLL":return g.month(C,{width:"abbreviated",context:"standalone"});case"LLLLL":return g.month(C,{width:"narrow",context:"standalone"});default:return g.month(C,{width:"wide",context:"standalone"})}},w:function(E,f,g,C){const D=_X(E,C);return f==="wo"?g.ordinalNumber(D,{unit:"week"}):Zt(D,f.length)},I:function(E,f,g){const C=mX(E);return f==="Io"?g.ordinalNumber(C,{unit:"week"}):Zt(C,f.length)},d:function(E,f,g){return f==="do"?g.ordinalNumber(E.getDate(),{unit:"date"}):Co.d(E,f)},D:function(E,f,g){const C=pX(E);return f==="Do"?g.ordinalNumber(C,{unit:"dayOfYear"}):Zt(C,f.length)},E:function(E,f,g){const C=E.getDay();switch(f){case"E":case"EE":case"EEE":return g.day(C,{width:"abbreviated",context:"formatting"});case"EEEEE":return g.day(C,{width:"narrow",context:"formatting"});case"EEEEEE":return g.day(C,{width:"short",context:"formatting"});default:return g.day(C,{width:"wide",context:"formatting"})}},e:function(E,f,g,C){const D=E.getDay(),U=(D-C.weekStartsOn+8)%7||7;switch(f){case"e":return String(U);case"ee":return Zt(U,2);case"eo":return g.ordinalNumber(U,{unit:"day"});case"eee":return g.day(D,{width:"abbreviated",context:"formatting"});case"eeeee":return g.day(D,{width:"narrow",context:"formatting"});case"eeeeee":return g.day(D,{width:"short",context:"formatting"});default:return g.day(D,{width:"wide",context:"formatting"})}},c:function(E,f,g,C){const D=E.getDay(),U=(D-C.weekStartsOn+8)%7||7;switch(f){case"c":return String(U);case"cc":return Zt(U,f.length);case"co":return g.ordinalNumber(U,{unit:"day"});case"ccc":return g.day(D,{width:"abbreviated",context:"standalone"});case"ccccc":return g.day(D,{width:"narrow",context:"standalone"});case"cccccc":return g.day(D,{width:"short",context:"standalone"});default:return g.day(D,{width:"wide",context:"standalone"})}},i:function(E,f,g){const C=E.getDay(),D=C===0?7:C;switch(f){case"i":return String(D);case"ii":return Zt(D,f.length);case"io":return g.ordinalNumber(D,{unit:"day"});case"iii":return g.day(C,{width:"abbreviated",context:"formatting"});case"iiiii":return g.day(C,{width:"narrow",context:"formatting"});case"iiiiii":return g.day(C,{width:"short",context:"formatting"});default:return g.day(C,{width:"wide",context:"formatting"})}},a:function(E,f,g){const D=E.getHours()/12>=1?"pm":"am";switch(f){case"a":case"aa":return g.dayPeriod(D,{width:"abbreviated",context:"formatting"});case"aaa":return g.dayPeriod(D,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return g.dayPeriod(D,{width:"narrow",context:"formatting"});default:return g.dayPeriod(D,{width:"wide",context:"formatting"})}},b:function(E,f,g){const C=E.getHours();let D;switch(C===12?D=Xc.noon:C===0?D=Xc.midnight:D=C/12>=1?"pm":"am",f){case"b":case"bb":return g.dayPeriod(D,{width:"abbreviated",context:"formatting"});case"bbb":return g.dayPeriod(D,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return g.dayPeriod(D,{width:"narrow",context:"formatting"});default:return g.dayPeriod(D,{width:"wide",context:"formatting"})}},B:function(E,f,g){const C=E.getHours();let D;switch(C>=17?D=Xc.evening:C>=12?D=Xc.afternoon:C>=4?D=Xc.morning:D=Xc.night,f){case"B":case"BB":case"BBB":return g.dayPeriod(D,{width:"abbreviated",context:"formatting"});case"BBBBB":return g.dayPeriod(D,{width:"narrow",context:"formatting"});default:return g.dayPeriod(D,{width:"wide",context:"formatting"})}},h:function(E,f,g){if(f==="ho"){let C=E.getHours()%12;return C===0&&(C=12),g.ordinalNumber(C,{unit:"hour"})}return Co.h(E,f)},H:function(E,f,g){return f==="Ho"?g.ordinalNumber(E.getHours(),{unit:"hour"}):Co.H(E,f)},K:function(E,f,g){const C=E.getHours()%12;return f==="Ko"?g.ordinalNumber(C,{unit:"hour"}):Zt(C,f.length)},k:function(E,f,g){let C=E.getHours();return C===0&&(C=24),f==="ko"?g.ordinalNumber(C,{unit:"hour"}):Zt(C,f.length)},m:function(E,f,g){return f==="mo"?g.ordinalNumber(E.getMinutes(),{unit:"minute"}):Co.m(E,f)},s:function(E,f,g){return f==="so"?g.ordinalNumber(E.getSeconds(),{unit:"second"}):Co.s(E,f)},S:function(E,f){return Co.S(E,f)},X:function(E,f,g){const C=E.getTimezoneOffset();if(C===0)return"Z";switch(f){case"X":return rk(C);case"XXXX":case"XX":return ba(C);default:return ba(C,":")}},x:function(E,f,g){const C=E.getTimezoneOffset();switch(f){case"x":return rk(C);case"xxxx":case"xx":return ba(C);default:return ba(C,":")}},O:function(E,f,g){const C=E.getTimezoneOffset();switch(f){case"O":case"OO":case"OOO":return"GMT"+ik(C,":");default:return"GMT"+ba(C,":")}},z:function(E,f,g){const C=E.getTimezoneOffset();switch(f){case"z":case"zz":case"zzz":return"GMT"+ik(C,":");default:return"GMT"+ba(C,":")}},t:function(E,f,g){const C=Math.trunc(+E/1e3);return Zt(C,f.length)},T:function(E,f,g){return Zt(+E,f.length)}};function ik(E,f=""){const g=E>0?"-":"+",C=Math.abs(E),D=Math.trunc(C/60),U=C%60;return U===0?g+String(D):g+String(D)+f+Zt(U,2)}function rk(E,f){return E%60===0?(E>0?"-":"+")+Zt(Math.abs(E)/60,2):ba(E,f)}function ba(E,f=""){const g=E>0?"-":"+",C=Math.abs(E),D=Zt(Math.trunc(C/60),2),U=Zt(C%60,2);return g+D+f+U}const sk=(E,f)=>{switch(E){case"P":return f.date({width:"short"});case"PP":return f.date({width:"medium"});case"PPP":return f.date({width:"long"});default:return f.date({width:"full"})}},Uk=(E,f)=>{switch(E){case"p":return f.time({width:"short"});case"pp":return f.time({width:"medium"});case"ppp":return f.time({width:"long"});default:return f.time({width:"full"})}},EX=(E,f)=>{const g=E.match(/(P+)(p+)?/)||[],C=g[1],D=g[2];if(!D)return sk(E,f);let U;switch(C){case"P":U=f.dateTime({width:"short"});break;case"PP":U=f.dateTime({width:"medium"});break;case"PPP":U=f.dateTime({width:"long"});break;default:U=f.dateTime({width:"full"});break}return U.replace("{{date}}",sk(C,f)).replace("{{time}}",Uk(D,f))},gX={p:Uk,P:EX},SX=/^D+$/,TX=/^Y+$/,yX=["D","DD","YY","YYYY"];function vX(E){return SX.test(E)}function RX(E){return TX.test(E)}function CX(E,f,g){const C=bX(E,f,g);if(console.warn(C),yX.includes(E))throw new RangeError(C)}function bX(E,f,g){const C=E[0]==="Y"?"years":"days of the month";return`Use \`${E.toLowerCase()}\` instead of \`${E}\` (in \`${f}\`) for formatting ${C} to the input \`${g}\`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md`}const IX=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,wX=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,AX=/^'([^]*?)'?$/,OX=/''/g,NX=/[a-zA-Z]/;function DX(E,f,g){const C=lm(),D=g?.locale??C.locale??hX,U=g?.firstWeekContainsDate??g?.locale?.options?.firstWeekContainsDate??C.firstWeekContainsDate??C.locale?.options?.firstWeekContainsDate??1,B=g?.weekStartsOn??g?.locale?.options?.weekStartsOn??C.weekStartsOn??C.locale?.options?.weekStartsOn??0,te=Jr(E,g?.in);if(!Lq(te))throw new RangeError("Invalid time value");let z=f.match(wX).map(ne=>{const ee=ne[0];if(ee==="p"||ee==="P"){const q=gX[ee];return q(ne,D.formatLong)}return ne}).join("").match(IX).map(ne=>{if(ne==="''")return{isToken:!1,value:"'"};const ee=ne[0];if(ee==="'")return{isToken:!1,value:PX(ne)};if(nk[ee])return{isToken:!0,value:ne};if(ee.match(NX))throw new RangeError("Format string contains an unescaped latin alphabet character `"+ee+"`");return{isToken:!1,value:ne}});D.localize.preprocessor&&(z=D.localize.preprocessor(te,z));const _e={firstWeekContainsDate:U,weekStartsOn:B,locale:D};return z.map(ne=>{if(!ne.isToken)return ne.value;const ee=ne.value;(!g?.useAdditionalWeekYearTokens&&RX(ee)||!g?.useAdditionalDayOfYearTokens&&vX(ee))&&CX(ee,f,String(E));const q=nk[ee[0]];return q(te,ee,D.localize,_e)}).join("")}function PX(E){const f=E.match(AX);return f?f[1].replace(OX,"'"):E}const LX={lessThanXSeconds:{one:"menos de un segundo",other:"menos de {{count}} segundos"},xSeconds:{one:"1 segundo",other:"{{count}} segundos"},halfAMinute:"medio minuto",lessThanXMinutes:{one:"menos de un minuto",other:"menos de {{count}} minutos"},xMinutes:{one:"1 minuto",other:"{{count}} minutos"},aboutXHours:{one:"alrededor de 1 hora",other:"alrededor de {{count}} horas"},xHours:{one:"1 hora",other:"{{count}} horas"},xDays:{one:"1 da",other:"{{count}} das"},aboutXWeeks:{one:"alrededor de 1 semana",other:"alrededor de {{count}} semanas"},xWeeks:{one:"1 semana",other:"{{count}} semanas"},aboutXMonths:{one:"alrededor de 1 mes",other:"alrededor de {{count}} meses"},xMonths:{one:"1 mes",other:"{{count}} meses"},aboutXYears:{one:"alrededor de 1 ao",other:"alrededor de {{count}} aos"},xYears:{one:"1 ao",other:"{{count}} aos"},overXYears:{one:"ms de 1 ao",other:"ms de {{count}} aos"},almostXYears:{one:"casi 1 ao",other:"casi {{count}} aos"}},kX=(E,f,g)=>{let C;const D=LX[E];return typeof D=="string"?C=D:f===1?C=D.one:C=D.other.replace("{{count}}",f.toString()),g?.addSuffix?g.comparison&&g.comparison>0?"en "+C:"hace "+C:C},xX={full:"EEEE, d 'de' MMMM 'de' y",long:"d 'de' MMMM 'de' y",medium:"d MMM y",short:"dd/MM/y"},MX={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},UX={full:"{{date}} 'a las' {{time}}",long:"{{date}} 'a las' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},VX={date:ed({formats:xX,defaultWidth:"full"}),time:ed({formats:MX,defaultWidth:"full"}),dateTime:ed({formats:UX,defaultWidth:"full"})},jX={lastWeek:"'el' eeee 'pasado a la' p",yesterday:"'ayer a la' p",today:"'hoy a la' p",tomorrow:"'maana a la' p",nextWeek:"eeee 'a la' p",other:"P"},FX={lastWeek:"'el' eeee 'pasado a las' p",yesterday:"'ayer a las' p",today:"'hoy a las' p",tomorrow:"'maana a las' p",nextWeek:"eeee 'a las' p",other:"P"},BX=(E,f,g,C)=>f.getHours()!==1?FX[E]:jX[E],WX={narrow:["AC","DC"],abbreviated:["AC","DC"],wide:["antes de cristo","despus de cristo"]},GX={narrow:["1","2","3","4"],abbreviated:["T1","T2","T3","T4"],wide:["1 trimestre","2 trimestre","3 trimestre","4 trimestre"]},HX={narrow:["e","f","m","a","m","j","j","a","s","o","n","d"],abbreviated:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],wide:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"]},KX={narrow:["d","l","m","m","j","v","s"],short:["do","lu","ma","mi","ju","vi","s"],abbreviated:["dom","lun","mar","mi","jue","vie","sb"],wide:["domingo","lunes","martes","mircoles","jueves","viernes","sbado"]},YX={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"maana",afternoon:"tarde",evening:"tarde",night:"noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"maana",afternoon:"tarde",evening:"tarde",night:"noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"maana",afternoon:"tarde",evening:"tarde",night:"noche"}},zX={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"de la maana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"de la maana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"de la maana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"}},qX=(E,f)=>Number(E)+"",XX={ordinalNumber:qX,era:Ts({values:WX,defaultWidth:"wide"}),quarter:Ts({values:GX,defaultWidth:"wide",argumentCallback:E=>Number(E)-1}),month:Ts({values:HX,defaultWidth:"wide"}),day:Ts({values:KX,defaultWidth:"wide"}),dayPeriod:Ts({values:YX,defaultWidth:"wide",formattingValues:zX,defaultFormattingWidth:"wide"})},JX=/^(\d+)()?/i,QX=/\d+/i,ZX={narrow:/^(ac|dc|a|d)/i,abbreviated:/^(a\.?\s?c\.?|a\.?\s?e\.?\s?c\.?|d\.?\s?c\.?|e\.?\s?c\.?)/i,wide:/^(antes de cristo|antes de la era com[u]n|despu[e]s de cristo|era com[u]n)/i},$X={any:[/^ac/i,/^dc/i],wide:[/^(antes de cristo|antes de la era com[u]n)/i,/^(despu[e]s de cristo|era com[u]n)/i]},e9={narrow:/^[1234]/i,abbreviated:/^T[1234]/i,wide:/^[1234]()? trimestre/i},t9={any:[/1/i,/2/i,/3/i,/4/i]},n9={narrow:/^[efmajsond]/i,abbreviated:/^(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)/i,wide:/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i},i9={narrow:[/^e/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^en/i,/^feb/i,/^mar/i,/^abr/i,/^may/i,/^jun/i,/^jul/i,/^ago/i,/^sep/i,/^oct/i,/^nov/i,/^dic/i]},r9={narrow:/^[dlmjvs]/i,short:/^(do|lu|ma|mi|ju|vi|s[a])/i,abbreviated:/^(dom|lun|mar|mi[e]|jue|vie|s[a]b)/i,wide:/^(domingo|lunes|martes|mi[e]rcoles|jueves|viernes|s[a]bado)/i},s9={narrow:[/^d/i,/^l/i,/^m/i,/^m/i,/^j/i,/^v/i,/^s/i],any:[/^do/i,/^lu/i,/^ma/i,/^mi/i,/^ju/i,/^vi/i,/^sa/i]},o9={narrow:/^(a|p|mn|md|(de la|a las) (maana|tarde|noche))/i,any:/^([ap]\.?\s?m\.?|medianoche|mediodia|(de la|a las) (maana|tarde|noche))/i},a9={any:{am:/^a/i,pm:/^p/i,midnight:/^mn/i,noon:/^md/i,morning:/maana/i,afternoon:/tarde/i,evening:/tarde/i,night:/noche/i}},c9={ordinalNumber:xk({matchPattern:JX,parsePattern:QX,valueCallback:function(E){return parseInt(E,10)}}),era:ys({matchPatterns:ZX,defaultMatchWidth:"wide",parsePatterns:$X,defaultParseWidth:"any"}),quarter:ys({matchPatterns:e9,defaultMatchWidth:"wide",parsePatterns:t9,defaultParseWidth:"any",valueCallback:E=>E+1}),month:ys({matchPatterns:n9,defaultMatchWidth:"wide",parsePatterns:i9,defaultParseWidth:"any"}),day:ys({matchPatterns:r9,defaultMatchWidth:"wide",parsePatterns:s9,defaultParseWidth:"any"}),dayPeriod:ys({matchPatterns:o9,defaultMatchWidth:"any",parsePatterns:a9,defaultParseWidth:"any"})},d9={code:"es",formatDistance:kX,formatLong:VX,formatRelative:BX,localize:XX,match:c9,options:{weekStartsOn:1,firstWeekContainsDate:1}};function l9(){const[E,f]=W.useState([]),[g,C]=W.useState(!0),[D,U]=W.useState(1),[B,te]=W.useState({action:"",resourceType:""}),[z,_e]=W.useState(0);W.useEffect(()=>{ne()},[D,B]);const ne=async()=>{C(!0);try{const ce={page:D,limit:20,...B},ae=await zp.getAdminAuditLogs(ce);f(ae.data.logs),_e(ae.data.total)}catch(ce){console.error("Error loading logs:",ce),alert("Error al cargar logs: "+ce.message)}finally{C(!1)}},ee=(ce,ae)=>{te({...B,[ce]:ae}),U(1)},q=Math.ceil(z/20);return m.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[m.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Logs de Auditora"}),m.jsx("p",{className:"text-gray-600 mb-6",children:"Historial completo de cambios en la plataforma"}),m.jsxs("div",{className:"mb-6 flex gap-4 bg-white p-4 rounded-lg shadow",children:[m.jsx("input",{type:"text",placeholder:"Filtrar por accin...",value:B.action,onChange:ce=>ee("action",ce.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg flex-1"}),m.jsxs("select",{value:B.resourceType,onChange:ce=>ee("resourceType",ce.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg",children:[m.jsx("option",{value:"",children:"Todos los tipos"}),m.jsx("option",{value:"user",children:"Usuario"}),m.jsx("option",{value:"content",children:"Contenido"}),m.jsx("option",{value:"role",children:"Rol"})]})]}),g?m.jsxs("div",{className:"text-center py-12 bg-white rounded-lg",children:[m.jsx("div",{className:"spinner-lg"}),m.jsx("p",{className:"text-gray-600 mt-4",children:"Cargando logs..."})]}):m.jsxs(m.Fragment,{children:[m.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:m.jsxs("table",{className:"w-full",children:[m.jsx("thead",{className:"bg-gray-100 border-b",children:m.jsxs("tr",{children:[m.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Fecha"}),m.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Actor"}),m.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Accin"}),m.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Recurso"}),m.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Detalles"})]})}),m.jsx("tbody",{children:E.length===0?m.jsx("tr",{children:m.jsx("td",{colSpan:"5",className:"px-6 py-8 text-center text-gray-500",children:"No hay logs de auditora"})}):E.map(ce=>m.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[m.jsx("td",{className:"px-6 py-4 text-sm",children:DX(new Date(ce.created_at),"dd/MM/yyyy HH:mm:ss",{locale:d9})}),m.jsx("td",{className:"px-6 py-4 text-sm font-medium",children:ce.actor_email}),m.jsx("td",{className:"px-6 py-4 text-sm",children:m.jsx("span",{className:"inline-block bg-amber-100 text-amber-800 px-3 py-1 rounded text-xs font-medium",children:ce.action})}),m.jsxs("td",{className:"px-6 py-4 text-sm",children:[ce.resource_type," #",ce.resource_id]}),m.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:ce.metadata&&m.jsxs("span",{title:JSON.stringify(ce.metadata,null,2),children:[JSON.stringify(ce.metadata).substring(0,40),"..."]})})]},ce.id))})]})}),E.length>0&&m.jsxs("div",{className:"mt-6 flex justify-between items-center",children:[m.jsxs("p",{className:"text-sm text-gray-600",children:["Mostrando ",(D-1)*20+1," a ",Math.min(D*20,z)," de ",z," logs"]}),m.jsxs("div",{className:"flex gap-2",children:[m.jsx("button",{onClick:()=>U(Math.max(1,D-1)),disabled:D===1,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:" Anterior"}),m.jsxs("span",{className:"px-4 py-2 font-medium",children:[D," de ",q]}),m.jsx("button",{onClick:()=>U(Math.min(q,D+1)),disabled:D===q,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:"Siguiente "})]})]})]})]})}function qr({children:E}){const{user:f,loading:g}=$i();return g?m.jsxs("div",{className:"loading-screen",children:[m.jsx("div",{className:"loading-spinner"}),m.jsx("p",{children:"Loading..."})]}):f?E:(window.location.replace("/"),null)}function bo({children:E}){const{user:f,loading:g}=$i();return g?m.jsxs("div",{className:"loading-screen",children:[m.jsx("div",{className:"loading-spinner"}),m.jsx("p",{children:"Loading..."})]}):f?["admin","superadmin"].includes(f.role)?E:m.jsx(QS,{to:"/",replace:!0}):(window.location.replace("/"),null)}function u9(){return m.jsx(HY,{children:m.jsxs(mY,{children:[m.jsx(Mn,{path:"/",element:m.jsx(qr,{children:m.jsx(zz,{})})}),m.jsx(Mn,{path:"/profile",element:m.jsx(qr,{children:m.jsx(Jz,{})})}),m.jsx(Mn,{path:"/nearby",element:m.jsx(qr,{children:m.jsx($z,{})})}),m.jsx(Mn,{path:"/hangouts",element:m.jsx(qr,{children:m.jsx(iq,{})})}),m.jsx(Mn,{path:"/live",element:m.jsx(qr,{children:m.jsx(lq,{})})}),m.jsx(Mn,{path:"/prime",element:m.jsx(qr,{children:m.jsx(pq,{})})}),m.jsx(Mn,{path:"/videorama",element:m.jsx(uq,{})}),m.jsx(Mn,{path:"/media",element:m.jsx(qr,{children:m.jsx(hq,{})})}),m.jsx(Mn,{path:"/feed",element:m.jsx(qr,{children:m.jsx(mq,{})})}),m.jsx(Mn,{path:"/wall/:userId",element:m.jsx(qr,{children:m.jsx(fq,{})})}),m.jsx(Mn,{path:"/messages",element:m.jsx(qr,{children:m.jsx(Eq,{})})}),m.jsx(Mn,{path:"/messages/:partnerId",element:m.jsx(qr,{children:m.jsx(Sq,{})})}),m.jsx(Mn,{path:"/admin",element:m.jsx(bo,{children:m.jsx(Tq,{})})}),m.jsx(Mn,{path:"/admin/users",element:m.jsx(bo,{children:m.jsx(yq,{})})}),m.jsx(Mn,{path:"/admin/posts",element:m.jsx(bo,{children:m.jsx(vq,{})})}),m.jsx(Mn,{path:"/admin/hangouts",element:m.jsx(bo,{children:m.jsx(Rq,{})})}),m.jsx(Mn,{path:"/admin/media",element:m.jsx(bo,{children:m.jsx(Cq,{})})}),m.jsx(Mn,{path:"/admin/radio",element:m.jsx(bo,{children:m.jsx(bq,{})})}),m.jsx(Mn,{path:"/admin/roles",element:m.jsx(bo,{children:m.jsx(Iq,{})})}),m.jsx(Mn,{path:"/admin/audit-logs",element:m.jsx(bo,{children:m.jsx(l9,{})})}),m.jsx(Mn,{path:"*",element:m.jsx(QS,{to:"/",replace:!0})})]})})}GY.createRoot(document.getElementById("root")).render(m.jsx(ck.StrictMode,{children:m.jsx(fY,{basename:"/app",children:m.jsx(u9,{})})}));
