<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Recurring Subscription - PNPtv</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1C1C1E;
            --text-main: #FFFFFF;
            --text-muted: #8E8E93;
            --neon-pink: #FF00CC;
            --neon-amber: #FFB454;
            --glass-bg: rgba(44, 44, 46, 0.7);
            --glass-border: rgba(255, 180, 84, 0.3);
            --card-radius: 20px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .ambient-glow {
            position: fixed; top: -30%; left: 50%; transform: translateX(-50%);
            width: 100vw; height: 100vw;
            background: radial-gradient(circle, rgba(255, 0, 204, 0.1) 0%, transparent 65%);
            z-index: -1; pointer-events: none;
        }

        .header {
            background: rgba(28, 28, 30, 0.95);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            padding: 20px 24px; text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .header h1 {
            font-size: 22px; font-weight: 800;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-amber));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        .header p { font-size: 13px; color: var(--text-muted); margin-top: 4px; }

        .recurring-badge {
            display: inline-block;
            background: rgba(255, 180, 84, 0.15);
            padding: 4px 12px; border-radius: 20px;
            font-size: 11px; color: var(--neon-amber);
            margin-top: 8px; font-weight: 700;
            border: 1px solid rgba(255, 180, 84, 0.3);
            letter-spacing: 0.5px;
        }

        .content { padding: 20px; max-width: 500px; margin: 0 auto; }

        .loading { text-align: center; padding: 60px 20px; }

        .spinner {
            width: 36px; height: 36px;
            border: 3px solid rgba(255, 255, 255, 0.1); border-top: 3px solid var(--neon-amber);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px;
        }

        .loading p { color: var(--text-muted); font-size: 14px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Plan Info Card */
        .plan-info {
            background: var(--glass-bg); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: var(--card-radius); padding: 24px; margin-bottom: 20px;
            position: relative; overflow: hidden;
        }

        .plan-info::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 3px;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-amber));
        }

        .plan-name {
            font-size: 16px; font-weight: 700; margin-bottom: 8px;
            display: flex; align-items: center; gap: 10px;
        }

        .plan-price {
            font-size: 32px; font-weight: 900; margin: 12px 0;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-amber));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        .plan-price .period {
            font-size: 13px; color: var(--text-muted); font-weight: 400;
            -webkit-text-fill-color: var(--text-muted);
        }

        .plan-features {
            margin-top: 16px; padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
        }

        .feature {
            display: flex; align-items: center; gap: 10px;
            margin: 8px 0; font-size: 13px; color: rgba(255, 255, 255, 0.7);
        }

        .feature::before {
            content: ""; width: 8px; height: 8px; flex-shrink: 0;
            background: linear-gradient(135deg, var(--neon-pink), var(--neon-amber));
            border-radius: 2px; transform: rotate(45deg);
        }

        /* Cancel Info */
        .cancel-info {
            background: rgba(255, 180, 84, 0.08);
            border: 1px solid rgba(255, 180, 84, 0.2);
            border-radius: 14px; padding: 16px; margin-bottom: 20px;
            font-size: 13px; color: rgba(255, 255, 255, 0.7); line-height: 1.5;
        }

        .cancel-info strong {
            display: block; margin-bottom: 6px; color: var(--neon-amber); font-size: 13px;
        }

        /* Error / Success */
        .error-message {
            background: rgba(255, 107, 107, 0.1); color: #FF9F9F;
            padding: 14px; border-radius: 12px; text-align: center;
            display: none; border: 1px solid rgba(255, 107, 107, 0.2);
            font-size: 14px; margin-bottom: 16px;
        }

        .success-message {
            text-align: center; padding: 48px 24px;
            background: var(--glass-bg); backdrop-filter: blur(16px);
            border-radius: var(--card-radius);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .success-icon { font-size: 48px; margin-bottom: 16px; }

        .success-message h2 {
            font-size: 22px; font-weight: 800; margin-bottom: 8px;
        }

        .success-message p {
            color: var(--text-muted); font-size: 14px; margin-bottom: 24px; line-height: 1.5;
        }

        .telegram-btn {
            display: inline-block; padding: 14px 28px;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-amber));
            color: white; text-decoration: none; border-radius: 14px;
            font-weight: 700; font-size: 14px; text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .telegram-btn:active { transform: scale(0.98); }

        /* Card Icons */
        .card-icons {
            display: flex; gap: 8px; margin-bottom: 20px; justify-content: center;
        }

        .card-icon {
            width: 48px; height: 30px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px; display: flex; align-items: center; justify-content: center;
            font-size: 9px; font-weight: 700; color: var(--text-muted); letter-spacing: 0.5px;
        }

        /* Form */
        .form-group { margin-bottom: 16px; }

        .form-group label {
            display: block; margin-bottom: 6px;
            font-weight: 600; color: var(--text-main); font-size: 13px;
        }

        .form-group input {
            width: 100%; padding: 14px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; font-size: 15px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input::placeholder { color: rgba(255, 255, 255, 0.25); }

        .form-group input:focus {
            outline: none;
            border-color: var(--neon-amber);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-row { display: flex; gap: 12px; }
        .form-row .form-group { flex: 1; }

        /* Submit Button */
        .submit-btn {
            width: 100%; padding: 16px;
            background: linear-gradient(90deg, var(--neon-pink), var(--neon-amber));
            color: white; border: none; border-radius: 14px;
            font-size: 15px; font-weight: 700; cursor: pointer;
            font-family: inherit; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 8px 24px rgba(255, 0, 204, 0.25);
        }

        .submit-btn:active { transform: scale(0.98); }

        .submit-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-muted); cursor: not-allowed; box-shadow: none;
        }

        /* Security & Terms */
        .security-note {
            text-align: center; margin-top: 20px; padding: 14px;
            background: rgba(255, 180, 84, 0.08);
            border: 1px solid rgba(255, 180, 84, 0.15);
            border-radius: 12px; font-size: 12px; color: var(--neon-amber);
        }

        .terms {
            margin-top: 16px; font-size: 11px;
            color: var(--text-muted); text-align: center; line-height: 1.5;
        }

        .terms a { color: var(--neon-amber); text-decoration: none; }

        @media (max-width: 480px) {
            .form-row { flex-direction: column; gap: 0; }
            .header h1 { font-size: 20px; }
            .plan-price { font-size: 28px; }
        }
    </style>
</head>
<body>
    <div class="ambient-glow"></div>
    <header class="header">
        <h1><span id="header-title">PRIME Subscription</span></h1>
        <p id="header-subtitle">Automatic monthly renewal</p>
        <div class="recurring-badge">Auto-renewal</div>
    </header>

    <main class="content">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p id="loading-text">Loading plan information...</p>
        </div>

        <!-- Checkout Form -->
        <div id="checkout-form" style="display: none;">
            <div class="plan-info">
                <div class="plan-name">
                    <span id="plan-name">Monthly Pass</span>
                </div>
                <div class="plan-price">
                    $<span id="plan-price">24.99</span> USD <span class="period">/ month</span>
                </div>
                <div class="plan-features">
                    <div class="feature" id="feature-1">Unlimited access to PRIME content</div>
                    <div class="feature" id="feature-2">Exclusive Telegram channel</div>
                    <div class="feature" id="feature-3">Cancel anytime</div>
                </div>
            </div>

            <div class="cancel-info">
                <strong>Important information:</strong>
                You can cancel your subscription anytime from the bot with the /subscription command. No long-term commitments.
            </div>

            <div class="error-message" id="error-message"></div>

            <div class="card-icons">
                <div class="card-icon">VISA</div>
                <div class="card-icon">MC</div>
                <div class="card-icon">AMEX</div>
            </div>

            <form id="payment-form" onsubmit="return handleSubmit(event)">
                <div class="form-group">
                    <label for="card-holder" id="label-holder">Name on card</label>
                    <input type="text" id="card-holder" name="cardHolder" placeholder="JOHN DOE" required autocomplete="cc-name">
                </div>

                <div class="form-group">
                    <label for="card-number" id="label-number">Card number</label>
                    <input type="text" id="card-number" name="cardNumber" placeholder="4242 4242 4242 4242" required maxlength="19" autocomplete="cc-number">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="expiry" id="label-expiry">Expiration date</label>
                        <input type="text" id="expiry" name="expiry" placeholder="MM/YY" required maxlength="5" autocomplete="cc-exp">
                    </div>
                    <div class="form-group">
                        <label for="cvv" id="label-cvv">CVV</label>
                        <input type="text" id="cvv" name="cvv" placeholder="123" required maxlength="4" autocomplete="cc-csc">
                    </div>
                </div>

                <div class="form-group">
                    <label for="email" id="label-email">Email address</label>
                    <input type="email" id="email" name="email" placeholder="you@email.com" required autocomplete="email">
                </div>

                <button type="submit" class="submit-btn" id="submit-btn">
                    Activate Monthly Subscription
                </button>
            </form>

            <div class="security-note" id="security-note">
                Your data is protected with 256-bit SSL encryption
            </div>

            <div class="terms" id="terms-text">
                By subscribing, you agree to our <a href="/terms" target="_blank">Terms & Conditions</a>
                and <a href="/privacy" target="_blank">Privacy Policy</a>
            </div>
        </div>

        <!-- Success State -->
        <div id="success" class="success-message" style="display: none;">
            <div class="success-icon">&#10003;</div>
            <h2 id="success-title">Subscription Activated!</h2>
            <p id="success-text">Your PRIME membership with auto-renewal is active. Check your Telegram for the access link.</p>
            <a href="https://t.me/pnptv_bot" class="telegram-btn" id="telegram-link">Open Telegram</a>
        </div>
    </main>

    <script>
        // Get URL parameters
        const pathParts = window.location.pathname.split('/');
        const userId = pathParts[2];
        const planId = pathParts[3];

        // Language detection
        const urlParams = new URLSearchParams(window.location.search);
        const lang = urlParams.get('lang') || 'es';
        const isSpanish = lang === 'es';

        // Translations
        const translations = {
            es: {
                headerTitle: 'Suscripcion PRIME',
                headerSubtitle: 'Renovacion automatica mensual',
                loadingText: 'Cargando informacion del plan...',
                planFeature1: 'Acceso ilimitado a contenido PRIME',
                planFeature2: 'Canal exclusivo de Telegram',
                planFeature3: 'Cancela cuando quieras',
                cancelInfo: 'Puedes cancelar tu suscripcion en cualquier momento desde el bot con el comando /subscription. No hay compromisos a largo plazo.',
                labelHolder: 'Nombre en la tarjeta',
                labelNumber: 'Numero de tarjeta',
                labelExpiry: 'Fecha de expiracion',
                labelCvv: 'CVV',
                labelEmail: 'Correo electronico',
                submitBtn: 'Activar Suscripcion Mensual',
                securityNote: 'Tus datos estan protegidos con encriptacion SSL de 256 bits',
                termsText: 'Al suscribirte, aceptas nuestros',
                successTitle: 'Suscripcion Activada!',
                successText: 'Tu membresia PRIME con renovacion automatica esta activa. Revisa tu Telegram para el enlace de acceso.',
                telegramBtn: 'Abrir Telegram',
                processing: 'Procesando...',
                errorGeneric: 'Error al procesar el pago. Por favor intenta de nuevo.',
                perMonth: '/ mes'
            },
            en: {
                headerTitle: 'PRIME Subscription',
                headerSubtitle: 'Automatic monthly renewal',
                loadingText: 'Loading plan information...',
                planFeature1: 'Unlimited access to PRIME content',
                planFeature2: 'Exclusive Telegram channel',
                planFeature3: 'Cancel anytime',
                cancelInfo: 'You can cancel your subscription anytime from the bot with the /subscription command. No long-term commitments.',
                labelHolder: 'Name on card',
                labelNumber: 'Card number',
                labelExpiry: 'Expiration date',
                labelCvv: 'CVV',
                labelEmail: 'Email address',
                submitBtn: 'Activate Monthly Subscription',
                securityNote: 'Your data is protected with 256-bit SSL encryption',
                termsText: 'By subscribing, you agree to our',
                successTitle: 'Subscription Activated!',
                successText: 'Your PRIME membership with auto-renewal is active. Check your Telegram for the access link.',
                telegramBtn: 'Open Telegram',
                processing: 'Processing...',
                errorGeneric: 'Error processing payment. Please try again.',
                perMonth: '/ month'
            }
        };

        const t = translations[isSpanish ? 'es' : 'en'];

        // Apply translations
        document.getElementById('header-title').textContent = t.headerTitle;
        document.getElementById('header-subtitle').textContent = t.headerSubtitle;
        document.getElementById('loading-text').textContent = t.loadingText;
        document.getElementById('feature-1').textContent = t.planFeature1;
        document.getElementById('feature-2').textContent = t.planFeature2;
        document.getElementById('feature-3').textContent = t.planFeature3;
        document.querySelector('.cancel-info').innerHTML = `<strong>${isSpanish ? 'Informacion importante:' : 'Important information:'}</strong> ${t.cancelInfo}`;
        document.getElementById('label-holder').textContent = t.labelHolder;
        document.getElementById('label-number').textContent = t.labelNumber;
        document.getElementById('label-expiry').textContent = t.labelExpiry;
        document.getElementById('label-cvv').textContent = t.labelCvv;
        document.getElementById('label-email').textContent = t.labelEmail;
        document.getElementById('submit-btn').textContent = t.submitBtn;
        document.getElementById('security-note').textContent = t.securityNote;
        document.getElementById('success-title').textContent = t.successTitle;
        document.getElementById('success-text').textContent = t.successText;
        document.getElementById('telegram-link').textContent = t.telegramBtn;
        document.querySelector('.plan-price .period').textContent = t.perMonth;

        // Card number formatting
        document.getElementById('card-number').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\s/g, '').replace(/\D/g, '');
            let formatted = value.match(/.{1,4}/g)?.join(' ') || value;
            e.target.value = formatted;
        });

        // Expiry formatting
        document.getElementById('expiry').addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) {
                value = value.slice(0, 2) + '/' + value.slice(2);
            }
            e.target.value = value;
        });

        // CVV - numbers only
        document.getElementById('cvv').addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '');
        });

        // Load plan info
        async function loadPlanInfo() {
            try {
                const response = await fetch(`/api/subscription/plans`);
                const plans = await response.json();

                // Find the plan
                const plan = plans.find(p => p.id === planId) || plans.find(p => p.duration === 30);

                if (plan) {
                    document.getElementById('plan-name').textContent = isSpanish ? (plan.nameEs || plan.name) : plan.name;
                    document.getElementById('plan-price').textContent = plan.price?.toFixed(2) || '24.99';
                }

                // Show form
                document.getElementById('loading').style.display = 'none';
                document.getElementById('checkout-form').style.display = 'block';
            } catch (error) {
                console.error('Error loading plan:', error);
                // Show form with defaults
                document.getElementById('loading').style.display = 'none';
                document.getElementById('checkout-form').style.display = 'block';
            }
        }

        // Handle form submission
        async function handleSubmit(event) {
            event.preventDefault();

            const submitBtn = document.getElementById('submit-btn');
            const errorDiv = document.getElementById('error-message');

            submitBtn.disabled = true;
            submitBtn.textContent = t.processing;
            errorDiv.style.display = 'none';

            const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
            const expiry = document.getElementById('expiry').value.split('/');
            const cvv = document.getElementById('cvv').value;
            const cardHolder = document.getElementById('card-holder').value;
            const email = document.getElementById('email').value;

            try {
                // First tokenize the card
                const tokenResponse = await fetch('/api/recurring/tokenize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        cardNumber,
                        expMonth: expiry[0],
                        expYear: '20' + expiry[1],
                        cvc: cvv,
                        cardHolderName: cardHolder,
                        email
                    })
                });

                const tokenResult = await tokenResponse.json();

                if (!tokenResult.success) {
                    throw new Error(tokenResult.error || t.errorGeneric);
                }

                // Then create the subscription
                const subResponse = await fetch('/api/recurring/subscribe', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        planId: planId || 'monthly_pass',
                        cardToken: tokenResult.token,
                        email
                    })
                });

                const subResult = await subResponse.json();

                if (!subResult.success) {
                    throw new Error(subResult.error || t.errorGeneric);
                }

                // Show success
                document.getElementById('checkout-form').style.display = 'none';
                document.getElementById('success').style.display = 'block';

            } catch (error) {
                console.error('Payment error:', error);
                errorDiv.textContent = error.message || t.errorGeneric;
                errorDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = t.submitBtn;
            }
        }

        // Initialize
        loadPlanInfo();
    </script>
</body>
</html>
