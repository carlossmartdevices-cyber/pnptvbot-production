<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PNPtv Radio - 24/7 Streaming</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="/unified-design.css">
  <style>
    :root {
      --md-sys-color-primary: #bb86fc;
      --md-sys-color-on-primary: #000000;
      --md-sys-color-secondary: #03dac6;
      --md-sys-color-background: #121212;
      --md-sys-color-surface: #1e1e1e;
      --md-sys-color-surface-variant: #2d2d2d;
      --md-sys-color-on-surface: #e1e1e1;
      --md-sys-color-on-surface-variant: #a0a0a0;
      --md-sys-color-error: #cf6679;
      --md-sys-color-outline: #444444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--md-sys-color-background);
      color: var(--md-sys-color-on-surface);
      min-height: 100vh;
    }

    /* Apply BBH Bartle font to all headings */
    h1, h2, h3, h4, h5, h6 {
      font-family: var(--font-title);
    }

    .app-bar {
      background: var(--md-sys-color-surface);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-bar h1 {
      font-size: 22px;
      font-weight: 500;
      flex: 1;
    }

    .app-bar .material-icons {
      color: var(--md-sys-color-primary);
      font-size: 28px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Player Card */
    .player-card {
      background: var(--md-sys-color-surface);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .player-visual {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 24px;
    }

    .album-art {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, var(--md-sys-color-primary), var(--md-sys-color-secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: pulse 2s ease-in-out infinite;
    }

    .album-art.playing {
      animation: rotate 4s linear infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    @keyframes rotate {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .album-art .material-icons {
      font-size: 48px;
      color: var(--md-sys-color-on-primary);
    }

    .now-playing-info {
      flex: 1;
    }

    .now-playing-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--md-sys-color-primary);
      margin-bottom: 8px;
    }

    .song-title {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .song-artist {
      font-size: 16px;
      color: var(--md-sys-color-on-surface-variant);
    }

    .player-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .play-btn {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--md-sys-color-primary);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .play-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(187, 134, 252, 0.4);
    }

    .play-btn .material-icons {
      font-size: 32px;
      color: var(--md-sys-color-on-primary);
    }

    .volume-control {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      max-width: 200px;
    }

    .volume-control .material-icons {
      color: var(--md-sys-color-on-surface-variant);
    }

    .volume-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 4px;
      background: var(--md-sys-color-surface-variant);
      border-radius: 2px;
      outline: none;
    }

    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--md-sys-color-primary);
      border-radius: 50%;
      cursor: pointer;
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: rgba(255, 0, 0, 0.2);
      border-radius: 20px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: #ff0000;
      border-radius: 50%;
      animation: blink 1s ease-in-out infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      overflow-x: auto;
      padding-bottom: 8px;
    }

    .tab {
      padding: 12px 24px;
      background: var(--md-sys-color-surface);
      border: none;
      border-radius: 20px;
      color: var(--md-sys-color-on-surface-variant);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .tab:hover {
      background: var(--md-sys-color-surface-variant);
    }

    .tab.active {
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
    }

    /* Content Sections */
    .content-section {
      display: none;
    }

    .content-section.active {
      display: block;
    }

    .card {
      background: var(--md-sys-color-surface);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 500;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .card-title .material-icons {
      color: var(--md-sys-color-primary);
    }

    /* History List */
    .history-list {
      list-style: none;
    }

    .history-item {
      display: flex;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--md-sys-color-outline);
    }

    .history-item:last-child {
      border-bottom: none;
    }

    .history-number {
      width: 32px;
      font-size: 14px;
      color: var(--md-sys-color-on-surface-variant);
    }

    .history-info {
      flex: 1;
    }

    .history-title {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .history-artist {
      font-size: 14px;
      color: var(--md-sys-color-on-surface-variant);
    }

    .history-time {
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
    }

    /* Request Form */
    .request-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .form-field {
      position: relative;
    }

    .form-field input {
      width: 100%;
      padding: 16px;
      background: var(--md-sys-color-surface-variant);
      border: 2px solid transparent;
      border-radius: 8px;
      color: var(--md-sys-color-on-surface);
      font-size: 16px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-field input:focus {
      outline: none;
      border-color: var(--md-sys-color-primary);
    }

    .form-field input::placeholder {
      color: var(--md-sys-color-on-surface-variant);
    }

    .submit-btn {
      padding: 16px 32px;
      background: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(187, 134, 252, 0.3);
    }

    .submit-btn:disabled {
      background: var(--md-sys-color-surface-variant);
      color: var(--md-sys-color-on-surface-variant);
      cursor: not-allowed;
      transform: none;
    }

    .request-limit {
      font-size: 12px;
      color: var(--md-sys-color-on-surface-variant);
      text-align: center;
    }

    /* Schedule */
    .schedule-day {
      margin-bottom: 24px;
    }

    .schedule-day-name {
      font-size: 16px;
      font-weight: 500;
      color: var(--md-sys-color-primary);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--md-sys-color-outline);
    }

    .schedule-program {
      display: flex;
      align-items: flex-start;
      padding: 12px 0;
      gap: 16px;
    }

    .schedule-time {
      font-size: 14px;
      color: var(--md-sys-color-on-surface-variant);
      min-width: 100px;
    }

    .schedule-info {
      flex: 1;
    }

    .schedule-program-name {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .schedule-description {
      font-size: 14px;
      color: var(--md-sys-color-on-surface-variant);
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--md-sys-color-surface-variant);
      color: var(--md-sys-color-on-surface);
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    .toast.success {
      background: var(--md-sys-color-secondary);
      color: var(--md-sys-color-on-primary);
    }

    .toast.error {
      background: var(--md-sys-color-error);
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 32px;
      color: var(--md-sys-color-on-surface-variant);
    }

    .empty-state .material-icons {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--md-sys-color-surface-variant);
      border-top-color: var(--md-sys-color-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 600px) {
      .container {
        padding: 16px;
      }

      .player-visual {
        flex-direction: column;
        text-align: center;
      }

      .player-controls {
        justify-content: center;
        flex-wrap: wrap;
      }

      .volume-control {
        width: 100%;
        max-width: none;
        justify-content: center;
      }

      .tabs {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app-bar">
    <a href="/" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit;">
      <span class="material-icons" style="font-size: 28px; color: var(--md-sys-color-primary);">home</span>
    </a>
    <a href="/community-room" style="display: flex; align-items: center; gap: 8px; text-decoration: none; color: inherit; cursor: pointer;">
      <span class="material-icons" style="font-size: 28px; color: var(--md-sys-color-primary);">videocam</span>
    </a>
    <span class="material-icons">radio</span>
    <h1>PNPtv Radio</h1>
    <div class="live-indicator">
      <div class="live-dot"></div>
      LIVE
    </div>
  </div>

  <div class="container">
    <!-- Player Card -->
    <div class="player-card">
      <div class="player-visual">
        <div class="album-art" id="albumArt">
          <span class="material-icons">music_note</span>
        </div>
        <div class="now-playing-info">
          <div class="now-playing-label">Now Playing</div>
          <div class="song-title" id="songTitle">Loading...</div>
          <div class="song-artist" id="songArtist">-</div>
        </div>
      </div>
      <div class="player-controls">
        <button class="play-btn" id="playBtn" onclick="togglePlay()">
          <span class="material-icons" id="playIcon">play_arrow</span>
        </button>
        <div class="volume-control">
          <span class="material-icons">volume_up</span>
          <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="80" onchange="setVolume(this.value)">
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="showTab('history')">
        <span class="material-icons" style="vertical-align: middle; font-size: 18px;">history</span>
        History
      </button>
      <button class="tab" onclick="showTab('request')">
        <span class="material-icons" style="vertical-align: middle; font-size: 18px;">queue_music</span>
        Request
      </button>
      <button class="tab" onclick="showTab('schedule')">
        <span class="material-icons" style="vertical-align: middle; font-size: 18px;">calendar_today</span>
        Schedule
      </button>
    </div>

    <!-- History Section -->
    <div class="content-section active" id="history-section">
      <div class="card">
        <div class="card-title">
          <span class="material-icons">history</span>
          Recently Played
        </div>
        <ul class="history-list" id="historyList">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </ul>
      </div>
    </div>

    <!-- Request Section -->
    <div class="content-section" id="request-section">
      <div class="card">
        <div class="card-title">
          <span class="material-icons">queue_music</span>
          Request a Song
        </div>
        <form class="request-form" onsubmit="submitRequest(event)">
          <div class="form-field">
            <input type="text" id="requestSong" placeholder="Song name (e.g., Sweet Child O' Mine)" required>
          </div>
          <div class="form-field">
            <input type="text" id="requestArtist" placeholder="Artist (optional)">
          </div>
          <button type="submit" class="submit-btn" id="requestBtn">
            <span class="material-icons">send</span>
            Submit Request
          </button>
          <p class="request-limit">You can request up to 5 songs per day</p>
        </form>
      </div>
    </div>

    <!-- Schedule Section -->
    <div class="content-section" id="schedule-section">
      <div class="card">
        <div class="card-title">
          <span class="material-icons">calendar_today</span>
          Weekly Schedule
        </div>
        <div id="scheduleContent">
          <div class="loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast notification -->
  <div class="toast" id="toast"></div>

  <!-- Audio element -->
  <audio id="radioStream" preload="none"></audio>

  <script>
    // Configuration
    const API_BASE = window.location.origin;
    const STREAM_URL = ''; // Will be loaded from API or env

    // State
    let isPlaying = false;
    let currentStreamUrl = '';

    // Elements
    const audio = document.getElementById('radioStream');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const albumArt = document.getElementById('albumArt');
    const songTitle = document.getElementById('songTitle');
    const songArtist = document.getElementById('songArtist');
    const volumeSlider = document.getElementById('volumeSlider');

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      await loadStreamUrl();
      await loadNowPlaying();
      await loadHistory();

      // Auto-refresh now playing every 30 seconds
      setInterval(loadNowPlaying, 30000);

      // Get telegram ID from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      window.telegramId = urlParams.get('telegramId') || '';
    });

    // Load stream URL from API
    async function loadStreamUrl() {
      try {
        const response = await fetch(`${API_BASE}/api/radio/config`);
        const data = await response.json();
        if (data.success && data.streamUrl) {
          currentStreamUrl = data.streamUrl;
          audio.src = currentStreamUrl;
        } else {
          // Fallback to default
          currentStreamUrl = 'https://pnptv.app/radio/stream';
          audio.src = currentStreamUrl;
        }
      } catch (error) {
        console.error('Error loading stream URL:', error);
        currentStreamUrl = 'https://pnptv.app/radio/stream';
        audio.src = currentStreamUrl;
      }
    }

    // Toggle play/pause
    function togglePlay() {
      if (isPlaying) {
        audio.pause();
        playIcon.textContent = 'play_arrow';
        albumArt.classList.remove('playing');
      } else {
        audio.play().catch(err => {
          showToast('Unable to play stream', 'error');
          console.error('Play error:', err);
        });
        playIcon.textContent = 'pause';
        albumArt.classList.add('playing');
      }
      isPlaying = !isPlaying;
    }

    // Set volume
    function setVolume(value) {
      audio.volume = value / 100;
    }

    // Initialize volume
    audio.volume = volumeSlider.value / 100;

    // Load now playing
    async function loadNowPlaying() {
      try {
        const response = await fetch(`${API_BASE}/api/radio/now-playing`);
        const data = await response.json();

        if (data.success && data.nowPlaying) {
          songTitle.textContent = data.nowPlaying.title || data.nowPlaying.song || 'Unknown';
          songArtist.textContent = data.nowPlaying.artist || '-';
        } else {
          songTitle.textContent = 'PNPtv Radio';
          songArtist.textContent = '24/7 Streaming';
        }
      } catch (error) {
        console.error('Error loading now playing:', error);
        songTitle.textContent = 'PNPtv Radio';
        songArtist.textContent = '24/7 Streaming';
      }
    }

    // Load history
    async function loadHistory() {
      const historyList = document.getElementById('historyList');

      try {
        const response = await fetch(`${API_BASE}/api/radio/history`);
        const data = await response.json();

        if (data.success && data.history && data.history.length > 0) {
          historyList.innerHTML = data.history.map((song, index) => `
            <li class="history-item">
              <span class="history-number">${index + 1}</span>
              <div class="history-info">
                <div class="history-title">${song.title || song.song}</div>
                <div class="history-artist">${song.artist || '-'}</div>
              </div>
              <span class="history-time">${formatTime(song.playedAt)}</span>
            </li>
          `).join('');
        } else {
          historyList.innerHTML = `
            <div class="empty-state">
              <span class="material-icons">history</span>
              <p>No history available yet</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading history:', error);
        historyList.innerHTML = `
          <div class="empty-state">
            <span class="material-icons">error_outline</span>
            <p>Failed to load history</p>
          </div>
        `;
      }
    }

    // Load schedule
    async function loadSchedule() {
      const scheduleContent = document.getElementById('scheduleContent');

      try {
        const response = await fetch(`${API_BASE}/api/radio/schedule`);
        const data = await response.json();

        if (data.success && data.schedule && data.schedule.length > 0) {
          const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

          // Group by day
          const scheduleByDay = {};
          data.schedule.forEach(entry => {
            const day = entry.dayOfWeek !== undefined ? days[entry.dayOfWeek] : entry.day;
            if (!scheduleByDay[day]) {
              scheduleByDay[day] = [];
            }
            scheduleByDay[day].push(entry);
          });

          let html = '';
          days.forEach(day => {
            if (scheduleByDay[day]) {
              html += `
                <div class="schedule-day">
                  <div class="schedule-day-name">${day}</div>
                  ${scheduleByDay[day].map(program => `
                    <div class="schedule-program">
                      <span class="schedule-time">${program.timeSlot}</span>
                      <div class="schedule-info">
                        <div class="schedule-program-name">${program.programName}</div>
                        ${program.description ? `<div class="schedule-description">${program.description}</div>` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
              `;
            }
          });

          scheduleContent.innerHTML = html || `
            <div class="empty-state">
              <span class="material-icons">calendar_today</span>
              <p>No schedule available</p>
            </div>
          `;
        } else {
          scheduleContent.innerHTML = `
            <div class="empty-state">
              <span class="material-icons">calendar_today</span>
              <p>No schedule available</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading schedule:', error);
        scheduleContent.innerHTML = `
          <div class="empty-state">
            <span class="material-icons">error_outline</span>
            <p>Failed to load schedule</p>
          </div>
        `;
      }
    }

    // Submit song request
    async function submitRequest(event) {
      event.preventDefault();

      const songInput = document.getElementById('requestSong');
      const artistInput = document.getElementById('requestArtist');
      const submitBtn = document.getElementById('requestBtn');

      const song = songInput.value.trim();
      const artist = artistInput.value.trim();

      if (!song) {
        showToast('Please enter a song name', 'error');
        return;
      }

      submitBtn.disabled = true;

      try {
        const response = await fetch(`${API_BASE}/api/radio/request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            song: artist ? `${song} - ${artist}` : song,
            telegramId: window.telegramId
          })
        });

        const data = await response.json();

        if (data.success) {
          showToast('Song request submitted!', 'success');
          songInput.value = '';
          artistInput.value = '';
        } else {
          showToast(data.error || 'Failed to submit request', 'error');
        }
      } catch (error) {
        console.error('Error submitting request:', error);
        showToast('Failed to submit request', 'error');
      } finally {
        submitBtn.disabled = false;
      }
    }

    // Show tab
    function showTab(tabName) {
      // Update tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.textContent.toLowerCase().includes(tabName)) {
          tab.classList.add('active');
        }
      });

      // Update sections
      document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(`${tabName}-section`).classList.add('active');

      // Load data for tab
      if (tabName === 'schedule') {
        loadSchedule();
      } else if (tabName === 'history') {
        loadHistory();
      }
    }

    // Format time
    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Show toast notification
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Audio event handlers
    audio.addEventListener('error', () => {
      showToast('Stream error - please try again', 'error');
      isPlaying = false;
      playIcon.textContent = 'play_arrow';
      albumArt.classList.remove('playing');
    });

    audio.addEventListener('waiting', () => {
      playIcon.textContent = 'hourglass_empty';
    });

    audio.addEventListener('playing', () => {
      playIcon.textContent = 'pause';
    });
  </script>
</body>
</html>
