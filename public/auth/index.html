<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0" />
  <meta name="theme-color" content="#120d14" />
  <meta name="description" content="PRIME Hub - PNPtv Community Platform" />
  <title>PRIME Hub - PNPtv</title>
  <link rel="icon" type="image/png" href="/favicon.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #120d14;
      --surface: #2C2C2E;
      --border: rgba(255,255,255,0.08);
      --text: #FFFFFF;
      --muted: #8E8E93;
      --accent: #ff3377;
      --amber: #ff9933;
      --radius: 16px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .glow {
      position: fixed;
      top: -200px;
      left: 50%;
      transform: translateX(-50%);
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(255,0,204,0.15) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    .card {
      position: relative;
      z-index: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 40px 36px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.5);
    }

    .logo img {
      width: 160px;
      height: 160px;
      object-fit: contain;
      display: block;
      margin: 0 auto 4px;
    }

    .subtitle {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      margin-bottom: 28px;
    }

    /* Error / success banners */
    .banner {
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      margin-bottom: 18px;
      display: none;
    }
    .banner.error  { background: rgba(255,69,58,0.15);  border: 1px solid rgba(255,69,58,0.4);  color: #ff453a; }
    .banner.success { background: rgba(48,209,88,0.12); border: 1px solid rgba(48,209,88,0.35); color: #30d158; }
    .banner.show { display: block; }


    /* Divider */
    .divider {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--muted);
      font-size: 12px;
      margin: 14px 0;
    }
    .divider::before, .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* Buttons */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 13px 20px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity 0.15s, transform 0.1s;
      text-decoration: none;
    }
    .btn:active { transform: scale(0.98); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-telegram {
      background: #2AABEE;
      color: #fff;
      margin-bottom: 14px;
    }
    .btn-telegram:hover { background: #229ED9; }

    .btn-x {
      background: #000;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.15);
      margin-bottom: 14px;
    }
    .btn-x:hover { background: #111; }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #8A00FF);
      color: #fff;
      margin-top: 4px;
    }
    .btn-primary:hover { opacity: 0.9; }

    .remember-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--muted);
      margin-top: -2px;
      user-select: none;
    }
    .remember-row input[type="checkbox"] {
      width: 14px;
      height: 14px;
      accent-color: var(--accent);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      background: rgba(0,0,0,0.25);
      border-radius: 10px;
      padding: 3px;
      margin-bottom: 18px;
    }
    .tab {
      flex: 1;
      padding: 8px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.15s;
    }
    .tab.active {
      background: var(--surface);
      color: var(--text);
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }

    /* Form */
    .form { display: flex; flex-direction: column; gap: 10px; }
    .form.hidden { display: none; }

    input[type="text"],
    input[type="email"],
    input[type="password"] {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      color: var(--text);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.15s;
    }
    input:focus { border-color: rgba(255,0,204,0.5); }
    input::placeholder { color: var(--muted); }

    /* Footer */
    .footer {
      margin-top: 22px;
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }
    .footer a { color: var(--amber); text-decoration: none; }
    .footer a:hover { text-decoration: underline; }

    /* X icon SVG */
    .x-icon { width: 18px; height: 18px; fill: currentColor; flex-shrink: 0; }
  </style>
</head>
<body>
  <div class="glow"></div>

  <div class="card">
    <div class="logo"><img src="/Logo2-50.png" alt="PNPtv PRIME" /></div>
    <p class="subtitle">Inicia sesión para acceder a la comunidad</p>

    <div id="error-banner"  class="banner error"></div>
    <div id="success-banner" class="banner success"></div>

    <!-- 1. Telegram Login (deep-link + poll, no widget dependency) -->
    <button type="button" class="btn btn-telegram" id="btn-telegram-main" onclick="handleTelegramLogin()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0;">
        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
      </svg>
      Continuar con Telegram
    </button>
    <button type="button" class="btn btn-telegram" id="btn-telegram-fallback" style="display:none;" onclick="handleTelegramLogin()">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0;">
        <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
      </svg>
      Continuar con Telegram
    </button>
    <div style="text-align:center;margin-top:6px;">
      <a href="#" onclick="handleTelegramOAuthLogin();return false;" style="font-size:12px;color:var(--amber);text-decoration:none;">Usar OAuth directo de Telegram</a>
    </div>

    <div class="divider">o</div>

    <!-- 2. X (Twitter) OAuth - TEMPORARILY HIDDEN FOR MAINTENANCE -->
    <button type="button" class="btn btn-x" id="btn-x" onclick="handleXLogin()" style="display:none;">
      <svg class="x-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-4.714-6.231-5.401 6.231H2.745l7.73-8.835L1.254 2.25H8.08l4.258 5.63 5.906-5.63Zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
      </svg>
      Continuar con X
    </button>

    <div class="divider" style="display:none;">o</div>

    <!-- 3. Email / Password -->
    <div class="tabs">
      <button type="button" class="tab active" id="tab-login"    onclick="switchTab('login')">Iniciar sesión</button>
      <button type="button" class="tab"        id="tab-register" onclick="switchTab('register')">Registrarse</button>
    </div>

    <!-- Login form -->
    <form class="form" id="form-login" onsubmit="return handleLogin(event);">
      <input type="email"    id="login-email" name="email" placeholder="Correo electrónico" autocomplete="username" />
      <input type="password" id="login-password" name="password" placeholder="Contraseña" autocomplete="current-password" />
      <label class="remember-row" for="login-remember">
        <input type="checkbox" id="login-remember" name="rememberMe" />
        Recordarme en este dispositivo (30 días)
      </label>
      <button type="submit" class="btn btn-primary" id="btn-login">Iniciar sesión</button>
      <div style="text-align:center;margin-top:4px;">
        <a href="#" onclick="showForgot();return false;" style="font-size:12px;color:var(--amber);text-decoration:none;">¿Olvidaste tu contraseña?</a>
      </div>
    </form>

    <!-- Forgot password form (hidden by default) -->
    <form class="form hidden" id="form-forgot" onsubmit="return handleForgot(event);">
      <p style="font-size:13px;color:var(--muted);margin-bottom:4px;">Ingresa tu correo y te enviamos un enlace para restablecer tu contraseña.</p>
      <input type="email" id="forgot-email" name="email" placeholder="Correo electrónico" autocomplete="email" />
      <button type="submit" class="btn btn-primary" id="btn-forgot">Enviar enlace</button>
      <div style="text-align:center;margin-top:4px;">
        <a href="#" onclick="hideForgot();return false;" style="font-size:12px;color:var(--amber);text-decoration:none;">← Volver</a>
      </div>
    </form>

    <!-- Register form -->
    <form class="form hidden" id="form-register" onsubmit="return handleRegister(event);">
      <input type="text"     id="reg-name" name="firstName" placeholder="Nombre" autocomplete="given-name" />
      <input type="email"    id="reg-email" name="email" placeholder="Correo electrónico" autocomplete="email" />
      <input type="password" id="reg-password" name="password" placeholder="Contraseña (mínimo 8 caracteres)" autocomplete="new-password" />
      <button type="submit" class="btn btn-primary" id="btn-register">Crear cuenta</button>
    </form>

    <p class="footer">
      Al ingresar aceptas nuestros
      <a href="/terms" target="_blank">Términos y Condiciones</a>
      y nuestra
      <a href="/privacy" target="_blank">Política de Privacidad</a>.<br/>
      Debes ser mayor de 18 años para usar esta plataforma.
    </p>
  </div>

  <script>
    const CANONICAL_ORIGIN = 'https://pnptv.app';
    const CANONICAL_APP_URL = `${CANONICAL_ORIGIN}/app`;

    // Always keep authentication on canonical domain.
    if (window.location.origin !== CANONICAL_ORIGIN) {
      window.location.replace(`${CANONICAL_ORIGIN}${window.location.pathname}${window.location.search}${window.location.hash}`);
    }

    // ── Show error/success from URL params ─────────────────────────────────────
    (function () {
      const p = new URLSearchParams(location.search);
      const err = p.get('error');
      const msgs = {
        auth_failed:     'La autenticación falló. Por favor intenta de nuevo.',
        not_registered:  p.get('x_handle')
          ? `La cuenta @${p.get('x_handle')} no está registrada en PNPtv. Regístrate primero con el bot de Telegram.`
          : 'Esta cuenta no está registrada. Usa el bot de Telegram primero.',
        missing_params:  'La autenticación fue incompleta. Por favor intenta de nuevo.',
      };
      if (err && msgs[err]) showBanner('error', msgs[err]);
    })();

    const REMEMBER_ME_KEY = 'pnptv.rememberMe';
    const REMEMBER_EMAIL_KEY = 'pnptv.rememberedEmail';

    (function restoreRememberedLogin() {
      try {
        const rememberMe = localStorage.getItem(REMEMBER_ME_KEY) === '1';
        const savedEmail = localStorage.getItem(REMEMBER_EMAIL_KEY) || '';
        const rememberEl = document.getElementById('login-remember');
        const emailEl = document.getElementById('login-email');
        if (!rememberEl || !emailEl) return;

        rememberEl.checked = rememberMe;
        if (rememberMe && savedEmail) emailEl.value = savedEmail;
      } catch (_) {
        // Ignore browser storage issues.
      }
    })();

    // ── Tab switch ─────────────────────────────────────────────────────────────
    function switchTab(tab) {
      document.getElementById('tab-login').classList.toggle('active', tab === 'login');
      document.getElementById('tab-register').classList.toggle('active', tab === 'register');
      document.getElementById('form-login').classList.toggle('hidden', tab !== 'login');
      document.getElementById('form-forgot').classList.add('hidden');
      document.getElementById('form-register').classList.toggle('hidden', tab !== 'register');
      clearBanners();
    }

    // ── Forgot password ────────────────────────────────────────────────────────
    function showForgot() {
      document.getElementById('form-login').classList.add('hidden');
      document.getElementById('form-forgot').classList.remove('hidden');
      clearBanners();
    }
    function hideForgot() {
      document.getElementById('form-forgot').classList.add('hidden');
      document.getElementById('form-login').classList.remove('hidden');
      clearBanners();
    }
    async function handleForgot(event) {
      if (event) event.preventDefault();
      clearBanners();
      const email = document.getElementById('forgot-email').value.trim();
      const btn   = document.getElementById('btn-forgot');
      if (!email) { showBanner('error', 'Ingresa tu correo electrónico.'); return; }
      btn.disabled = true;
      btn.textContent = 'Enviando...';
      try {
        await fetch('/api/webapp/auth/forgot-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email }),
        });
        showBanner('success', 'Si ese correo está registrado, recibirás un enlace en breve.');
      } catch {
        showBanner('error', 'Error de red. Intenta de nuevo.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Enviar enlace';
      }
      return false;
    }

    // ── Banners ────────────────────────────────────────────────────────────────
    function showBanner(type, msg) {
      const el = document.getElementById(`${type}-banner`);
      el.textContent = msg;
      el.classList.add('show');
    }
    function clearBanners() {
      document.getElementById('error-banner').classList.remove('show');
      document.getElementById('success-banner').classList.remove('show');
    }

    // ── Email Login ────────────────────────────────────────────────────────────
    async function handleLogin(event) {
      if (event) event.preventDefault();
      clearBanners();
      const email    = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      const rememberMe = document.getElementById('login-remember').checked;
      const btn      = document.getElementById('btn-login');

      if (!email || !password) { showBanner('error', 'Completa todos los campos.'); return; }

      btn.disabled = true;
      btn.textContent = 'Ingresando...';
      try {
        const res  = await fetch('/api/webapp/auth/email/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password, rememberMe }),
        });
        const data = await res.json();
        if (res.ok && data.authenticated) {
          try {
            if (rememberMe) {
              localStorage.setItem(REMEMBER_ME_KEY, '1');
              localStorage.setItem(REMEMBER_EMAIL_KEY, email);
            } else {
              localStorage.removeItem(REMEMBER_ME_KEY);
              localStorage.removeItem(REMEMBER_EMAIL_KEY);
            }
          } catch (_) {
            // Ignore browser storage issues.
          }
          showBanner('success', '¡Bienvenido! Redirigiendo...');
          setTimeout(() => { location.href = CANONICAL_APP_URL; }, 800);
        } else if (data.error === 'email_not_verified') {
          // Email not verified — show resend option
          const resendLink = document.createElement('a');
          resendLink.href = '#';
          resendLink.style.color = 'var(--amber)';
          resendLink.style.textDecoration = 'underline';
          resendLink.style.marginLeft = '4px';
          resendLink.onclick = (e) => { e.preventDefault(); handleResendVerification(email, btn); };
          resendLink.textContent = 'Reenviar correo';

          const errorEl = document.getElementById('error-banner');
          errorEl.textContent = 'Por favor verifica tu email antes de iniciar sesión. ';
          errorEl.appendChild(resendLink);
          errorEl.classList.add('show');
          btn.disabled = false;
          btn.textContent = 'Iniciar sesión';
        } else {
          showBanner('error', data.error || 'Error al iniciar sesión.');
          btn.disabled = false;
          btn.textContent = 'Iniciar sesión';
        }
      } catch {
        showBanner('error', 'Error de red. Intenta de nuevo.');
        btn.disabled = false;
        btn.textContent = 'Iniciar sesión';
      }
      return false;
    }

    // ── Email Register ─────────────────────────────────────────────────────────
    async function handleRegister(event) {
      if (event) event.preventDefault();
      clearBanners();
      const firstName = document.getElementById('reg-name').value.trim();
      const email     = document.getElementById('reg-email').value.trim();
      const password  = document.getElementById('reg-password').value;
      const btn       = document.getElementById('btn-register');

      if (!firstName || !email || !password) { showBanner('error', 'Completa todos los campos.'); return; }
      if (password.length < 8) { showBanner('error', 'La contraseña debe tener al menos 8 caracteres.'); return; }

      btn.disabled = true;
      btn.textContent = 'Creando cuenta...';
      try {
        const res  = await fetch('/api/webapp/auth/email/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ firstName, email, password }),
        });
        const data = await res.json();
        if (data.requiresVerification) {
          showBanner('success', '¡Cuenta creada! Revisa tu correo para verificar tu email.');
          // Clear form
          document.getElementById('reg-name').value = '';
          document.getElementById('reg-email').value = '';
          document.getElementById('reg-password').value = '';
          btn.disabled = false;
          btn.textContent = 'Crear cuenta';
        } else if (res.ok && data.authenticated) {
          showBanner('success', '¡Cuenta creada! Redirigiendo...');
          setTimeout(() => { location.href = CANONICAL_APP_URL; }, 800);
        } else {
          showBanner('error', data.error || 'Error al registrarse.');
          btn.disabled = false;
          btn.textContent = 'Crear cuenta';
        }
      } catch {
        showBanner('error', 'Error de red. Intenta de nuevo.');
        btn.disabled = false;
        btn.textContent = 'Crear cuenta';
      }
      return false;
    }

    // ── Resend Verification Email ──────────────────────────────────────────────
    async function handleResendVerification(email, triggerBtn) {
      clearBanners();
      triggerBtn.disabled = true;
      triggerBtn.textContent = 'Reenviando...';
      try {
        const res = await fetch('/api/webapp/auth/resend-verification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email }),
        });
        const data = await res.json();
        if (res.ok) {
          showBanner('success', 'Se envió un nuevo correo de verificación. Revisa tu bandeja de entrada.');
        } else {
          showBanner('error', data.error || 'Error al reenviar correo.');
        }
      } catch {
        showBanner('error', 'Error de red. Intenta de nuevo.');
      } finally {
        triggerBtn.disabled = false;
        triggerBtn.textContent = 'Iniciar sesión';
      }
    }

    // ── Telegram Login ─────────────────────────────────────────────────────
    function handleTelegramOAuthLogin() {
      clearBanners();
      window.location.href = '/api/webapp/auth/telegram/start';
    }

    // Deep link login (primary flow)
    let _tgPollInterval = null;
    const svgTelegram = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="flex-shrink:0;"><path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/></svg>';

    async function handleTelegramLogin() {
      clearBanners();
      const btn = document.getElementById('btn-telegram-main');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-sm"></span> Conectando...';
      try {
        const res = await fetch('/api/webapp/auth/telegram/token', { method: 'POST', credentials: 'include' });
        const data = await res.json();
        if (!res.ok || !data.token) { showBanner('error', 'Error al generar enlace.'); btn.disabled = false; btn.innerHTML = svgTelegram + ' Continuar con Telegram'; return; }
        window.open(data.deepLink, '_blank');
        btn.innerHTML = '<span class="spinner-sm"></span> Esperando...';
        showBanner('success', 'Abre Telegram y presiona START para completar el login.');
        let attempts = 0;
        _tgPollInterval = setInterval(async () => {
          if (++attempts > 60) { clearInterval(_tgPollInterval); showBanner('error', 'Tiempo agotado.'); btn.disabled = false; btn.innerHTML = svgTelegram + ' Continuar con Telegram'; return; }
          try {
            const c = await fetch('/api/webapp/auth/telegram/check?token=' + data.token + '&_t=' + Date.now(), { credentials: 'include', cache: 'no-store' });
            const r = await c.json();
            if (r.authenticated) { clearInterval(_tgPollInterval); showBanner('success', '¡Bienvenido! Redirigiendo...'); setTimeout(() => { location.href = CANONICAL_APP_URL; }, 800); }
          } catch {}
        }, 2000);
      } catch { showBanner('error', 'Error de red.'); btn.disabled = false; btn.innerHTML = svgTelegram + ' Continuar con Telegram'; }
    }

    // ── X (Twitter) OAuth ─────────────────────────────────────────────────────
    function handleXLogin() {
      clearBanners();
      // Direct navigation — ensures same session cookie is used for start and callback
      window.location.href = '/api/webapp/auth/x/start?redirect=true';
    }
  </script>

</body>
</html>
