<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNPtv Videorama!</title>

    <!-- Materialize CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- Unified Design System -->
    <link rel="stylesheet" href="/unified-design.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 64px;
        }

        /* Navbar Styling */
        nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        nav .brand-logo {
            font-weight: 700;
            letter-spacing: 1px;
            margin-left: 20px;
        }

        nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Main Container */
        .main-container {
            background: white;
            border-radius: 8px;
            margin: 30px auto;
            max-width: 1200px;
            min-height: calc(100vh - 200px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
        }

        /* Header Section */
        .header-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header-section h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header-section p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Search & Filter Section */
        .search-section {
            padding: 30px;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-wrapper {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .input-field input {
            border-bottom: 2px solid #667eea;
        }

        .input-field input:focus {
            border-bottom-color: #764ba2;
            box-shadow: 0 1px 0 0 #764ba2;
        }

        .btn-search {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-top: 5px;
        }

        .btn-search:hover {
            background: linear-gradient(135deg, #5568d3 0%, #663a91 100%);
        }

        .filter-chips {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .chip {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chip:hover,
        .chip.active {
            background: #667eea;
            color: white;
        }

        /* Content Area */
        .content-area {
            padding: 40px 30px;
            min-height: 600px;
        }

        /* Playlist Grid */
        .playlist-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        /* Playlist Card */
        .playlist-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .playlist-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .playlist-thumbnail {
            width: 100%;
            height: 160px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 3rem;
            position: relative;
            overflow: hidden;
        }

        .playlist-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .playlist-thumbnail .overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .playlist-card:hover .overlay {
            opacity: 1;
        }

        .overlay-icon {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: #667eea;
        }

        .playlist-content {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .playlist-content h3 {
            color: #333;
            font-size: 1.1rem;
            margin: 0 0 10px 0;
            font-weight: 600;
            line-height: 1.3;
        }

        .playlist-content p {
            color: #999;
            font-size: 0.9rem;
            margin: 0 0 15px 0;
            line-height: 1.4;
            flex-grow: 1;
        }

        .playlist-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
            color: #666;
            font-size: 0.85rem;
        }

        .video-count {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-play {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            margin-top: 10px;
            width: 100%;
        }

        .btn-play:hover {
            background: linear-gradient(135deg, #5568d3 0%, #663a91 100%);
        }

        /* Icon Button */
        .btn-icon-small {
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .btn-icon-small:hover {
            transform: scale(1.1);
        }

        /* Tabs */
        .tabs {
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
        }

        .tabs .tab a {
            color: #667eea;
            font-weight: 500;
        }

        .tabs .tab a.active {
            color: #764ba2;
            border-bottom: 3px solid #764ba2;
        }

        .tab-content {
            padding: 30px;
        }

        /* Video List */
        .video-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .video-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
            cursor: pointer;
            align-items: flex-start;
        }

        .video-item:hover {
            background: #f9f9f9;
            border-color: #667eea;
        }

        .video-thumbnail {
            width: 100px;
            height: 70px;
            border-radius: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            overflow: hidden;
        }

        .video-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-info {
            flex-grow: 1;
        }

        .video-info h4 {
            color: #333;
            margin: 0 0 5px 0;
            font-weight: 600;
            line-height: 1.3;
        }

        .video-info p {
            color: #999;
            font-size: 0.85rem;
            margin: 0;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 30px;
            color: #999;
        }

        .empty-state i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #666;
            margin-bottom: 10px;
        }

        /* Footer */
        .footer-section {
            background: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            padding: 20px 30px;
            text-align: center;
            color: #999;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding-top: 56px;
            }

            .header-section h1 {
                font-size: 1.8rem;
            }

            .playlist-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 15px;
            }

            .search-wrapper {
                flex-direction: column;
            }

            .filter-chips {
                margin-top: 10px;
            }

            .playlist-card {
                margin: 0;
            }

            .main-container {
                margin: 15px auto;
                border-radius: 0;
            }
        }

        /* Loading Spinner */
        .spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        .preloader-wrapper.small {
            height: 36px;
            width: 36px;
            margin: auto;
        }

        /* Scrollbar Styling */
        .video-list::-webkit-scrollbar {
            width: 6px;
        }

        .video-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .video-list::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }

        .video-list::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* Badge */
        .badge {
            background: #667eea;
            border-radius: 12px;
            padding: 4px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            margin-top: 10px;
        }

        .badge.featured {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* Creator Badge */
        .creator-badge {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #667eea;
            font-weight: 600;
            white-space: nowrap;
            display: inline-block;
        }

        /* PNPtv Creator Badge (highlighted) */
        .creator-badge[title*="PNPtv"] {
            border-left-color: #FFD700;
            color: #FFD700;
            background: rgba(255, 215, 0, 0.15);
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        /* Floating Action Button */
        .fab-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 999;
        }

        .btn-fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }

        .btn-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 600px) {
            .fab-container {
                bottom: 20px;
                right: 20px;
            }

            .btn-fab {
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-wrapper">
            <a href="/" class="brand-logo">
                <i class="material-icons" style="vertical-align: middle; margin-right: 10px;">play_circle_filled</i>
                PNPtv Videorama!
            </a>
            <ul class="right hide-on-med-and-down">
                <li><a href="/" title="Home"><i class="material-icons">home</i></a></li>
                <li><a href="/radio.html" title="Radio"><i class="material-icons">radio</i></a></li>
                <li><a href="/videorama" title="Videorama"><i class="material-icons">videocam</i></a></li>
                <li><a href="#language" title="Language"><i class="material-icons">language</i></a></li>
            </ul>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Header -->
        <div class="header-section">
            <h1>ðŸŽ¬ PNPtv Videorama!</h1>
            <p>Discover and enjoy curated playlists from PNPtv</p>
        </div>

        <!-- Search & Filter -->
        <div class="search-section">
            <div class="search-wrapper">
                <div class="input-field" style="flex: 1; min-width: 250px;">
                    <i class="material-icons prefix">search</i>
                    <input id="searchInput" type="text" placeholder="Search playlists...">
                </div>
                <button class="btn btn-search" onclick="handleSearch()">
                    <i class="material-icons left">search</i>Search
                </button>
            </div>

            <div class="filter-chips">
                <div class="chip" data-filter="all" onclick="filterPlaylists(this)">
                    <i class="material-icons left">apps</i>All
                </div>
                <div class="chip" data-filter="featured" onclick="filterPlaylists(this)">
                    <i class="material-icons left">star</i>Featured
                </div>
                <div class="chip" data-filter="music" onclick="filterPlaylists(this)">
                    <i class="material-icons left">music_note</i>Music
                </div>
                <div class="chip" data-filter="podcast" onclick="filterPlaylists(this)">
                    <i class="material-icons left">podcasts</i>Podcasts
                </div>
                <div class="chip" data-filter="education" onclick="filterPlaylists(this)">
                    <i class="material-icons left">school</i>Education
                </div>
                <div class="chip" data-filter="entertainment" onclick="filterPlaylists(this)">
                    <i class="material-icons left">theaters</i>Entertainment
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="row" style="margin: 0; display: flex; align-items: center; padding: 10px 30px; background: #f5f5f5; border-bottom: 2px solid #e0e0e0;">
            <div class="col s12" style="flex: 1;">
                <ul class="tabs" style="margin: 0;">
                    <li class="tab col s6 m3">
                        <a class="active" href="#tab-playlists">
                            <i class="material-icons">playlist_play</i>Playlists
                        </a>
                    </li>
                    <li class="tab col s6 m3">
                        <a href="#tab-favorites">
                            <i class="material-icons">favorite</i>Favorites
                        </a>
                    </li>
                </ul>
            </div>
            <button class="btn" id="createPlaylistBtn" onclick="openCreatePlaylistModal()" style="margin-left: auto; margin-right: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="material-icons left">add_circle</i>Create Playlist
            </button>
        </div>

        <!-- Create Playlist Modal -->
        <div id="createPlaylistModal" class="modal">
            <div class="modal-content">
                <h4>Create a New Playlist</h4>
                <p>Share your music taste with the PNPtv community!</p>

                <div class="input-field">
                    <input id="playlistTitle" type="text" placeholder="Playlist Title">
                    <label for="playlistTitle">Title</label>
                </div>

                <div class="input-field">
                    <textarea id="playlistDescription" class="materialize-textarea" placeholder="Describe your playlist..."></textarea>
                    <label for="playlistDescription">Description</label>
                </div>

                <div class="input-field">
                    <select id="playlistCategory">
                        <option value="">Select Category</option>
                        <option value="music">Music</option>
                        <option value="podcast">Podcast</option>
                        <option value="education">Education</option>
                        <option value="entertainment">Entertainment</option>
                    </select>
                    <label>Category</label>
                </div>

                <div class="input-field">
                    <input id="creatorName" type="text" placeholder="Your Name">
                    <label for="creatorName">Creator Name</label>
                </div>

                <div class="input-field">
                    <input id="creatorEmoji" type="text" value="ðŸ‘¤" placeholder="Pick an emoji" maxlength="2">
                    <label for="creatorEmoji">Creator Emoji (optional)</label>
                </div>

                <div class="input-field">
                    <input id="videoLinks" type="text" placeholder="YouTube links (comma-separated)">
                    <label for="videoLinks">Video Links (comma-separated)</label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-flat" onclick="closeCreatePlaylistModal()">Cancel</button>
                <button class="btn" onclick="savePlaylist()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="material-icons left">check</i>Create Playlist
                </button>
            </div>
        </div>

        <!-- Video Player Modal -->
        <div id="videoPlayerModal" class="modal" style="max-width: 90%; width: 1200px; height: 90%;">
            <div class="modal-content" style="padding: 0; height: 100%;">
                <div style="position: relative; height: 100%; display: flex; flex-direction: column;">
                    <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h5 id="videoPlayerTitle" style="margin: 0; font-weight: 600;">Now Playing</h5>
                        <p id="videoPlayerSubtitle" style="margin: 5px 0 0 0; opacity: 0.9;">Loading...</p>
                    </div>
                    <div id="videoPlayerContainer" style="flex: 1; background: #000; position: relative;">
                        <iframe id="videoPlayerFrame"
                                style="width: 100%; height: 100%; border: none;"
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                                allowfullscreen>
                        </iframe>
                    </div>
                    <div style="padding: 15px; background: #f5f5f5; border-top: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <button class="btn" onclick="playPreviousVideo()" id="prevBtn">
                                <i class="material-icons left">skip_previous</i>Previous
                            </button>
                            <div style="text-align: center; flex: 1; min-width: 200px;">
                                <span id="videoPosition">1 / 9</span>
                            </div>
                            <button class="btn" onclick="playNextVideo()" id="nextBtn">
                                <i class="material-icons right">skip_next</i>Next
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 10px 24px;">
                <button class="btn-flat" onclick="closeVideoPlayer()">Close Player</button>
            </div>
        </div>

        <div class="row" style="margin: 0;">

            <!-- Playlists Tab -->
            <div id="tab-playlists" class="col s12 tab-content">
                <div id="playlistsContainer" class="playlist-grid">
                    <!-- Playlists will be loaded here -->
                </div>
                <div id="emptyState" class="empty-state" style="display: none;">
                    <i class="material-icons">not_interested</i>
                    <h3>No playlists found</h3>
                    <p>Try adjusting your search filters</p>
                </div>
            </div>

            <!-- Favorites Tab -->
            <div id="tab-favorites" class="col s12 tab-content">
                <div id="favoritesContainer" class="playlist-grid">
                    <!-- Favorite playlists will be loaded here -->
                </div>
                <div id="emptyFavorites" class="empty-state">
                    <i class="material-icons">favorite_border</i>
                    <h3>No favorites yet</h3>
                    <p>Start adding playlists to your favorites by clicking the heart icon</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer-section">
            <p>&copy; 2025 PNPtv. Powered by Invidious. All rights reserved.</p>
        </div>
    </div>

    <!-- Floating Action Button -->
    <div class="fab-container">
        <button class="btn-fab" onclick="scrollToTop()" title="Back to top">
            <i class="material-icons">arrow_upward</i>
        </button>
    </div>

    <!-- Materialize JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

    <script>
        // PNPtv Featured Playlist (Official)
        let playlists = [
            {
                id: 1,
                title: 'Emotional Rollercoaster',
                description: 'A narrative journey through impulse, mental noise, intrusive thoughts, emotional numbness, breaking points, acceptance, and landing back in reality. Listen in order. Let each song do its work. It\\'s not a party. It\\'s a journey.',
                category: 'music',
                icon: 'ðŸŽ¢',
                videoCount: 12,
                featured: true,
                creator: 'PNPtv',
                creatorBadge: 'ðŸ‘‘',
                thumbnail: 'https://i.ytimg.com/vi/_9BGLtqqkVI/hqdefault.jpg',
                videos: [
                    { title: '1. Hash Pipe - Weezer', url: 'https://www.youtube.com/watch?v=_9BGLtqqkVI', description: 'Impulso inicial: energÃ­a caÃ³tica, decisiones rÃ¡pidas, cero filtro. El momento donde todo arranca sin pensar demasiado.' },
                    { title: '2. Come Undone - Robbie Williams', url: 'https://www.youtube.com/watch?v=4D35vfQ7eZg', description: 'La euforia empieza a agrietarse. Sigue siendo intensa, pero ya convive con ansiedad y pÃ©rdida de control.' },
                    { title: '3. Don\'t Let Me Get Me - P!nk', url: 'https://www.youtube.com/watch?v=asaCQOZpqUQ', description: 'Auto-conflicto. FrustraciÃ³n. La mente girando contra sÃ­ misma.' },
                    { title: '4. Berghain - RosalÃ­a feat. BjÃ¶rk & Yves Tumor', url: 'https://www.youtube.com/watch?v=6TKYd-pHo1A', description: 'Pensamientos intrusivos: introspecciÃ³n intensa, diÃ¡logo interno invasivo, ideas que no se pueden apagar. AquÃ­ el viaje se vuelve mental.' },
                    { title: '5. Numb / Encore - Linkin Park & Jay-Z', url: 'https://www.youtube.com/watch?v=yS8lkzNF-eU', description: 'SaturaciÃ³n total. El ruido interno ya es constante y abrumador.' },
                    { title: '6. Habits (Stay High) - Tove Lo', url: 'https://www.youtube.com/watch?v=SYM-RJwSGQ8', description: 'El intento de escapar. RepeticiÃ³n emocional. Loop.' },
                    { title: '7. Novacane - Frank Ocean', url: 'https://www.youtube.com/watch?v=8PtP3AO4Rgo', description: 'Anestesia emocional. Nada dueleâ€¦ pero nada se siente.' },
                    { title: '8. When It Hurts So Bad - Lauryn Hill', url: 'https://www.youtube.com/watch?v=tG21lp8fNpM', description: 'El quiebre. La emociÃ³n que ya no se puede evitar.' },
                    { title: '9. Don\'t Leave Home - Dido', url: 'https://www.youtube.com/watch?v=vuGL6RZg_Gs', description: 'Aislamiento. Miedo. Necesidad de refugio.' },
                    { title: '10. Tears Dry on Their Own - Amy Winehouse', url: 'https://www.youtube.com/watch?v=j-GqgTX43wo', description: 'AceptaciÃ³n silenciosa. No todo se arregla, pero se sigue.' },
                    { title: '11. La Plata - Diomedes DÃ­az', url: 'https://www.youtube.com/watch?v=0MWlFi9d4c0', description: 'Aterrizaje terrenal. Memoria, culpa, realidad cotidiana.' },
                    { title: '12. Thank U - Alanis Morissette', url: 'https://www.youtube.com/watch?v=JXRmZRmpsbE', description: 'No es felicidad forzada. Es conciencia. Gratitud por lo aprendido, incluso por lo incÃ³modo.' }
                ]
            }
        ];

        let currentFilter = 'all';
        let favorites = JSON.parse(localStorage.getItem('playlistFavorites')) || [];
        let userPlaylists = JSON.parse(localStorage.getItem('userPlaylists')) || [];

        // Utility function to escape HTML and prevent XSS
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            const div = document.createElement('div');
            div.textContent = unsafe;
            return div.innerHTML;
        }

        // Merge all playlists (PNPtv + user + API)
        async function getAllPlaylists() {
            let allPlaylists = [...playlists];

            // Add localStorage user playlists
            userPlaylists.forEach(userPlaylist => {
                allPlaylists.push({
                    ...userPlaylist,
                    featured: Math.random() < 0.3
                });
            });

            // Fetch public playlists from API
            try {
                const response = await fetch('/api/playlists/public');
                if (response.ok) {
                    const apiPlaylists = await response.json();
                    apiPlaylists.forEach(p => {
                        allPlaylists.push({
                            id: p.id,
                            title: p.title,
                            description: p.description,
                            category: p.category,
                            icon: p.icon || 'ðŸŽµ',
                            videoCount: p.videoCount,
                            thumbnail: p.thumbnail,
                            videos: p.videos,
                            featured: p.featured,
                            creator: p.creator || 'User',
                            creatorBadge: p.creatorBadge || 'ðŸ‘¤'
                        });
                    });
                }
            } catch (error) {
                console.log('Could not load API playlists:', error);
            }

            return allPlaylists;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            M.Tabs.init(document.querySelectorAll('.tabs'));
            renderPlaylists();
            renderFavorites();
        });

        // Render Playlists
        async function renderPlaylists(filter = 'all') {
            const container = document.getElementById('playlistsContainer');
            const emptyState = document.getElementById('emptyState');

            let allPlaylists = await getAllPlaylists();
            let filtered = allPlaylists;

            if (filter !== 'all') {
                filtered = allPlaylists.filter(p => p.category === filter);
            }

            if (filtered.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            container.innerHTML = filtered.map(playlist => `
                <div class="playlist-card" onclick="viewPlaylist(${playlist.id})">
                    <div class="playlist-thumbnail">
                        <img src="${escapeHtml(playlist.thumbnail)}" alt="${escapeHtml(playlist.title)}">
                        <div class="overlay">
                            <div class="overlay-icon">
                                <i class="material-icons">play_arrow</i>
                            </div>
                        </div>
                    </div>
                    <div class="playlist-content">
                        <h3>${escapeHtml(playlist.title)}</h3>
                        <p>${escapeHtml(playlist.description)}</p>
                        <div style="margin-top: auto; display: flex; gap: 8px; align-items: center;">
                            ${playlist.featured ? '<span class="badge featured">Featured</span>' : ''}
                            <span class="creator-badge" title="Created by ${escapeHtml(playlist.creator)}">
                                ${escapeHtml(playlist.creatorBadge || 'ðŸ‘¤')} ${escapeHtml(playlist.creator)}
                            </span>
                        </div>
                    </div>
                    <div class="playlist-info">
                        <div class="video-count">
                            <i class="material-icons" style="font-size: 1rem;">play_circle</i>
                            ${playlist.videoCount} videos
                        </div>
                        <button class="btn-icon-small" onclick="toggleFavorite(event, ${playlist.id})" title="Add to favorites">
                            <i class="material-icons" style="font-size: 1.2rem; color: ${favorites.includes(playlist.id) ? '#667eea' : '#ccc'};">
                                ${favorites.includes(playlist.id) ? 'favorite' : 'favorite_border'}
                            </i>
                        </button>
                    </div>
                    <button class="btn btn-play" onclick="playPlaylist(event, ${playlist.id})">
                        <i class="material-icons left">play_arrow</i>Play All
                    </button>
                </div>
            `).join('');
        }

        // Render Favorites
        async function renderFavorites() {
            const container = document.getElementById('favoritesContainer');
            const emptyFavorites = document.getElementById('emptyFavorites');

            let allPlaylists = await getAllPlaylists();
            const favoritePlaylists = allPlaylists.filter(p => favorites.includes(p.id));

            if (favoritePlaylists.length === 0) {
                container.style.display = 'none';
                emptyFavorites.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyFavorites.style.display = 'none';

            container.innerHTML = favoritePlaylists.map(playlist => `
                <div class="playlist-card" onclick="viewPlaylist(${playlist.id})">
                    <div class="playlist-thumbnail">
                        <img src="${escapeHtml(playlist.thumbnail)}" alt="${escapeHtml(playlist.title)}">
                        <div class="overlay">
                            <div class="overlay-icon">
                                <i class="material-icons">play_arrow</i>
                            </div>
                        </div>
                    </div>
                    <div class="playlist-content">
                        <h3>${escapeHtml(playlist.title)}</h3>
                        <p>${escapeHtml(playlist.description)}</p>
                        <div style="margin-top: auto; display: flex; gap: 8px; align-items: center;">
                            ${playlist.featured ? '<span class="badge featured">Featured</span>' : ''}
                            <span class="creator-badge" title="Created by ${escapeHtml(playlist.creator)}">
                                ${escapeHtml(playlist.creatorBadge || 'ðŸ‘¤')} ${escapeHtml(playlist.creator)}
                            </span>
                        </div>
                    </div>
                    <div class="playlist-info">
                        <div class="video-count">
                            <i class="material-icons" style="font-size: 1rem;">play_circle</i>
                            ${playlist.videoCount} videos
                        </div>
                        <button class="btn-icon-small" onclick="toggleFavorite(event, ${playlist.id})" title="Remove from favorites">
                            <i class="material-icons" style="font-size: 1.2rem; color: #667eea;">favorite</i>
                        </button>
                    </div>
                    <button class="btn btn-play" onclick="playPlaylist(event, ${playlist.id})">
                        <i class="material-icons left">play_arrow</i>Play All
                    </button>
                </div>
            `).join('');
        }

        // Filter Playlists
        function filterPlaylists(element) {
            document.querySelectorAll('.filter-chips .chip').forEach(chip => {
                chip.classList.remove('active');
            });
            element.classList.add('active');

            currentFilter = element.dataset.filter;
            renderPlaylists(currentFilter);
        }

        // Toggle Favorite
        function toggleFavorite(event, playlistId) {
            event.stopPropagation();

            const index = favorites.indexOf(playlistId);
            if (index > -1) {
                favorites.splice(index, 1);
            } else {
                favorites.push(playlistId);
            }

            localStorage.setItem('playlistFavorites', JSON.stringify(favorites));
            renderPlaylists(currentFilter);
            renderFavorites();

            M.toast({
                html: index > -1 ? 'Removed from favorites' : 'Added to favorites',
                displayLength: 2000
            });
        }

        // Play Playlist
        async function playPlaylist(event, playlistId) {
            event.stopPropagation();
            const allPlaylists = await getAllPlaylists();
            const playlist = allPlaylists.find(p => p.id === playlistId);

            if (playlist && playlist.videos && playlist.videos.length > 0) {
                // Open first video in the playlist
                const firstVideo = playlist.videos[0];
                if (firstVideo.url) {
                    window.open(firstVideo.url, '_blank');
                    M.toast({
                        html: `<i class="material-icons left">play_arrow</i>Playing: ${playlist.title}`,
                        displayLength: 3000
                    });
                }
            }
        }

        // View Playlist Details
        async function viewPlaylist(playlistId) {
            const allPlaylists = await getAllPlaylists();
            const playlist = allPlaylists.find(p => p.id === playlistId);

            // Show modal with playlist details
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'playlistModal';
            modal.style.maxHeight = '90vh';
            modal.innerHTML = `
                <div class="modal-content">
                    <h4>${playlist.title}</h4>
                    <p>${playlist.description}</p>
                    <div class="video-list" style="max-height: 60vh; overflow-y: auto;">
                        ${playlist.videos.map((video, index) => `
                            <div class="video-item" style="cursor: pointer; padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: flex-start; gap: 15px;" onclick="window.open('${video.url}', '_blank')">
                                <div class="video-thumbnail" style="flex-shrink: 0;">
                                    <i class="material-icons" style="font-size: 2rem; color: #667eea;">play_circle</i>
                                </div>
                                <div class="video-info" style="flex: 1;">
                                    <h6 style="margin: 0 0 8px 0; font-weight: 600; color: #333;">${video.title}</h6>
                                    ${video.description ? `<p style="margin: 0; font-size: 0.85rem; color: #666; line-height: 1.4;">${video.description}</p>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-flat" onclick="closePlaylistModal()">Close</button>
                    <button class="btn btn-play" onclick="playPlaylist(event, ${playlist.id})" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <i class="material-icons left">play_arrow</i>Play First Video
                    </button>
                </div>
            `;

            document.body.appendChild(modal);
            const instance = M.Modal.init(modal, { dismissible: true });
            instance.open();
        }

        // Close Playlist Modal
        function closePlaylistModal() {
            const modal = document.getElementById('playlistModal');
            const instance = M.Modal.getInstance(modal);
            instance.close();
            modal.remove();
        }

        // Search
        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();

            if (!query) {
                renderPlaylists(currentFilter);
                return;
            }

            const container = document.getElementById('playlistsContainer');
            const emptyState = document.getElementById('emptyState');

            const filtered = playlists.filter(p =>
                p.title.toLowerCase().includes(query) ||
                p.description.toLowerCase().includes(query)
            );

            if (filtered.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';

            container.innerHTML = filtered.map(playlist => `
                <div class="playlist-card" onclick="viewPlaylist(${playlist.id})">
                    <div class="playlist-thumbnail">
                        <img src="${playlist.thumbnail}" alt="${playlist.title}">
                        <div class="overlay">
                            <div class="overlay-icon">
                                <i class="material-icons">play_arrow</i>
                            </div>
                        </div>
                    </div>
                    <div class="playlist-content">
                        <h3>${playlist.title}</h3>
                        <p>${playlist.description}</p>
                    </div>
                    <div class="playlist-info">
                        <div class="video-count">
                            <i class="material-icons" style="font-size: 1rem;">play_circle</i>
                            ${playlist.videoCount} videos
                        </div>
                    </div>
                    <button class="btn btn-play" onclick="playPlaylist(event, ${playlist.id})">
                        <i class="material-icons left">play_arrow</i>Play All
                    </button>
                </div>
            `).join('');
        }

        // Scroll to Top
        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Search on Enter
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleSearch();
                }
            });
        });

        // Set first chip as active
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.filter-chips .chip').classList.add('active');
            M.Modal.init(document.getElementById('createPlaylistModal'));
            M.updateTextFields();
            M.FormSelect.init(document.querySelectorAll('select'));
        });

        // Create Playlist Modal Functions
        function openCreatePlaylistModal() {
            const modal = M.Modal.getInstance(document.getElementById('createPlaylistModal'));
            modal.open();
        }

        function closeCreatePlaylistModal() {
            const modal = M.Modal.getInstance(document.getElementById('createPlaylistModal'));
            modal.close();
        }

        function savePlaylist() {
            const title = document.getElementById('playlistTitle').value.trim();
            const description = document.getElementById('playlistDescription').value.trim();
            const category = document.getElementById('playlistCategory').value;
            const creator = document.getElementById('creatorName').value.trim();
            const emoji = document.getElementById('creatorEmoji').value || 'ðŸ‘¤';
            const videoLinks = document.getElementById('videoLinks').value;

            // Validation
            if (!title || !description || !category || !creator) {
                M.toast({
                    html: '<i class="material-icons left">warning</i>Please fill in all required fields',
                    displayLength: 3000
                });
                return;
            }

            if (!videoLinks) {
                M.toast({
                    html: '<i class="material-icons left">warning</i>Please add at least one video link',
                    displayLength: 3000
                });
                return;
            }

            // Parse video links and create videos array
            const links = videoLinks.split(',').map(link => link.trim()).filter(link => link);

            // Extract YouTube video IDs from URLs
            const videos = links.map((link, index) => {
                const videoId = extractYouTubeVideoId(link);
                return {
                    title: `Video ${index + 1}`,
                    duration: '--:--',
                    videoId: videoId || null
                };
            });

            // Create new playlist
            const newPlaylist = {
                id: Date.now(), // Use timestamp as unique ID
                title: title,
                description: description,
                category: category,
                icon: emoji,
                videoCount: videos.length,
                creator: creator,
                creatorBadge: emoji,
                featured: false, // User playlists start as not featured, but have 30% chance when rendered
                thumbnail: `https://via.placeholder.com/280x160?text=${encodeURIComponent(title)}`,
                videos: videos,
                links: links
            };

            // Save to localStorage
            userPlaylists.push(newPlaylist);
            localStorage.setItem('userPlaylists', JSON.stringify(userPlaylists));

            // Reset form and close modal
            document.getElementById('playlistTitle').value = '';
            document.getElementById('playlistDescription').value = '';
            document.getElementById('playlistCategory').value = '';
            document.getElementById('creatorName').value = '';
            document.getElementById('creatorEmoji').value = 'ðŸ‘¤';
            document.getElementById('videoLinks').value = '';

            M.updateTextFields();

            closeCreatePlaylistModal();

            // Show success message
            M.toast({
                html: `<i class="material-icons left">check_circle</i>Playlist "${title}" created successfully!`,
                displayLength: 3000
            });

            // Refresh the playlists view
            renderPlaylists(currentFilter);
            renderFavorites();
        }

        // Helper function to extract YouTube video ID from URL
        function extractYouTubeVideoId(url) {
            // Support various YouTube URL formats:
            // - https://www.youtube.com/watch?v=VIDEO_ID
            // - https://youtu.be/VIDEO_ID
            // - https://www.youtube.com/embed/VIDEO_ID
            // - Just VIDEO_ID

            if (!url) return null;

            // If it's already just an ID (11 characters, alphanumeric)
            if (/^[a-zA-Z0-9_-]{11}$/.test(url)) {
                return url;
            }

            // Try to extract from various URL formats
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
                /^([a-zA-Z0-9_-]{11})$/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    return match[1];
                }
            }

            return null;
        }

        // Video Player functionality
        let currentPlaylist = null;
        let currentVideoIndex = 0;
        let videoPlayerModalInstance = null;
        let currentInvidiousInstance = null;

        // List of fallback Invidious instances
        const INVIDIOUS_INSTANCES = [
            'https://invidious.io',
            'https://inv.nadeko.net',
            'https://invidious.snopyta.org',
            'https://iv.ggtyler.dev',
            'https://invidious.nerdvpn.org',
        ];

        // Initialize video player modal
        document.addEventListener('DOMContentLoaded', () => {
            const videoPlayerModal = document.getElementById('videoPlayerModal');
            videoPlayerModalInstance = M.Modal.init(videoPlayerModal, {
                dismissible: true,
                onCloseStart: function() {
                    // Stop video when closing
                    const iframe = document.getElementById('videoPlayerFrame');
                    iframe.src = '';
                }
            });
        });

        // Test if an Invidious instance is working
        async function testInvidiousInstance(instance) {
            try {
                const response = await fetch(`${instance}/api/v1/stats`, { timeout: 3000 });
                return response.ok;
            } catch (error) {
                console.warn(`Invidious instance ${instance} failed:`, error.message);
                return false;
            }
        }

        // Get a working Invidious instance
        async function getWorkingInstance() {
            if (currentInvidiousInstance) {
                return currentInvidiousInstance;
            }

            for (const instance of INVIDIOUS_INSTANCES) {
                if (await testInvidiousInstance(instance)) {
                    currentInvidiousInstance = instance;
                    console.log(`Using Invidious instance: ${instance}`);
                    return instance;
                }
            }

            // If no instance works, default to first one and hope for the best
            console.warn('No working Invidious instances found, using fallback');
            currentInvidiousInstance = INVIDIOUS_INSTANCES[0];
            return currentInvidiousInstance;
        }

        // Open video player
        async function openVideoPlayer(videoId, playlist, videoIndex) {
            currentPlaylist = playlist;
            currentVideoIndex = videoIndex;

            const video = playlist.videos[videoIndex];

            // Update player UI
            document.getElementById('videoPlayerTitle').textContent = video.title;
            document.getElementById('videoPlayerSubtitle').textContent = `${playlist.title} - ${playlist.creator}`;
            document.getElementById('videoPosition').textContent = `${videoIndex + 1} / ${playlist.videos.length}`;

            // Get a working Invidious instance
            const invidiousInstance = await getWorkingInstance();
            const embedUrl = `${invidiousInstance}/embed/${videoId}?autoplay=1`;

            // Load video in iframe
            const iframe = document.getElementById('videoPlayerFrame');
            iframe.src = embedUrl;

            // Update button states
            document.getElementById('prevBtn').disabled = videoIndex === 0;
            document.getElementById('nextBtn').disabled = videoIndex === playlist.videos.length - 1;

            // Open modal
            videoPlayerModalInstance.open();
        }

        // Play next video
        function playNextVideo() {
            if (!currentPlaylist || currentVideoIndex >= currentPlaylist.videos.length - 1) {
                M.toast({
                    html: '<i class="material-icons left">info</i>No more videos in playlist',
                    displayLength: 2000
                });
                return;
            }

            currentVideoIndex++;
            const nextVideo = currentPlaylist.videos[currentVideoIndex];
            openVideoPlayer(nextVideo.videoId, currentPlaylist, currentVideoIndex);
        }

        // Play previous video
        function playPreviousVideo() {
            if (!currentPlaylist || currentVideoIndex <= 0) {
                M.toast({
                    html: '<i class="material-icons left">info</i>Already at first video',
                    displayLength: 2000
                });
                return;
            }

            currentVideoIndex--;
            const prevVideo = currentPlaylist.videos[currentVideoIndex];
            openVideoPlayer(prevVideo.videoId, currentPlaylist, currentVideoIndex);
        }

        // Close video player
        function closeVideoPlayer() {
            videoPlayerModalInstance.close();
            currentPlaylist = null;
            currentVideoIndex = 0;
        }

        // Play individual video from playlist modal
        async function playIndividualVideo(videoId, playlistId, videoIndex) {
            const allPlaylists = await getAllPlaylists();
            const playlist = allPlaylists.find(p => p.id === playlistId);

            if (playlist) {
                // Close the playlist details modal first
                closePlaylistModal();

                // Open video player
                setTimeout(() => {
                    openVideoPlayer(videoId, playlist, videoIndex);
                }, 300);
            }
        }
    </script>
</body>
</html>
