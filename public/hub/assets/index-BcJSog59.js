import{a as J9,b as Q9,g as NM,r as K,R as Fu,u as JT,L as pn,c as Z9,d as lT,e as DM,N as QT,f as $9,h as Bn,B as eJ}from"./vendor-BYwGbbwJ.js";import{S as tJ,R as PM,M as vf,F as nJ,H as iJ,U as ac,a as rJ,b as wu,C as hf,c as Rf,d as IT,X as Cf,e as sJ,f as ZT,T as bf,g as oJ,h as aJ,i as c1,j as cJ,k as $T,l as dJ,P as ev,m as lJ,L as tv,n as wf,o as Af,p as xu,V as Nu,q as LM,E as OT,r as uJ,s as hJ,t as pJ,u as mJ,v as kM,w as fJ,x as d1,y as _J,I as gJ,A as xM,z as cc,B as EJ,D as SJ,G as yJ,J as TJ,K as vJ,N as RJ,O as CJ,Q as bJ,W as wJ}from"./icons-RhNAWvM8.js";(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const y of document.querySelectorAll('link[rel="modulepreload"]'))f(y);new MutationObserver(y=>{for(const w of y)if(w.type==="childList")for(const A of w.addedNodes)A.tagName==="LINK"&&A.rel==="modulepreload"&&f(A)}).observe(document,{childList:!0,subtree:!0});function h(y){const w={};return y.integrity&&(w.integrity=y.integrity),y.referrerPolicy&&(w.referrerPolicy=y.referrerPolicy),y.crossOrigin==="use-credentials"?w.credentials="include":y.crossOrigin==="anonymous"?w.credentials="omit":w.credentials="same-origin",w}function f(y){if(y.ep)return;y.ep=!0;const w=h(y);fetch(y.href,w)}})();var uT={exports:{}},Tu={};var l1;function AJ(){if(l1)return Tu;l1=1;var d=J9(),l=Symbol.for("react.element"),h=Symbol.for("react.fragment"),f=Object.prototype.hasOwnProperty,y=d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,w={key:!0,ref:!0,__self:!0,__source:!0};function A(P,L,U){var M,V={},W=null,z=null;U!==void 0&&(W=""+U),L.key!==void 0&&(W=""+L.key),L.ref!==void 0&&(z=L.ref);for(M in L)f.call(L,M)&&!w.hasOwnProperty(M)&&(V[M]=L[M]);if(P&&P.defaultProps)for(M in L=P.defaultProps,L)V[M]===void 0&&(V[M]=L[M]);return{$$typeof:l,type:P,key:W,ref:z,props:V,_owner:y.current}}return Tu.Fragment=h,Tu.jsx=A,Tu.jsxs=A,Tu}var u1;function IJ(){return u1||(u1=1,uT.exports=AJ()),uT.exports}var E=IJ(),Km={},h1;function OJ(){if(h1)return Km;h1=1;var d=Q9();return Km.createRoot=d.createRoot,Km.hydrateRoot=d.hydrateRoot,Km}var NJ=OJ();const DJ=NM(NJ),MM=K.createContext({transformPagePoint:d=>d,isStatic:!1,reducedMotion:"never"}),If=K.createContext({}),Of=K.createContext(null),Nf=typeof document<"u",nv=Nf?K.useLayoutEffect:K.useEffect,UM=K.createContext({strict:!1}),iv=d=>d.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),PJ="framerAppearId",VM="data-"+iv(PJ);function LJ(d,l,h,f){const{visualElement:y}=K.useContext(If),w=K.useContext(UM),A=K.useContext(Of),P=K.useContext(MM).reducedMotion,L=K.useRef();f=f||w.renderer,!L.current&&f&&(L.current=f(d,{visualState:l,parent:y,props:h,presenceContext:A,blockInitialAnimation:A?A.initial===!1:!1,reducedMotionConfig:P}));const U=L.current;K.useInsertionEffect(()=>{U&&U.update(h,A)});const M=K.useRef(!!(h[VM]&&!window.HandoffComplete));return nv(()=>{U&&(U.render(),M.current&&U.animationState&&U.animationState.animateChanges())}),K.useEffect(()=>{U&&(U.updateFeatures(),!M.current&&U.animationState&&U.animationState.animateChanges(),M.current&&(M.current=!1,window.HandoffComplete=!0))}),U}function Vd(d){return d&&typeof d=="object"&&Object.prototype.hasOwnProperty.call(d,"current")}function kJ(d,l,h){return K.useCallback(f=>{f&&d.mount&&d.mount(f),l&&(f?l.mount(f):l.unmount()),h&&(typeof h=="function"?h(f):Vd(h)&&(h.current=f))},[l])}function Mu(d){return typeof d=="string"||Array.isArray(d)}function Df(d){return d!==null&&typeof d=="object"&&typeof d.start=="function"}const rv=["animate","whileInView","whileFocus","whileHover","whileTap","whileDrag","exit"],sv=["initial",...rv];function Pf(d){return Df(d.animate)||sv.some(l=>Mu(d[l]))}function jM(d){return!!(Pf(d)||d.variants)}function xJ(d,l){if(Pf(d)){const{initial:h,animate:f}=d;return{initial:h===!1||Mu(h)?h:void 0,animate:Mu(f)?f:void 0}}return d.inherit!==!1?l:{}}function MJ(d){const{initial:l,animate:h}=xJ(d,K.useContext(If));return K.useMemo(()=>({initial:l,animate:h}),[p1(l),p1(h)])}function p1(d){return Array.isArray(d)?d.join(" "):d}const m1={animation:["animate","variants","whileHover","whileTap","exit","whileInView","whileFocus","whileDrag"],exit:["exit"],drag:["drag","dragControls"],focus:["whileFocus"],hover:["whileHover","onHoverStart","onHoverEnd"],tap:["whileTap","onTap","onTapStart","onTapCancel"],pan:["onPan","onPanStart","onPanSessionStart","onPanEnd"],inView:["whileInView","onViewportEnter","onViewportLeave"],layout:["layout","layoutId"]},Uu={};for(const d in m1)Uu[d]={isEnabled:l=>m1[d].some(h=>!!l[h])};function UJ(d){for(const l in d)Uu[l]={...Uu[l],...d[l]}}const ov=K.createContext({}),FM=K.createContext({}),VJ=Symbol.for("motionComponentSymbol");function jJ({preloadedFeatures:d,createVisualElement:l,useRender:h,useVisualState:f,Component:y}){d&&UJ(d);function w(P,L){let U;const M={...K.useContext(MM),...P,layoutId:FJ(P)},{isStatic:V}=M,W=MJ(P),z=f(P,V);if(!V&&Nf){W.visualElement=LJ(y,z,M,l);const X=K.useContext(FM),$=K.useContext(UM).strict;W.visualElement&&(U=W.visualElement.loadFeatures(M,$,d,X))}return K.createElement(If.Provider,{value:W},U&&W.visualElement?K.createElement(U,{visualElement:W.visualElement,...M}):null,h(y,P,kJ(z,W.visualElement,L),z,V,W.visualElement))}const A=K.forwardRef(w);return A[VJ]=y,A}function FJ({layoutId:d}){const l=K.useContext(ov).id;return l&&d!==void 0?l+"-"+d:d}function BJ(d){function l(f,y={}){return jJ(d(f,y))}if(typeof Proxy>"u")return l;const h=new Map;return new Proxy(l,{get:(f,y)=>(h.has(y)||h.set(y,l(y)),h.get(y))})}const WJ=["animate","circle","defs","desc","ellipse","g","image","line","filter","marker","mask","metadata","path","pattern","polygon","polyline","rect","stop","switch","symbol","svg","text","tspan","use","view"];function av(d){return typeof d!="string"||d.includes("-")?!1:!!(WJ.indexOf(d)>-1||/[A-Z]/.test(d))}const pf={};function GJ(d){Object.assign(pf,d)}const Bu=["transformPerspective","x","y","z","translateX","translateY","translateZ","scale","scaleX","scaleY","rotate","rotateX","rotateY","rotateZ","skew","skewX","skewY"],lc=new Set(Bu);function BM(d,{layout:l,layoutId:h}){return lc.has(d)||d.startsWith("origin")||(l||h!==void 0)&&(!!pf[d]||d==="opacity")}const Qi=d=>!!(d&&d.getVelocity),HJ={x:"translateX",y:"translateY",z:"translateZ",transformPerspective:"perspective"},KJ=Bu.length;function YJ(d,{enableHardwareAcceleration:l=!0,allowTransformNone:h=!0},f,y){let w="";for(let A=0;A<KJ;A++){const P=Bu[A];if(d[P]!==void 0){const L=HJ[P]||P;w+=`${L}(${d[P]}) `}}return l&&!d.z&&(w+="translateZ(0)"),w=w.trim(),y?w=y(d,f?"":w):h&&f&&(w="none"),w}const WM=d=>l=>typeof l=="string"&&l.startsWith(d),GM=WM("--"),NT=WM("var(--"),zJ=/var\s*\(\s*--[\w-]+(\s*,\s*(?:(?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)+)?\s*\)/g,qJ=(d,l)=>l&&typeof d=="number"?l.transform(d):d,Zo=(d,l,h)=>Math.min(Math.max(h,d),l),uc={test:d=>typeof d=="number",parse:parseFloat,transform:d=>d},Du={...uc,transform:d=>Zo(0,1,d)},Ym={...uc,default:1},Pu=d=>Math.round(d*1e5)/1e5,Lf=/(-)?([\d]*\.?[\d])+/g,HM=/(#[0-9a-f]{3,8}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2}(-?[\d\.]+%?)\s*[\,\/]?\s*[\d\.]*%?\))/gi,XJ=/^(#[0-9a-f]{3,8}|(rgb|hsl)a?\((-?[\d\.]+%?[,\s]+){2}(-?[\d\.]+%?)\s*[\,\/]?\s*[\d\.]*%?\))$/i;function Wu(d){return typeof d=="string"}const Gu=d=>({test:l=>Wu(l)&&l.endsWith(d)&&l.split(" ").length===1,parse:parseFloat,transform:l=>`${l}${d}`}),qo=Gu("deg"),Vs=Gu("%"),dt=Gu("px"),JJ=Gu("vh"),QJ=Gu("vw"),f1={...Vs,parse:d=>Vs.parse(d)/100,transform:d=>Vs.transform(d*100)},_1={...uc,transform:Math.round},KM={borderWidth:dt,borderTopWidth:dt,borderRightWidth:dt,borderBottomWidth:dt,borderLeftWidth:dt,borderRadius:dt,radius:dt,borderTopLeftRadius:dt,borderTopRightRadius:dt,borderBottomRightRadius:dt,borderBottomLeftRadius:dt,width:dt,maxWidth:dt,height:dt,maxHeight:dt,size:dt,top:dt,right:dt,bottom:dt,left:dt,padding:dt,paddingTop:dt,paddingRight:dt,paddingBottom:dt,paddingLeft:dt,margin:dt,marginTop:dt,marginRight:dt,marginBottom:dt,marginLeft:dt,rotate:qo,rotateX:qo,rotateY:qo,rotateZ:qo,scale:Ym,scaleX:Ym,scaleY:Ym,scaleZ:Ym,skew:qo,skewX:qo,skewY:qo,distance:dt,translateX:dt,translateY:dt,translateZ:dt,x:dt,y:dt,z:dt,perspective:dt,transformPerspective:dt,opacity:Du,originX:f1,originY:f1,originZ:dt,zIndex:_1,fillOpacity:Du,strokeOpacity:Du,numOctaves:_1};function cv(d,l,h,f){const{style:y,vars:w,transform:A,transformOrigin:P}=d;let L=!1,U=!1,M=!0;for(const V in l){const W=l[V];if(GM(V)){w[V]=W;continue}const z=KM[V],X=qJ(W,z);if(lc.has(V)){if(L=!0,A[V]=X,!M)continue;W!==(z.default||0)&&(M=!1)}else V.startsWith("origin")?(U=!0,P[V]=X):y[V]=X}if(l.transform||(L||f?y.transform=YJ(d.transform,h,M,f):y.transform&&(y.transform="none")),U){const{originX:V="50%",originY:W="50%",originZ:z=0}=P;y.transformOrigin=`${V} ${W} ${z}`}}const dv=()=>({style:{},transform:{},transformOrigin:{},vars:{}});function YM(d,l,h){for(const f in l)!Qi(l[f])&&!BM(f,h)&&(d[f]=l[f])}function ZJ({transformTemplate:d},l,h){return K.useMemo(()=>{const f=dv();return cv(f,l,{enableHardwareAcceleration:!h},d),Object.assign({},f.vars,f.style)},[l])}function $J(d,l,h){const f=d.style||{},y={};return YM(y,f,d),Object.assign(y,ZJ(d,l,h)),d.transformValues?d.transformValues(y):y}function e7(d,l,h){const f={},y=$J(d,l,h);return d.drag&&d.dragListener!==!1&&(f.draggable=!1,y.userSelect=y.WebkitUserSelect=y.WebkitTouchCallout="none",y.touchAction=d.drag===!0?"none":`pan-${d.drag==="x"?"y":"x"}`),d.tabIndex===void 0&&(d.onTap||d.onTapStart||d.whileTap)&&(f.tabIndex=0),f.style=y,f}const t7=new Set(["animate","exit","variants","initial","style","values","variants","transition","transformTemplate","transformValues","custom","inherit","onBeforeLayoutMeasure","onAnimationStart","onAnimationComplete","onUpdate","onDragStart","onDrag","onDragEnd","onMeasureDragConstraints","onDirectionLock","onDragTransitionEnd","_dragX","_dragY","onHoverStart","onHoverEnd","onViewportEnter","onViewportLeave","globalTapTarget","ignoreStrict","viewport"]);function mf(d){return d.startsWith("while")||d.startsWith("drag")&&d!=="draggable"||d.startsWith("layout")||d.startsWith("onTap")||d.startsWith("onPan")||d.startsWith("onLayout")||t7.has(d)}let zM=d=>!mf(d);function n7(d){d&&(zM=l=>l.startsWith("on")?!mf(l):d(l))}try{n7(require("@emotion/is-prop-valid").default)}catch{}function i7(d,l,h){const f={};for(const y in d)y==="values"&&typeof d.values=="object"||(zM(y)||h===!0&&mf(y)||!l&&!mf(y)||d.draggable&&y.startsWith("onDrag"))&&(f[y]=d[y]);return f}function g1(d,l,h){return typeof d=="string"?d:dt.transform(l+h*d)}function r7(d,l,h){const f=g1(l,d.x,d.width),y=g1(h,d.y,d.height);return`${f} ${y}`}const s7={offset:"stroke-dashoffset",array:"stroke-dasharray"},o7={offset:"strokeDashoffset",array:"strokeDasharray"};function a7(d,l,h=1,f=0,y=!0){d.pathLength=1;const w=y?s7:o7;d[w.offset]=dt.transform(-f);const A=dt.transform(l),P=dt.transform(h);d[w.array]=`${A} ${P}`}function lv(d,{attrX:l,attrY:h,attrScale:f,originX:y,originY:w,pathLength:A,pathSpacing:P=1,pathOffset:L=0,...U},M,V,W){if(cv(d,U,M,W),V){d.style.viewBox&&(d.attrs.viewBox=d.style.viewBox);return}d.attrs=d.style,d.style={};const{attrs:z,style:X,dimensions:$}=d;z.transform&&($&&(X.transform=z.transform),delete z.transform),$&&(y!==void 0||w!==void 0||X.transform)&&(X.transformOrigin=r7($,y!==void 0?y:.5,w!==void 0?w:.5)),l!==void 0&&(z.x=l),h!==void 0&&(z.y=h),f!==void 0&&(z.scale=f),A!==void 0&&a7(z,A,P,L,!1)}const qM=()=>({...dv(),attrs:{}}),uv=d=>typeof d=="string"&&d.toLowerCase()==="svg";function c7(d,l,h,f){const y=K.useMemo(()=>{const w=qM();return lv(w,l,{enableHardwareAcceleration:!1},uv(f),d.transformTemplate),{...w.attrs,style:{...w.style}}},[l]);if(d.style){const w={};YM(w,d.style,d),y.style={...w,...y.style}}return y}function d7(d=!1){return(h,f,y,{latestValues:w},A)=>{const L=(av(h)?c7:e7)(f,w,A,h),M={...i7(f,typeof h=="string",d),...L,ref:y},{children:V}=f,W=K.useMemo(()=>Qi(V)?V.get():V,[V]);return K.createElement(h,{...M,children:W})}}function XM(d,{style:l,vars:h},f,y){Object.assign(d.style,l,y&&y.getProjectionStyles(f));for(const w in h)d.style.setProperty(w,h[w])}const JM=new Set(["baseFrequency","diffuseConstant","kernelMatrix","kernelUnitLength","keySplines","keyTimes","limitingConeAngle","markerHeight","markerWidth","numOctaves","targetX","targetY","surfaceScale","specularConstant","specularExponent","stdDeviation","tableValues","viewBox","gradientTransform","pathLength","startOffset","textLength","lengthAdjust"]);function QM(d,l,h,f){XM(d,l,void 0,f);for(const y in l.attrs)d.setAttribute(JM.has(y)?y:iv(y),l.attrs[y])}function hv(d,l){const{style:h}=d,f={};for(const y in h)(Qi(h[y])||l.style&&Qi(l.style[y])||BM(y,d))&&(f[y]=h[y]);return f}function ZM(d,l){const h=hv(d,l);for(const f in d)if(Qi(d[f])||Qi(l[f])){const y=Bu.indexOf(f)!==-1?"attr"+f.charAt(0).toUpperCase()+f.substring(1):f;h[y]=d[f]}return h}function pv(d,l,h,f={},y={}){return typeof l=="function"&&(l=l(h!==void 0?h:d.custom,f,y)),typeof l=="string"&&(l=d.variants&&d.variants[l]),typeof l=="function"&&(l=l(h!==void 0?h:d.custom,f,y)),l}function $M(d){const l=K.useRef(null);return l.current===null&&(l.current=d()),l.current}const ff=d=>Array.isArray(d),l7=d=>!!(d&&typeof d=="object"&&d.mix&&d.toValue),u7=d=>ff(d)?d[d.length-1]||0:d;function ef(d){const l=Qi(d)?d.get():d;return l7(l)?l.toValue():l}function h7({scrapeMotionValuesFromProps:d,createRenderState:l,onMount:h},f,y,w){const A={latestValues:p7(f,y,w,d),renderState:l()};return h&&(A.mount=P=>h(f,P,A)),A}const eU=d=>(l,h)=>{const f=K.useContext(If),y=K.useContext(Of),w=()=>h7(d,l,f,y);return h?w():$M(w)};function p7(d,l,h,f){const y={},w=f(d,{});for(const W in w)y[W]=ef(w[W]);let{initial:A,animate:P}=d;const L=Pf(d),U=jM(d);l&&U&&!L&&d.inherit!==!1&&(A===void 0&&(A=l.initial),P===void 0&&(P=l.animate));let M=h?h.initial===!1:!1;M=M||A===!1;const V=M?P:A;return V&&typeof V!="boolean"&&!Df(V)&&(Array.isArray(V)?V:[V]).forEach(z=>{const X=pv(d,z);if(!X)return;const{transitionEnd:$,transition:oe,...ve}=X;for(const Re in ve){let pe=ve[Re];if(Array.isArray(pe)){const fe=M?pe.length-1:0;pe=pe[fe]}pe!==null&&(y[Re]=pe)}for(const Re in $)y[Re]=$[Re]}),y}const Wn=d=>d;class E1{constructor(){this.order=[],this.scheduled=new Set}add(l){if(!this.scheduled.has(l))return this.scheduled.add(l),this.order.push(l),!0}remove(l){const h=this.order.indexOf(l);h!==-1&&(this.order.splice(h,1),this.scheduled.delete(l))}clear(){this.order.length=0,this.scheduled.clear()}}function m7(d){let l=new E1,h=new E1,f=0,y=!1,w=!1;const A=new WeakSet,P={schedule:(L,U=!1,M=!1)=>{const V=M&&y,W=V?l:h;return U&&A.add(L),W.add(L)&&V&&y&&(f=l.order.length),L},cancel:L=>{h.remove(L),A.delete(L)},process:L=>{if(y){w=!0;return}if(y=!0,[l,h]=[h,l],h.clear(),f=l.order.length,f)for(let U=0;U<f;U++){const M=l.order[U];M(L),A.has(M)&&(P.schedule(M),d())}y=!1,w&&(w=!1,P.process(L))}};return P}const zm=["prepare","read","update","preRender","render","postRender"],f7=40;function _7(d,l){let h=!1,f=!0;const y={delta:0,timestamp:0,isProcessing:!1},w=zm.reduce((V,W)=>(V[W]=m7(()=>h=!0),V),{}),A=V=>w[V].process(y),P=()=>{const V=performance.now();h=!1,y.delta=f?1e3/60:Math.max(Math.min(V-y.timestamp,f7),1),y.timestamp=V,y.isProcessing=!0,zm.forEach(A),y.isProcessing=!1,h&&l&&(f=!1,d(P))},L=()=>{h=!0,f=!0,y.isProcessing||d(P)};return{schedule:zm.reduce((V,W)=>{const z=w[W];return V[W]=(X,$=!1,oe=!1)=>(h||L(),z.schedule(X,$,oe)),V},{}),cancel:V=>zm.forEach(W=>w[W].cancel(V)),state:y,steps:w}}const{schedule:fn,cancel:lo,state:bi,steps:hT}=_7(typeof requestAnimationFrame<"u"?requestAnimationFrame:Wn,!0),g7={useVisualState:eU({scrapeMotionValuesFromProps:ZM,createRenderState:qM,onMount:(d,l,{renderState:h,latestValues:f})=>{fn.read(()=>{try{h.dimensions=typeof l.getBBox=="function"?l.getBBox():l.getBoundingClientRect()}catch{h.dimensions={x:0,y:0,width:0,height:0}}}),fn.render(()=>{lv(h,f,{enableHardwareAcceleration:!1},uv(l.tagName),d.transformTemplate),QM(l,h)})}})},E7={useVisualState:eU({scrapeMotionValuesFromProps:hv,createRenderState:dv})};function S7(d,{forwardMotionProps:l=!1},h,f){return{...av(d)?g7:E7,preloadedFeatures:h,useRender:d7(l),createVisualElement:f,Component:d}}function oo(d,l,h,f={passive:!0}){return d.addEventListener(l,h,f),()=>d.removeEventListener(l,h)}const tU=d=>d.pointerType==="mouse"?typeof d.button!="number"||d.button<=0:d.isPrimary!==!1;function kf(d,l="page"){return{point:{x:d[l+"X"],y:d[l+"Y"]}}}const y7=d=>l=>tU(l)&&d(l,kf(l));function ao(d,l,h,f){return oo(d,l,y7(h),f)}const T7=(d,l)=>h=>l(d(h)),Jo=(...d)=>d.reduce(T7);function nU(d){let l=null;return()=>{const h=()=>{l=null};return l===null?(l=d,h):!1}}const S1=nU("dragHorizontal"),y1=nU("dragVertical");function iU(d){let l=!1;if(d==="y")l=y1();else if(d==="x")l=S1();else{const h=S1(),f=y1();h&&f?l=()=>{h(),f()}:(h&&h(),f&&f())}return l}function rU(){const d=iU(!0);return d?(d(),!1):!0}class ta{constructor(l){this.isMounted=!1,this.node=l}update(){}}function T1(d,l){const h="pointer"+(l?"enter":"leave"),f="onHover"+(l?"Start":"End"),y=(w,A)=>{if(w.pointerType==="touch"||rU())return;const P=d.getProps();d.animationState&&P.whileHover&&d.animationState.setActive("whileHover",l),P[f]&&fn.update(()=>P[f](w,A))};return ao(d.current,h,y,{passive:!d.getProps()[f]})}class v7 extends ta{mount(){this.unmount=Jo(T1(this.node,!0),T1(this.node,!1))}unmount(){}}class R7 extends ta{constructor(){super(...arguments),this.isActive=!1}onFocus(){let l=!1;try{l=this.node.current.matches(":focus-visible")}catch{l=!0}!l||!this.node.animationState||(this.node.animationState.setActive("whileFocus",!0),this.isActive=!0)}onBlur(){!this.isActive||!this.node.animationState||(this.node.animationState.setActive("whileFocus",!1),this.isActive=!1)}mount(){this.unmount=Jo(oo(this.node.current,"focus",()=>this.onFocus()),oo(this.node.current,"blur",()=>this.onBlur()))}unmount(){}}const sU=(d,l)=>l?d===l?!0:sU(d,l.parentElement):!1;function pT(d,l){if(!l)return;const h=new PointerEvent("pointer"+d);l(h,kf(h))}class C7 extends ta{constructor(){super(...arguments),this.removeStartListeners=Wn,this.removeEndListeners=Wn,this.removeAccessibleListeners=Wn,this.startPointerPress=(l,h)=>{if(this.isPressing)return;this.removeEndListeners();const f=this.node.getProps(),w=ao(window,"pointerup",(P,L)=>{if(!this.checkPressEnd())return;const{onTap:U,onTapCancel:M,globalTapTarget:V}=this.node.getProps();fn.update(()=>{!V&&!sU(this.node.current,P.target)?M&&M(P,L):U&&U(P,L)})},{passive:!(f.onTap||f.onPointerUp)}),A=ao(window,"pointercancel",(P,L)=>this.cancelPress(P,L),{passive:!(f.onTapCancel||f.onPointerCancel)});this.removeEndListeners=Jo(w,A),this.startPress(l,h)},this.startAccessiblePress=()=>{const l=w=>{if(w.key!=="Enter"||this.isPressing)return;const A=P=>{P.key!=="Enter"||!this.checkPressEnd()||pT("up",(L,U)=>{const{onTap:M}=this.node.getProps();M&&fn.update(()=>M(L,U))})};this.removeEndListeners(),this.removeEndListeners=oo(this.node.current,"keyup",A),pT("down",(P,L)=>{this.startPress(P,L)})},h=oo(this.node.current,"keydown",l),f=()=>{this.isPressing&&pT("cancel",(w,A)=>this.cancelPress(w,A))},y=oo(this.node.current,"blur",f);this.removeAccessibleListeners=Jo(h,y)}}startPress(l,h){this.isPressing=!0;const{onTapStart:f,whileTap:y}=this.node.getProps();y&&this.node.animationState&&this.node.animationState.setActive("whileTap",!0),f&&fn.update(()=>f(l,h))}checkPressEnd(){return this.removeEndListeners(),this.isPressing=!1,this.node.getProps().whileTap&&this.node.animationState&&this.node.animationState.setActive("whileTap",!1),!rU()}cancelPress(l,h){if(!this.checkPressEnd())return;const{onTapCancel:f}=this.node.getProps();f&&fn.update(()=>f(l,h))}mount(){const l=this.node.getProps(),h=ao(l.globalTapTarget?window:this.node.current,"pointerdown",this.startPointerPress,{passive:!(l.onTapStart||l.onPointerStart)}),f=oo(this.node.current,"focus",this.startAccessiblePress);this.removeStartListeners=Jo(h,f)}unmount(){this.removeStartListeners(),this.removeEndListeners(),this.removeAccessibleListeners()}}const DT=new WeakMap,mT=new WeakMap,b7=d=>{const l=DT.get(d.target);l&&l(d)},w7=d=>{d.forEach(b7)};function A7({root:d,...l}){const h=d||document;mT.has(h)||mT.set(h,{});const f=mT.get(h),y=JSON.stringify(l);return f[y]||(f[y]=new IntersectionObserver(w7,{root:d,...l})),f[y]}function I7(d,l,h){const f=A7(l);return DT.set(d,h),f.observe(d),()=>{DT.delete(d),f.unobserve(d)}}const O7={some:0,all:1};class N7 extends ta{constructor(){super(...arguments),this.hasEnteredView=!1,this.isInView=!1}startObserver(){this.unmount();const{viewport:l={}}=this.node.getProps(),{root:h,margin:f,amount:y="some",once:w}=l,A={root:h?h.current:void 0,rootMargin:f,threshold:typeof y=="number"?y:O7[y]},P=L=>{const{isIntersecting:U}=L;if(this.isInView===U||(this.isInView=U,w&&!U&&this.hasEnteredView))return;U&&(this.hasEnteredView=!0),this.node.animationState&&this.node.animationState.setActive("whileInView",U);const{onViewportEnter:M,onViewportLeave:V}=this.node.getProps(),W=U?M:V;W&&W(L)};return I7(this.node.current,A,P)}mount(){this.startObserver()}update(){if(typeof IntersectionObserver>"u")return;const{props:l,prevProps:h}=this.node;["amount","margin","root"].some(D7(l,h))&&this.startObserver()}unmount(){}}function D7({viewport:d={}},{viewport:l={}}={}){return h=>d[h]!==l[h]}const P7={inView:{Feature:N7},tap:{Feature:C7},focus:{Feature:R7},hover:{Feature:v7}};function oU(d,l){if(!Array.isArray(l))return!1;const h=l.length;if(h!==d.length)return!1;for(let f=0;f<h;f++)if(l[f]!==d[f])return!1;return!0}function L7(d){const l={};return d.values.forEach((h,f)=>l[f]=h.get()),l}function k7(d){const l={};return d.values.forEach((h,f)=>l[f]=h.getVelocity()),l}function xf(d,l,h){const f=d.getProps();return pv(f,l,h!==void 0?h:f.custom,L7(d),k7(d))}let mv=Wn;const dc=d=>d*1e3,co=d=>d/1e3,x7={current:!1},aU=d=>Array.isArray(d)&&typeof d[0]=="number";function cU(d){return!!(!d||typeof d=="string"&&dU[d]||aU(d)||Array.isArray(d)&&d.every(cU))}const Au=([d,l,h,f])=>`cubic-bezier(${d}, ${l}, ${h}, ${f})`,dU={linear:"linear",ease:"ease",easeIn:"ease-in",easeOut:"ease-out",easeInOut:"ease-in-out",circIn:Au([0,.65,.55,1]),circOut:Au([.55,0,1,.45]),backIn:Au([.31,.01,.66,-.59]),backOut:Au([.33,1.53,.69,.99])};function lU(d){if(d)return aU(d)?Au(d):Array.isArray(d)?d.map(lU):dU[d]}function M7(d,l,h,{delay:f=0,duration:y,repeat:w=0,repeatType:A="loop",ease:P,times:L}={}){const U={[l]:h};L&&(U.offset=L);const M=lU(P);return Array.isArray(M)&&(U.easing=M),d.animate(U,{delay:f,duration:y,easing:Array.isArray(M)?"linear":M,fill:"both",iterations:w+1,direction:A==="reverse"?"alternate":"normal"})}function U7(d,{repeat:l,repeatType:h="loop"}){const f=l&&h!=="loop"&&l%2===1?0:d.length-1;return d[f]}const uU=(d,l,h)=>(((1-3*h+3*l)*d+(3*h-6*l))*d+3*l)*d,V7=1e-7,j7=12;function F7(d,l,h,f,y){let w,A,P=0;do A=l+(h-l)/2,w=uU(A,f,y)-d,w>0?h=A:l=A;while(Math.abs(w)>V7&&++P<j7);return A}function Hu(d,l,h,f){if(d===l&&h===f)return Wn;const y=w=>F7(w,0,1,d,h);return w=>w===0||w===1?w:uU(y(w),l,f)}const B7=Hu(.42,0,1,1),W7=Hu(0,0,.58,1),hU=Hu(.42,0,.58,1),G7=d=>Array.isArray(d)&&typeof d[0]!="number",pU=d=>l=>l<=.5?d(2*l)/2:(2-d(2*(1-l)))/2,mU=d=>l=>1-d(1-l),fv=d=>1-Math.sin(Math.acos(d)),fU=mU(fv),H7=pU(fv),_U=Hu(.33,1.53,.69,.99),_v=mU(_U),K7=pU(_v),Y7=d=>(d*=2)<1?.5*_v(d):.5*(2-Math.pow(2,-10*(d-1))),z7={linear:Wn,easeIn:B7,easeInOut:hU,easeOut:W7,circIn:fv,circInOut:H7,circOut:fU,backIn:_v,backInOut:K7,backOut:_U,anticipate:Y7},v1=d=>{if(Array.isArray(d)){mv(d.length===4);const[l,h,f,y]=d;return Hu(l,h,f,y)}else if(typeof d=="string")return z7[d];return d},gv=(d,l)=>h=>!!(Wu(h)&&XJ.test(h)&&h.startsWith(d)||l&&Object.prototype.hasOwnProperty.call(h,l)),gU=(d,l,h)=>f=>{if(!Wu(f))return f;const[y,w,A,P]=f.match(Lf);return{[d]:parseFloat(y),[l]:parseFloat(w),[h]:parseFloat(A),alpha:P!==void 0?parseFloat(P):1}},q7=d=>Zo(0,255,d),fT={...uc,transform:d=>Math.round(q7(d))},oc={test:gv("rgb","red"),parse:gU("red","green","blue"),transform:({red:d,green:l,blue:h,alpha:f=1})=>"rgba("+fT.transform(d)+", "+fT.transform(l)+", "+fT.transform(h)+", "+Pu(Du.transform(f))+")"};function X7(d){let l="",h="",f="",y="";return d.length>5?(l=d.substring(1,3),h=d.substring(3,5),f=d.substring(5,7),y=d.substring(7,9)):(l=d.substring(1,2),h=d.substring(2,3),f=d.substring(3,4),y=d.substring(4,5),l+=l,h+=h,f+=f,y+=y),{red:parseInt(l,16),green:parseInt(h,16),blue:parseInt(f,16),alpha:y?parseInt(y,16)/255:1}}const PT={test:gv("#"),parse:X7,transform:oc.transform},jd={test:gv("hsl","hue"),parse:gU("hue","saturation","lightness"),transform:({hue:d,saturation:l,lightness:h,alpha:f=1})=>"hsla("+Math.round(d)+", "+Vs.transform(Pu(l))+", "+Vs.transform(Pu(h))+", "+Pu(Du.transform(f))+")"},ki={test:d=>oc.test(d)||PT.test(d)||jd.test(d),parse:d=>oc.test(d)?oc.parse(d):jd.test(d)?jd.parse(d):PT.parse(d),transform:d=>Wu(d)?d:d.hasOwnProperty("red")?oc.transform(d):jd.transform(d)},Ln=(d,l,h)=>-h*d+h*l+d;function _T(d,l,h){return h<0&&(h+=1),h>1&&(h-=1),h<1/6?d+(l-d)*6*h:h<1/2?l:h<2/3?d+(l-d)*(2/3-h)*6:d}function J7({hue:d,saturation:l,lightness:h,alpha:f}){d/=360,l/=100,h/=100;let y=0,w=0,A=0;if(!l)y=w=A=h;else{const P=h<.5?h*(1+l):h+l-h*l,L=2*h-P;y=_T(L,P,d+1/3),w=_T(L,P,d),A=_T(L,P,d-1/3)}return{red:Math.round(y*255),green:Math.round(w*255),blue:Math.round(A*255),alpha:f}}const gT=(d,l,h)=>{const f=d*d;return Math.sqrt(Math.max(0,h*(l*l-f)+f))},Q7=[PT,oc,jd],Z7=d=>Q7.find(l=>l.test(d));function R1(d){const l=Z7(d);let h=l.parse(d);return l===jd&&(h=J7(h)),h}const EU=(d,l)=>{const h=R1(d),f=R1(l),y={...h};return w=>(y.red=gT(h.red,f.red,w),y.green=gT(h.green,f.green,w),y.blue=gT(h.blue,f.blue,w),y.alpha=Ln(h.alpha,f.alpha,w),oc.transform(y))};function $7(d){var l,h;return isNaN(d)&&Wu(d)&&(((l=d.match(Lf))===null||l===void 0?void 0:l.length)||0)+(((h=d.match(HM))===null||h===void 0?void 0:h.length)||0)>0}const SU={regex:zJ,countKey:"Vars",token:"${v}",parse:Wn},yU={regex:HM,countKey:"Colors",token:"${c}",parse:ki.parse},TU={regex:Lf,countKey:"Numbers",token:"${n}",parse:uc.parse};function ET(d,{regex:l,countKey:h,token:f,parse:y}){const w=d.tokenised.match(l);w&&(d["num"+h]=w.length,d.tokenised=d.tokenised.replace(l,f),d.values.push(...w.map(y)))}function _f(d){const l=d.toString(),h={value:l,tokenised:l,values:[],numVars:0,numColors:0,numNumbers:0};return h.value.includes("var(--")&&ET(h,SU),ET(h,yU),ET(h,TU),h}function vU(d){return _f(d).values}function RU(d){const{values:l,numColors:h,numVars:f,tokenised:y}=_f(d),w=l.length;return A=>{let P=y;for(let L=0;L<w;L++)L<f?P=P.replace(SU.token,A[L]):L<f+h?P=P.replace(yU.token,ki.transform(A[L])):P=P.replace(TU.token,Pu(A[L]));return P}}const eQ=d=>typeof d=="number"?0:d;function tQ(d){const l=vU(d);return RU(d)(l.map(eQ))}const $o={test:$7,parse:vU,createTransformer:RU,getAnimatableNone:tQ},CU=(d,l)=>h=>`${h>0?l:d}`;function bU(d,l){return typeof d=="number"?h=>Ln(d,l,h):ki.test(d)?EU(d,l):d.startsWith("var(")?CU(d,l):AU(d,l)}const wU=(d,l)=>{const h=[...d],f=h.length,y=d.map((w,A)=>bU(w,l[A]));return w=>{for(let A=0;A<f;A++)h[A]=y[A](w);return h}},nQ=(d,l)=>{const h={...d,...l},f={};for(const y in h)d[y]!==void 0&&l[y]!==void 0&&(f[y]=bU(d[y],l[y]));return y=>{for(const w in f)h[w]=f[w](y);return h}},AU=(d,l)=>{const h=$o.createTransformer(l),f=_f(d),y=_f(l);return f.numVars===y.numVars&&f.numColors===y.numColors&&f.numNumbers>=y.numNumbers?Jo(wU(f.values,y.values),h):CU(d,l)},Vu=(d,l,h)=>{const f=l-d;return f===0?1:(h-d)/f},C1=(d,l)=>h=>Ln(d,l,h);function iQ(d){return typeof d=="number"?C1:typeof d=="string"?ki.test(d)?EU:AU:Array.isArray(d)?wU:typeof d=="object"?nQ:C1}function rQ(d,l,h){const f=[],y=h||iQ(d[0]),w=d.length-1;for(let A=0;A<w;A++){let P=y(d[A],d[A+1]);if(l){const L=Array.isArray(l)?l[A]||Wn:l;P=Jo(L,P)}f.push(P)}return f}function IU(d,l,{clamp:h=!0,ease:f,mixer:y}={}){const w=d.length;if(mv(w===l.length),w===1)return()=>l[0];d[0]>d[w-1]&&(d=[...d].reverse(),l=[...l].reverse());const A=rQ(l,f,y),P=A.length,L=U=>{let M=0;if(P>1)for(;M<d.length-2&&!(U<d[M+1]);M++);const V=Vu(d[M],d[M+1],U);return A[M](V)};return h?U=>L(Zo(d[0],d[w-1],U)):L}function sQ(d,l){const h=d[d.length-1];for(let f=1;f<=l;f++){const y=Vu(0,l,f);d.push(Ln(h,1,y))}}function oQ(d){const l=[0];return sQ(l,d.length-1),l}function aQ(d,l){return d.map(h=>h*l)}function cQ(d,l){return d.map(()=>l||hU).splice(0,d.length-1)}function gf({duration:d=300,keyframes:l,times:h,ease:f="easeInOut"}){const y=G7(f)?f.map(v1):v1(f),w={done:!1,value:l[0]},A=aQ(h&&h.length===l.length?h:oQ(l),d),P=IU(A,l,{ease:Array.isArray(y)?y:cQ(l,y)});return{calculatedDuration:d,next:L=>(w.value=P(L),w.done=L>=d,w)}}function OU(d,l){return l?d*(1e3/l):0}const dQ=5;function NU(d,l,h){const f=Math.max(l-dQ,0);return OU(h-d(f),l-f)}const ST=.001,lQ=.01,uQ=10,hQ=.05,pQ=1;function mQ({duration:d=800,bounce:l=.25,velocity:h=0,mass:f=1}){let y,w,A=1-l;A=Zo(hQ,pQ,A),d=Zo(lQ,uQ,co(d)),A<1?(y=U=>{const M=U*A,V=M*d,W=M-h,z=LT(U,A),X=Math.exp(-V);return ST-W/z*X},w=U=>{const V=U*A*d,W=V*h+h,z=Math.pow(A,2)*Math.pow(U,2)*d,X=Math.exp(-V),$=LT(Math.pow(U,2),A);return(-y(U)+ST>0?-1:1)*((W-z)*X)/$}):(y=U=>{const M=Math.exp(-U*d),V=(U-h)*d+1;return-ST+M*V},w=U=>{const M=Math.exp(-U*d),V=(h-U)*(d*d);return M*V});const P=5/d,L=_Q(y,w,P);if(d=dc(d),isNaN(L))return{stiffness:100,damping:10,duration:d};{const U=Math.pow(L,2)*f;return{stiffness:U,damping:A*2*Math.sqrt(f*U),duration:d}}}const fQ=12;function _Q(d,l,h){let f=h;for(let y=1;y<fQ;y++)f=f-d(f)/l(f);return f}function LT(d,l){return d*Math.sqrt(1-l*l)}const gQ=["duration","bounce"],EQ=["stiffness","damping","mass"];function b1(d,l){return l.some(h=>d[h]!==void 0)}function SQ(d){let l={velocity:0,stiffness:100,damping:10,mass:1,isResolvedFromDuration:!1,...d};if(!b1(d,EQ)&&b1(d,gQ)){const h=mQ(d);l={...l,...h,mass:1},l.isResolvedFromDuration=!0}return l}function DU({keyframes:d,restDelta:l,restSpeed:h,...f}){const y=d[0],w=d[d.length-1],A={done:!1,value:y},{stiffness:P,damping:L,mass:U,duration:M,velocity:V,isResolvedFromDuration:W}=SQ({...f,velocity:-co(f.velocity||0)}),z=V||0,X=L/(2*Math.sqrt(P*U)),$=w-y,oe=co(Math.sqrt(P/U)),ve=Math.abs($)<5;h||(h=ve?.01:2),l||(l=ve?.005:.5);let Re;if(X<1){const pe=LT(oe,X);Re=fe=>{const Be=Math.exp(-X*oe*fe);return w-Be*((z+X*oe*$)/pe*Math.sin(pe*fe)+$*Math.cos(pe*fe))}}else if(X===1)Re=pe=>w-Math.exp(-oe*pe)*($+(z+oe*$)*pe);else{const pe=oe*Math.sqrt(X*X-1);Re=fe=>{const Be=Math.exp(-X*oe*fe),Ne=Math.min(pe*fe,300);return w-Be*((z+X*oe*$)*Math.sinh(Ne)+pe*$*Math.cosh(Ne))/pe}}return{calculatedDuration:W&&M||null,next:pe=>{const fe=Re(pe);if(W)A.done=pe>=M;else{let Be=z;pe!==0&&(X<1?Be=NU(Re,pe,fe):Be=0);const Ne=Math.abs(Be)<=h,Ee=Math.abs(w-fe)<=l;A.done=Ne&&Ee}return A.value=A.done?w:fe,A}}}function w1({keyframes:d,velocity:l=0,power:h=.8,timeConstant:f=325,bounceDamping:y=10,bounceStiffness:w=500,modifyTarget:A,min:P,max:L,restDelta:U=.5,restSpeed:M}){const V=d[0],W={done:!1,value:V},z=Q=>P!==void 0&&Q<P||L!==void 0&&Q>L,X=Q=>P===void 0?L:L===void 0||Math.abs(P-Q)<Math.abs(L-Q)?P:L;let $=h*l;const oe=V+$,ve=A===void 0?oe:A(oe);ve!==oe&&($=ve-V);const Re=Q=>-$*Math.exp(-Q/f),pe=Q=>ve+Re(Q),fe=Q=>{const je=Re(Q),Tt=pe(Q);W.done=Math.abs(je)<=U,W.value=W.done?ve:Tt};let Be,Ne;const Ee=Q=>{z(W.value)&&(Be=Q,Ne=DU({keyframes:[W.value,X(W.value)],velocity:NU(pe,Q,W.value),damping:y,stiffness:w,restDelta:U,restSpeed:M}))};return Ee(0),{calculatedDuration:null,next:Q=>{let je=!1;return!Ne&&Be===void 0&&(je=!0,fe(Q),Ee(Q)),Be!==void 0&&Q>Be?Ne.next(Q-Be):(!je&&fe(Q),W)}}}const yQ=d=>{const l=({timestamp:h})=>d(h);return{start:()=>fn.update(l,!0),stop:()=>lo(l),now:()=>bi.isProcessing?bi.timestamp:performance.now()}},A1=2e4;function I1(d){let l=0;const h=50;let f=d.next(l);for(;!f.done&&l<A1;)l+=h,f=d.next(l);return l>=A1?1/0:l}const TQ={decay:w1,inertia:w1,tween:gf,keyframes:gf,spring:DU};function Ef({autoplay:d=!0,delay:l=0,driver:h=yQ,keyframes:f,type:y="keyframes",repeat:w=0,repeatDelay:A=0,repeatType:P="loop",onPlay:L,onStop:U,onComplete:M,onUpdate:V,...W}){let z=1,X=!1,$,oe;const ve=()=>{oe=new Promise(_n=>{$=_n})};ve();let Re;const pe=TQ[y]||gf;let fe;pe!==gf&&typeof f[0]!="number"&&(fe=IU([0,100],f,{clamp:!1}),f=[0,100]);const Be=pe({...W,keyframes:f});let Ne;P==="mirror"&&(Ne=pe({...W,keyframes:[...f].reverse(),velocity:-(W.velocity||0)}));let Ee="idle",Q=null,je=null,Tt=null;Be.calculatedDuration===null&&w&&(Be.calculatedDuration=I1(Be));const{calculatedDuration:et}=Be;let kt=1/0,ze=1/0;et!==null&&(kt=et+A,ze=kt*(w+1)-A);let qe=0;const $n=_n=>{if(je===null)return;z>0&&(je=Math.min(je,_n)),z<0&&(je=Math.min(_n-ze/z,je)),Q!==null?qe=Q:qe=Math.round(_n-je)*z;const xi=qe-l*(z>=0?1:-1),na=z>=0?xi<0:xi>ze;qe=Math.max(xi,0),Ee==="finished"&&Q===null&&(qe=ze);let Vr=qe,Ku=Be;if(w){const uo=Math.min(qe,ze)/kt;let Ws=Math.floor(uo),Gs=uo%1;!Gs&&uo>=1&&(Gs=1),Gs===1&&Ws--,Ws=Math.min(Ws,w+1),Ws%2&&(P==="reverse"?(Gs=1-Gs,A&&(Gs-=A/kt)):P==="mirror"&&(Ku=Ne)),Vr=Zo(0,1,Gs)*kt}const ia=na?{done:!1,value:f[0]}:Ku.next(Vr);fe&&(ia.value=fe(ia.value));let{done:hc}=ia;!na&&et!==null&&(hc=z>=0?qe>=ze:qe<=0);const jf=Q===null&&(Ee==="finished"||Ee==="running"&&hc);return V&&V(ia.value),jf&&hs(),ia},mn=()=>{Re&&Re.stop(),Re=void 0},zt=()=>{Ee="idle",mn(),$(),ve(),je=Tt=null},hs=()=>{Ee="finished",M&&M(),mn(),$()},Bs=()=>{if(X)return;Re||(Re=h($n));const _n=Re.now();L&&L(),Q!==null?je=_n-Q:(!je||Ee==="finished")&&(je=_n),Ee==="finished"&&ve(),Tt=je,Q=null,Ee="running",Re.start()};d&&Bs();const zd={then(_n,xi){return oe.then(_n,xi)},get time(){return co(qe)},set time(_n){_n=dc(_n),qe=_n,Q!==null||!Re||z===0?Q=_n:je=Re.now()-_n/z},get duration(){const _n=Be.calculatedDuration===null?I1(Be):Be.calculatedDuration;return co(_n)},get speed(){return z},set speed(_n){_n===z||!Re||(z=_n,zd.time=co(qe))},get state(){return Ee},play:Bs,pause:()=>{Ee="paused",Q=qe},stop:()=>{X=!0,Ee!=="idle"&&(Ee="idle",U&&U(),zt())},cancel:()=>{Tt!==null&&$n(Tt),zt()},complete:()=>{Ee="finished"},sample:_n=>(je=0,$n(_n))};return zd}function vQ(d){let l;return()=>(l===void 0&&(l=d()),l)}const RQ=vQ(()=>Object.hasOwnProperty.call(Element.prototype,"animate")),CQ=new Set(["opacity","clipPath","filter","transform","backgroundColor"]),qm=10,bQ=2e4,wQ=(d,l)=>l.type==="spring"||d==="backgroundColor"||!cU(l.ease);function AQ(d,l,{onUpdate:h,onComplete:f,...y}){if(!(RQ()&&CQ.has(l)&&!y.repeatDelay&&y.repeatType!=="mirror"&&y.damping!==0&&y.type!=="inertia"))return!1;let A=!1,P,L,U=!1;const M=()=>{L=new Promise(pe=>{P=pe})};M();let{keyframes:V,duration:W=300,ease:z,times:X}=y;if(wQ(l,y)){const pe=Ef({...y,repeat:0,delay:0});let fe={done:!1,value:V[0]};const Be=[];let Ne=0;for(;!fe.done&&Ne<bQ;)fe=pe.sample(Ne),Be.push(fe.value),Ne+=qm;X=void 0,V=Be,W=Ne-qm,z="linear"}const $=M7(d.owner.current,l,V,{...y,duration:W,ease:z,times:X}),oe=()=>{U=!1,$.cancel()},ve=()=>{U=!0,fn.update(oe),P(),M()};return $.onfinish=()=>{U||(d.set(U7(V,y)),f&&f(),ve())},{then(pe,fe){return L.then(pe,fe)},attachTimeline(pe){return $.timeline=pe,$.onfinish=null,Wn},get time(){return co($.currentTime||0)},set time(pe){$.currentTime=dc(pe)},get speed(){return $.playbackRate},set speed(pe){$.playbackRate=pe},get duration(){return co(W)},play:()=>{A||($.play(),lo(oe))},pause:()=>$.pause(),stop:()=>{if(A=!0,$.playState==="idle")return;const{currentTime:pe}=$;if(pe){const fe=Ef({...y,autoplay:!1});d.setWithVelocity(fe.sample(pe-qm).value,fe.sample(pe).value,qm)}ve()},complete:()=>{U||$.finish()},cancel:ve}}function IQ({keyframes:d,delay:l,onUpdate:h,onComplete:f}){const y=()=>(h&&h(d[d.length-1]),f&&f(),{time:0,speed:1,duration:0,play:Wn,pause:Wn,stop:Wn,then:w=>(w(),Promise.resolve()),cancel:Wn,complete:Wn});return l?Ef({keyframes:[0,1],duration:0,delay:l,onComplete:y}):y()}const OQ={type:"spring",stiffness:500,damping:25,restSpeed:10},NQ=d=>({type:"spring",stiffness:550,damping:d===0?2*Math.sqrt(550):30,restSpeed:10}),DQ={type:"keyframes",duration:.8},PQ={type:"keyframes",ease:[.25,.1,.35,1],duration:.3},LQ=(d,{keyframes:l})=>l.length>2?DQ:lc.has(d)?d.startsWith("scale")?NQ(l[1]):OQ:PQ,kT=(d,l)=>d==="zIndex"?!1:!!(typeof l=="number"||Array.isArray(l)||typeof l=="string"&&($o.test(l)||l==="0")&&!l.startsWith("url(")),kQ=new Set(["brightness","contrast","saturate","opacity"]);function xQ(d){const[l,h]=d.slice(0,-1).split("(");if(l==="drop-shadow")return d;const[f]=h.match(Lf)||[];if(!f)return d;const y=h.replace(f,"");let w=kQ.has(l)?1:0;return f!==h&&(w*=100),l+"("+w+y+")"}const MQ=/([a-z-]*)\(.*?\)/g,xT={...$o,getAnimatableNone:d=>{const l=d.match(MQ);return l?l.map(xQ).join(" "):d}},UQ={...KM,color:ki,backgroundColor:ki,outlineColor:ki,fill:ki,stroke:ki,borderColor:ki,borderTopColor:ki,borderRightColor:ki,borderBottomColor:ki,borderLeftColor:ki,filter:xT,WebkitFilter:xT},Ev=d=>UQ[d];function PU(d,l){let h=Ev(d);return h!==xT&&(h=$o),h.getAnimatableNone?h.getAnimatableNone(l):void 0}const LU=d=>/^0[^.\s]+$/.test(d);function VQ(d){if(typeof d=="number")return d===0;if(d!==null)return d==="none"||d==="0"||LU(d)}function jQ(d,l,h,f){const y=kT(l,h);let w;Array.isArray(h)?w=[...h]:w=[null,h];const A=f.from!==void 0?f.from:d.get();let P;const L=[];for(let U=0;U<w.length;U++)w[U]===null&&(w[U]=U===0?A:w[U-1]),VQ(w[U])&&L.push(U),typeof w[U]=="string"&&w[U]!=="none"&&w[U]!=="0"&&(P=w[U]);if(y&&L.length&&P)for(let U=0;U<L.length;U++){const M=L[U];w[M]=PU(l,P)}return w}function FQ({when:d,delay:l,delayChildren:h,staggerChildren:f,staggerDirection:y,repeat:w,repeatType:A,repeatDelay:P,from:L,elapsed:U,...M}){return!!Object.keys(M).length}function Sv(d,l){return d[l]||d.default||d}const BQ={skipAnimations:!1},yv=(d,l,h,f={})=>y=>{const w=Sv(f,d)||{},A=w.delay||f.delay||0;let{elapsed:P=0}=f;P=P-dc(A);const L=jQ(l,d,h,w),U=L[0],M=L[L.length-1],V=kT(d,U),W=kT(d,M);let z={keyframes:L,velocity:l.getVelocity(),ease:"easeOut",...w,delay:-P,onUpdate:X=>{l.set(X),w.onUpdate&&w.onUpdate(X)},onComplete:()=>{y(),w.onComplete&&w.onComplete()}};if(FQ(w)||(z={...z,...LQ(d,z)}),z.duration&&(z.duration=dc(z.duration)),z.repeatDelay&&(z.repeatDelay=dc(z.repeatDelay)),!V||!W||x7.current||w.type===!1||BQ.skipAnimations)return IQ(z);if(!f.isHandoff&&l.owner&&l.owner.current instanceof HTMLElement&&!l.owner.getProps().onUpdate){const X=AQ(l,d,z);if(X)return X}return Ef(z)};function Sf(d){return!!(Qi(d)&&d.add)}const kU=d=>/^\-?\d*\.?\d+$/.test(d);function Tv(d,l){d.indexOf(l)===-1&&d.push(l)}function vv(d,l){const h=d.indexOf(l);h>-1&&d.splice(h,1)}class Rv{constructor(){this.subscriptions=[]}add(l){return Tv(this.subscriptions,l),()=>vv(this.subscriptions,l)}notify(l,h,f){const y=this.subscriptions.length;if(y)if(y===1)this.subscriptions[0](l,h,f);else for(let w=0;w<y;w++){const A=this.subscriptions[w];A&&A(l,h,f)}}getSize(){return this.subscriptions.length}clear(){this.subscriptions.length=0}}const WQ=d=>!isNaN(parseFloat(d));class GQ{constructor(l,h={}){this.version="10.18.0",this.timeDelta=0,this.lastUpdated=0,this.canTrackVelocity=!1,this.events={},this.updateAndNotify=(f,y=!0)=>{this.prev=this.current,this.current=f;const{delta:w,timestamp:A}=bi;this.lastUpdated!==A&&(this.timeDelta=w,this.lastUpdated=A,fn.postRender(this.scheduleVelocityCheck)),this.prev!==this.current&&this.events.change&&this.events.change.notify(this.current),this.events.velocityChange&&this.events.velocityChange.notify(this.getVelocity()),y&&this.events.renderRequest&&this.events.renderRequest.notify(this.current)},this.scheduleVelocityCheck=()=>fn.postRender(this.velocityCheck),this.velocityCheck=({timestamp:f})=>{f!==this.lastUpdated&&(this.prev=this.current,this.events.velocityChange&&this.events.velocityChange.notify(this.getVelocity()))},this.hasAnimated=!1,this.prev=this.current=l,this.canTrackVelocity=WQ(this.current),this.owner=h.owner}onChange(l){return this.on("change",l)}on(l,h){this.events[l]||(this.events[l]=new Rv);const f=this.events[l].add(h);return l==="change"?()=>{f(),fn.read(()=>{this.events.change.getSize()||this.stop()})}:f}clearListeners(){for(const l in this.events)this.events[l].clear()}attach(l,h){this.passiveEffect=l,this.stopPassiveEffect=h}set(l,h=!0){!h||!this.passiveEffect?this.updateAndNotify(l,h):this.passiveEffect(l,this.updateAndNotify)}setWithVelocity(l,h,f){this.set(h),this.prev=l,this.timeDelta=f}jump(l){this.updateAndNotify(l),this.prev=l,this.stop(),this.stopPassiveEffect&&this.stopPassiveEffect()}get(){return this.current}getPrevious(){return this.prev}getVelocity(){return this.canTrackVelocity?OU(parseFloat(this.current)-parseFloat(this.prev),this.timeDelta):0}start(l){return this.stop(),new Promise(h=>{this.hasAnimated=!0,this.animation=l(h),this.events.animationStart&&this.events.animationStart.notify()}).then(()=>{this.events.animationComplete&&this.events.animationComplete.notify(),this.clearAnimation()})}stop(){this.animation&&(this.animation.stop(),this.events.animationCancel&&this.events.animationCancel.notify()),this.clearAnimation()}isAnimating(){return!!this.animation}clearAnimation(){delete this.animation}destroy(){this.clearListeners(),this.stop(),this.stopPassiveEffect&&this.stopPassiveEffect()}}function Hd(d,l){return new GQ(d,l)}const xU=d=>l=>l.test(d),HQ={test:d=>d==="auto",parse:d=>d},MU=[uc,dt,Vs,qo,QJ,JJ,HQ],vu=d=>MU.find(xU(d)),KQ=[...MU,ki,$o],YQ=d=>KQ.find(xU(d));function zQ(d,l,h){d.hasValue(l)?d.getValue(l).set(h):d.addValue(l,Hd(h))}function qQ(d,l){const h=xf(d,l);let{transitionEnd:f={},transition:y={},...w}=h?d.makeTargetAnimatable(h,!1):{};w={...w,...f};for(const A in w){const P=u7(w[A]);zQ(d,A,P)}}function XQ(d,l,h){var f,y;const w=Object.keys(l).filter(P=>!d.hasValue(P)),A=w.length;if(A)for(let P=0;P<A;P++){const L=w[P],U=l[L];let M=null;Array.isArray(U)&&(M=U[0]),M===null&&(M=(y=(f=h[L])!==null&&f!==void 0?f:d.readValue(L))!==null&&y!==void 0?y:l[L]),M!=null&&(typeof M=="string"&&(kU(M)||LU(M))?M=parseFloat(M):!YQ(M)&&$o.test(U)&&(M=PU(L,U)),d.addValue(L,Hd(M,{owner:d})),h[L]===void 0&&(h[L]=M),M!==null&&d.setBaseTarget(L,M))}}function JQ(d,l){return l?(l[d]||l.default||l).from:void 0}function QQ(d,l,h){const f={};for(const y in d){const w=JQ(y,l);if(w!==void 0)f[y]=w;else{const A=h.getValue(y);A&&(f[y]=A.get())}}return f}function ZQ({protectedKeys:d,needsAnimating:l},h){const f=d.hasOwnProperty(h)&&l[h]!==!0;return l[h]=!1,f}function $Q(d,l){const h=d.get();if(Array.isArray(l)){for(let f=0;f<l.length;f++)if(l[f]!==h)return!0}else return h!==l}function UU(d,l,{delay:h=0,transitionOverride:f,type:y}={}){let{transition:w=d.getDefaultTransition(),transitionEnd:A,...P}=d.makeTargetAnimatable(l);const L=d.getValue("willChange");f&&(w=f);const U=[],M=y&&d.animationState&&d.animationState.getState()[y];for(const V in P){const W=d.getValue(V),z=P[V];if(!W||z===void 0||M&&ZQ(M,V))continue;const X={delay:h,elapsed:0,...Sv(w||{},V)};if(window.HandoffAppearAnimations){const ve=d.getProps()[VM];if(ve){const Re=window.HandoffAppearAnimations(ve,V,W,fn);Re!==null&&(X.elapsed=Re,X.isHandoff=!0)}}let $=!X.isHandoff&&!$Q(W,z);if(X.type==="spring"&&(W.getVelocity()||X.velocity)&&($=!1),W.animation&&($=!1),$)continue;W.start(yv(V,W,z,d.shouldReduceMotion&&lc.has(V)?{type:!1}:X));const oe=W.animation;Sf(L)&&(L.add(V),oe.then(()=>L.remove(V))),U.push(oe)}return A&&Promise.all(U).then(()=>{A&&qQ(d,A)}),U}function MT(d,l,h={}){const f=xf(d,l,h.custom);let{transition:y=d.getDefaultTransition()||{}}=f||{};h.transitionOverride&&(y=h.transitionOverride);const w=f?()=>Promise.all(UU(d,f,h)):()=>Promise.resolve(),A=d.variantChildren&&d.variantChildren.size?(L=0)=>{const{delayChildren:U=0,staggerChildren:M,staggerDirection:V}=y;return eZ(d,l,U+L,M,V,h)}:()=>Promise.resolve(),{when:P}=y;if(P){const[L,U]=P==="beforeChildren"?[w,A]:[A,w];return L().then(()=>U())}else return Promise.all([w(),A(h.delay)])}function eZ(d,l,h=0,f=0,y=1,w){const A=[],P=(d.variantChildren.size-1)*f,L=y===1?(U=0)=>U*f:(U=0)=>P-U*f;return Array.from(d.variantChildren).sort(tZ).forEach((U,M)=>{U.notify("AnimationStart",l),A.push(MT(U,l,{...w,delay:h+L(M)}).then(()=>U.notify("AnimationComplete",l)))}),Promise.all(A)}function tZ(d,l){return d.sortNodePosition(l)}function nZ(d,l,h={}){d.notify("AnimationStart",l);let f;if(Array.isArray(l)){const y=l.map(w=>MT(d,w,h));f=Promise.all(y)}else if(typeof l=="string")f=MT(d,l,h);else{const y=typeof l=="function"?xf(d,l,h.custom):l;f=Promise.all(UU(d,y,h))}return f.then(()=>d.notify("AnimationComplete",l))}const iZ=[...rv].reverse(),rZ=rv.length;function sZ(d){return l=>Promise.all(l.map(({animation:h,options:f})=>nZ(d,h,f)))}function oZ(d){let l=sZ(d);const h=cZ();let f=!0;const y=(L,U)=>{const M=xf(d,U);if(M){const{transition:V,transitionEnd:W,...z}=M;L={...L,...z,...W}}return L};function w(L){l=L(d)}function A(L,U){const M=d.getProps(),V=d.getVariantContext(!0)||{},W=[],z=new Set;let X={},$=1/0;for(let ve=0;ve<rZ;ve++){const Re=iZ[ve],pe=h[Re],fe=M[Re]!==void 0?M[Re]:V[Re],Be=Mu(fe),Ne=Re===U?pe.isActive:null;Ne===!1&&($=ve);let Ee=fe===V[Re]&&fe!==M[Re]&&Be;if(Ee&&f&&d.manuallyAnimateOnMount&&(Ee=!1),pe.protectedKeys={...X},!pe.isActive&&Ne===null||!fe&&!pe.prevProp||Df(fe)||typeof fe=="boolean")continue;let je=aZ(pe.prevProp,fe)||Re===U&&pe.isActive&&!Ee&&Be||ve>$&&Be,Tt=!1;const et=Array.isArray(fe)?fe:[fe];let kt=et.reduce(y,{});Ne===!1&&(kt={});const{prevResolvedValues:ze={}}=pe,qe={...ze,...kt},$n=mn=>{je=!0,z.has(mn)&&(Tt=!0,z.delete(mn)),pe.needsAnimating[mn]=!0};for(const mn in qe){const zt=kt[mn],hs=ze[mn];if(X.hasOwnProperty(mn))continue;let Bs=!1;ff(zt)&&ff(hs)?Bs=!oU(zt,hs):Bs=zt!==hs,Bs?zt!==void 0?$n(mn):z.add(mn):zt!==void 0&&z.has(mn)?$n(mn):pe.protectedKeys[mn]=!0}pe.prevProp=fe,pe.prevResolvedValues=kt,pe.isActive&&(X={...X,...kt}),f&&d.blockInitialAnimation&&(je=!1),je&&(!Ee||Tt)&&W.push(...et.map(mn=>({animation:mn,options:{type:Re,...L}})))}if(z.size){const ve={};z.forEach(Re=>{const pe=d.getBaseTarget(Re);pe!==void 0&&(ve[Re]=pe)}),W.push({animation:ve})}let oe=!!W.length;return f&&(M.initial===!1||M.initial===M.animate)&&!d.manuallyAnimateOnMount&&(oe=!1),f=!1,oe?l(W):Promise.resolve()}function P(L,U,M){var V;if(h[L].isActive===U)return Promise.resolve();(V=d.variantChildren)===null||V===void 0||V.forEach(z=>{var X;return(X=z.animationState)===null||X===void 0?void 0:X.setActive(L,U)}),h[L].isActive=U;const W=A(M,L);for(const z in h)h[z].protectedKeys={};return W}return{animateChanges:A,setActive:P,setAnimateFunction:w,getState:()=>h}}function aZ(d,l){return typeof l=="string"?l!==d:Array.isArray(l)?!oU(l,d):!1}function ec(d=!1){return{isActive:d,protectedKeys:{},needsAnimating:{},prevResolvedValues:{}}}function cZ(){return{animate:ec(!0),whileInView:ec(),whileHover:ec(),whileTap:ec(),whileDrag:ec(),whileFocus:ec(),exit:ec()}}class dZ extends ta{constructor(l){super(l),l.animationState||(l.animationState=oZ(l))}updateAnimationControlsSubscription(){const{animate:l}=this.node.getProps();this.unmount(),Df(l)&&(this.unmount=l.subscribe(this.node))}mount(){this.updateAnimationControlsSubscription()}update(){const{animate:l}=this.node.getProps(),{animate:h}=this.node.prevProps||{};l!==h&&this.updateAnimationControlsSubscription()}unmount(){}}let lZ=0;class uZ extends ta{constructor(){super(...arguments),this.id=lZ++}update(){if(!this.node.presenceContext)return;const{isPresent:l,onExitComplete:h,custom:f}=this.node.presenceContext,{isPresent:y}=this.node.prevPresenceContext||{};if(!this.node.animationState||l===y)return;const w=this.node.animationState.setActive("exit",!l,{custom:f??this.node.getProps().custom});h&&!l&&w.then(()=>h(this.id))}mount(){const{register:l}=this.node.presenceContext||{};l&&(this.unmount=l(this.id))}unmount(){}}const hZ={animation:{Feature:dZ},exit:{Feature:uZ}},O1=(d,l)=>Math.abs(d-l);function pZ(d,l){const h=O1(d.x,l.x),f=O1(d.y,l.y);return Math.sqrt(h**2+f**2)}class VU{constructor(l,h,{transformPagePoint:f,contextWindow:y,dragSnapToOrigin:w=!1}={}){if(this.startEvent=null,this.lastMoveEvent=null,this.lastMoveEventInfo=null,this.handlers={},this.contextWindow=window,this.updatePoint=()=>{if(!(this.lastMoveEvent&&this.lastMoveEventInfo))return;const V=TT(this.lastMoveEventInfo,this.history),W=this.startEvent!==null,z=pZ(V.offset,{x:0,y:0})>=3;if(!W&&!z)return;const{point:X}=V,{timestamp:$}=bi;this.history.push({...X,timestamp:$});const{onStart:oe,onMove:ve}=this.handlers;W||(oe&&oe(this.lastMoveEvent,V),this.startEvent=this.lastMoveEvent),ve&&ve(this.lastMoveEvent,V)},this.handlePointerMove=(V,W)=>{this.lastMoveEvent=V,this.lastMoveEventInfo=yT(W,this.transformPagePoint),fn.update(this.updatePoint,!0)},this.handlePointerUp=(V,W)=>{this.end();const{onEnd:z,onSessionEnd:X,resumeAnimation:$}=this.handlers;if(this.dragSnapToOrigin&&$&&$(),!(this.lastMoveEvent&&this.lastMoveEventInfo))return;const oe=TT(V.type==="pointercancel"?this.lastMoveEventInfo:yT(W,this.transformPagePoint),this.history);this.startEvent&&z&&z(V,oe),X&&X(V,oe)},!tU(l))return;this.dragSnapToOrigin=w,this.handlers=h,this.transformPagePoint=f,this.contextWindow=y||window;const A=kf(l),P=yT(A,this.transformPagePoint),{point:L}=P,{timestamp:U}=bi;this.history=[{...L,timestamp:U}];const{onSessionStart:M}=h;M&&M(l,TT(P,this.history)),this.removeListeners=Jo(ao(this.contextWindow,"pointermove",this.handlePointerMove),ao(this.contextWindow,"pointerup",this.handlePointerUp),ao(this.contextWindow,"pointercancel",this.handlePointerUp))}updateHandlers(l){this.handlers=l}end(){this.removeListeners&&this.removeListeners(),lo(this.updatePoint)}}function yT(d,l){return l?{point:l(d.point)}:d}function N1(d,l){return{x:d.x-l.x,y:d.y-l.y}}function TT({point:d},l){return{point:d,delta:N1(d,jU(l)),offset:N1(d,mZ(l)),velocity:fZ(l,.1)}}function mZ(d){return d[0]}function jU(d){return d[d.length-1]}function fZ(d,l){if(d.length<2)return{x:0,y:0};let h=d.length-1,f=null;const y=jU(d);for(;h>=0&&(f=d[h],!(y.timestamp-f.timestamp>dc(l)));)h--;if(!f)return{x:0,y:0};const w=co(y.timestamp-f.timestamp);if(w===0)return{x:0,y:0};const A={x:(y.x-f.x)/w,y:(y.y-f.y)/w};return A.x===1/0&&(A.x=0),A.y===1/0&&(A.y=0),A}function ur(d){return d.max-d.min}function UT(d,l=0,h=.01){return Math.abs(d-l)<=h}function D1(d,l,h,f=.5){d.origin=f,d.originPoint=Ln(l.min,l.max,d.origin),d.scale=ur(h)/ur(l),(UT(d.scale,1,1e-4)||isNaN(d.scale))&&(d.scale=1),d.translate=Ln(h.min,h.max,d.origin)-d.originPoint,(UT(d.translate)||isNaN(d.translate))&&(d.translate=0)}function Lu(d,l,h,f){D1(d.x,l.x,h.x,f?f.originX:void 0),D1(d.y,l.y,h.y,f?f.originY:void 0)}function P1(d,l,h){d.min=h.min+l.min,d.max=d.min+ur(l)}function _Z(d,l,h){P1(d.x,l.x,h.x),P1(d.y,l.y,h.y)}function L1(d,l,h){d.min=l.min-h.min,d.max=d.min+ur(l)}function ku(d,l,h){L1(d.x,l.x,h.x),L1(d.y,l.y,h.y)}function gZ(d,{min:l,max:h},f){return l!==void 0&&d<l?d=f?Ln(l,d,f.min):Math.max(d,l):h!==void 0&&d>h&&(d=f?Ln(h,d,f.max):Math.min(d,h)),d}function k1(d,l,h){return{min:l!==void 0?d.min+l:void 0,max:h!==void 0?d.max+h-(d.max-d.min):void 0}}function EZ(d,{top:l,left:h,bottom:f,right:y}){return{x:k1(d.x,h,y),y:k1(d.y,l,f)}}function x1(d,l){let h=l.min-d.min,f=l.max-d.max;return l.max-l.min<d.max-d.min&&([h,f]=[f,h]),{min:h,max:f}}function SZ(d,l){return{x:x1(d.x,l.x),y:x1(d.y,l.y)}}function yZ(d,l){let h=.5;const f=ur(d),y=ur(l);return y>f?h=Vu(l.min,l.max-f,d.min):f>y&&(h=Vu(d.min,d.max-y,l.min)),Zo(0,1,h)}function TZ(d,l){const h={};return l.min!==void 0&&(h.min=l.min-d.min),l.max!==void 0&&(h.max=l.max-d.min),h}const VT=.35;function vZ(d=VT){return d===!1?d=0:d===!0&&(d=VT),{x:M1(d,"left","right"),y:M1(d,"top","bottom")}}function M1(d,l,h){return{min:U1(d,l),max:U1(d,h)}}function U1(d,l){return typeof d=="number"?d:d[l]||0}const V1=()=>({translate:0,scale:1,origin:0,originPoint:0}),Fd=()=>({x:V1(),y:V1()}),j1=()=>({min:0,max:0}),qn=()=>({x:j1(),y:j1()});function Mr(d){return[d("x"),d("y")]}function FU({top:d,left:l,right:h,bottom:f}){return{x:{min:l,max:h},y:{min:d,max:f}}}function RZ({x:d,y:l}){return{top:l.min,right:d.max,bottom:l.max,left:d.min}}function CZ(d,l){if(!l)return d;const h=l({x:d.left,y:d.top}),f=l({x:d.right,y:d.bottom});return{top:h.y,left:h.x,bottom:f.y,right:f.x}}function vT(d){return d===void 0||d===1}function jT({scale:d,scaleX:l,scaleY:h}){return!vT(d)||!vT(l)||!vT(h)}function tc(d){return jT(d)||BU(d)||d.z||d.rotate||d.rotateX||d.rotateY}function BU(d){return F1(d.x)||F1(d.y)}function F1(d){return d&&d!=="0%"}function yf(d,l,h){const f=d-h,y=l*f;return h+y}function B1(d,l,h,f,y){return y!==void 0&&(d=yf(d,y,f)),yf(d,h,f)+l}function FT(d,l=0,h=1,f,y){d.min=B1(d.min,l,h,f,y),d.max=B1(d.max,l,h,f,y)}function WU(d,{x:l,y:h}){FT(d.x,l.translate,l.scale,l.originPoint),FT(d.y,h.translate,h.scale,h.originPoint)}function bZ(d,l,h,f=!1){const y=h.length;if(!y)return;l.x=l.y=1;let w,A;for(let P=0;P<y;P++){w=h[P],A=w.projectionDelta;const L=w.instance;L&&L.style&&L.style.display==="contents"||(f&&w.options.layoutScroll&&w.scroll&&w!==w.root&&Bd(d,{x:-w.scroll.offset.x,y:-w.scroll.offset.y}),A&&(l.x*=A.x.scale,l.y*=A.y.scale,WU(d,A)),f&&tc(w.latestValues)&&Bd(d,w.latestValues))}l.x=W1(l.x),l.y=W1(l.y)}function W1(d){return Number.isInteger(d)||d>1.0000000000001||d<.999999999999?d:1}function Xo(d,l){d.min=d.min+l,d.max=d.max+l}function G1(d,l,[h,f,y]){const w=l[y]!==void 0?l[y]:.5,A=Ln(d.min,d.max,w);FT(d,l[h],l[f],A,l.scale)}const wZ=["x","scaleX","originX"],AZ=["y","scaleY","originY"];function Bd(d,l){G1(d.x,l,wZ),G1(d.y,l,AZ)}function GU(d,l){return FU(CZ(d.getBoundingClientRect(),l))}function IZ(d,l,h){const f=GU(d,h),{scroll:y}=l;return y&&(Xo(f.x,y.offset.x),Xo(f.y,y.offset.y)),f}const HU=({current:d})=>d?d.ownerDocument.defaultView:null,OZ=new WeakMap;class NZ{constructor(l){this.openGlobalLock=null,this.isDragging=!1,this.currentDirection=null,this.originPoint={x:0,y:0},this.constraints=!1,this.hasMutatedConstraints=!1,this.elastic=qn(),this.visualElement=l}start(l,{snapToCursor:h=!1}={}){const{presenceContext:f}=this.visualElement;if(f&&f.isPresent===!1)return;const y=M=>{const{dragSnapToOrigin:V}=this.getProps();V?this.pauseAnimation():this.stopAnimation(),h&&this.snapToCursor(kf(M,"page").point)},w=(M,V)=>{const{drag:W,dragPropagation:z,onDragStart:X}=this.getProps();if(W&&!z&&(this.openGlobalLock&&this.openGlobalLock(),this.openGlobalLock=iU(W),!this.openGlobalLock))return;this.isDragging=!0,this.currentDirection=null,this.resolveConstraints(),this.visualElement.projection&&(this.visualElement.projection.isAnimationBlocked=!0,this.visualElement.projection.target=void 0),Mr(oe=>{let ve=this.getAxisMotionValue(oe).get()||0;if(Vs.test(ve)){const{projection:Re}=this.visualElement;if(Re&&Re.layout){const pe=Re.layout.layoutBox[oe];pe&&(ve=ur(pe)*(parseFloat(ve)/100))}}this.originPoint[oe]=ve}),X&&fn.update(()=>X(M,V),!1,!0);const{animationState:$}=this.visualElement;$&&$.setActive("whileDrag",!0)},A=(M,V)=>{const{dragPropagation:W,dragDirectionLock:z,onDirectionLock:X,onDrag:$}=this.getProps();if(!W&&!this.openGlobalLock)return;const{offset:oe}=V;if(z&&this.currentDirection===null){this.currentDirection=DZ(oe),this.currentDirection!==null&&X&&X(this.currentDirection);return}this.updateAxis("x",V.point,oe),this.updateAxis("y",V.point,oe),this.visualElement.render(),$&&$(M,V)},P=(M,V)=>this.stop(M,V),L=()=>Mr(M=>{var V;return this.getAnimationState(M)==="paused"&&((V=this.getAxisMotionValue(M).animation)===null||V===void 0?void 0:V.play())}),{dragSnapToOrigin:U}=this.getProps();this.panSession=new VU(l,{onSessionStart:y,onStart:w,onMove:A,onSessionEnd:P,resumeAnimation:L},{transformPagePoint:this.visualElement.getTransformPagePoint(),dragSnapToOrigin:U,contextWindow:HU(this.visualElement)})}stop(l,h){const f=this.isDragging;if(this.cancel(),!f)return;const{velocity:y}=h;this.startAnimation(y);const{onDragEnd:w}=this.getProps();w&&fn.update(()=>w(l,h))}cancel(){this.isDragging=!1;const{projection:l,animationState:h}=this.visualElement;l&&(l.isAnimationBlocked=!1),this.panSession&&this.panSession.end(),this.panSession=void 0;const{dragPropagation:f}=this.getProps();!f&&this.openGlobalLock&&(this.openGlobalLock(),this.openGlobalLock=null),h&&h.setActive("whileDrag",!1)}updateAxis(l,h,f){const{drag:y}=this.getProps();if(!f||!Xm(l,y,this.currentDirection))return;const w=this.getAxisMotionValue(l);let A=this.originPoint[l]+f[l];this.constraints&&this.constraints[l]&&(A=gZ(A,this.constraints[l],this.elastic[l])),w.set(A)}resolveConstraints(){var l;const{dragConstraints:h,dragElastic:f}=this.getProps(),y=this.visualElement.projection&&!this.visualElement.projection.layout?this.visualElement.projection.measure(!1):(l=this.visualElement.projection)===null||l===void 0?void 0:l.layout,w=this.constraints;h&&Vd(h)?this.constraints||(this.constraints=this.resolveRefConstraints()):h&&y?this.constraints=EZ(y.layoutBox,h):this.constraints=!1,this.elastic=vZ(f),w!==this.constraints&&y&&this.constraints&&!this.hasMutatedConstraints&&Mr(A=>{this.getAxisMotionValue(A)&&(this.constraints[A]=TZ(y.layoutBox[A],this.constraints[A]))})}resolveRefConstraints(){const{dragConstraints:l,onMeasureDragConstraints:h}=this.getProps();if(!l||!Vd(l))return!1;const f=l.current,{projection:y}=this.visualElement;if(!y||!y.layout)return!1;const w=IZ(f,y.root,this.visualElement.getTransformPagePoint());let A=SZ(y.layout.layoutBox,w);if(h){const P=h(RZ(A));this.hasMutatedConstraints=!!P,P&&(A=FU(P))}return A}startAnimation(l){const{drag:h,dragMomentum:f,dragElastic:y,dragTransition:w,dragSnapToOrigin:A,onDragTransitionEnd:P}=this.getProps(),L=this.constraints||{},U=Mr(M=>{if(!Xm(M,h,this.currentDirection))return;let V=L&&L[M]||{};A&&(V={min:0,max:0});const W=y?200:1e6,z=y?40:1e7,X={type:"inertia",velocity:f?l[M]:0,bounceStiffness:W,bounceDamping:z,timeConstant:750,restDelta:1,restSpeed:10,...w,...V};return this.startAxisValueAnimation(M,X)});return Promise.all(U).then(P)}startAxisValueAnimation(l,h){const f=this.getAxisMotionValue(l);return f.start(yv(l,f,0,h))}stopAnimation(){Mr(l=>this.getAxisMotionValue(l).stop())}pauseAnimation(){Mr(l=>{var h;return(h=this.getAxisMotionValue(l).animation)===null||h===void 0?void 0:h.pause()})}getAnimationState(l){var h;return(h=this.getAxisMotionValue(l).animation)===null||h===void 0?void 0:h.state}getAxisMotionValue(l){const h="_drag"+l.toUpperCase(),f=this.visualElement.getProps(),y=f[h];return y||this.visualElement.getValue(l,(f.initial?f.initial[l]:void 0)||0)}snapToCursor(l){Mr(h=>{const{drag:f}=this.getProps();if(!Xm(h,f,this.currentDirection))return;const{projection:y}=this.visualElement,w=this.getAxisMotionValue(h);if(y&&y.layout){const{min:A,max:P}=y.layout.layoutBox[h];w.set(l[h]-Ln(A,P,.5))}})}scalePositionWithinConstraints(){if(!this.visualElement.current)return;const{drag:l,dragConstraints:h}=this.getProps(),{projection:f}=this.visualElement;if(!Vd(h)||!f||!this.constraints)return;this.stopAnimation();const y={x:0,y:0};Mr(A=>{const P=this.getAxisMotionValue(A);if(P){const L=P.get();y[A]=yZ({min:L,max:L},this.constraints[A])}});const{transformTemplate:w}=this.visualElement.getProps();this.visualElement.current.style.transform=w?w({},""):"none",f.root&&f.root.updateScroll(),f.updateLayout(),this.resolveConstraints(),Mr(A=>{if(!Xm(A,l,null))return;const P=this.getAxisMotionValue(A),{min:L,max:U}=this.constraints[A];P.set(Ln(L,U,y[A]))})}addListeners(){if(!this.visualElement.current)return;OZ.set(this.visualElement,this);const l=this.visualElement.current,h=ao(l,"pointerdown",L=>{const{drag:U,dragListener:M=!0}=this.getProps();U&&M&&this.start(L)}),f=()=>{const{dragConstraints:L}=this.getProps();Vd(L)&&(this.constraints=this.resolveRefConstraints())},{projection:y}=this.visualElement,w=y.addEventListener("measure",f);y&&!y.layout&&(y.root&&y.root.updateScroll(),y.updateLayout()),f();const A=oo(window,"resize",()=>this.scalePositionWithinConstraints()),P=y.addEventListener("didUpdate",(({delta:L,hasLayoutChanged:U})=>{this.isDragging&&U&&(Mr(M=>{const V=this.getAxisMotionValue(M);V&&(this.originPoint[M]+=L[M].translate,V.set(V.get()+L[M].translate))}),this.visualElement.render())}));return()=>{A(),h(),w(),P&&P()}}getProps(){const l=this.visualElement.getProps(),{drag:h=!1,dragDirectionLock:f=!1,dragPropagation:y=!1,dragConstraints:w=!1,dragElastic:A=VT,dragMomentum:P=!0}=l;return{...l,drag:h,dragDirectionLock:f,dragPropagation:y,dragConstraints:w,dragElastic:A,dragMomentum:P}}}function Xm(d,l,h){return(l===!0||l===d)&&(h===null||h===d)}function DZ(d,l=10){let h=null;return Math.abs(d.y)>l?h="y":Math.abs(d.x)>l&&(h="x"),h}class PZ extends ta{constructor(l){super(l),this.removeGroupControls=Wn,this.removeListeners=Wn,this.controls=new NZ(l)}mount(){const{dragControls:l}=this.node.getProps();l&&(this.removeGroupControls=l.subscribe(this.controls)),this.removeListeners=this.controls.addListeners()||Wn}unmount(){this.removeGroupControls(),this.removeListeners()}}const H1=d=>(l,h)=>{d&&fn.update(()=>d(l,h))};class LZ extends ta{constructor(){super(...arguments),this.removePointerDownListener=Wn}onPointerDown(l){this.session=new VU(l,this.createPanHandlers(),{transformPagePoint:this.node.getTransformPagePoint(),contextWindow:HU(this.node)})}createPanHandlers(){const{onPanSessionStart:l,onPanStart:h,onPan:f,onPanEnd:y}=this.node.getProps();return{onSessionStart:H1(l),onStart:H1(h),onMove:f,onEnd:(w,A)=>{delete this.session,y&&fn.update(()=>y(w,A))}}}mount(){this.removePointerDownListener=ao(this.node.current,"pointerdown",l=>this.onPointerDown(l))}update(){this.session&&this.session.updateHandlers(this.createPanHandlers())}unmount(){this.removePointerDownListener(),this.session&&this.session.end()}}function kZ(){const d=K.useContext(Of);if(d===null)return[!0,null];const{isPresent:l,onExitComplete:h,register:f}=d,y=K.useId();return K.useEffect(()=>f(y),[]),!l&&h?[!1,()=>h&&h(y)]:[!0]}const tf={hasAnimatedSinceResize:!0,hasEverUpdated:!1};function K1(d,l){return l.max===l.min?0:d/(l.max-l.min)*100}const Ru={correct:(d,l)=>{if(!l.target)return d;if(typeof d=="string")if(dt.test(d))d=parseFloat(d);else return d;const h=K1(d,l.target.x),f=K1(d,l.target.y);return`${h}% ${f}%`}},xZ={correct:(d,{treeScale:l,projectionDelta:h})=>{const f=d,y=$o.parse(d);if(y.length>5)return f;const w=$o.createTransformer(d),A=typeof y[0]!="number"?1:0,P=h.x.scale*l.x,L=h.y.scale*l.y;y[0+A]/=P,y[1+A]/=L;const U=Ln(P,L,.5);return typeof y[2+A]=="number"&&(y[2+A]/=U),typeof y[3+A]=="number"&&(y[3+A]/=U),w(y)}};class MZ extends Fu.Component{componentDidMount(){const{visualElement:l,layoutGroup:h,switchLayoutGroup:f,layoutId:y}=this.props,{projection:w}=l;GJ(UZ),w&&(h.group&&h.group.add(w),f&&f.register&&y&&f.register(w),w.root.didUpdate(),w.addEventListener("animationComplete",()=>{this.safeToRemove()}),w.setOptions({...w.options,onExitComplete:()=>this.safeToRemove()})),tf.hasEverUpdated=!0}getSnapshotBeforeUpdate(l){const{layoutDependency:h,visualElement:f,drag:y,isPresent:w}=this.props,A=f.projection;return A&&(A.isPresent=w,y||l.layoutDependency!==h||h===void 0?A.willUpdate():this.safeToRemove(),l.isPresent!==w&&(w?A.promote():A.relegate()||fn.postRender(()=>{const P=A.getStack();(!P||!P.members.length)&&this.safeToRemove()}))),null}componentDidUpdate(){const{projection:l}=this.props.visualElement;l&&(l.root.didUpdate(),queueMicrotask(()=>{!l.currentAnimation&&l.isLead()&&this.safeToRemove()}))}componentWillUnmount(){const{visualElement:l,layoutGroup:h,switchLayoutGroup:f}=this.props,{projection:y}=l;y&&(y.scheduleCheckAfterUnmount(),h&&h.group&&h.group.remove(y),f&&f.deregister&&f.deregister(y))}safeToRemove(){const{safeToRemove:l}=this.props;l&&l()}render(){return null}}function KU(d){const[l,h]=kZ(),f=K.useContext(ov);return Fu.createElement(MZ,{...d,layoutGroup:f,switchLayoutGroup:K.useContext(FM),isPresent:l,safeToRemove:h})}const UZ={borderRadius:{...Ru,applyTo:["borderTopLeftRadius","borderTopRightRadius","borderBottomLeftRadius","borderBottomRightRadius"]},borderTopLeftRadius:Ru,borderTopRightRadius:Ru,borderBottomLeftRadius:Ru,borderBottomRightRadius:Ru,boxShadow:xZ},YU=["TopLeft","TopRight","BottomLeft","BottomRight"],VZ=YU.length,Y1=d=>typeof d=="string"?parseFloat(d):d,z1=d=>typeof d=="number"||dt.test(d);function jZ(d,l,h,f,y,w){y?(d.opacity=Ln(0,h.opacity!==void 0?h.opacity:1,FZ(f)),d.opacityExit=Ln(l.opacity!==void 0?l.opacity:1,0,BZ(f))):w&&(d.opacity=Ln(l.opacity!==void 0?l.opacity:1,h.opacity!==void 0?h.opacity:1,f));for(let A=0;A<VZ;A++){const P=`border${YU[A]}Radius`;let L=q1(l,P),U=q1(h,P);if(L===void 0&&U===void 0)continue;L||(L=0),U||(U=0),L===0||U===0||z1(L)===z1(U)?(d[P]=Math.max(Ln(Y1(L),Y1(U),f),0),(Vs.test(U)||Vs.test(L))&&(d[P]+="%")):d[P]=U}(l.rotate||h.rotate)&&(d.rotate=Ln(l.rotate||0,h.rotate||0,f))}function q1(d,l){return d[l]!==void 0?d[l]:d.borderRadius}const FZ=zU(0,.5,fU),BZ=zU(.5,.95,Wn);function zU(d,l,h){return f=>f<d?0:f>l?1:h(Vu(d,l,f))}function X1(d,l){d.min=l.min,d.max=l.max}function xr(d,l){X1(d.x,l.x),X1(d.y,l.y)}function J1(d,l,h,f,y){return d-=l,d=yf(d,1/h,f),y!==void 0&&(d=yf(d,1/y,f)),d}function WZ(d,l=0,h=1,f=.5,y,w=d,A=d){if(Vs.test(l)&&(l=parseFloat(l),l=Ln(A.min,A.max,l/100)-A.min),typeof l!="number")return;let P=Ln(w.min,w.max,f);d===w&&(P-=l),d.min=J1(d.min,l,h,P,y),d.max=J1(d.max,l,h,P,y)}function Q1(d,l,[h,f,y],w,A){WZ(d,l[h],l[f],l[y],l.scale,w,A)}const GZ=["x","scaleX","originX"],HZ=["y","scaleY","originY"];function Z1(d,l,h,f){Q1(d.x,l,GZ,h?h.x:void 0,f?f.x:void 0),Q1(d.y,l,HZ,h?h.y:void 0,f?f.y:void 0)}function $1(d){return d.translate===0&&d.scale===1}function qU(d){return $1(d.x)&&$1(d.y)}function KZ(d,l){return d.x.min===l.x.min&&d.x.max===l.x.max&&d.y.min===l.y.min&&d.y.max===l.y.max}function XU(d,l){return Math.round(d.x.min)===Math.round(l.x.min)&&Math.round(d.x.max)===Math.round(l.x.max)&&Math.round(d.y.min)===Math.round(l.y.min)&&Math.round(d.y.max)===Math.round(l.y.max)}function eM(d){return ur(d.x)/ur(d.y)}class YZ{constructor(){this.members=[]}add(l){Tv(this.members,l),l.scheduleRender()}remove(l){if(vv(this.members,l),l===this.prevLead&&(this.prevLead=void 0),l===this.lead){const h=this.members[this.members.length-1];h&&this.promote(h)}}relegate(l){const h=this.members.findIndex(y=>l===y);if(h===0)return!1;let f;for(let y=h;y>=0;y--){const w=this.members[y];if(w.isPresent!==!1){f=w;break}}return f?(this.promote(f),!0):!1}promote(l,h){const f=this.lead;if(l!==f&&(this.prevLead=f,this.lead=l,l.show(),f)){f.instance&&f.scheduleRender(),l.scheduleRender(),l.resumeFrom=f,h&&(l.resumeFrom.preserveOpacity=!0),f.snapshot&&(l.snapshot=f.snapshot,l.snapshot.latestValues=f.animationValues||f.latestValues),l.root&&l.root.isUpdating&&(l.isLayoutDirty=!0);const{crossfade:y}=l.options;y===!1&&f.hide()}}exitAnimationComplete(){this.members.forEach(l=>{const{options:h,resumingFrom:f}=l;h.onExitComplete&&h.onExitComplete(),f&&f.options.onExitComplete&&f.options.onExitComplete()})}scheduleRender(){this.members.forEach(l=>{l.instance&&l.scheduleRender(!1)})}removeLeadSnapshot(){this.lead&&this.lead.snapshot&&(this.lead.snapshot=void 0)}}function tM(d,l,h){let f="";const y=d.x.translate/l.x,w=d.y.translate/l.y;if((y||w)&&(f=`translate3d(${y}px, ${w}px, 0) `),(l.x!==1||l.y!==1)&&(f+=`scale(${1/l.x}, ${1/l.y}) `),h){const{rotate:L,rotateX:U,rotateY:M}=h;L&&(f+=`rotate(${L}deg) `),U&&(f+=`rotateX(${U}deg) `),M&&(f+=`rotateY(${M}deg) `)}const A=d.x.scale*l.x,P=d.y.scale*l.y;return(A!==1||P!==1)&&(f+=`scale(${A}, ${P})`),f||"none"}const zZ=(d,l)=>d.depth-l.depth;class qZ{constructor(){this.children=[],this.isDirty=!1}add(l){Tv(this.children,l),this.isDirty=!0}remove(l){vv(this.children,l),this.isDirty=!0}forEach(l){this.isDirty&&this.children.sort(zZ),this.isDirty=!1,this.children.forEach(l)}}function XZ(d,l){const h=performance.now(),f=({timestamp:y})=>{const w=y-h;w>=l&&(lo(f),d(w-l))};return fn.read(f,!0),()=>lo(f)}function JZ(d){window.MotionDebug&&window.MotionDebug.record(d)}function QZ(d){return d instanceof SVGElement&&d.tagName!=="svg"}function ZZ(d,l,h){const f=Qi(d)?d:Hd(d);return f.start(yv("",f,l,h)),f.animation}const nM=["","X","Y","Z"],$Z={visibility:"hidden"},iM=1e3;let e$=0;const nc={type:"projectionFrame",totalNodes:0,resolvedTargetDeltas:0,recalculatedProjection:0};function JU({attachResizeListener:d,defaultParent:l,measureScroll:h,checkIsScrollRoot:f,resetTransform:y}){return class{constructor(A={},P=l?.()){this.id=e$++,this.animationId=0,this.children=new Set,this.options={},this.isTreeAnimating=!1,this.isAnimationBlocked=!1,this.isLayoutDirty=!1,this.isProjectionDirty=!1,this.isSharedProjectionDirty=!1,this.isTransformDirty=!1,this.updateManuallyBlocked=!1,this.updateBlockedByResize=!1,this.isUpdating=!1,this.isSVG=!1,this.needsReset=!1,this.shouldResetTransform=!1,this.treeScale={x:1,y:1},this.eventHandlers=new Map,this.hasTreeAnimated=!1,this.updateScheduled=!1,this.projectionUpdateScheduled=!1,this.checkUpdateFailed=()=>{this.isUpdating&&(this.isUpdating=!1,this.clearAllSnapshots())},this.updateProjection=()=>{this.projectionUpdateScheduled=!1,nc.totalNodes=nc.resolvedTargetDeltas=nc.recalculatedProjection=0,this.nodes.forEach(i$),this.nodes.forEach(c$),this.nodes.forEach(d$),this.nodes.forEach(r$),JZ(nc)},this.hasProjected=!1,this.isVisible=!0,this.animationProgress=0,this.sharedNodes=new Map,this.latestValues=A,this.root=P?P.root||P:this,this.path=P?[...P.path,P]:[],this.parent=P,this.depth=P?P.depth+1:0;for(let L=0;L<this.path.length;L++)this.path[L].shouldResetTransform=!0;this.root===this&&(this.nodes=new qZ)}addEventListener(A,P){return this.eventHandlers.has(A)||this.eventHandlers.set(A,new Rv),this.eventHandlers.get(A).add(P)}notifyListeners(A,...P){const L=this.eventHandlers.get(A);L&&L.notify(...P)}hasListeners(A){return this.eventHandlers.has(A)}mount(A,P=this.root.hasTreeAnimated){if(this.instance)return;this.isSVG=QZ(A),this.instance=A;const{layoutId:L,layout:U,visualElement:M}=this.options;if(M&&!M.current&&M.mount(A),this.root.nodes.add(this),this.parent&&this.parent.children.add(this),P&&(U||L)&&(this.isLayoutDirty=!0),d){let V;const W=()=>this.root.updateBlockedByResize=!1;d(A,()=>{this.root.updateBlockedByResize=!0,V&&V(),V=XZ(W,250),tf.hasAnimatedSinceResize&&(tf.hasAnimatedSinceResize=!1,this.nodes.forEach(sM))})}L&&this.root.registerSharedNode(L,this),this.options.animate!==!1&&M&&(L||U)&&this.addEventListener("didUpdate",({delta:V,hasLayoutChanged:W,hasRelativeTargetChanged:z,layout:X})=>{if(this.isTreeAnimationBlocked()){this.target=void 0,this.relativeTarget=void 0;return}const $=this.options.transition||M.getDefaultTransition()||m$,{onLayoutAnimationStart:oe,onLayoutAnimationComplete:ve}=M.getProps(),Re=!this.targetLayout||!XU(this.targetLayout,X)||z,pe=!W&&z;if(this.options.layoutRoot||this.resumeFrom&&this.resumeFrom.instance||pe||W&&(Re||!this.currentAnimation)){this.resumeFrom&&(this.resumingFrom=this.resumeFrom,this.resumingFrom.resumingFrom=void 0),this.setAnimationOrigin(V,pe);const fe={...Sv($,"layout"),onPlay:oe,onComplete:ve};(M.shouldReduceMotion||this.options.layoutRoot)&&(fe.delay=0,fe.type=!1),this.startAnimation(fe)}else W||sM(this),this.isLead()&&this.options.onExitComplete&&this.options.onExitComplete();this.targetLayout=X})}unmount(){this.options.layoutId&&this.willUpdate(),this.root.nodes.remove(this);const A=this.getStack();A&&A.remove(this),this.parent&&this.parent.children.delete(this),this.instance=void 0,lo(this.updateProjection)}blockUpdate(){this.updateManuallyBlocked=!0}unblockUpdate(){this.updateManuallyBlocked=!1}isUpdateBlocked(){return this.updateManuallyBlocked||this.updateBlockedByResize}isTreeAnimationBlocked(){return this.isAnimationBlocked||this.parent&&this.parent.isTreeAnimationBlocked()||!1}startUpdate(){this.isUpdateBlocked()||(this.isUpdating=!0,this.nodes&&this.nodes.forEach(l$),this.animationId++)}getTransformTemplate(){const{visualElement:A}=this.options;return A&&A.getProps().transformTemplate}willUpdate(A=!0){if(this.root.hasTreeAnimated=!0,this.root.isUpdateBlocked()){this.options.onExitComplete&&this.options.onExitComplete();return}if(!this.root.isUpdating&&this.root.startUpdate(),this.isLayoutDirty)return;this.isLayoutDirty=!0;for(let M=0;M<this.path.length;M++){const V=this.path[M];V.shouldResetTransform=!0,V.updateScroll("snapshot"),V.options.layoutRoot&&V.willUpdate(!1)}const{layoutId:P,layout:L}=this.options;if(P===void 0&&!L)return;const U=this.getTransformTemplate();this.prevTransformTemplateValue=U?U(this.latestValues,""):void 0,this.updateSnapshot(),A&&this.notifyListeners("willUpdate")}update(){if(this.updateScheduled=!1,this.isUpdateBlocked()){this.unblockUpdate(),this.clearAllSnapshots(),this.nodes.forEach(rM);return}this.isUpdating||this.nodes.forEach(o$),this.isUpdating=!1,this.nodes.forEach(a$),this.nodes.forEach(t$),this.nodes.forEach(n$),this.clearAllSnapshots();const P=performance.now();bi.delta=Zo(0,1e3/60,P-bi.timestamp),bi.timestamp=P,bi.isProcessing=!0,hT.update.process(bi),hT.preRender.process(bi),hT.render.process(bi),bi.isProcessing=!1}didUpdate(){this.updateScheduled||(this.updateScheduled=!0,queueMicrotask(()=>this.update()))}clearAllSnapshots(){this.nodes.forEach(s$),this.sharedNodes.forEach(u$)}scheduleUpdateProjection(){this.projectionUpdateScheduled||(this.projectionUpdateScheduled=!0,fn.preRender(this.updateProjection,!1,!0))}scheduleCheckAfterUnmount(){fn.postRender(()=>{this.isLayoutDirty?this.root.didUpdate():this.root.checkUpdateFailed()})}updateSnapshot(){this.snapshot||!this.instance||(this.snapshot=this.measure())}updateLayout(){if(!this.instance||(this.updateScroll(),!(this.options.alwaysMeasureLayout&&this.isLead())&&!this.isLayoutDirty))return;if(this.resumeFrom&&!this.resumeFrom.instance)for(let L=0;L<this.path.length;L++)this.path[L].updateScroll();const A=this.layout;this.layout=this.measure(!1),this.layoutCorrected=qn(),this.isLayoutDirty=!1,this.projectionDelta=void 0,this.notifyListeners("measure",this.layout.layoutBox);const{visualElement:P}=this.options;P&&P.notify("LayoutMeasure",this.layout.layoutBox,A?A.layoutBox:void 0)}updateScroll(A="measure"){let P=!!(this.options.layoutScroll&&this.instance);this.scroll&&this.scroll.animationId===this.root.animationId&&this.scroll.phase===A&&(P=!1),P&&(this.scroll={animationId:this.root.animationId,phase:A,isRoot:f(this.instance),offset:h(this.instance)})}resetTransform(){if(!y)return;const A=this.isLayoutDirty||this.shouldResetTransform,P=this.projectionDelta&&!qU(this.projectionDelta),L=this.getTransformTemplate(),U=L?L(this.latestValues,""):void 0,M=U!==this.prevTransformTemplateValue;A&&(P||tc(this.latestValues)||M)&&(y(this.instance,U),this.shouldResetTransform=!1,this.scheduleRender())}measure(A=!0){const P=this.measurePageBox();let L=this.removeElementScroll(P);return A&&(L=this.removeTransform(L)),f$(L),{animationId:this.root.animationId,measuredBox:P,layoutBox:L,latestValues:{},source:this.id}}measurePageBox(){const{visualElement:A}=this.options;if(!A)return qn();const P=A.measureViewportBox(),{scroll:L}=this.root;return L&&(Xo(P.x,L.offset.x),Xo(P.y,L.offset.y)),P}removeElementScroll(A){const P=qn();xr(P,A);for(let L=0;L<this.path.length;L++){const U=this.path[L],{scroll:M,options:V}=U;if(U!==this.root&&M&&V.layoutScroll){if(M.isRoot){xr(P,A);const{scroll:W}=this.root;W&&(Xo(P.x,-W.offset.x),Xo(P.y,-W.offset.y))}Xo(P.x,M.offset.x),Xo(P.y,M.offset.y)}}return P}applyTransform(A,P=!1){const L=qn();xr(L,A);for(let U=0;U<this.path.length;U++){const M=this.path[U];!P&&M.options.layoutScroll&&M.scroll&&M!==M.root&&Bd(L,{x:-M.scroll.offset.x,y:-M.scroll.offset.y}),tc(M.latestValues)&&Bd(L,M.latestValues)}return tc(this.latestValues)&&Bd(L,this.latestValues),L}removeTransform(A){const P=qn();xr(P,A);for(let L=0;L<this.path.length;L++){const U=this.path[L];if(!U.instance||!tc(U.latestValues))continue;jT(U.latestValues)&&U.updateSnapshot();const M=qn(),V=U.measurePageBox();xr(M,V),Z1(P,U.latestValues,U.snapshot?U.snapshot.layoutBox:void 0,M)}return tc(this.latestValues)&&Z1(P,this.latestValues),P}setTargetDelta(A){this.targetDelta=A,this.root.scheduleUpdateProjection(),this.isProjectionDirty=!0}setOptions(A){this.options={...this.options,...A,crossfade:A.crossfade!==void 0?A.crossfade:!0}}clearMeasurements(){this.scroll=void 0,this.layout=void 0,this.snapshot=void 0,this.prevTransformTemplateValue=void 0,this.targetDelta=void 0,this.target=void 0,this.isLayoutDirty=!1}forceRelativeParentToResolveTarget(){this.relativeParent&&this.relativeParent.resolvedRelativeTargetAt!==bi.timestamp&&this.relativeParent.resolveTargetDelta(!0)}resolveTargetDelta(A=!1){var P;const L=this.getLead();this.isProjectionDirty||(this.isProjectionDirty=L.isProjectionDirty),this.isTransformDirty||(this.isTransformDirty=L.isTransformDirty),this.isSharedProjectionDirty||(this.isSharedProjectionDirty=L.isSharedProjectionDirty);const U=!!this.resumingFrom||this!==L;if(!(A||U&&this.isSharedProjectionDirty||this.isProjectionDirty||!((P=this.parent)===null||P===void 0)&&P.isProjectionDirty||this.attemptToResolveRelativeTarget))return;const{layout:V,layoutId:W}=this.options;if(!(!this.layout||!(V||W))){if(this.resolvedRelativeTargetAt=bi.timestamp,!this.targetDelta&&!this.relativeTarget){const z=this.getClosestProjectingParent();z&&z.layout&&this.animationProgress!==1?(this.relativeParent=z,this.forceRelativeParentToResolveTarget(),this.relativeTarget=qn(),this.relativeTargetOrigin=qn(),ku(this.relativeTargetOrigin,this.layout.layoutBox,z.layout.layoutBox),xr(this.relativeTarget,this.relativeTargetOrigin)):this.relativeParent=this.relativeTarget=void 0}if(!(!this.relativeTarget&&!this.targetDelta)){if(this.target||(this.target=qn(),this.targetWithTransforms=qn()),this.relativeTarget&&this.relativeTargetOrigin&&this.relativeParent&&this.relativeParent.target?(this.forceRelativeParentToResolveTarget(),_Z(this.target,this.relativeTarget,this.relativeParent.target)):this.targetDelta?(this.resumingFrom?this.target=this.applyTransform(this.layout.layoutBox):xr(this.target,this.layout.layoutBox),WU(this.target,this.targetDelta)):xr(this.target,this.layout.layoutBox),this.attemptToResolveRelativeTarget){this.attemptToResolveRelativeTarget=!1;const z=this.getClosestProjectingParent();z&&!!z.resumingFrom==!!this.resumingFrom&&!z.options.layoutScroll&&z.target&&this.animationProgress!==1?(this.relativeParent=z,this.forceRelativeParentToResolveTarget(),this.relativeTarget=qn(),this.relativeTargetOrigin=qn(),ku(this.relativeTargetOrigin,this.target,z.target),xr(this.relativeTarget,this.relativeTargetOrigin)):this.relativeParent=this.relativeTarget=void 0}nc.resolvedTargetDeltas++}}}getClosestProjectingParent(){if(!(!this.parent||jT(this.parent.latestValues)||BU(this.parent.latestValues)))return this.parent.isProjecting()?this.parent:this.parent.getClosestProjectingParent()}isProjecting(){return!!((this.relativeTarget||this.targetDelta||this.options.layoutRoot)&&this.layout)}calcProjection(){var A;const P=this.getLead(),L=!!this.resumingFrom||this!==P;let U=!0;if((this.isProjectionDirty||!((A=this.parent)===null||A===void 0)&&A.isProjectionDirty)&&(U=!1),L&&(this.isSharedProjectionDirty||this.isTransformDirty)&&(U=!1),this.resolvedRelativeTargetAt===bi.timestamp&&(U=!1),U)return;const{layout:M,layoutId:V}=this.options;if(this.isTreeAnimating=!!(this.parent&&this.parent.isTreeAnimating||this.currentAnimation||this.pendingAnimation),this.isTreeAnimating||(this.targetDelta=this.relativeTarget=void 0),!this.layout||!(M||V))return;xr(this.layoutCorrected,this.layout.layoutBox);const W=this.treeScale.x,z=this.treeScale.y;bZ(this.layoutCorrected,this.treeScale,this.path,L),P.layout&&!P.target&&(this.treeScale.x!==1||this.treeScale.y!==1)&&(P.target=P.layout.layoutBox);const{target:X}=P;if(!X){this.projectionTransform&&(this.projectionDelta=Fd(),this.projectionTransform="none",this.scheduleRender());return}this.projectionDelta||(this.projectionDelta=Fd(),this.projectionDeltaWithTransform=Fd());const $=this.projectionTransform;Lu(this.projectionDelta,this.layoutCorrected,X,this.latestValues),this.projectionTransform=tM(this.projectionDelta,this.treeScale),(this.projectionTransform!==$||this.treeScale.x!==W||this.treeScale.y!==z)&&(this.hasProjected=!0,this.scheduleRender(),this.notifyListeners("projectionUpdate",X)),nc.recalculatedProjection++}hide(){this.isVisible=!1}show(){this.isVisible=!0}scheduleRender(A=!0){if(this.options.scheduleRender&&this.options.scheduleRender(),A){const P=this.getStack();P&&P.scheduleRender()}this.resumingFrom&&!this.resumingFrom.instance&&(this.resumingFrom=void 0)}setAnimationOrigin(A,P=!1){const L=this.snapshot,U=L?L.latestValues:{},M={...this.latestValues},V=Fd();(!this.relativeParent||!this.relativeParent.options.layoutRoot)&&(this.relativeTarget=this.relativeTargetOrigin=void 0),this.attemptToResolveRelativeTarget=!P;const W=qn(),z=L?L.source:void 0,X=this.layout?this.layout.source:void 0,$=z!==X,oe=this.getStack(),ve=!oe||oe.members.length<=1,Re=!!($&&!ve&&this.options.crossfade===!0&&!this.path.some(p$));this.animationProgress=0;let pe;this.mixTargetDelta=fe=>{const Be=fe/1e3;oM(V.x,A.x,Be),oM(V.y,A.y,Be),this.setTargetDelta(V),this.relativeTarget&&this.relativeTargetOrigin&&this.layout&&this.relativeParent&&this.relativeParent.layout&&(ku(W,this.layout.layoutBox,this.relativeParent.layout.layoutBox),h$(this.relativeTarget,this.relativeTargetOrigin,W,Be),pe&&KZ(this.relativeTarget,pe)&&(this.isProjectionDirty=!1),pe||(pe=qn()),xr(pe,this.relativeTarget)),$&&(this.animationValues=M,jZ(M,U,this.latestValues,Be,Re,ve)),this.root.scheduleUpdateProjection(),this.scheduleRender(),this.animationProgress=Be},this.mixTargetDelta(this.options.layoutRoot?1e3:0)}startAnimation(A){this.notifyListeners("animationStart"),this.currentAnimation&&this.currentAnimation.stop(),this.resumingFrom&&this.resumingFrom.currentAnimation&&this.resumingFrom.currentAnimation.stop(),this.pendingAnimation&&(lo(this.pendingAnimation),this.pendingAnimation=void 0),this.pendingAnimation=fn.update(()=>{tf.hasAnimatedSinceResize=!0,this.currentAnimation=ZZ(0,iM,{...A,onUpdate:P=>{this.mixTargetDelta(P),A.onUpdate&&A.onUpdate(P)},onComplete:()=>{A.onComplete&&A.onComplete(),this.completeAnimation()}}),this.resumingFrom&&(this.resumingFrom.currentAnimation=this.currentAnimation),this.pendingAnimation=void 0})}completeAnimation(){this.resumingFrom&&(this.resumingFrom.currentAnimation=void 0,this.resumingFrom.preserveOpacity=void 0);const A=this.getStack();A&&A.exitAnimationComplete(),this.resumingFrom=this.currentAnimation=this.animationValues=void 0,this.notifyListeners("animationComplete")}finishAnimation(){this.currentAnimation&&(this.mixTargetDelta&&this.mixTargetDelta(iM),this.currentAnimation.stop()),this.completeAnimation()}applyTransformsToTarget(){const A=this.getLead();let{targetWithTransforms:P,target:L,layout:U,latestValues:M}=A;if(!(!P||!L||!U)){if(this!==A&&this.layout&&U&&QU(this.options.animationType,this.layout.layoutBox,U.layoutBox)){L=this.target||qn();const V=ur(this.layout.layoutBox.x);L.x.min=A.target.x.min,L.x.max=L.x.min+V;const W=ur(this.layout.layoutBox.y);L.y.min=A.target.y.min,L.y.max=L.y.min+W}xr(P,L),Bd(P,M),Lu(this.projectionDeltaWithTransform,this.layoutCorrected,P,M)}}registerSharedNode(A,P){this.sharedNodes.has(A)||this.sharedNodes.set(A,new YZ),this.sharedNodes.get(A).add(P);const U=P.options.initialPromotionConfig;P.promote({transition:U?U.transition:void 0,preserveFollowOpacity:U&&U.shouldPreserveFollowOpacity?U.shouldPreserveFollowOpacity(P):void 0})}isLead(){const A=this.getStack();return A?A.lead===this:!0}getLead(){var A;const{layoutId:P}=this.options;return P?((A=this.getStack())===null||A===void 0?void 0:A.lead)||this:this}getPrevLead(){var A;const{layoutId:P}=this.options;return P?(A=this.getStack())===null||A===void 0?void 0:A.prevLead:void 0}getStack(){const{layoutId:A}=this.options;if(A)return this.root.sharedNodes.get(A)}promote({needsReset:A,transition:P,preserveFollowOpacity:L}={}){const U=this.getStack();U&&U.promote(this,L),A&&(this.projectionDelta=void 0,this.needsReset=!0),P&&this.setOptions({transition:P})}relegate(){const A=this.getStack();return A?A.relegate(this):!1}resetRotation(){const{visualElement:A}=this.options;if(!A)return;let P=!1;const{latestValues:L}=A;if((L.rotate||L.rotateX||L.rotateY||L.rotateZ)&&(P=!0),!P)return;const U={};for(let M=0;M<nM.length;M++){const V="rotate"+nM[M];L[V]&&(U[V]=L[V],A.setStaticValue(V,0))}A.render();for(const M in U)A.setStaticValue(M,U[M]);A.scheduleRender()}getProjectionStyles(A){var P,L;if(!this.instance||this.isSVG)return;if(!this.isVisible)return $Z;const U={visibility:""},M=this.getTransformTemplate();if(this.needsReset)return this.needsReset=!1,U.opacity="",U.pointerEvents=ef(A?.pointerEvents)||"",U.transform=M?M(this.latestValues,""):"none",U;const V=this.getLead();if(!this.projectionDelta||!this.layout||!V.target){const $={};return this.options.layoutId&&($.opacity=this.latestValues.opacity!==void 0?this.latestValues.opacity:1,$.pointerEvents=ef(A?.pointerEvents)||""),this.hasProjected&&!tc(this.latestValues)&&($.transform=M?M({},""):"none",this.hasProjected=!1),$}const W=V.animationValues||V.latestValues;this.applyTransformsToTarget(),U.transform=tM(this.projectionDeltaWithTransform,this.treeScale,W),M&&(U.transform=M(W,U.transform));const{x:z,y:X}=this.projectionDelta;U.transformOrigin=`${z.origin*100}% ${X.origin*100}% 0`,V.animationValues?U.opacity=V===this?(L=(P=W.opacity)!==null&&P!==void 0?P:this.latestValues.opacity)!==null&&L!==void 0?L:1:this.preserveOpacity?this.latestValues.opacity:W.opacityExit:U.opacity=V===this?W.opacity!==void 0?W.opacity:"":W.opacityExit!==void 0?W.opacityExit:0;for(const $ in pf){if(W[$]===void 0)continue;const{correct:oe,applyTo:ve}=pf[$],Re=U.transform==="none"?W[$]:oe(W[$],V);if(ve){const pe=ve.length;for(let fe=0;fe<pe;fe++)U[ve[fe]]=Re}else U[$]=Re}return this.options.layoutId&&(U.pointerEvents=V===this?ef(A?.pointerEvents)||"":"none"),U}clearSnapshot(){this.resumeFrom=this.snapshot=void 0}resetTree(){this.root.nodes.forEach(A=>{var P;return(P=A.currentAnimation)===null||P===void 0?void 0:P.stop()}),this.root.nodes.forEach(rM),this.root.sharedNodes.clear()}}}function t$(d){d.updateLayout()}function n$(d){var l;const h=((l=d.resumeFrom)===null||l===void 0?void 0:l.snapshot)||d.snapshot;if(d.isLead()&&d.layout&&h&&d.hasListeners("didUpdate")){const{layoutBox:f,measuredBox:y}=d.layout,{animationType:w}=d.options,A=h.source!==d.layout.source;w==="size"?Mr(V=>{const W=A?h.measuredBox[V]:h.layoutBox[V],z=ur(W);W.min=f[V].min,W.max=W.min+z}):QU(w,h.layoutBox,f)&&Mr(V=>{const W=A?h.measuredBox[V]:h.layoutBox[V],z=ur(f[V]);W.max=W.min+z,d.relativeTarget&&!d.currentAnimation&&(d.isProjectionDirty=!0,d.relativeTarget[V].max=d.relativeTarget[V].min+z)});const P=Fd();Lu(P,f,h.layoutBox);const L=Fd();A?Lu(L,d.applyTransform(y,!0),h.measuredBox):Lu(L,f,h.layoutBox);const U=!qU(P);let M=!1;if(!d.resumeFrom){const V=d.getClosestProjectingParent();if(V&&!V.resumeFrom){const{snapshot:W,layout:z}=V;if(W&&z){const X=qn();ku(X,h.layoutBox,W.layoutBox);const $=qn();ku($,f,z.layoutBox),XU(X,$)||(M=!0),V.options.layoutRoot&&(d.relativeTarget=$,d.relativeTargetOrigin=X,d.relativeParent=V)}}}d.notifyListeners("didUpdate",{layout:f,snapshot:h,delta:L,layoutDelta:P,hasLayoutChanged:U,hasRelativeTargetChanged:M})}else if(d.isLead()){const{onExitComplete:f}=d.options;f&&f()}d.options.transition=void 0}function i$(d){nc.totalNodes++,d.parent&&(d.isProjecting()||(d.isProjectionDirty=d.parent.isProjectionDirty),d.isSharedProjectionDirty||(d.isSharedProjectionDirty=!!(d.isProjectionDirty||d.parent.isProjectionDirty||d.parent.isSharedProjectionDirty)),d.isTransformDirty||(d.isTransformDirty=d.parent.isTransformDirty))}function r$(d){d.isProjectionDirty=d.isSharedProjectionDirty=d.isTransformDirty=!1}function s$(d){d.clearSnapshot()}function rM(d){d.clearMeasurements()}function o$(d){d.isLayoutDirty=!1}function a$(d){const{visualElement:l}=d.options;l&&l.getProps().onBeforeLayoutMeasure&&l.notify("BeforeLayoutMeasure"),d.resetTransform()}function sM(d){d.finishAnimation(),d.targetDelta=d.relativeTarget=d.target=void 0,d.isProjectionDirty=!0}function c$(d){d.resolveTargetDelta()}function d$(d){d.calcProjection()}function l$(d){d.resetRotation()}function u$(d){d.removeLeadSnapshot()}function oM(d,l,h){d.translate=Ln(l.translate,0,h),d.scale=Ln(l.scale,1,h),d.origin=l.origin,d.originPoint=l.originPoint}function aM(d,l,h,f){d.min=Ln(l.min,h.min,f),d.max=Ln(l.max,h.max,f)}function h$(d,l,h,f){aM(d.x,l.x,h.x,f),aM(d.y,l.y,h.y,f)}function p$(d){return d.animationValues&&d.animationValues.opacityExit!==void 0}const m$={duration:.45,ease:[.4,0,.1,1]},cM=d=>typeof navigator<"u"&&navigator.userAgent.toLowerCase().includes(d),dM=cM("applewebkit/")&&!cM("chrome/")?Math.round:Wn;function lM(d){d.min=dM(d.min),d.max=dM(d.max)}function f$(d){lM(d.x),lM(d.y)}function QU(d,l,h){return d==="position"||d==="preserve-aspect"&&!UT(eM(l),eM(h),.2)}const _$=JU({attachResizeListener:(d,l)=>oo(d,"resize",l),measureScroll:()=>({x:document.documentElement.scrollLeft||document.body.scrollLeft,y:document.documentElement.scrollTop||document.body.scrollTop}),checkIsScrollRoot:()=>!0}),RT={current:void 0},ZU=JU({measureScroll:d=>({x:d.scrollLeft,y:d.scrollTop}),defaultParent:()=>{if(!RT.current){const d=new _$({});d.mount(window),d.setOptions({layoutScroll:!0}),RT.current=d}return RT.current},resetTransform:(d,l)=>{d.style.transform=l!==void 0?l:"none"},checkIsScrollRoot:d=>window.getComputedStyle(d).position==="fixed"}),g$={pan:{Feature:LZ},drag:{Feature:PZ,ProjectionNode:ZU,MeasureLayout:KU}},E$=/var\((--[a-zA-Z0-9-_]+),? ?([a-zA-Z0-9 ()%#.,-]+)?\)/;function S$(d){const l=E$.exec(d);if(!l)return[,];const[,h,f]=l;return[h,f]}function BT(d,l,h=1){const[f,y]=S$(d);if(!f)return;const w=window.getComputedStyle(l).getPropertyValue(f);if(w){const A=w.trim();return kU(A)?parseFloat(A):A}else return NT(y)?BT(y,l,h+1):y}function y$(d,{...l},h){const f=d.current;if(!(f instanceof Element))return{target:l,transitionEnd:h};h&&(h={...h}),d.values.forEach(y=>{const w=y.get();if(!NT(w))return;const A=BT(w,f);A&&y.set(A)});for(const y in l){const w=l[y];if(!NT(w))continue;const A=BT(w,f);A&&(l[y]=A,h||(h={}),h[y]===void 0&&(h[y]=w))}return{target:l,transitionEnd:h}}const T$=new Set(["width","height","top","left","right","bottom","x","y","translateX","translateY"]),$U=d=>T$.has(d),v$=d=>Object.keys(d).some($U),uM=d=>d===uc||d===dt,hM=(d,l)=>parseFloat(d.split(", ")[l]),pM=(d,l)=>(h,{transform:f})=>{if(f==="none"||!f)return 0;const y=f.match(/^matrix3d\((.+)\)$/);if(y)return hM(y[1],l);{const w=f.match(/^matrix\((.+)\)$/);return w?hM(w[1],d):0}},R$=new Set(["x","y","z"]),C$=Bu.filter(d=>!R$.has(d));function b$(d){const l=[];return C$.forEach(h=>{const f=d.getValue(h);f!==void 0&&(l.push([h,f.get()]),f.set(h.startsWith("scale")?1:0))}),l.length&&d.render(),l}const Kd={width:({x:d},{paddingLeft:l="0",paddingRight:h="0"})=>d.max-d.min-parseFloat(l)-parseFloat(h),height:({y:d},{paddingTop:l="0",paddingBottom:h="0"})=>d.max-d.min-parseFloat(l)-parseFloat(h),top:(d,{top:l})=>parseFloat(l),left:(d,{left:l})=>parseFloat(l),bottom:({y:d},{top:l})=>parseFloat(l)+(d.max-d.min),right:({x:d},{left:l})=>parseFloat(l)+(d.max-d.min),x:pM(4,13),y:pM(5,14)};Kd.translateX=Kd.x;Kd.translateY=Kd.y;const w$=(d,l,h)=>{const f=l.measureViewportBox(),y=l.current,w=getComputedStyle(y),{display:A}=w,P={};A==="none"&&l.setStaticValue("display",d.display||"block"),h.forEach(U=>{P[U]=Kd[U](f,w)}),l.render();const L=l.measureViewportBox();return h.forEach(U=>{const M=l.getValue(U);M&&M.jump(P[U]),d[U]=Kd[U](L,w)}),d},A$=(d,l,h={},f={})=>{l={...l},f={...f};const y=Object.keys(l).filter($U);let w=[],A=!1;const P=[];if(y.forEach(L=>{const U=d.getValue(L);if(!d.hasValue(L))return;let M=h[L],V=vu(M);const W=l[L];let z;if(ff(W)){const X=W.length,$=W[0]===null?1:0;M=W[$],V=vu(M);for(let oe=$;oe<X&&W[oe]!==null;oe++)z?mv(vu(W[oe])===z):z=vu(W[oe])}else z=vu(W);if(V!==z)if(uM(V)&&uM(z)){const X=U.get();typeof X=="string"&&U.set(parseFloat(X)),typeof W=="string"?l[L]=parseFloat(W):Array.isArray(W)&&z===dt&&(l[L]=W.map(parseFloat))}else V?.transform&&z?.transform&&(M===0||W===0)?M===0?U.set(z.transform(M)):l[L]=V.transform(W):(A||(w=b$(d),A=!0),P.push(L),f[L]=f[L]!==void 0?f[L]:l[L],U.jump(W))}),P.length){const L=P.indexOf("height")>=0?window.pageYOffset:null,U=w$(l,d,P);return w.length&&w.forEach(([M,V])=>{d.getValue(M).set(V)}),d.render(),Nf&&L!==null&&window.scrollTo({top:L}),{target:U,transitionEnd:f}}else return{target:l,transitionEnd:f}};function I$(d,l,h,f){return v$(l)?A$(d,l,h,f):{target:l,transitionEnd:f}}const O$=(d,l,h,f)=>{const y=y$(d,l,f);return l=y.target,f=y.transitionEnd,I$(d,l,h,f)},WT={current:null},e2={current:!1};function N$(){if(e2.current=!0,!!Nf)if(window.matchMedia){const d=window.matchMedia("(prefers-reduced-motion)"),l=()=>WT.current=d.matches;d.addListener(l),l()}else WT.current=!1}function D$(d,l,h){const{willChange:f}=l;for(const y in l){const w=l[y],A=h[y];if(Qi(w))d.addValue(y,w),Sf(f)&&f.add(y);else if(Qi(A))d.addValue(y,Hd(w,{owner:d})),Sf(f)&&f.remove(y);else if(A!==w)if(d.hasValue(y)){const P=d.getValue(y);!P.hasAnimated&&P.set(w)}else{const P=d.getStaticValue(y);d.addValue(y,Hd(P!==void 0?P:w,{owner:d}))}}for(const y in h)l[y]===void 0&&d.removeValue(y);return l}const mM=new WeakMap,t2=Object.keys(Uu),P$=t2.length,fM=["AnimationStart","AnimationComplete","Update","BeforeLayoutMeasure","LayoutMeasure","LayoutAnimationStart","LayoutAnimationComplete"],L$=sv.length;class k${constructor({parent:l,props:h,presenceContext:f,reducedMotionConfig:y,visualState:w},A={}){this.current=null,this.children=new Set,this.isVariantNode=!1,this.isControllingVariants=!1,this.shouldReduceMotion=null,this.values=new Map,this.features={},this.valueSubscriptions=new Map,this.prevMotionValues={},this.events={},this.propEventSubscriptions={},this.notifyUpdate=()=>this.notify("Update",this.latestValues),this.render=()=>{this.current&&(this.triggerBuild(),this.renderInstance(this.current,this.renderState,this.props.style,this.projection))},this.scheduleRender=()=>fn.render(this.render,!1,!0);const{latestValues:P,renderState:L}=w;this.latestValues=P,this.baseTarget={...P},this.initialValues=h.initial?{...P}:{},this.renderState=L,this.parent=l,this.props=h,this.presenceContext=f,this.depth=l?l.depth+1:0,this.reducedMotionConfig=y,this.options=A,this.isControllingVariants=Pf(h),this.isVariantNode=jM(h),this.isVariantNode&&(this.variantChildren=new Set),this.manuallyAnimateOnMount=!!(l&&l.current);const{willChange:U,...M}=this.scrapeMotionValuesFromProps(h,{});for(const V in M){const W=M[V];P[V]!==void 0&&Qi(W)&&(W.set(P[V],!1),Sf(U)&&U.add(V))}}scrapeMotionValuesFromProps(l,h){return{}}mount(l){this.current=l,mM.set(l,this),this.projection&&!this.projection.instance&&this.projection.mount(l),this.parent&&this.isVariantNode&&!this.isControllingVariants&&(this.removeFromVariantTree=this.parent.addVariantChild(this)),this.values.forEach((h,f)=>this.bindToMotionValue(f,h)),e2.current||N$(),this.shouldReduceMotion=this.reducedMotionConfig==="never"?!1:this.reducedMotionConfig==="always"?!0:WT.current,this.parent&&this.parent.children.add(this),this.update(this.props,this.presenceContext)}unmount(){mM.delete(this.current),this.projection&&this.projection.unmount(),lo(this.notifyUpdate),lo(this.render),this.valueSubscriptions.forEach(l=>l()),this.removeFromVariantTree&&this.removeFromVariantTree(),this.parent&&this.parent.children.delete(this);for(const l in this.events)this.events[l].clear();for(const l in this.features)this.features[l].unmount();this.current=null}bindToMotionValue(l,h){const f=lc.has(l),y=h.on("change",A=>{this.latestValues[l]=A,this.props.onUpdate&&fn.update(this.notifyUpdate,!1,!0),f&&this.projection&&(this.projection.isTransformDirty=!0)}),w=h.on("renderRequest",this.scheduleRender);this.valueSubscriptions.set(l,()=>{y(),w()})}sortNodePosition(l){return!this.current||!this.sortInstanceNodePosition||this.type!==l.type?0:this.sortInstanceNodePosition(this.current,l.current)}loadFeatures({children:l,...h},f,y,w){let A,P;for(let L=0;L<P$;L++){const U=t2[L],{isEnabled:M,Feature:V,ProjectionNode:W,MeasureLayout:z}=Uu[U];W&&(A=W),M(h)&&(!this.features[U]&&V&&(this.features[U]=new V(this)),z&&(P=z))}if((this.type==="html"||this.type==="svg")&&!this.projection&&A){this.projection=new A(this.latestValues,this.parent&&this.parent.projection);const{layoutId:L,layout:U,drag:M,dragConstraints:V,layoutScroll:W,layoutRoot:z}=h;this.projection.setOptions({layoutId:L,layout:U,alwaysMeasureLayout:!!M||V&&Vd(V),visualElement:this,scheduleRender:()=>this.scheduleRender(),animationType:typeof U=="string"?U:"both",initialPromotionConfig:w,layoutScroll:W,layoutRoot:z})}return P}updateFeatures(){for(const l in this.features){const h=this.features[l];h.isMounted?h.update():(h.mount(),h.isMounted=!0)}}triggerBuild(){this.build(this.renderState,this.latestValues,this.options,this.props)}measureViewportBox(){return this.current?this.measureInstanceViewportBox(this.current,this.props):qn()}getStaticValue(l){return this.latestValues[l]}setStaticValue(l,h){this.latestValues[l]=h}makeTargetAnimatable(l,h=!0){return this.makeTargetAnimatableFromInstance(l,this.props,h)}update(l,h){(l.transformTemplate||this.props.transformTemplate)&&this.scheduleRender(),this.prevProps=this.props,this.props=l,this.prevPresenceContext=this.presenceContext,this.presenceContext=h;for(let f=0;f<fM.length;f++){const y=fM[f];this.propEventSubscriptions[y]&&(this.propEventSubscriptions[y](),delete this.propEventSubscriptions[y]);const w=l["on"+y];w&&(this.propEventSubscriptions[y]=this.on(y,w))}this.prevMotionValues=D$(this,this.scrapeMotionValuesFromProps(l,this.prevProps),this.prevMotionValues),this.handleChildMotionValue&&this.handleChildMotionValue()}getProps(){return this.props}getVariant(l){return this.props.variants?this.props.variants[l]:void 0}getDefaultTransition(){return this.props.transition}getTransformPagePoint(){return this.props.transformPagePoint}getClosestVariantNode(){return this.isVariantNode?this:this.parent?this.parent.getClosestVariantNode():void 0}getVariantContext(l=!1){if(l)return this.parent?this.parent.getVariantContext():void 0;if(!this.isControllingVariants){const f=this.parent?this.parent.getVariantContext()||{}:{};return this.props.initial!==void 0&&(f.initial=this.props.initial),f}const h={};for(let f=0;f<L$;f++){const y=sv[f],w=this.props[y];(Mu(w)||w===!1)&&(h[y]=w)}return h}addVariantChild(l){const h=this.getClosestVariantNode();if(h)return h.variantChildren&&h.variantChildren.add(l),()=>h.variantChildren.delete(l)}addValue(l,h){h!==this.values.get(l)&&(this.removeValue(l),this.bindToMotionValue(l,h)),this.values.set(l,h),this.latestValues[l]=h.get()}removeValue(l){this.values.delete(l);const h=this.valueSubscriptions.get(l);h&&(h(),this.valueSubscriptions.delete(l)),delete this.latestValues[l],this.removeValueFromRenderState(l,this.renderState)}hasValue(l){return this.values.has(l)}getValue(l,h){if(this.props.values&&this.props.values[l])return this.props.values[l];let f=this.values.get(l);return f===void 0&&h!==void 0&&(f=Hd(h,{owner:this}),this.addValue(l,f)),f}readValue(l){var h;return this.latestValues[l]!==void 0||!this.current?this.latestValues[l]:(h=this.getBaseTargetFromProps(this.props,l))!==null&&h!==void 0?h:this.readValueFromInstance(this.current,l,this.options)}setBaseTarget(l,h){this.baseTarget[l]=h}getBaseTarget(l){var h;const{initial:f}=this.props,y=typeof f=="string"||typeof f=="object"?(h=pv(this.props,f))===null||h===void 0?void 0:h[l]:void 0;if(f&&y!==void 0)return y;const w=this.getBaseTargetFromProps(this.props,l);return w!==void 0&&!Qi(w)?w:this.initialValues[l]!==void 0&&y===void 0?void 0:this.baseTarget[l]}on(l,h){return this.events[l]||(this.events[l]=new Rv),this.events[l].add(h)}notify(l,...h){this.events[l]&&this.events[l].notify(...h)}}class n2 extends k${sortInstanceNodePosition(l,h){return l.compareDocumentPosition(h)&2?1:-1}getBaseTargetFromProps(l,h){return l.style?l.style[h]:void 0}removeValueFromRenderState(l,{vars:h,style:f}){delete h[l],delete f[l]}makeTargetAnimatableFromInstance({transition:l,transitionEnd:h,...f},{transformValues:y},w){let A=QQ(f,l||{},this);if(y&&(h&&(h=y(h)),f&&(f=y(f)),A&&(A=y(A))),w){XQ(this,f,A);const P=O$(this,f,A,h);h=P.transitionEnd,f=P.target}return{transition:l,transitionEnd:h,...f}}}function x$(d){return window.getComputedStyle(d)}class M$ extends n2{constructor(){super(...arguments),this.type="html"}readValueFromInstance(l,h){if(lc.has(h)){const f=Ev(h);return f&&f.default||0}else{const f=x$(l),y=(GM(h)?f.getPropertyValue(h):f[h])||0;return typeof y=="string"?y.trim():y}}measureInstanceViewportBox(l,{transformPagePoint:h}){return GU(l,h)}build(l,h,f,y){cv(l,h,f,y.transformTemplate)}scrapeMotionValuesFromProps(l,h){return hv(l,h)}handleChildMotionValue(){this.childSubscription&&(this.childSubscription(),delete this.childSubscription);const{children:l}=this.props;Qi(l)&&(this.childSubscription=l.on("change",h=>{this.current&&(this.current.textContent=`${h}`)}))}renderInstance(l,h,f,y){XM(l,h,f,y)}}class U$ extends n2{constructor(){super(...arguments),this.type="svg",this.isSVGTag=!1}getBaseTargetFromProps(l,h){return l[h]}readValueFromInstance(l,h){if(lc.has(h)){const f=Ev(h);return f&&f.default||0}return h=JM.has(h)?h:iv(h),l.getAttribute(h)}measureInstanceViewportBox(){return qn()}scrapeMotionValuesFromProps(l,h){return ZM(l,h)}build(l,h,f,y){lv(l,h,f,this.isSVGTag,y.transformTemplate)}renderInstance(l,h,f,y){QM(l,h,f,y)}mount(l){this.isSVGTag=uv(l.tagName),super.mount(l)}}const V$=(d,l)=>av(d)?new U$(l,{enableHardwareAcceleration:!1}):new M$(l,{enableHardwareAcceleration:!0}),j$={layout:{ProjectionNode:ZU,MeasureLayout:KU}},F$={...hZ,...P7,...g$,...j$},B$=BJ((d,l)=>S7(d,l,F$,V$));function i2(){const d=K.useRef(!1);return nv(()=>(d.current=!0,()=>{d.current=!1}),[]),d}function W$(){const d=i2(),[l,h]=K.useState(0),f=K.useCallback(()=>{d.current&&h(l+1)},[l]);return[K.useCallback(()=>fn.postRender(f),[f]),l]}class G$ extends K.Component{getSnapshotBeforeUpdate(l){const h=this.props.childRef.current;if(h&&l.isPresent&&!this.props.isPresent){const f=this.props.sizeRef.current;f.height=h.offsetHeight||0,f.width=h.offsetWidth||0,f.top=h.offsetTop,f.left=h.offsetLeft}return null}componentDidUpdate(){}render(){return this.props.children}}function H$({children:d,isPresent:l}){const h=K.useId(),f=K.useRef(null),y=K.useRef({width:0,height:0,top:0,left:0});return K.useInsertionEffect(()=>{const{width:w,height:A,top:P,left:L}=y.current;if(l||!f.current||!w||!A)return;f.current.dataset.motionPopId=h;const U=document.createElement("style");return document.head.appendChild(U),U.sheet&&U.sheet.insertRule(`
          [data-motion-pop-id="${h}"] {
            position: absolute !important;
            width: ${w}px !important;
            height: ${A}px !important;
            top: ${P}px !important;
            left: ${L}px !important;
          }
        `),()=>{document.head.removeChild(U)}},[l]),K.createElement(G$,{isPresent:l,childRef:f,sizeRef:y},K.cloneElement(d,{ref:f}))}const CT=({children:d,initial:l,isPresent:h,onExitComplete:f,custom:y,presenceAffectsLayout:w,mode:A})=>{const P=$M(K$),L=K.useId(),U=K.useMemo(()=>({id:L,initial:l,isPresent:h,custom:y,onExitComplete:M=>{P.set(M,!0);for(const V of P.values())if(!V)return;f&&f()},register:M=>(P.set(M,!1),()=>P.delete(M))}),w?void 0:[h]);return K.useMemo(()=>{P.forEach((M,V)=>P.set(V,!1))},[h]),K.useEffect(()=>{!h&&!P.size&&f&&f()},[h]),A==="popLayout"&&(d=K.createElement(H$,{isPresent:h},d)),K.createElement(Of.Provider,{value:U},d)};function K$(){return new Map}function Y$(d){return K.useEffect(()=>()=>d(),[])}const ic=d=>d.key||"";function z$(d,l){d.forEach(h=>{const f=ic(h);l.set(f,h)})}function q$(d){const l=[];return K.Children.forEach(d,h=>{K.isValidElement(h)&&l.push(h)}),l}const X$=({children:d,custom:l,initial:h=!0,onExitComplete:f,exitBeforeEnter:y,presenceAffectsLayout:w=!0,mode:A="sync"})=>{const P=K.useContext(ov).forceRender||W$()[0],L=i2(),U=q$(d);let M=U;const V=K.useRef(new Map).current,W=K.useRef(M),z=K.useRef(new Map).current,X=K.useRef(!0);if(nv(()=>{X.current=!1,z$(U,z),W.current=M}),Y$(()=>{X.current=!0,z.clear(),V.clear()}),X.current)return K.createElement(K.Fragment,null,M.map(Re=>K.createElement(CT,{key:ic(Re),isPresent:!0,initial:h?void 0:!1,presenceAffectsLayout:w,mode:A},Re)));M=[...M];const $=W.current.map(ic),oe=U.map(ic),ve=$.length;for(let Re=0;Re<ve;Re++){const pe=$[Re];oe.indexOf(pe)===-1&&!V.has(pe)&&V.set(pe,void 0)}return A==="wait"&&V.size&&(M=[]),V.forEach((Re,pe)=>{if(oe.indexOf(pe)!==-1)return;const fe=z.get(pe);if(!fe)return;const Be=$.indexOf(pe);let Ne=Re;if(!Ne){const Ee=()=>{V.delete(pe);const Q=Array.from(z.keys()).filter(je=>!oe.includes(je));if(Q.forEach(je=>z.delete(je)),W.current=U.filter(je=>{const Tt=ic(je);return Tt===pe||Q.includes(Tt)}),!V.size){if(L.current===!1)return;P(),f&&f()}};Ne=K.createElement(CT,{key:ic(fe),isPresent:!1,onExitComplete:Ee,custom:l,presenceAffectsLayout:w,mode:A},fe),V.set(pe,Ne)}M.splice(Be,0,Ne)}),M=M.map(Re=>{const pe=Re.key;return V.has(pe)?Re:K.createElement(CT,{key:ic(Re),isPresent:!0,presenceAffectsLayout:w,mode:A},Re)}),K.createElement(K.Fragment,null,V.size?M:M.map(Re=>K.cloneElement(Re)))},nf="/api/webapp";async function Ke(d,l={}){const h=`${nf}${d}`,f={"Content-Type":"application/json",...l.headers},y=await fetch(h,{credentials:"include",headers:f,...l}),w=await y.json();if(!y.ok)throw new Error(w.error||`Request failed (${y.status})`);return w}const We={authStatus:async()=>{const d=await fetch("/api/me",{credentials:"include"}),l=await d.json();if(!d.ok)throw new Error(l.error||`Request failed (${d.status})`);return l},telegramLogin:d=>Ke("/auth/telegram",{method:"POST",body:JSON.stringify({telegramUser:d})}),emailLogin:(d,l,h=!1)=>Ke("/auth/email/login",{method:"POST",body:JSON.stringify({email:d,password:l,rememberMe:h})}),emailRegister:(d,l,h,f="")=>Ke("/auth/email/register",{method:"POST",body:JSON.stringify({firstName:d,email:l,password:h,lastName:f})}),forgotPassword:d=>Ke("/auth/forgot-password",{method:"POST",body:JSON.stringify({email:d})}),xLoginStart:async()=>(window.location.assign("/api/webapp/auth/x/start?redirect=true"),{success:!0}),logout:()=>Ke("/auth/logout",{method:"POST"}),getProfile:()=>Ke("/profile"),updateProfile:d=>Ke("/profile",{method:"PUT",body:JSON.stringify(d)}),uploadAvatar:d=>{const l=new FormData;return l.append("avatar",d),fetch(`${nf}/profile/avatar`,{method:"POST",credentials:"include",body:l}).then(h=>h.json()).then(h=>{if(!h.success)throw new Error(h.error||"Upload failed");return h})},nearbyUpdateLocation:(d,l,h)=>Ke("/nearby/update-location",{method:"POST",body:JSON.stringify({latitude:d,longitude:l,accuracy:h})}),nearbySearch:(d,l,h=5)=>Ke(`/nearby/search?latitude=${d}&longitude=${l}&radius=${h}&limit=30`),getMastodonFeed:(d=10)=>Ke(`/mastodon/feed?limit=${d}`),getMediaLibrary:(d="all",l=50)=>fetch(`/api/media/library?type=${d}&limit=${l}`,{credentials:"include"}).then(h=>h.json()),getRadioNowPlaying:()=>fetch("/api/radio/now-playing",{credentials:"include"}).then(d=>d.json()).catch(()=>({})),getPublicHangouts:()=>Ke("/webapp/hangouts/public"),createHangout:d=>Ke("/webapp/hangouts/create",{method:"POST",body:JSON.stringify(d)}),joinHangout:d=>Ke(`/webapp/hangouts/join/${d}`,{method:"POST"}),leaveHangout:d=>Ke(`/webapp/hangouts/leave/${d}`,{method:"POST"}),endHangout:d=>Ke(`/webapp/hangouts/${d}`,{method:"DELETE"}),getFeed:d=>Ke(`/social/feed${d?`?cursor=${encodeURIComponent(d)}`:""}`),getWall:(d,l)=>Ke(`/social/wall/${d}${l?`?cursor=${encodeURIComponent(l)}`:""}`),createPost:d=>Ke("/social/posts",{method:"POST",body:JSON.stringify(d)}),createPostWithMedia:(d,l)=>{const h=new FormData;return h.append("content",d),l&&h.append("media",l),fetch(`${nf}/social/posts/with-media`,{method:"POST",credentials:"include",body:h}).then(f=>f.json()).then(f=>{if(!f.success)throw new Error(f.error||"Post failed");return f})},toggleLike:d=>Ke(`/social/posts/${d}/like`,{method:"POST"}),deletePost:d=>Ke(`/social/posts/${d}`,{method:"DELETE"}),getReplies:(d,l)=>Ke(`/social/posts/${d}/replies${l?`?cursor=${encodeURIComponent(l)}`:""}`),getDMThreads:()=>Ke("/dm/threads"),getConversation:(d,l)=>Ke(`/dm/conversation/${d}${l?`?cursor=${encodeURIComponent(l)}`:""}`),getDMPartnerInfo:d=>Ke(`/dm/user/${d}`),sendDMRest:(d,l)=>Ke(`/dm/send/${d}`,{method:"POST",body:JSON.stringify({content:l})}),getChatHistory:(d="general")=>Ke(`/chat/${d}/history`),sendChatRest:(d="general",l)=>Ke(`/chat/${d}/send`,{method:"POST",body:JSON.stringify({content:l})}),searchUsers:d=>Ke(`/users/search?q=${encodeURIComponent(d)}`),getAdminStats:()=>Ke("/admin/stats"),listAdminUsers:(d,l)=>Ke(`/admin/users?page=${d}&search=${encodeURIComponent(l||"")}`),getAdminUser:d=>Ke(`/admin/users/${d}`),updateAdminUser:(d,l)=>Ke(`/admin/users/${d}`,{method:"PUT",body:JSON.stringify(l)}),banAdminUser:(d,l,h)=>Ke(`/admin/users/${d}/ban`,{method:"POST",body:JSON.stringify({ban:l,reason:h})}),listAdminPosts:d=>Ke(`/admin/posts?page=${d}`),deleteAdminPost:d=>Ke(`/admin/posts/${d}`,{method:"DELETE"}),listAdminHangouts:()=>Ke("/admin/hangouts"),endAdminHangout:d=>Ke(`/admin/hangouts/${d}`,{method:"DELETE"}),getLiveStreams:()=>Ke("/live/streams"),startLiveStream:d=>Ke("/live/start",{method:"POST",body:JSON.stringify(d)}),joinLiveStream:d=>Ke(`/live/streams/${d}/join`),endLiveStream:d=>Ke(`/live/streams/${d}/end`,{method:"POST"}),leaveLiveStream:d=>Ke(`/live/streams/${d}/leave`,{method:"POST"}),getAdminMedia:(d="")=>{const l=`/admin/media/library${d}`;return Ke(l)},getAdminMediaCategories:()=>Ke("/admin/media/categories"),uploadAdminMedia:d=>fetch(`${nf}/admin/media/upload`,{method:"POST",credentials:"include",body:d}).then(l=>l.json()).then(l=>{if(!l.success&&!l.media)throw new Error(l.error||"Upload failed");return l}),updateAdminMedia:(d,l)=>Ke(`/admin/media/${d}`,{method:"PUT",body:JSON.stringify(l)}),deleteAdminMedia:d=>Ke(`/admin/media/${d}`,{method:"DELETE"}),getAdminRadioNowPlaying:()=>Ke("/admin/radio/now-playing"),setAdminRadioNowPlaying:d=>Ke("/admin/radio/now-playing",{method:"POST",body:JSON.stringify(d)}),getAdminRadioQueue:()=>Ke("/admin/radio/queue"),addAdminRadioQueue:d=>Ke("/admin/radio/queue",{method:"POST",body:JSON.stringify(d)}),removeAdminRadioQueue:d=>Ke(`/admin/radio/queue/${d}`,{method:"DELETE"}),clearAdminRadioQueue:()=>Ke("/admin/radio/queue/clear",{method:"POST"}),getAdminRadioRequests:(d="pending")=>Ke(`/admin/radio/requests?status=${d}`),updateAdminRadioRequest:(d,l)=>Ke(`/admin/radio/requests/${d}`,{method:"PUT",body:JSON.stringify(l)}),getAdminRoles:()=>Ke("/admin/roles"),getAdminUsersByRole:(d,l=1,h=20)=>Ke(`/admin/users?role=${d}&page=${l}&limit=${h}`),assignAdminUserRole:(d,l,h="")=>Ke("/admin/users/role",{method:"PUT",body:JSON.stringify({userId:d,roleName:l,reason:h})}),removeAdminUserRole:(d,l)=>Ke(`/admin/users/${d}/role`,{method:"DELETE",body:JSON.stringify({userId:d,roleName:l})}),getAdminUserRoles:d=>Ke(`/admin/users/${d}/roles`),getAdminPermissions:(d=null)=>{let l="/admin/permissions";return d&&(l+=`?roleName=${d}`),Ke(l)},checkAdminPermission:(d,l)=>Ke(`/admin/permissions/check?userId=${d}&permission=${l}`),getAdminAuditLogs:(d={})=>{const l=new URLSearchParams;return Object.entries(d).forEach(([h,f])=>{f&&l.append(h,f)}),Ke(`/admin/audit-logs?${l.toString()}`)},getAdminAuditLogsResource:(d,l,h=50)=>Ke(`/admin/audit-logs/resource?resourceType=${d}&resourceId=${l}&limit=${h}`),getLatestPrimeVideo:()=>Ke("/prime/latest"),getLatestVideoramaVideo:()=>Ke("/videorama/latest"),getActiveLiveStreams:()=>Ke("/livestream/active"),getMostActiveHangout:()=>Ke("/hangouts/most-active")},rf=We,r2=K.createContext(null);function J$({children:d}){const[l,h]=K.useState(null),[f,y]=K.useState(!0),w=K.useCallback(async()=>{try{const V=await We.authStatus();V.authenticated?h(V.user):h(null)}catch{h(null)}finally{y(!1)}},[]);K.useEffect(()=>{w()},[w]);const A=K.useCallback(async V=>{const W=await We.telegramLogin(V);return W.authenticated&&W.registered?(h(W.user),{success:!0}):{success:!1,...W}},[]),P=K.useCallback(async(V,W,z=!1)=>{const X=await We.emailLogin(V,W,z);return X.authenticated?(h(X.user),{success:!0}):{success:!1,...X}},[]),L=K.useCallback(async(V,W,z,X="")=>{const $=await We.emailRegister(V,W,z,X);return $.authenticated?(h($.user),{success:!0}):{success:!1,...$}},[]),U=K.useCallback(async()=>{await We.xLoginStart()},[]),M=K.useCallback(async()=>{await We.logout(),h(null),window.location.replace("/")},[]);return E.jsx(r2.Provider,{value:{user:l,loading:f,loginWithTelegram:A,loginWithEmail:P,registerWithEmail:L,loginWithX:U,logout:M,checkAuth:w},children:d})}function hr(){const d=K.useContext(r2);if(!d)throw new Error("useAuth must be used within AuthProvider");return d}function Q$(){const{user:d}=hr(),l=JT();return E.jsxs("header",{className:"app-header",children:[E.jsx("div",{className:"header-left",children:E.jsx(pn,{to:"/",className:"header-logo",children:E.jsx("img",{src:"/logo.png",alt:"PNPtv PRIME"})})}),E.jsxs("nav",{className:"header-nav",children:[d&&["admin","superadmin"].includes(d.role)&&E.jsx(pn,{to:"/admin",className:`header-nav-btn ${l.pathname.startsWith("/admin")?"active":""}`,title:"Admin Panel",children:E.jsx(tJ,{size:18})}),E.jsx(pn,{to:"/feed",className:`header-nav-btn ${l.pathname==="/feed"?"active":""}`,title:"Social Feed",children:E.jsx(PM,{size:18})}),E.jsx(pn,{to:"/messages",className:`header-nav-btn ${l.pathname.startsWith("/messages")?"active":""}`,title:"Messages",children:E.jsx(vf,{size:18})}),E.jsx("a",{href:"/terms",target:"_blank",rel:"noopener",className:"header-nav-btn",title:"Terms",children:E.jsx(nJ,{size:18})}),E.jsx("a",{href:"https://t.me/PNPLatinoTV_Bot",target:"_blank",rel:"noopener",className:"header-nav-btn",title:"Support",children:E.jsx(iJ,{size:18})})]}),E.jsxs("div",{className:"header-right",children:[d&&E.jsx(pn,{to:`/wall/${d.id}`,className:`header-nav-btn ${l.pathname.startsWith("/wall")?"active":""}`,title:"My Wall",children:E.jsx(ac,{size:18})}),E.jsx(pn,{to:"/profile",title:"My Profile",children:E.jsx("div",{className:"header-avatar",children:d?.photoUrl?E.jsx("img",{src:d.photoUrl,alt:d.username||"Profile"}):E.jsx(rJ,{size:18,color:"#8E8E93"})})})]})]})}const Z$=[{path:"/nearby",label:"Nearby",icon:wu},{path:"/hangouts",label:"Hangouts",icon:ac},{path:"/prime",label:"Prime",icon:hf},{path:"/live",label:"Live",icon:Rf},{path:"/videorama",label:"Videorama",icon:IT}];function $$(){const d=JT();return E.jsx("nav",{className:"app-footer",children:Z$.map(({path:l,label:h,icon:f})=>E.jsxs(pn,{to:l,className:`footer-tab ${d.pathname===l?"active":""}`,children:[E.jsx(f,{size:22}),h]},l))})}const Fs=Object.create(null);Fs.open="0";Fs.close="1";Fs.ping="2";Fs.pong="3";Fs.message="4";Fs.upgrade="5";Fs.noop="6";const sf=Object.create(null);Object.keys(Fs).forEach(d=>{sf[Fs[d]]=d});const GT={type:"error",data:"parser error"},s2=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",o2=typeof ArrayBuffer=="function",a2=d=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(d):d&&d.buffer instanceof ArrayBuffer,Cv=({type:d,data:l},h,f)=>s2&&l instanceof Blob?h?f(l):_M(l,f):o2&&(l instanceof ArrayBuffer||a2(l))?h?f(l):_M(new Blob([l]),f):f(Fs[d]+(l||"")),_M=(d,l)=>{const h=new FileReader;return h.onload=function(){const f=h.result.split(",")[1];l("b"+(f||""))},h.readAsDataURL(d)};function gM(d){return d instanceof Uint8Array?d:d instanceof ArrayBuffer?new Uint8Array(d):new Uint8Array(d.buffer,d.byteOffset,d.byteLength)}let bT;function eee(d,l){if(s2&&d.data instanceof Blob)return d.data.arrayBuffer().then(gM).then(l);if(o2&&(d.data instanceof ArrayBuffer||a2(d.data)))return l(gM(d.data));Cv(d,!1,h=>{bT||(bT=new TextEncoder),l(bT.encode(h))})}const EM="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Iu=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let d=0;d<EM.length;d++)Iu[EM.charCodeAt(d)]=d;const tee=d=>{let l=d.length*.75,h=d.length,f,y=0,w,A,P,L;d[d.length-1]==="="&&(l--,d[d.length-2]==="="&&l--);const U=new ArrayBuffer(l),M=new Uint8Array(U);for(f=0;f<h;f+=4)w=Iu[d.charCodeAt(f)],A=Iu[d.charCodeAt(f+1)],P=Iu[d.charCodeAt(f+2)],L=Iu[d.charCodeAt(f+3)],M[y++]=w<<2|A>>4,M[y++]=(A&15)<<4|P>>2,M[y++]=(P&3)<<6|L&63;return U},nee=typeof ArrayBuffer=="function",bv=(d,l)=>{if(typeof d!="string")return{type:"message",data:c2(d,l)};const h=d.charAt(0);return h==="b"?{type:"message",data:iee(d.substring(1),l)}:sf[h]?d.length>1?{type:sf[h],data:d.substring(1)}:{type:sf[h]}:GT},iee=(d,l)=>{if(nee){const h=tee(d);return c2(h,l)}else return{base64:!0,data:d}},c2=(d,l)=>l==="blob"?d instanceof Blob?d:new Blob([d]):d instanceof ArrayBuffer?d:d.buffer,d2="",ree=(d,l)=>{const h=d.length,f=new Array(h);let y=0;d.forEach((w,A)=>{Cv(w,!1,P=>{f[A]=P,++y===h&&l(f.join(d2))})})},see=(d,l)=>{const h=d.split(d2),f=[];for(let y=0;y<h.length;y++){const w=bv(h[y],l);if(f.push(w),w.type==="error")break}return f};function oee(){return new TransformStream({transform(d,l){eee(d,h=>{const f=h.length;let y;if(f<126)y=new Uint8Array(1),new DataView(y.buffer).setUint8(0,f);else if(f<65536){y=new Uint8Array(3);const w=new DataView(y.buffer);w.setUint8(0,126),w.setUint16(1,f)}else{y=new Uint8Array(9);const w=new DataView(y.buffer);w.setUint8(0,127),w.setBigUint64(1,BigInt(f))}d.data&&typeof d.data!="string"&&(y[0]|=128),l.enqueue(y),l.enqueue(h)})}})}let wT;function Jm(d){return d.reduce((l,h)=>l+h.length,0)}function Qm(d,l){if(d[0].length===l)return d.shift();const h=new Uint8Array(l);let f=0;for(let y=0;y<l;y++)h[y]=d[0][f++],f===d[0].length&&(d.shift(),f=0);return d.length&&f<d[0].length&&(d[0]=d[0].slice(f)),h}function aee(d,l){wT||(wT=new TextDecoder);const h=[];let f=0,y=-1,w=!1;return new TransformStream({transform(A,P){for(h.push(A);;){if(f===0){if(Jm(h)<1)break;const L=Qm(h,1);w=(L[0]&128)===128,y=L[0]&127,y<126?f=3:y===126?f=1:f=2}else if(f===1){if(Jm(h)<2)break;const L=Qm(h,2);y=new DataView(L.buffer,L.byteOffset,L.length).getUint16(0),f=3}else if(f===2){if(Jm(h)<8)break;const L=Qm(h,8),U=new DataView(L.buffer,L.byteOffset,L.length),M=U.getUint32(0);if(M>Math.pow(2,21)-1){P.enqueue(GT);break}y=M*Math.pow(2,32)+U.getUint32(4),f=3}else{if(Jm(h)<y)break;const L=Qm(h,y);P.enqueue(bv(w?L:wT.decode(L),l)),f=0}if(y===0||y>d){P.enqueue(GT);break}}}})}const l2=4;function Xn(d){if(d)return cee(d)}function cee(d){for(var l in Xn.prototype)d[l]=Xn.prototype[l];return d}Xn.prototype.on=Xn.prototype.addEventListener=function(d,l){return this._callbacks=this._callbacks||{},(this._callbacks["$"+d]=this._callbacks["$"+d]||[]).push(l),this};Xn.prototype.once=function(d,l){function h(){this.off(d,h),l.apply(this,arguments)}return h.fn=l,this.on(d,h),this};Xn.prototype.off=Xn.prototype.removeListener=Xn.prototype.removeAllListeners=Xn.prototype.removeEventListener=function(d,l){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var h=this._callbacks["$"+d];if(!h)return this;if(arguments.length==1)return delete this._callbacks["$"+d],this;for(var f,y=0;y<h.length;y++)if(f=h[y],f===l||f.fn===l){h.splice(y,1);break}return h.length===0&&delete this._callbacks["$"+d],this};Xn.prototype.emit=function(d){this._callbacks=this._callbacks||{};for(var l=new Array(arguments.length-1),h=this._callbacks["$"+d],f=1;f<arguments.length;f++)l[f-1]=arguments[f];if(h){h=h.slice(0);for(var f=0,y=h.length;f<y;++f)h[f].apply(this,l)}return this};Xn.prototype.emitReserved=Xn.prototype.emit;Xn.prototype.listeners=function(d){return this._callbacks=this._callbacks||{},this._callbacks["$"+d]||[]};Xn.prototype.hasListeners=function(d){return!!this.listeners(d).length};const Mf=typeof Promise=="function"&&typeof Promise.resolve=="function"?l=>Promise.resolve().then(l):(l,h)=>h(l,0),Ur=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),dee="arraybuffer";function u2(d,...l){return l.reduce((h,f)=>(d.hasOwnProperty(f)&&(h[f]=d[f]),h),{})}const lee=Ur.setTimeout,uee=Ur.clearTimeout;function Uf(d,l){l.useNativeTimers?(d.setTimeoutFn=lee.bind(Ur),d.clearTimeoutFn=uee.bind(Ur)):(d.setTimeoutFn=Ur.setTimeout.bind(Ur),d.clearTimeoutFn=Ur.clearTimeout.bind(Ur))}const hee=1.33;function pee(d){return typeof d=="string"?mee(d):Math.ceil((d.byteLength||d.size)*hee)}function mee(d){let l=0,h=0;for(let f=0,y=d.length;f<y;f++)l=d.charCodeAt(f),l<128?h+=1:l<2048?h+=2:l<55296||l>=57344?h+=3:(f++,h+=4);return h}function h2(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function fee(d){let l="";for(let h in d)d.hasOwnProperty(h)&&(l.length&&(l+="&"),l+=encodeURIComponent(h)+"="+encodeURIComponent(d[h]));return l}function _ee(d){let l={},h=d.split("&");for(let f=0,y=h.length;f<y;f++){let w=h[f].split("=");l[decodeURIComponent(w[0])]=decodeURIComponent(w[1])}return l}class gee extends Error{constructor(l,h,f){super(l),this.description=h,this.context=f,this.type="TransportError"}}class wv extends Xn{constructor(l){super(),this.writable=!1,Uf(this,l),this.opts=l,this.query=l.query,this.socket=l.socket,this.supportsBinary=!l.forceBase64}onError(l,h,f){return super.emitReserved("error",new gee(l,h,f)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(l){this.readyState==="open"&&this.write(l)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(l){const h=bv(l,this.socket.binaryType);this.onPacket(h)}onPacket(l){super.emitReserved("packet",l)}onClose(l){this.readyState="closed",super.emitReserved("close",l)}pause(l){}createUri(l,h={}){return l+"://"+this._hostname()+this._port()+this.opts.path+this._query(h)}_hostname(){const l=this.opts.hostname;return l.indexOf(":")===-1?l:"["+l+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port)!==443||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(l){const h=fee(l);return h.length?"?"+h:""}}class Eee extends wv{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(l){this.readyState="pausing";const h=()=>{this.readyState="paused",l()};if(this._polling||!this.writable){let f=0;this._polling&&(f++,this.once("pollComplete",function(){--f||h()})),this.writable||(f++,this.once("drain",function(){--f||h()}))}else h()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(l){const h=f=>{if(this.readyState==="opening"&&f.type==="open"&&this.onOpen(),f.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(f)};see(l,this.socket.binaryType).forEach(h),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const l=()=>{this.write([{type:"close"}])};this.readyState==="open"?l():this.once("open",l)}write(l){this.writable=!1,ree(l,h=>{this.doWrite(h,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const l=this.opts.secure?"https":"http",h=this.query||{};return this.opts.timestampRequests!==!1&&(h[this.opts.timestampParam]=h2()),!this.supportsBinary&&!h.sid&&(h.b64=1),this.createUri(l,h)}}let p2=!1;try{p2=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const See=p2;function yee(){}class Tee extends Eee{constructor(l){if(super(l),typeof location<"u"){const h=location.protocol==="https:";let f=location.port;f||(f=h?"443":"80"),this.xd=typeof location<"u"&&l.hostname!==location.hostname||f!==l.port}}doWrite(l,h){const f=this.request({method:"POST",data:l});f.on("success",h),f.on("error",(y,w)=>{this.onError("xhr post error",y,w)})}doPoll(){const l=this.request();l.on("data",this.onData.bind(this)),l.on("error",(h,f)=>{this.onError("xhr poll error",h,f)}),this.pollXhr=l}}class js extends Xn{constructor(l,h,f){super(),this.createRequest=l,Uf(this,f),this._opts=f,this._method=f.method||"GET",this._uri=h,this._data=f.data!==void 0?f.data:null,this._create()}_create(){var l;const h=u2(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");h.xdomain=!!this._opts.xd;const f=this._xhr=this.createRequest(h);try{f.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){f.setDisableHeaderCheck&&f.setDisableHeaderCheck(!0);for(let y in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(y)&&f.setRequestHeader(y,this._opts.extraHeaders[y])}}catch{}if(this._method==="POST")try{f.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{f.setRequestHeader("Accept","*/*")}catch{}(l=this._opts.cookieJar)===null||l===void 0||l.addCookies(f),"withCredentials"in f&&(f.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(f.timeout=this._opts.requestTimeout),f.onreadystatechange=()=>{var y;f.readyState===3&&((y=this._opts.cookieJar)===null||y===void 0||y.parseCookies(f.getResponseHeader("set-cookie"))),f.readyState===4&&(f.status===200||f.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof f.status=="number"?f.status:0)},0))},f.send(this._data)}catch(y){this.setTimeoutFn(()=>{this._onError(y)},0);return}typeof document<"u"&&(this._index=js.requestsCount++,js.requests[this._index]=this)}_onError(l){this.emitReserved("error",l,this._xhr),this._cleanup(!0)}_cleanup(l){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=yee,l)try{this._xhr.abort()}catch{}typeof document<"u"&&delete js.requests[this._index],this._xhr=null}}_onLoad(){const l=this._xhr.responseText;l!==null&&(this.emitReserved("data",l),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}js.requestsCount=0;js.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",SM);else if(typeof addEventListener=="function"){const d="onpagehide"in Ur?"pagehide":"unload";addEventListener(d,SM,!1)}}function SM(){for(let d in js.requests)js.requests.hasOwnProperty(d)&&js.requests[d].abort()}const vee=(function(){const d=m2({xdomain:!1});return d&&d.responseType!==null})();class Ree extends Tee{constructor(l){super(l);const h=l&&l.forceBase64;this.supportsBinary=vee&&!h}request(l={}){return Object.assign(l,{xd:this.xd},this.opts),new js(m2,this.uri(),l)}}function m2(d){const l=d.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!l||See))return new XMLHttpRequest}catch{}if(!l)try{return new Ur[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const f2=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class Cee extends wv{get name(){return"websocket"}doOpen(){const l=this.uri(),h=this.opts.protocols,f=f2?{}:u2(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(f.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(l,h,f)}catch(y){return this.emitReserved("error",y)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=l=>this.onClose({description:"websocket connection closed",context:l}),this.ws.onmessage=l=>this.onData(l.data),this.ws.onerror=l=>this.onError("websocket error",l)}write(l){this.writable=!1;for(let h=0;h<l.length;h++){const f=l[h],y=h===l.length-1;Cv(f,this.supportsBinary,w=>{try{this.doWrite(f,w)}catch{}y&&Mf(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const l=this.opts.secure?"wss":"ws",h=this.query||{};return this.opts.timestampRequests&&(h[this.opts.timestampParam]=h2()),this.supportsBinary||(h.b64=1),this.createUri(l,h)}}const AT=Ur.WebSocket||Ur.MozWebSocket;class bee extends Cee{createSocket(l,h,f){return f2?new AT(l,h,f):h?new AT(l,h):new AT(l)}doWrite(l,h){this.ws.send(h)}}class wee extends wv{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(l){return this.emitReserved("error",l)}this._transport.closed.then(()=>{this.onClose()}).catch(l=>{this.onError("webtransport error",l)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(l=>{const h=aee(Number.MAX_SAFE_INTEGER,this.socket.binaryType),f=l.readable.pipeThrough(h).getReader(),y=oee();y.readable.pipeTo(l.writable),this._writer=y.writable.getWriter();const w=()=>{f.read().then(({done:P,value:L})=>{P||(this.onPacket(L),w())}).catch(P=>{})};w();const A={type:"open"};this.query.sid&&(A.data=`{"sid":"${this.query.sid}"}`),this._writer.write(A).then(()=>this.onOpen())})})}write(l){this.writable=!1;for(let h=0;h<l.length;h++){const f=l[h],y=h===l.length-1;this._writer.write(f).then(()=>{y&&Mf(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var l;(l=this._transport)===null||l===void 0||l.close()}}const Aee={websocket:bee,webtransport:wee,polling:Ree},Iee=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Oee=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function HT(d){if(d.length>8e3)throw"URI too long";const l=d,h=d.indexOf("["),f=d.indexOf("]");h!=-1&&f!=-1&&(d=d.substring(0,h)+d.substring(h,f).replace(/:/g,";")+d.substring(f,d.length));let y=Iee.exec(d||""),w={},A=14;for(;A--;)w[Oee[A]]=y[A]||"";return h!=-1&&f!=-1&&(w.source=l,w.host=w.host.substring(1,w.host.length-1).replace(/;/g,":"),w.authority=w.authority.replace("[","").replace("]","").replace(/;/g,":"),w.ipv6uri=!0),w.pathNames=Nee(w,w.path),w.queryKey=Dee(w,w.query),w}function Nee(d,l){const h=/\/{2,9}/g,f=l.replace(h,"/").split("/");return(l.slice(0,1)=="/"||l.length===0)&&f.splice(0,1),l.slice(-1)=="/"&&f.splice(f.length-1,1),f}function Dee(d,l){const h={};return l.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(f,y,w){y&&(h[y]=w)}),h}const KT=typeof addEventListener=="function"&&typeof removeEventListener=="function",of=[];KT&&addEventListener("offline",()=>{of.forEach(d=>d())},!1);class Qo extends Xn{constructor(l,h){if(super(),this.binaryType=dee,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,l&&typeof l=="object"&&(h=l,l=null),l){const f=HT(l);h.hostname=f.host,h.secure=f.protocol==="https"||f.protocol==="wss",h.port=f.port,f.query&&(h.query=f.query)}else h.host&&(h.hostname=HT(h.host).host);Uf(this,h),this.secure=h.secure!=null?h.secure:typeof location<"u"&&location.protocol==="https:",h.hostname&&!h.port&&(h.port=this.secure?"443":"80"),this.hostname=h.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=h.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},h.transports.forEach(f=>{const y=f.prototype.name;this.transports.push(y),this._transportsByName[y]=f}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},h),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=_ee(this.opts.query)),KT&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},of.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(l){const h=Object.assign({},this.opts.query);h.EIO=l2,h.transport=l,this.id&&(h.sid=this.id);const f=Object.assign({},this.opts,{query:h,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[l]);return new this._transportsByName[l](f)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const l=this.opts.rememberUpgrade&&Qo.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const h=this.createTransport(l);h.open(),this.setTransport(h)}setTransport(l){this.transport&&this.transport.removeAllListeners(),this.transport=l,l.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",h=>this._onClose("transport close",h))}onOpen(){this.readyState="open",Qo.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(l){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",l),this.emitReserved("heartbeat"),l.type){case"open":this.onHandshake(JSON.parse(l.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const h=new Error("server error");h.code=l.data,this._onError(h);break;case"message":this.emitReserved("data",l.data),this.emitReserved("message",l.data);break}}onHandshake(l){this.emitReserved("handshake",l),this.id=l.sid,this.transport.query.sid=l.sid,this._pingInterval=l.pingInterval,this._pingTimeout=l.pingTimeout,this._maxPayload=l.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const l=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+l,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},l),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const l=this._getWritablePackets();this.transport.send(l),this._prevBufferLen=l.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let h=1;for(let f=0;f<this.writeBuffer.length;f++){const y=this.writeBuffer[f].data;if(y&&(h+=pee(y)),f>0&&h>this._maxPayload)return this.writeBuffer.slice(0,f);h+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const l=Date.now()>this._pingTimeoutTime;return l&&(this._pingTimeoutTime=0,Mf(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),l}write(l,h,f){return this._sendPacket("message",l,h,f),this}send(l,h,f){return this._sendPacket("message",l,h,f),this}_sendPacket(l,h,f,y){if(typeof h=="function"&&(y=h,h=void 0),typeof f=="function"&&(y=f,f=null),this.readyState==="closing"||this.readyState==="closed")return;f=f||{},f.compress=f.compress!==!1;const w={type:l,data:h,options:f};this.emitReserved("packetCreate",w),this.writeBuffer.push(w),y&&this.once("flush",y),this.flush()}close(){const l=()=>{this._onClose("forced close"),this.transport.close()},h=()=>{this.off("upgrade",h),this.off("upgradeError",h),l()},f=()=>{this.once("upgrade",h),this.once("upgradeError",h)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?f():l()}):this.upgrading?f():l()),this}_onError(l){if(Qo.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",l),this._onClose("transport error",l)}_onClose(l,h){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),KT&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const f=of.indexOf(this._offlineEventListener);f!==-1&&of.splice(f,1)}this.readyState="closed",this.id=null,this.emitReserved("close",l,h),this.writeBuffer=[],this._prevBufferLen=0}}}Qo.protocol=l2;class Pee extends Qo{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let l=0;l<this._upgrades.length;l++)this._probe(this._upgrades[l])}_probe(l){let h=this.createTransport(l),f=!1;Qo.priorWebsocketSuccess=!1;const y=()=>{f||(h.send([{type:"ping",data:"probe"}]),h.once("packet",V=>{if(!f)if(V.type==="pong"&&V.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",h),!h)return;Qo.priorWebsocketSuccess=h.name==="websocket",this.transport.pause(()=>{f||this.readyState!=="closed"&&(M(),this.setTransport(h),h.send([{type:"upgrade"}]),this.emitReserved("upgrade",h),h=null,this.upgrading=!1,this.flush())})}else{const W=new Error("probe error");W.transport=h.name,this.emitReserved("upgradeError",W)}}))};function w(){f||(f=!0,M(),h.close(),h=null)}const A=V=>{const W=new Error("probe error: "+V);W.transport=h.name,w(),this.emitReserved("upgradeError",W)};function P(){A("transport closed")}function L(){A("socket closed")}function U(V){h&&V.name!==h.name&&w()}const M=()=>{h.removeListener("open",y),h.removeListener("error",A),h.removeListener("close",P),this.off("close",L),this.off("upgrading",U)};h.once("open",y),h.once("error",A),h.once("close",P),this.once("close",L),this.once("upgrading",U),this._upgrades.indexOf("webtransport")!==-1&&l!=="webtransport"?this.setTimeoutFn(()=>{f||h.open()},200):h.open()}onHandshake(l){this._upgrades=this._filterUpgrades(l.upgrades),super.onHandshake(l)}_filterUpgrades(l){const h=[];for(let f=0;f<l.length;f++)~this.transports.indexOf(l[f])&&h.push(l[f]);return h}}let Lee=class extends Pee{constructor(l,h={}){const f=typeof l=="object"?l:h;(!f.transports||f.transports&&typeof f.transports[0]=="string")&&(f.transports=(f.transports||["polling","websocket","webtransport"]).map(y=>Aee[y]).filter(y=>!!y)),super(l,f)}};function kee(d,l="",h){let f=d;h=h||typeof location<"u"&&location,d==null&&(d=h.protocol+"//"+h.host),typeof d=="string"&&(d.charAt(0)==="/"&&(d.charAt(1)==="/"?d=h.protocol+d:d=h.host+d),/^(https?|wss?):\/\//.test(d)||(typeof h<"u"?d=h.protocol+"//"+d:d="https://"+d),f=HT(d)),f.port||(/^(http|ws)$/.test(f.protocol)?f.port="80":/^(http|ws)s$/.test(f.protocol)&&(f.port="443")),f.path=f.path||"/";const w=f.host.indexOf(":")!==-1?"["+f.host+"]":f.host;return f.id=f.protocol+"://"+w+":"+f.port+l,f.href=f.protocol+"://"+w+(h&&h.port===f.port?"":":"+f.port),f}const xee=typeof ArrayBuffer=="function",Mee=d=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(d):d.buffer instanceof ArrayBuffer,_2=Object.prototype.toString,Uee=typeof Blob=="function"||typeof Blob<"u"&&_2.call(Blob)==="[object BlobConstructor]",Vee=typeof File=="function"||typeof File<"u"&&_2.call(File)==="[object FileConstructor]";function Av(d){return xee&&(d instanceof ArrayBuffer||Mee(d))||Uee&&d instanceof Blob||Vee&&d instanceof File}function af(d,l){if(!d||typeof d!="object")return!1;if(Array.isArray(d)){for(let h=0,f=d.length;h<f;h++)if(af(d[h]))return!0;return!1}if(Av(d))return!0;if(d.toJSON&&typeof d.toJSON=="function"&&arguments.length===1)return af(d.toJSON(),!0);for(const h in d)if(Object.prototype.hasOwnProperty.call(d,h)&&af(d[h]))return!0;return!1}function jee(d){const l=[],h=d.data,f=d;return f.data=YT(h,l),f.attachments=l.length,{packet:f,buffers:l}}function YT(d,l){if(!d)return d;if(Av(d)){const h={_placeholder:!0,num:l.length};return l.push(d),h}else if(Array.isArray(d)){const h=new Array(d.length);for(let f=0;f<d.length;f++)h[f]=YT(d[f],l);return h}else if(typeof d=="object"&&!(d instanceof Date)){const h={};for(const f in d)Object.prototype.hasOwnProperty.call(d,f)&&(h[f]=YT(d[f],l));return h}return d}function Fee(d,l){return d.data=zT(d.data,l),delete d.attachments,d}function zT(d,l){if(!d)return d;if(d&&d._placeholder===!0){if(typeof d.num=="number"&&d.num>=0&&d.num<l.length)return l[d.num];throw new Error("illegal attachments")}else if(Array.isArray(d))for(let h=0;h<d.length;h++)d[h]=zT(d[h],l);else if(typeof d=="object")for(const h in d)Object.prototype.hasOwnProperty.call(d,h)&&(d[h]=zT(d[h],l));return d}const Bee=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var Ft;(function(d){d[d.CONNECT=0]="CONNECT",d[d.DISCONNECT=1]="DISCONNECT",d[d.EVENT=2]="EVENT",d[d.ACK=3]="ACK",d[d.CONNECT_ERROR=4]="CONNECT_ERROR",d[d.BINARY_EVENT=5]="BINARY_EVENT",d[d.BINARY_ACK=6]="BINARY_ACK"})(Ft||(Ft={}));class Wee{constructor(l){this.replacer=l}encode(l){return(l.type===Ft.EVENT||l.type===Ft.ACK)&&af(l)?this.encodeAsBinary({type:l.type===Ft.EVENT?Ft.BINARY_EVENT:Ft.BINARY_ACK,nsp:l.nsp,data:l.data,id:l.id}):[this.encodeAsString(l)]}encodeAsString(l){let h=""+l.type;return(l.type===Ft.BINARY_EVENT||l.type===Ft.BINARY_ACK)&&(h+=l.attachments+"-"),l.nsp&&l.nsp!=="/"&&(h+=l.nsp+","),l.id!=null&&(h+=l.id),l.data!=null&&(h+=JSON.stringify(l.data,this.replacer)),h}encodeAsBinary(l){const h=jee(l),f=this.encodeAsString(h.packet),y=h.buffers;return y.unshift(f),y}}class Iv extends Xn{constructor(l){super(),this.reviver=l}add(l){let h;if(typeof l=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");h=this.decodeString(l);const f=h.type===Ft.BINARY_EVENT;f||h.type===Ft.BINARY_ACK?(h.type=f?Ft.EVENT:Ft.ACK,this.reconstructor=new Gee(h),h.attachments===0&&super.emitReserved("decoded",h)):super.emitReserved("decoded",h)}else if(Av(l)||l.base64)if(this.reconstructor)h=this.reconstructor.takeBinaryData(l),h&&(this.reconstructor=null,super.emitReserved("decoded",h));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+l)}decodeString(l){let h=0;const f={type:Number(l.charAt(0))};if(Ft[f.type]===void 0)throw new Error("unknown packet type "+f.type);if(f.type===Ft.BINARY_EVENT||f.type===Ft.BINARY_ACK){const w=h+1;for(;l.charAt(++h)!=="-"&&h!=l.length;);const A=l.substring(w,h);if(A!=Number(A)||l.charAt(h)!=="-")throw new Error("Illegal attachments");f.attachments=Number(A)}if(l.charAt(h+1)==="/"){const w=h+1;for(;++h&&!(l.charAt(h)===","||h===l.length););f.nsp=l.substring(w,h)}else f.nsp="/";const y=l.charAt(h+1);if(y!==""&&Number(y)==y){const w=h+1;for(;++h;){const A=l.charAt(h);if(A==null||Number(A)!=A){--h;break}if(h===l.length)break}f.id=Number(l.substring(w,h+1))}if(l.charAt(++h)){const w=this.tryParse(l.substr(h));if(Iv.isPayloadValid(f.type,w))f.data=w;else throw new Error("invalid payload")}return f}tryParse(l){try{return JSON.parse(l,this.reviver)}catch{return!1}}static isPayloadValid(l,h){switch(l){case Ft.CONNECT:return yM(h);case Ft.DISCONNECT:return h===void 0;case Ft.CONNECT_ERROR:return typeof h=="string"||yM(h);case Ft.EVENT:case Ft.BINARY_EVENT:return Array.isArray(h)&&(typeof h[0]=="number"||typeof h[0]=="string"&&Bee.indexOf(h[0])===-1);case Ft.ACK:case Ft.BINARY_ACK:return Array.isArray(h)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Gee{constructor(l){this.packet=l,this.buffers=[],this.reconPack=l}takeBinaryData(l){if(this.buffers.push(l),this.buffers.length===this.reconPack.attachments){const h=Fee(this.reconPack,this.buffers);return this.finishedReconstruction(),h}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function yM(d){return Object.prototype.toString.call(d)==="[object Object]"}const Hee=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Iv,Encoder:Wee,get PacketType(){return Ft}},Symbol.toStringTag,{value:"Module"}));function ls(d,l,h){return d.on(l,h),function(){d.off(l,h)}}const Kee=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class g2 extends Xn{constructor(l,h,f){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=l,this.nsp=h,f&&f.auth&&(this.auth=f.auth),this._opts=Object.assign({},f),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const l=this.io;this.subs=[ls(l,"open",this.onopen.bind(this)),ls(l,"packet",this.onpacket.bind(this)),ls(l,"error",this.onerror.bind(this)),ls(l,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...l){return l.unshift("message"),this.emit.apply(this,l),this}emit(l,...h){var f,y,w;if(Kee.hasOwnProperty(l))throw new Error('"'+l.toString()+'" is a reserved event name');if(h.unshift(l),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(h),this;const A={type:Ft.EVENT,data:h};if(A.options={},A.options.compress=this.flags.compress!==!1,typeof h[h.length-1]=="function"){const M=this.ids++,V=h.pop();this._registerAckCallback(M,V),A.id=M}const P=(y=(f=this.io.engine)===null||f===void 0?void 0:f.transport)===null||y===void 0?void 0:y.writable,L=this.connected&&!(!((w=this.io.engine)===null||w===void 0)&&w._hasPingExpired());return this.flags.volatile&&!P||(L?(this.notifyOutgoingListeners(A),this.packet(A)):this.sendBuffer.push(A)),this.flags={},this}_registerAckCallback(l,h){var f;const y=(f=this.flags.timeout)!==null&&f!==void 0?f:this._opts.ackTimeout;if(y===void 0){this.acks[l]=h;return}const w=this.io.setTimeoutFn(()=>{delete this.acks[l];for(let P=0;P<this.sendBuffer.length;P++)this.sendBuffer[P].id===l&&this.sendBuffer.splice(P,1);h.call(this,new Error("operation has timed out"))},y),A=(...P)=>{this.io.clearTimeoutFn(w),h.apply(this,P)};A.withError=!0,this.acks[l]=A}emitWithAck(l,...h){return new Promise((f,y)=>{const w=(A,P)=>A?y(A):f(P);w.withError=!0,h.push(w),this.emit(l,...h)})}_addToQueue(l){let h;typeof l[l.length-1]=="function"&&(h=l.pop());const f={id:this._queueSeq++,tryCount:0,pending:!1,args:l,flags:Object.assign({fromQueue:!0},this.flags)};l.push((y,...w)=>(this._queue[0],y!==null?f.tryCount>this._opts.retries&&(this._queue.shift(),h&&h(y)):(this._queue.shift(),h&&h(null,...w)),f.pending=!1,this._drainQueue())),this._queue.push(f),this._drainQueue()}_drainQueue(l=!1){if(!this.connected||this._queue.length===0)return;const h=this._queue[0];h.pending&&!l||(h.pending=!0,h.tryCount++,this.flags=h.flags,this.emit.apply(this,h.args))}packet(l){l.nsp=this.nsp,this.io._packet(l)}onopen(){typeof this.auth=="function"?this.auth(l=>{this._sendConnectPacket(l)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(l){this.packet({type:Ft.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},l):l})}onerror(l){this.connected||this.emitReserved("connect_error",l)}onclose(l,h){this.connected=!1,delete this.id,this.emitReserved("disconnect",l,h),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(l=>{if(!this.sendBuffer.some(f=>String(f.id)===l)){const f=this.acks[l];delete this.acks[l],f.withError&&f.call(this,new Error("socket has been disconnected"))}})}onpacket(l){if(l.nsp===this.nsp)switch(l.type){case Ft.CONNECT:l.data&&l.data.sid?this.onconnect(l.data.sid,l.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case Ft.EVENT:case Ft.BINARY_EVENT:this.onevent(l);break;case Ft.ACK:case Ft.BINARY_ACK:this.onack(l);break;case Ft.DISCONNECT:this.ondisconnect();break;case Ft.CONNECT_ERROR:this.destroy();const f=new Error(l.data.message);f.data=l.data.data,this.emitReserved("connect_error",f);break}}onevent(l){const h=l.data||[];l.id!=null&&h.push(this.ack(l.id)),this.connected?this.emitEvent(h):this.receiveBuffer.push(Object.freeze(h))}emitEvent(l){if(this._anyListeners&&this._anyListeners.length){const h=this._anyListeners.slice();for(const f of h)f.apply(this,l)}super.emit.apply(this,l),this._pid&&l.length&&typeof l[l.length-1]=="string"&&(this._lastOffset=l[l.length-1])}ack(l){const h=this;let f=!1;return function(...y){f||(f=!0,h.packet({type:Ft.ACK,id:l,data:y}))}}onack(l){const h=this.acks[l.id];typeof h=="function"&&(delete this.acks[l.id],h.withError&&l.data.unshift(null),h.apply(this,l.data))}onconnect(l,h){this.id=l,this.recovered=h&&this._pid===h,this._pid=h,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(l=>this.emitEvent(l)),this.receiveBuffer=[],this.sendBuffer.forEach(l=>{this.notifyOutgoingListeners(l),this.packet(l)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(l=>l()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:Ft.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(l){return this.flags.compress=l,this}get volatile(){return this.flags.volatile=!0,this}timeout(l){return this.flags.timeout=l,this}onAny(l){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(l),this}prependAny(l){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(l),this}offAny(l){if(!this._anyListeners)return this;if(l){const h=this._anyListeners;for(let f=0;f<h.length;f++)if(l===h[f])return h.splice(f,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(l){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(l),this}prependAnyOutgoing(l){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(l),this}offAnyOutgoing(l){if(!this._anyOutgoingListeners)return this;if(l){const h=this._anyOutgoingListeners;for(let f=0;f<h.length;f++)if(l===h[f])return h.splice(f,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(l){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const h=this._anyOutgoingListeners.slice();for(const f of h)f.apply(this,l.data)}}}function Yd(d){d=d||{},this.ms=d.min||100,this.max=d.max||1e4,this.factor=d.factor||2,this.jitter=d.jitter>0&&d.jitter<=1?d.jitter:0,this.attempts=0}Yd.prototype.duration=function(){var d=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var l=Math.random(),h=Math.floor(l*this.jitter*d);d=(Math.floor(l*10)&1)==0?d-h:d+h}return Math.min(d,this.max)|0};Yd.prototype.reset=function(){this.attempts=0};Yd.prototype.setMin=function(d){this.ms=d};Yd.prototype.setMax=function(d){this.max=d};Yd.prototype.setJitter=function(d){this.jitter=d};class qT extends Xn{constructor(l,h){var f;super(),this.nsps={},this.subs=[],l&&typeof l=="object"&&(h=l,l=void 0),h=h||{},h.path=h.path||"/socket.io",this.opts=h,Uf(this,h),this.reconnection(h.reconnection!==!1),this.reconnectionAttempts(h.reconnectionAttempts||1/0),this.reconnectionDelay(h.reconnectionDelay||1e3),this.reconnectionDelayMax(h.reconnectionDelayMax||5e3),this.randomizationFactor((f=h.randomizationFactor)!==null&&f!==void 0?f:.5),this.backoff=new Yd({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(h.timeout==null?2e4:h.timeout),this._readyState="closed",this.uri=l;const y=h.parser||Hee;this.encoder=new y.Encoder,this.decoder=new y.Decoder,this._autoConnect=h.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(l){return arguments.length?(this._reconnection=!!l,l||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(l){return l===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=l,this)}reconnectionDelay(l){var h;return l===void 0?this._reconnectionDelay:(this._reconnectionDelay=l,(h=this.backoff)===null||h===void 0||h.setMin(l),this)}randomizationFactor(l){var h;return l===void 0?this._randomizationFactor:(this._randomizationFactor=l,(h=this.backoff)===null||h===void 0||h.setJitter(l),this)}reconnectionDelayMax(l){var h;return l===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=l,(h=this.backoff)===null||h===void 0||h.setMax(l),this)}timeout(l){return arguments.length?(this._timeout=l,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(l){if(~this._readyState.indexOf("open"))return this;this.engine=new Lee(this.uri,this.opts);const h=this.engine,f=this;this._readyState="opening",this.skipReconnect=!1;const y=ls(h,"open",function(){f.onopen(),l&&l()}),w=P=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",P),l?l(P):this.maybeReconnectOnOpen()},A=ls(h,"error",w);if(this._timeout!==!1){const P=this._timeout,L=this.setTimeoutFn(()=>{y(),w(new Error("timeout")),h.close()},P);this.opts.autoUnref&&L.unref(),this.subs.push(()=>{this.clearTimeoutFn(L)})}return this.subs.push(y),this.subs.push(A),this}connect(l){return this.open(l)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const l=this.engine;this.subs.push(ls(l,"ping",this.onping.bind(this)),ls(l,"data",this.ondata.bind(this)),ls(l,"error",this.onerror.bind(this)),ls(l,"close",this.onclose.bind(this)),ls(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(l){try{this.decoder.add(l)}catch(h){this.onclose("parse error",h)}}ondecoded(l){Mf(()=>{this.emitReserved("packet",l)},this.setTimeoutFn)}onerror(l){this.emitReserved("error",l)}socket(l,h){let f=this.nsps[l];return f?this._autoConnect&&!f.active&&f.connect():(f=new g2(this,l,h),this.nsps[l]=f),f}_destroy(l){const h=Object.keys(this.nsps);for(const f of h)if(this.nsps[f].active)return;this._close()}_packet(l){const h=this.encoder.encode(l);for(let f=0;f<h.length;f++)this.engine.write(h[f],l.options)}cleanup(){this.subs.forEach(l=>l()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(l,h){var f;this.cleanup(),(f=this.engine)===null||f===void 0||f.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",l,h),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const l=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const h=this.backoff.duration();this._reconnecting=!0;const f=this.setTimeoutFn(()=>{l.skipReconnect||(this.emitReserved("reconnect_attempt",l.backoff.attempts),!l.skipReconnect&&l.open(y=>{y?(l._reconnecting=!1,l.reconnect(),this.emitReserved("reconnect_error",y)):l.onreconnect()}))},h);this.opts.autoUnref&&f.unref(),this.subs.push(()=>{this.clearTimeoutFn(f)})}}onreconnect(){const l=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",l)}}const Cu={};function cf(d,l){typeof d=="object"&&(l=d,d=void 0),l=l||{};const h=kee(d,l.path||"/socket.io"),f=h.source,y=h.id,w=h.path,A=Cu[y]&&w in Cu[y].nsps,P=l.forceNew||l["force new connection"]||l.multiplex===!1||A;let L;return P?L=new qT(f,l):(Cu[y]||(Cu[y]=new qT(f,l)),L=Cu[y]),h.query&&!l.query&&(l.query=h.queryKey),L.socket(h.path,l)}Object.assign(cf,{Manager:qT,Socket:g2,io:cf,connect:cf});let Wd=null,df=0;function E2(){return Wd||(Wd=cf(window.location.origin,{path:"/socket.io",transports:["websocket","polling"],withCredentials:!0})),df++,Wd}function S2(){df--,df<=0&&Wd&&(Wd.disconnect(),Wd=null,df=0)}function Yee(d="general"){const[l,h]=K.useState([]),[f,y]=K.useState(!1),[w,A]=K.useState(null),P=K.useRef(null);K.useEffect(()=>{const M=E2();P.current=M;const V=()=>{y(!0),M.emit("chat:join",{room:d})},W=()=>y(!1),z=oe=>{Array.isArray(oe)?h(oe):(console.warn("chat:history received non-array:",oe),h([]))},X=oe=>{oe&&oe.id&&oe.content!==void 0&&h(ve=>[...ve,oe])},$=oe=>A(oe?.message||"Chat error");return M.on("connect",V),M.on("disconnect",W),M.on("chat:history",z),M.on("chat:message",X),M.on("chat:error",$),M.connected&&(y(!0),M.emit("chat:join",{room:d})),()=>{M.off("connect",V),M.off("disconnect",W),M.off("chat:history",z),M.off("chat:message",X),M.off("chat:error",$),S2()}},[d]);const L=K.useCallback(M=>{P.current&&M.trim()&&P.current.emit("chat:message",{room:d,content:M})},[d]),U=K.useCallback(M=>{h(V=>[...V,M])},[]);return{messages:l,connected:f,error:w,sendMessage:L,pushMessage:U}}function zee(d){const l=K.useRef(null),[h,f]=K.useState(!1);K.useEffect(()=>{const A=E2();l.current=A;const P=()=>f(!0),L=()=>f(!1),U=M=>d&&d(M);return A.on("connect",P),A.on("disconnect",L),A.on("dm:received",U),A.connected&&f(!0),()=>{A.off("connect",P),A.off("disconnect",L),A.off("dm:received",U),S2()}},[]);const y=K.useCallback((A,P)=>{l.current&&l.current.emit("dm:send",{recipientId:A,content:P})},[]),w=K.useCallback(A=>{l.current&&l.current.emit("dm:typing",{recipientId:A})},[]);return{sendDM:y,sendTyping:w,connected:h}}function qee(d){const l=Date.now()-new Date(d).getTime(),h=Math.floor(l/6e4);if(h<1)return"now";if(h<60)return`${h}m`;const f=Math.floor(h/60);return f<24?`${f}h`:`${Math.floor(f/24)}d`}function Xee(){const[d,l]=K.useState(!1),[h,f]=K.useState(""),{user:y}=hr(),{messages:w,connected:A,sendMessage:P,pushMessage:L}=Yee("general"),U=K.useRef(null),M=K.useRef(null),V=K.useRef(!1);K.useEffect(()=>{d&&!A&&!V.current&&w.length===0&&(V.current=!0,We.getChatHistory("general").then(X=>{X.success&&Array.isArray(X.messages)&&X.messages.forEach($=>L($))}).catch(X=>{console.warn("Failed to load chat history:",X)}))},[d,A,w.length]),K.useEffect(()=>{d&&U.current&&U.current.scrollIntoView({behavior:"smooth"})},[w,d]),K.useEffect(()=>{d&&M.current&&M.current.focus()},[d]);const W=async()=>{const X=h.trim();if(!(!X||!y))if(f(""),A)P(X);else try{const $=await We.sendChatRest("general",X);$.message&&L($.message)}catch{}},z=X=>{X.key==="Enter"&&!X.shiftKey&&(X.preventDefault(),W())};return y?E.jsxs(E.Fragment,{children:[E.jsxs("button",{onClick:()=>l(X=>!X),className:"chat-widget-fab",title:"Community Chat","aria-label":"Open community chat",children:[d?E.jsx(Cf,{size:22}):E.jsx(vf,{size:22}),!d&&w.length>0&&E.jsx("span",{className:"chat-widget-badge"})]}),d&&E.jsxs("div",{className:"chat-widget-panel",children:[E.jsxs("div",{className:"chat-widget-header",children:[E.jsx("span",{children:"Community Chat"}),E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8},children:[E.jsx("span",{className:`chat-status-dot ${A?"connected":"disconnected"}`}),E.jsx("button",{onClick:()=>l(!1),className:"chat-close-btn",children:E.jsx(sJ,{size:18})})]})]}),E.jsxs("div",{className:"chat-messages-list",children:[w.length===0&&E.jsx("div",{style:{textAlign:"center",color:"var(--text-muted)",fontSize:13,padding:"20px 0"},children:"No messages yet. Say hi!"}),w.map(X=>E.jsxs("div",{className:`chat-message ${X.user_id===y.id?"own":""}`,children:[X.user_id!==y.id&&E.jsx("div",{className:"chat-message-author",children:X.first_name||X.username}),E.jsx("div",{className:"chat-bubble",children:X.content}),E.jsx("div",{className:"chat-message-time",children:qee(X.created_at)})]},X.id)),E.jsx("div",{ref:U})]}),E.jsxs("div",{className:"chat-input-row",children:[E.jsx("input",{ref:M,type:"text",value:h,onChange:X=>f(X.target.value),onKeyDown:z,placeholder:"Message...",maxLength:2e3,className:"chat-input"}),E.jsx("button",{onClick:W,disabled:!h.trim(),className:"chat-send-btn",children:E.jsx(ZT,{size:16})})]})]})]}):null}function Gn({children:d}){return E.jsxs("div",{className:"app-layout",children:[E.jsx(Q$,{}),E.jsx("main",{className:"app-main",children:d}),E.jsx($$,{}),E.jsx(Xee,{})]})}function Ov(){const[d,l]=K.useState([]),h=K.useCallback((w,A="info",P=5e3)=>{const L=Date.now().toString();return l(U=>[...U,{id:L,message:w,type:A,duration:P}]),L},[]),f=K.useCallback(w=>{l(A=>A.filter(P=>P.id!==w))},[]),y=K.useCallback(()=>{l([])},[]);return{toasts:d,showToast:h,closeToast:f,clearToasts:y}}function Jee(d){const l=Date.now()-new Date(d).getTime(),h=Math.floor(l/6e4);if(h<1)return"now";if(h<60)return`${h}m`;const f=Math.floor(h/60);return f<24?`${f}h`:`${Math.floor(f/24)}d`}function Nv({post:d,onDeleted:l,onError:h}){const{user:f}=hr(),{showToast:y}=Ov(),[w,A]=K.useState(d.liked_by_me),[P,L]=K.useState(d.likes_count||0),[U,M]=K.useState(!1),[V,W]=K.useState([]),[z,X]=K.useState(!1),[$,oe]=K.useState(""),[ve,Re]=K.useState(!1),pe=async()=>{const Q=w,je=P;try{A(!Q),L(et=>Q?Math.max(0,et-1):et+1);const Tt=await We.toggleLike(d.id);A(Tt.liked),L(et=>Tt.liked?je+1:Math.max(0,je-1))}catch(Tt){A(Q),L(je),console.error("Error toggling like:",Tt),y("Error al procesar el like","error"),h?.()}},fe=async()=>{if(confirm("Eliminar este post?"))try{await We.deletePost(d.id),y("Post eliminado exitosamente","success"),l&&l(d.id)}catch(Q){console.error("Error deleting post:",Q),y("Error al eliminar el post","error"),h?.()}},Be=async()=>{if(U){M(!1);return}try{const Q=await We.getReplies(d.id);W(Q.replies||[]),M(!0)}catch(Q){console.error("Error loading replies:",Q),y("Error al cargar las respuestas","error"),h?.()}},Ne=async()=>{if($.trim())try{await We.createPost({content:$,replyToId:d.id}),oe(""),X(!1);const Q=await We.getReplies(d.id);W(Q.replies||[]),M(!0),y("Respuesta agregada","success")}catch(Q){console.error("Error submitting reply:",Q),y("Error al enviar la respuesta","error"),h?.()}},Ee=(Q,je)=>(Q||je||"?")[0].toUpperCase();return E.jsxs("div",{className:"post-card",children:[E.jsxs("div",{className:"post-header",children:[E.jsx("div",{className:"post-avatar",children:d.author_photo_url&&!ve?E.jsx("img",{src:d.author_photo_url,alt:d.author_first_name||d.author_username,className:"post-avatar-img",loading:"lazy",onError:()=>Re(!0)}):E.jsx("div",{className:"post-avatar-placeholder",children:Ee(d.author_first_name,d.author_username)})}),E.jsxs("div",{style:{flex:1},children:[E.jsx(pn,{to:`/wall/${d.author_id}`,className:"post-author-name",children:d.author_first_name||d.author_username}),d.author_username&&E.jsxs("span",{className:"post-author-handle",children:["@",d.author_username]}),E.jsx("div",{className:"post-time",children:Jee(d.created_at)})]}),d.author_id===f?.id&&E.jsx("button",{onClick:fe,className:"post-delete-btn",title:"Delete",children:E.jsx(bf,{size:14})})]}),d.repost_content&&E.jsxs("div",{className:"post-repost-preview",children:[E.jsx(oJ,{size:12,style:{opacity:.6}}),E.jsxs("span",{children:[d.repost_author_first_name||d.repost_author_username,": ",d.repost_content.slice(0,100)]})]}),E.jsx("div",{className:"post-content",children:d.content}),d.media_url&&d.media_type==="image"&&E.jsx("img",{src:d.media_url,alt:"",className:"post-media"}),d.media_url&&d.media_type==="video"&&E.jsx("video",{src:d.media_url,controls:!0,className:"post-media",style:{maxHeight:400}}),E.jsxs("div",{className:"post-actions",children:[E.jsxs("button",{onClick:pe,className:`post-action-btn ${w?"liked":""}`,children:[E.jsx(aJ,{size:16,fill:w?"currentColor":"none"}),E.jsx("span",{children:P})]}),E.jsxs("button",{onClick:Be,className:"post-action-btn",children:[E.jsx(c1,{size:16}),E.jsx("span",{children:d.replies_count||0})]}),E.jsx(pn,{to:`/messages/${d.author_id}`,className:"post-action-btn",style:{textDecoration:"none"},children:E.jsx(c1,{size:16,style:{opacity:0}})})]}),U&&E.jsxs("div",{className:"post-replies",children:[V.map(Q=>E.jsxs("div",{className:"reply-item",children:[E.jsxs("span",{className:"reply-author",children:[Q.author_first_name||Q.author_username,":"]}),E.jsxs("span",{className:"reply-content",children:[" ",Q.content]})]},Q.id)),E.jsx("button",{onClick:()=>X(Q=>!Q),className:"post-action-btn",style:{marginTop:8},children:z?"Cancel":"Reply"}),z&&E.jsxs("div",{className:"reply-compose",children:[E.jsx("input",{type:"text",value:$,onChange:Q=>oe(Q.target.value),placeholder:"Write a reply...",className:"reply-input",onKeyDown:Q=>Q.key==="Enter"&&Ne()}),E.jsx("button",{onClick:Ne,className:"chat-send-btn",disabled:!$.trim(),children:"Reply"})]})]})]})}function Qee(){const[d,l]=K.useState(null);return K.useEffect(()=>{let h=!1;return We.getRadioNowPlaying().then(f=>{!h&&f.track&&l(f.track)}).catch(()=>{}),()=>{h=!0}},[]),d?E.jsxs("div",{className:"card",style:{display:"flex",alignItems:"center",gap:12,padding:"12px 16px",marginBottom:4},children:[E.jsx("div",{style:{width:36,height:36,borderRadius:8,background:"linear-gradient(135deg, #ff453a, #ff6b35)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0},children:E.jsx(cJ,{size:18,color:"#fff"})}),E.jsxs("div",{style:{flex:1,minWidth:0},children:[E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:2},children:"Now Playing"}),E.jsx("div",{style:{fontWeight:600,fontSize:14,color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:d.title||"PNPtv Radio"}),d.artist&&d.artist!=="Starting Soon"&&E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:d.artist})]}),E.jsx($T,{size:16,style:{color:"var(--accent)",flexShrink:0,animation:"pulse 2s infinite"}})]}):null}function Zee(){const[d,l]=K.useState([]),[h,f]=K.useState(!0);return K.useEffect(()=>{let y=!1;return We.getFeed().then(w=>{y||l((w.posts||[]).slice(0,5))}).catch(()=>{}).finally(()=>{y||f(!1)}),()=>{y=!0}},[]),h?E.jsx("div",{className:"card",style:{textAlign:"center",padding:32},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):d.length===0?E.jsxs("div",{className:"card",style:{textAlign:"center",padding:24},children:[E.jsx("p",{style:{color:"var(--text-muted)",fontSize:14,marginBottom:12},children:"No posts yet. Be the first!"}),E.jsxs(pn,{to:"/feed",className:"btn-primary",style:{display:"inline-flex",alignItems:"center",gap:6,fontSize:13,textDecoration:"none"},children:[E.jsx(PM,{size:14})," Go to Feed"]})]}):E.jsxs("div",{children:[E.jsxs("div",{className:"card",style:{padding:"10px 16px",display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:8},children:[E.jsx("span",{style:{fontWeight:600,fontSize:14,color:"var(--text)"},children:"Latest Posts"}),E.jsx(pn,{to:"/feed",style:{fontSize:12,color:"var(--text-muted)",textDecoration:"none"},children:"See all "})]}),d.map(y=>E.jsx(Nv,{post:y},y.id))]})}function $ee(){const{user:d}=hr(),[l,h]=K.useState(null),[f,y]=K.useState(null),[w,A]=K.useState(null),[P,L]=K.useState(null);K.useEffect(()=>{We.getLatestPrimeVideo().then(M=>h(M.data)).catch(()=>{}),We.getLatestVideoramaVideo().then(M=>y(M.data)).catch(()=>{}),We.getActiveLiveStreams().then(M=>A(M.data)).catch(()=>{}),We.getMostActiveHangout().then(M=>L(M.data)).catch(()=>{})},[]);const U=({badge:M,badgeColor:V,title:W,subtitle:z,image:X,cta:$,ctaText:oe,onClick:ve})=>E.jsxs("div",{onClick:ve,style:{background:"linear-gradient(135deg, rgba(0,0,0,0.3), rgba(0,0,0,0.6))",backgroundImage:X?`url(${X})`:"none",backgroundSize:"cover",backgroundPosition:"center",borderRadius:12,overflow:"hidden",cursor:"pointer",aspectRatio:"16/9",display:"flex",flexDirection:"column",justifyContent:"space-between",padding:16,position:"relative",textDecoration:"none",color:"inherit",transition:"transform 0.2s, box-shadow 0.2s"},onMouseEnter:Re=>{Re.currentTarget.style.transform="scale(1.02)",Re.currentTarget.style.boxShadow="0 8px 16px rgba(0,0,0,0.3)"},onMouseLeave:Re=>{Re.currentTarget.style.transform="scale(1)",Re.currentTarget.style.boxShadow="none"},as:pn,to:$,className:"card",children:[E.jsx("span",{style:{display:"inline-block",background:V||"var(--accent)",color:"#fff",padding:"4px 8px",borderRadius:6,fontSize:11,fontWeight:600,width:"fit-content",textShadow:"0 1px 2px rgba(0,0,0,0.3)"},children:M}),E.jsxs("div",{children:[E.jsx("div",{style:{fontWeight:600,fontSize:16,color:"#fff",marginBottom:4,textShadow:"0 2px 4px rgba(0,0,0,0.5)"},children:W}),E.jsx("div",{style:{fontSize:13,color:"rgba(255,255,255,0.8)",marginBottom:12,textShadow:"0 1px 2px rgba(0,0,0,0.3)"},children:z}),E.jsx("button",{style:{background:"var(--accent)",color:"#fff",border:"none",padding:"6px 12px",borderRadius:6,fontSize:12,fontWeight:600,cursor:"pointer"},onClick:Re=>{Re.preventDefault(),ve?.()},children:oe})]})]});return E.jsxs(Gn,{children:[E.jsxs("div",{className:"welcome-banner",children:[E.jsxs("h2",{children:["Welcome",d?.firstName?`, ${d.firstName}`:"","!"]}),E.jsx("p",{children:"Your PNPtv hub - explore, connect, and enjoy."})]}),E.jsx(Qee,{}),E.jsx("div",{className:"section-label",children:"Featured Content"}),E.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(240px, 1fr))",gap:12,marginBottom:24},children:[l&&E.jsx(pn,{to:"/videorama",style:{textDecoration:"none"},children:E.jsx(U,{badge:" PRIME",badgeColor:"#D4AF37",title:l.title,subtitle:l.artist,image:l.cover,cta:"/suscripcion",ctaText:"Subscribe"})}),f&&E.jsx(pn,{to:"/videorama",style:{textDecoration:"none"},children:E.jsx(U,{badge:" VIDEORAMA",badgeColor:"#1abc9c",title:f.title,subtitle:f.artist,image:f.cover,cta:"/videorama",ctaText:"Watch"})}),w&&E.jsx(pn,{to:"/livestream",style:{textDecoration:"none"},children:E.jsx(U,{badge:" LIVE",badgeColor:"#ff453a",title:w.title,subtitle:w.host,image:w.thumbnail,cta:"/livestream",ctaText:"Join"})}),P&&E.jsx(pn,{to:"/hangouts",style:{textDecoration:"none"},children:E.jsx(U,{badge:" HANGOUT",badgeColor:"#007AFF",title:P.title,subtitle:`${P.members||0} members`,image:P.thumbnail,cta:"/hangouts",ctaText:"Join"})})]}),E.jsx("div",{className:"section-label",children:"Latest Posts"}),E.jsx(Zee,{})]})}function ete({status:d}){const h={active:{label:"Active",className:"active"},lifetime:{label:"Lifetime",className:"active"},trial:{label:"Trial",className:"active"},expired:{label:"Expired",className:"expired"},cancelled:{label:"Cancelled",className:"expired"}}[d]||{label:d||"Inactive",className:"inactive"};return E.jsx("span",{className:`sub-badge ${h.className}`,children:h.label})}function tte({photoUrl:d,onUpload:l,uploading:h}){const f=Fu.useRef(null),[y,w]=K.useState(null),A=async P=>{const L=P.target.files?.[0];if(!L)return;const U=new FileReader;U.onload=M=>w(M.target.result),U.readAsDataURL(L);try{await l(L),w(null)}catch{w(null)}};return E.jsxs("div",{style:{position:"relative",display:"inline-block",margin:"0 auto"},children:[E.jsx("div",{className:"profile-avatar",onClick:()=>f.current?.click(),style:{cursor:"pointer",position:"relative"},title:"Click to upload avatar",children:y?E.jsx("img",{src:y,alt:"Preview"}):d?E.jsx("img",{src:d,alt:"Avatar"}):E.jsx("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"100%",height:"100%",fontSize:28,fontWeight:700,color:"var(--accent-pink)"},children:h?"...":""})}),E.jsx("input",{ref:f,type:"file",accept:"image/*",onChange:A,disabled:h,style:{display:"none"}})]})}function bu({label:d,value:l,editing:h,name:f,form:y,onChange:w,placeholder:A,textarea:P}){if(!h)return l?E.jsxs("div",{className:"profile-row",children:[E.jsx("span",{className:"profile-row-label",children:d}),E.jsx("span",{className:"profile-row-value",children:l})]}):null;const L={name:f,value:y[f]??"",onChange:w,placeholder:A||d,className:"profile-edit-input"};return E.jsxs("div",{className:"profile-row profile-row-edit",children:[E.jsx("span",{className:"profile-row-label",children:d}),P?E.jsx("textarea",{...L,rows:3,className:"profile-edit-textarea"}):E.jsx("input",{...L})]})}function nte(){const{user:d,logout:l}=hr();Z9();const[h,f]=K.useState(null),[y,w]=K.useState(!0),[A,P]=K.useState(!1),[L,U]=K.useState(!1),[M,V]=K.useState(!1),[W,z]=K.useState(""),[X,$]=K.useState({});K.useEffect(()=>{let Ne=!1;return We.getProfile().then(Ee=>{!Ne&&Ee.success&&f(Ee.profile)}).catch(()=>{}).finally(()=>{Ne||w(!1)}),()=>{Ne=!0}},[]);const oe=()=>{$({firstName:h?.firstName||"",lastName:h?.lastName||"",bio:h?.bio||"",locationText:h?.locationText||"",interests:Array.isArray(h?.interests)?h.interests.join(", "):h?.interests||"",xHandle:h?.xHandle||"",instagramHandle:h?.instagramHandle||"",tiktokHandle:h?.tiktokHandle||""}),z(""),P(!0)},ve=()=>{P(!1),z("")},Re=Ne=>$(Ee=>({...Ee,[Ne.target.name]:Ne.target.value})),pe=async()=>{U(!0),z("");try{await We.updateProfile(X);const Ne=await We.getProfile();Ne.success&&f(Ne.profile),P(!1)}catch(Ne){z(Ne.message||"Failed to save profile")}finally{U(!1)}},fe=async Ne=>{V(!0),z("");try{const Ee=await We.uploadAvatar(Ne);f(Q=>({...Q,photoUrl:Ee.photoUrl}))}catch(Ee){z(Ee.message||"Failed to upload avatar")}finally{V(!1)}},Be=Ne=>Ne?new Date(Ne).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"N/A";return E.jsx(Gn,{children:y?E.jsx("div",{style:{textAlign:"center",padding:48},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):E.jsxs(E.Fragment,{children:[E.jsxs("div",{className:"card profile-header-card",children:[E.jsx(tte,{photoUrl:h?.photoUrl,onUpload:fe,uploading:M}),A?E.jsxs("div",{style:{display:"flex",gap:8,marginBottom:8},children:[E.jsx("input",{name:"firstName",value:X.firstName,onChange:Re,placeholder:"First name",className:"profile-edit-input",style:{maxWidth:130}}),E.jsx("input",{name:"lastName",value:X.lastName,onChange:Re,placeholder:"Last name",className:"profile-edit-input",style:{maxWidth:130}})]}):E.jsxs("div",{className:"profile-name",children:[h?.firstName||d?.firstName||""," ",h?.lastName||d?.lastName||""]}),E.jsxs("div",{className:"profile-username",children:["@",h?.username||d?.username||"user"]}),A?E.jsx("textarea",{name:"bio",value:X.bio,onChange:Re,placeholder:"Bio (optional)",rows:3,className:"profile-edit-textarea",style:{marginTop:8}}):h?.bio&&E.jsx("p",{className:"profile-bio",children:h.bio}),W&&E.jsx("div",{style:{color:"#ff453a",fontSize:13,marginTop:6},children:W}),E.jsx("div",{style:{display:"flex",gap:10,marginTop:12,justifyContent:"center"},children:A?E.jsxs(E.Fragment,{children:[E.jsxs("button",{className:"btn-secondary",onClick:ve,disabled:L,style:{display:"flex",alignItems:"center",gap:6,fontSize:13},children:[E.jsx(Cf,{size:14})," Cancel"]}),E.jsxs("button",{className:"btn-primary",onClick:pe,disabled:L,style:{display:"flex",alignItems:"center",gap:6,fontSize:13},children:[E.jsx(dJ,{size:14})," ",L?"Saving":"Save"]})]}):E.jsxs("button",{className:"btn-secondary",onClick:oe,style:{display:"flex",alignItems:"center",gap:6,fontSize:13},children:[E.jsx(ev,{size:14})," Edit Profile"]})}),E.jsxs("div",{className:"profile-stats",style:{marginTop:16},children:[E.jsxs("div",{className:"profile-stat",children:[E.jsx("div",{className:"profile-stat-value",children:E.jsx(hf,{size:16,style:{display:"inline",verticalAlign:"middle"}})}),E.jsx("div",{className:"profile-stat-label",children:E.jsx(ete,{status:h?.subscriptionStatus||d?.subscriptionStatus})})]}),E.jsxs("div",{className:"profile-stat",children:[E.jsx("div",{className:"profile-stat-value",children:E.jsx(lJ,{size:16,style:{display:"inline",verticalAlign:"middle"}})}),E.jsxs("div",{className:"profile-stat-label",children:["Since ",Be(h?.memberSince)]})]})]})]}),E.jsx("div",{className:"section-label",children:"Account"}),E.jsxs("div",{className:"card profile-section",children:[E.jsxs("div",{className:"profile-row",children:[E.jsx("span",{className:"profile-row-label",children:"Subscription"}),E.jsx("span",{className:"profile-row-value",children:h?.subscriptionPlan||"None"})]}),h?.subscriptionExpires&&E.jsxs("div",{className:"profile-row",children:[E.jsx("span",{className:"profile-row-label",children:"Expires"}),E.jsx("span",{className:"profile-row-value",children:Be(h.subscriptionExpires)})]}),E.jsxs("div",{className:"profile-row",children:[E.jsx("span",{className:"profile-row-label",children:"Language"}),E.jsx("span",{className:"profile-row-value",children:h?.language==="es"?"Espaol":"English"})]}),E.jsx(bu,{label:"Location",value:h?.locationText,editing:A,name:"locationText",form:X,onChange:Re,placeholder:"Your city or area"}),E.jsx(bu,{label:"Interests",value:Array.isArray(h?.interests)?h.interests.join(", "):h?.interests,editing:A,name:"interests",form:X,onChange:Re,placeholder:"e.g. music, travel, art"})]}),E.jsx("div",{className:"section-label",children:"Social"}),E.jsxs("div",{className:"card profile-section",children:[E.jsx(bu,{label:"X (Twitter)",value:h?.xHandle?`@${h.xHandle}`:null,editing:A,name:"xHandle",form:X,onChange:Re,placeholder:"username (without @)"}),E.jsx(bu,{label:"Instagram",value:h?.instagramHandle?`@${h.instagramHandle}`:null,editing:A,name:"instagramHandle",form:X,onChange:Re,placeholder:"username (without @)"}),E.jsx(bu,{label:"TikTok",value:h?.tiktokHandle?`@${h.tiktokHandle}`:null,editing:A,name:"tiktokHandle",form:X,onChange:Re,placeholder:"username (without @)"}),!A&&!h?.xHandle&&!h?.instagramHandle&&!h?.tiktokHandle&&E.jsx("div",{style:{color:"var(--text-muted)",fontSize:13,padding:"8px 0"},children:"No social handles yet. Click Edit Profile to add them."})]}),E.jsxs("button",{className:"btn-logout",onClick:l,children:[E.jsx(tv,{size:16,style:{display:"inline",verticalAlign:"middle",marginRight:8}}),"Sign Out"]})]})})}const ite=[1,5,10,25,50];function rte(d){return d<1?`${Math.round(d*1e3)} m`:`${d.toFixed(1)} km`}function ste(){const[d,l]=K.useState("idle"),[h,f]=K.useState([]),[y,w]=K.useState(5),[A,P]=K.useState(null),[L,U]=K.useState(""),M=K.useCallback(()=>{if(!navigator.geolocation){l("error"),U("Geolocation is not supported by your browser.");return}l("locating"),U(""),navigator.geolocation.getCurrentPosition(W=>{const{latitude:z,longitude:X,accuracy:$}=W.coords;P({latitude:z,longitude:X}),l("searching"),We.nearbyUpdateLocation(z,X,$).catch(()=>{}).then(()=>We.nearbySearch(z,X,y)).then(oe=>{f(oe.users||oe.nearby||[]),l("done")}).catch(oe=>{l("error"),U(oe.message||"Failed to search nearby users.")})},W=>{l("error"),U(W.code===1?"Location access denied. Please allow location in your browser settings.":W.code===2?"Location unavailable. Try again.":"Location request timed out. Try again.")},{enableHighAccuracy:!0,timeout:12e3,maximumAge:6e4})},[y]),V=K.useCallback(()=>{if(!A){M();return}l("searching"),We.nearbySearch(A.latitude,A.longitude,y).then(W=>{f(W.users||W.nearby||[]),l("done")}).catch(W=>{l("error"),U(W.message||"Search failed.")})},[A,y,M]);return E.jsxs(Gn,{children:[E.jsx("div",{className:"section-label",children:"Nearby"}),E.jsxs("div",{className:"card",style:{display:"flex",alignItems:"center",gap:12,flexWrap:"wrap"},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:6,flex:1},children:[E.jsx(wu,{size:16,color:"var(--accent)"}),E.jsx("span",{style:{fontSize:13,color:"var(--text-muted)"},children:"Radius:"}),E.jsx("select",{value:y,onChange:W=>w(Number(W.target.value)),style:{background:"var(--surface-2)",border:"1px solid var(--border)",borderRadius:8,color:"var(--text)",padding:"4px 8px",fontSize:13},children:ite.map(W=>E.jsxs("option",{value:W,children:[W," km"]},W))})]}),E.jsx("button",{className:"btn-primary",onClick:d==="done"?V:M,disabled:d==="locating"||d==="searching",style:{display:"flex",alignItems:"center",gap:6,fontSize:13,padding:"8px 16px"},children:d==="locating"||d==="searching"?E.jsxs(E.Fragment,{children:[E.jsx("div",{className:"loading-spinner",style:{width:14,height:14,borderWidth:2}})," ",d==="locating"?"Locating":"Searching"]}):d==="done"?E.jsxs(E.Fragment,{children:[E.jsx(wf,{size:14})," Refresh"]}):E.jsxs(E.Fragment,{children:[E.jsx(Af,{size:14})," Find Nearby"]})})]}),d==="error"&&E.jsx("div",{className:"card",style:{color:"#ff453a",fontSize:14,padding:"14px 16px"},children:L}),d==="done"&&h.length===0&&E.jsxs("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:[E.jsx(wu,{size:32,style:{opacity:.3,margin:"0 auto 12px",display:"block"}}),E.jsxs("p",{children:["No users found within ",y," km."]}),E.jsx("p",{style:{fontSize:13,marginTop:6},children:"Try increasing the radius."})]}),d==="idle"&&E.jsxs("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:[E.jsx(wu,{size:32,style:{opacity:.3,margin:"0 auto 12px",display:"block"}}),E.jsxs("p",{children:["Tap ",E.jsx("strong",{children:"Find Nearby"})," to discover members around you."]}),E.jsx("p",{style:{fontSize:12,marginTop:8},children:"Your location is only shared while searching."})]}),d==="done"&&h.length>0&&E.jsxs(E.Fragment,{children:[E.jsxs("div",{style:{fontSize:13,color:"var(--text-muted)",padding:"4px 0 8px"},children:[h.length," member",h.length!==1?"s":""," within ",y," km"]}),h.map(W=>E.jsxs("div",{className:"card",style:{display:"flex",alignItems:"center",gap:12},children:[E.jsx("div",{style:{width:44,height:44,borderRadius:"50%",background:"var(--surface-2)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:18,fontWeight:700,color:"var(--accent)",flexShrink:0},children:(W.name||W.username||"?")[0].toUpperCase()}),E.jsxs("div",{style:{flex:1,minWidth:0},children:[E.jsx(pn,{to:`/wall/${W.id||W.userId}`,style:{fontWeight:600,fontSize:15,color:"var(--text)",textDecoration:"none"},children:W.name||W.username||"User"}),W.username&&E.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:["@",W.username]}),(W.distance_km!==void 0||W.distance!==void 0)&&E.jsxs("div",{style:{fontSize:12,color:"var(--accent)",marginTop:2},children:[E.jsx(wu,{size:11,style:{display:"inline",verticalAlign:"middle"}})," ",rte(W.distance_km??W.distance)]})]}),E.jsxs(pn,{to:`/messages/${W.id||W.userId}`,className:"btn-secondary",style:{display:"flex",alignItems:"center",gap:4,fontSize:12,padding:"6px 10px",flexShrink:0,textDecoration:"none"},children:[E.jsx(vf,{size:13})," DM"]})]},W.id||W.userId))]})]})}function ote(d){if(!d)return"";const l=Date.now()-new Date(d).getTime(),h=Math.floor(l/6e4);return h<1?"just now":h<60?`${h}m ago`:`${Math.floor(h/60)}h ago`}let TM=!1,Zm=null;function ate(){return TM?Promise.resolve():Zm||(Zm=new Promise((d,l)=>{const h=document.createElement("script");h.src="https://8x8.vc/libs/external_api.min.js",h.onload=()=>{TM=!0,d()},h.onerror=()=>l(new Error("Failed to load Jitsi API")),document.head.appendChild(h)}),Zm)}function cte({activeCall:d,userName:l,onLeave:h,onEnd:f}){const y=K.useRef(null),w=K.useRef(null),[A,P]=K.useState("");return K.useEffect(()=>{let L=!1;return(async()=>{try{if(await ate(),L||!y.current)return;if(!window.JitsiMeetExternalAPI)throw new Error("JitsiMeetExternalAPI not available");const M=new URL(d.jitsiUrl),V=M.pathname.split("/").filter(Boolean),W=V[0],z=V[1],X=M.searchParams.get("jwt"),$=new window.JitsiMeetExternalAPI("8x8.vc",{roomName:`${W}/${z}`,jwt:X,parentNode:y.current,width:"100%",height:"100%",configOverwrite:{startWithAudioMuted:!1,startWithVideoMuted:!1,disableDeepLinking:!0,prejoinPageEnabled:!1},interfaceConfigOverwrite:{SHOW_JITSI_WATERMARK:!1,SHOW_WATERMARK_FOR_GUESTS:!1,TOOLBAR_BUTTONS:["microphone","camera","closedcaptions","desktop","fullscreen","fodeviceselection","hangup","chat","raisehand","videoquality","tileview","select-background","stats"]},userInfo:{displayName:l||"Guest"}});w.current=$,$.addEventListener("readyToClose",()=>{L||h()}),$.addEventListener("videoConferenceLeft",()=>{L||h()})}catch(M){L||P(M.message||"Failed to load video call")}})(),()=>{if(L=!0,w.current){try{w.current.dispose()}catch{}w.current=null}}},[d.jitsiUrl]),E.jsxs("div",{style:{position:"fixed",inset:0,zIndex:1e3,background:"#000",display:"flex",flexDirection:"column"},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 16px",background:"rgba(0,0,0,0.8)",borderBottom:"1px solid rgba(255,255,255,0.1)",flexShrink:0},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,color:"#fff",fontSize:14},children:[E.jsx(Nu,{size:16,style:{color:"#30d158"}}),E.jsx("span",{style:{fontWeight:600},children:d.title||`${d.creatorName||"Host"}'s Room`})]}),E.jsxs("div",{style:{display:"flex",gap:8},children:[d.isModerator&&E.jsxs("button",{onClick:f,style:{display:"flex",alignItems:"center",gap:6,padding:"6px 14px",borderRadius:8,border:"none",cursor:"pointer",background:"rgba(255,69,58,0.2)",color:"#ff453a",fontSize:13,fontWeight:600},children:[E.jsx(LM,{size:14})," End Room"]}),E.jsxs("button",{onClick:h,style:{display:"flex",alignItems:"center",gap:6,padding:"6px 14px",borderRadius:8,border:"none",cursor:"pointer",background:"rgba(255,255,255,0.1)",color:"#fff",fontSize:13,fontWeight:600},children:[E.jsx(tv,{size:14})," Leave"]})]})]}),E.jsx("div",{ref:y,style:{flex:1,width:"100%",overflow:"hidden"},children:A&&E.jsx("div",{style:{color:"#ff453a",textAlign:"center",padding:40},children:A})})]})}function dte(){const{user:d}=hr(),[l,h]=K.useState([]),[f,y]=K.useState(!0),[w,A]=K.useState(!1),[P,L]=K.useState(!1),[U,M]=K.useState(""),[V,W]=K.useState(""),[z,X]=K.useState(null),[$,oe]=K.useState(null),ve=K.useCallback(async()=>{try{const Ee=await We.getPublicHangouts();h(Ee.rooms||[])}catch{h([])}finally{y(!1)}},[]);K.useEffect(()=>{ve();const Ee=setInterval(ve,3e4);return()=>clearInterval(Ee)},[ve]);const Re=(Ee,{title:Q,creatorName:je,isModerator:Tt})=>{Ee.jitsiUrl?oe({jitsiUrl:Ee.jitsiUrl,room:Ee.room,id:Ee.id,isModerator:Tt??!1,title:Q,creatorName:je}):window.open(`https://meet.jit.si/${Ee.room}`,"_blank","noopener")},pe=async()=>{W(""),A(!0);try{const Ee=await We.createHangout({title:U.trim()||null,isPublic:!0});L(!1),M("");const Q=d?.firstName||d?.username||"You";Re(Ee,{title:U.trim()||null,creatorName:Q,isModerator:!0}),await ve()}catch(Ee){W(Ee.message||"Failed to create room")}finally{A(!1)}},fe=async Ee=>{X(Ee.id),W("");try{const Q=await We.joinHangout(Ee.id);Re(Q,{title:Ee.title,creatorName:Ee.creatorName,isModerator:Q.isModerator})}catch(Q){W(Q.message||"Failed to join room")}finally{X(null)}},Be=K.useCallback(async()=>{if($){try{await We.leaveHangout($.id)}catch{}oe(null),ve()}},[$,ve]),Ne=K.useCallback(async()=>{if($){try{await We.endHangout($.id)}catch{}oe(null),ve()}},[$,ve]);if($){const Ee=d?.firstName||d?.username||"Guest";return E.jsx(cte,{activeCall:$,userName:Ee,onLeave:Be,onEnd:Ne})}return E.jsxs(Gn,{children:[E.jsxs("div",{className:"page-header",children:[E.jsx("h2",{className:"page-title",children:"Hangouts"}),E.jsxs("div",{style:{display:"flex",gap:8},children:[E.jsx("button",{onClick:ve,className:"btn-secondary",style:{padding:"6px 10px"},title:"Refresh",children:E.jsx(wf,{size:15})}),E.jsxs("button",{onClick:()=>{L(Ee=>!Ee),W("")},className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6},children:[E.jsx(xu,{size:16})," New Room"]})]})]}),P&&E.jsxs("div",{className:"card",style:{marginBottom:12,padding:16},children:[E.jsx("div",{style:{marginBottom:10,fontWeight:600,color:"var(--text-primary)"},children:"Create a Room"}),E.jsx("input",{type:"text",value:U,onChange:Ee=>M(Ee.target.value),placeholder:"Room title (optional)",maxLength:80,className:"chat-input",style:{width:"100%",marginBottom:10},onKeyDown:Ee=>Ee.key==="Enter"&&pe(),autoFocus:!0}),V&&E.jsx("div",{className:"login-error",style:{marginBottom:8},children:V}),E.jsxs("div",{style:{display:"flex",gap:8},children:[E.jsxs("button",{onClick:pe,disabled:w,className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6},children:[E.jsx(Nu,{size:15}),w?"Starting...":"Start Room"]}),E.jsx("button",{onClick:()=>L(!1),className:"btn-secondary",children:"Cancel"})]})]}),V&&!P&&E.jsx("div",{className:"login-error",style:{marginBottom:12},children:V}),f?E.jsx("div",{style:{textAlign:"center",padding:40},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):l.length===0?E.jsxs("div",{className:"card",style:{textAlign:"center",padding:40},children:[E.jsx(Nu,{size:36,style:{margin:"0 auto 12px",display:"block",opacity:.3}}),E.jsx("div",{style:{color:"var(--text-muted)",marginBottom:16},children:"No active rooms. Start one!"}),E.jsxs("button",{onClick:()=>L(!0),className:"btn-primary",style:{display:"inline-flex",alignItems:"center",gap:6},children:[E.jsx(xu,{size:16})," New Room"]})]}):E.jsx("div",{style:{display:"flex",flexDirection:"column",gap:10},children:l.map(Ee=>E.jsx("div",{className:"card",style:{padding:16},children:E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[E.jsxs("div",{style:{flex:1,minWidth:0},children:[E.jsx("div",{style:{fontWeight:600,color:"var(--text-primary)",marginBottom:4,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:Ee.title||`${Ee.creatorName}'s Room`}),E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,fontSize:13,color:"var(--text-muted)"},children:[E.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[E.jsx(ac,{size:13}),Ee.currentParticipants??0,"/",Ee.maxParticipants]}),E.jsxs("span",{children:["by ",Ee.creatorName]}),E.jsx("span",{children:ote(Ee.createdAt)})]})]}),E.jsxs("button",{onClick:()=>fe(Ee),disabled:z===Ee.id,className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6,flexShrink:0},children:[E.jsx(Nu,{size:14}),z===Ee.id?"Joining...":"Join"]})]})},Ee.id))})]})}var lf={exports:{}},lte=lf.exports,vM;function ute(){return vM||(vM=1,(function(d,l){(function(h,f){d.exports=f()})(lte,(function(){function h(e,t){return t.forEach((function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach((function(i){if(i!=="default"&&!(i in e)){var r=Object.getOwnPropertyDescriptor(n,i);Object.defineProperty(e,i,r.get?r:{enumerable:!0,get:function(){return n[i]}})}}))})),Object.freeze(e)}var f=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof lT<"u"?lT:typeof self<"u"?self:{};function y(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var w=function(e){try{return!!e()}catch{return!0}},A=!w((function(){var e=(function(){}).bind();return typeof e!="function"||e.hasOwnProperty("prototype")})),P=A,L=Function.prototype,U=L.call,M=P&&L.bind.bind(U,U),V=P?M:function(e){return function(){return U.apply(e,arguments)}},W=V({}.isPrototypeOf),z=function(e){return e&&e.Math===Math&&e},X=z(typeof globalThis=="object"&&globalThis)||z(typeof window=="object"&&window)||z(typeof self=="object"&&self)||z(typeof f=="object"&&f)||z(typeof f=="object"&&f)||(function(){return this})()||Function("return this")(),$=A,oe=Function.prototype,ve=oe.apply,Re=oe.call,pe=typeof Reflect=="object"&&Reflect.apply||($?Re.bind(ve):function(){return Re.apply(ve,arguments)}),fe=V,Be=fe({}.toString),Ne=fe("".slice),Ee=function(e){return Ne(Be(e),8,-1)},Q=Ee,je=V,Tt=function(e){if(Q(e)==="Function")return je(e)},et=typeof document=="object"&&document.all,kt=et===void 0&&et!==void 0?function(e){return typeof e=="function"||e===et}:function(e){return typeof e=="function"},ze={},qe=!w((function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7})),$n=A,mn=Function.prototype.call,zt=$n?mn.bind(mn):function(){return mn.apply(mn,arguments)},hs={},Bs={}.propertyIsEnumerable,zd=Object.getOwnPropertyDescriptor,_n=zd&&!Bs.call({1:2},1);hs.f=_n?function(e){var t=zd(this,e);return!!t&&t.enumerable}:Bs;var xi,na,Vr=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},Ku=w,ia=Ee,hc=Object,jf=V("".split),uo=Ku((function(){return!hc("z").propertyIsEnumerable(0)}))?function(e){return ia(e)==="String"?jf(e,""):hc(e)}:hc,Ws=function(e){return e==null},Gs=Ws,Dv=TypeError,ho=function(e){if(Gs(e))throw new Dv("Can't call method on "+e);return e},O2=uo,N2=ho,po=function(e){return O2(N2(e))},D2=kt,ei=function(e){return typeof e=="object"?e!==null:D2(e)},Mi={},Ff=Mi,Bf=X,P2=kt,Pv=function(e){return P2(e)?e:void 0},di=function(e,t){return arguments.length<2?Pv(Ff[e])||Pv(Bf[e]):Ff[e]&&Ff[e][t]||Bf[e]&&Bf[e][t]},Lv=X.navigator,kv=Lv&&Lv.userAgent,Hs=kv?String(kv):"",xv=X,Wf=Hs,Mv=xv.process,Uv=xv.Deno,Vv=Mv&&Mv.versions||Uv&&Uv.version,jv=Vv&&Vv.v8;jv&&(na=(xi=jv.split("."))[0]>0&&xi[0]<4?1:+(xi[0]+xi[1])),!na&&Wf&&(!(xi=Wf.match(/Edge\/(\d+)/))||xi[1]>=74)&&(xi=Wf.match(/Chrome\/(\d+)/))&&(na=+xi[1]);var ra=na,Fv=ra,L2=w,k2=X.String,pc=!!Object.getOwnPropertySymbols&&!L2((function(){var e=Symbol("symbol detection");return!k2(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Fv&&Fv<41})),Bv=pc&&!Symbol.sham&&typeof Symbol.iterator=="symbol",x2=di,M2=kt,U2=W,V2=Object,qd=Bv?function(e){return typeof e=="symbol"}:function(e){var t=x2("Symbol");return M2(t)&&U2(t.prototype,V2(e))},j2=String,mc=function(e){try{return j2(e)}catch{return"Object"}},F2=kt,B2=mc,W2=TypeError,Ui=function(e){if(F2(e))return e;throw new W2(B2(e)+" is not a function")},G2=Ui,H2=Ws,Xd=function(e,t){var n=e[t];return H2(n)?void 0:G2(n)},Wv=zt,Gv=kt,Hv=ei,K2=TypeError,Kv={exports:{}},Yv=X,Y2=Object.defineProperty,z2=X,q2=function(e,t){try{Y2(Yv,e,{value:t,configurable:!0,writable:!0})}catch{Yv[e]=t}return t},zv="__core-js_shared__",qv=Kv.exports=z2[zv]||q2(zv,{});(qv.versions||(qv.versions=[])).push({version:"3.46.0",mode:"pure",copyright:" 2014-2025 Denis Pushkarev (zloirock.ru), 2025 CoreJS Company (core-js.io)",license:"https://github.com/zloirock/core-js/blob/v3.46.0/LICENSE",source:"https://github.com/zloirock/core-js"});var Gf=Kv.exports,Xv=Gf,fc=function(e,t){return Xv[e]||(Xv[e]=t||{})},X2=ho,J2=Object,ps=function(e){return J2(X2(e))},Q2=ps,Z2=V({}.hasOwnProperty),Hn=Object.hasOwn||function(e,t){return Z2(Q2(e),t)},$2=V,eV=0,tV=Math.random(),nV=$2(1.1.toString),Hf=function(e){return"Symbol("+(e===void 0?"":e)+")_"+nV(++eV+tV,36)},iV=fc,Jv=Hn,rV=Hf,sV=pc,oV=Bv,_c=X.Symbol,Kf=iV("wks"),aV=oV?_c.for||_c:_c&&_c.withoutSetter||rV,rn=function(e){return Jv(Kf,e)||(Kf[e]=sV&&Jv(_c,e)?_c[e]:aV("Symbol."+e)),Kf[e]},cV=zt,Qv=ei,Zv=qd,dV=Xd,lV=function(e,t){var n,i;if(Gv(n=e.toString)&&!Hv(i=Wv(n,e))||Gv(n=e.valueOf)&&!Hv(i=Wv(n,e)))return i;throw new K2("Can't convert object to primitive value")},uV=TypeError,hV=rn("toPrimitive"),pV=function(e,t){if(!Qv(e)||Zv(e))return e;var n,i=dV(e,hV);if(i){if(n=cV(i,e,t),!Qv(n)||Zv(n))return n;throw new uV("Can't convert object to primitive value")}return lV(e)},mV=qd,Yf=function(e){var t=pV(e,"string");return mV(t)?t:t+""},$v=ei,zf=X.document,fV=$v(zf)&&$v(zf.createElement),qf=function(e){return fV?zf.createElement(e):{}},_V=qf,eR=!qe&&!w((function(){return Object.defineProperty(_V("div"),"a",{get:function(){return 7}}).a!==7})),gV=qe,EV=zt,SV=hs,yV=Vr,TV=po,vV=Yf,RV=Hn,CV=eR,tR=Object.getOwnPropertyDescriptor;ze.f=gV?tR:function(e,t){if(e=TV(e),t=vV(t),CV)try{return tR(e,t)}catch{}if(RV(e,t))return yV(!EV(SV.f,e,t),e[t])};var bV=w,wV=kt,AV=/#|\.prototype\./,Jd=function(e,t){var n=OV[IV(e)];return n===DV||n!==NV&&(wV(t)?bV(t):!!t)},IV=Jd.normalize=function(e){return String(e).replace(AV,".").toLowerCase()},OV=Jd.data={},NV=Jd.NATIVE="N",DV=Jd.POLYFILL="P",nR=Jd,PV=Ui,LV=A,kV=Tt(Tt.bind),mo=function(e,t){return PV(e),t===void 0?e:LV?kV(e,t):function(){return e.apply(t,arguments)}},pr={},iR=qe&&w((function(){return Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype!==42})),xV=ei,MV=String,UV=TypeError,wi=function(e){if(xV(e))return e;throw new UV(MV(e)+" is not an object")},VV=qe,jV=eR,FV=iR,Yu=wi,rR=Yf,BV=TypeError,Xf=Object.defineProperty,WV=Object.getOwnPropertyDescriptor,Jf="enumerable",Qf="configurable",Zf="writable";pr.f=VV?FV?function(e,t,n){if(Yu(e),t=rR(t),Yu(n),typeof e=="function"&&t==="prototype"&&"value"in n&&Zf in n&&!n[Zf]){var i=WV(e,t);i&&i[Zf]&&(e[t]=n.value,n={configurable:Qf in n?n[Qf]:i[Qf],enumerable:Jf in n?n[Jf]:i[Jf],writable:!1})}return Xf(e,t,n)}:Xf:function(e,t,n){if(Yu(e),t=rR(t),Yu(n),jV)try{return Xf(e,t,n)}catch{}if("get"in n||"set"in n)throw new BV("Accessors not supported");return"value"in n&&(e[t]=n.value),e};var GV=pr,HV=Vr,sa=qe?function(e,t,n){return GV.f(e,t,HV(1,n))}:function(e,t,n){return e[t]=n,e},Qd=X,KV=pe,YV=Tt,zV=kt,qV=ze.f,XV=nR,gc=Mi,JV=mo,Ec=sa,sR=Hn,QV=function(e){var t=function(n,i,r){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(n);case 2:return new e(n,i)}return new e(n,i,r)}return KV(e,this,arguments)};return t.prototype=e.prototype,t},pt=function(e,t){var n,i,r,s,o,a,c,u,p,m=e.target,_=e.global,g=e.stat,b=e.proto,v=_?Qd:g?Qd[m]:Qd[m]&&Qd[m].prototype,R=_?gc:gc[m]||Ec(gc,m,{})[m],O=R.prototype;for(s in t)i=!(n=XV(_?s:m+(g?".":"#")+s,e.forced))&&v&&sR(v,s),a=R[s],i&&(c=e.dontCallGetSet?(p=qV(v,s))&&p.value:v[s]),o=i&&c?c:t[s],(n||b||typeof a!=typeof o)&&(u=e.bind&&i?JV(o,Qd):e.wrap&&i?QV(o):b&&zV(o)?YV(o):o,(e.sham||o&&o.sham||a&&a.sham)&&Ec(u,"sham",!0),Ec(R,s,u),b&&(sR(gc,r=m+"Prototype")||Ec(gc,r,{}),Ec(gc[r],s,o),e.real&&O&&(n||!O[s])&&Ec(O,s,o)))},ZV=Math.ceil,$V=Math.floor,ej=Math.trunc||function(e){var t=+e;return(t>0?$V:ZV)(t)},tj=ej,$f=function(e){var t=+e;return t!=t||t===0?0:tj(t)},nj=$f,ij=Math.max,rj=Math.min,e_=function(e,t){var n=nj(e);return n<0?ij(n+t,0):rj(n,t)},sj=$f,oj=Math.min,oR=function(e){var t=sj(e);return t>0?oj(t,9007199254740991):0},aj=oR,fo=function(e){return aj(e.length)},cj=po,dj=e_,lj=fo,aR=function(e){return function(t,n,i){var r=cj(t),s=lj(r);if(s===0)return!e&&-1;var o,a=dj(i,s);if(e&&n!=n){for(;s>a;)if((o=r[a++])!=o)return!0}else for(;s>a;a++)if((e||a in r)&&r[a]===n)return e||a||0;return!e&&-1}},t_={includes:aR(!0),indexOf:aR(!1)},uj=t_.includes;pt({target:"Array",proto:!0,forced:w((function(){return!Array(1).includes()}))},{includes:function(e){return uj(this,e,arguments.length>1?arguments[1]:void 0)}});var hj=X,pj=Mi,Zi=function(e,t){var n=pj[e+"Prototype"],i=n&&n[t];if(i)return i;var r=hj[e],s=r&&r.prototype;return s&&s[t]},mj=Zi("Array","includes"),fj=ei,_j=Ee,gj=rn("match"),n_=function(e){var t;return fj(e)&&((t=e[gj])!==void 0?!!t:_j(e)==="RegExp")},Ej=n_,Sj=TypeError,cR={};cR[rn("toStringTag")]="z";var i_=String(cR)==="[object z]",yj=i_,Tj=kt,zu=Ee,vj=rn("toStringTag"),Rj=Object,Cj=zu((function(){return arguments})())==="Arguments",_o=yj?zu:function(e){var t,n,i;return e===void 0?"Undefined":e===null?"Null":typeof(n=(function(r,s){try{return r[s]}catch{}})(t=Rj(e),vj))=="string"?n:Cj?zu(t):(i=zu(t))==="Object"&&Tj(t.callee)?"Arguments":i},bj=_o,wj=String,Ai=function(e){if(bj(e)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return wj(e)},Aj=rn("match"),Ij=pt,Oj=function(e){if(Ej(e))throw new Sj("The method doesn't accept regular expressions");return e},Nj=ho,dR=Ai,Dj=function(e){var t=/./;try{"/./"[e](t)}catch{try{return t[Aj]=!1,"/./"[e](t)}catch{}}return!1},Pj=V("".indexOf);Ij({target:"String",proto:!0,forced:!Dj("includes")},{includes:function(e){return!!~Pj(dR(Nj(this)),dR(Oj(e)),arguments.length>1?arguments[1]:void 0)}});var Lj=Zi("String","includes"),lR=W,kj=mj,xj=Lj,r_=Array.prototype,s_=String.prototype,Mj=function(e){var t=e.includes;return e===r_||lR(r_,e)&&t===r_.includes?kj:typeof e=="string"||e===s_||lR(s_,e)&&t===s_.includes?xj:t},ie=y(Mj),Uj=Ui,Vj=ps,jj=uo,Fj=fo,uR=TypeError,hR="Reduce of empty array with no initial value",Bj=function(e){return function(t,n,i,r){var s=Vj(t),o=jj(s),a=Fj(s);if(Uj(n),a===0&&i<2)throw new uR(hR);var c=e?a-1:0,u=e?-1:1;if(i<2)for(;;){if(c in o){r=o[c],c+=u;break}if(c+=u,e?c<0:a<=c)throw new uR(hR)}for(;e?c>=0:a>c;c+=u)c in o&&(r=n(r,o[c],c,s));return r}},Wj={left:Bj(!1)},Gj=w,qu=function(e,t){var n=[][e];return!!n&&Gj((function(){n.call(null,t||function(){return 1},1)}))},Zd=X,Hj=Hs,Kj=Ee,Xu=function(e){return Hj.slice(0,e.length)===e},o_=Xu("Bun/")?"BUN":Xu("Cloudflare-Workers")?"CLOUDFLARE":Xu("Deno/")?"DENO":Xu("Node.js/")?"NODE":Zd.Bun&&typeof Bun.version=="string"?"BUN":Zd.Deno&&typeof Deno.version=="object"?"DENO":Kj(Zd.process)==="process"?"NODE":Zd.window&&Zd.document?"BROWSER":"REST",Ju=o_==="NODE",Yj=Wj.left;pt({target:"Array",proto:!0,forced:!Ju&&ra>79&&ra<83||!qu("reduce")},{reduce:function(e){var t=arguments.length;return Yj(this,e,t,t>1?arguments[1]:void 0)}});var zj=Zi("Array","reduce"),qj=W,Xj=zj,a_=Array.prototype,Jj=function(e){var t=e.reduce;return e===a_||qj(a_,e)&&t===a_.reduce?Xj:t},pR=Jj,$i=y(pR),Qj=Ee,$d=Array.isArray||function(e){return Qj(e)==="Array"},Zj=pt,$j=$d,eF=V([].reverse),mR=[1,2];Zj({target:"Array",proto:!0,forced:String(mR)===String(mR.reverse())},{reverse:function(){return $j(this)&&(this.length=this.length),eF(this)}});var tF=Zi("Array","reverse"),nF=W,iF=tF,c_=Array.prototype,rF=function(e){var t=e.reverse;return e===c_||nF(c_,e)&&t===c_.reverse?iF:t},fR=rF,_R=y(fR),sF=Hf,gR=fc("keys"),Qu=function(e){return gR[e]||(gR[e]=sF(e))},oF=!w((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),aF=Hn,cF=kt,dF=ps,lF=oF,ER=Qu("IE_PROTO"),d_=Object,uF=d_.prototype,l_=lF?d_.getPrototypeOf:function(e){var t=dF(e);if(aF(t,ER))return t[ER];var n=t.constructor;return cF(n)&&t instanceof n?n.prototype:t instanceof d_?uF:null},hF=V,pF=Ui,mF=ei,fF=function(e){return mF(e)||e===null},_F=String,gF=TypeError,EF=function(e,t,n){try{return hF(pF(Object.getOwnPropertyDescriptor(e,t)[n]))}catch{}},SF=ei,yF=ho,TF=function(e){if(fF(e))return e;throw new gF("Can't set "+_F(e)+" as a prototype")},vF=Object.setPrototypeOf||("__proto__"in{}?(function(){var e,t=!1,n={};try{(e=EF(Object.prototype,"__proto__","set"))(n,[]),t=n instanceof Array}catch{}return function(i,r){return yF(i),TF(r),SF(i)&&(t?e(i,r):i.__proto__=r),i}})():void 0),Zu={},$u={},u_=Hn,RF=po,CF=t_.indexOf,bF=$u,SR=V([].push),yR=function(e,t){var n,i=RF(e),r=0,s=[];for(n in i)!u_(bF,n)&&u_(i,n)&&SR(s,n);for(;t.length>r;)u_(i,n=t[r++])&&(~CF(s,n)||SR(s,n));return s},h_=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],wF=yR,AF=h_.concat("length","prototype");Zu.f=Object.getOwnPropertyNames||function(e){return wF(e,AF)};var el={};el.f=Object.getOwnPropertySymbols;var IF=di,OF=Zu,NF=el,DF=wi,PF=V([].concat),LF=IF("Reflect","ownKeys")||function(e){var t=OF.f(DF(e)),n=NF.f;return n?PF(t,n(e)):t},TR=Hn,kF=LF,xF=ze,MF=pr,p_={},UF=yR,VF=h_,eh=Object.keys||function(e){return UF(e,VF)},jF=qe,FF=iR,BF=pr,WF=wi,GF=po,HF=eh;p_.f=jF&&!FF?Object.defineProperties:function(e,t){WF(e);for(var n,i=GF(t),r=HF(t),s=r.length,o=0;s>o;)BF.f(e,n=r[o++],i[n]);return e};var th,vR=di("document","documentElement"),KF=wi,YF=p_,RR=h_,zF=$u,qF=vR,XF=qf,m_="prototype",f_="script",CR=Qu("IE_PROTO"),__=function(){},bR=function(e){return"<"+f_+">"+e+"</"+f_+">"},wR=function(e){e.write(bR("")),e.close();var t=e.parentWindow.Object;return e=null,t},nh=function(){try{th=new ActiveXObject("htmlfile")}catch{}var e,t,n;nh=typeof document<"u"?document.domain&&th?wR(th):(t=XF("iframe"),n="java"+f_+":",t.style.display="none",qF.appendChild(t),t.src=String(n),(e=t.contentWindow.document).open(),e.write(bR("document.F=Object")),e.close(),e.F):wR(th);for(var i=RR.length;i--;)delete nh[m_][RR[i]];return nh()};zF[CR]=!0;var tl=Object.create||function(e,t){var n;return e!==null?(__[m_]=KF(e),n=new __,__[m_]=null,n[CR]=e):n=nh(),t===void 0?n:YF.f(n,t)},JF=ei,QF=sa,AR=Error,ZF=V("".replace),$F=String(new AR("zxcasd").stack),IR=/\n\s*at [^:]*:[^\n]*/,eB=IR.test($F),tB=Vr,nB=!w((function(){var e=new Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",tB(1,7)),e.stack!==7)})),iB=sa,rB=function(e,t){if(eB&&typeof e=="string"&&!AR.prepareStackTrace)for(;t--;)e=ZF(e,IR,"");return e},sB=nB,OR=Error.captureStackTrace,Sc={},oB=Sc,aB=rn("iterator"),cB=Array.prototype,NR=function(e){return e!==void 0&&(oB.Array===e||cB[aB]===e)},dB=_o,DR=Xd,lB=Ws,uB=Sc,hB=rn("iterator"),ih=function(e){if(!lB(e))return DR(e,hB)||DR(e,"@@iterator")||uB[dB(e)]},pB=zt,mB=Ui,fB=wi,_B=mc,gB=ih,EB=TypeError,g_=function(e,t){var n=arguments.length<2?gB(e):t;if(mB(n))return fB(pB(n,e));throw new EB(_B(e)+" is not iterable")},SB=zt,PR=wi,yB=Xd,LR=function(e,t,n){var i,r;PR(e);try{if(!(i=yB(e,"return"))){if(t==="throw")throw n;return n}i=SB(i,e)}catch(s){r=!0,i=s}if(t==="throw")throw n;if(r)throw i;return PR(i),n},TB=mo,vB=zt,RB=wi,CB=mc,bB=NR,wB=fo,kR=W,AB=g_,IB=ih,xR=LR,OB=TypeError,rh=function(e,t){this.stopped=e,this.result=t},MR=rh.prototype,nl=function(e,t,n){var i,r,s,o,a,c,u,p=n&&n.that,m=!(!n||!n.AS_ENTRIES),_=!(!n||!n.IS_RECORD),g=!(!n||!n.IS_ITERATOR),b=!(!n||!n.INTERRUPTED),v=TB(t,p),R=function(D){return i&&xR(i,"normal"),new rh(!0,D)},O=function(D){return m?(RB(D),b?v(D[0],D[1],R):v(D[0],D[1])):b?v(D,R):v(D)};if(_)i=e.iterator;else if(g)i=e;else{if(!(r=IB(e)))throw new OB(CB(e)+" is not iterable");if(bB(r)){for(s=0,o=wB(e);o>s;s++)if((a=O(e[s]))&&kR(MR,a))return a;return new rh(!1)}i=AB(e,r)}for(c=_?e.next:i.next;!(u=vB(c,i)).done;){try{a=O(u.value)}catch(D){xR(i,"throw",D)}if(typeof a=="object"&&a&&kR(MR,a))return a}return new rh(!1)},NB=Ai,DB=pt,PB=W,LB=l_,sh=vF,kB=function(e,t,n){for(var i=kF(t),r=MF.f,s=xF.f,o=0;o<i.length;o++){var a=i[o];TR(e,a)||n&&TR(n,a)||r(e,a,s(t,a))}},UR=tl,E_=sa,S_=Vr,xB=function(e,t){JF(t)&&"cause"in t&&QF(e,"cause",t.cause)},MB=function(e,t,n,i){sB&&(OR?OR(e,t):iB(e,"stack",rB(n,i)))},UB=nl,VB=function(e,t){return e===void 0?arguments.length<2?"":t:NB(e)},jB=rn("toStringTag"),oh=Error,FB=[].push,yc=function(e,t){var n,i=PB(y_,this);sh?n=sh(new oh,i?LB(this):y_):(n=i?this:UR(y_),E_(n,jB,"Error")),t!==void 0&&E_(n,"message",VB(t)),MB(n,yc,n.stack,1),arguments.length>2&&xB(n,arguments[2]);var r=[];return UB(e,FB,{that:r}),E_(n,"errors",r),n};sh?sh(yc,oh):kB(yc,oh,{name:!0});var y_=yc.prototype=UR(oh.prototype,{constructor:S_(1,yc),message:S_(1,""),name:S_(1,"AggregateError")});DB({global:!0},{AggregateError:yc});var ah,il,ch,BB=kt,VR=X.WeakMap,WB=BB(VR)&&/native code/.test(String(VR)),jR=X,GB=ei,HB=sa,T_=Hn,v_=Gf,KB=Qu,YB=$u,FR="Object already initialized",R_=jR.TypeError,zB=jR.WeakMap;if(WB||v_.state){var ms=v_.state||(v_.state=new zB);ms.get=ms.get,ms.has=ms.has,ms.set=ms.set,ah=function(e,t){if(ms.has(e))throw new R_(FR);return t.facade=e,ms.set(e,t),t},il=function(e){return ms.get(e)||{}},ch=function(e){return ms.has(e)}}else{var Tc=KB("state");YB[Tc]=!0,ah=function(e,t){if(T_(e,Tc))throw new R_(FR);return t.facade=e,HB(e,Tc,t),t},il=function(e){return T_(e,Tc)?e[Tc]:{}},ch=function(e){return T_(e,Tc)}}var oa,BR,WR,aa={set:ah,get:il,has:ch,enforce:function(e){return ch(e)?il(e):ah(e,{})},getterFor:function(e){return function(t){var n;if(!GB(t)||(n=il(t)).type!==e)throw new R_("Incompatible receiver, "+e+" required");return n}}},C_=qe,qB=Hn,GR=Function.prototype,XB=C_&&Object.getOwnPropertyDescriptor,HR=qB(GR,"name"),KR={PROPER:HR&&(function(){}).name==="something",CONFIGURABLE:HR&&(!C_||C_&&XB(GR,"name").configurable)},JB=sa,go=function(e,t,n,i){return i&&i.enumerable?e[t]=n:JB(e,t,n),e},QB=w,ZB=kt,$B=ei,e3=tl,YR=l_,t3=go,b_=rn("iterator"),zR=!1;[].keys&&("next"in(WR=[].keys())?(BR=YR(YR(WR)))!==Object.prototype&&(oa=BR):zR=!0);var n3=!$B(oa)||QB((function(){var e={};return oa[b_].call(e)!==e}));ZB((oa=n3?{}:e3(oa))[b_])||t3(oa,b_,(function(){return this}));var qR={IteratorPrototype:oa,BUGGY_SAFARI_ITERATORS:zR},i3=_o,r3=i_?{}.toString:function(){return"[object "+i3(this)+"]"},s3=i_,o3=pr.f,a3=sa,c3=Hn,d3=r3,XR=rn("toStringTag"),Ks=function(e,t,n,i){var r=n?e:e&&e.prototype;r&&(c3(r,XR)||o3(r,XR,{configurable:!0,value:t}),i&&!s3&&a3(r,"toString",d3))},l3=qR.IteratorPrototype,u3=tl,h3=Vr,p3=Ks,m3=Sc,f3=function(){return this},w_=function(e,t,n,i){var r=t+" Iterator";return e.prototype=u3(l3,{next:h3(+!i,n)}),p3(e,r,!1,!0),m3[r]=f3,e},_3=pt,g3=zt,E3=KR,S3=w_,y3=l_,T3=Ks,JR=go,QR=Sc,v3=qR,R3=E3.PROPER,dh=v3.BUGGY_SAFARI_ITERATORS,A_=rn("iterator"),ZR="keys",lh="values",$R="entries",C3=function(){return this},eC=function(e,t,n,i,r,s,o){S3(n,t,i);var a,c,u,p=function(O){if(O===r&&v)return v;if(!dh&&O&&O in g)return g[O];switch(O){case ZR:case lh:case $R:return function(){return new n(this,O)}}return function(){return new n(this)}},m=t+" Iterator",_=!1,g=e.prototype,b=g[A_]||g["@@iterator"]||r&&g[r],v=!dh&&b||p(r),R=t==="Array"&&g.entries||b;if(R&&(a=y3(R.call(new e)))!==Object.prototype&&a.next&&(T3(a,m,!0,!0),QR[m]=C3),R3&&r===lh&&b&&b.name!==lh&&(_=!0,v=function(){return g3(b,this)}),r)if(c={values:p(lh),keys:s?v:p(ZR),entries:p($R)},o)for(u in c)(dh||_||!(u in g))&&JR(g,u,c[u]);else _3({target:t,proto:!0,forced:dh||_},c);return o&&g[A_]!==v&&JR(g,A_,v,{}),QR[t]=v,c},uh=function(e,t){return{value:e,done:t}},b3=po,tC=Sc,nC=aa;pr.f;var w3=eC,hh=uh,iC="Array Iterator",A3=nC.set,I3=nC.getterFor(iC);w3(Array,"Array",(function(e,t){A3(this,{type:iC,target:b3(e),index:0,kind:t})}),(function(){var e=I3(this),t=e.target,n=e.index++;if(!t||n>=t.length)return e.target=null,hh(void 0,!0);switch(e.kind){case"keys":return hh(n,!1);case"values":return hh(t[n],!1)}return hh([n,t[n]],!1)}),"values"),tC.Arguments=tC.Array;var O3=pr,ph=function(e,t,n){return O3.f(e,t,n)},N3=di,D3=ph,P3=qe,rC=rn("species"),L3=W,k3=TypeError,I_=function(e,t){if(L3(t,e))return e;throw new k3("Incorrect invocation")},x3=kt,O_=Gf,M3=V(Function.toString);x3(O_.inspectSource)||(O_.inspectSource=function(e){return M3(e)});var sC=O_.inspectSource,U3=V,V3=w,oC=kt,j3=_o,F3=sC,aC=function(){},cC=di("Reflect","construct"),N_=/^\s*(?:class|function)\b/,B3=U3(N_.exec),W3=!N_.test(aC),rl=function(e){if(!oC(e))return!1;try{return cC(aC,[],e),!0}catch{return!1}},dC=function(e){if(!oC(e))return!1;switch(j3(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return W3||!!B3(N_,F3(e))}catch{return!0}};dC.sham=!0;var sl,vc,lC,D_,mh=!cC||V3((function(){var e;return rl(rl.call)||!rl(Object)||!rl((function(){e=!0}))||e}))?dC:rl,G3=mh,H3=mc,K3=TypeError,uC=wi,Y3=function(e){if(G3(e))return e;throw new K3(H3(e)+" is not a constructor")},z3=Ws,q3=rn("species"),P_=function(e,t){var n,i=uC(e).constructor;return i===void 0||z3(n=uC(i)[q3])?t:Y3(n)},Eo=V([].slice),X3=TypeError,ca=function(e,t){if(e<t)throw new X3("Not enough arguments");return e},hC=/(?:ipad|iphone|ipod).*applewebkit/i.test(Hs),er=X,J3=pe,Q3=mo,pC=kt,Z3=Hn,mC=w,fC=vR,$3=Eo,_C=qf,e5=ca,t5=hC,n5=Ju,L_=er.setImmediate,k_=er.clearImmediate,i5=er.process,x_=er.Dispatch,r5=er.Function,gC=er.MessageChannel,s5=er.String,M_=0,ol={},EC="onreadystatechange";mC((function(){sl=er.location}));var U_=function(e){if(Z3(ol,e)){var t=ol[e];delete ol[e],t()}},V_=function(e){return function(){U_(e)}},SC=function(e){U_(e.data)},yC=function(e){er.postMessage(s5(e),sl.protocol+"//"+sl.host)};L_&&k_||(L_=function(e){e5(arguments.length,1);var t=pC(e)?e:r5(e),n=$3(arguments,1);return ol[++M_]=function(){J3(t,void 0,n)},vc(M_),M_},k_=function(e){delete ol[e]},n5?vc=function(e){i5.nextTick(V_(e))}:x_&&x_.now?vc=function(e){x_.now(V_(e))}:gC&&!t5?(D_=(lC=new gC).port2,lC.port1.onmessage=SC,vc=Q3(D_.postMessage,D_)):er.addEventListener&&pC(er.postMessage)&&!er.importScripts&&sl&&sl.protocol!=="file:"&&!mC(yC)?(vc=yC,er.addEventListener("message",SC,!1)):vc=EC in _C("script")?function(e){fC.appendChild(_C("script"))[EC]=function(){fC.removeChild(this),U_(e)}}:function(e){setTimeout(V_(e),0)});var fh={set:L_,clear:k_},TC=X,o5=qe,a5=Object.getOwnPropertyDescriptor,vC=function(e){if(!o5)return TC[e];var t=a5(TC,e);return t&&t.value},RC=function(){this.head=null,this.tail=null};RC.prototype={add:function(e){var t={item:e,next:null},n=this.tail;n?n.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return(this.head=e.next)===null&&(this.tail=null),e.item}};var Rc,j_,F_,B_,CC,bC=RC,c5=/ipad|iphone|ipod/i.test(Hs)&&typeof Pebble<"u",d5=/web0s(?!.*chrome)/i.test(Hs),Cc=X,l5=vC,wC=mo,W_=fh.set,u5=bC,h5=hC,p5=c5,m5=d5,G_=Ju,AC=Cc.MutationObserver||Cc.WebKitMutationObserver,IC=Cc.document,OC=Cc.process,_h=Cc.Promise,H_=l5("queueMicrotask");if(!H_){var gh=new u5,Eh=function(){var e,t;for(G_&&(e=OC.domain)&&e.exit();t=gh.get();)try{t()}catch(n){throw gh.head&&Rc(),n}e&&e.enter()};h5||G_||m5||!AC||!IC?!p5&&_h&&_h.resolve?((B_=_h.resolve(void 0)).constructor=_h,CC=wC(B_.then,B_),Rc=function(){CC(Eh)}):G_?Rc=function(){OC.nextTick(Eh)}:(W_=wC(W_,Cc),Rc=function(){W_(Eh)}):(j_=!0,F_=IC.createTextNode(""),new AC(Eh).observe(F_,{characterData:!0}),Rc=function(){F_.data=j_=!j_}),H_=function(e){gh.head||Rc(),gh.add(e)}}var NC=H_,bc=function(e){try{return{error:!1,value:e()}}catch(t){return{error:!0,value:t}}},da=X.Promise,f5=X,al=da,_5=kt,g5=nR,E5=sC,S5=rn,DC=o_,K_=ra,PC=al&&al.prototype,y5=S5("species"),LC=_5(f5.PromiseRejectionEvent),T5=g5("Promise",(function(){var e=E5(al),t=e!==String(al);if(!t&&K_===66||!PC.catch||!PC.finally)return!0;if(!K_||K_<51||!/native code/.test(e)){var n=new al((function(r){r(1)})),i=function(r){r((function(){}),(function(){}))};if((n.constructor={})[y5]=i,!(n.then((function(){}))instanceof i))return!0}return!(t||DC!=="BROWSER"&&DC!=="DENO"||LC)})),cl={CONSTRUCTOR:T5,REJECTION_EVENT:LC},fs={},kC=Ui,v5=TypeError,R5=function(e){var t,n;this.promise=new e((function(i,r){if(t!==void 0||n!==void 0)throw new v5("Bad Promise constructor");t=i,n=r})),this.resolve=kC(t),this.reject=kC(n)};fs.f=function(e){return new R5(e)};var Y_,xC,MC,C5=pt,Sh=Ju,So=X,b5=Mi,dl=zt,w5=go,A5=Ks,I5=function(e){var t=N3(e);P3&&t&&!t[rC]&&D3(t,rC,{configurable:!0,get:function(){return this}})},O5=Ui,z_=kt,N5=ei,D5=I_,P5=P_,UC=fh.set,q_=NC,L5=function(e,t){try{arguments.length===1?console.error(e):console.error(e,t)}catch{}},k5=bc,x5=bC,VC=aa,X_=da,jC=cl,FC=fs,yh="Promise",BC=jC.CONSTRUCTOR,M5=jC.REJECTION_EVENT,J_=VC.getterFor(yh),U5=VC.set,V5=X_&&X_.prototype,ll=X_,Q_=V5,WC=So.TypeError,Z_=So.document,$_=So.process,eg=FC.f,j5=eg,F5=!!(Z_&&Z_.createEvent&&So.dispatchEvent),GC="unhandledrejection",HC=function(e){var t;return!(!N5(e)||!z_(t=e.then))&&t},KC=function(e,t){var n,i,r,s=t.value,o=t.state===1,a=o?e.ok:e.fail,c=e.resolve,u=e.reject,p=e.domain;try{a?(o||(t.rejection===2&&W5(t),t.rejection=1),a===!0?n=s:(p&&p.enter(),n=a(s),p&&(p.exit(),r=!0)),n===e.promise?u(new WC("Promise-chain cycle")):(i=HC(n))?dl(i,n,c,u):c(n)):u(s)}catch(m){p&&!r&&p.exit(),u(m)}},YC=function(e,t){e.notified||(e.notified=!0,q_((function(){for(var n,i=e.reactions;n=i.get();)KC(n,e);e.notified=!1,t&&!e.rejection&&B5(e)})))},zC=function(e,t,n){var i,r;F5?((i=Z_.createEvent("Event")).promise=t,i.reason=n,i.initEvent(e,!1,!0),So.dispatchEvent(i)):i={promise:t,reason:n},!M5&&(r=So["on"+e])?r(i):e===GC&&L5("Unhandled promise rejection",n)},B5=function(e){dl(UC,So,(function(){var t,n=e.facade,i=e.value;if(qC(e)&&(t=k5((function(){Sh?$_.emit("unhandledRejection",i,n):zC(GC,n,i)})),e.rejection=Sh||qC(e)?2:1,t.error))throw t.value}))},qC=function(e){return e.rejection!==1&&!e.parent},W5=function(e){dl(UC,So,(function(){var t=e.facade;Sh?$_.emit("rejectionHandled",t):zC("rejectionhandled",t,e.value)}))},wc=function(e,t,n){return function(i){e(t,i,n)}},Ac=function(e,t,n){e.done||(e.done=!0,n&&(e=n),e.value=t,e.state=2,YC(e,!0))},tg=function(e,t,n){if(!e.done){e.done=!0,n&&(e=n);try{if(e.facade===t)throw new WC("Promise can't be resolved itself");var i=HC(t);i?q_((function(){var r={done:!1};try{dl(i,t,wc(tg,r,e),wc(Ac,r,e))}catch(s){Ac(r,s,e)}})):(e.value=t,e.state=1,YC(e,!1))}catch(r){Ac({done:!1},r,e)}}};BC&&(Q_=(ll=function(e){D5(this,Q_),O5(e),dl(Y_,this);var t=J_(this);try{e(wc(tg,t),wc(Ac,t))}catch(n){Ac(t,n)}}).prototype,(Y_=function(e){U5(this,{type:yh,done:!1,notified:!1,parent:!1,reactions:new x5,rejection:!1,state:0,value:null})}).prototype=w5(Q_,"then",(function(e,t){var n=J_(this),i=eg(P5(this,ll));return n.parent=!0,i.ok=!z_(e)||e,i.fail=z_(t)&&t,i.domain=Sh?$_.domain:void 0,n.state===0?n.reactions.add(i):q_((function(){KC(i,n)})),i.promise})),xC=function(){var e=new Y_,t=J_(e);this.promise=e,this.resolve=wc(tg,t),this.reject=wc(Ac,t)},FC.f=eg=function(e){return e===ll||e===MC?new xC(e):j5(e)}),C5({global:!0,wrap:!0,forced:BC},{Promise:ll}),MC=b5.Promise,A5(ll,yh,!1,!0),I5(yh);var XC=rn("iterator"),JC=!1;try{var G5=0,QC={next:function(){return{done:!!G5++}},return:function(){JC=!0}};QC[XC]=function(){return this},Array.from(QC,(function(){throw 2}))}catch{}var H5=da,K5=function(e,t){try{if(!t&&!JC)return!1}catch{return!1}var n=!1;try{var i={};i[XC]=function(){return{next:function(){return{done:n=!0}}}},e(i)}catch{}return n},Th=cl.CONSTRUCTOR||!K5((function(e){H5.all(e).then(void 0,(function(){}))})),Y5=zt,z5=Ui,q5=fs,X5=bc,J5=nl;pt({target:"Promise",stat:!0,forced:Th},{all:function(e){var t=this,n=q5.f(t),i=n.resolve,r=n.reject,s=X5((function(){var o=z5(t.resolve),a=[],c=0,u=1;J5(e,(function(p){var m=c++,_=!1;u++,Y5(o,t,p).then((function(g){_||(_=!0,a[m]=g,--u||i(a))}),r)})),--u||i(a)}));return s.error&&r(s.value),n.promise}});var Q5=pt,Z5=cl.CONSTRUCTOR;da&&da.prototype,Q5({target:"Promise",proto:!0,forced:Z5,real:!0},{catch:function(e){return this.then(void 0,e)}});var $5=zt,eW=Ui,tW=fs,nW=bc,iW=nl;pt({target:"Promise",stat:!0,forced:Th},{race:function(e){var t=this,n=tW.f(t),i=n.reject,r=nW((function(){var s=eW(t.resolve);iW(e,(function(o){$5(s,t,o).then(n.resolve,i)}))}));return r.error&&i(r.value),n.promise}});var rW=fs;pt({target:"Promise",stat:!0,forced:cl.CONSTRUCTOR},{reject:function(e){var t=rW.f(this);return(0,t.reject)(e),t.promise}});var sW=wi,oW=ei,aW=fs,ZC=function(e,t){if(sW(e),oW(t)&&t.constructor===e)return t;var n=aW.f(e);return(0,n.resolve)(t),n.promise},cW=pt,dW=da,lW=cl.CONSTRUCTOR,uW=ZC,hW=di("Promise"),pW=!lW;cW({target:"Promise",stat:!0,forced:!0},{resolve:function(e){return uW(pW&&this===hW?dW:this,e)}});var mW=zt,fW=Ui,_W=fs,gW=bc,EW=nl;pt({target:"Promise",stat:!0,forced:Th},{allSettled:function(e){var t=this,n=_W.f(t),i=n.resolve,r=n.reject,s=gW((function(){var o=fW(t.resolve),a=[],c=0,u=1;EW(e,(function(p){var m=c++,_=!1;u++,mW(o,t,p).then((function(g){_||(_=!0,a[m]={status:"fulfilled",value:g},--u||i(a))}),(function(g){_||(_=!0,a[m]={status:"rejected",reason:g},--u||i(a))}))})),--u||i(a)}));return s.error&&r(s.value),n.promise}});var SW=zt,yW=Ui,TW=di,vW=fs,RW=bc,CW=nl,$C="No one promise resolved";pt({target:"Promise",stat:!0,forced:Th},{any:function(e){var t=this,n=TW("AggregateError"),i=vW.f(t),r=i.resolve,s=i.reject,o=RW((function(){var a=yW(t.resolve),c=[],u=0,p=1,m=!1;CW(e,(function(_){var g=u++,b=!1;p++,SW(a,t,_).then((function(v){b||m||(m=!0,r(v))}),(function(v){b||m||(b=!0,c[g]=v,--p||s(new n(c,$C)))}))})),--p||s(new n(c,$C))}));return o.error&&s(o.value),i.promise}});var bW=pt,wW=pe,AW=Eo,IW=fs,OW=Ui,eb=bc,ng=X.Promise,tb=!1;bW({target:"Promise",stat:!0,forced:!ng||!ng.try||eb((function(){ng.try((function(e){tb=e===8}),8)})).error||!tb},{try:function(e){var t=arguments.length>1?AW(arguments,1):[],n=IW.f(this),i=eb((function(){return wW(OW(e),void 0,t)}));return(i.error?n.reject:n.resolve)(i.value),n.promise}});var NW=fs;pt({target:"Promise",stat:!0},{withResolvers:function(){var e=NW.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var DW=pt,ig=da,PW=w,LW=di,kW=kt,xW=P_,nb=ZC,MW=ig&&ig.prototype;DW({target:"Promise",proto:!0,real:!0,forced:!!ig&&PW((function(){MW.finally.call({then:function(){}},(function(){}))}))},{finally:function(e){var t=xW(this,LW("Promise")),n=kW(e);return this.then(n?function(i){return nb(t,e()).then((function(){return i}))}:e,n?function(i){return nb(t,e()).then((function(){throw i}))}:e)}});var rg=V,UW=$f,VW=Ai,jW=ho,FW=rg("".charAt),ib=rg("".charCodeAt),BW=rg("".slice),rb=function(e){return function(t,n){var i,r,s=VW(jW(t)),o=UW(n),a=s.length;return o<0||o>=a?e?"":void 0:(i=ib(s,o))<55296||i>56319||o+1===a||(r=ib(s,o+1))<56320||r>57343?e?FW(s,o):i:e?BW(s,o,o+2):r-56320+(i-55296<<10)+65536}},sg={codeAt:rb(!1),charAt:rb(!0)},WW=sg.charAt,GW=Ai,sb=aa,HW=eC,ob=uh,ab="String Iterator",KW=sb.set,YW=sb.getterFor(ab);HW(String,"String",(function(e){KW(this,{type:ab,string:GW(e),index:0})}),(function(){var e,t=YW(this),n=t.string,i=t.index;return i>=n.length?ob(void 0,!0):(e=WW(n,i),t.index+=e.length,ob(e,!1))}));var zW=Mi.Promise,qW={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},XW=X,JW=Ks,cb=Sc;for(var og in qW)JW(XW[og],og),cb[og]=cb.Array;var db=zW,de=y(db),QW=Zi("Array","values"),ZW=_o,$W=Hn,eG=W,tG=QW,ag=Array.prototype,nG={DOMTokenList:!0,NodeList:!0},iG=function(e){var t=e.values;return e===ag||eG(ag,e)&&t===ag.values||$W(nG,ZW(e))?tG:t},Ii=y(iG),lb=mc,rG=TypeError,ub=Eo,sG=Math.floor,cg=function(e,t){var n=e.length;if(n<8)for(var i,r,s=1;s<n;){for(r=s,i=e[s];r&&t(e[r-1],i)>0;)e[r]=e[--r];r!==s++&&(e[r]=i)}else for(var o=sG(n/2),a=cg(ub(e,0,o),t),c=cg(ub(e,o),t),u=a.length,p=c.length,m=0,_=0;m<u||_<p;)e[m+_]=m<u&&_<p?t(a[m],c[_])<=0?a[m++]:c[_++]:m<u?a[m++]:c[_++];return e},hb=cg,pb=Hs.match(/firefox\/(\d+)/i),oG=!!pb&&+pb[1],aG=/MSIE|Trident/.test(Hs),mb=Hs.match(/AppleWebKit\/(\d+)\./),cG=!!mb&&+mb[1],dG=pt,fb=V,lG=Ui,uG=ps,_b=fo,hG=function(e,t){if(!delete e[t])throw new rG("Cannot delete property "+lb(t)+" of "+lb(e))},gb=Ai,dg=w,pG=hb,mG=qu,Eb=oG,fG=aG,Sb=ra,yb=cG,yo=[],Tb=fb(yo.sort),_G=fb(yo.push),gG=dg((function(){yo.sort(void 0)})),EG=dg((function(){yo.sort(null)})),SG=mG("sort"),vb=!dg((function(){if(Sb)return Sb<70;if(!(Eb&&Eb>3)){if(fG)return!0;if(yb)return yb<603;var e,t,n,i,r="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(i=0;i<47;i++)yo.push({k:t+i,v:n})}for(yo.sort((function(s,o){return o.v-s.v})),i=0;i<yo.length;i++)t=yo[i].k.charAt(0),r.charAt(r.length-1)!==t&&(r+=t);return r!=="DGBEFHACIJK"}}));dG({target:"Array",proto:!0,forced:gG||!EG||!SG||!vb},{sort:function(e){e!==void 0&&lG(e);var t=uG(this);if(vb)return e===void 0?Tb(t):Tb(t,e);var n,i,r=[],s=_b(t);for(i=0;i<s;i++)i in t&&_G(r,t[i]);for(pG(r,(function(o){return function(a,c){return c===void 0?-1:a===void 0?1:o!==void 0?+o(a,c)||0:gb(a)>gb(c)?1:-1}})(e)),n=_b(r),i=0;i<n;)t[i]=r[i++];for(;i<s;)hG(t,i++);return t}});var yG=Zi("Array","sort"),TG=W,vG=yG,lg=Array.prototype,RG=function(e){var t=e.sort;return e===lg||TG(lg,e)&&t===lg.sort?vG:t},la=y(RG),CG=pt,bG=V,wG=e_,AG=RangeError,Rb=String.fromCharCode,Cb=String.fromCodePoint,IG=bG([].join);CG({target:"String",stat:!0,forced:!!Cb&&Cb.length!==1},{fromCodePoint:function(e){for(var t,n=[],i=arguments.length,r=0;i>r;){if(t=+arguments[r++],wG(t,1114111)!==t)throw new AG(t+" is not a valid code point");n[r]=t<65536?Rb(t):Rb(55296+((t-=65536)>>10),t%1024+56320)}return IG(n,"")}});var OG=w,NG=rn("iterator"),vh=!OG((function(){var e=new URL("b?a=1&b=2&c=3","https://a"),t=e.searchParams,n=new URLSearchParams("a=1&a=2&b=3"),i="";return e.pathname="c%20d",t.forEach((function(r,s){t.delete("b"),i+=s+r})),n.delete("a",2),n.delete("b",void 0),!e.toJSON||!n.has("a",1)||n.has("a",2)||!n.has("a",void 0)||n.has("b")||!t.size&&!0||!t.sort||e.href!=="https://a/c%20d?a=1&c=3"||t.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!t[NG]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://").host!=="xn--e1aybc"||new URL("https://a#").hash!=="#%D0%B1"||i!=="a1c3"||new URL("https://x",void 0).host!=="x"})),DG=go,ug=pt,bb=X,hg=vC,PG=di,Rh=zt,jr=V,ul=qe,wb=vh,Ab=go,LG=ph,kG=function(e,t,n){for(var i in t)n&&n.unsafe&&e[i]?e[i]=t[i]:DG(e,i,t[i],n);return e},xG=Ks,MG=w_,pg=aa,Ib=I_,mg=kt,UG=Hn,VG=mo,jG=_o,FG=wi,Ob=ei,Oi=Ai,BG=tl,Nb=Vr,Db=g_,WG=ih,Ch=uh,Ic=ca,GG=hb,HG=rn("iterator"),Oc="URLSearchParams",Pb=Oc+"Iterator",Lb=pg.set,mr=pg.getterFor(Oc),KG=pg.getterFor(Pb),kb=hg("fetch"),bh=hg("Request"),hl=hg("Headers"),fg=bh&&bh.prototype,xb=hl&&hl.prototype,YG=bb.TypeError,zG=bb.encodeURIComponent,qG=String.fromCharCode,XG=PG("String","fromCodePoint"),JG=parseInt,wh=jr("".charAt),Mb=jr([].join),To=jr([].push),Ub=jr("".replace),QG=jr([].shift),Vb=jr([].splice),jb=jr("".split),Fb=jr("".slice),ZG=jr(/./.exec),$G=/\+/g,e4=/^[0-9a-f]+$/i,Bb=function(e,t){var n=Fb(e,t,t+2);return ZG(e4,n)?JG(n,16):NaN},t4=function(e){for(var t=0,n=128;n>0&&(e&n)!=0;n>>=1)t++;return t},n4=function(e){var t=null;switch(e.length){case 1:t=e[0];break;case 2:t=(31&e[0])<<6|63&e[1];break;case 3:t=(15&e[0])<<12|(63&e[1])<<6|63&e[2];break;case 4:t=(7&e[0])<<18|(63&e[1])<<12|(63&e[2])<<6|63&e[3]}return t>1114111?null:t},Wb=function(e){for(var t=(e=Ub(e,$G," ")).length,n="",i=0;i<t;){var r=wh(e,i);if(r==="%"){if(wh(e,i+1)==="%"||i+3>t){n+="%",i++;continue}var s=Bb(e,i+1);if(s!=s){n+=r,i++;continue}i+=2;var o=t4(s);if(o===0)r=qG(s);else{if(o===1||o>4){n+="",i++;continue}for(var a=[s],c=1;c<o&&!(++i+3>t||wh(e,i)!=="%");){var u=Bb(e,i+1);if(u!=u){i+=3;break}if(u>191||u<128)break;To(a,u),i+=2,c++}if(a.length!==o){n+="";continue}var p=n4(a);p===null?n+="":r=XG(p)}}n+=r,i++}return n},i4=/[!'()~]|%20/g,r4={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},s4=function(e){return r4[e]},Gb=function(e){return Ub(zG(e),i4,s4)},_g=MG((function(e,t){Lb(this,{type:Pb,target:mr(e).entries,index:0,kind:t})}),Oc,(function(){var e=KG(this),t=e.target,n=e.index++;if(!t||n>=t.length)return e.target=null,Ch(void 0,!0);var i=t[n];switch(e.kind){case"keys":return Ch(i.key,!1);case"values":return Ch(i.value,!1)}return Ch([i.key,i.value],!1)}),!0),Hb=function(e){this.entries=[],this.url=null,e!==void 0&&(Ob(e)?this.parseObject(e):this.parseQuery(typeof e=="string"?wh(e,0)==="?"?Fb(e,1):e:Oi(e)))};Hb.prototype={type:Oc,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,n,i,r,s,o,a,c=this.entries,u=WG(e);if(u)for(n=(t=Db(e,u)).next;!(i=Rh(n,t)).done;){if(s=(r=Db(FG(i.value))).next,(o=Rh(s,r)).done||(a=Rh(s,r)).done||!Rh(s,r).done)throw new YG("Expected sequence with length 2");To(c,{key:Oi(o.value),value:Oi(a.value)})}else for(var p in e)UG(e,p)&&To(c,{key:p,value:Oi(e[p])})},parseQuery:function(e){if(e)for(var t,n,i=this.entries,r=jb(e,"&"),s=0;s<r.length;)(t=r[s++]).length&&(n=jb(t,"="),To(i,{key:Wb(QG(n)),value:Wb(Mb(n,"="))}))},serialize:function(){for(var e,t=this.entries,n=[],i=0;i<t.length;)e=t[i++],To(n,Gb(e.key)+"="+Gb(e.value));return Mb(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Ah=function(){Ib(this,Nc);var e=Lb(this,new Hb(arguments.length>0?arguments[0]:void 0));ul||(this.size=e.entries.length)},Nc=Ah.prototype;if(kG(Nc,{append:function(e,t){var n=mr(this);Ic(arguments.length,2),To(n.entries,{key:Oi(e),value:Oi(t)}),ul||this.length++,n.updateURL()},delete:function(e){for(var t=mr(this),n=Ic(arguments.length,1),i=t.entries,r=Oi(e),s=n<2?void 0:arguments[1],o=s===void 0?s:Oi(s),a=0;a<i.length;){var c=i[a];if(c.key!==r||o!==void 0&&c.value!==o)a++;else if(Vb(i,a,1),o!==void 0)break}ul||(this.size=i.length),t.updateURL()},get:function(e){var t=mr(this).entries;Ic(arguments.length,1);for(var n=Oi(e),i=0;i<t.length;i++)if(t[i].key===n)return t[i].value;return null},getAll:function(e){var t=mr(this).entries;Ic(arguments.length,1);for(var n=Oi(e),i=[],r=0;r<t.length;r++)t[r].key===n&&To(i,t[r].value);return i},has:function(e){for(var t=mr(this).entries,n=Ic(arguments.length,1),i=Oi(e),r=n<2?void 0:arguments[1],s=r===void 0?r:Oi(r),o=0;o<t.length;){var a=t[o++];if(a.key===i&&(s===void 0||a.value===s))return!0}return!1},set:function(e,t){var n=mr(this);Ic(arguments.length,1);for(var i,r=n.entries,s=!1,o=Oi(e),a=Oi(t),c=0;c<r.length;c++)(i=r[c]).key===o&&(s?Vb(r,c--,1):(s=!0,i.value=a));s||To(r,{key:o,value:a}),ul||(this.size=r.length),n.updateURL()},sort:function(){var e=mr(this);GG(e.entries,(function(t,n){return t.key>n.key?1:-1})),e.updateURL()},forEach:function(e){for(var t,n=mr(this).entries,i=VG(e,arguments.length>1?arguments[1]:void 0),r=0;r<n.length;)i((t=n[r++]).value,t.key,this)},keys:function(){return new _g(this,"keys")},values:function(){return new _g(this,"values")},entries:function(){return new _g(this,"entries")}},{enumerable:!0}),Ab(Nc,HG,Nc.entries,{}),Ab(Nc,"toString",(function(){return mr(this).serialize()}),{enumerable:!0}),ul&&LG(Nc,"size",{get:function(){return mr(this).entries.length},configurable:!0,enumerable:!0}),xG(Ah,Oc),ug({global:!0,forced:!wb},{URLSearchParams:Ah}),!wb&&mg(hl)){var o4=jr(xb.has),a4=jr(xb.set),Kb=function(e){if(Ob(e)){var t,n=e.body;if(jG(n)===Oc)return t=e.headers?new hl(e.headers):new hl,o4(t,"content-type")||a4(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),BG(e,{body:Nb(0,Oi(n)),headers:Nb(0,t)})}return e};if(mg(kb)&&ug({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return kb(e,arguments.length>1?Kb(arguments[1]):{})}}),mg(bh)){var gg=function(e){return Ib(this,fg),new bh(e,arguments.length>1?Kb(arguments[1]):{})};fg.constructor=gg,gg.prototype=fg,ug({global:!0,dontCallGetSet:!0,forced:!0},{Request:gg})}}var fr,c4={URLSearchParams:Ah,getState:mr},d4=Mi.URLSearchParams,Yb=qe,l4=V,u4=zt,h4=w,Eg=eh,p4=el,m4=hs,f4=ps,_4=uo,Dc=Object.assign,zb=Object.defineProperty,g4=l4([].concat),E4=!Dc||h4((function(){if(Yb&&Dc({b:1},Dc(zb({},"a",{enumerable:!0,get:function(){zb(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var e={},t={},n=Symbol("assign detection"),i="abcdefghijklmnopqrst";return e[n]=7,i.split("").forEach((function(r){t[r]=r})),Dc({},e)[n]!==7||Eg(Dc({},t)).join("")!==i}))?function(e,t){for(var n=f4(e),i=arguments.length,r=1,s=p4.f,o=m4.f;i>r;)for(var a,c=_4(arguments[r++]),u=s?g4(Eg(c),s(c)):Eg(c),p=u.length,m=0;p>m;)a=u[m++],Yb&&!u4(o,c,a)||(n[a]=c[a]);return n}:Dc,S4=wi,y4=LR,T4=qe,v4=pr,R4=Vr,Sg=function(e,t,n){T4?v4.f(e,t,R4(0,n)):e[t]=n},C4=mo,b4=zt,w4=ps,A4=function(e,t,n,i){try{return i?t(S4(n)[0],n[1]):t(n)}catch(r){y4(e,"throw",r)}},I4=NR,O4=mh,N4=fo,qb=Sg,D4=g_,P4=ih,Xb=Array,ua=V,yg=2147483647,L4=/[^\0-\u007E]/,Jb=/[.\u3002\uFF0E\uFF61]/g,Qb="Overflow: input needs wider integers to process",Zb=RangeError,k4=ua(Jb.exec),Pc=Math.floor,Tg=String.fromCharCode,$b=ua("".charCodeAt),ew=ua([].join),vo=ua([].push),x4=ua("".replace),M4=ua("".split),U4=ua("".toLowerCase),tw=function(e){return e+22+75*(e<26)},V4=function(e,t,n){var i=0;for(e=n?Pc(e/700):e>>1,e+=Pc(e/t);e>455;)e=Pc(e/35),i+=36;return Pc(i+36*e/(e+38))},j4=function(e){var t=[];e=(function(O){for(var D=[],x=0,B=O.length;x<B;){var G=$b(O,x++);if(G>=55296&&G<=56319&&x<B){var j=$b(O,x++);(64512&j)==56320?vo(D,((1023&G)<<10)+(1023&j)+65536):(vo(D,G),x--)}else vo(D,G)}return D})(e);var n,i,r=e.length,s=128,o=0,a=72;for(n=0;n<e.length;n++)(i=e[n])<128&&vo(t,Tg(i));var c=t.length,u=c;for(c&&vo(t,"-");u<r;){var p=yg;for(n=0;n<e.length;n++)(i=e[n])>=s&&i<p&&(p=i);var m=u+1;if(p-s>Pc((yg-o)/m))throw new Zb(Qb);for(o+=(p-s)*m,s=p,n=0;n<e.length;n++){if((i=e[n])<s&&++o>yg)throw new Zb(Qb);if(i===s){for(var _=o,g=36;;){var b=g<=a?1:g>=a+26?26:g-a;if(_<b)break;var v=_-b,R=36-b;vo(t,Tg(tw(b+v%R))),_=Pc(v/R),g+=36}vo(t,Tg(tw(_))),a=V4(o,m,u===c),o=0,u++}}o++,s++}return ew(t,"")},F4=pt,vg=qe,B4=vh,Rg=X,nw=mo,_r=V,Ih=go,gr=ph,W4=I_,Cg=Hn,bg=E4,Lc=function(e){var t=w4(e),n=O4(this),i=arguments.length,r=i>1?arguments[1]:void 0,s=r!==void 0;s&&(r=C4(r,i>2?arguments[2]:void 0));var o,a,c,u,p,m,_=P4(t),g=0;if(!_||this===Xb&&I4(_))for(o=N4(t),a=n?new this(o):Xb(o);o>g;g++)m=s?r(t[g],g):t[g],qb(a,g,m);else for(a=n?new this:[],p=(u=D4(t,_)).next;!(c=b4(p,u)).done;g++)m=s?A4(u,r,[c.value,g],!0):c.value,qb(a,g,m);return a.length=g,a},Fr=Eo,G4=sg.codeAt,H4=function(e){var t,n,i=[],r=M4(x4(U4(e),Jb,"."),".");for(t=0;t<r.length;t++)n=r[t],vo(i,k4(L4,n)?"xn--"+j4(n):n);return ew(i,".")},Ys=Ai,K4=Ks,Y4=ca,iw=c4,rw=aa,z4=rw.set,Oh=rw.getterFor("URL"),q4=iw.URLSearchParams,X4=iw.getState,pl=Rg.URL,wg=Rg.TypeError,Nh=Rg.parseInt,J4=Math.floor,sw=Math.pow,Er=_r("".charAt),Br=_r(/./.exec),ml=_r([].join),Q4=_r(1.1.toString),Z4=_r([].pop),kc=_r([].push),Ag=_r("".replace),$4=_r([].shift),e6=_r("".split),fl=_r("".slice),Dh=_r("".toLowerCase),t6=_r([].unshift),Ig="Invalid scheme",ha="Invalid host",ow="Invalid port",aw=/[a-z]/i,n6=/[\d+-.a-z]/i,Og=/\d/,i6=/^0x/i,r6=/^[0-7]+$/,s6=/^\d+$/,cw=/^[\da-f]+$/i,o6=/[\0\t\n\r #%/:<>?@[\\\]^|]/,a6=/[\0\t\n\r #/:<>?@[\\\]^|]/,c6=/^[\u0000-\u0020]+/,d6=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,l6=/[\t\n\r]/g,_l=function(e){var t,n,i,r;if(typeof e=="number"){for(t=[],n=0;n<4;n++)t6(t,e%256),e=J4(e/256);return ml(t,".")}if(typeof e=="object"){for(t="",i=(function(s){for(var o=null,a=1,c=null,u=0,p=0;p<8;p++)s[p]!==0?(u>a&&(o=c,a=u),c=null,u=0):(c===null&&(c=p),++u);return u>a?c:o})(e),n=0;n<8;n++)r&&e[n]===0||(r&&(r=!1),i===n?(t+=n?":":"::",r=!0):(t+=Q4(e[n],16),n<7&&(t+=":")));return"["+t+"]"}return e},Ph={},dw=bg({},Ph,{" ":1,'"':1,"<":1,">":1,"`":1}),lw=bg({},dw,{"#":1,"?":1,"{":1,"}":1}),Ng=bg({},lw,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),Ro=function(e,t){var n=G4(e,0);return n>32&&n<127&&!Cg(t,e)?e:encodeURIComponent(e)},Lh={ftp:21,file:null,http:80,https:443,ws:80,wss:443},gl=function(e,t){var n;return e.length===2&&Br(aw,Er(e,0))&&((n=Er(e,1))===":"||!t&&n==="|")},uw=function(e){var t;return e.length>1&&gl(fl(e,0,2))&&(e.length===2||(t=Er(e,2))==="/"||t==="\\"||t==="?"||t==="#")},u6=function(e){return e==="."||Dh(e)==="%2e"},Dg={},hw={},Pg={},pw={},mw={},Lg={},fw={},_w={},kh={},xh={},kg={},xg={},Mg={},Ug={},gw={},Vg={},xc={},_s={},Ew={},pa={},zs={},jg=function(e,t,n){var i,r,s,o=Ys(e);if(t){if(r=this.parse(o))throw new wg(r);this.searchParams=null}else{if(n!==void 0&&(i=new jg(n,!0)),r=this.parse(o,null,i))throw new wg(r);(s=X4(new q4)).bindURL(this),this.searchParams=s}};jg.prototype={type:"URL",parse:function(e,t,n){var i,r,s,o,a,c=this,u=t||Dg,p=0,m="",_=!1,g=!1,b=!1;for(e=Ys(e),t||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,e=Ag(e,c6,""),e=Ag(e,d6,"$1")),e=Ag(e,l6,""),i=Lc(e);p<=i.length;){switch(r=i[p],u){case Dg:if(!r||!Br(aw,r)){if(t)return Ig;u=Pg;continue}m+=Dh(r),u=hw;break;case hw:if(r&&(Br(n6,r)||r==="+"||r==="-"||r==="."))m+=Dh(r);else{if(r!==":"){if(t)return Ig;m="",u=Pg,p=0;continue}if(t&&(c.isSpecial()!==Cg(Lh,m)||m==="file"&&(c.includesCredentials()||c.port!==null)||c.scheme==="file"&&!c.host))return;if(c.scheme=m,t)return void(c.isSpecial()&&Lh[c.scheme]===c.port&&(c.port=null));m="",c.scheme==="file"?u=Ug:c.isSpecial()&&n&&n.scheme===c.scheme?u=pw:c.isSpecial()?u=_w:i[p+1]==="/"?(u=mw,p++):(c.cannotBeABaseURL=!0,kc(c.path,""),u=Ew)}break;case Pg:if(!n||n.cannotBeABaseURL&&r!=="#")return Ig;if(n.cannotBeABaseURL&&r==="#"){c.scheme=n.scheme,c.path=Fr(n.path),c.query=n.query,c.fragment="",c.cannotBeABaseURL=!0,u=zs;break}u=n.scheme==="file"?Ug:Lg;continue;case pw:if(r!=="/"||i[p+1]!=="/"){u=Lg;continue}u=kh,p++;break;case mw:if(r==="/"){u=xh;break}u=_s;continue;case Lg:if(c.scheme=n.scheme,r===fr)c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=Fr(n.path),c.query=n.query;else if(r==="/"||r==="\\"&&c.isSpecial())u=fw;else if(r==="?")c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=Fr(n.path),c.query="",u=pa;else{if(r!=="#"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=Fr(n.path),c.path.length--,u=_s;continue}c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,c.path=Fr(n.path),c.query=n.query,c.fragment="",u=zs}break;case fw:if(!c.isSpecial()||r!=="/"&&r!=="\\"){if(r!=="/"){c.username=n.username,c.password=n.password,c.host=n.host,c.port=n.port,u=_s;continue}u=xh}else u=kh;break;case _w:if(u=kh,r!=="/"||Er(m,p+1)!=="/")continue;p++;break;case kh:if(r!=="/"&&r!=="\\"){u=xh;continue}break;case xh:if(r==="@"){_&&(m="%40"+m),_=!0,s=Lc(m);for(var v=0;v<s.length;v++){var R=s[v];if(R!==":"||b){var O=Ro(R,Ng);b?c.password+=O:c.username+=O}else b=!0}m=""}else if(r===fr||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(_&&m==="")return"Invalid authority";p-=Lc(m).length+1,m="",u=kg}else m+=r;break;case kg:case xg:if(t&&c.scheme==="file"){u=Vg;continue}if(r!==":"||g){if(r===fr||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(c.isSpecial()&&m==="")return ha;if(t&&m===""&&(c.includesCredentials()||c.port!==null))return;if(o=c.parseHost(m))return o;if(m="",u=xc,t)return;continue}r==="["?g=!0:r==="]"&&(g=!1),m+=r}else{if(m==="")return ha;if(o=c.parseHost(m))return o;if(m="",u=Mg,t===xg)return}break;case Mg:if(!Br(Og,r)){if(r===fr||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()||t){if(m!==""){var D=Nh(m,10);if(D>65535)return ow;c.port=c.isSpecial()&&D===Lh[c.scheme]?null:D,m=""}if(t)return;u=xc;continue}return ow}m+=r;break;case Ug:if(c.scheme="file",r==="/"||r==="\\")u=gw;else{if(!n||n.scheme!=="file"){u=_s;continue}switch(r){case fr:c.host=n.host,c.path=Fr(n.path),c.query=n.query;break;case"?":c.host=n.host,c.path=Fr(n.path),c.query="",u=pa;break;case"#":c.host=n.host,c.path=Fr(n.path),c.query=n.query,c.fragment="",u=zs;break;default:uw(ml(Fr(i,p),""))||(c.host=n.host,c.path=Fr(n.path),c.shortenPath()),u=_s;continue}}break;case gw:if(r==="/"||r==="\\"){u=Vg;break}n&&n.scheme==="file"&&!uw(ml(Fr(i,p),""))&&(gl(n.path[0],!0)?kc(c.path,n.path[0]):c.host=n.host),u=_s;continue;case Vg:if(r===fr||r==="/"||r==="\\"||r==="?"||r==="#"){if(!t&&gl(m))u=_s;else if(m===""){if(c.host="",t)return;u=xc}else{if(o=c.parseHost(m))return o;if(c.host==="localhost"&&(c.host=""),t)return;m="",u=xc}continue}m+=r;break;case xc:if(c.isSpecial()){if(u=_s,r!=="/"&&r!=="\\")continue}else if(t||r!=="?")if(t||r!=="#"){if(r!==fr&&(u=_s,r!=="/"))continue}else c.fragment="",u=zs;else c.query="",u=pa;break;case _s:if(r===fr||r==="/"||r==="\\"&&c.isSpecial()||!t&&(r==="?"||r==="#")){if((a=Dh(a=m))===".."||a==="%2e."||a===".%2e"||a==="%2e%2e"?(c.shortenPath(),r==="/"||r==="\\"&&c.isSpecial()||kc(c.path,"")):u6(m)?r==="/"||r==="\\"&&c.isSpecial()||kc(c.path,""):(c.scheme==="file"&&!c.path.length&&gl(m)&&(c.host&&(c.host=""),m=Er(m,0)+":"),kc(c.path,m)),m="",c.scheme==="file"&&(r===fr||r==="?"||r==="#"))for(;c.path.length>1&&c.path[0]==="";)$4(c.path);r==="?"?(c.query="",u=pa):r==="#"&&(c.fragment="",u=zs)}else m+=Ro(r,lw);break;case Ew:r==="?"?(c.query="",u=pa):r==="#"?(c.fragment="",u=zs):r!==fr&&(c.path[0]+=Ro(r,Ph));break;case pa:t||r!=="#"?r!==fr&&(r==="'"&&c.isSpecial()?c.query+="%27":c.query+=r==="#"?"%23":Ro(r,Ph)):(c.fragment="",u=zs);break;case zs:r!==fr&&(c.fragment+=Ro(r,dw))}p++}},parseHost:function(e){var t,n,i;if(Er(e,0)==="["){if(Er(e,e.length-1)!=="]"||(t=(function(r){var s,o,a,c,u,p,m,_=[0,0,0,0,0,0,0,0],g=0,b=null,v=0,R=function(){return Er(r,v)};if(R()===":"){if(Er(r,1)!==":")return;v+=2,b=++g}for(;R();){if(g===8)return;if(R()!==":"){for(s=o=0;o<4&&Br(cw,R());)s=16*s+Nh(R(),16),v++,o++;if(R()==="."){if(o===0||(v-=o,g>6))return;for(a=0;R();){if(c=null,a>0){if(!(R()==="."&&a<4))return;v++}if(!Br(Og,R()))return;for(;Br(Og,R());){if(u=Nh(R(),10),c===null)c=u;else{if(c===0)return;c=10*c+u}if(c>255)return;v++}_[g]=256*_[g]+c,++a!=2&&a!==4||g++}if(a!==4)return;break}if(R()===":"){if(v++,!R())return}else if(R())return;_[g++]=s}else{if(b!==null)return;v++,b=++g}}if(b!==null)for(p=g-b,g=7;g!==0&&p>0;)m=_[g],_[g--]=_[b+p-1],_[b+--p]=m;else if(g!==8)return;return _})(fl(e,1,-1)),!t))return ha;this.host=t}else if(this.isSpecial()){if(e=H4(e),Br(o6,e)||(t=(function(r){var s,o,a,c,u,p,m,_=e6(r,".");if(_.length&&_[_.length-1]===""&&_.length--,(s=_.length)>4)return r;for(o=[],a=0;a<s;a++){if((c=_[a])==="")return r;if(u=10,c.length>1&&Er(c,0)==="0"&&(u=Br(i6,c)?16:8,c=fl(c,u===8?1:2)),c==="")p=0;else{if(!Br(u===10?s6:u===8?r6:cw,c))return r;p=Nh(c,u)}kc(o,p)}for(a=0;a<s;a++)if(p=o[a],a===s-1){if(p>=sw(256,5-s))return null}else if(p>255)return null;for(m=Z4(o),a=0;a<o.length;a++)m+=o[a]*sw(256,3-a);return m})(e),t===null))return ha;this.host=t}else{if(Br(a6,e))return ha;for(t="",n=Lc(e),i=0;i<n.length;i++)t+=Ro(n[i],Ph);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return Cg(Lh,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||this.scheme==="file"&&t===1&&gl(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,n=e.username,i=e.password,r=e.host,s=e.port,o=e.path,a=e.query,c=e.fragment,u=t+":";return r!==null?(u+="//",e.includesCredentials()&&(u+=n+(i?":"+i:"")+"@"),u+=_l(r),s!==null&&(u+=":"+s)):t==="file"&&(u+="//"),u+=e.cannotBeABaseURL?o[0]:o.length?"/"+ml(o,"/"):"",a!==null&&(u+="?"+a),c!==null&&(u+="#"+c),u},setHref:function(e){var t=this.parse(e);if(t)throw new wg(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if(e==="blob")try{return new Mc(e.path[0]).origin}catch{return"null"}return e!=="file"&&this.isSpecial()?e+"://"+_l(this.host)+(t!==null?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(Ys(e)+":",Dg)},getUsername:function(){return this.username},setUsername:function(e){var t=Lc(Ys(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<t.length;n++)this.username+=Ro(t[n],Ng)}},getPassword:function(){return this.password},setPassword:function(e){var t=Lc(Ys(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<t.length;n++)this.password+=Ro(t[n],Ng)}},getHost:function(){var e=this.host,t=this.port;return e===null?"":t===null?_l(e):_l(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,kg)},getHostname:function(){var e=this.host;return e===null?"":_l(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,xg)},getPort:function(){var e=this.port;return e===null?"":Ys(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||((e=Ys(e))===""?this.port=null:this.parse(e,Mg))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+ml(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,xc))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){(e=Ys(e))===""?this.query=null:(Er(e,0)==="?"&&(e=fl(e,1)),this.query="",this.parse(e,pa)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){(e=Ys(e))!==""?(Er(e,0)==="#"&&(e=fl(e,1)),this.fragment="",this.parse(e,zs)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Mc=function(e){var t=W4(this,Ni),n=Y4(arguments.length,1)>1?arguments[1]:void 0,i=z4(t,new jg(e,!1,n));vg||(t.href=i.serialize(),t.origin=i.getOrigin(),t.protocol=i.getProtocol(),t.username=i.getUsername(),t.password=i.getPassword(),t.host=i.getHost(),t.hostname=i.getHostname(),t.port=i.getPort(),t.pathname=i.getPathname(),t.search=i.getSearch(),t.searchParams=i.getSearchParams(),t.hash=i.getHash())},Ni=Mc.prototype,Sr=function(e,t){return{get:function(){return Oh(this)[e]()},set:t&&function(n){return Oh(this)[t](n)},configurable:!0,enumerable:!0}};if(vg&&(gr(Ni,"href",Sr("serialize","setHref")),gr(Ni,"origin",Sr("getOrigin")),gr(Ni,"protocol",Sr("getProtocol","setProtocol")),gr(Ni,"username",Sr("getUsername","setUsername")),gr(Ni,"password",Sr("getPassword","setPassword")),gr(Ni,"host",Sr("getHost","setHost")),gr(Ni,"hostname",Sr("getHostname","setHostname")),gr(Ni,"port",Sr("getPort","setPort")),gr(Ni,"pathname",Sr("getPathname","setPathname")),gr(Ni,"search",Sr("getSearch","setSearch")),gr(Ni,"searchParams",Sr("getSearchParams")),gr(Ni,"hash",Sr("getHash","setHash"))),Ih(Ni,"toJSON",(function(){return Oh(this).serialize()}),{enumerable:!0}),Ih(Ni,"toString",(function(){return Oh(this).serialize()}),{enumerable:!0}),pl){var Sw=pl.createObjectURL,yw=pl.revokeObjectURL;Sw&&Ih(Mc,"createObjectURL",nw(Sw,pl)),yw&&Ih(Mc,"revokeObjectURL",nw(yw,pl))}K4(Mc,"URL"),F4({global:!0,forced:!B4,sham:!vg},{URL:Mc});var h6=pt,Tw=w,p6=ca,vw=Ai,m6=vh,Fg=di("URL"),f6=m6&&Tw((function(){Fg.canParse()})),_6=Tw((function(){return Fg.canParse.length!==1}));h6({target:"URL",stat:!0,forced:!f6||_6},{canParse:function(e){var t=p6(arguments.length,1),n=vw(e),i=t<2||arguments[1]===void 0?void 0:vw(arguments[1]);try{return!!new Fg(n,i)}catch{return!1}}});var g6=pt,E6=ca,Rw=Ai,S6=vh,y6=di("URL");g6({target:"URL",stat:!0,forced:!S6},{parse:function(e){var t=E6(arguments.length,1),n=Rw(e),i=t<2||arguments[1]===void 0?void 0:Rw(arguments[1]);try{return new y6(n,i)}catch{return null}}});var Mh=y(Mi.URL);let Cw=!0,bw=!0;function Uh(e,t,n){const i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)}function ma(e,t,n){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(o,a){if(o!==t)return r.apply(this,arguments);const c=u=>{const p=n(u);p&&(a.handleEvent?a.handleEvent(p):a(p))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(a,c),r.apply(this,[o,c])};const s=i.removeEventListener;i.removeEventListener=function(o,a){if(o!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(a))return s.apply(this,arguments);const c=this._eventMap[t].get(a);return this._eventMap[t].delete(a),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,s.apply(this,[o,c])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(o){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),o&&this.addEventListener(t,this["_on"+t]=o)},enumerable:!0,configurable:!0})}function T6(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Cw=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function v6(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(bw=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function ww(){if(typeof window=="object"){if(Cw)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function Bg(e,t){bw&&console.warn(e+" is deprecated, please use "+t+" instead.")}function Aw(e){return Object.prototype.toString.call(e)==="[object Object]"}function Iw(e){var t;return Aw(e)?$i(t=Object.keys(e)).call(t,(function(n,i){const r=Aw(e[i]),s=r?Iw(e[i]):e[i],o=r&&!Object.keys(s).length;return s===void 0||o?n:Object.assign(n,{[i]:s})}),{}):e}function Wg(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach((i=>{i.endsWith("Id")?Wg(e,e.get(t[i]),n):i.endsWith("Ids")&&t[i].forEach((r=>{Wg(e,e.get(r),n)}))})))}function Ow(e,t,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(t===null)return r;const s=[];return e.forEach((o=>{o.type==="track"&&o.trackIdentifier===t.id&&s.push(o)})),s.forEach((o=>{e.forEach((a=>{a.type===i&&a.trackId===o.id&&Wg(e,a,r)}))})),r}const Nw=ww;function Dw(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const i=function(o){if(typeof o!="object"||o.mandatory||o.optional)return o;const a={};return Object.keys(o).forEach((c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;const u=typeof o[c]=="object"?o[c]:{ideal:o[c]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const p=function(m,_){return m?m+_.charAt(0).toUpperCase()+_.slice(1):_==="deviceId"?"sourceId":_};if(u.ideal!==void 0){a.optional=a.optional||[];let m={};typeof u.ideal=="number"?(m[p("min",c)]=u.ideal,a.optional.push(m),m={},m[p("max",c)]=u.ideal,a.optional.push(m)):(m[p("",c)]=u.ideal,a.optional.push(m))}u.exact!==void 0&&typeof u.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[p("",c)]=u.exact):["min","max"].forEach((m=>{u[m]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[p(m,c)]=u[m])}))})),o.advanced&&(a.optional=(a.optional||[]).concat(o.advanced)),a},r=function(o,a){if(t.version>=61)return a(o);if((o=JSON.parse(JSON.stringify(o)))&&typeof o.audio=="object"){const c=function(u,p,m){p in u&&!(m in u)&&(u[m]=u[p],delete u[p])};c((o=JSON.parse(JSON.stringify(o))).audio,"autoGainControl","googAutoGainControl"),c(o.audio,"noiseSuppression","googNoiseSuppression"),o.audio=i(o.audio)}if(o&&typeof o.video=="object"){let c=o.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});const u=t.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||u)){let p;if(delete o.video.facingMode,c.exact==="environment"||c.ideal==="environment"?p=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(p=["front"]),p)return n.mediaDevices.enumerateDevices().then((m=>{m=m.filter((g=>g.kind==="videoinput"));let _=m.find((g=>p.some((b=>{var v;return ie(v=g.label.toLowerCase()).call(v,b)}))));return!_&&m.length&&ie(p).call(p,"back")&&(_=m[m.length-1]),_&&(o.video.deviceId=c.exact?{exact:_.deviceId}:{ideal:_.deviceId}),o.video=i(o.video),Nw("chrome: "+JSON.stringify(o)),a(o)}))}o.video=i(o.video)}return Nw("chrome: "+JSON.stringify(o)),a(o)},s=function(o){return t.version>=64?o:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[o.name]||o.name,message:o.message,constraint:o.constraint||o.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=(function(o,a,c){r(o,(u=>{n.webkitGetUserMedia(u,a,(p=>{c&&c(s(p))}))}))}).bind(n),n.mediaDevices.getUserMedia){const o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(a){return r(a,(c=>o(c).then((u=>{if(c.audio&&!u.getAudioTracks().length||c.video&&!u.getVideoTracks().length)throw u.getTracks().forEach((p=>{p.stop()})),new DOMException("","NotFoundError");return u}),(u=>de.reject(s(u))))))}}}function Pw(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function Lw(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",(i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((o=>o.track&&o.track.id===i.track.id)):{track:i.track};const s=new Event("track");s.track=i.track,s.receiver=r,s.transceiver={receiver:r},s.streams=[n.stream],this.dispatchEvent(s)})),n.stream.getTracks().forEach((i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((o=>o.track&&o.track.id===i.id)):{track:i};const s=new Event("track");s.track=i,s.receiver=r,s.transceiver={receiver:r},s.streams=[n.stream],this.dispatchEvent(s)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else ma(e,"track",(t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t)))}function kw(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(r,s){return{track:s,get dtmf(){return this._dtmf===void 0&&(s.kind==="audio"?this._dtmf=r.createDTMFSender(s):this._dtmf=null),this._dtmf},_pc:r}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(o,a){let c=r.apply(this,arguments);return c||(c=t(this,o),this._senders.push(c)),c};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(o){s.apply(this,arguments);const a=this._senders.indexOf(o);a!==-1&&this._senders.splice(a,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach((s=>{this._senders.push(t(this,s))}))};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach((s=>{const o=this._senders.find((a=>a.track===s));o&&this._senders.splice(this._senders.indexOf(o),1)}))}}else if(typeof e=="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const n=t.apply(this,[]);return n.forEach((i=>i._pc=this)),n},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function xw(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[n,i,r]=arguments;if(arguments.length>0&&typeof n=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof n!="function"))return t.apply(this,[]);const s=function(a){const c={};return a.result().forEach((u=>{const p={id:u.id,timestamp:u.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[u.type]||u.type};u.names().forEach((m=>{p[m]=u.stat(m)})),c[p.id]=p})),c},o=function(a){return new Map(Object.keys(a).map((c=>[c,a[c]])))};if(arguments.length>=2){const a=function(c){i(o(s(c)))};return t.apply(this,[a,n])}return new de(((a,c)=>{t.apply(this,[function(u){a(o(s(u)))},c])})).then(i,r)}}function Mw(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const n=e.RTCPeerConnection.prototype.getSenders;n&&(e.RTCPeerConnection.prototype.getSenders=function(){const r=n.apply(this,[]);return r.forEach((s=>s._pc=this)),r});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const r=i.apply(this,arguments);return r._pc=this,r}),e.RTCRtpSender.prototype.getStats=function(){const r=this;return this._pc.getStats().then((s=>Ow(s,r.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const n=e.RTCPeerConnection.prototype.getReceivers;n&&(e.RTCPeerConnection.prototype.getReceivers=function(){const i=n.apply(this,[]);return i.forEach((r=>r._pc=this)),i}),ma(e,"track",(i=>(i.receiver._pc=i.srcElement,i))),e.RTCRtpReceiver.prototype.getStats=function(){const i=this;return this._pc.getStats().then((r=>Ow(r,i.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const n=arguments[0];let i,r,s;return this.getSenders().forEach((o=>{o.track===n&&(i?s=!0:i=o)})),this.getReceivers().forEach((o=>(o.track===n&&(r?s=!0:r=o),o.track===n))),s||i&&r?de.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):i?i.getStats():r?r.getStats():de.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function Uw(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((s=>this._shimmedLocalStreams[s][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(s,o){if(!o)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const a=t.apply(this,arguments);return this._shimmedLocalStreams[o.id]?this._shimmedLocalStreams[o.id].indexOf(a)===-1&&this._shimmedLocalStreams[o.id].push(a):this._shimmedLocalStreams[o.id]=[o,a],a};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach((c=>{if(this.getSenders().find((p=>p.track===c)))throw new DOMException("Track already exists.","InvalidAccessError")}));const o=this.getSenders();n.apply(this,arguments);const a=this.getSenders().filter((c=>o.indexOf(c)===-1));this._shimmedLocalStreams[s.id]=[s].concat(a)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],i.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach((o=>{const a=this._shimmedLocalStreams[o].indexOf(s);a!==-1&&this._shimmedLocalStreams[o].splice(a,1),this._shimmedLocalStreams[o].length===1&&delete this._shimmedLocalStreams[o]})),r.apply(this,arguments)}}function Vw(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return Uw(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const c=n.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map((u=>this._reverseStreams[u.id]))};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach((u=>{if(this.getSenders().find((m=>m.track===u)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[c.id]){const u=new e.MediaStream(c.getTracks());this._streams[c.id]=u,this._reverseStreams[u.id]=c,c=u}i.apply(this,[c])};const r=e.RTCPeerConnection.prototype.removeStream;function s(c,u){let p=u.sdp;return Object.keys(c._reverseStreams||[]).forEach((m=>{const _=c._reverseStreams[m],g=c._streams[_.id];p=p.replace(new RegExp(g.id,"g"),_.id)})),new RTCSessionDescription({type:u.type,sdp:p})}e.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},e.RTCPeerConnection.prototype.addTrack=function(c,u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const p=[].slice.call(arguments,1);if(p.length!==1||!p[0].getTracks().find((g=>g===c)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((g=>g.track===c)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const _=this._streams[u.id];if(_)_.addTrack(c),de.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const g=new e.MediaStream([c]);this._streams[u.id]=g,this._reverseStreams[g.id]=u,this.addStream(g)}return this.getSenders().find((g=>g.track===c))},["createOffer","createAnswer"].forEach((function(c){const u=e.RTCPeerConnection.prototype[c],p={[c](){const m=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[_=>{const g=s(this,_);m[0].apply(null,[g])},_=>{m[1]&&m[1].apply(null,_)},arguments[2]]):u.apply(this,arguments).then((_=>s(this,_)))}};e.RTCPeerConnection.prototype[c]=p[c]}));const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=(function(c,u){let p=u.sdp;return Object.keys(c._reverseStreams||[]).forEach((m=>{const _=c._reverseStreams[m],g=c._streams[_.id];p=p.replace(new RegExp(_.id,"g"),g.id)})),new RTCSessionDescription({type:u.type,sdp:p})})(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const a=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const c=a.get.apply(this);return c.type===""?c:s(this,c)}}),e.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let u;this._streams=this._streams||{},Object.keys(this._streams).forEach((p=>{this._streams[p].getTracks().find((m=>c.track===m))&&(u=this._streams[p])})),u&&(u.getTracks().length===1?this.removeStream(this._reverseStreams[u.id]):u.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Gg(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(n){const i=e.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[n]=r[n]}))}function jw(e,t){ma(e,"negotiationneeded",(n=>{const i=n.target;if(!(t.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")||i.signalingState==="stable")return n}))}var Fw=Object.freeze({__proto__:null,fixNegotiationNeeded:jw,shimAddTrackRemoveTrack:Vw,shimAddTrackRemoveTrackWithNative:Uw,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(typeof t=="function"?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then((i=>{const r=n.video&&n.video.width,s=n.video&&n.video.height,o=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxFrameRate:o||3}},r&&(n.video.mandatory.maxWidth=r),s&&(n.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(n)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:kw,shimGetStats:xw,shimGetUserMedia:Dw,shimMediaStream:Pw,shimOnTrack:Lw,shimPeerConnection:Gg,shimSenderReceiverGetStats:Mw});function Bw(e,t){const n=e&&e.navigator,i=e&&e.MediaStreamTrack;if(n.getUserMedia=function(r,s,o){Bg("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(r).then(s,o)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const r=function(o,a,c){a in o&&!(c in o)&&(o[c]=o[a],delete o[a])},s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(o){return typeof o=="object"&&typeof o.audio=="object"&&(o=JSON.parse(JSON.stringify(o)),r(o.audio,"autoGainControl","mozAutoGainControl"),r(o.audio,"noiseSuppression","mozNoiseSuppression")),s(o)},i&&i.prototype.getSettings){const o=i.prototype.getSettings;i.prototype.getSettings=function(){const a=o.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const o=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),o.apply(this,[a])}}}}function Ww(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Hg(e,t){if(typeof e!="object"||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(r){const s=e.RTCPeerConnection.prototype[r],o={[r](){return arguments[0]=new(r==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};e.RTCPeerConnection.prototype[r]=o[r]}));const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[r,s,o]=arguments;return i.apply(this,[r||null]).then((a=>{if(t.version<53&&!s)try{a.forEach((c=>{c.type=n[c.type]||c.type}))}catch(c){if(c.name!=="TypeError")throw c;a.forEach(((u,p)=>{a.set(p,Object.assign({},u,{type:n[u.type]||u.type}))}))}return a})).then(s,o)}}function Gw(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const i=t.apply(this,[]);return i.forEach((r=>r._pc=this)),i});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const i=n.apply(this,arguments);return i._pc=this,i}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):de.resolve(new Map)}}function Hw(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const n=t.apply(this,[]);return n.forEach((i=>i._pc=this)),n}),ma(e,"track",(n=>(n.receiver._pc=n.srcElement,n))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Kw(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(t){Bg("removeStream","removeTrack"),this.getSenders().forEach((n=>{var i;n.track&&ie(i=t.getTracks()).call(i,n.track)&&this.removeTrack(n)}))})}function Yw(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function zw(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];const i=n.length>0;i&&n.forEach((s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=t.apply(this,arguments);if(i){const{sender:s}=r,o=s.getParameters();(!("encodings"in o)||o.encodings.length===1&&Object.keys(o.encodings[0]).length===0)&&(o.encodings=n,s.sendEncodings=n,this.setParametersPromises.push(s.setParameters(o).then((()=>{delete s.sendEncodings})).catch((()=>{delete s.sendEncodings}))))}return r})}function qw(e){if(typeof e!="object"||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const n=t.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function Xw(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?de.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function Jw(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?de.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var Qw=Object.freeze({__proto__:null,shimAddTransceiver:zw,shimCreateAnswer:Jw,shimCreateOffer:Xw,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const i=new DOMException("getDisplayMedia without video constraints is undefined");return i.name="NotFoundError",i.code=8,de.reject(i)}return n.video===!0?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:qw,shimGetUserMedia:Bw,shimOnTrack:Ww,shimPeerConnection:Hg,shimRTCDataChannel:Yw,shimReceiverGetStats:Hw,shimRemoveStream:Kw,shimSenderGetStats:Gw});function Zw(e){if(typeof e=="object"&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(n){var i;this._localStreams||(this._localStreams=[]),ie(i=this._localStreams).call(i,n)||this._localStreams.push(n),n.getAudioTracks().forEach((r=>t.call(this,r,n))),n.getVideoTracks().forEach((r=>t.call(this,r,n)))},e.RTCPeerConnection.prototype.addTrack=function(n){for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return r&&r.forEach((o=>{var a;this._localStreams?ie(a=this._localStreams).call(a,o)||this._localStreams.push(o):this._localStreams=[o]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const n=this._localStreams.indexOf(t);if(n===-1)return;this._localStreams.splice(n,1);const i=t.getTracks();this.getSenders().forEach((r=>{ie(i).call(i,r.track)&&this.removeTrack(r)}))})}}function $w(e){if(typeof e=="object"&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach((r=>{var s;if(this._remoteStreams||(this._remoteStreams=[]),ie(s=this._remoteStreams).call(s,r))return;this._remoteStreams.push(r);const o=new Event("addstream");o.stream=r,this.dispatchEvent(o)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(i){i.streams.forEach((r=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(r)>=0)return;n._remoteStreams.push(r);const s=new Event("addstream");s.stream=r,n.dispatchEvent(s)}))}),t.apply(n,arguments)}}}function eA(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(c,u){const p=arguments.length>=2?arguments[2]:arguments[0],m=n.apply(this,[p]);return u?(m.then(c,u),de.resolve()):m},t.createAnswer=function(c,u){const p=arguments.length>=2?arguments[2]:arguments[0],m=i.apply(this,[p]);return u?(m.then(c,u),de.resolve()):m};let a=function(c,u,p){const m=r.apply(this,[c]);return p?(m.then(u,p),de.resolve()):m};t.setLocalDescription=a,a=function(c,u,p){const m=s.apply(this,[c]);return p?(m.then(u,p),de.resolve()):m},t.setRemoteDescription=a,a=function(c,u,p){const m=o.apply(this,[c]);return p?(m.then(u,p),de.resolve()):m},t.addIceCandidate=a}function tA(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const n=t.mediaDevices,i=n.getUserMedia.bind(n);t.mediaDevices.getUserMedia=r=>i(nA(r))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(n,i,r){t.mediaDevices.getUserMedia(n).then(i,r)}).bind(t))}function nA(e){return e&&e.video!==void 0?Object.assign({},e,{video:Iw(e.video)}):e}function iA(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(n,i){if(n&&n.iceServers){const r=[];for(let s=0;s<n.iceServers.length;s++){let o=n.iceServers[s];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(Bg("RTCIceServer.url","RTCIceServer.urls"),o=JSON.parse(JSON.stringify(o)),o.urls=o.url,delete o.url,r.push(o)):r.push(n.iceServers[s])}n.iceServers=r}return new t(n,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function rA(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function sA(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(n){if(n){n.offerToReceiveAudio!==void 0&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);const i=this.getTransceivers().find((s=>s.receiver.track.kind==="audio"));n.offerToReceiveAudio===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):n.offerToReceiveAudio!==!0||i||this.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo!==void 0&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);const r=this.getTransceivers().find((s=>s.receiver.track.kind==="video"));n.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):n.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function oA(e){typeof e!="object"||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var aA=Object.freeze({__proto__:null,shimAudioContext:oA,shimCallbacksAPI:eA,shimConstraints:nA,shimCreateOfferLegacy:sA,shimGetUserMedia:tA,shimLocalStreamsAPI:Zw,shimRTCIceServerUrls:iA,shimRemoteStreamsAPI:$w,shimTrackEventTransceiver:rA}),cA=`	
\v\f\r \u2028\u2029\uFEFF`,R6=ho,C6=Ai,Kg=cA,dA=V("".replace),b6=RegExp("^["+Kg+"]+"),w6=RegExp("(^|[^"+Kg+"])["+Kg+"]+$"),A6=function(e){return function(t){var n=C6(R6(t));return 1&e&&(n=dA(n,b6,"")),2&e&&(n=dA(n,w6,"$1")),n}},I6={trim:A6(3)},O6=KR.PROPER,N6=w,lA=cA,D6=I6.trim;pt({target:"String",proto:!0,forced:(function(e){return N6((function(){return!!lA[e]()||""[e]()!==""||O6&&lA[e].name!==e}))})("trim")},{trim:function(){return D6(this)}});var P6=Zi("String","trim"),L6=W,k6=P6,Yg=String.prototype,x6=function(e){var t=e.trim;return typeof e=="string"||e===Yg||L6(Yg,e)&&t===Yg.trim?k6:t},ti=y(x6),uA={exports:{}};(function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(n){return n.trim().split(`
`).map((i=>i.trim()))},t.splitSections=function(n){return n.split(`
m=`).map(((i,r)=>(r>0?"m="+i:i).trim()+`\r
`))},t.getDescription=function(n){const i=t.splitSections(n);return i&&i[0]},t.getMediaSections=function(n){const i=t.splitSections(n);return i.shift(),i},t.matchPrefix=function(n,i){return t.splitLines(n).filter((r=>r.indexOf(i)===0))},t.parseCandidate=function(n){let i;i=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let s=8;s<i.length;s+=2)switch(i[s]){case"raddr":r.relatedAddress=i[s+1];break;case"rport":r.relatedPort=parseInt(i[s+1],10);break;case"tcptype":r.tcpType=i[s+1];break;case"ufrag":r.ufrag=i[s+1],r.usernameFragment=i[s+1];break;default:r[i[s]]===void 0&&(r[i[s]]=i[s+1])}return r},t.writeCandidate=function(n){const i=[];i.push(n.foundation);const r=n.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(n.protocol.toUpperCase()),i.push(n.priority),i.push(n.address||n.ip),i.push(n.port);const s=n.type;return i.push("typ"),i.push(s),s!=="host"&&n.relatedAddress&&n.relatedPort&&(i.push("raddr"),i.push(n.relatedAddress),i.push("rport"),i.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(i.push("ufrag"),i.push(n.usernameFragment||n.ufrag)),"candidate:"+i.join(" ")},t.parseIceOptions=function(n){return n.substring(14).split(" ")},t.parseRtpMap=function(n){let i=n.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(n){let i=n.payloadType;n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType);const r=n.channels||n.numChannels||1;return"a=rtpmap:"+i+" "+n.name+"/"+n.clockRate+(r!==1?"/"+r:"")+`\r
`},t.parseExtmap=function(n){const i=n.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},t.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},t.parseFmtp=function(n){const i={};let r;const s=n.substring(n.indexOf(" ")+1).split(";");for(let o=0;o<s.length;o++)r=s[o].trim().split("="),i[r[0].trim()]=r[1];return i},t.writeFmtp=function(n){let i="",r=n.payloadType;if(n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const s=[];Object.keys(n.parameters).forEach((o=>{n.parameters[o]!==void 0?s.push(o+"="+n.parameters[o]):s.push(o)})),i+="a=fmtp:"+r+" "+s.join(";")+`\r
`}return i},t.parseRtcpFb=function(n){const i=n.substring(n.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},t.writeRtcpFb=function(n){let i="",r=n.payloadType;return n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach((s=>{i+="a=rtcp-fb:"+r+" "+s.type+(s.parameter&&s.parameter.length?" "+s.parameter:"")+`\r
`})),i},t.parseSsrcMedia=function(n){const i=n.indexOf(" "),r={ssrc:parseInt(n.substring(7,i),10)},s=n.indexOf(":",i);return s>-1?(r.attribute=n.substring(i+1,s),r.value=n.substring(s+1)):r.attribute=n.substring(i+1),r},t.parseSsrcGroup=function(n){const i=n.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map((r=>parseInt(r,10)))}},t.getMid=function(n){const i=t.matchPrefix(n,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(n){const i=n.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},t.getDtlsParameters=function(n,i){return{role:"auto",fingerprints:t.matchPrefix(n+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(n,i){let r="a=setup:"+i+`\r
`;return n.fingerprints.forEach((s=>{r+="a=fingerprint:"+s.algorithm+" "+s.value+`\r
`})),r},t.parseCryptoLine=function(n){const i=n.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},t.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?t.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;const i=n.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},t.getCryptoParameters=function(n,i){return t.matchPrefix(n+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(n,i){const r=t.matchPrefix(n+i,"a=ice-ufrag:")[0],s=t.matchPrefix(n+i,"a=ice-pwd:")[0];return r&&s?{usernameFragment:r.substring(12),password:s.substring(10)}:null},t.writeIceParameters=function(n){let i="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(i+=`a=ice-lite\r
`),i},t.parseRtpParameters=function(n){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(n)[0].split(" ");i.profile=r[2];for(let o=3;o<r.length;o++){const a=r[o],c=t.matchPrefix(n,"a=rtpmap:"+a+" ")[0];if(c){const u=t.parseRtpMap(c),p=t.matchPrefix(n,"a=fmtp:"+a+" ");switch(u.parameters=p.length?t.parseFmtp(p[0]):{},u.rtcpFeedback=t.matchPrefix(n,"a=rtcp-fb:"+a+" ").map(t.parseRtcpFb),i.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(u.name.toUpperCase())}}}t.matchPrefix(n,"a=extmap:").forEach((o=>{i.headerExtensions.push(t.parseExtmap(o))}));const s=t.matchPrefix(n,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach((o=>{s.forEach((a=>{o.rtcpFeedback.find((c=>c.type===a.type&&c.parameter===a.parameter))||o.rtcpFeedback.push(a)}))})),i},t.writeRtpDescription=function(n,i){let r="";r+="m="+n+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map((o=>o.preferredPayloadType!==void 0?o.preferredPayloadType:o.payloadType)).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach((o=>{r+=t.writeRtpMap(o),r+=t.writeFmtp(o),r+=t.writeRtcpFb(o)}));let s=0;return i.codecs.forEach((o=>{o.maxptime>s&&(s=o.maxptime)})),s>0&&(r+="a=maxptime:"+s+`\r
`),i.headerExtensions&&i.headerExtensions.forEach((o=>{r+=t.writeExtmap(o)})),r},t.parseRtpEncodingParameters=function(n){const i=[],r=t.parseRtpParameters(n),s=r.fecMechanisms.indexOf("RED")!==-1,o=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=t.matchPrefix(n,"a=ssrc:").map((_=>t.parseSsrcMedia(_))).filter((_=>_.attribute==="cname")),c=a.length>0&&a[0].ssrc;let u;const p=t.matchPrefix(n,"a=ssrc-group:FID").map((_=>_.substring(17).split(" ").map((g=>parseInt(g,10)))));p.length>0&&p[0].length>1&&p[0][0]===c&&(u=p[0][1]),r.codecs.forEach((_=>{if(_.name.toUpperCase()==="RTX"&&_.parameters.apt){let g={ssrc:c,codecPayloadType:parseInt(_.parameters.apt,10)};c&&u&&(g.rtx={ssrc:u}),i.push(g),s&&(g=JSON.parse(JSON.stringify(g)),g.fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},i.push(g))}})),i.length===0&&c&&i.push({ssrc:c});let m=t.matchPrefix(n,"b=");return m.length&&(m=m[0].indexOf("b=TIAS:")===0?parseInt(m[0].substring(7),10):m[0].indexOf("b=AS:")===0?1e3*parseInt(m[0].substring(5),10)*.95-16e3:void 0,i.forEach((_=>{_.maxBitrate=m}))),i},t.parseRtcpParameters=function(n){const i={},r=t.matchPrefix(n,"a=ssrc:").map((a=>t.parseSsrcMedia(a))).filter((a=>a.attribute==="cname"))[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const s=t.matchPrefix(n,"a=rtcp-rsize");i.reducedSize=s.length>0,i.compound=s.length===0;const o=t.matchPrefix(n,"a=rtcp-mux");return i.mux=o.length>0,i},t.writeRtcpParameters=function(n){let i="";return n.reducedSize&&(i+=`a=rtcp-rsize\r
`),n.mux&&(i+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(i+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),i},t.parseMsid=function(n){let i;const r=t.matchPrefix(n,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const s=t.matchPrefix(n,"a=ssrc:").map((o=>t.parseSsrcMedia(o))).filter((o=>o.attribute==="msid"));return s.length>0?(i=s[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(n){const i=t.parseMLine(n),r=t.matchPrefix(n,"a=max-message-size:");let s;r.length>0&&(s=parseInt(r[0].substring(19),10)),isNaN(s)&&(s=65536);const o=t.matchPrefix(n,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substring(12),10),protocol:i.fmt,maxMessageSize:s};const a=t.matchPrefix(n,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:s}}},t.writeSctpDescription=function(n,i){let r=[];return r=n.protocol!=="DTLS/SCTP"?["m="+n.kind+" 9 "+n.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:["m="+n.kind+" 9 "+n.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(n,i,r){let s;const o=i!==void 0?i:2;return s=n||t.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+s+" "+o+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(n,i){const r=t.splitLines(n);for(let s=0;s<r.length;s++)switch(r[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[s].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(n){return t.splitLines(n)[0].split(" ")[0].substring(2)},t.isRejected=function(n){return n.split(" ",2)[1]==="0"},t.parseMLine=function(n){const i=t.splitLines(n)[0].substring(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(n){const i=t.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;const i=t.splitLines(n);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},e.exports=t})(uA);var hA=uA.exports,Uc=y(hA),M6=h({__proto__:null,default:Uc},[hA]);function Vh(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){const i=new t(n),r=Uc.parseCandidate(n.candidate),s=Object.assign(i,r);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(n)},e.RTCIceCandidate.prototype=t.prototype,ma(e,"icecandidate",(n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new e.RTCIceCandidate(n.candidate),writable:"false"}),n)))}function zg(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||ma(e,"icecandidate",(t=>{if(t.candidate){const n=Uc.parseCandidate(t.candidate.candidate);n.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return t}))}function jh(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const n=function(a){if(!a||!a.sdp)return!1;const c=Uc.splitSections(a.sdp);return c.shift(),c.some((u=>{const p=Uc.parseMLine(u);return p&&p.kind==="application"&&p.protocol.indexOf("SCTP")!==-1}))},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const u=parseInt(c[1],10);return u!=u?-1:u},r=function(a){let c=65536;return t.browser==="firefox"&&(c=t.version<57?a===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637),c},s=function(a,c){let u=65536;t.browser==="firefox"&&t.version===57&&(u=65535);const p=Uc.matchPrefix(a.sdp,"a=max-message-size:");return p.length>0?u=parseInt(p[0].substr(19),10):t.browser==="firefox"&&c!==-1&&(u=2147483637),u},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const a=i(arguments[0]),c=r(a),u=s(arguments[0],a);let p;p=c===0&&u===0?Number.POSITIVE_INFINITY:c===0||u===0?Math.max(c,u):Math.min(c,u);const m={};Object.defineProperty(m,"maxMessageSize",{get:()=>p}),this._sctp=m}return o.apply(this,arguments)}}function Fh(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(i,r){const s=i.send;i.send=function(){const o=arguments[0],a=o.length||o.size||o.byteLength;if(i.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return s.apply(i,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const i=n.apply(this,arguments);return t(i,this),i},ma(e,"datachannel",(i=>(t(i.channel,i.target),i)))}function qg(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((n=>{const i=t[n];t[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const s=r.target;if(s._lastConnectionState!==s.connectionState){s._lastConnectionState=s.connectionState;const o=new Event("connectionstatechange",r);s.dispatchEvent(o)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function Xg(e,t){if(!e.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(i){if(i&&i.sdp&&i.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const r=i.sdp.split(`
`).filter((s=>ti(s).call(s)!=="a=extmap-allow-mixed")).join(`
`);e.RTCSessionDescription&&i instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:i.type,sdp:r}):i.sdp=r}return n.apply(this,arguments)}}function Bh(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.addIceCandidate;n&&n.length!==0&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?de.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),de.resolve())})}function Wh(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.setLocalDescription;n&&n.length!==0&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let i=arguments[0]||{};if(typeof i!="object"||i.type&&i.sdp)return n.apply(this,arguments);if(i={type:i.type,sdp:i.sdp},!i.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":i.type="offer";break;default:i.type="answer"}return i.sdp||i.type!=="offer"&&i.type!=="answer"?n.apply(this,[i]):(i.type==="offer"?this.createOffer:this.createAnswer).apply(this).then((r=>n.apply(this,[r])))})}var U6=Object.freeze({__proto__:null,removeExtmapAllowMixed:Xg,shimAddIceCandidateNullOrEmpty:Bh,shimConnectionState:qg,shimMaxMessageSize:jh,shimParameterlessSetLocalDescription:Wh,shimRTCIceCandidate:Vh,shimRTCIceCandidateRelayProtocol:zg,shimSendThrowTypeError:Fh});(function(){let{window:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=ww,i=(function(s){const o={browser:null,version:null};if(s===void 0||!s.navigator)return o.browser="Not a browser.",o;const{navigator:a}=s;if(a.mozGetUserMedia)o.browser="firefox",o.version=Uh(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||s.isSecureContext===!1&&s.webkitRTCPeerConnection)o.browser="chrome",o.version=Uh(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!s.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return o.browser="Not a supported browser.",o;o.browser="safari",o.version=Uh(a.userAgent,/AppleWebKit\/(\d+)\./,1),o.supportsUnifiedPlan=s.RTCRtpTransceiver&&"currentDirection"in s.RTCRtpTransceiver.prototype}return o})(e),r={browserDetails:i,commonShim:U6,extractVersion:Uh,disableLog:T6,disableWarnings:v6,sdp:M6};switch(i.browser){case"chrome":if(!Fw||!Gg||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(i.version===null)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=Fw,Bh(e,i),Wh(e),Dw(e,i),Pw(e),Gg(e,i),Lw(e),Vw(e,i),kw(e),xw(e),Mw(e),jw(e,i),Vh(e),zg(e),qg(e),jh(e,i),Fh(e),Xg(e,i);break;case"firefox":if(!Qw||!Hg||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=Qw,Bh(e,i),Wh(e),Bw(e,i),Hg(e,i),Ww(e),Kw(e),Gw(e),Hw(e),Yw(e),zw(e),qw(e),Xw(e),Jw(e),Vh(e),qg(e),jh(e,i),Fh(e);break;case"safari":if(!aA||!t.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=aA,Bh(e,i),Wh(e),iA(e),sA(e),eA(e),Zw(e),$w(e),rA(e),tA(e),oA(e),Vh(e),zg(e),jh(e,i),Fh(e),Xg(e,i);break;default:n("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var V6=w,pA=X.RegExp,j6=!V6((function(){var e=!0;try{pA(".","d")}catch{e=!1}var t={},n="",i=e?"dgimsy":"gimsy",r=function(a,c){Object.defineProperty(t,a,{get:function(){return n+=c,!0}})},s={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var o in e&&(s.hasIndices="d"),s)r(o,s[o]);return Object.getOwnPropertyDescriptor(pA.prototype,"flags").get.call(t)!==i||n!==i})),F6=wi,B6=zt,W6=Hn,G6=W,mA={correct:j6},H6=function(){var e=F6(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},K6=RegExp.prototype,Jg=mA.correct?function(e){return e.flags}:function(e){return mA.correct||!G6(K6,e)||W6(e,"flags")?e.flags:B6(H6,e)},Qg=V,Y6=Math.floor,Zg=Qg("".charAt),z6=Qg("".replace),$g=Qg("".slice),q6=/\$([$&'`]|\d{1,2})/g,X6=pt,J6=zt,eE=V,fA=ho,Q6=kt,Z6=ei,$6=n_,Vc=Ai,eH=Xd,tH=Jg,nH=function(e,t,n,i,r,s){var o=n+e.length,a=i.length,c=q6;return z6(s,c,(function(u,p){var m;switch(Zg(p,0)){case"$":return"$";case"&":return e;case"`":return $g(t,0,n);case"'":return $g(t,o);case"<":m=r[$g(p,1,-1)];break;default:var _=+p;if(_===0)return u;if(_>a){var g=Y6(_/10);return g===0?u:g<=a?i[g-1]===void 0?Zg(p,1):i[g-1]+Zg(p,1):u}m=i[_-1]}return m===void 0?"":m}))},iH=rn("replace"),rH=TypeError,tE=eE("".indexOf),sH=eE("".replace),_A=eE("".slice),oH=Math.max;X6({target:"String",proto:!0},{replaceAll:function(e,t){var n,i,r,s,o,a,c,u,p,m,_=fA(this),g=0,b="";if(Z6(e)){if((n=$6(e))&&(i=Vc(fA(tH(e))),!~tE(i,"g")))throw new rH("`.replaceAll` does not allow non-global regexes");if(r=eH(e,iH))return J6(r,e,_,t);if(n)return sH(Vc(_),e,t)}for(s=Vc(_),o=Vc(e),(a=Q6(t))||(t=Vc(t)),c=o.length,u=oH(1,c),p=tE(s,o);p!==-1;)m=a?Vc(t(o,p,s)):nH(o,s,p,[],void 0,t),b+=_A(s,g,p)+m,g=p+c,p=p+u>s.length?-1:tE(s,o,p+u);return g<s.length&&(b+=_A(s,g)),b}});var aH=Zi("String","replaceAll"),cH=W,dH=aH,nE=String.prototype,lH=function(e){var t=e.replaceAll;return typeof e=="string"||e===nE||cH(nE,e)&&t===nE.replaceAll?dH:t},uH=y(lH),iE=X;pt({global:!0,forced:iE.globalThis!==iE},{globalThis:iE});var gA=y(X),rE={exports:{}};(function(e,t){(function(n,i){var r="function",s="undefined",o="object",a="string",c="major",u="model",p="name",m="type",_="vendor",g="version",b="architecture",v="console",R="mobile",O="tablet",D="smarttv",x="wearable",B="embedded",G="Amazon",j="Apple",H="ASUS",Z="BlackBerry",ne="Browser",he="Chrome",De="Firefox",Oe="Google",Ge="Honor",Ue="Huawei",ct="LG",Ut="Microsoft",ee="Motorola",ce="Nvidia",ge="OnePlus",te="Opera",T="OPPO",k="Samsung",F="Sharp",se="Sony",ke="Xiaomi",It="Zebra",vn="Facebook",lr="Chromium OS",Ho="Mac OS",Wm=" Browser",Ld=function(an){for(var hn={},Lt=0;Lt<an.length;Lt++)hn[an[Lt].toUpperCase()]=an[Lt];return hn},Gm=function(an,hn){return typeof an===a&&Qa(hn).indexOf(Qa(an))!==-1},Qa=function(an){return an.toLowerCase()},yu=function(an,hn){if(typeof an===a)return an=an.replace(/^\s\s*/,""),typeof hn===s?an:an.substring(0,500)},Za=function(an,hn){for(var Lt,Ci,as,Qt,so,rt,cs=0;cs<hn.length&&!so;){var $a=hn[cs],xs=hn[cs+1];for(Lt=Ci=0;Lt<$a.length&&!so&&$a[Lt];)if(so=$a[Lt++].exec(an))for(as=0;as<xs.length;as++)rt=so[++Ci],typeof(Qt=xs[as])===o&&Qt.length>0?Qt.length===2?typeof Qt[1]==r?this[Qt[0]]=Qt[1].call(this,rt):this[Qt[0]]=Qt[1]:Qt.length===3?typeof Qt[1]!==r||Qt[1].exec&&Qt[1].test?this[Qt[0]]=rt?rt.replace(Qt[1],Qt[2]):i:this[Qt[0]]=rt?Qt[1].call(this,rt,Qt[2]):i:Qt.length===4&&(this[Qt[0]]=rt?Qt[3].call(this,rt.replace(Qt[1],Qt[2])):i):this[Qt]=rt||i;cs+=2}},Ko=function(an,hn){for(var Lt in hn)if(typeof hn[Lt]===o&&hn[Lt].length>0){for(var Ci=0;Ci<hn[Lt].length;Ci++)if(Gm(hn[Lt][Ci],an))return Lt==="?"?i:Lt}else if(Gm(hn[Lt],an))return Lt==="?"?i:Lt;return hn.hasOwnProperty("*")?hn["*"]:an},o1={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},a1={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[g,[p,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[g,[p,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[p,g],[/opios[\/ ]+([\w\.]+)/i],[g,[p,te+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[g,[p,te+" GX"]],[/\bopr\/([\w\.]+)/i],[g,[p,te]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[g,[p,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[g,[p,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[p,g],[/quark(?:pc)?\/([-\w\.]+)/i],[g,[p,"Quark"]],[/\bddg\/([\w\.]+)/i],[g,[p,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[g,[p,"UC"+ne]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[g,[p,"WeChat"]],[/konqueror\/([\w\.]+)/i],[g,[p,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[g,[p,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[g,[p,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[g,[p,"Smart Lenovo "+ne]],[/(avast|avg)\/([\w\.]+)/i],[[p,/(.+)/,"$1 Secure "+ne],g],[/\bfocus\/([\w\.]+)/i],[g,[p,De+" Focus"]],[/\bopt\/([\w\.]+)/i],[g,[p,te+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[g,[p,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[g,[p,"Dolphin"]],[/coast\/([\w\.]+)/i],[g,[p,te+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[g,[p,"MIUI"+Wm]],[/fxios\/([\w\.-]+)/i],[g,[p,De]],[/\bqihoobrowser\/?([\w\.]*)/i],[g,[p,"360"]],[/\b(qq)\/([\w\.]+)/i],[[p,/(.+)/,"$1Browser"],g],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[p,/(.+)/,"$1"+Wm],g],[/samsungbrowser\/([\w\.]+)/i],[g,[p,k+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[g,[p,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[p,"Sogou Mobile"],g],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[p,g],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[p],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[g,p],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[p,vn],g],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[p,g],[/\bgsa\/([\w\.]+) .*safari\//i],[g,[p,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[g,[p,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[g,[p,he+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[p,he+" WebView"],g],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[g,[p,"Android "+ne]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[p,g],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[g,[p,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[g,p],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[p,[g,Ko,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[p,g],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[p,"Netscape"],g],[/(wolvic|librewolf)\/([\w\.]+)/i],[p,g],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[g,[p,De+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[p,[g,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[p,[g,/master.|lts./,""]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[b,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[b,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[b,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[b,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[b,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[b,/ower/,"",Qa]],[/ sun4\w[;\)]/i],[[b,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[b,Qa]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[u,[_,k],[m,O]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[u,[_,k],[m,R]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[u,[_,j],[m,R]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[u,[_,j],[m,O]],[/(macintosh);/i],[u,[_,j]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[u,[_,F],[m,R]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[u,[_,Ge],[m,O]],[/honor([-\w ]+)[;\)]/i],[u,[_,Ge],[m,R]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[u,[_,Ue],[m,O]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[u,[_,Ue],[m,R]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[u,/_/g," "],[_,ke],[m,O]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[u,/_/g," "],[_,ke],[m,R]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[u,[_,T],[m,R]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[u,[_,Ko,{OnePlus:["304","403","203"],"*":T}],[m,O]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[u,[_,"Vivo"],[m,R]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[u,[_,"Realme"],[m,R]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[u,[_,ee],[m,R]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[u,[_,ee],[m,O]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[u,[_,ct],[m,O]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv|watch)\w+)/i,/\blg-?([\d\w]+) bui/i],[u,[_,ct],[m,R]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[u,[_,"Lenovo"],[m,O]],[/(nokia) (t[12][01])/i],[_,u,[m,O]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[u,/_/g," "],[m,R],[_,"Nokia"]],[/(pixel (c|tablet))\b/i],[u,[_,Oe],[m,O]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[u,[_,Oe],[m,R]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[u,[_,se],[m,R]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[u,"Xperia Tablet"],[_,se],[m,O]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[u,[_,ge],[m,R]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[u,[_,G],[m,O]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[u,/(.+)/g,"Fire Phone $1"],[_,G],[m,R]],[/(playbook);[-\w\),; ]+(rim)/i],[u,_,[m,O]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[u,[_,Z],[m,R]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[u,[_,H],[m,O]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[u,[_,H],[m,R]],[/(nexus 9)/i],[u,[_,"HTC"],[m,O]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[_,[u,/_/g," "],[m,R]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[u,[_,"TCL"],[m,O]],[/(itel) ((\w+))/i],[[_,Qa],u,[m,Ko,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[u,[_,"Acer"],[m,O]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[u,[_,"Meizu"],[m,R]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[u,[_,"Ulefone"],[m,R]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[u,[_,"Energizer"],[m,R]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[u,[_,"Cat"],[m,R]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[u,[_,"Smartfren"],[m,R]],[/droid.+; (a(?:015|06[35]|142p?))/i],[u,[_,"Nothing"],[m,R]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[u,[_,"Archos"],[m,O]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[u,[_,"Archos"],[m,R]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[_,u,[m,O]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (hmd|imo) ([\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[_,u,[m,R]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[_,u,[m,O]],[/(surface duo)/i],[u,[_,Ut],[m,O]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[u,[_,"Fairphone"],[m,R]],[/(u304aa)/i],[u,[_,"AT&T"],[m,R]],[/\bsie-(\w*)/i],[u,[_,"Siemens"],[m,R]],[/\b(rct\w+) b/i],[u,[_,"RCA"],[m,O]],[/\b(venue[\d ]{2,7}) b/i],[u,[_,"Dell"],[m,O]],[/\b(q(?:mv|ta)\w+) b/i],[u,[_,"Verizon"],[m,O]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[u,[_,"Barnes & Noble"],[m,O]],[/\b(tm\d{3}\w+) b/i],[u,[_,"NuVision"],[m,O]],[/\b(k88) b/i],[u,[_,"ZTE"],[m,O]],[/\b(nx\d{3}j) b/i],[u,[_,"ZTE"],[m,R]],[/\b(gen\d{3}) b.+49h/i],[u,[_,"Swiss"],[m,R]],[/\b(zur\d{3}) b/i],[u,[_,"Swiss"],[m,O]],[/\b((zeki)?tb.*\b) b/i],[u,[_,"Zeki"],[m,O]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[_,"Dragon Touch"],u,[m,O]],[/\b(ns-?\w{0,9}) b/i],[u,[_,"Insignia"],[m,O]],[/\b((nxa|next)-?\w{0,9}) b/i],[u,[_,"NextBook"],[m,O]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[_,"Voice"],u,[m,R]],[/\b(lvtel\-)?(v1[12]) b/i],[[_,"LvTel"],u,[m,R]],[/\b(ph-1) /i],[u,[_,"Essential"],[m,R]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[u,[_,"Envizen"],[m,O]],[/\b(trio[-\w\. ]+) b/i],[u,[_,"MachSpeed"],[m,O]],[/\btu_(1491) b/i],[u,[_,"Rotor"],[m,O]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[u,[_,ce],[m,O]],[/(sprint) (\w+)/i],[_,u,[m,R]],[/(kin\.[onetw]{3})/i],[[u,/\./g," "],[_,Ut],[m,R]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[u,[_,It],[m,O]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[u,[_,It],[m,R]],[/smart-tv.+(samsung)/i],[_,[m,D]],[/hbbtv.+maple;(\d+)/i],[[u,/^/,"SmartTV"],[_,k],[m,D]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[_,ct],[m,D]],[/(apple) ?tv/i],[_,[u,j+" TV"],[m,D]],[/crkey/i],[[u,he+"cast"],[_,Oe],[m,D]],[/droid.+aft(\w+)( bui|\))/i],[u,[_,G],[m,D]],[/(shield \w+ tv)/i],[u,[_,ce],[m,D]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[u,[_,F],[m,D]],[/(bravia[\w ]+)( bui|\))/i],[u,[_,se],[m,D]],[/(mi(tv|box)-?\w+) bui/i],[u,[_,ke],[m,D]],[/Hbbtv.*(technisat) (.*);/i],[_,u,[m,D]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[_,yu],[u,yu],[m,D]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[u,[m,D]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[m,D]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[_,u,[m,v]],[/droid.+; (shield)( bui|\))/i],[u,[_,ce],[m,v]],[/(playstation \w+)/i],[u,[_,se],[m,v]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[u,[_,Ut],[m,v]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[u,[_,k],[m,x]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[_,u,[m,x]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[u,[_,T],[m,x]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[u,[_,j],[m,x]],[/(opwwe\d{3})/i],[u,[_,ge],[m,x]],[/(moto 360)/i],[u,[_,ee],[m,x]],[/(smartwatch 3)/i],[u,[_,se],[m,x]],[/(g watch r)/i],[u,[_,ct],[m,x]],[/droid.+; (wt63?0{2,3})\)/i],[u,[_,It],[m,x]],[/droid.+; (glass) \d/i],[u,[_,Oe],[m,x]],[/(pico) (4|neo3(?: link|pro)?)/i],[_,u,[m,x]],[/; (quest( \d| pro)?)/i],[u,[_,vn],[m,x]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[_,[m,B]],[/(aeobc)\b/i],[u,[_,G],[m,B]],[/(homepod).+mac os/i],[u,[_,j],[m,B]],[/windows iot/i],[[m,B]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[u,[m,R]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[u,[m,O]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[m,O]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[m,R]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[u,[_,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[g,[p,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[p,g],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[g,[p,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[p,g],[/ladybird\//i],[[p,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[g,p]],os:[[/microsoft (windows) (vista|xp)/i],[p,g],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[p,[g,Ko,o1]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[g,Ko,o1],[p,"Windows"]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[g,/_/g,"."],[p,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[p,Ho],[g,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[g,p],[/(ubuntu) ([\w\.]+) like android/i],[[p,/(.+)/,"$1 Touch"],g],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/; ]?([\d\.]*)/i],[p,g],[/\(bb(10);/i],[g,[p,Z]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[g,[p,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[g,[p,De+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[g,[p,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[g,[p,"watchOS"]],[/crkey\/([\d\.]+)/i],[g,[p,he+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[p,lr],g],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[p,g],[/(sunos) ?([\w\.\d]*)/i],[[p,"Solaris"],g],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[p,g]]},os=function(an,hn){if(typeof an===o&&(hn=an,an=i),!(this instanceof os))return new os(an,hn).getResult();var Lt=typeof n!==s&&n.navigator?n.navigator:i,Ci=an||(Lt&&Lt.userAgent?Lt.userAgent:""),as=Lt&&Lt.userAgentData?Lt.userAgentData:i,Qt=hn?(function(rt,cs){var $a={};for(var xs in rt)cs[xs]&&cs[xs].length%2==0?$a[xs]=cs[xs].concat(rt[xs]):$a[xs]=rt[xs];return $a})(a1,hn):a1,so=Lt&&Lt.userAgent==Ci;return this.getBrowser=function(){var rt={};return rt[p]=i,rt[g]=i,Za.call(rt,Ci,Qt.browser),rt[c]=(function(cs){return typeof cs===a?cs.replace(/[^\d\.]/g,"").split(".")[0]:i})(rt[g]),so&&Lt&&Lt.brave&&typeof Lt.brave.isBrave==r&&(rt[p]="Brave"),rt},this.getCPU=function(){var rt={};return rt[b]=i,Za.call(rt,Ci,Qt.cpu),rt},this.getDevice=function(){var rt={};return rt[_]=i,rt[u]=i,rt[m]=i,Za.call(rt,Ci,Qt.device),so&&!rt[m]&&as&&as.mobile&&(rt[m]=R),so&&rt[u]=="Macintosh"&&Lt&&typeof Lt.standalone!==s&&Lt.maxTouchPoints&&Lt.maxTouchPoints>2&&(rt[u]="iPad",rt[m]=O),rt},this.getEngine=function(){var rt={};return rt[p]=i,rt[g]=i,Za.call(rt,Ci,Qt.engine),rt},this.getOS=function(){var rt={};return rt[p]=i,rt[g]=i,Za.call(rt,Ci,Qt.os),so&&!rt[p]&&as&&as.platform&&as.platform!="Unknown"&&(rt[p]=as.platform.replace(/chrome os/i,lr).replace(/macos/i,Ho)),rt},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Ci},this.setUA=function(rt){return Ci=typeof rt===a&&rt.length>500?yu(rt,500):rt,this},this.setUA(Ci),this};os.VERSION="0.7.41",os.BROWSER=Ld([p,g,c]),os.CPU=Ld([b]),os.DEVICE=Ld([u,_,m,v,R,D,O,x,B]),os.ENGINE=os.OS=Ld([p,g]),e.exports&&(t=e.exports=os),t.UAParser=os;var kd=typeof n!==s&&(n.jQuery||n.Zepto);if(kd&&!kd.ua){var Hm=new os;kd.ua=Hm.getResult(),kd.ua.get=function(){return Hm.getUA()},kd.ua.set=function(an){Hm.setUA(an);var hn=Hm.getResult();for(var Lt in hn)kd.ua[Lt]=hn[Lt]}}})(typeof window=="object"?window:f)})(rE,rE.exports);var hH=y(rE.exports),EA=fh.clear;pt({global:!0,bind:!0,forced:X.clearImmediate!==EA},{clearImmediate:EA});var SA=X,pH=pe,mH=kt,fH=o_,_H=Hs,gH=Eo,EH=ca,SH=SA.Function,yH=/MSIE .\./.test(_H)||fH==="BUN"&&(function(){var e=SA.Bun.version.split(".");return e.length<3||e[0]==="0"&&(e[1]<3||e[1]==="3"&&e[2]==="0")})(),TH=pt,yA=X,TA=fh.set,vH=function(e,t){var n=1;return yH?function(i,r){var s=EH(arguments.length,1)>n,o=mH(i)?i:SH(i),a=s?gH(arguments,n):[],c=s?function(){pH(o,this,a)}:o;return e(c)}:e},vA=yA.setImmediate?vH(TA):TA;TH({global:!0,bind:!0,forced:yA.setImmediate!==vA},{setImmediate:vA});var RA=y(Mi.setImmediate),RH=X,CH=NC,bH=Ui,wH=ca,AH=qe;pt({global:!0,dontCallGetSet:!0,forced:w((function(){return AH&&Object.getOwnPropertyDescriptor(RH,"queueMicrotask").value.length!==1}))},{queueMicrotask:function(e){wH(arguments.length,1),CH(bH(e))}});var CA=y(Mi.queueMicrotask);function bA(e,t){return function(){return e.apply(t,arguments)}}const{toString:IH}=Object.prototype,{getPrototypeOf:sE}=Object,{iterator:Gh,toStringTag:wA}=Symbol,Hh=(oE=Object.create(null),e=>{const t=IH.call(e);return oE[t]||(oE[t]=t.slice(8,-1).toLowerCase())});var oE;const Wr=e=>(e=e.toLowerCase(),t=>Hh(t)===e),Kh=e=>t=>typeof t===e,{isArray:jc}=Array,Fc=Kh("undefined");function El(e){return e!==null&&!Fc(e)&&e.constructor!==null&&!Fc(e.constructor)&&Vi(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}const AA=Wr("ArrayBuffer"),OH=Kh("string"),Vi=Kh("function"),IA=Kh("number"),Sl=e=>e!==null&&typeof e=="object",Yh=e=>{if(Hh(e)!=="object")return!1;const t=sE(e);return!(t!==null&&t!==Object.prototype&&Object.getPrototypeOf(t)!==null||wA in e||Gh in e)},NH=Wr("Date"),DH=Wr("File"),PH=Wr("Blob"),LH=Wr("FileList"),kH=Wr("URLSearchParams"),[xH,MH,UH,VH]=["ReadableStream","Request","Response","Headers"].map(Wr);function yl(e,t){let n,i,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(e!=null)if(typeof e!="object"&&(e=[e]),jc(e))for(n=0,i=e.length;n<i;n++)t.call(null,e[n],n,e);else{if(El(e))return;const s=r?Object.getOwnPropertyNames(e):Object.keys(e),o=s.length;let a;for(n=0;n<o;n++)a=s[n],t.call(null,e[a],a,e)}}function OA(e,t){if(El(e))return null;t=t.toLowerCase();const n=Object.keys(e);let i,r=n.length;for(;r-- >0;)if(i=n[r],t===i.toLowerCase())return i;return null}const fa=gA!==void 0?gA:typeof self<"u"?self:typeof window<"u"?window:lT,NA=e=>!Fc(e)&&e!==fa,jH=(aE=typeof Uint8Array<"u"&&sE(Uint8Array),e=>aE&&e instanceof aE);var aE;const FH=Wr("HTMLFormElement"),DA=(e=>{let{hasOwnProperty:t}=e;return(n,i)=>t.call(n,i)})(Object.prototype),BH=Wr("RegExp"),PA=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),i={};yl(n,((r,s)=>{let o;(o=t(r,s,e))!==!1&&(i[s]=o||r)})),Object.defineProperties(e,i)},WH=Wr("AsyncFunction"),LA=(kA=typeof RA=="function",xA=Vi(fa.postMessage),kA?RA:xA?(cE="axios@".concat(Math.random()),zh=[],fa.addEventListener("message",(e=>{let{source:t,data:n}=e;t===fa&&n===cE&&zh.length&&zh.shift()()}),!1),e=>{zh.push(e),fa.postMessage(cE,"*")}):e=>setTimeout(e));var kA,xA,cE,zh;const GH=CA!==void 0?CA.bind(fa):typeof process<"u"&&process.nextTick||LA;var ue={isArray:jc,isArrayBuffer:AA,isBuffer:El,isFormData:e=>{let t;return e&&(typeof FormData=="function"&&e instanceof FormData||Vi(e.append)&&((t=Hh(e))==="formdata"||t==="object"&&Vi(e.toString)&&e.toString()==="[object FormData]"))},isArrayBufferView:function(e){let t;return t=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&AA(e.buffer),t},isString:OH,isNumber:IA,isBoolean:e=>e===!0||e===!1,isObject:Sl,isPlainObject:Yh,isEmptyObject:e=>{if(!Sl(e)||El(e))return!1;try{return Object.keys(e).length===0&&Object.getPrototypeOf(e)===Object.prototype}catch{return!1}},isReadableStream:xH,isRequest:MH,isResponse:UH,isHeaders:VH,isUndefined:Fc,isDate:NH,isFile:DH,isBlob:PH,isRegExp:BH,isFunction:Vi,isStream:e=>Sl(e)&&Vi(e.pipe),isURLSearchParams:kH,isTypedArray:jH,isFileList:LH,forEach:yl,merge:function e(){const{caseless:t,skipUndefined:n}=NA(this)&&this||{},i={},r=(s,o)=>{const a=t&&OA(i,o)||o;Yh(i[a])&&Yh(s)?i[a]=e(i[a],s):Yh(s)?i[a]=e({},s):jc(s)?i[a]=s.slice():n&&Fc(s)||(i[a]=s)};for(let s=0,o=arguments.length;s<o;s++)arguments[s]&&yl(arguments[s],r);return i},extend:function(e,t,n){let{allOwnKeys:i}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return yl(t,((r,s)=>{n&&Vi(r)?e[s]=bA(r,n):e[s]=r}),{allOwnKeys:i}),e},trim:e=>ti(e)?ti(e).call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(e.charCodeAt(0)===65279&&(e=e.slice(1)),e),inherits:(e,t,n,i)=>{e.prototype=Object.create(t.prototype,i),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),n&&Object.assign(e.prototype,n)},toFlatObject:(e,t,n,i)=>{let r,s,o;const a={};if(t=t||{},e==null)return t;do{for(r=Object.getOwnPropertyNames(e),s=r.length;s-- >0;)o=r[s],i&&!i(o,e,t)||a[o]||(t[o]=e[o],a[o]=!0);e=n!==!1&&sE(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},kindOf:Hh,kindOfTest:Wr,endsWith:(e,t,n)=>{e=String(e),(n===void 0||n>e.length)&&(n=e.length),n-=t.length;const i=e.indexOf(t,n);return i!==-1&&i===n},toArray:e=>{if(!e)return null;if(jc(e))return e;let t=e.length;if(!IA(t))return null;const n=new Array(t);for(;t-- >0;)n[t]=e[t];return n},forEachEntry:(e,t)=>{const n=(e&&e[Gh]).call(e);let i;for(;(i=n.next())&&!i.done;){const r=i.value;t.call(e,r[0],r[1])}},matchAll:(e,t)=>{let n;const i=[];for(;(n=e.exec(t))!==null;)i.push(n);return i},isHTMLForm:FH,hasOwnProperty:DA,hasOwnProp:DA,reduceDescriptors:PA,freezeMethods:e=>{PA(e,((t,n)=>{if(Vi(e)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const i=e[n];Vi(i)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))}))},toObjectSet:(e,t)=>{const n={},i=r=>{r.forEach((s=>{n[s]=!0}))};return jc(e)?i(e):i(String(e).split(t)),n},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,(function(t,n,i){return n.toUpperCase()+i})),noop:()=>{},toFiniteNumber:(e,t)=>e!=null&&Number.isFinite(e=+e)?e:t,findKey:OA,global:fa,isContextDefined:NA,isSpecCompliantForm:function(e){return!!(e&&Vi(e.append)&&e[wA]==="FormData"&&e[Gh])},toJSONObject:e=>{const t=new Array(10),n=(i,r)=>{if(Sl(i)){if(t.indexOf(i)>=0)return;if(El(i))return i;if(!("toJSON"in i)){t[r]=i;const s=jc(i)?[]:{};return yl(i,((o,a)=>{const c=n(o,r+1);!Fc(c)&&(s[a]=c)})),t[r]=void 0,s}}return i};return n(e,0)},isAsyncFn:WH,isThenable:e=>e&&(Sl(e)||Vi(e))&&Vi(e.then)&&Vi(e.catch),setImmediate:LA,asap:GH,isIterable:e=>e!=null&&Vi(e[Gh])};function vt(e,t,n,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r,this.status=r.status?r.status:null)}ue.inherits(vt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:ue.toJSONObject(this.config),code:this.code,status:this.status}}});const MA=vt.prototype,UA={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach((e=>{UA[e]={value:e}})),Object.defineProperties(vt,UA),Object.defineProperty(MA,"isAxiosError",{value:!0}),vt.from=(e,t,n,i,r,s)=>{const o=Object.create(MA);ue.toFlatObject(e,o,(function(u){return u!==Error.prototype}),(u=>u!=="isAxiosError"));const a=e&&e.message?e.message:"Error",c=t==null&&e?e.code:t;return vt.call(o,a,c,n,i,r),e&&o.cause==null&&Object.defineProperty(o,"cause",{value:e,configurable:!0}),o.name=e&&e.name||"Error",s&&Object.assign(o,s),o};function dE(e){return ue.isPlainObject(e)||ue.isArray(e)}function VA(e){return ue.endsWith(e,"[]")?e.slice(0,-2):e}function jA(e,t,n){return e?e.concat(t).map((function(i,r){return i=VA(i),!n&&r?"["+i+"]":i})).join(n?".":""):t}const HH=ue.toFlatObject(ue,{},null,(function(e){return/^is[A-Z]/.test(e)}));function qh(e,t,n){if(!ue.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const i=(n=ue.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,(function(_,g){return!ue.isUndefined(g[_])}))).metaTokens,r=n.visitor||u,s=n.dots,o=n.indexes,a=(n.Blob||typeof Blob<"u"&&Blob)&&ue.isSpecCompliantForm(t);if(!ue.isFunction(r))throw new TypeError("visitor must be a function");function c(_){if(_===null)return"";if(ue.isDate(_))return _.toISOString();if(ue.isBoolean(_))return _.toString();if(!a&&ue.isBlob(_))throw new vt("Blob is not supported. Use a Buffer instead.");return ue.isArrayBuffer(_)||ue.isTypedArray(_)?a&&typeof Blob=="function"?new Blob([_]):Buffer.from(_):_}function u(_,g,b){let v=_;if(_&&!b&&typeof _=="object"){if(ue.endsWith(g,"{}"))g=i?g:g.slice(0,-2),_=JSON.stringify(_);else if(ue.isArray(_)&&(function(R){return ue.isArray(R)&&!R.some(dE)})(_)||(ue.isFileList(_)||ue.endsWith(g,"[]"))&&(v=ue.toArray(_)))return g=VA(g),v.forEach((function(R,O){!ue.isUndefined(R)&&R!==null&&t.append(o===!0?jA([g],O,s):o===null?g:g+"[]",c(R))})),!1}return!!dE(_)||(t.append(jA(b,g,s),c(_)),!1)}const p=[],m=Object.assign(HH,{defaultVisitor:u,convertValue:c,isVisitable:dE});if(!ue.isObject(e))throw new TypeError("data must be an object");return(function _(g,b){if(!ue.isUndefined(g)){if(p.indexOf(g)!==-1)throw Error("Circular reference detected in "+b.join("."));p.push(g),ue.forEach(g,(function(v,R){(!(ue.isUndefined(v)||v===null)&&r.call(t,v,ue.isString(R)?ti(R).call(R):R,b,m))===!0&&_(v,b?b.concat(R):[R])})),p.pop()}})(e),t}function FA(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,(function(n){return t[n]}))}function lE(e,t){this._pairs=[],e&&qh(e,this,t)}const BA=lE.prototype;function KH(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function WA(e,t,n){if(!t)return e;const i=n&&n.encode||KH;ue.isFunction(n)&&(n={serialize:n});const r=n&&n.serialize;let s;if(s=r?r(t,n):ue.isURLSearchParams(t)?t.toString():new lE(t,n).toString(i),s){const o=e.indexOf("#");o!==-1&&(e=e.slice(0,o)),e+=(e.indexOf("?")===-1?"?":"&")+s}return e}BA.append=function(e,t){this._pairs.push([e,t])},BA.toString=function(e){const t=e?function(n){return e.call(this,n,FA)}:FA;return this._pairs.map((function(n){return t(n[0])+"="+t(n[1])}),"").join("&")};var GA=class{constructor(){this.handlers=[]}use(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){ue.forEach(this.handlers,(function(t){t!==null&&e(t)}))}},HA={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},KA={exports:{}},YH=pt,zH=qe,YA=pr.f;YH({target:"Object",stat:!0,forced:Object.defineProperty!==YA,sham:!zH},{defineProperty:YA});var zA=Mi.Object,qH=KA.exports=function(e,t,n){return zA.defineProperty(e,t,n)};zA.defineProperty.sham&&(qH.sham=!0);var qA=y(KA.exports),XH=TypeError,XA=$d,JH=mh,QH=ei,ZH=rn("species"),JA=Array,$H=function(e){var t;return XA(e)&&(t=e.constructor,(JH(t)&&(t===JA||XA(t.prototype))||QH(t)&&(t=t[ZH])===null)&&(t=void 0)),t===void 0?JA:t},QA=function(e,t){return new($H(e))(t===0?0:t)},eK=w,tK=ra,nK=rn("species"),ZA=function(e){return tK>=51||!eK((function(){var t=[];return(t.constructor={})[nK]=function(){return{foo:1}},t[e](Boolean).foo!==1}))},iK=pt,rK=w,sK=$d,oK=ei,aK=ps,cK=fo,$A=function(e){if(e>9007199254740991)throw XH("Maximum allowed index exceeded");return e},eI=Sg,dK=QA,lK=ZA,uK=ra,tI=rn("isConcatSpreadable"),hK=uK>=51||!rK((function(){var e=[];return e[tI]=!1,e.concat()[0]!==e})),pK=function(e){if(!oK(e))return!1;var t=e[tI];return t!==void 0?!!t:sK(e)};iK({target:"Array",proto:!0,forced:!hK||!lK("concat")},{concat:function(e){var t,n,i,r,s,o=aK(this),a=dK(o,0),c=0;for(t=-1,i=arguments.length;t<i;t++)if(pK(s=t===-1?o:arguments[t]))for(r=cK(s),$A(c+r),n=0;n<r;n++,c++)n in s&&eI(a,c,s[n]);else $A(c+1),eI(a,c++,s);return a.length=c,a}});var nI={},mK=Ee,fK=po,iI=Zu.f,_K=Eo,rI=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];nI.f=function(e){return rI&&mK(e)==="Window"?(function(t){try{return iI(t)}catch{return _K(rI)}})(e):iI(fK(e))};var Bc={},gK=rn;Bc.f=gK;var sI=Mi,EK=Hn,SK=Bc,yK=pr.f,On=function(e){var t=sI.Symbol||(sI.Symbol={});EK(t,e)||yK(t,e,{value:SK.f(e)})},TK=zt,vK=di,RK=rn,CK=go,oI=function(){var e=vK("Symbol"),t=e&&e.prototype,n=t&&t.valueOf,i=RK("toPrimitive");t&&!t[i]&&CK(t,i,(function(r){return TK(n,this)}),{})},bK=mo,wK=uo,AK=ps,IK=fo,OK=QA,aI=V([].push),NK=function(e){var t=e===1,n=e===2,i=e===3,r=e===4,s=e===6,o=e===7,a=e===5||s;return function(c,u,p,m){for(var _,g,b=AK(c),v=wK(b),R=IK(v),O=bK(u,p),D=0,x=m||OK,B=t?x(c,R):n||o?x(c,0):void 0;R>D;D++)if((a||D in v)&&(g=O(_=v[D],D,b),e))if(t)B[D]=g;else if(g)switch(e){case 3:return!0;case 5:return _;case 6:return D;case 2:aI(B,_)}else switch(e){case 4:return!1;case 7:aI(B,_)}return s?-1:i||r?r:B}},cI={forEach:NK(0)},Xh=pt,Tl=X,uE=zt,DK=V,Wc=qe,Gc=pc,PK=w,ni=Hn,LK=W,hE=wi,Jh=po,pE=Yf,kK=Ai,mE=Vr,Hc=tl,dI=eh,xK=Zu,lI=nI,MK=el,uI=ze,hI=pr,UK=p_,pI=hs,mI=go,VK=ph,fE=fc,fI=$u,_I=Hf,jK=rn,FK=Bc,BK=On,WK=oI,GK=Ks,gI=aa,Qh=cI.forEach,ji=Qu("hidden"),Zh="Symbol",vl="prototype",HK=gI.set,EI=gI.getterFor(Zh),Gr=Object[vl],_a=Tl.Symbol,$h=_a&&_a[vl],KK=Tl.RangeError,YK=Tl.TypeError,_E=Tl.QObject,SI=uI.f,ga=hI.f,yI=lI.f,zK=pI.f,TI=DK([].push),qs=fE("symbols"),Rl=fE("op-symbols"),qK=fE("wks"),gE=!_E||!_E[vl]||!_E[vl].findChild,vI=function(e,t,n){var i=SI(Gr,t);i&&delete Gr[t],ga(e,t,n),i&&e!==Gr&&ga(Gr,t,i)},EE=Wc&&PK((function(){return Hc(ga({},"a",{get:function(){return ga(this,"a",{value:7}).a}})).a!==7}))?vI:ga,SE=function(e,t){var n=qs[e]=Hc($h);return HK(n,{type:Zh,tag:e,description:t}),Wc||(n.description=t),n},ep=function(e,t,n){e===Gr&&ep(Rl,t,n),hE(e);var i=pE(t);return hE(n),ni(qs,i)?(n.enumerable?(ni(e,ji)&&e[ji][i]&&(e[ji][i]=!1),n=Hc(n,{enumerable:mE(0,!1)})):(ni(e,ji)||ga(e,ji,mE(1,Hc(null))),e[ji][i]=!0),EE(e,i,n)):ga(e,i,n)},yE=function(e,t){hE(e);var n=Jh(t),i=dI(n).concat(wI(n));return Qh(i,(function(r){Wc&&!uE(RI,n,r)||ep(e,r,n[r])})),e},RI=function(e){var t=pE(e),n=uE(zK,this,t);return!(this===Gr&&ni(qs,t)&&!ni(Rl,t))&&(!(n||!ni(this,t)||!ni(qs,t)||ni(this,ji)&&this[ji][t])||n)},CI=function(e,t){var n=Jh(e),i=pE(t);if(n!==Gr||!ni(qs,i)||ni(Rl,i)){var r=SI(n,i);return!r||!ni(qs,i)||ni(n,ji)&&n[ji][i]||(r.enumerable=!0),r}},bI=function(e){var t=yI(Jh(e)),n=[];return Qh(t,(function(i){ni(qs,i)||ni(fI,i)||TI(n,i)})),n},wI=function(e){var t=e===Gr,n=yI(t?Rl:Jh(e)),i=[];return Qh(n,(function(r){!ni(qs,r)||t&&!ni(Gr,r)||TI(i,qs[r])})),i};Gc||(_a=function(){if(LK($h,this))throw new YK("Symbol is not a constructor");var e=arguments.length&&arguments[0]!==void 0?kK(arguments[0]):void 0,t=_I(e),n=function(i){var r=this===void 0?Tl:this;r===Gr&&uE(n,Rl,i),ni(r,ji)&&ni(r[ji],t)&&(r[ji][t]=!1);var s=mE(1,i);try{EE(r,t,s)}catch(o){if(!(o instanceof KK))throw o;vI(r,t,s)}};return Wc&&gE&&EE(Gr,t,{configurable:!0,set:n}),SE(t,e)},mI($h=_a[vl],"toString",(function(){return EI(this).tag})),mI(_a,"withoutSetter",(function(e){return SE(_I(e),e)})),pI.f=RI,hI.f=ep,UK.f=yE,uI.f=CI,xK.f=lI.f=bI,MK.f=wI,FK.f=function(e){return SE(jK(e),e)},Wc&&VK($h,"description",{configurable:!0,get:function(){return EI(this).description}})),Xh({global:!0,wrap:!0,forced:!Gc,sham:!Gc},{Symbol:_a}),Qh(dI(qK),(function(e){BK(e)})),Xh({target:Zh,stat:!0,forced:!Gc},{useSetter:function(){gE=!0},useSimple:function(){gE=!1}}),Xh({target:"Object",stat:!0,forced:!Gc,sham:!Wc},{create:function(e,t){return t===void 0?Hc(e):yE(Hc(e),t)},defineProperty:ep,defineProperties:yE,getOwnPropertyDescriptor:CI}),Xh({target:"Object",stat:!0,forced:!Gc},{getOwnPropertyNames:bI}),WK(),GK(_a,Zh),fI[ji]=!0;var AI=pc&&!!Symbol.for&&!!Symbol.keyFor,XK=pt,JK=di,QK=Hn,ZK=Ai,II=fc,$K=AI,TE=II("string-to-symbol-registry"),e8=II("symbol-to-string-registry");XK({target:"Symbol",stat:!0,forced:!$K},{for:function(e){var t=ZK(e);if(QK(TE,t))return TE[t];var n=JK("Symbol")(t);return TE[t]=n,e8[n]=t,n}});var t8=pt,n8=Hn,i8=qd,r8=mc,s8=AI,OI=fc("symbol-to-string-registry");t8({target:"Symbol",stat:!0,forced:!s8},{keyFor:function(e){if(!i8(e))throw new TypeError(r8(e)+" is not a symbol");if(n8(OI,e))return OI[e]}});var NI=$d,o8=kt,DI=Ee,a8=Ai,PI=V([].push),c8=pt,LI=di,kI=pe,d8=zt,Cl=V,xI=w,MI=kt,UI=qd,VI=Eo,l8=function(e){if(o8(e))return e;if(NI(e)){for(var t=e.length,n=[],i=0;i<t;i++){var r=e[i];typeof r=="string"?PI(n,r):typeof r!="number"&&DI(r)!=="Number"&&DI(r)!=="String"||PI(n,a8(r))}var s=n.length,o=!0;return function(a,c){if(o)return o=!1,c;if(NI(this))return c;for(var u=0;u<s;u++)if(n[u]===a)return c}}},u8=pc,h8=String,Co=LI("JSON","stringify"),tp=Cl(/./.exec),jI=Cl("".charAt),p8=Cl("".charCodeAt),m8=Cl("".replace),f8=Cl(1.1.toString),_8=/[\uD800-\uDFFF]/g,FI=/^[\uD800-\uDBFF]$/,BI=/^[\uDC00-\uDFFF]$/,WI=!u8||xI((function(){var e=LI("Symbol")("stringify detection");return Co([e])!=="[null]"||Co({a:e})!=="{}"||Co(Object(e))!=="{}"})),GI=xI((function(){return Co("\uDF06\uD834")!=='"\\udf06\\ud834"'||Co("\uDEAD")!=='"\\udead"'})),g8=function(e,t){var n=VI(arguments),i=l8(t);if(MI(i)||e!==void 0&&!UI(e))return n[1]=function(r,s){if(MI(i)&&(s=d8(i,this,h8(r),s)),!UI(s))return s},kI(Co,null,n)},E8=function(e,t,n){var i=jI(n,t-1),r=jI(n,t+1);return tp(FI,e)&&!tp(BI,r)||tp(BI,e)&&!tp(FI,i)?"\\u"+f8(p8(e,0),16):e};Co&&c8({target:"JSON",stat:!0,forced:WI||GI},{stringify:function(e,t,n){var i=VI(arguments),r=kI(WI?g8:Co,null,i);return GI&&typeof r=="string"?m8(r,_8,E8):r}});var HI=el,S8=ps;pt({target:"Object",stat:!0,forced:!pc||w((function(){HI.f(1)}))},{getOwnPropertySymbols:function(e){var t=HI.f;return t?t(S8(e)):[]}}),On("asyncDispose"),On("asyncIterator"),On("dispose"),On("hasInstance"),On("isConcatSpreadable"),On("iterator"),On("match"),On("matchAll"),On("replace"),On("search"),On("species"),On("split");var y8=oI;On("toPrimitive"),y8();var T8=di,v8=Ks;On("toStringTag"),v8(T8("Symbol"),"Symbol"),On("unscopables"),Ks(X.JSON,"JSON",!0);var R8=Mi.Symbol,C8=rn,b8=pr.f,KI=C8("metadata"),YI=Function.prototype;YI[KI]===void 0&&b8(YI,KI,{value:null}),On("metadata");var w8=R8,A8=V,vE=di("Symbol"),I8=vE.keyFor,O8=A8(vE.prototype.valueOf),zI=vE.isRegisteredSymbol||function(e){try{return I8(O8(e))!==void 0}catch{return!1}};pt({target:"Symbol",stat:!0},{isRegisteredSymbol:zI});for(var N8=fc,qI=di,D8=V,P8=qd,L8=rn,np=qI("Symbol"),XI=np.isWellKnownSymbol,JI=qI("Object","getOwnPropertyNames"),k8=D8(np.prototype.valueOf),QI=N8("wks"),RE=0,ZI=JI(np),x8=ZI.length;RE<x8;RE++)try{var $I=ZI[RE];P8(np[$I])&&L8($I)}catch{}var e0=function(e){if(XI&&XI(e))return!0;try{for(var t=k8(e),n=0,i=JI(QI),r=i.length;n<r;n++)if(QI[i[n]]==t)return!0}catch{}return!1};pt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:e0}),On("customMatcher"),On("observable"),pt({target:"Symbol",stat:!0},{isRegistered:zI}),pt({target:"Symbol",stat:!0,forced:!0},{isWellKnown:e0}),On("matcher"),On("metadataKey"),On("patternMatch"),On("replaceAll");var Kc=y(w8),t0=y(Bc.f("iterator"));function bl(e){return bl=typeof Kc=="function"&&typeof t0=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Kc=="function"&&t.constructor===Kc&&t!==Kc.prototype?"symbol":typeof t},bl(e)}var M8=y(Bc.f("toPrimitive"));function U8(e){var t=(function(n,i){if(bl(n)!="object"||!n)return n;var r=n[M8];if(r!==void 0){var s=r.call(n,i);if(bl(s)!="object")return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return(i==="string"?String:Number)(n)})(e,"string");return bl(t)=="symbol"?t:t+""}function C(e,t,n){return(t=U8(t))in e?qA(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var n0=y(d4),V8={isBrowser:!0,classes:{URLSearchParams:n0!==void 0?n0:lE,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const CE=typeof window<"u"&&typeof document<"u",bE=typeof navigator=="object"&&navigator||void 0,j8=CE&&(!bE||["ReactNative","NativeScript","NS"].indexOf(bE.product)<0),F8=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",B8=CE&&window.location.href||"http://localhost";function i0(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function r0(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?i0(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i0(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}var Si=r0(r0({},Object.freeze({__proto__:null,hasBrowserEnv:CE,hasStandardBrowserEnv:j8,hasStandardBrowserWebWorkerEnv:F8,navigator:bE,origin:B8})),V8);function s0(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function W8(e,t){return qh(e,new Si.classes.URLSearchParams,(function(n){for(var i=1;i<arguments.length;i++){var r=arguments[i]!=null?arguments[i]:{};i%2?s0(Object(r),!0).forEach((function(s){C(n,s,r[s])})):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):s0(Object(r)).forEach((function(s){Object.defineProperty(n,s,Object.getOwnPropertyDescriptor(r,s))}))}return n})({visitor:function(n,i,r,s){return Si.isNode&&ue.isBuffer(n)?(this.append(i,n.toString("base64")),!1):s.defaultVisitor.apply(this,arguments)}},t))}var G8=sg.charAt,o0=zt,H8=wi,K8=kt,Y8=Ee,z8=/./.exec,q8=TypeError,X8=pt,a0=zt,c0=Tt,J8=w_,ip=uh,d0=ho,l0=oR,wl=Ai,Q8=wi,Z8=ei,$8=Ee,eY=n_,u0=Jg,tY=Xd,nY=w,iY=P_,rY=function(e,t,n){return t+(n?G8(e,t).length:1)},sY=function(e,t){var n=e.exec;if(K8(n)){var i=o0(n,e,t);return i!==null&&H8(i),i}if(Y8(e)==="RegExp")return o0(z8,e,t);throw new q8("RegExp#exec called on incompatible receiver")},h0=aa,oY=rn("matchAll"),p0="RegExp String",m0=p0+" Iterator",aY=h0.set,cY=h0.getterFor(m0),dY=TypeError,wE=c0("".indexOf),rp=c0("".matchAll),AE=!!rp&&!nY((function(){rp("a",/./)})),lY=J8((function(e,t,n,i){aY(this,{type:m0,regexp:e,string:t,global:n,unicode:i,done:!1})}),p0,(function(){var e=cY(this);if(e.done)return ip(void 0,!0);var t=e.regexp,n=e.string,i=sY(t,n);return i===null?(e.done=!0,ip(void 0,!0)):e.global?(wl(i[0])===""&&(t.lastIndex=rY(n,l0(t.lastIndex),e.unicode)),ip(i,!1)):(e.done=!0,ip(i,!1))})),f0=function(e){var t,n,i,r=Q8(this),s=wl(e),o=iY(r,RegExp),a=wl(u0(r));return t=new o(o===RegExp?r.source:r,a),n=!!~wE(a,"g"),i=!!~wE(a,"u"),t.lastIndex=l0(r.lastIndex),new lY(t,s,n,i)};X8({target:"String",proto:!0,forced:AE},{matchAll:function(e){var t,n,i,r,s=d0(this);if(Z8(e)){if(eY(e)&&(t=wl(d0(u0(e))),!~wE(t,"g")))throw new dY("`.matchAll` does not allow non-global regexes");if(AE)return rp(s,e);if((i=tY(e,oY))===void 0&&$8(e)==="RegExp"&&(i=f0),i)return a0(i,e,s)}else if(AE)return rp(s,e);return n=wl(s),r=new RegExp(e,"g"),a0(f0,r,n)}});var uY=Zi("String","matchAll"),hY=W,pY=uY,IE=String.prototype,mY=function(e){var t=e.matchAll;return typeof e=="string"||e===IE||hY(IE,e)&&t===IE.matchAll?pY:t},fY=y(mY);function _0(e){function t(n,i,r,s){let o=n[s++];if(o==="__proto__")return!0;const a=Number.isFinite(+o),c=s>=n.length;return o=!o&&ue.isArray(r)?r.length:o,c?(ue.hasOwnProp(r,o)?r[o]=[r[o],i]:r[o]=i,!a):(r[o]&&ue.isObject(r[o])||(r[o]=[]),t(n,i,r[o],s)&&ue.isArray(r[o])&&(r[o]=(function(u){const p={},m=Object.keys(u);let _;const g=m.length;let b;for(_=0;_<g;_++)b=m[_],p[b]=u[b];return p})(r[o])),!a)}if(ue.isFormData(e)&&ue.isFunction(e.entries)){const n={};return ue.forEachEntry(e,((i,r)=>{t((function(s){return fY(ue).call(ue,/\w+|\[(\w*)]/g,s).map((o=>o[0]==="[]"?"":o[1]||o[0]))})(i),r,n,0)})),n}return null}const OE={transitional:HA,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const n=t.getContentType()||"",i=n.indexOf("application/json")>-1,r=ue.isObject(e);if(r&&ue.isHTMLForm(e)&&(e=new FormData(e)),ue.isFormData(e))return i?JSON.stringify(_0(e)):e;if(ue.isArrayBuffer(e)||ue.isBuffer(e)||ue.isStream(e)||ue.isFile(e)||ue.isBlob(e)||ue.isReadableStream(e))return e;if(ue.isArrayBufferView(e))return e.buffer;if(ue.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let s;if(r){if(n.indexOf("application/x-www-form-urlencoded")>-1)return W8(e,this.formSerializer).toString();if((s=ue.isFileList(e))||n.indexOf("multipart/form-data")>-1){const o=this.env&&this.env.FormData;return qh(s?{"files[]":e}:e,o&&new o,this.formSerializer)}}return r||i?(t.setContentType("application/json",!1),(function(o,a,c){if(ue.isString(o))try{return(a||JSON.parse)(o),ti(ue).call(ue,o)}catch(u){if(u.name!=="SyntaxError")throw u}return(c||JSON.stringify)(o)})(e)):e}],transformResponse:[function(e){const t=this.transitional||OE.transitional,n=t&&t.forcedJSONParsing,i=this.responseType==="json";if(ue.isResponse(e)||ue.isReadableStream(e))return e;if(e&&ue.isString(e)&&(n&&!this.responseType||i)){const r=!(t&&t.silentJSONParsing)&&i;try{return JSON.parse(e,this.parseReviver)}catch(s){if(r)throw s.name==="SyntaxError"?vt.from(s,vt.ERR_BAD_RESPONSE,this,null,this.response):s}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Si.classes.FormData,Blob:Si.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};ue.forEach(["delete","get","head","post","put","patch"],(e=>{OE.headers[e]={}}));var NE=OE;const _Y=ue.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),g0=Symbol("internals");function Al(e){var t;return e&&ti(t=String(e)).call(t).toLowerCase()}function sp(e){return e===!1||e==null?e:ue.isArray(e)?e.map(sp):String(e)}function DE(e,t,n,i,r){return ue.isFunction(i)?i.call(this,t,n):(r&&(t=n),ue.isString(t)?ue.isString(i)?t.indexOf(i)!==-1:ue.isRegExp(i)?i.test(t):void 0:void 0)}class op{constructor(t){t&&this.set(t)}set(t,n,i){const r=this;function s(c,u,p){const m=Al(u);if(!m)throw new Error("header name must be a non-empty string");const _=ue.findKey(r,m);(!_||r[_]===void 0||p===!0||p===void 0&&r[_]!==!1)&&(r[_||u]=sp(c))}const o=(c,u)=>ue.forEach(c,((p,m)=>s(p,m,u)));if(ue.isPlainObject(t)||t instanceof this.constructor)o(t,n);else if(ue.isString(t)&&(t=ti(t).call(t))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(ti(a=t).call(a)))o((c=>{const u={};let p,m,_;return c&&c.split(`
`).forEach((function(g){var b,v;_=g.indexOf(":"),p=ti(b=g.substring(0,_)).call(b).toLowerCase(),m=ti(v=g.substring(_+1)).call(v),!p||u[p]&&_Y[p]||(p==="set-cookie"?u[p]?u[p].push(m):u[p]=[m]:u[p]=u[p]?u[p]+", "+m:m)})),u})(t),n);else if(ue.isObject(t)&&ue.isIterable(t)){let c,u,p={};for(const m of t){if(!ue.isArray(m))throw TypeError("Object iterator must return a key-value pair");p[u=m[0]]=(c=p[u])?ue.isArray(c)?[...c,m[1]]:[c,m[1]]:m[1]}o(p,n)}else t!=null&&s(n,t,i);var a;return this}get(t,n){if(t=Al(t)){const i=ue.findKey(this,t);if(i){const r=this[i];if(!n)return r;if(n===!0)return(function(s){const o=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let c;for(;c=a.exec(s);)o[c[1]]=c[2];return o})(r);if(ue.isFunction(n))return n.call(this,r,i);if(ue.isRegExp(n))return n.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,n){if(t=Al(t)){const i=ue.findKey(this,t);return!(!i||this[i]===void 0||n&&!DE(0,this[i],i,n))}return!1}delete(t,n){const i=this;let r=!1;function s(o){if(o=Al(o)){const a=ue.findKey(i,o);!a||n&&!DE(0,i[a],a,n)||(delete i[a],r=!0)}}return ue.isArray(t)?t.forEach(s):s(t),r}clear(t){const n=Object.keys(this);let i=n.length,r=!1;for(;i--;){const s=n[i];t&&!DE(0,this[s],s,t,!0)||(delete this[s],r=!0)}return r}normalize(t){const n=this,i={};return ue.forEach(this,((r,s)=>{var o;const a=ue.findKey(i,s);if(a)return n[a]=sp(r),void delete n[s];const c=t?(function(u){return ti(u).call(u).toLowerCase().replace(/([a-z\d])(\w*)/g,((p,m,_)=>m.toUpperCase()+_))})(s):ti(o=String(s)).call(o);c!==s&&delete n[s],n[c]=sp(r),i[c]=!0})),this}concat(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return this.constructor.concat(this,...n)}toJSON(t){const n=Object.create(null);return ue.forEach(this,((i,r)=>{i!=null&&i!==!1&&(n[r]=t&&ue.isArray(i)?i.join(", "):i)})),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map((t=>{let[n,i]=t;return n+": "+i})).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t){const n=new this(t);for(var i=arguments.length,r=new Array(i>1?i-1:0),s=1;s<i;s++)r[s-1]=arguments[s];return r.forEach((o=>n.set(o))),n}static accessor(t){const n=(this[g0]=this[g0]={accessors:{}}).accessors,i=this.prototype;function r(s){const o=Al(s);n[o]||((function(a,c){const u=ue.toCamelCase(" "+c);["get","set","has"].forEach((p=>{Object.defineProperty(a,p+u,{value:function(m,_,g){return this[p].call(this,c,m,_,g)},configurable:!0})}))})(i,s),n[o]=!0)}return ue.isArray(t)?t.forEach(r):r(t),this}}op.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),ue.reduceDescriptors(op.prototype,((e,t)=>{let{value:n}=e,i=t[0].toUpperCase()+t.slice(1);return{get:()=>n,set(r){this[i]=r}}})),ue.freezeMethods(op);var Hr=op;function PE(e,t){const n=this||NE,i=t||n,r=Hr.from(i.headers);let s=i.data;return ue.forEach(e,(function(o){s=o.call(n,s,r.normalize(),t?t.status:void 0)})),r.normalize(),s}function E0(e){return!(!e||!e.__CANCEL__)}function Yc(e,t,n){vt.call(this,e??"canceled",vt.ERR_CANCELED,t,n),this.name="CanceledError"}function S0(e,t,n){const i=n.config.validateStatus;n.status&&i&&!i(n.status)?t(new vt("Request failed with status code "+n.status,[vt.ERR_BAD_REQUEST,vt.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):e(n)}ue.inherits(Yc,vt,{__CANCEL__:!0});const ap=function(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,i=0;const r=(function(s,o){s=s||10;const a=new Array(s),c=new Array(s);let u,p=0,m=0;return o=o!==void 0?o:1e3,function(_){const g=Date.now(),b=c[m];u||(u=g),a[p]=_,c[p]=g;let v=m,R=0;for(;v!==p;)R+=a[v++],v%=s;if(p=(p+1)%s,p===m&&(m=(m+1)%s),g-u<o)return;const O=b&&g-b;return O?Math.round(1e3*R/O):void 0}})(50,250);return(function(s,o){let a,c,u=0,p=1e3/o;const m=function(_){u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),a=null,c&&(clearTimeout(c),c=null),s(..._)};return[function(){const _=Date.now(),g=_-u;for(var b=arguments.length,v=new Array(b),R=0;R<b;R++)v[R]=arguments[R];g>=p?m(v,_):(a=v,c||(c=setTimeout((()=>{c=null,m(a)}),p-g)))},()=>a&&m(a)]})((s=>{const o=s.loaded,a=s.lengthComputable?s.total:void 0,c=o-i,u=r(c);i=o,e({loaded:o,total:a,progress:a?o/a:void 0,bytes:c,rate:u||void 0,estimated:u&&a&&o<=a?(a-o)/u:void 0,event:s,lengthComputable:a!=null,[t?"download":"upload"]:!0})}),n)},y0=(e,t)=>{const n=e!=null;return[i=>t[0]({lengthComputable:n,total:e,loaded:i}),t[1]]},T0=e=>function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return ue.asap((()=>e(...n)))};var gY=Si.hasStandardBrowserEnv?((e,t)=>n=>(n=new Mh(n,Si.origin),e.protocol===n.protocol&&e.host===n.host&&(t||e.port===n.port)))(new Mh(Si.origin),Si.navigator&&/(msie|trident)/i.test(Si.navigator.userAgent)):()=>!0,EY=Si.hasStandardBrowserEnv?{write(e,t,n,i,r,s,o){if(typeof document>"u")return;const a=["".concat(e,"=").concat(encodeURIComponent(t))];ue.isNumber(n)&&a.push("expires=".concat(new Date(n).toUTCString())),ue.isString(i)&&a.push("path=".concat(i)),ue.isString(r)&&a.push("domain=".concat(r)),s===!0&&a.push("secure"),ue.isString(o)&&a.push("SameSite=".concat(o)),document.cookie=a.join("; ")},read(e){if(typeof document>"u")return null;const t=document.cookie.match(new RegExp("(?:^|; )"+e+"=([^;]*)"));return t?decodeURIComponent(t[1]):null},remove(e){this.write(e,"",Date.now()-864e5,"/")}}:{write(){},read:()=>null,remove(){}};function v0(e,t,n){let i=!(function(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)})(t);return e&&(i||n==0)?(function(r,s){return s?r.replace(/\/?\/$/,"")+"/"+s.replace(/^\/+/,""):r})(e,t):t}function R0(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function LE(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?R0(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):R0(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const C0=e=>e instanceof Hr?LE({},e):e;function Ea(e,t){t=t||{};const n={};function i(u,p,m,_){return ue.isPlainObject(u)&&ue.isPlainObject(p)?ue.merge.call({caseless:_},u,p):ue.isPlainObject(p)?ue.merge({},p):ue.isArray(p)?p.slice():p}function r(u,p,m,_){return ue.isUndefined(p)?ue.isUndefined(u)?void 0:i(void 0,u,0,_):i(u,p,0,_)}function s(u,p){if(!ue.isUndefined(p))return i(void 0,p)}function o(u,p){return ue.isUndefined(p)?ue.isUndefined(u)?void 0:i(void 0,u):i(void 0,p)}function a(u,p,m){return m in t?i(u,p):m in e?i(void 0,u):void 0}const c={url:s,method:s,data:s,baseURL:o,transformRequest:o,transformResponse:o,paramsSerializer:o,timeout:o,timeoutMessage:o,withCredentials:o,withXSRFToken:o,adapter:o,responseType:o,xsrfCookieName:o,xsrfHeaderName:o,onUploadProgress:o,onDownloadProgress:o,decompress:o,maxContentLength:o,maxBodyLength:o,beforeRedirect:o,transport:o,httpAgent:o,httpsAgent:o,cancelToken:o,socketPath:o,responseEncoding:o,validateStatus:a,headers:(u,p,m)=>r(C0(u),C0(p),0,!0)};return ue.forEach(Object.keys(LE(LE({},e),t)),(function(u){const p=c[u]||r,m=p(e[u],t[u],u);ue.isUndefined(m)&&p!==a||(n[u]=m)})),n}var b0=e=>{const t=Ea({},e);let{data:n,withXSRFToken:i,xsrfHeaderName:r,xsrfCookieName:s,headers:o,auth:a}=t;if(t.headers=o=Hr.from(o),t.url=WA(v0(t.baseURL,t.url,t.allowAbsoluteUrls),e.params,e.paramsSerializer),a&&o.set("Authorization","Basic "+btoa((a.username||"")+":"+(a.password?unescape(encodeURIComponent(a.password)):""))),ue.isFormData(n)){if(Si.hasStandardBrowserEnv||Si.hasStandardBrowserWebWorkerEnv)o.setContentType(void 0);else if(ue.isFunction(n.getHeaders)){const c=n.getHeaders(),u=["content-type","content-length"];Object.entries(c).forEach((p=>{let[m,_]=p;ie(u).call(u,m.toLowerCase())&&o.set(m,_)}))}}if(Si.hasStandardBrowserEnv&&(i&&ue.isFunction(i)&&(i=i(t)),i||i!==!1&&gY(t.url))){const c=r&&s&&EY.read(s);c&&o.set(r,c)}return t},SY=typeof XMLHttpRequest<"u"&&function(e){return new de((function(t,n){const i=b0(e);let r=i.data;const s=Hr.from(i.headers).normalize();let o,a,c,u,p,{responseType:m,onUploadProgress:_,onDownloadProgress:g}=i;function b(){u&&u(),p&&p(),i.cancelToken&&i.cancelToken.unsubscribe(o),i.signal&&i.signal.removeEventListener("abort",o)}let v=new XMLHttpRequest;function R(){if(!v)return;const D=Hr.from("getAllResponseHeaders"in v&&v.getAllResponseHeaders());S0((function(x){t(x),b()}),(function(x){n(x),b()}),{data:m&&m!=="text"&&m!=="json"?v.response:v.responseText,status:v.status,statusText:v.statusText,headers:D,config:e,request:v}),v=null}v.open(i.method.toUpperCase(),i.url,!0),v.timeout=i.timeout,"onloadend"in v?v.onloadend=R:v.onreadystatechange=function(){v&&v.readyState===4&&(v.status!==0||v.responseURL&&v.responseURL.indexOf("file:")===0)&&setTimeout(R)},v.onabort=function(){v&&(n(new vt("Request aborted",vt.ECONNABORTED,e,v)),v=null)},v.onerror=function(D){const x=new vt(D&&D.message?D.message:"Network Error",vt.ERR_NETWORK,e,v);x.event=D||null,n(x),v=null},v.ontimeout=function(){let D=i.timeout?"timeout of "+i.timeout+"ms exceeded":"timeout exceeded";const x=i.transitional||HA;i.timeoutErrorMessage&&(D=i.timeoutErrorMessage),n(new vt(D,x.clarifyTimeoutError?vt.ETIMEDOUT:vt.ECONNABORTED,e,v)),v=null},r===void 0&&s.setContentType(null),"setRequestHeader"in v&&ue.forEach(s.toJSON(),(function(D,x){v.setRequestHeader(x,D)})),ue.isUndefined(i.withCredentials)||(v.withCredentials=!!i.withCredentials),m&&m!=="json"&&(v.responseType=i.responseType),g&&([c,p]=ap(g,!0),v.addEventListener("progress",c)),_&&v.upload&&([a,u]=ap(_),v.upload.addEventListener("progress",a),v.upload.addEventListener("loadend",u)),(i.cancelToken||i.signal)&&(o=D=>{v&&(n(!D||D.type?new Yc(null,e,v):D),v.abort(),v=null)},i.cancelToken&&i.cancelToken.subscribe(o),i.signal&&(i.signal.aborted?o():i.signal.addEventListener("abort",o)));const O=(function(D){const x=/^([-+\w]{1,25})(:?\/\/|:)/.exec(D);return x&&x[1]||""})(i.url);O&&Si.protocols.indexOf(O)===-1?n(new vt("Unsupported protocol "+O+":",vt.ERR_BAD_REQUEST,e)):v.send(r||null)}))},yY=(e,t)=>{const{length:n}=e=e?e.filter(Boolean):[];if(t||n){let i,r=new AbortController;const s=function(u){if(!i){i=!0,a();const p=u instanceof Error?u:this.reason;r.abort(p instanceof vt?p:new Yc(p instanceof Error?p.message:p))}};let o=t&&setTimeout((()=>{o=null,s(new vt("timeout ".concat(t," of ms exceeded"),vt.ETIMEDOUT))}),t);const a=()=>{e&&(o&&clearTimeout(o),o=null,e.forEach((u=>{u.unsubscribe?u.unsubscribe(s):u.removeEventListener("abort",s)})),e=null)};e.forEach((u=>u.addEventListener("abort",s)));const{signal:c}=r;return c.unsubscribe=()=>ue.asap(a),c}},kE=y(db),w0=Bc.f("asyncIterator"),TY=y(w0);function xE(e,t){this.v=e,this.k=t}function li(e){return function(){return new Il(e.apply(this,arguments))}}function Il(e){var t,n;function i(s,o){try{var a=e[s](o),c=a.value,u=c instanceof xE;kE.resolve(u?c.v:c).then((function(p){if(u){var m=s==="return"?"return":"next";if(!c.k||p.done)return i(m,p);p=e[m](p).value}r(a.done?"return":"normal",p)}),(function(p){i("throw",p)}))}catch(p){r("throw",p)}}function r(s,o){switch(s){case"return":t.resolve({value:o,done:!0});break;case"throw":t.reject(o);break;default:t.resolve({value:o,done:!1})}(t=t.next)?i(t.key,t.arg):n=null}this._invoke=function(s,o){return new kE((function(a,c){var u={key:s,arg:o,resolve:a,reject:c,next:null};n?n=n.next=u:(t=n=u,i(s,o))}))},typeof e.return!="function"&&(this.return=void 0)}function He(e){return new xE(e,0)}function zc(e){var t={},n=!1;function i(r,s){return n=!0,s=new kE((function(o){o(e[r](s))})),{done:!1,value:new xE(s,1)}}return t[Kc!==void 0&&t0||"@@iterator"]=function(){return this},t.next=function(r){return n?(n=!1,r):i("next",r)},typeof e.throw=="function"&&(t.throw=function(r){if(n)throw n=!1,r;return i("throw",r)}),typeof e.return=="function"&&(t.return=function(r){return n?(n=!1,r):i("return",r)}),t}Il.prototype[typeof Kc=="function"&&TY||"@@asyncIterator"]=function(){return this},Il.prototype.next=function(e){return this._invoke("next",e)},Il.prototype.throw=function(e){return this._invoke("throw",e)},Il.prototype.return=function(e){return this._invoke("return",e)};var cp=y(w0);function ME(e){var t,n,i,r=2;for(typeof Symbol<"u"&&(n=cp,i=Symbol.iterator);r--;){if(n&&(t=e[n])!=null)return t.call(e);if(i&&(t=e[i])!=null)return new dp(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function dp(e){function t(n){if(Object(n)!==n)return de.reject(new TypeError(n+" is not an object."));var i=n.done;return de.resolve(n.value).then((function(r){return{value:r,done:i}}))}return dp=function(n){this.s=n,this.n=n.next},dp.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?de.resolve({value:n,done:!0}):t(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?de.reject(n):t(i.apply(this.s,arguments))}},new dp(e)}const vY=function*(e,t){let n=e.byteLength;if(!t||n<t)return void(yield e);let i,r=0;for(;r<n;)i=r+t,yield e.slice(r,i),r=i},RY=(function(){var e=li((function*(t,n){var i,r=!1,s=!1;try{for(var o,a=ME(CY(t));r=!(o=yield He(a.next())).done;r=!1){const c=o.value;yield*zc(ME(vY(c,n)))}}catch(c){s=!0,i=c}finally{try{r&&a.return!=null&&(yield He(a.return()))}finally{if(s)throw i}}}));return function(t,n){return e.apply(this,arguments)}})(),CY=(function(){var e=li((function*(t){if(t[cp])return void(yield*zc(ME(t)));const n=t.getReader();try{for(;;){const{done:i,value:r}=yield He(n.read());if(i)break;yield r}}finally{yield He(n.cancel())}}));return function(t){return e.apply(this,arguments)}})(),A0=(e,t,n,i)=>{const r=RY(e,t);let s,o=0,a=c=>{s||(s=!0,i&&i(c))};return new ReadableStream({async pull(c){try{const{done:u,value:p}=await r.next();if(u)return a(),void c.close();let m=p.byteLength;if(n){let _=o+=m;n(_)}c.enqueue(new Uint8Array(p))}catch(u){throw a(u),u}},cancel:c=>(a(c),r.return())},{highWaterMark:2})};function I0(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function O0(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?I0(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I0(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const{isFunction:lp}=ue,bY=(e=>{let{Request:t,Response:n}=e;return{Request:t,Response:n}})(ue.global),{ReadableStream:N0,TextEncoder:D0}=ue.global,P0=function(e){try{for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return!!e(...n)}catch{return!1}},wY=e=>{e=ue.merge.call({skipUndefined:!0},bY,e);const{fetch:t,Request:n,Response:i}=e,r=t?lp(t):typeof fetch=="function",s=lp(n),o=lp(i);if(!r)return!1;const a=r&&lp(N0),c=r&&(typeof D0=="function"?(u=new D0,b=>u.encode(b)):async b=>new Uint8Array(await new n(b).arrayBuffer()));var u;const p=s&&a&&P0((()=>{let b=!1;const v=new n(Si.origin,{body:new N0,method:"POST",get duplex(){return b=!0,"half"}}).headers.has("Content-Type");return b&&!v})),m=o&&a&&P0((()=>ue.isReadableStream(new i("").body))),_={stream:m&&(b=>b.body)};r&&["text","arrayBuffer","blob","formData","stream"].forEach((b=>{!_[b]&&(_[b]=(v,R)=>{let O=v&&v[b];if(O)return O.call(v);throw new vt("Response type '".concat(b,"' is not supported"),vt.ERR_NOT_SUPPORT,R)})}));const g=async(b,v)=>{const R=ue.toFiniteNumber(b.getContentLength());return R??(async O=>O==null?0:ue.isBlob(O)?O.size:ue.isSpecCompliantForm(O)?(await new n(Si.origin,{method:"POST",body:O}).arrayBuffer()).byteLength:ue.isArrayBufferView(O)||ue.isArrayBuffer(O)?O.byteLength:(ue.isURLSearchParams(O)&&(O+=""),ue.isString(O)?(await c(O)).byteLength:void 0))(v)};return async b=>{let{url:v,method:R,data:O,signal:D,cancelToken:x,timeout:B,onDownloadProgress:G,onUploadProgress:j,responseType:H,headers:Z,withCredentials:ne="same-origin",fetchOptions:he}=b0(b),De=t||fetch;H=H?(H+"").toLowerCase():"text";let Oe=yY([D,x&&x.toAbortSignal()],B),Ge=null;const Ue=Oe&&Oe.unsubscribe&&(()=>{Oe.unsubscribe()});let ct;try{if(j&&p&&R!=="get"&&R!=="head"&&(ct=await g(Z,O))!==0){let T,k=new n(v,{method:"POST",body:O,duplex:"half"});if(ue.isFormData(O)&&(T=k.headers.get("content-type"))&&Z.setContentType(T),k.body){const[F,se]=y0(ct,ap(T0(j)));O=A0(k.body,65536,F,se)}}ue.isString(ne)||(ne=ne?"include":"omit");const Ut=s&&"credentials"in n.prototype,ee=O0(O0({},he),{},{signal:Oe,method:R.toUpperCase(),headers:Z.normalize().toJSON(),body:O,duplex:"half",credentials:Ut?ne:void 0});Ge=s&&new n(v,ee);let ce=await(s?De(Ge,he):De(v,ee));const ge=m&&(H==="stream"||H==="response");if(m&&(G||ge&&Ue)){const T={};["status","statusText","headers"].forEach((ke=>{T[ke]=ce[ke]}));const k=ue.toFiniteNumber(ce.headers.get("content-length")),[F,se]=G&&y0(k,ap(T0(G),!0))||[];ce=new i(A0(ce.body,65536,F,(()=>{se&&se(),Ue&&Ue()})),T)}H=H||"text";let te=await _[ue.findKey(_,H)||"text"](ce,b);return!ge&&Ue&&Ue(),await new de(((T,k)=>{S0(T,k,{data:te,headers:Hr.from(ce.headers),status:ce.status,statusText:ce.statusText,config:b,request:Ge})}))}catch(Ut){throw Ue&&Ue(),Ut&&Ut.name==="TypeError"&&/Load failed|fetch/i.test(Ut.message)?Object.assign(new vt("Network Error",vt.ERR_NETWORK,b,Ge),{cause:Ut.cause||Ut}):vt.from(Ut,Ut&&Ut.code,b,Ge)}}},AY=new Map,L0=e=>{let t=e&&e.env||{};const{fetch:n,Request:i,Response:r}=t,s=[i,r,n];let o,a,c=s.length,u=AY;for(;c--;)o=s[c],a=u.get(o),a===void 0&&u.set(o,a=c?new Map:wY(t)),u=a;return a};L0();const UE={http:null,xhr:SY,fetch:{get:L0}};ue.forEach(UE,((e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch{}Object.defineProperty(e,"adapterName",{value:t})}}));const k0=e=>"- ".concat(e),IY=e=>ue.isFunction(e)||e===null||e===!1;var x0={getAdapter:function(e,t){e=ue.isArray(e)?e:[e];const{length:n}=e;let i,r;const s={};for(let o=0;o<n;o++){let a;if(i=e[o],r=i,!IY(i)&&(r=UE[(a=String(i)).toLowerCase()],r===void 0))throw new vt("Unknown adapter '".concat(a,"'"));if(r&&(ue.isFunction(r)||(r=r.get(t))))break;s[a||"#"+o]=r}if(!r){const o=Object.entries(s).map((a=>{let[c,u]=a;return"adapter ".concat(c," ")+(u===!1?"is not supported by the environment":"is not available in the build")}));throw new vt("There is no suitable adapter to dispatch the request "+(n?o.length>1?`since :
`+o.map(k0).join(`
`):" "+k0(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r},adapters:UE};function VE(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new Yc(null,e)}function M0(e){return VE(e),e.headers=Hr.from(e.headers),e.data=PE.call(e,e.transformRequest),["post","put","patch"].indexOf(e.method)!==-1&&e.headers.setContentType("application/x-www-form-urlencoded",!1),x0.getAdapter(e.adapter||NE.adapter,e)(e).then((function(t){return VE(e),t.data=PE.call(e,e.transformResponse,t),t.headers=Hr.from(t.headers),t}),(function(t){return E0(t)||(VE(e),t&&t.response&&(t.response.data=PE.call(e,e.transformResponse,t.response),t.response.headers=Hr.from(t.response.headers))),de.reject(t)}))}const U0="1.13.2",up={};["object","boolean","number","function","string","symbol"].forEach(((e,t)=>{up[e]=function(n){return typeof n===e||"a"+(t<1?"n ":" ")+e}}));const V0={};up.transitional=function(e,t,n){function i(r,s){return"[Axios v"+U0+"] Transitional option '"+r+"'"+s+(n?". "+n:"")}return(r,s,o)=>{if(e===!1)throw new vt(i(s," has been removed"+(t?" in "+t:"")),vt.ERR_DEPRECATED);return t&&!V0[s]&&(V0[s]=!0,console.warn(i(s," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(r,s,o)}},up.spelling=function(e){return(t,n)=>(console.warn("".concat(n," is likely a misspelling of ").concat(e)),!0)};var hp={assertOptions:function(e,t,n){if(typeof e!="object")throw new vt("options must be an object",vt.ERR_BAD_OPTION_VALUE);const i=Object.keys(e);let r=i.length;for(;r-- >0;){const s=i[r],o=t[s];if(o){const a=e[s],c=a===void 0||o(a,s,e);if(c!==!0)throw new vt("option "+s+" must be "+c,vt.ERR_BAD_OPTION_VALUE)}else if(n!==!0)throw new vt("Unknown option "+s,vt.ERR_BAD_OPTION)}},validators:up};const gs=hp.validators;let pp=class{constructor(e){this.defaults=e||{},this.interceptors={request:new GA,response:new GA}}async request(e,t){try{return await this._request(e,t)}catch(n){if(n instanceof Error){let i={};Error.captureStackTrace?Error.captureStackTrace(i):i=new Error;const r=i.stack?i.stack.replace(/^.+\n/,""):"";try{n.stack?r&&!String(n.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+r):n.stack=r}catch{}}throw n}}_request(e,t){typeof e=="string"?(t=t||{}).url=e:t=e||{},t=Ea(this.defaults,t);const{transitional:n,paramsSerializer:i,headers:r}=t;n!==void 0&&hp.assertOptions(n,{silentJSONParsing:gs.transitional(gs.boolean),forcedJSONParsing:gs.transitional(gs.boolean),clarifyTimeoutError:gs.transitional(gs.boolean)},!1),i!=null&&(ue.isFunction(i)?t.paramsSerializer={serialize:i}:hp.assertOptions(i,{encode:gs.function,serialize:gs.function},!0)),t.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),hp.assertOptions(t,{baseUrl:gs.spelling("baseURL"),withXsrfToken:gs.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let s=r&&ue.merge(r.common,r[t.method]);r&&ue.forEach(["delete","get","head","post","put","patch","common"],(g=>{delete r[g]})),t.headers=Hr.concat(s,r);const o=[];let a=!0;this.interceptors.request.forEach((function(g){typeof g.runWhen=="function"&&g.runWhen(t)===!1||(a=a&&g.synchronous,o.unshift(g.fulfilled,g.rejected))}));const c=[];let u;this.interceptors.response.forEach((function(g){c.push(g.fulfilled,g.rejected)}));let p,m=0;if(!a){const g=[M0.bind(this),void 0];for(g.unshift(...o),g.push(...c),p=g.length,u=de.resolve(t);m<p;)u=u.then(g[m++],g[m++]);return u}p=o.length;let _=t;for(;m<p;){const g=o[m++],b=o[m++];try{_=g(_)}catch(v){b.call(this,v);break}}try{u=M0.call(this,_)}catch(g){return de.reject(g)}for(m=0,p=c.length;m<p;)u=u.then(c[m++],c[m++]);return u}getUri(e){return WA(v0((e=Ea(this.defaults,e)).baseURL,e.url,e.allowAbsoluteUrls),e.params,e.paramsSerializer)}};ue.forEach(["delete","get","head","options"],(function(e){pp.prototype[e]=function(t,n){return this.request(Ea(n||{},{method:e,url:t,data:(n||{}).data}))}})),ue.forEach(["post","put","patch"],(function(e){function t(n){return function(i,r,s){return this.request(Ea(s||{},{method:e,headers:n?{"Content-Type":"multipart/form-data"}:{},url:i,data:r}))}}pp.prototype[e]=t(),pp.prototype[e+"Form"]=t(!0)}));var mp=pp;class jE{constructor(t){if(typeof t!="function")throw new TypeError("executor must be a function.");let n;this.promise=new de((function(r){n=r}));const i=this;this.promise.then((r=>{if(!i._listeners)return;let s=i._listeners.length;for(;s-- >0;)i._listeners[s](r);i._listeners=null})),this.promise.then=r=>{let s;const o=new de((a=>{i.subscribe(a),s=a})).then(r);return o.cancel=function(){i.unsubscribe(s)},o},t((function(r,s,o){i.reason||(i.reason=new Yc(r,s,o),n(i.reason))}))}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;const n=this._listeners.indexOf(t);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const t=new AbortController,n=i=>{t.abort(i)};return this.subscribe(n),t.signal.unsubscribe=()=>this.unsubscribe(n),t.signal}static source(){let t;return{token:new jE((function(i){t=i})),cancel:t}}}var OY=jE;const FE={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(FE).forEach((e=>{let[t,n]=e;FE[n]=t}));var NY=FE;const Kn=(function e(t){const n=new mp(t),i=bA(mp.prototype.request,n);return ue.extend(i,mp.prototype,n,{allOwnKeys:!0}),ue.extend(i,n,null,{allOwnKeys:!0}),i.create=function(r){return e(Ea(t,r))},i})(NE);Kn.Axios=mp,Kn.CanceledError=Yc,Kn.CancelToken=OY,Kn.isCancel=E0,Kn.VERSION=U0,Kn.toFormData=qh,Kn.AxiosError=vt,Kn.Cancel=Kn.CanceledError,Kn.all=function(e){return de.all(e)},Kn.spread=function(e){return function(t){return e.apply(null,t)}},Kn.isAxiosError=function(e){return ue.isObject(e)&&e.isAxiosError===!0},Kn.mergeConfig=Ea,Kn.AxiosHeaders=Hr,Kn.formToJSON=e=>_0(ue.isHTMLForm(e)?new FormData(e):e),Kn.getAdapter=x0.getAdapter,Kn.HttpStatusCode=NY,Kn.default=Kn;var ui=Kn;const DY=()=>{};function Ol(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:DY};return e.promise=new de(((t,n)=>{e.resolve=i=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(i),e.value=i)},e.reject=i=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,n(i))}})),e}const fp=new Map,_p=new Map,Es=new Map;let gn=(function(e){return e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot",e})({}),at=(function(e){return e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger",e})({});const j0=new hH;let Kr=j0.getResult(),BE=null;function st(e){if(!BE){Kr=j0.getResult();const t=(function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return at.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return at.CHROME;case"Safari":case"Mobile Safari":return at.SAFARI;case"Edge":return at.EDGE;case"Firefox":return at.FIREFOX;case"QQ":case"QQBrowser":return at.QQ;case"Opera":return at.OPERA;case"WeChat":return at.WECHAT;default:return a.browser.name||""}})(Kr),n=F0(Kr),i=(function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""})(Kr),r=Kr.os.version,s=F0(Kr,!1),o=Kr.device.type;if(!(t&&n&&i&&r))return{name:t,version:n,os:i,osVersion:r,browserVersion:s,deviceType:o};BE={name:t,version:n,os:i,osVersion:r,browserVersion:s,deviceType:o}}return BE}function F0(e){let t,n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return t=e.engine.name==="Blink"?e.engine.version||"":e.browser.version||"",n?t.split(".")[0]:t}function gp(){return st().os}function B0(){const e=st();return"".concat(e.os," ").concat(e.osVersion)}function Ep(){const e=st();return!!(Kr.engine.name==="WebKit"&&e.os===gn.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==at.SAFARI||Yn()&&e.name!==at.SAFARI)}function Xs(){return st().name===at.CHROME}function Rn(){return st().name===at.SAFARI}function W0(){const e=st();if(e.name!==at.SAFARI||!e.browserVersion)return!1;const t=e.browserVersion.split(".");return Number(t[0])>15||Number(t[0])===15&&Number(t[1])>=4}function G0(){return st().name===at.EDGE}function Nt(){return st().name===at.FIREFOX}function Yn(){return st().os===gn.IOS}function Yr(e){const t=st();return!(t.name!==at.CHROME||!t.osVersion)&&Number(t.version)>=e}function H0(e){const t=st();return!(t.name!==at.CHROME||!t.osVersion)&&Number(t.version)<e}function WE(e,t,n){const i=st();return!(i.name!==e||!i.osVersion)&&(n?Number(i.version)>=t&&Number(i.version)<=n:Number(i.version)===t)}function bo(e){const t=st();return!(t.name!==at.EDGE||!t.osVersion)&&Number(t.version)>=e}function GE(e){const t=st();return!(t.name!==at.FIREFOX||!t.osVersion)&&Number(t.version)>=e}function K0(e){const t=st();return!(t.name!==at.SAFARI||!t.osVersion)&&Number(t.version)>=e}function Y0(e,t,n){const i=st();if(i.os!==gn.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])>t||Number(r[0])>e:t?Number(r[0])===e&&Number(r[1])>=t||Number(r[0])>e:Number(r[0])>=e}function z0(e,t,n){const i=st();if(i.os!==gn.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function HE(e,t,n){const i=st();if(i.name!==at.SAFARI||!i.osVersion||!i.browserVersion)return!1;const r=i.browserVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function Sa(e){const t=st();return!(t.name!==at.OPERA||!t.osVersion)&&Number(t.version)>=e}function q0(){const e=st();if(e.os!==gn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function qc(){const e=st();if(e.os!==gn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15}function KE(){const e=st();if(e.os!==gn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===16}function X0(){const e=st();if(e.os!==gn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function yr(){return Rn()&&navigator.maxTouchPoints>0}function J0(){return st().name===at.WECHAT}function Q0(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function Z0(){const e=gp();return(function(){const{deviceType:t}=st();return t==="mobile"||t==="tablet"})()||e===gn.ANDROID||e===gn.IOS||e===gn.HARMONY_OS}function Ss(){const e=st();return e.name!==at.EDGE&&e.name!==at.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function Nl(){return gp()===gn.ANDROID}function Dl(){const e=st();return Nl()&&(e.name===at.CHROME||e.name===at.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function xe(e,t,n){return(t=(function(i){var r=(function(s,o){if(typeof s!="object"||!s)return s;var a=s[Symbol.toPrimitive];if(a!==void 0){var c=a.call(s,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)})(i);return typeof r=="symbol"?r:r+""})(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function $0(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function ae(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?$0(Object(n),!0).forEach((function(i){xe(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$0(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let N=(function(e){return e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",e})({}),J=class extends Error{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(t),xe(this,"code",void 0),xe(this,"message",void 0),xe(this,"data",void 0),xe(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=n}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return e==="error"&&(t||console).error(this.toString()),e==="warning"&&(t||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}};function Tr(e,t){if(typeof e!="boolean")throw new J(N.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function Zt(e,t,n){if(!ie(n).call(n,e))throw new J(N.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(n)))}function Rt(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(e<n||e>i||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!(function(r){return typeof r=="number"&&r%1==0})(e))throw new J(N.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(n,", ").concat(i,"]. integer only"))}function YE(e,t){if(typeof e!="number"){if(!(e.min||e.max||e.ideal||e.exact))throw new J(N.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));e.min!==void 0&&Rt(e.min,"".concat(t,".min"),0,1/0),e.max!==void 0&&Rt(e.max,"".concat(t,".max"),1,1/0),e.exact!==void 0&&Rt(e.exact,"".concat(t,".exact"),1,1/0),e.ideal!==void 0&&Rt(e.ideal,"".concat(t,".ideal"),1,1/0)}else Rt(e,t,1,1/0)}function Nn(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(e==null)throw new J(N.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!eO(e,n,i,r))throw new J(N.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(n,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function Js(e,t){if(!Array.isArray(e))throw new J(N.INVALID_PARAMS,"".concat(t," should be an array"))}function Wt(e){return e==null}function eO(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,i=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof e=="string"&&e.length<=n&&e.length>=t&&(!i||(function(r){if(typeof r!="string")return!1;for(let s=0;s<r.length;s+=1){const o=r.charCodeAt(s);if(o<0||o>255)return!1}return!0})(e))}function tO(e,t,n){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,n);const i=e.getUint32(t,n),r=e.getUint32(t+4,n),s=0,o=+!n;return BigInt(i*o+r*s)<<BigInt(32)|BigInt(i*s+r*o)}function nO(e,t,n,i){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,n,i);const r=Number(n>>BigInt(32)),s=Number(n&BigInt(4294967295));e.setUint32(t,r,i),e.setUint32(t+4,s,i)}var Pl=(function(e){return e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE",e})(Pl||{}),zE=(function(e){return e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",e})(zE||{});const iO=new class{constructor(){xe(this,"_clientSize",null),xe(this,"getClientWidth",(()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth)),xe(this,"getClientHeight",(()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight)),xe(this,"getStyle",(e=>window.getComputedStyle(e,null))),xe(this,"checkCssVisibleProperty",(e=>{var t;let n=!0;const i=this.getStyle(e),{display:r,visibility:s,opacity:o,filter:a}=i;return(r==="none"||ie(t=["hidden","collapse"]).call(t,s)||Number(o)<.1)&&(n=!1),!!n&&(a&&a.split(" ").filter((c=>{var u;const p=c.split("(")[0];return ie(u=["brightness","blur","opacity"]).call(u,p)})).map((c=>{const[u,p]=c.split(/\(|\)/);return[u,Number(p.match(/^[0-9\.]+/))]})).forEach((c=>{const[u,p]=c;switch(u){case"brightness":(p<.1||p>3)&&(n=!1);break;case"blur":p>3&&(n=!1);break;case"opacity":p<.1&&(n=!1)}})),n)})),xe(this,"checkPropertyUpToAllParentNodes",((e,t)=>{let n=!0,i=!0;const r=o=>t(o);let s=e;for(;s&&i;)r(s)||(n=!1,i=!1),s=s.parentElement,s||(i=!1);return n})),xe(this,"checkActualCssVisibleIncludeInherit",(e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty))),xe(this,"getSizeAboutClient",(e=>{const{width:t,height:n,left:i,right:r,top:s,bottom:o}=e.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:t,height:n,left:i,right:r,top:s,bottom:o,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}})),xe(this,"checkActualSize",(()=>{const{width:e,height:t,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(e,t,n)})),xe(this,"elementFromPoint",((e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null)),xe(this,"checkCoverForAPoint",((e,t,n)=>{const i=this.elementFromPoint(e,t);return i!==null&&i!==n})),xe(this,"getPointPositionList",(()=>{const{width:e,height:t,left:n,top:i}=this._clientSize,r=e/6,s=t/6,o=[],a=10**6;for(let c=0;c<5;c++)for(let u=0;u<5;u++){const p=(n*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,m=(i*a+(u===0?.1:u===4?(s*u*a-1e5)/a:s*u)*a)/a;o.push({x:p,y:m})}return[...o]})),xe(this,"checkElementCover",(e=>this.getPointPositionList().map((t=>this.checkCoverForAPoint(t.x,t.y,e))).filter((t=>!!t)).length>6)),xe(this,"checkSizeIsVisible",((e,t,n)=>(e>50||n/e<=10)&&(t>50||n/t<=10))),xe(this,"checkSizeOfPartInClient",(()=>{const{left:e,right:t,top:n,bottom:i,clientHeight:r,clientWidth:s,clientMin:o}=this._clientSize;let a,c,u,p;if(e<0)a=0;else{if(!(e<s))return!1;a=e}if(t<0)return!1;if(c=t<s?t:s,n<0)u=0;else{if(!(n<r))return!1;u=n}if(i<0)return!1;p=i<r?i:r;const m=c-a,_=p-u;return this.checkSizeIsVisible(m,_,o)})),xe(this,"returnHiddenResult",(e=>(this._clientSize=null,{visible:!1,reason:e}))),xe(this,"checkOneElementVisible",(e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(Pl.COVERED);{const t=this.checkActualSize(),n=this.checkSizeOfPartInClient();return t&&!n?this.returnHiddenResult(Pl.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Pl.SIZE)}}return this.returnHiddenResult(Pl.STYLE)}return this.returnHiddenResult(zE.UNMOUNTED)}return this.returnHiddenResult(zE.INVALID_HTML_ELEMENT)})),xe(this,"checkElementIsMountedOnDom",(e=>this.checkPropertyUpToAllParentNodes(e,(t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))))}};function qE(e){return new TextEncoder().encode(e)}const rO=function(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n},XE=async e=>(function(t,n){let i="";return new Uint8Array(t).forEach((r=>{i+=r.toString(n).padStart(2,"0")})),i})(await crypto.subtle.digest("SHA-256",qE(e)),16);let Vt=class{constructor(){xe(this,"_events",{}),xe(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map((t=>t.listener)):[]}on(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];this._indexOfListener(n,t)===-1&&n.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];this._indexOfListener(n,t)===-1&&n.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;const n=this._events[e],i=this._indexOfListener(n,t);i!==-1&&n.splice(i,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const t=this._events[e].map((s=>s));for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(let s=0;s<t.length;s+=1){const o=t[s];o.once&&this.off(e,o.listener),o.listener.apply(this,i||[])}}safeEmit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];[...this._events[e]||[]].forEach((r=>{r.once&&this.off(e,r.listener);try{r.listener.apply(this,n)}catch(s){console.error("safeEmit event:".concat(e," error ").concat(s?.toString()))}}))}_indexOfListener(e,t){let n=e.length;for(;n--;)if(e[n].listener===t)return n;return-1}},Ll=null;function sO(){if(Ll)return Ll;if(window.electron)return Ll=window.electron;if(!window.require)return null;try{return Ll=window.require("electron"),Ll}catch{return null}}let xt=(function(e){return e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.PRELOAD="PRELOAD",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload",e.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",e.PRELOAD_MEDIA_FAILED="preloadMediaFailed",e.MISMATCH_DTLS_PARAMETERS="mismatchDtlsParameters",e.VOS_FALLBACK_CN="vosFallbackCN",e.DATACHANNEL_FAILBACK="datachannelFailback",e})({}),Ct=(function(e){return e.TRACER="tracer",e})({});function oO(e){return Rt(e.timeout,"config.timeout",0,1e5),Rt(e.timeoutFactor,"config.timeoutFactor",0,100,!1),Rt(e.maxRetryCount,"config.maxRetryConfig",0,1/0),Rt(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let PY=(function(e){return e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",e})({}),Ze=(function(e){return e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.FALLBACK="FALLBACK",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.FALLBACK_TO_HLS="FALLBACK_TO_HLS",e.UID_CONFLICT="UID_CONFLICT",e})({});function ya(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach((t=>{if(!t.urls)throw Error()}))}catch{return!1}return!0}function aO(e){return Nn(e.turnServerURL,"turnServerURL"),Nn(e.username,"username"),Nn(e.password,"password"),e.udpport&&Rt(e.udpport,"udpport",1,99999,!0),e.forceturn&&Tr(e.forceturn,"forceturn"),e.security&&Tr(e.security,"security"),e.tcpport&&Rt(e.tcpport,"tcpport",1,99999,!0),!0}let Xc=(function(e){return e[e.AUTO_SIMULCAST_STREAM=-1]="AUTO_SIMULCAST_STREAM",e[e.DISABLE_SIMULCAST_STREM=0]="DISABLE_SIMULCAST_STREM",e[e.ENABLE_SIMULCAST_STREAM=1]="ENABLE_SIMULCAST_STREAM",e})({});function JE(e){return e.level!==void 0&&Zt(e.level,"level",[1,2,3]),e.delay!==void 0&&Rt(e.delay,"delay",0,3e3,!0),!0}let Ye=(function(e){return e.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",e.AUDIO_METADATA="audio-metadata",e.AUDIO_PTS="audio-pts",e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",e.FALLBACK_TO_HLS="fallback-to-hls",e.FIRST_VIDEO_BUFFER_READY="first-video-buffer-ready",e.FIRST_VIDEO_PRE_RENDER="first-video-pre-render",e.AV1_DECODABLE_RESULT="av1-decodable-result",e})({}),QE=(function(e){return e.CONFIG="config",e.VOSERROR="vos_error",e.AP_ERROR="ap_error",e})({}),kn=(function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",e})({}),ii=(function(e){return e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e})({}),Ta=(function(e){return e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e})({});function sn(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return e.getListeners(t).length===0?de.reject(new J(N.UNEXPECTED_ERROR,"can not emit promise")):new de(((s,o)=>{e.emit(t,...i,s,o)}))}function wt(e,t){if(e.getListeners(t).length===0)return de.resolve();for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return sn(e,t,...i)}function Di(e,t){if(e.getListeners(t).length===0)return null;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return va(e,t,...i)}function va(e,t){let n=null,i=null;for(var r=arguments.length,s=new Array(r>2?r-2:0),o=2;o<r;o++)s[o-2]=arguments[o];if(e.emit(t,...s,(a=>{n=a}),(a=>{i=a})),i!==null)throw i;if(n===null)throw new J(N.UNEXPECTED_ERROR,"handler is not sync");return n}const Gt=new class extends Vt{set networkState(e){this.emit(Ta.NETWORK_STATE_CHANGE,e,this._networkState),e===ii.ONLINE?this.emit(Ta.ONLINE):e===ii.OFFLINE&&(this.onlineWaiter=new de((t=>{this.once(Ta.ONLINE,(()=>{this.onlineWaiter=void 0,t(ii.ONLINE)}))})),this.emit(Ta.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===ii.ONLINE}constructor(){super(),xe(this,"_moduleName","network-indicator"),xe(this,"_networkState",ii.ONLINE),xe(this,"onlineWaiter",void 0),window.addEventListener("online",(()=>{this.networkState=ii.ONLINE})),window.addEventListener("offline",(()=>{this.networkState=ii.OFFLINE}))}},hi=[];for(let e=0;e<256;++e)hi.push((e+256).toString(16).slice(1));const cO=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);let ZE;const LY=new Uint8Array(16);function kY(){return cO?cO():(function(n,i,r){var s,o,a,c;const u=(s=(o=(n=n||{}).random)!==null&&o!==void 0?o:(a=(c=n).rng)===null||a===void 0?void 0:a.call(c))!==null&&s!==void 0?s:(function(){if(!ZE){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");ZE=crypto.getRandomValues.bind(crypto)}return ZE(LY)})();if(u.length<16)throw new Error("Random bytes length must be >= 16");if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,i){if((r=r||0)<0||r+16>i.length)throw new RangeError("UUID byte range ".concat(r,":").concat(r+15," is out of buffer bounds"));for(let p=0;p<16;++p)i[r+p]=u[p];return i}return(function(p){let m=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(hi[p[m+0]]+hi[p[m+1]]+hi[p[m+2]]+hi[p[m+3]]+"-"+hi[p[m+4]]+hi[p[m+5]]+"-"+hi[p[m+6]]+hi[p[m+7]]+"-"+hi[p[m+8]]+hi[p[m+9]]+"-"+hi[p[m+10]]+hi[p[m+11]]+hi[p[m+12]]+hi[p[m+13]]+hi[p[m+14]]+hi[p[m+15]]).toLowerCase()})(u)})(e,t,void 0);var e,t}function Sp(e,t){const n=e.indexOf(t);n!==-1&&e.splice(n,1)}function Jc(e){const t=[];return e.forEach((n=>{t.indexOf(n)===-1&&t.push(n)})),t}function yp(e){de!==void 0?de.resolve().then(e):setTimeout(e,0)}function Dt(e){return JSON.parse(JSON.stringify(e))}function Ra(e){try{return Dt(e)}catch{return e}}const dO={};function wo(e,t){dO[t]||(dO[t]=!0,e())}function Ca(e){const t=window.atob(e),n=new Uint8Array(new ArrayBuffer(t.length));for(let i=0;i<t.length;i+=1)n[i]=t.charCodeAt(i);return n}function Ao(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return window.btoa(t)}function lO(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=new TextEncoder().encode(e);if(n.length>t)n=n.slice(0,t);else if(n.length<t){const i=new Uint8Array(t);i.set(n),n=i}return n}function uO(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=$i(t).call(t,((o,a)=>o+a.length),0),r=new Uint8Array(new ArrayBuffer(i));let s=0;return t.forEach((o=>{r.set(o,s),s+=o.length})),r}function ys(e){return window.TextEncoder?new TextEncoder().encode(e).length:e.length}function hO(e){let t=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&e.realFormData&&(e=e.realFormData),e.forEach((n=>{t+=typeof n=="string"?ys(n):n.size})),t+138}function xY(e){const t=new J(N.TIMEOUT,"timeout");return new de(((n,i)=>{window.setTimeout((()=>i(t)),e)}))}function En(e){return new de((t=>{window.setTimeout(t,e)}))}function mt(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,e).toLowerCase();return n.length===e?"".concat(t).concat(n):"".concat(t).concat(n)+mt(e-n.length,"")}function ba(){let e,t=!1;try{var n;e=uH(n=kY()).call(n,"-","")}catch{t=!0}return!t&&e&&e.length===32||(e=mt(32,"")),e.toUpperCase()}const kl=()=>{},pO=new class{constructor(){xe(this,"fnMap",new Map)}throttleByKey(e,t,n,i){for(var r=arguments.length,s=new Array(r>4?r-4:0),o=4;o<r;o++)s[o-4]=arguments[o];if(this.fnMap.has(t)){const a=this.fnMap.get(t);if(a.threshold!==n){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout((()=>{const u=this.fnMap.get(t);u&&u.fn(...u.args),this.fnMap.delete(t)}),n);this.fnMap.set(t,{fn:e,threshold:n,timer:c,args:s,skipFn:i})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(t,ae(ae({},a),{},{fn:e,args:s,skipFn:i}))}else{const a=window.setTimeout((()=>{const c=this.fnMap.get(t);c&&c.fn(...c.args),this.fnMap.delete(t)}),n);this.fnMap.set(t,{fn:e,threshold:n,timer:a,args:s,skipFn:i})}}},mO=pO.throttleByKey.bind(pO);function fO(e){return typeof e=="object"&&e!==null&&!(e instanceof RegExp)}function $E(e,t){if(!fO(e)||!fO(t)||Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){const n=[...e];for(let i=0;i<t.length;i++)n[i]=$E(e[i],t[i]);return n}{const n=ae({},e);for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(Object.prototype.hasOwnProperty.call(e,i)?n[i]=$E(e[i],t[i]):n[i]=t[i]);return n}}function _O(e,t){let n=[0];if(n=new Array(t).fill(0),e===0)return n;let i=0;for(;e>0&&(n[i]=255&e,e>>=8,i++,i!==t););return n}function Qc(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function eS(e,t){try{return typeof e=="object"&&typeof t=="object"&&JSON.stringify(e)===JSON.stringify(t)}catch{return!1}}function tS(e){return $i(e).call(e,((t,n)=>t+n),0)}function gO(e){const t="0123456789abcdef";function n(x){let B,G="";for(B=0;B<=3;B++)G+=t.charAt(x>>8*B+4&15)+t.charAt(x>>8*B&15);return G}function i(x,B){const G=(65535&x)+(65535&B);return(x>>16)+(B>>16)+(G>>16)<<16|65535&G}function r(x,B,G,j,H,Z){return i((function(ne,he){return ne<<he|ne>>>32-he})(i(i(B,x),i(j,Z)),H),G)}function s(x,B,G,j,H,Z,ne){return r(B&G|~B&j,x,B,H,Z,ne)}function o(x,B,G,j,H,Z,ne){return r(B&j|G&~j,x,B,H,Z,ne)}function a(x,B,G,j,H,Z,ne){return r(B^G^j,x,B,H,Z,ne)}function c(x,B,G,j,H,Z,ne){return r(G^(B|~j),x,B,H,Z,ne)}const u=(function(x){let B;const G=1+(x.length+8>>6),j=new Array(16*G);for(B=0;B<16*G;B++)j[B]=0;for(B=0;B<x.length;B++)j[B>>2]|=x.charCodeAt(B)<<B%4*8;return j[B>>2]|=128<<B%4*8,j[16*G-2]=8*x.length,j})(e);let p,m,_,g,b,v=1732584193,R=-271733879,O=-1732584194,D=271733878;for(p=0;p<u.length;p+=16)m=v,_=R,g=O,b=D,v=s(v,R,O,D,u[p+0],7,-680876936),D=s(D,v,R,O,u[p+1],12,-389564586),O=s(O,D,v,R,u[p+2],17,606105819),R=s(R,O,D,v,u[p+3],22,-1044525330),v=s(v,R,O,D,u[p+4],7,-176418897),D=s(D,v,R,O,u[p+5],12,1200080426),O=s(O,D,v,R,u[p+6],17,-1473231341),R=s(R,O,D,v,u[p+7],22,-45705983),v=s(v,R,O,D,u[p+8],7,1770035416),D=s(D,v,R,O,u[p+9],12,-1958414417),O=s(O,D,v,R,u[p+10],17,-42063),R=s(R,O,D,v,u[p+11],22,-1990404162),v=s(v,R,O,D,u[p+12],7,1804603682),D=s(D,v,R,O,u[p+13],12,-40341101),O=s(O,D,v,R,u[p+14],17,-1502002290),R=s(R,O,D,v,u[p+15],22,1236535329),v=o(v,R,O,D,u[p+1],5,-165796510),D=o(D,v,R,O,u[p+6],9,-1069501632),O=o(O,D,v,R,u[p+11],14,643717713),R=o(R,O,D,v,u[p+0],20,-373897302),v=o(v,R,O,D,u[p+5],5,-701558691),D=o(D,v,R,O,u[p+10],9,38016083),O=o(O,D,v,R,u[p+15],14,-660478335),R=o(R,O,D,v,u[p+4],20,-405537848),v=o(v,R,O,D,u[p+9],5,568446438),D=o(D,v,R,O,u[p+14],9,-1019803690),O=o(O,D,v,R,u[p+3],14,-187363961),R=o(R,O,D,v,u[p+8],20,1163531501),v=o(v,R,O,D,u[p+13],5,-1444681467),D=o(D,v,R,O,u[p+2],9,-51403784),O=o(O,D,v,R,u[p+7],14,1735328473),R=o(R,O,D,v,u[p+12],20,-1926607734),v=a(v,R,O,D,u[p+5],4,-378558),D=a(D,v,R,O,u[p+8],11,-2022574463),O=a(O,D,v,R,u[p+11],16,1839030562),R=a(R,O,D,v,u[p+14],23,-35309556),v=a(v,R,O,D,u[p+1],4,-1530992060),D=a(D,v,R,O,u[p+4],11,1272893353),O=a(O,D,v,R,u[p+7],16,-155497632),R=a(R,O,D,v,u[p+10],23,-1094730640),v=a(v,R,O,D,u[p+13],4,681279174),D=a(D,v,R,O,u[p+0],11,-358537222),O=a(O,D,v,R,u[p+3],16,-722521979),R=a(R,O,D,v,u[p+6],23,76029189),v=a(v,R,O,D,u[p+9],4,-640364487),D=a(D,v,R,O,u[p+12],11,-421815835),O=a(O,D,v,R,u[p+15],16,530742520),R=a(R,O,D,v,u[p+2],23,-995338651),v=c(v,R,O,D,u[p+0],6,-198630844),D=c(D,v,R,O,u[p+7],10,1126891415),O=c(O,D,v,R,u[p+14],15,-1416354905),R=c(R,O,D,v,u[p+5],21,-57434055),v=c(v,R,O,D,u[p+12],6,1700485571),D=c(D,v,R,O,u[p+3],10,-1894986606),O=c(O,D,v,R,u[p+10],15,-1051523),R=c(R,O,D,v,u[p+1],21,-2054922799),v=c(v,R,O,D,u[p+8],6,1873313359),D=c(D,v,R,O,u[p+15],10,-30611744),O=c(O,D,v,R,u[p+6],15,-1560198380),R=c(R,O,D,v,u[p+13],21,1309151649),v=c(v,R,O,D,u[p+4],6,-145523070),D=c(D,v,R,O,u[p+11],10,-1120210379),O=c(O,D,v,R,u[p+2],15,718787259),R=c(R,O,D,v,u[p+9],21,-343485551),v=i(v,m),R=i(R,_),O=i(O,g),D=i(D,b);return n(v)+n(R)+n(O)+n(D)}let MY=1,EO=console,Cn=class{static setLogger(e){EO=e}constructor(e,t){xe(this,"id",void 0),xe(this,"lockingPromise",de.resolve()),xe(this,"locks",0),xe(this,"name",""),xe(this,"lockId",void 0),this.lockId=MY++,e&&(this.name=e),t&&(this.id=t),this.logger("created")}logger(e,t){const n=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),i=e==="created"?"is ".concat(e,"."):"is ".concat(e,", current queue ").concat(this.locks,". ").concat(t??"");EO.debug("".concat(n," ").concat(i))}setId(e){this.id=e}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,this.logger("locked",e);const n=new de((r=>{t=()=>{this.locks-=1,this.logger("unlocked",e),r()}})),i=this.lockingPromise.then((()=>t));return this.lockingPromise=this.lockingPromise.then((()=>n)),i}};function Zc(e,t){return function(n,i,r){const s=r.value;if(typeof s!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const o=this[t];if(!o)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const a=await o.lock("From ".concat(e,".").concat(i));try{for(var c=arguments.length,u=new Array(c),p=0;p<c;p++)u[p]=arguments[p];return await s.apply(this,u)}finally{a()}},r}}const $t={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function Tp(e,t){const n=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,n)}function zr(e,t,n,i){const r=Object.assign({},$t,i);let s=r.timeout;const o=async()=>{await(function(u){return new de((p=>{window.setTimeout(p,u)}))})(s),s*=r.timeoutFactor,s=Math.min(r.maxRetryTimeout,s)};let a=!1;const c=new de((async(u,p)=>{t=t||(()=>!1),n=n||(()=>!0);for(let m=0;m<r.maxRetryCount;m+=1){if(a)return p(new J(N.OPERATION_ABORTED));try{const _=await e();if(!t(_,m)||m+1===r.maxRetryCount)return u(_);await o()}catch(_){if(!n(_,m)||m+1===r.maxRetryCount)return p(_);await o()}}}));return c.cancel=()=>a=!0,c}let vp,nS=class{constructor(e){xe(this,"input",[]),xe(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return this.input.length===0?0:$i(e=this.input).call(e,((t,n)=>t+n))/this.input.length}},Rp=0,iS=0;function rS(e,t,n,i){return new de(((r,s)=>{t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),Rp+=ys(t.data)):n&&(t.data.size?Rp+=t.data.size:t.data instanceof FormData?Rp+=hO(t.data):Rp+=ys(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ui.request(t).then((o=>{typeof o.data=="string"?iS+=ys(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?iS+=o.data.byteLength:iS+=ys(JSON.stringify(o.data)),r(o.data)})).catch((o=>{ui.isCancel(o)?s(new J(N.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new J(N.NETWORK_TIMEOUT,o.message)):o.response?s(new J(N.NETWORK_RESPONSE_ERROR,o.response.status)):s(new J(N.NETWORK_ERROR,o.message))}))}))}async function UY(e,t){const n=new Blob([t.data],{type:"buffer"});return await rS(e,ae(ae({},t),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}const SO=()=>window.isSecureContext!==void 0;function vr(e){if(Array.isArray(e))return e.map((n=>n));if(!yO(e))return e;const t={};for(const n in e){const i=e[n];yO(i)||Array.isArray(i)?t[n]=vr(i):t[n]=i}return t}function yO(e){return!(typeof e!="object"||Array.isArray(e)||!e)}let sS=class{constructor(e){xe(this,"input",[]),xe(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}};const Rr={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},xl={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],transport:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0},selectedCandidatePair:{id:"unknown",localCandidate:Rr,remoteCandidate:Rr},updateInterval:0},TO={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},vO={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},RO={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},CO={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0};let oS=class{constructor(e,t){xe(this,"onFirstVideoReceived",void 0),xe(this,"onFirstVideoDecoded",void 0),xe(this,"onFirstAudioReceived",void 0),xe(this,"onFirstVideoDecodedTimeout",void 0),xe(this,"onFirstAudioDecoded",void 0),xe(this,"onSelectedLocalCandidateChanged",void 0),xe(this,"onSelectedRemoteCandidateChanged",void 0),xe(this,"videoIsReady",!1),xe(this,"videoIsReady2",{}),xe(this,"pc",void 0),xe(this,"options",void 0),xe(this,"intervalTimer",void 0),xe(this,"stats",vr(xl)),xe(this,"isFirstVideoReceived",{}),xe(this,"isFirstVideoDecoded",{}),xe(this,"isFirstAudioReceived",{}),xe(this,"isFirstAudioDecoded",{}),xe(this,"isFirstVideoDecodedTimeout",{}),xe(this,"lossRateWindowStats",[]),this.pc=e,this.options=t,this.intervalTimer=window.setInterval((async()=>{this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new de((e=>{e({local:ae({},Rr),remote:ae({},Rr)})}))}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"];let i=0,r=0,s=0,o=0;for(const a of n)e[a].forEach(((c,u)=>{if(!this.lossRateWindowStats[t-1][a][u]||!this.lossRateWindowStats[0][a][u])return;const p=this.lossRateWindowStats[t-1][a][u].packets-this.lossRateWindowStats[0][a][u].packets,m=this.lossRateWindowStats[t-1][a][u].packetsLost-this.lossRateWindowStats[0][a][u].packetsLost;a==="videoSend"||a==="audioSend"?(i+=p,s+=m):(r+=p,o+=m),Number.isNaN(p)||Number.isNaN(p)?c.packetLostRate=0:c.packetLostRate=p<=0||m<=0?0:m/(p+m)}));e.sendPacketLossRate=i<=0||s<=0?0:s/(i+s),e.recvPacketLossRate=r<=0||o<=0?0:o/(r+o)}},VY=class extends oS{constructor(){super(...arguments),xe(this,"_stats",xl),xe(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=vr(xl);const n=t.filter((r=>r.type==="ssrc"));this.processSSRCStats(n);const i=t.find((r=>r.type==="VideoBwe"));i&&this.processBandwidthStats(i),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach((t=>{var n;const i=ie(n=t.id).call(n,"send");switch("".concat(t.mediaType,"_").concat(i?"send":"recv")){case"video_send":{const r=vr(vO);r.codec=t.googCodecName,r.adaptionChangeReason="none",t.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),t.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(t.googAvgEncodeMs),r.inputFrame={width:Number(t.googFrameWidthInput)||Number(t.googFrameWidthSent),height:Number(t.googFrameHeightInput)||Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},r.sentFrame={width:Number(t.googFrameWidthSent),height:Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},r.firsCount=Number(t.googFirReceived),r.nacksCount=Number(t.googNacksReceived),r.plisCount=Number(t.googPlisReceived),r.frameCount=Number(t.framesEncoded),r.bytes=Number(t.bytesSent),r.packets=Number(t.packetsSent),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.rttMs=Number(t.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{const r=vr(TO),s=this.lastDecodeVideoReceiverStats.get(Number(t.ssrc));if(r.codec=t.googCodecName,r.targetDelayMs=Number(t.googTargetDelayMs),r.renderDelayMs=Number(t.googRenderDelayMs),r.currentDelayMs=Number(t.googCurrentDelayMs),r.minPlayoutDelayMs=Number(t.googMinPlayoutDelayMs),r.decodeMs=Number(t.googDecodeMs),r.maxDecodeMs=Number(t.googMaxDecodeMs),r.receivedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateReceived)},r.decodedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateDecoded)},r.decodeFrameRate=Number(t.googFrameRateDecoded),r.outputFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateOutput)},r.jitterBufferMs=Number(t.googJitterBufferMs),r.firsCount=Number(t.googFirsSent),r.nacksCount=Number(t.googNacksSent),r.plisCount=Number(t.googPlisSent),r.framesDecodeCount=Number(t.framesDecoded),r.bytes=Number(t.bytesReceived),r.packets=Number(t.packetsReceived),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),s){const o=s.stats,a=Date.now()-s.lts;r.framesDecodeFreezeTime=o.framesDecodeFreezeTime,r.framesDecodeInterval=o.framesDecodeInterval,r.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(s.lts=Date.now(),r.framesDecodeInterval=a,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):r.framesDecodeCount<s.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:ae({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{const r=vr(CO);r.codec=t.googCodecName,r.outputLevel=Math.abs(Number(t.audioOutputLevel))/32767,r.decodingCNG=Number(t.googDecodingCNG),r.decodingCTN=Number(t.googDecodingCTN),r.decodingCTSG=Number(t.googDecodingCTSG),r.decodingNormal=Number(t.googDecodingNormal),r.decodingPLC=Number(t.googDecodingPLC),r.decodingPLCCNG=Number(t.googDecodingPLCCNG),r.expandRate=Number(t.googExpandRate),r.accelerateRate=Number(t.googAccelerateRate),r.preemptiveExpandRate=Number(t.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(t.googSecondaryDecodedRate),r.speechExpandRate=Number(t.googSpeechExpandRate),r.preferredJitterBufferMs=Number(t.googPreferredJitterBufferMs),r.jitterBufferMs=Number(t.googJitterBufferMs),r.jitterMs=Number(t.googJitterReceived),r.bytes=Number(t.bytesReceived),r.packets=Number(t.packetsReceived),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.receivedFrames=Number(t.googDecodingCTN)||Number(t.packetsReceived),r.droppedFrames=Number(t.googDecodingPLC)+Number(t.googDecodingPLCCNG)||Number(t.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{const r=vr(RO);r.codec=t.googCodecName,r.inputLevel=Math.abs(Number(t.audioInputLevel))/32767,r.aecReturnLoss=Number(t.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(t.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(t.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(t.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(t.bytesSent),r.packets=Number(t.packetsSent),r.packetsLost=Number(t.packetsLost),r.ssrc=Number(t.ssrc),r.rttMs=Number(t.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}}))}_getStats(){return new de(((e,t)=>{this.pc.getStats(e,t)}))}statsResponsesToObjects(e){const t=[];return e.result().forEach((n=>{const i={id:n.id,timestamp:n.timestamp.valueOf().toString(),type:n.type};n.names().forEach((r=>{i[r]=n.stat(r)})),t.push(i)})),t}},$c=(function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e})({}),Cp=(function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L1T3_KEY="L1T3_KEY",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e})({}),aS=(function(e){return e[e.new=0]="new",e[e.connecting=1]="connecting",e[e.connected=2]="connected",e[e.disconnected=3]="disconnected",e[e.failed=4]="failed",e[e.closed=5]="closed",e})({}),Fi=(function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e})({});var ed=(function(e){return e[e.kNone=1]="kNone",e[e.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",e[e.kBytesToBits=8]="kBytesToBits",e})(ed||{});function Ml(e,t,n,i){let r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:ed.kNone;if(!t)return;const s=Number(t[n]);if(typeof s!="number")return;const o=Number(t[i]);if(typeof o!="number")return;if(!e)return o?s/o*r:void 0;const a=Number(e[n]);if(typeof a!="number")return;const c=Number(e[i]);if(typeof c!="number")return;const u=o-c;return u?(s-a)/u*r:void 0}let bO=class extends oS{constructor(){super(...arguments),xe(this,"_stats",xl),xe(this,"report",void 0),xe(this,"lastDecodeVideoReceiverStats",new Map),xe(this,"lastVideoFramesRecv",new Map),xe(this,"lastVideoFramesSent",new Map),xe(this,"lastVideoFramesDecode",new Map),xe(this,"lastVideoFramesOutput",new Map),xe(this,"lastVideoJBDelay",new Map),xe(this,"lastAudioJBDelay",new Map),xe(this,"mediaBytesSent",new Map),xe(this,"mediaBytesRetransmit",new Map),xe(this,"mediaBytesTargetEncode",new Map),xe(this,"lastDecodeAudioReceiverStats",new Map),xe(this,"lastAudioConcealment",new Map),xe(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=vr(xl),this.report.forEach((e=>{switch(e.type){case Fi.OUTBOUND:case Fi.INBOUND:{const t=e.mediaType||e.kind,n=!t&&"frameWidth"in e,i=!t&&!("frameWidth"in e);e.type===Fi.OUTBOUND?t==="audio"||i?this.processAudioOutboundStats(e):(t==="video"||n)&&this.processVideoOutboundStats(e):e.type===Fi.INBOUND&&(t==="audio"||i?this.processAudioInboundStats(e):(t==="video"||n)&&this.processVideoInboundStats(e));break}case Fi.TRANSPORT:{this.processTransportStats(e);const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case Fi.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}})),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:ae({},Rr),remote:ae({},Rr)};return e.forEach((n=>{let i;if(n.type===Fi.TRANSPORT&&(i=e.get(n.selectedCandidatePairId)),n.type===Fi.CANDIDATE_PAIR&&n.selected&&(i=n),i){const r=(s,o)=>{s.type=o.type,s.id=o.id,o.address&&(s.address=o.address),o.candidateType&&(s.candidateType=o.candidateType),o.port&&(s.port=o.port),o.priority&&(s.priority=o.priority),o.protocol&&(s.protocol=o.protocol),o.relayProtocol&&(s.relayProtocol=o.relayProtocol)};if(i.localCandidateId){const s=e.get(i.localCandidateId);s&&r(t.local,s)}if(i.remoteCandidateId){const s=e.get(i.remoteCandidateId);s&&r(t.remote,s)}}})),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.audioSend.forEach((t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)})),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===Fi.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===Fi.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===Fi.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(ae({},t),ae({},this.stats.selectedCandidatePair.localCandidate)),e.type===Fi.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(ae({},t),ae({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find((i=>i.ssrc===e.ssrc));t||(t=vr(CO),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.packetsDiscarded=e.packetsDiscarded,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.totalProcessingDelay=e.totalProcessingDelay,t.jitterBufferEmittedCount=e.jitterBufferEmittedCount,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const n=this.lastDecodeAudioReceiverStats.get(t.ssrc);t.avgProcessingDelayMs=Ml(n,t,"totalProcessingDelay","jitterBufferEmittedCount",ed.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(e,e.trackId,t),this.calculateAudioFreeze(t,n,e),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),typeof e.concealedSamples=="number"&&(t.concealedSamples=e.concealedSamples),this.lastDecodeAudioReceiverStats.set(t.ssrc,ae({},t))}calculateAudioFreeze(e,t,n){const i=this.lastAudioConcealment.get(e.ssrc);if(t!=null&&i!=null){const r=i.lts,s=n.timestamp,o=s-r;if(o<=0)return;const a=e.concealedSamples-t.concealedSamples-0,c=i.nonSilent+a,u=e.totalSamplesReceived-t.totalSamplesReceived;if(u<=0)return;const p=80*u/o,m=200*u/o,_=o/u;let g=0;e.freezeSamples80=t.freezeSamples80,e.freezeMs80=t.freezeMs80,c>p&&(i.plc80>0?(e.freezeSamples80+=a,e.freezeMs80+=Math.round(a*_)):(e.freezeSamples80+=c,e.freezeMs80+=Math.round(c*_)),g=i.plc80+1);let b=0;e.freezeSamples200=t.freezeSamples200,e.freezeMs200=t.freezeMs200,c>m&&(i.plc200>0?(e.freezeSamples200+=a,e.freezeMs200+=Math.round(a*_)):(e.freezeSamples200+=c,e.freezeMs200+=Math.round(c*_)),b=i.plc200+1),this.lastAudioConcealment.set(e.ssrc,{nonSilent:a,lts:s,plc80:g,plc200:b})}else e.freezeSamples80=0,e.freezeSamples200=0,e.freezeMs80=0,e.freezeMs200=0,this.lastAudioConcealment.set(e.ssrc,{nonSilent:0,lts:n.timestamp,plc80:0,plc200:0})}processVideoInboundStats(e){let t=this._stats.videoRecv.find((o=>o.ssrc===e.ssrc));t||(t=vr(TO),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.framesDroppedCount=e.framesDropped,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,t.totalFreezesDuration=e.totalFreezesDuration,t.totalProcessingDelay=e.totalProcessingDelay,t.packetsDiscarded=e.packetsDiscarded,t.framesAssembledFromMultiplePackets=e.framesAssembledFromMultiplePackets,t.totalAssemblyTime=e.totalAssemblyTime,t.keyFramesDecoded=e.keyFramesDecoded,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const n=this.lastDecodeVideoReceiverStats.get(t.ssrc),i=this.lastVideoFramesDecode.get(t.ssrc),r=this.lastVideoFramesOutput.get(t.ssrc),s=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const o=t.decodedFrame?t.decodedFrame.width:0,a=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,o,a),this.isFirstVideoDecoded[t.ssrc]=!0}if(n){const o=n.stats,a=s-n.lts;t.framesDecodeFreezeTime=o.framesDecodeFreezeTime,t.framesDecodeInterval=o.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>o.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(n.lts=Date.now(),t.framesDecodeInterval=a,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<o.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(n.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-n.qpSum)/(e.framesDecoded-n.stats.framesDecodeCount))}e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime,t.avgDecodeMs=Ml(n?.stats,t,"decodeMs","framesDecodeCount")),t.avgProcessingDelayMs=Ml(n?.stats,t,"totalProcessingDelay","framesDecodeCount",ed.kMillisecondsFromSeconds),t.avgFramesAssembledFromMultiplePacketsMs=Ml(n?.stats,t,"totalAssemblyTime","framesAssembledFromMultiplePackets",ed.kMillisecondsFromSeconds),t.avgInterFrameDelayMs=Ml(n?.stats,t,"totalInterFrameDelay","framesDecodeCount",ed.kMillisecondsFromSeconds),i&&s-i.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-i.count)/((s-i.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:t.decodeFrameRate})):i?t.decodeFrameRate=i.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:s,rate:0}),t.framesDroppedCount&&e.framesReceived&&(r&&s-r.lts>=800?(t.outputFrameRate=Math.round((e.framesReceived-t.framesDroppedCount-r.count)/((s-r.lts)/1e3)),this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:s,rate:Math.max(t.outputFrameRate,0)})):r?t.outputFrameRate=r.rate:this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:s,rate:0})),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:ae({},t),lts:n?n.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find((i=>i.ssrc===e.ssrc));t||(t=vr(vO),this._stats.videoSend.push(t));const n=this.mediaBytesSent.get(e.ssrc);if(n)n.add(e.bytesSent);else{const i=new sS(10);i.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,i)}if(e.retransmittedBytesSent!==void 0){const i=this.mediaBytesRetransmit.get(e.ssrc);if(i)i.add(e.retransmittedBytesSent);else{const r=new sS(10);r.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,r)}}if(e.totalEncodedBytesTarget){const i=this.mediaBytesTargetEncode.get(e.ssrc);if(i)i.add(e.totalEncodedBytesTarget);else{const r=new sS(10);r.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,r)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,t.hugeFramesSent=e.hugeFramesSent,t.keyFramesEncoded=e.keyFramesEncoded,t.targetBitrate=e.targetBitrate,e.totalEncodeTime&&e.framesEncoded){const i=this.lastEncoderMs.get(e.ssrc);if(!i||i.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const r=e.framesEncoded-i.lastFrameCount,s=e.totalEncodeTime-i.lastEncoderTime;t.avgEncodeMs=1e3*s/r}}if(e.framesEncoded&&e.qpSum){const i=this.lastEncoderMs.get(e.ssrc);!i||i.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-i.lastQpSum)/(e.framesEncoded-i.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const i=this.findRemoteStatsId(e.ssrc,Fi.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find((n=>n.ssrc===e.ssrc));if(t||(t=vr(RO),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const n=this.findRemoteStatsId(e.ssrc,Fi.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,t)}}processTransportStats(e){this._stats.transport.bytesReceived=e.bytesReceived||this._stats.transport.bytesReceived,this._stats.transport.bytesSent=e.bytesSent||this._stats.transport.bytesSent,this._stats.transport.packetsReceived=e.packetsReceived||this._stats.transport.packetsReceived,this._stats.transport.packetsSent=e.packetsSent||this._stats.transport.packetsSent}findRemoteStatsId(e,t){var n;const i=Array.from(Ii(n=this.report).call(n)).find((r=>r.type===t&&r.ssrc===e));return i?i.id:null}processVideoMediaSource(e,t){const n=this.report.get(e);n&&n.width&&n.height&&n.framesPerSecond&&(t.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(e,t){const n=this.report.get(e);n&&(t.inputLevel=n.audioLevel)}processVideoTrackSenderStats(e,t,n){var i,r,s,o;const a=t?this.report.get(t):void 0,c=(i=a?.framesSent)!==null&&i!==void 0?i:e.framesSent;if(typeof c!="number")return;let u=(r=a?.frameWidth)!==null&&r!==void 0?r:e.frameWidth,p=(s=a?.frameHeight)!==null&&s!==void 0?s:e.frameHeight,m=(o=a?.framesPerSecond)!==null&&o!==void 0?o:e.framesPerSecond;if(typeof u=="number"&&typeof p=="number"||(u=0,p=0),m==null){const _=Date.now(),g=this.lastVideoFramesSent.get(n.ssrc);g&&_-g.lts>=800?(m=Math.round((c-g.count)/((_-g.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:_,rate:m})):g?m=g.rate:this.lastVideoFramesSent.set(n.ssrc,{count:c,lts:_,rate:0})}n.sentFrame={width:u,height:p,frameRate:Math.max(0,m)}}processVideoTrackReceiverStats(e,t,n){var i,r,s,o,a;const c=t?this.report.get(t):void 0,u=(i=c?.framesReceived)!==null&&i!==void 0?i:e.framesReceived,p=(r=c?.frameWidth)!==null&&r!==void 0?r:e.frameWidth,m=(s=c?.frameHeight)!==null&&s!==void 0?s:e.frameHeight,_=(o=c?.jitterBufferDelay)!==null&&o!==void 0?o:e.jitterBufferDelay,g=(a=c?.jitterBufferEmittedCount)!==null&&a!==void 0?a:e.jitterBufferEmittedCount;if(typeof u=="number"){const b=this.lastVideoFramesRecv.get(n.ssrc),v=Date.now();n.framesReceivedCount=u;let R=0;b&&v-b.lts>=800?(R=Math.round((u-b.count)/((v-b.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:u,lts:v,rate:R})):b?R=b.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:u,lts:v,rate:0}),n.receivedFrame={width:p||0,height:m||0,frameRate:R||0},n.decodedFrame={width:p||0,height:m||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:p||0,height:m||0,frameRate:n.outputFrameRate||n.decodeFrameRate||0}}if(_&&g){const b=this.lastVideoJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let v=b.jitterBufferMs;const R=g-b.jitterBufferEmittedCount;R>0&&(v=1e3*(_-b.jitterBufferDelay)/R),n.jitterBufferMs=v,n.currentDelayMs=Math.round(v),this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:_,jitterBufferEmittedCount:g,jitterBufferMs:n.currentDelayMs})}}processAudioTrackSenderStats(e,t,n){var i,r,s,o;const a=t?this.report.get(t):void 0,c=(i=(r=a?.echoReturnLoss)!==null&&r!==void 0?r:e.echoReturnLoss)!==null&&i!==void 0?i:0,u=(s=(o=a?.echoReturnLossEnhancement)!==null&&o!==void 0?o:e.echoReturnLossEnhancement)!==null&&s!==void 0?s:0;n.aecReturnLoss=c,n.aecReturnLossEnhancement=u}processAudioTrackReceiverStats(e,t,n){var i,r,s,o,a,c,u,p,m;const _=t?this.report.get(t):void 0,g=(i=_?.removedSamplesForAcceleration)!==null&&i!==void 0?i:e.removedSamplesForAcceleration,b=(r=_?.totalSamplesReceived)!==null&&r!==void 0?r:e.totalSamplesReceived,v=(s=_?.jitterBufferDelay)!==null&&s!==void 0?s:e.jitterBufferDelay,R=(o=_?.jitterBufferEmittedCount)!==null&&o!==void 0?o:e.jitterBufferEmittedCount,O=(a=_?.audioLevel)!==null&&a!==void 0?a:e?.audioLevel,D=(c=_?.totalSamplesDuration)!==null&&c!==void 0?c:e?.totalSamplesDuration,x=(u=_?.concealedSamples)!==null&&u!==void 0?u:e.concealedSamples,B=(p=_?.silentConcealedSamples)!==null&&p!==void 0?p:e.silentConcealedSamples,G=(m=_?.concealmentEvents)!==null&&m!==void 0?m:e.concealmentEvents;if(typeof b=="number"&&(n.totalSamplesReceived=b),typeof B=="number"&&(n.silentConcealedSamples=B),typeof G=="number"&&(n.concealmentEvents=G),typeof x=="number"&&(n.concealedSamples=x),g&&b&&(n.accelerateRate=g/b),v&&R){const H=this.lastAudioJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let Z=H.jitterBufferMs;const ne=R-H.jitterBufferEmittedCount;ne>0&&(Z=1e3*(v-H.jitterBufferDelay)/ne),n.jitterBufferMs=Math.round(Z),this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:v,jitterBufferEmittedCount:R,jitterBufferMs:n.jitterBufferMs})}n.outputLevel=O;let j=1920;D&&b&&(j=b/D/50,n.receivedFrames=Math.round(b/j)),x&&(n.droppedFrames=Math.round(x/j))}processRemoteInboundStats(e,t){const n=this.report.get(e);n&&(t.packetsLost=n.packetsLost,n.roundTripTime&&(t.rttMs=1e3*n.roundTripTime),n.jitter&&(t.jitterMs=1e3*n.jitter),n.timestamp&&(t.timestamp=n.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const n=t.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let e=0,t=null,n=null;this.mediaBytesSent.forEach((r=>{e+=r.diffMean()})),this.mediaBytesRetransmit.forEach((r=>{t=t===null?r.diffMean():t+r.diffMean()})),this.mediaBytesTargetEncode.forEach((r=>{n=n===null?r.diffMean():n+r.diffMean()}));const i=t!==null?e-t:e;this._stats.bitrate={actualEncoded:8*i/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},t!==null&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),n!==null&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}},jY=class extends oS{updateStats(){return de.resolve()}};function bp(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const s=(function(){const o=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return o&&o[0]?Number(o[0].split("/")[1]):null})();return s?s<76?new VY(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new bO(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):(function(o){if(!window.RTCStatsReport)return!1;const a=o.getStats();return!!(a instanceof de||(function(c){return!!c&&(typeof c=="object"||typeof c=="function")&&typeof c.then=="function"})(a))})(e)?new bO(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new jY(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r})}const wO="websdk_ng_install_id";function cS(){try{if(I("INSTALL_ID"))return I("INSTALL_ID");let e=window.localStorage.getItem(wO);return e||(e=ba(),window.localStorage.setItem(wO,e)),St("INSTALL_ID",e),e}catch{return}}const tr=(function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(t&&t[1]&&t[2]){const n=t[1],i=t[2];return"".concat(n,".").concat(i)}return"4.0.0.999"})("4.24.2"),dS=(function(){try{return JSON.parse("true")===!0}catch{return!0}})();let wa=(function(e){return e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn",e})({});const xn=(function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const i=n.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const s=r.join(""),o={};return o[e]=i,o[t]=s,Object.assign(o,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})})();window.DEFAULT_TURN_CONFIG=xn;const wp={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!0,FORCE_ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:1,ENABLE_AUT_FEEDBACK:!0,SVC_EXTENDED:["VP9"]},lS={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},uS="v4.24.2-0-g002485b1-dirty(12/12/2025, 5:26:54 PM)",hS={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",TURN_DOMAINS:["edge.agora.io"],USE_TURN_IP:!0,NEW_TURN_MODE:4,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1,FLS_FALLBACK_TIMEOUT:3e4,RTE_DETAIL_REPORT_INTERVAL:6e4,ENCODE_EXCEPTION_TIMES:5,ENABLE_ENCODE_EXCEPTION:!0,ENCODE_EXCEPTION_VALIDATE_CODEC:["h264"],VIDEO_ENCODER_CONFIG_LIST:[{width:240,height:180},{width:320,height:240},{width:400,height:300},{width:480,height:360},{width:560,height:420},{width:640,height:480}],DELETE_NEQ_AFTER_USER_LEAVE:!0,UPDATE_RTP_CAP_IN_HOST:!1,IOS_BG_TAG:!0,IOS_AUTO_RESTART_BG_TAG:!0,IGNORE_UID_CHECK:!1,ENABLE_UP_SPS_PPS:!1,ENABLE_DOWN_SPS_PPS:!1,NO_EDGES_RETRY:!0,BUFFER_READY_FRAMES:3,FLS_SYNC_AV_PLAY_LIMIT:0,FLS_BUFFER_WAIT_TIME:1500,VOS_CONFIGURE:void 0,ENABLE_QUALITY_FALLBACK:!1,QUALITY_FALLBACK_REHEARSAL:!0,ENABLE_FLS_AV1_FIRST:!1,ENABLE_AP_MULTI_IP:!0,FLS_ENABLE_AV1_DETECT:!0,FLS_ENABLE_AV1_DECODE_DETECT:!0},ft=ae(ae(ae(ae({},hS),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_MANAGER_WSS:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_WSS:"",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ENABLE_ABSSENDTIME_AS_SENTTS:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,DC_JOIN_WITH_FAILBACK:4e3,DC_CONNECTION_TIMEOUT:2e3,DC_PINGPONG_INTERVAL:2e3,DC_DEBUG_LOG:!1,UNSUPPORTED_VIDEO_UPLINK_CODEC:[],UNSUPPORTED_VIDEO_DOWNLINK_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:lS,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},wp),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,REMOTE_VIDEO_STREAM_TYPE:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1,ENABLE_FORCE_HLS:!1,MAX_WEBAUDIO_VOLUME:300,ENABLE_VOS_FALLBACK:!1,ENABLE_FALLBACK_TO_HLS:!1,ENABLE_PRE_RENDER:!1,FORCE_DISABLE_AUTO_SUB:!1,ENABLE_PRE_SUB_WITH_PRE_PC:!0,PRE_USE_LOCAL_CODECS:!0},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:2,BASELINE_MORE_H264_BITRATE_RATIO:1.1,IGNORE_RTC_DEVICE_CHECK:!1,FLS_AUTOPLAY_EMITS:!1,ENABLE_DUAL_STREAM_FLAG:!1,FORBID_MODIFY_LOCAL_OFFER_SDP:!1,RESERVE_MID_1_MLINE:!1});function St(e,t,n){var i,r,s;ie(i=Object.keys(ft)).call(i,e)&&(!n&&ie(r=Object.keys(Bi)).call(r,e)||(ft[e]=t,e!=="ENABLE_VIDEO_SEI"&&e!=="ENABLE_AUDIO_TOPN"&&e!=="ENABLE_AUDIO_METADATA"&&e!=="ENABLE_AUDIO_PTS"||t!==!0||(ft.ENABLE_ENCODED_TRANSFORM=!0),e==="USE_NEW_NETWORK_CONFIG"&&t&&(s=!!t,ft.USE_NEW_NETWORK_CONFIG=s,s&&(ft.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],ft.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],ft.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ft.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],ft.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",ft.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",ft.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),e==="ENABLE_PRE_SUB"&&t&&(ft.ENABLE_INSTANT_VIDEO=!0,ft.ENABLE_PREALLOC_PC=!0),e==="ENABLE_SVC"&&t&&(ft.ENABLE_AUT_CC=!0),e==="NEW_FORCE_TURN"&&t&&(ft.NEW_TURN_MODE||(ft.NEW_TURN_MODE=4))))}function I(e){if(e==="TURN_DOMAINS"){const t=ft.TURN_DOMAINS;return ie(t).call(t,I("TURN_DOMAIN"))?t:[I("TURN_DOMAIN")].concat(t)}return ft[e]}dS||(ft.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],ft.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],ft.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],ft.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ft.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],ft.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],ft.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",ft.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",ft.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",ft.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",ft.AREAS=["NORTH_AMERICA","OVERSEA"]);let AO=(function(e){return e[e.REALTIME=1]="REALTIME",e})({});const Bi={};var Pe=(function(e){return e.SET_SESSION_ID="SET_SESSION_ID",e.SET_RTE_URL="SET_RTE_URL",e.SET_RTE_SID="SET_RTE_SID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.KEY_METRIC_PRELOAD_START="KEY_METRIC_PRELOAD_START",e.KEY_METRIC_PRELOAD_END="KEY_METRIC_PRELOAD_END",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_REQUEST_SUA_END="KEY_METRIC_REQUEST_SUA_END",e.KEY_METRIC_BEFORE_CONNECT="KEY_METRIC_BEFORE_CONNECT",e.KEY_METRIC_PEER_RECEIVER="KEY_METRIC_PEER_RECEIVER",e.KEY_METRIC_SIGNAL_CONNECTED="KEY_METRIC_SIGNAL_CONNECTED",e.KEY_METRIC_JOIN_REQ="KEY_METRIC_JOIN_REQ",e.KEY_METRIC_JOIN_REP="KEY_METRIC_JOIN_REP",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED="KEY_METRIC_FIRST_VIDEO_FRAME_DECODED",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.RESET_FIRST_VIDEO_FRAME_DECODED="RESET_FIRST_VIDEO_FRAME_DECODED",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",e})(Pe||{});let Aa=(function(e){return e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1",e})({});(function(e){e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722"})({});const IO=128,FY=96,OO=1e3,td=10;let BY=0;var NO=(()=>{var e={8:(i,r,s)=>{s.r(r),s.d(r,{Parser:()=>ne,Printer:()=>Ue,parse:()=>ce,print:()=>ge});const o=`
`,a="".concat("\r").concat(o),c=" ";let u;function p(te){return te>="0"&&te<="9"}function m(te){return te>="!"&&te<="~"}function _(te){return m(te)||te>=""&&te<=""}function g(te){return te==="!"||te>="#"&&te<="'"||te>="*"&&te<="+"||te>="-"&&te<="."||te>="0"&&te<="9"||te>="A"&&te<="Z"||te>="^"&&te<="~"}function b(te){return te>="1"&&te<="9"}function v(te){return te>="A"&&te<="Z"||te>="a"&&te<="z"}function R(te){return te==="d"||te==="h"||te==="m"||te==="s"}function O(te){return te>""&&te<"	"||te>"\v"&&te<"\f"||te>""&&te<""}function D(te){return v(te)||p(te)||te==="+"||te==="/"}function x(te){return p(te)||v(te)||te==="+"||te==="/"||te==="-"||te==="_"}function B(te){return v(te)||p(te)||te==="+"||te==="/"}function G(te,T){var k=Object.keys(te);if(Object.getOwnPropertySymbols){var F=Object.getOwnPropertySymbols(te);T&&(F=F.filter((function(se){return Object.getOwnPropertyDescriptor(te,se).enumerable}))),k.push.apply(k,F)}return k}function j(te){for(var T=1;T<arguments.length;T++){var k=arguments[T]!=null?arguments[T]:{};T%2?G(Object(k),!0).forEach((function(F){H(te,F,k[F])})):Object.getOwnPropertyDescriptors?Object.defineProperties(te,Object.getOwnPropertyDescriptors(k)):G(Object(k)).forEach((function(F){Object.defineProperty(te,F,Object.getOwnPropertyDescriptor(k,F))}))}return te}function H(te,T,k){return T in te?Object.defineProperty(te,T,{value:k,enumerable:!0,configurable:!0,writable:!0}):te[T]=k,te}(function(te){te.VERSION="v",te.ORIGIN="o",te.SESSION_NAME="s",te.INFORMATION="i",te.URI="u",te.EMAIL="e",te.PHONE="p",te.CONNECTION="c",te.BANDWIDTH="b",te.TIME="t",te.REPEAT="r",te.ZONE_ADJUSTMENTS="z",te.KEY="k",te.ATTRIBUTE="a",te.MEDIA="m"})(u||(u={}));class Z{consumeText(T,k){let F=k;for(;F<T.length;){const se=T[F];if(se==="\0"||se==="\r"||se===o)break;F+=1}if(F-k==0)throw new Error("Invalid text, at ".concat(T));return F}consumeUnicastAddress(T,k,F){return this.consumeTill(T,k,c)}consumeOneOrMore(T,k,F){let se=k;for(;F(T[se]);)se++;if(se-k==0)throw new Error("Invalid rule at ".concat(k,"."));return se}consumeSpace(T,k){if(T[k]===c)return k+1;throw new Error("Invalid space at ".concat(k,"."))}consumeIP4Address(T,k){let F=k;for(let se=0;se<4;se++)if(F=this.consumeDecimalUChar(T,F),se!==3){if(T[F]!==".")throw new Error("Invalid IP4 address.");F++}return F}consumeDecimalUChar(T,k){let F=k;for(let ke=0;ke<3&&p(T[F]);ke++,F++);if(F-k==0)throw new Error("Invalid decimal uchar.");const se=parseInt(T.slice(k,F));if(se>=0&&se<=255)return F;throw new Error("Invalid decimal uchar")}consumeIP6Address(T,k){let F=this.consumeHexpart(T,k);return T[F]===":"&&(F+=1,F=this.consumeIP4Address(T,F)),F}consumeHexpart(T,k){let F=k;if(T[F]===":"&&T[F+1]===":"){F+=2;try{F=this.consumeHexseq(T,F)}catch{}return F}if(F=this.consumeHexseq(T,F),T[F]===":"&&T[F+1]===":"){F+=2;try{F=this.consumeHexseq(T,F)}catch{}return F}return F}consumeHexseq(T,k){let F=k;for(;F=this.consumeHex4(T,F),T[F]===":"&&T[F+1]!==":";)F+=1;return F}consumeHex4(T,k){let F=0;for(;F<4;F++)if(!((se=T[k+F])>="0"&&se<="9"||se>="a"&&se<="f"||se>="A"&&se<="F")){if(F===0)throw new Error("Invalid hex 4");break}var se;return k+F}consumeFQDN(T,k){let F=k;for(;p(T[F])||v(T[F])||T[F]==="-"||T[F]===".";)F+=1;if(F-k<4)throw new Error("Invalid FQDN");return F}consumeExtnAddr(T,k){return this.consumeOneOrMore(T,k,_)}consumeMulticastAddress(T,k,F){switch(F){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(T,k);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(T,k);default:try{return this.consumeFQDN(T,k)}catch{return this.consumeExtnAddr(T,k)}}}consumeIP6MulticastAddress(T,k){const F=this.consumeHexpart(T,k);return T[F]==="/"?this.consumeInteger(T,F+1):F}consumeIP4MulticastAddress(T,k){let F=k+3;const se=T.slice(k,F),ke=parseInt(se);if(ke<224||ke>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let It=0;It<3;It++){if(T[F]!==".")throw new Error("Invalid IP4 multicast address.");F+=1,F=this.consumeDecimalUChar(T,F)}return T[F]==="/"&&(F+=1),F=this.consumeTTL(T,F),T[F]==="/"&&(F=this.consumeInteger(T,F)),F}consumeInteger(T,k){if(!b(T[k]))throw new Error("Invalid integer.");for(k+=1;p(T[k]);)k+=1;return k}consumeTTL(T,k){if(T[k]==="0")return k+1;if(!b(T[k]))throw new Error("Invalid TTL.");k+=1;for(let F=0;F<2&&p(T[k]);F++)k+=1;return k}consumeToken(T,k){return this.consumeOneOrMore(T,k,g)}consumeTime(T,k){let F=k;if(T[F]==="0")return F+1;for(b(T[F])&&(F+=1);p(T[F]);)F++;if(F-k<10)throw new Error("Invalid time");return F}consumeAddress(T,k){return this.consumeTill(T,k,c)}consumeTypedTime(T,k){let F=k;return F=this.consumeOneOrMore(T,F,p),R(T[F])?F+1:F}consumeRepeatInterval(T,k){if(!b(T[k]))throw new Error("Invalid repeat interval");for(k+=1;p(T[k]);)k+=1;return R(T[k])&&(k+=1),k}consumePort(T,k){return this.consumeOneOrMore(T,k,p)}consume(T,k,F){for(let se=0;se<F.length;se++){if(k+se>=T.length)throw new Error("consume exceeding value length");if(T[k+se]!==F[se])throw new Error("consume ".concat(F," failed at ").concat(se))}return k+F.length}consumeTill(T,k,F){let se=k;for(;se<T.length&&(typeof F!="string"||T[se]!==F)&&(typeof F!="function"||!F(T[se]));)se++;return se}}class ne extends Z{constructor(){super(),H(this,"records",[]),H(this,"currentLine",0)}parse(T){const k=this.probeEOL(T);this.records=T.split(k).filter((Ko=>!!ti(Ko).call(Ko))).map(this.parseLine),this.currentLine=0;const F=this.parseVersion(),se=this.parseOrigin(),ke=this.parseSessionName(),It=this.parseInformation(),vn=this.parseUri(),lr=this.parseEmail(),Ho=this.parsePhone(),Wm=this.parseConnection(),Ld=this.parseBandWidth(),Gm=this.parseTimeFields(),Qa=this.parseKey(),yu=this.parseSessionAttribute(),Za=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:F,origin:se,sessionName:ke,information:It,uri:vn,emails:lr,phones:Ho,connection:Wm,bandwidths:Ld,timeFields:Gm,key:Qa,attributes:yu,mediaDescriptions:Za}}getCurrentRecord(){const T=this.records[this.currentLine];if(!T)throw new Error("Record doesn't exit.");return T}probeEOL(T){for(let k=0;k<T.length;k++)if(T[k]===o)return T[k-1]==="\r"?a:o;throw new Error("Invalid newline character.")}parseLine(T,k){if(T.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const F=T[0];if(T[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:F,value:T.slice(2),line:k,cur:0}}parseSessionAttribute(){const T=new De;for(;this.currentLine<this.records.length;){const k=this.getCurrentRecord();if(k.type!==u.ATTRIBUTE)break;const F={attField:this.extractOneOrMore(k,(se=>g(se)&&se!==":")),_cur:0};k.value[k.cur]===":"&&(k.cur+=1,F.attValue=this.extractOneOrMore(k,O)),T.parse(F),this.currentLine++}return T.digest()}parseMediaAttributes(T){const k=new Oe(T);for(;this.currentLine<this.records.length;){const F=this.getCurrentRecord();if(F.type!==u.ATTRIBUTE)break;const se={attField:this.extractOneOrMore(F,(ke=>g(ke)&&ke!==":")),_cur:0};F.value[F.cur]===":"&&(F.cur+=1,se.attValue=this.extractOneOrMore(F,O)),k.parse(se),this.currentLine++}return k.digest()}parseKey(){const T=this.getCurrentRecord();if(T.type===u.KEY){if(T.value==="prompt"||T.value==="clear:"||T.value==="base64:"||T.value==="uri:")return T.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const T=this.getCurrentRecord();if(T.type===u.ZONE_ADJUSTMENTS){const k=[];for(;;)try{const F=this.extract(T,this.consumeTime);this.consumeSpaceForRecord(T);let se=!1;T.value[T.cur]==="-"&&(se=!0,T.cur+=1);const ke=this.extract(T,this.consumeTypedTime);k.push({time:F,typedTime:ke,back:se})}catch{break}if(k.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,k}return[]}parseRepeat(){const T=[];for(;;){const k=this.getCurrentRecord();if(k.type!==u.REPEAT)break;{const F=this.extract(k,this.consumeRepeatInterval),se=this.parseTypedTime(k);T.push({repeatInterval:F,typedTimes:se}),this.currentLine++}}return T}parseTypedTime(T){const k=[];for(;;)try{this.consumeSpaceForRecord(T),k.push(this.extract(T,this.consumeTypedTime))}catch{break}if(k.length===0)throw new Error("Invalid typed time.");return k}parseTime(){const T=this.getCurrentRecord(),k=this.extract(T,this.consumeTime);this.consumeSpaceForRecord(T);const F=this.extract(T,this.consumeTime);return this.currentLine++,{startTime:k,stopTime:F}}parseBandWidth(){const T=[];for(;this.currentLine<this.records.length;){const k=this.getCurrentRecord();if(k.type!==u.BANDWIDTH)break;{const F=this.extractOneOrMore(k,g);if(k.value[k.cur]!==":")throw new Error("Invalid bandwidth field.");k.cur++;const se=this.extractOneOrMore(k,p);T.push({bwtype:F,bandwidth:se}),this.currentLine++}}return T}parseVersion(){const T=this.getCurrentRecord();if(T.type!==u.VERSION)throw new Error("first sdp record must be version");const k=T.value.slice(0,this.consumeOneOrMore(T.value,0,p));if(k.length!==T.value.length)throw new Error('invalid proto version, "v='.concat(T.value,'"'));return this.currentLine++,k}parseOrigin(){const T=this.getCurrentRecord();if(T.type!==u.ORIGIN)throw new Error("second line of sdp must be origin");const k=this.extractOneOrMore(T,_);this.consumeSpaceForRecord(T);const F=this.extractOneOrMore(T,p);this.consumeSpaceForRecord(T);const se=this.extractOneOrMore(T,p);this.consumeSpaceForRecord(T);const ke=this.extractOneOrMore(T,g);this.consumeSpaceForRecord(T);const It=this.extractOneOrMore(T,g);this.consumeSpaceForRecord(T);const vn=this.extract(T,this.consumeUnicastAddress);return this.currentLine++,{username:k,sessId:F,sessVersion:se,nettype:ke,addrtype:It,unicastAddress:vn}}parseSessionName(){const T=this.getCurrentRecord();if(T.type===u.SESSION_NAME){const k=this.extract(T,this.consumeText);return this.currentLine++,k}}parseInformation(){const T=this.getCurrentRecord();if(T.type!==u.INFORMATION)return;const k=this.extract(T,this.consumeText);return this.currentLine++,k}parseUri(){const T=this.getCurrentRecord();if(T.type===u.URI)return this.currentLine++,T.value}parseEmail(){const T=[];for(;;){const k=this.getCurrentRecord();if(k.type!==u.EMAIL)break;T.push(k.value),this.currentLine++}return T}parsePhone(){const T=[];for(;;){const k=this.getCurrentRecord();if(k.type!==u.PHONE)break;T.push(k.value),this.currentLine++}return T}parseConnection(){const T=this.getCurrentRecord();if(T.type===u.CONNECTION){const k=this.extractOneOrMore(T,g);this.consumeSpaceForRecord(T);const F=this.extractOneOrMore(T,g);this.consumeSpaceForRecord(T);const se=this.extract(T,this.consumeAddress);return this.currentLine++,{nettype:k,addrtype:F,address:se}}}parseMedia(){const T=this.getCurrentRecord(),k=this.extract(T,this.consumeToken);this.consumeSpaceForRecord(T);let F=this.extract(T,this.consumePort);T.value[T.cur]==="/"&&(T.cur+=1,F+=this.extract(T,this.consumeInteger)),this.consumeSpaceForRecord(T);const se=[];for(se.push(this.extract(T,this.consumeToken));T.value[T.cur]==="/";)T.cur+=1,se.push(this.extract(T,this.consumeToken));if(se.length===0)throw new Error("Invalid proto");const ke=this.parseFmt(T);return this.currentLine++,{mediaType:k,port:F,protos:se,fmts:ke}}parseTimeFields(){const T=[];for(;this.getCurrentRecord().type===u.TIME;){const k=this.parseTime(),F=this.parseRepeat(),se=this.parseZone();T.push({time:k,repeats:F,zones:se})}return T}parseMediaDescription(){const T=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===u.MEDIA;){const k=this.parseMedia(),F=this.parseInformation(),se=this.parseConnections(),ke=this.parseBandWidth(),It=this.parseKey(),vn=this.parseMediaAttributes(k);T.push({media:k,information:F,connections:se,bandwidths:ke,key:It,attributes:vn})}return T}parseConnections(){const T=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===u.CONNECTION;)T.push(this.parseConnection());return T}parseFmt(T){const k=[];for(;;)try{this.consumeSpaceForRecord(T),k.push(this.extract(T,this.consumeToken))}catch{break}if(k.length===0)throw new Error("Invalid fmts");return k}extract(T,k){for(var F=arguments.length,se=new Array(F>2?F-2:0),ke=2;ke<F;ke++)se[ke-2]=arguments[ke];const It=k.call(this,T.value,T.cur,...se),vn=T.value.slice(T.cur,It);return T.cur=It,vn}extractOneOrMore(T,k){const F=this.consumeOneOrMore(T.value,T.cur,k),se=T.value.slice(T.cur,F);return T.cur=F,se}consumeSpaceForRecord(T){if(T.value[T.cur]!==c)throw new Error("Invalid space at ".concat(T.cur,"."));T.cur+=1}}class he extends Z{constructor(){super(...arguments),H(this,"attributes",void 0),H(this,"digested",!1)}extractOneOrMore(T,k,F){const se=this.consumeOneOrMore(T.attValue,T._cur,k),ke=T.attValue.slice(T._cur,se),[It,vn]=F||[];if(typeof It=="number"&&ke.length<It)throw new Error("error in length, should be more or equal than ".concat(It," characters."));if(typeof vn=="number"&&ke.length>vn)throw new Error("error in length, should be less or equal than ".concat(vn," characters."));return T._cur=se,ke}consumeAttributeSpace(T){if(T.attValue[T._cur]!==c)throw new Error("Invalid space at ".concat(T._cur,"."));T._cur+=1}extract(T,k){if(!T.attValue)throw new Error("Nothing to extract from attValue.");for(var F=arguments.length,se=new Array(F>2?F-2:0),ke=2;ke<F;ke++)se[ke-2]=arguments[ke];const It=k.call(this,T.attValue,T._cur,...se),vn=T.attValue.slice(T._cur,It);return T._cur=It,vn}atEnd(T){if(!T.attValue)throw new Error;return T._cur>=T.attValue.length}peekChar(T){if(!T.attValue)throw new Error;return T.attValue[T._cur]}peek(T,k){if(!T.attValue)throw new Error;for(let F=0;F<k.length;F++)if(k[F]!==T.attValue[T._cur+F])return!1;return!0}parseIceUfrag(T){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(T,D,[4,256])}parseIcePwd(T){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(T,D,[22,256])}parseIceOptions(T){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const k=[];for(;!this.atEnd(T);){k.push(this.extractOneOrMore(T,D));try{this.consumeAttributeSpace(T)}catch(F){if(this.atEnd(T))break;throw F}}this.attributes.iceOptions=k}parseFingerprint(T){const k=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T);const F=this.extract(T,this.consumeTill);this.attributes.fingerprints.push({hashFunction:k,fingerprint:F})}parseExtmap(T){const k=this.extractOneOrMore(T,p);let F;this.peekChar(T)==="/"&&(this.extract(T,this.consume,"/"),F=this.extract(T,this.consumeToken)),this.consumeAttributeSpace(T);const se=this.extract(T,this.consumeTill,c),ke=j(j({entry:parseInt(k,10)},F&&{direction:F}),{},{extensionName:se});this.peekChar(T)===c&&(this.consumeAttributeSpace(T),ke.extensionAttributes=this.extract(T,this.consumeTill)),this.attributes.extmaps.push(ke)}parseSetup(T){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const k=this.extract(T,this.consumeTill);if(k!=="active"&&k!=="passive"&&k!=="actpass"&&k!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=k}}class De extends he{constructor(){super(...arguments),H(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(T){if(this.digested)throw new Error("already digested");try{switch(T.attField){case"group":this.parseGroup(T);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(T);break;case"ice-pwd":this.parseIcePwd(T);break;case"ice-options":this.parseIceOptions(T);break;case"fingerprint":this.parseFingerprint(T);break;case"setup":this.parseSetup(T);break;case"tls-id":this.parseTlsId(T);break;case"identity":this.parseIdentity(T);break;case"extmap":this.parseExtmap(T);break;case"msid-semantic":this.parseMsidSemantic(T);break;default:T.ignored=!0,this.attributes.unrecognized.push(T)}}catch(k){throw console.error("parsing session attribute ".concat(T.attField,' error, "a=').concat(T.attField,":").concat(T.attValue,'"')),k}if(!T.ignored&&T.attValue&&!this.atEnd(T))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(T){const k=this.extract(T,this.consumeToken),F=[];for(;!this.atEnd(T)&&this.peekChar(T)===c;)this.consumeAttributeSpace(T),F.push(this.extract(T,this.consumeToken));this.attributes.groups.push({semantic:k,identificationTag:F})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(T){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(T,x)}parseIdentity(T){const k=this.extractOneOrMore(T,B),F=[];for(;!this.atEnd(T)&&this.peekChar(T)===c;){this.consumeAttributeSpace(T);const se=this.extract(T,this.consumeToken);this.extract(T,this.consume,"=");const ke=this.extractOneOrMore(T,(It=>It!==c&&O(It)));F.push({name:se,value:ke})}this.attributes.identities.push({assertionValue:k,extensions:F})}parseMsidSemantic(T){this.peekChar(T)===c&&this.consumeAttributeSpace(T);const k={semantic:this.extract(T,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(T)}catch{break}if(this.peekChar(T)==="*"){this.extract(T,this.consume,"*"),k.applyForAll=!0;break}{const F=this.extract(T,this.consumeTill,c);k.identifierList.push(F)}}this.attributes.msidSemantic=k}}class Oe extends he{constructor(T){super(),H(this,"attributes",void 0),T.protos.indexOf("RTP")!==-1||T.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(T){if(this.digested)throw new Error("already digested");try{switch(T.attField){case"extmap":this.parseExtmap(T);break;case"setup":this.parseSetup(T);break;case"ice-ufrag":this.parseIceUfrag(T);break;case"ice-pwd":this.parseIcePwd(T);break;case"ice-options":this.parseIceOptions(T);break;case"candidate":this.parseCandidate(T);break;case"remote-candidate":this.parseRemoteCandidate(T);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(T);break;case"rtpmap":this.parseRtpmap(T);break;case"ptime":this.parsePtime(T);break;case"maxptime":this.parseMaxPtime(T);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(T);break;case"ssrc":this.parseSSRC(T);break;case"fmtp":this.parseFmtp(T);break;case"rtcp-fb":this.parseRtcpFb(T);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(T);break;case"mid":this.parseMid(T);break;case"msid":this.parseMsid(T);break;case"imageattr":this.parseImageAttr(T);break;case"rid":this.parseRid(T);break;case"simulcast":this.parseSimulcast(T);break;case"sctp-port":this.parseSctpPort(T);break;case"max-message-size":this.parseMaxMessageSize(T);break;case"ssrc-group":this.parseSSRCGroup(T);break;default:T.ignored=!0,this.attributes.unrecognized.push(T)}}catch(k){throw console.error("parsing media attribute ".concat(T.attField,' error, "a=').concat(T.attField,":").concat(T.attValue,'"')),k}if(!T.ignored&&T.attValue&&!this.atEnd(T))throw new Error("attribute parsing error")}parseCandidate(T){const k=this.extractOneOrMore(T,D,[1,32]);this.consumeAttributeSpace(T);const F=this.extractOneOrMore(T,p,[1,5]);this.consumeAttributeSpace(T);const se=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T);const ke=this.extractOneOrMore(T,p,[1,10]);this.consumeAttributeSpace(T);const It=this.extract(T,this.consumeAddress);this.consumeAttributeSpace(T);const vn=this.extract(T,this.consumePort);this.consumeAttributeSpace(T),this.extract(T,this.consume,"typ"),this.consumeAttributeSpace(T);const lr={foundation:k,componentId:F,transport:se,priority:ke,connectionAddress:It,port:vn,type:this.extract(T,this.consumeToken),extension:{}};for(this.peek(T," raddr")&&(this.extract(T,this.consume," raddr"),this.consumeAttributeSpace(T),lr.relAddr=this.extract(T,this.consumeAddress)),this.peek(T," rport")&&(this.extract(T,this.consume," rport"),this.consumeAttributeSpace(T),lr.relPort=this.extract(T,this.consumePort));this.peekChar(T)===c;){this.consumeAttributeSpace(T);const Ho=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T),lr.extension[Ho]=this.extractOneOrMore(T,m)}this.attributes.candidates.push(lr)}parseRemoteCandidate(T){const k=[];for(;;){const F=this.extractOneOrMore(T,p,[1,5]);this.consumeAttributeSpace(T);const se=this.extract(T,this.consumeAddress);this.consumeAttributeSpace(T);const ke=this.extract(T,this.consumePort);k.push({componentId:F,connectionAddress:se,port:ke});try{this.consumeAttributeSpace(T)}catch{break}}this.attributes.remoteCandidatesList.push(k)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(T){const k=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T);const F=this.extract(T,this.consumeTill,"/");this.extract(T,this.consume,"/");const se={encodingName:F,clockRate:this.extractOneOrMore(T,p)};this.atEnd(T)||this.peekChar(T)!=="/"||(this.extract(T,this.consume,"/"),se.encodingParameters=parseInt(this.extract(T,this.consumeTill),10));const ke=this.attributes.payloads.find((It=>It.payloadType===parseInt(k,10)));ke?ke.rtpMap=se:this.attributes.payloads.push({payloadType:parseInt(k,10),rtpMap:se,rtcpFeedbacks:[]})}parsePtime(T){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(T,this.consumeTill)}parseMaxPtime(T){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(T,this.consumeTill)}parseDirection(T){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=T.attField}parseSSRC(T){const k=this.extractOneOrMore(T,p);this.consumeAttributeSpace(T);const F=this.extract(T,this.consumeTill,":");let se;this.peekChar(T)===":"&&(this.extract(T,this.consume,":"),se=this.extract(T,this.consumeTill));const ke=this.attributes.ssrcs.find((It=>It.ssrcId===parseInt(k,10)));ke?ke.attributes[F]=se:this.attributes.ssrcs.push({ssrcId:parseInt(k,10),attributes:{[F]:se}})}parseFmtp(T){const k=this.extract(T,this.consumeTill,c);this.consumeAttributeSpace(T);const F=this.extract(T,this.consumeTill),se={};F.split(";").forEach((It=>{let[vn,lr]=It.split("=");vn=ti(vn).call(vn);const Ho=typeof lr=="string"?ti(lr).call(lr):null;typeof vn=="string"&&vn.length>0&&(se[vn]=Ho)}));const ke=this.attributes.payloads.find((It=>It.payloadType===parseInt(k,10)));ke?ke.fmtp={parameters:se}:this.attributes.payloads.push({payloadType:parseInt(k,10),rtcpFeedbacks:[],fmtp:{parameters:se}})}parseFmtParameters(T){const k={},F=this.extract(T,this.consumeTill,"=");T._cur++;const se=this.extract(T,this.consumeTill,";");for(k[F]=se;T.attValue[T._cur]===";";){const ke=this.extract(T,this.consumeTill,"=");T._cur++;const It=this.extract(T,this.consumeTill,";");k[ke]=It}return k}parseRtcpFb(T){let k="";k=this.peekChar(T)==="*"?this.extract(T,this.consume,"*"):this.extract(T,this.consumeTill,c),this.consumeAttributeSpace(T);const F=this.extract(T,this.consumeTill,c);let se;if(F==="trr-int")se={type:F,interval:this.extract(T,this.consumeTill)};else{const ke={type:F};this.peekChar(T)===c&&(this.consumeAttributeSpace(T),ke.parameter=this.extract(T,this.consumeToken),this.peekChar(T)===c&&(ke.additional=this.extract(T,this.consumeTill))),se=ke}if(k==="*")this.attributes.rtcpFeedbackWildcards.push(se);else{const ke=this.attributes.payloads.find((It=>It.payloadType===parseInt(k,10)));ke?ke.rtcpFeedbacks.push(se):this.attributes.payloads.push({payloadType:parseInt(k,10),rtcpFeedbacks:[se]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(T){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const k={port:this.extract(T,this.consumePort)};this.peekChar(T)===c&&(this.consumeAttributeSpace(T),k.netType=this.extractOneOrMore(T,g),this.consumeAttributeSpace(T),k.addressType=this.extractOneOrMore(T,g),this.consumeAttributeSpace(T),k.address=this.extract(T,this.consumeAddress)),this.attributes.rtcp=k}parseMsid(T){const k={id:this.extractOneOrMore(T,g,[1,64])};this.peekChar(T)===c&&(this.consumeAttributeSpace(T),k.appdata=this.extractOneOrMore(T,g,[1,64])),this.attributes.msids.push(k)}parseImageAttr(T){this.attributes.imageattr.push(T.attValue)}parseRid(T){const k=this.extractOneOrMore(T,(se=>v(se)||p(se)||se==="_"||se==="-"));this.consumeAttributeSpace(T);const F={id:k,direction:this.extract(T,this.consumeToken),params:[]};if(this.peekChar(T)===c){if(this.consumeAttributeSpace(T),this.peek(T,"pt=")){this.extract(T,this.consume,"pt=");const se=[];for(;;){const ke=this.extract(T,this.consumeToken);se.push(ke);try{this.extract(T,this.consume,",")}catch{break}}F.payloads=se,this.peekChar(T)===c&&this.extract(T,this.consume,c)}for(;;){const se=this.extract(T,this.consumeToken);if(se==="depend"){const ke={type:se,rids:this.extract(T,this.consume,"=").split(",")};F.params.push(ke)}else{const ke={type:se};this.peekChar(T)==="="&&(this.extract(T,this.consume,"="),ke.val=this.extract(T,this.consumeTill,";")),F.params.push(ke)}try{this.extract(T,this.consume,";")}catch{break}}}this.attributes.rids.push(F)}parseSimulcast(T){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=T.attValue,this.extract(T,this.consumeTill)}parseSctpPort(T){this.attributes.sctpPort=this.extractOneOrMore(T,p,[1,5])}parseMaxMessageSize(T){this.attributes.maxMessageSize=this.extractOneOrMore(T,p,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(T){this.attributes.mid=this.extract(T,this.consumeToken)}parseSSRCGroup(T){const k=this.extract(T,this.consumeToken),F=[];for(;;)try{this.consumeAttributeSpace(T);const se=this.extract(T,this.consumeInteger);F.push(parseInt(se,10))}catch{break}this.attributes.ssrcGroups.push({semantic:k,ssrcIds:F})}}function Ge(te,T,k){return T in te?Object.defineProperty(te,T,{value:k,enumerable:!0,configurable:!0,writable:!0}):te[T]=k,te}class Ue{constructor(){Ge(this,"eol",a)}print(T,k){let F="";return k&&(this.eol=k),F+=this.printVersion(T.version),F+=this.printOrigin(T.origin),F+=this.printSessionName(T.sessionName),F+=this.printInformation(T.information),F+=this.printUri(T.uri),F+=this.printEmail(T.emails),F+=this.printPhone(T.phones),F+=this.printConnection(T.connection),F+=this.printBandwidth(T.bandwidths),F+=this.printTimeFields(T.timeFields),F+=this.printKey(T.key),F+=this.printSessionAttributes(T.attributes),F+=this.printMediaDescription(T.mediaDescriptions),F}printVersion(T){return"v=".concat(T).concat(this.eol)}printOrigin(T){return"o=".concat(T.username," ").concat(T.sessId," ").concat(T.sessVersion," ").concat(T.nettype," ").concat(T.addrtype," ").concat(T.unicastAddress).concat(this.eol)}printSessionName(T){return T?"s=".concat(T).concat(this.eol):""}printInformation(T){return T?"i=".concat(T).concat(this.eol):""}printUri(T){return T?"u=".concat(T).concat(this.eol):""}printEmail(T){let k="";for(const F of T)k+="e=".concat(F).concat(this.eol);return k}printPhone(T){let k="";for(const F of T)k+="e=".concat(F).concat(this.eol);return k}printConnection(T){return T?"c=".concat(T.nettype," ").concat(T.addrtype," ").concat(T.address).concat(this.eol):""}printBandwidth(T){let k="";for(const F of T)k+="b=".concat(F.bwtype,":").concat(F.bandwidth).concat(this.eol);return k}printTimeFields(T){let k="";for(const F of T){k+="t=".concat(F.time.startTime," ").concat(F.time.startTime).concat(this.eol);for(const se of F.repeats)k+="r=".concat(se.repeatInterval," ").concat(se.typedTimes.join(" ")).concat(this.eol);F.zoneAdjustments&&(k+="z=",k+="z=".concat(F.zoneAdjustments.map((se=>"".concat(se.time," ").concat(se.back?"-":""," ").concat(se.typedTime))).join(" ")).concat(this.eol),k+=this.eol)}return k}printKey(T){return T?"k=".concat(T).concat(this.eol):""}printAttributes(T){let k="";for(const F of T)k+="a=".concat(F.attField).concat(F.attValue?":".concat(F.attValue):"").concat(this.eol);return k}printMediaDescription(T){let k="";for(const F of T)k+=this.printMedia(F.media),k+=this.printInformation(F.information),k+=this.printConnections(F.connections),k+=this.printBandwidth(F.bandwidths),k+=this.printKey(F.key),k+=this.printMediaAttributes(F);return k}printConnections(T){let k="";for(const F of T)k+=this.printConnection(F);return k}printMedia(T){return"m=".concat(T.mediaType," ").concat(T.port," ").concat(T.protos.join("/")," ").concat(T.fmts.join(" ")).concat(this.eol)}printSessionAttributes(T){return new Ut(this.eol).print(T)}printMediaAttributes(T){return new ee(this.eol).print(T)}}class ct{constructor(T){Ge(this,"eol",void 0),this.eol=T}printIceUfrag(T){return T===void 0?"":"a=ice-ufrag:".concat(T).concat(this.eol)}printIcePwd(T){return T===void 0?"":"a=ice-pwd:".concat(T).concat(this.eol)}printIceOptions(T){return T===void 0?"":"a=ice-options:".concat(T.join(c)).concat(this.eol)}printFingerprints(T){return T.length>0?T.map((k=>"a=fingerprint:".concat(k.hashFunction).concat(c).concat(k.fingerprint))).join(this.eol)+this.eol:""}printExtmap(T){return T.map((k=>"a=extmap:".concat(k.entry).concat(k.direction?"/".concat(k.direction):"").concat(c).concat(k.extensionName).concat(k.extensionAttributes?"".concat(c).concat(k.extensionAttributes):"").concat(this.eol))).join("")}printSetup(T){return T===void 0?"":"a=setup:".concat(T).concat(this.eol)}printUnrecognized(T){return T.map((k=>"a=".concat(k.attField).concat(k.attValue?":".concat(k.attValue):"").concat(this.eol))).join("")}}class Ut extends ct{print(T){let k="";return k+=this.printGroups(T.groups),k+=this.printMsidSemantic(T.msidSemantic),k+=this.printIceLite(T.iceLite),k+=this.printIceUfrag(T.iceUfrag),k+=this.printIcePwd(T.icePwd),k+=this.printIceOptions(T.iceOptions),k+=this.printFingerprints(T.fingerprints),k+=this.printSetup(T.setup),k+=this.printTlsId(T.tlsId),k+=this.printIdentity(T.identities),k+=this.printExtmap(T.extmaps),k+=this.printUnrecognized(T.unrecognized),k}printGroups(T){let k="";return T.length>0&&(k+=T.map((F=>"a=group:".concat(F.semantic).concat(F.identificationTag.map((se=>"".concat(c).concat(se))).join("")).concat(this.eol))).join("")),k}printIceLite(T){return T===void 0?"":"a=ice-lite"+this.eol}printTlsId(T){return T?"a=tls-id:".concat(T).concat(this.eol):""}printIdentity(T){return T.length===0?"":T.map((k=>"a=identity:".concat(k.assertionValue).concat(k.extensions.map((F=>"".concat(c).concat(F.name).concat(F.value?"=".concat(F.value):"")))))).join(this.eol)+this.eol}printMsidSemantic(T){if(!T)return"";let k="a=msid-semantic:".concat(T.semantic);return T.applyForAll?k+="".concat(c,"*"):T.identifierList.length>0&&(k+=T.identifierList.map((F=>"".concat(c).concat(F)))),k+this.eol}}class ee extends ct{print(T){const k=T.attributes;let F="";return F+=this.printRTCP(k.rtcp),F+=this.printIceUfrag(k.iceUfrag),F+=this.printIcePwd(k.icePwd),F+=this.printIceOptions(k.iceOptions),F+=this.printCandidates(k.candidates),F+=this.printRemoteCandidatesList(k.remoteCandidatesList),F+=this.printEndOfCandidates(k.endOfCandidates),F+=this.printFingerprints(k.fingerprints),F+=this.printSetup(k.setup),F+=this.printMid(k.mid),F+=this.printExtmap(k.extmaps),F+=this.printRTPRelated(k),F+=this.printPtime(k.ptime),F+=this.printMaxPtime(k.maxPtime),F+=this.printDirection(k.direction),F+=this.printSSRCGroups(k.ssrcGroups),F+=this.printSSRC(k.ssrcs),F+=this.printRTCPMux(k.rtcpMux),F+=this.printRTCPMuxOnly(k.rtcpMuxOnly),F+=this.printRTCPRsize(k.rtcpRsize),F+=this.printMSId(k.msids),F+=this.printImageattr(k.imageattr),F+=this.printRid(k.rids),F+=this.printSimulcast(k.simulcast),F+=this.printSCTPPort(k.sctpPort),F+=this.printMaxMessageSize(k.maxMessageSize),F+=this.printUnrecognized(k.unrecognized),F}printCandidates(T){return T.map((k=>"a=candidate:".concat(k.foundation).concat(c).concat(k.componentId).concat(c).concat(k.transport).concat(c).concat(k.priority).concat(c).concat(k.connectionAddress).concat(c).concat(k.port).concat(c,"typ").concat(c).concat(k.type).concat(k.relAddr?"".concat(c,"raddr").concat(c).concat(k.relAddr):"").concat(k.relPort?"".concat(c,"rport").concat(c).concat(k.relPort):"").concat(Object.keys(k.extension).map((F=>"".concat(c).concat(F).concat(c).concat(k.extension[F]))).join("")).concat(this.eol))).join("")}printRemoteCandidatesList(T){return T.map((k=>"a=remote-candidates:".concat(k.join(c)).concat(this.eol))).join("")}printEndOfCandidates(T){return T===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(T){if(!T.payloads)return"";const k=T.payloads;let F="";F+=T.rtcpFeedbackWildcards.map((se=>this.printRTCPFeedback("*",se))).join("");for(const se of k)F+=this.printRtpMap(se.payloadType,se.rtpMap),F+=this.printFmtp(se.payloadType,se.fmtp),F+=se.rtcpFeedbacks.map((ke=>this.printRTCPFeedback(se.payloadType,ke))).join("");return F}printFmtp(T,k){if(!k)return"";const F=Object.keys(k.parameters);return F.length===1&&k.parameters[F[0]]===null?"a=fmtp:".concat(T).concat(c).concat(F[0]).concat(this.eol):"a=fmtp:".concat(T).concat(c).concat(Object.keys(k.parameters).map((se=>"".concat(se,"=").concat(k.parameters[se]))).join(";")).concat(this.eol)}printRtpMap(T,k){return k?"a=rtpmap:".concat(T).concat(c).concat(k.encodingName,"/").concat(k.clockRate).concat(k.encodingParameters?"/".concat(k.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(T,k){let F="a=rtcp-fb:".concat(T).concat(c),se=k;return se.type==="trr-int"?F+="ttr-int".concat(c).concat(se.interval):(F+="".concat(se.type),se.parameter&&(F+="".concat(c).concat(se.parameter),se.additional&&(F+="".concat(c).concat(se.additional)))),F+this.eol}printPtime(T){return T===void 0?"":"a=ptime:".concat(T).concat(this.eol)}printMaxPtime(T){return T===void 0?"":"a=maxptime:".concat(T).concat(this.eol)}printDirection(T){return T===void 0?"":"a=".concat(T).concat(this.eol)}printSSRC(T){return T.map((k=>Object.keys(k.attributes).map((F=>"a=ssrc:".concat(k.ssrcId.toString(10)).concat(c).concat(F).concat(k.attributes[F]?":".concat(k.attributes[F]):"").concat(this.eol))).join(""))).join("")}printRTCPMux(T){return T===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(T){return T===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(T){return T===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(T){if(T===void 0)return"";let k="a=rtcp:".concat(T.port);return T.netType&&(k+="".concat(c).concat(T.netType)),T.addressType&&(k+="".concat(c).concat(T.addressType)),T.address&&(k+="".concat(c).concat(T.address)),k+this.eol}printMSId(T){return T.map((k=>"a=msid:".concat(k.id).concat(k.appdata?"".concat(c).concat(k.appdata):"").concat(this.eol))).join("")}printImageattr(T){return T.map((k=>"a=imageattr:".concat(k).concat(this.eol))).join("")}printRid(T){return T.map((k=>{let F="a=rid:".concat(k.id).concat(c).concat(k.direction);return k.payloads&&(F+="".concat(c,"pt=").concat(k.payloads.join(","))),k.params.length>0&&(F+="".concat(c).concat(k.params.map((se=>se.type==="depend"?"depend=".concat(se.rids.join(",")):"".concat(se.type,"=").concat(se.val))).join(";"))),F+this.eol})).join("")}printSimulcast(T){return T===void 0?"":"a=simulcast:".concat(T).concat(this.eol)}printSCTPPort(T){return T===void 0?"":"a=sctp-port:".concat(T).concat(this.eol)}printMaxMessageSize(T){return T===void 0?"":"a=max-message-size:".concat(T).concat(this.eol)}printMid(T){return T===void 0?"":"a=mid:".concat(T).concat(this.eol)}printSSRCGroups(T){return T.map((k=>"a=ssrc-group:".concat(k.semantic).concat(k.ssrcIds.map((F=>"".concat(c).concat(F.toString(10)))).join("")).concat(this.eol))).join("")}}function ce(te){return new ne().parse(te)}function ge(te,T){return new Ue().print(te,T)}}},t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{}};return e[i](r,r.exports,n),r.exports}return n.d=(i,r)=>{for(var s in r)n.o(r,s)&&!n.o(i,s)&&Object.defineProperty(i,s,{enumerable:!0,get:r[s]})},n.o=(i,r)=>Object.prototype.hasOwnProperty.call(i,r),n.r=i=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},n(8)})();function ri(e){return NO.parse(e)}function Qs(e,t){return NO.print(e,t)}var WY=Zi("Array","keys"),GY=_o,HY=Hn,KY=W,YY=WY,pS=Array.prototype,zY={DOMTokenList:!0,NodeList:!0},qY=function(e){var t=e.keys;return e===pS||KY(pS,e)&&t===pS.keys||HY(zY,GY(e))?YY:t},zn=y(qY);function Ht(e,t,n){return(t=(function(i){var r=(function(s,o){if(typeof s!="object"||!s)return s;var a=s[Symbol.toPrimitive];if(a!==void 0){var c=a.call(s,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)})(i);return typeof r=="symbol"?r:r+""})(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function DO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Fe(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?DO(Object(n),!0).forEach((function(i){Ht(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):DO(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function Ap(e,t){return Ap=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,i){return n.__proto__=i,n},Ap(e,t)}function mS(){mS=function(r,s){return new n(r,void 0,s)};var e=RegExp.prototype,t=new WeakMap;function n(r,s,o){var a=RegExp(r,s);return t.set(a,o||t.get(r)),Ap(a,n.prototype)}function i(r,s){var o,a=t.get(s);return $i(o=Object.keys(a)).call(o,(function(c,u){var p=a[u];if(typeof p=="number")c[u]=r[p];else{for(var m=0;r[p[m]]===void 0&&m+1<p.length;)m++;c[u]=r[p[m]]}return c}),Object.create(null))}return(function(r,s){if(typeof s!="function"&&s!==null)throw new TypeError("Super expression must either be null or a function");r.prototype=Object.create(s&&s.prototype,{constructor:{value:r,writable:!0,configurable:!0}}),Object.defineProperty(r,"prototype",{writable:!1}),s&&Ap(r,s)})(n,RegExp),n.prototype.exec=function(r){var s=e.exec.call(this,r);if(s){s.groups=i(s,this);var o=s.indices;o&&(o.groups=i(o,this))}return s},n.prototype[Symbol.replace]=function(r,s){if(typeof s=="string"){var o=t.get(this);return e[Symbol.replace].call(this,r,s.replace(/\$<([^>]+)(>|$)/g,(function(c,u,p){if(p==="")return c;var m=o[u];return Array.isArray(m)?"$"+m.join("$"):typeof m=="number"?"$"+m:""})))}if(typeof s=="function"){var a=this;return e[Symbol.replace].call(this,r,(function(){var c=arguments;return typeof c[c.length-1]!="object"&&(c=[].slice.call(c)).push(i(c,a)),s.apply(this,c)}))}return e[Symbol.replace].call(this,r,s)},mS.apply(this,arguments)}const PO=new class extends Vt{constructor(){super(...arguments),Ht(this,"currentUploadLogID",0)}reportLogUploadError(e){const{errorRange:t}=e;t[t.length-1]&&t[t.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=t[t.length-1],this.emit("REPORT_LOG_UPLOAD",e))}};class XY{constructor(t){Ht(this,"logger",void 0),Ht(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.debug(...this.prefixLists,...n)}info(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.info(...this.prefixLists,...n)}warning(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.warning(...this.prefixLists,...n)}error(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.error(...this.prefixLists,...n)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function fS(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function LO(){const e=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?t?.[0]+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const nr={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},Ip=Date.now(),Ul=e=>{for(const t in nr)if(Object.prototype.hasOwnProperty.call(nr,t)&&nr[t]===e)return t;return"DEFAULT"},S=new class{constructor(){Ht(this,"proxyServerURL",void 0),Ht(this,"logLevel",nr.DEBUG),Ht(this,"uploadState","collecting"),Ht(this,"uploadLogWaitingList",[]),Ht(this,"uploadLogUploadingList",[]),Ht(this,"uploadErrorCount",0),Ht(this,"currentLogID",0),Ht(this,"url",void 0),Ht(this,"extLog",((e,t)=>{this.appendLogToWaitingList(e,...t)}))}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[nr.DEBUG].concat(t);this.log.apply(this,i)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[nr.INFO].concat(t);this.log.apply(this,i)}warning(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[nr.WARNING].concat(t);this.log.apply(this,i)}warn(){this.warning(...arguments)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[nr.ERROR].concat(t);this.log.apply(this,i)}upload(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=[nr.DEBUG].concat(t);this.uploadLog.apply(this,i)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){St("UPLOAD_LOG",!0)}disableLogUpload(){St("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new XY(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-Ip<100)return void setTimeout((()=>{this.log(...t)}),Date.now()-Ip);const i=Math.max(0,Math.min(4,t[0]));if(t[0]=fS()+" Agora-SDK [".concat(Ul(i),"]:"),this.appendLogToWaitingList(i,...t),i<this.logLevel)return;const r=fS()+" %cAgora-SDK [".concat(Ul(i),"]:");let s=[];if(!I("USE_NEW_LOG"))switch(i){case nr.DEBUG:s=[r,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,s);break;case nr.INFO:s=[r,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,s);break;case nr.WARNING:s=[r,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,s);break;case nr.ERROR:s=[r,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,s)}}uploadLog(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-Ip<100)return void setTimeout((()=>{this.uploadLog(...t)}),Date.now()-Ip);const i=Math.max(0,Math.min(4,t[0]));t[0]=fS()+" Agora-SDK [".concat(Ul(i),"]:"),this.appendLogToWaitingList(i,...t)}appendLogToWaitingList(e){if(!I("UPLOAD_LOG"))return;for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];Array.isArray(n[0])?n[0][0]=LO()+" Agora-SDK [".concat(Ul(e),"]:"):n[0]=LO()+" Agora-SDK [".concat(Ul(e),"]:");let r="";n.forEach((s=>{typeof s=="object"&&(s=JSON.stringify(s)),r+="".concat(s," ")})),this.uploadLogWaitingList.push({payload_str:r,log_level:e,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const e=this.uploadLogUploadingList,t={sdk_version:tr,process_id:I("PROCESS_ID"),payload:JSON.stringify(e)};return zr((async()=>{const n=await ui.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(I("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(I("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if(n.data!=="OK"){const i=new Error("unexpected upload log response");throw i.response=n,i}}),(()=>(this.uploadLogUploadingList=[],!1)),(n=>{const i={status:-1,message:n.message,errorRange:e.map((r=>r.log_item_id))};return n.response?(i.status=n.response.status,i.data=n.response.data,i.headers=n.response.headers):n.request&&(i.status=n.request.status),PO.reportLogUploadError(i),!0}),{timeout:I("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:I("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,I("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then((()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout((()=>this.uploadLogInterval()),I("UPLOAD_LOG_INTERVAL"))})).catch((e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout((()=>this.uploadLogInterval()),I("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout((()=>this.uploadLogInterval()),I("UPLOAD_LOG_RETRY_INTERVAL_V1"))})))}};var kO;function JY(e){return Nn(e.reportId,"params.reportId",0,100,!1),Nn(e.category,"params.category",0,100,!1),Nn(e.event,"params.event",0,100,!1),Nn(e.label,"params.label",0,100,!1),Rt(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(kO={}).FREE="free",kO.UPLOADING="uploading",(function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"})({});const QY={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let cn=(function(e){return e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.RTE_DETAIL="rte_detail_stats",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.XLA_PEER_FIRST_VIDEO_FRAME="xla_peer_first_video_frame",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",e.AB_TEST="ab_test",e})({}),Mt=(function(e){return e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.RTE_DETAIL="io.agora.pb.Wrtc.RteDetailStats",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.XLA_PEER_FIRST_VIDEO_FRAME="io.agora.pb.Wrtc.XLAPeerFirstVideoFrame",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",e.AB_TEST="io.agora.pb.Wrtc.ABTest",e})({});(function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let ZY=(function(e){return e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",e})({});function Ae(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,n,i){const r=i.value;if(typeof r=="function"){const s=e.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);i.value=function(){for(var o,a=arguments.length,c=new Array(a),u=0;u<a;u++)c[u]=arguments[u];let p=c;if(e.argsMap)try{p=e.argsMap(this,...c)}catch(_){S.warning(_),p=[]}try{JSON.stringify(p)}catch{S.warning("arguments for method ".concat(s,".").concat(String(n)," not serializable for apiInvoke.")),p=[]}const m=(e.report||Se).reportApiInvoke(this._sessionId||null,{id:this._clientId||((o=this.store)===null||o===void 0?void 0:o.clientId)||this._ID,name:"".concat(s,".").concat(String(n)),options:p,tag:Ct.TRACER,reportResult:e.reportResult},e.throttleTime);try{const _=r.apply(this,c);return _ instanceof de?_.then((g=>(m.onSuccess(e.reportResult&&g),g))).catch((g=>{throw m.onError(g),g})):(m.onSuccess(e.reportResult&&_),_)}catch(_){throw m.onError(_),_}}}return i}}const Se=new class{constructor(){Ht(this,"baseInfoMap",new Map),Ht(this,"proxyServer",void 0),Ht(this,"eventUploadTimer",void 0),Ht(this,"setSessionIdTimer",void 0),Ht(this,"url",void 0),Ht(this,"sids",new Set),Ht(this,"backupUrl",void 0),Ht(this,"_appId",void 0),Ht(this,"_aid",0),Ht(this,"keyEventUploadPendingItems",[]),Ht(this,"normalEventUploadPendingItems",[]),Ht(this,"apiInvokeUploadPendingItems",[]),Ht(this,"apiInvokeCount",0),Ht(this,"apiInvokeLoggedCount",0),Ht(this,"ltsList",[]),Ht(this,"lastSendNormalEventTime",Date.now()),Ht(this,"customReportCounterTimer",void 0),Ht(this,"customReportCount",0),Ht(this,"extApiInvoke",(async e=>{for(const t of e){const n=Fe(Fe({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Ct.TRACER});this.sendApiInvoke(n)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),I("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),I("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}setAppId(e){this._appId=e,this._aid=parseInt(e.replace(/[a-fA-F0-9]{8}/g,(t=>{let[n,i]=t;return n+i})),16)||0}reportApiInvoke(e,t,n){t.timeout=t.timeout||6e4,t.reportResult=t.reportResult===void 0||t.reportResult;const i=Date.now();this.apiInvokeCount+=1;const r=this.apiInvokeCount,s=!!I("SHOW_REPORT_INVOKER_LOG"),o=!!I("SHOW_REPORT_USER_INVOKER_LOG"),a=s||o&&t.id;a&&(this.apiInvokeLoggedCount+=1);const c=this.apiInvokeLoggedCount;function u(g,b){if(a){let v="[apiInvoke-".concat(c,"]");if(t.id&&(v+="[".concat(t.id,"]")),t.name&&(v+="[".concat(t.name,"]"),t.name===xt.JOIN))return S.info("".concat(v," ").concat(g));S.info("".concat(v," ").concat(g),g==="start"?t.options:b||"")}}const p=()=>({tag:t.tag,invokeId:r,sid:e,name:t.name,apiInvokeTime:i,options:t.options,states:t.states||null});u("start");let m=!1;En(t.timeout).then((()=>{m||(this.sendApiInvoke(Fe(Fe({},p()),{},{error:N.API_INVOKE_TIMEOUT,success:!1})),u("timeout"))}));const _=new J(N.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:g=>{const b=()=>{if(m)throw _;return m=!0,this.sendApiInvoke(Fe(Fe({},p()),{},{success:!0},t.reportResult&&{result:g})),u("onSuccess"),g};return n?mO(b,t.name+"Success",n,(()=>m=!0)):b()},onError:g=>{const b=()=>{if(m)throw g;m=!0,this.sendApiInvoke(Fe(Fe({},p()),{},{success:!1,error:g})),u("onFailure",g.toString())};return n?mO(b,t.name+"Error",n,(()=>m=!0)):b()}}}_send(e,t,n){this.send({type:e,data:t},n)}_sendApiInvoke(e){return this.sendApiInvoke(e)}sessionInit(e,t){if(this.baseInfoMap.has(e))return;const n=Date.now(),i=this.createBaseInfo(e,n);i.cname=t.cname,i.rteUrl=t.rteUrl;const r=Object.assign({},{willUploadConsoleLog:I("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:dS?"global":"oversea",areas:I("AREAS")&&I("AREAS").join(",")},t.extend),{stringUid:s,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:u,clientRole:p}=t,m=Date.now(),_=Fe(Fe({},i),{},{eventType:cn.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,buildFormat:t.buildFormat,build:uS,lts:m,elapse:m-n,extend:JSON.stringify(r),mode:t.mode,process:I("PROCESS_ID"),appType:I("APP_TYPE"),success:!0,version:tr,stringUid:s,channelProfile:o,channelMode:a,isABTestSuccess:c,lsid:u,clientType:ie(g=window.navigator.userAgent).call(g,"AgoraWebView")?42:20,clientRole:p,serviceId:I("PROCESS_ID"),extensionID:I("PLUGIN_INFO").join(",")||"",rteUrl:t.rteUrl,rteSid:t.rteSid});var g;this.send({type:Mt.SESSION,data:_},!0)}reportRteDetail(e){const t=this.baseInfoMap.get(e);if(!t)return;const n=t.info,i=Date.now(),r=Fe(Fe({},n),{},{eventType:cn.RTE_DETAIL,lts:i,success:!0,elapse:i-t.startTime,vid:n.vid===void 0?0:Number(n.vid),ua:navigator.userAgent});this.send({type:Mt.RTE_DETAIL,data:r},!0)}joinChooseServer(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info;t.vid&&(i.vid=t.vid);const r=Date.now(),s=Fe(Fe({},i),{},{role:t.role,eventType:cn.JOIN_CHOOSE_SERVER,lts:r,eventElapse:t.elapse||r-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:r-n.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3,corssRegionTagReq:t.corssRegionTagReq||void 0,corssRegionTagRes:t.corssRegionTagRes||void 0,ua:navigator.userAgent,resourceTimingInfo:t.resourceTimingInfo||void 0});this.send({type:Mt.JOIN_CHOOSE_SERVER,data:s},!0)}reqUserAccount(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe({},i),{},{eventType:cn.REQ_USER_ACCOUNT,lts:r,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:t.elapse||r-n.startTime,eventElapse:r-t.lts,extend:JSON.stringify(t.extend)});this.send({type:Mt.REQ_USER_ACCOUNT,data:s},!0)}joinGateway(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info;t.vid&&(i.vid=t.vid),i.uid=t.uid,i.cid=t.cid;const r=Date.now(),{firstSuccess:s,addr:o,isProxy:a}=t,c=r-n.startTime,u=Fe(Fe({},i),{},{eventType:cn.JOIN_GATEWAY,lts:r,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,errorMsg:t.errorMsg||"",elapse:c,eventElapse:r-t.lts,firstSuccess:s,signalChannel:t.signalChannel,preload:t.preload?1:0,installId:cS(),isABTestSuccess:t.isABTestSuccess?1:0,gatewayIp:null,gatewayPort:null,isProxy:a?1:0}),p=u.success?1:0;if(t.succ&&(n.lastJoinSuccessTime=r),o)if(u.signalChannel==="1"){const m=mS(/(\d+\.\d+\.\d+\.\d+):(\d+)/,{ip:1,port:2}),_=o.match(m);u.gatewayIp=_&&_.groups?_.groups.ip:"",u.gatewayPort=_&&_.groups?_.groups.port:""}else if(a){const m=o.match(/h=(\d{1,3}-){3}\d{1,3}/g),_=o.match(/p=[0-9]{1,6}/g);u.gatewayIp=m&&m.length?m[0].split("=")[1].replace(/-/g,"."):"",u.gatewayPort=_&&_.length?_[0].split("=")[1]:""}else{const m=o.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),_=o.match(/(:|p=)[0-9]{1,6}/g);u.gatewayIp=m&&m.length?m[0].split("//")[1].replace(/-/g,"."):"",u.gatewayPort=_&&_.length?_[0].split(/:|p=/g)[1]:""}if(s)this.send({type:Mt.JOIN_GATEWAY,data:u},!0);else{let m={isSuccess:p,port:u.gatewayPort};delete u.success,delete u.eventType,delete u.firstSuccess,delete u.gatewayPort,u.vid=Number(u.vid);const _=Object.assign({},u,m,{eventType:cn.REJOIN_GATEWAY});this.send({type:Mt.RE_JOIN_GATEWAY,data:_},!0)}}joinChannelTimeout(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=Date.now(),r=Fe(Fe({},n.info),{},{lts:i,timeout:t,elapse:i-n.startTime});this.send({type:Mt.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe({},i),{},{eventType:cn.PUBLISH,lts:r,eventElapse:t.eventElapse,elapse:r-n.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:Mt.PUBLISH,data:s},!0)}subscribe(e,t,n){const i=this.baseInfoMap.get(e);if(!i)return;const r=i.info,s=Date.now(),o=Fe(Fe({},r),{},{eventType:cn.SUBSCRIBE,lts:s,eventElapse:t.eventElapse,elapse:s-i.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid,preSsrc:t.preSsrc?1:0},n&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof t.peerid=="string"?o.peerSuid=t.peerid:o.peer=t.peerid,this.send({type:Mt.SUBSCRIBE,data:o},!0)}wsCompressorInit(e){var t;const n=[...zn(t=this.baseInfoMap).call(t)],i=n.length?n[0]:"UnableToGetSid",r=this.baseInfoMap.get(i);if(!r)return;const s=r.info,o=Date.now(),a=Fe(Fe({},s),{},{eventType:cn.WS_COMPRESSOR_INIT,lts:o,eventElapse:e.eventElapse,elapse:o-r.startTime,status:e.status?1:2});this.send({type:Mt.WS_COMPRESSOR_INIT,data:a},!0)}firstXLAPeerFirstVideoFrame(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=t.peerPubStatusMs-(n.lastJoinSuccessTime||r),o=Fe(Fe({},i),{},{elapse:r-n.startTime,eventType:cn.XLA_PEER_FIRST_VIDEO_FRAME,lts:r,peer:t.peer,width:t.width,height:t.height,ssrc:t.ssrc,p2pid:t.p2pid,peerPublishDuration:t.peerPublishDuration,joinChannelSuccessElapse:s,peerPubStatusMs:t.peerPubStatusMs-t.joinChannelStart,availablePublish:t.peerPublishDuration>s?1:0,preloadStart:Math.max(t.preloadStart-t.joinChannelStart,0),preloadEnd:Math.max(t.preloadEnd-t.joinChannelStart,0),encrypt:Math.max(t.apStart-t.joinChannelStart,0),ap:Math.max(t.apEnd-t.joinChannelStart,0),sua:Math.max(t.suaEnd-t.joinChannelStart,0),beforeConnect:Math.max(t.beforeConnect-t.joinChannelStart,0),peerRecevier:Math.max(t.peerReceiver-t.joinChannelStart,0),ice:Math.max(t.ice-t.joinChannelStart,0),pc:Math.max(t.pc-t.joinChannelStart,0),signalConnected:Math.max(t.signalConnected-t.joinChannelStart,0),joinReq:Math.max(t.joinReq-t.joinChannelStart,0),joinRes:Math.max(t.joinRes-t.joinChannelStart,0),userJoinNotify:Math.max(t.userJoinNotify-t.joinChannelStart,0),videoSsrcNotify:Math.max(t.videoAddNotify-t.joinChannelStart,0),subscribeDelayMs:Math.max(t.subscribeStart-t.videoAddNotify,0),subscribeStart:Math.max(t.subscribeStart-t.joinChannelStart,0),subscribeEnd:Math.max(t.subscribeEnd-t.joinChannelStart,0),firstReceived:Math.max(t.firstReceived-t.joinChannelStart,0),firstDecoded:Math.max(t.firstDecoded-t.joinChannelStart,0),firstPreRender:Math.max(t.firstPreRender-t.joinChannelStart,0),firstRender:Math.max(t.firstRender-t.joinChannelStart,0),playDelayMs:Math.max(t.playStart-t.subscribeEnd,0),playStart:Math.max(t.playStart-t.joinChannelStart,0),playEnd:Math.max(t.playEnd-t.joinChannelStart,0),isPreSub:t.isPreSub?1:0,isPrePc:t.isPrePc?1:0,isPreInstantVideo:t.isPreInstantVideo?1:0,firstReceivedEncodedFrame:t.firstReceivedEncodedFrame?Math.max(t.firstReceivedEncodedFrame-t.joinChannelStart,0):void 0,frameType:t.frameType||"",rtpTimestamp:t.rtpTimestamp||0,framePayloadType:t.framePayloadType||0,frameDataLength:t.frameDataLength||0,mimeType:t.mimeType||""});this.send({type:Mt.XLA_PEER_FIRST_VIDEO_FRAME,data:o},!0)}firstRemoteVideoDecode(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=Fe(Fe(Fe({},s),i),{},{elapse:o-r.startTime,eventType:t,lts:o,firstDecodeFrame:Math.max((i.firstFrame||o)-r.startTime,0),apEnd:Math.max(i.apEnd-r.startTime,0),apStart:Math.max(i.apStart-r.startTime,0),joinGwEnd:Math.max(i.joinGwEnd-r.startTime,0),joinGwStart:Math.max(i.joinGwStart-r.startTime,0),pcEnd:Math.max(i.pcEnd-r.startTime,0),pcStart:Math.max(i.pcStart-r.startTime,0),subscriberEnd:Math.max(i.subscriberEnd-r.startTime,0),subscriberStart:Math.max(i.subscriberStart-r.startTime,0),videoAddNotify:Math.max(i.videoAddNotify-r.startTime,0)});this.send({type:n,data:a},!0)}firstRemoteFrame(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=Fe(Fe(Fe({},s),i),{},{elapse:o-r.startTime,eventType:t,lts:o});this.send({type:n,data:a},!0)}abTest(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe(Fe({},i),t),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-n.startTime,eventType:cn.AB_TEST,lts:r});this.send({type:Mt.AB_TEST,data:s},!0)}pcStats(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe(Fe({},i),t),{},{vid:i.vid===void 0?0:Number(i.vid),elapse:r-n.startTime,eventType:cn.PC_STATS,lts:r,preallocation:t.preallocation?1:0});this.send({type:Mt.PC_STATS,data:s},!0)}updateRemoteRTPCapabilities(e,t){if(e){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe(Fe({},i),t),{},{vid:i.vid===void 0?0:Number(i.vid),eventType:cn.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:Mt.UPDATE_REMOTE_RTPCAPABILITIES,data:s},!0)}}onGatewayStream(e,t,n,i){const r=this.baseInfoMap.get(e);if(!r)return;const s=r.info,o=Date.now(),a=Fe(Fe(Fe({},s),i),{},{eventType:t,lts:o});this.send({type:n,data:a},!0)}streamSwitch(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe({},i),{},{eventType:cn.STREAM_SWITCH,lts:r,isDual:t.isdual,elapse:r-n.startTime,success:t.succ});this.send({type:Mt.STREAM_SWITCH,data:s},!0)}requestProxyAppCenter(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe({},i),{},{eventType:cn.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-t.lts,elapse:r-n.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Mt.REQUEST_PROXY_APPCENTER,data:s},!0)}requestProxyWorkerManager(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe({},i),{},{eventType:cn.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-t.lts,elapse:r-n.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Mt.REQUEST_PROXY_WORKER_MANAGER,data:s},!0)}setProxyServer(e){this.proxyServer=e,e?S.debug("reportProxyServerurl: ".concat(e)):S.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe({},i),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:r,elapse:r-n.startTime,joinChannelSuccessElapse:r-(n.lastJoinSuccessTime||r),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:Mt.PEER_PUBLISH_STATUS,data:s},!0)}workerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now();(function(s,o,a){const c=s[o];if(!c||typeof c!="string")return[s];s[o]="";const u=ys(JSON.stringify(s));let p=0;const m=[];let _=0;for(let g=0;g<c.length;g++)_+=c.charCodeAt(g)<=127?1:3,_<=a-u||(m[m.length]=ae(ae({},s),{},{[o]:c.substring(p,g)}),p=g,_=c.charCodeAt(g)<=127?1:3);return p!==c.length-1&&(m[m.length]=ae(ae({},s),{},{[o]:c.substring(p)})),m})(Fe(Fe(Fe({},i),t),{},{elapse:r-n.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach((s=>this.send({type:Mt.WORKER_EVENT,data:s},!0)))}apworkerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe(Fe({},i),t),{},{elapse:r-n.startTime,lts:r});this.send({type:Mt.AP_WORKER_EVENT,data:s},!0)}joinWebProxyAP(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe(Fe({},i),t),{},{elapse:r-n.startTime,lts:r,extend:t.extend||void 0});this.send({type:Mt.JOIN_WEB_PROXY_AP,data:s},!0)}WebSocketQuit(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const i=n.info,r=Date.now(),s=Fe(Fe(Fe({},i),t),{},{elapse:r-n.startTime,lts:r});this.send({type:Mt.WEBSOCKET_QUIT,data:s},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>I("CUSTOM_REPORT_LIMIT"))throw new J(N.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval((()=>{this.customReportCount=0}),5e3));const n=Date.now(),i=t.map((r=>({type:Mt.USER_ANALYTICS,data:Fe(Fe({sid:e},r),{},{lts:n})})));try{I("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(i):await this.postDataToStatsCollector(i)}catch(r){throw S.error("send custom report message failed",r.toString()),new J(N.CUSTOM_REPORT_SEND_FAILED,r.message)}}sendApiInvoke(e){const t=I("NOT_REPORT_EVENT");if(e.tag&&ie(t)&&ie(t).call(t,e.tag))return!1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;const n=this.baseInfoMap.get(e.sid);if(!n)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:i,uid:r,cid:s}=n.info;let o;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof J){const{code:c,message:u}=e.error;o=c||u||e.error.toString()}else o=e.error.toString();const a={invokeId:e.invokeId,sid:e.sid,cname:i,cid:s,uid:r,lts:e.lts,success:e.success,elapse:e.lts-n.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?o:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:Mt.API_INVOKE,data:a},!1),!0}addSid(e){this.sids.add(e)}removeSid(e){this.sids.delete(e)}appendSessionId(){const e=this.apiInvokeUploadPendingItems;if(e.length===0)return;const t=Array.from(this.sids).find((n=>n!==null));t&&e.forEach((n=>{n&&(n.sid=t,this.sendApiInvoke(Object.assign({},n)))})),e.length=0}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>I("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){const n=[],i=[];for(;e.length;){const s=e.shift();n.length<20?n.push(s):i.push(s)}e.push(...i);for(const s of[...n]){var r;this.ltsList.indexOf(s.data.lts)!==-1?(s.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(s.data.lts)):(this.ltsList.push(s.data.lts),la(r=this.ltsList).call(r,((o,a)=>o-a)))}return t||(this.lastSendNormalEventTime=Date.now()),I("ENABLE_EVENT_REPORT")&&n.length&&(I("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((s=>o=>{I("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(s):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(s),this.normalEventUploadPendingItems.length>I("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-I("NORMAL_EVENT_QUEUE_CAPACITY")),S.warning("report: drop normal events"))))})(n)),e}async postDataToStatsCollector2(e){Gt.networkState===ii.OFFLINE&&await de.race([Gt.onlineWaiter,En(2*$t.maxRetryTimeout)]);const t=r=>{let s=new Uint8Array;return r.forEach((o=>{const a=qE(JSON.stringify(o.data)),c=new ArrayBuffer(5),u=(m=>{let _=0;return Object.entries(Mt).forEach((g=>{let[b,v]=g;v===m.type&&(_=ZY[b])})),_})(o),p=new DataView(c);p.setUint16(0,a.byteLength,!0),p.setUint8(2,255&u),p.setUint8(3,u>>>8&255),p.setUint8(4,u>>>16&255),s=rO(s,new Uint8Array(c)),s=rO(s,a)})),s},n="event";let i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(I("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(n):"https://".concat(I("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(n);for(let r=0;r<2;r+=1){r===1&&(i=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(I("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(n):"https://".concat(I("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(n));try{await rS(i,{timeout:1e4,data:t(e),headers:Fe(Fe({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(s){if(r===1)throw s;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=(a=>{const c=a&&a.data.sid&&this.baseInfoMap.get(a.data.sid);return c&&c.info.vid&&+c.info.vid||0})(e[0]),i=n?void 0:this._aid,r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map((a=>JSON.stringify(a))),vid:n,aid:i};Gt.networkState===ii.OFFLINE&&await de.race([Gt.onlineWaiter,En(2*$t.maxRetryTimeout)]);const s=t?"/events/proto-raws":"/events/messages";let o=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(I("EVENT_REPORT_DOMAIN"),"&p=").concat(I("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(I("EVENT_REPORT_DOMAIN"),":").concat(I("STATS_COLLECTOR_PORT")).concat(s));for(let a=0;a<2;a+=1){a===1&&(o=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(I("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(I("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(I("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(I("STATS_COLLECTOR_PORT")).concat(s)));try{t?await UY(o,{timeout:1e4,data:r}):await rS(o,{timeout:1e4,data:r})}catch(c){if(a===1)throw c;continue}return}}createBaseInfo(e,t){const n=Object.assign({},QY);return n.sid=e,this.baseInfoMap.set(e,{info:n,startTime:t}),n}reportResourceTiming(e,t){const n=performance.getEntriesByName(e),i=n[n.length-1];i&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:i,tag:Ct.TRACER}).onSuccess()}};PO.on("REPORT_LOG_UPLOAD",(e=>{e.networkState=Gt.networkState,Se.reportApiInvoke(null,{name:"logUploadError",options:e,tag:Ct.TRACER}).onSuccess("logUploadError")}));let Y=class extends J{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),Ht(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,S)}throw(){super.throw(S)}};const Sn={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1,supportSuppressLocalAudioPlayback:!1,supportRestrictOwnAudio:!1};function Xe(){return Sn}function xO(){return"setSinkId"in HTMLAudioElement.prototype&&(!I("RESTRICTION_SET_PLAYBACK_DEVICE")||(Xs()||G0())&&!Z0())}function Op(){return!Sn.supportUnifiedPlan||I("CHROME_FORCE_PLAN_B")&&Ss()}function Vl(e){return!(Nt()||H0(87)||Op()||!I("ENABLE_PRE_SUB")&&(e==null||!e.autoSubscribe||I("FORCE_DISABLE_AUTO_SUB")))}function MO(e){return I("ENABLE_INSTANT_VIDEO")?I("ENABLE_INSTANT_VIDEO"):!(e==null||!e.autoSubscribe||I("FORCE_DISABLE_AUTO_SUB"))}function UO(){return navigator.mediaDevices&&"getSupportedConstraints"in navigator.mediaDevices}function VO(){if(UO()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("suppressLocalAudioPlayback"in e)||!e.suppressLocalAudioPlayback)}return Yr(141)||bo(141)||Sa(141)}function jO(){if(UO()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("restrictOwnAudio"in e)||!e.restrictOwnAudio)}return Yr(141)||bo(141)||Sa(125)}let Dn=(function(e){return e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change",e})({});function nd(e,t,n){return{sampleRate:e,stereo:t,bitrate:n}}function ot(e,t,n,i,r){return{width:e,height:t,frameRate:n,bitrateMin:i,bitrateMax:r}}function Cr(e,t,n,i,r){return{width:{max:e},height:{max:t},frameRate:n,bitrateMin:i,bitrateMax:r}}function _S(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}const $Y={"90p":ot(160,90),"90p_1":ot(160,90),"120p":ot(160,120,15,30,65),"120p_1":ot(160,120,15,30,65),"120p_3":ot(120,120,15,30,50),"120p_4":ot(212,120),"180p":ot(320,180,15,30,140),"180p_1":ot(320,180,15,30,140),"180p_3":ot(180,180,15,30,100),"180p_4":ot(240,180,15,30,120),"240p":ot(320,240,15,40,200),"240p_1":ot(320,240,15,40,200),"240p_3":ot(240,240,15,40,140),"240p_4":ot(424,240,15,40,220),"360p":ot(640,360,15,80,400),"360p_1":ot(640,360,15,80,400),"360p_3":ot(360,360,15,80,260),"360p_4":ot(640,360,30,80,600),"360p_6":ot(360,360,30,80,400),"360p_7":ot(480,360,15,80,320),"360p_8":ot(480,360,30,80,490),"360p_9":ot(640,360,15,80,800),"360p_10":ot(640,360,24,80,800),"360p_11":ot(640,360,24,80,1e3),"480p":ot(640,480,15,100,500),"480p_1":ot(640,480,15,100,500),"480p_2":ot(640,480,30,100,1e3),"480p_3":ot(480,480,15,100,400),"480p_4":ot(640,480,30,100,750),"480p_6":ot(480,480,30,100,600),"480p_8":ot(848,480,15,100,610),"480p_9":ot(848,480,30,100,930),"480p_10":ot(640,480,10,100,400),"720p":ot(1280,720,15,120,1130),"720p_auto":ot(1280,720,30,900,3e3),"720p_1":ot(1280,720,15,120,1130),"720p_2":ot(1280,720,30,120,2e3),"720p_3":ot(1280,720,30,120,1710),"720p_5":ot(960,720,15,120,910),"720p_6":ot(960,720,30,120,1380),"1080p":ot(1920,1080,15,120,2080),"1080p_1":ot(1920,1080,15,120,2080),"1080p_2":ot(1920,1080,30,120,3e3),"1080p_3":ot(1920,1080,30,120,3150),"1080p_5":ot(1920,1080,60,120,4780),"1440p":ot(2560,1440,30,120,4850),"1440p_1":ot(2560,1440,30,120,4850),"1440p_2":ot(2560,1440,60,120,7350),"4k":ot(3840,2160,30,120,8910),"4k_1":ot(3840,2160,30,120,8910),"4k_3":ot(3840,2160,60,120,13500)},ez={"480p":Cr(640,480,5),"480p_1":Cr(640,480,5),"480p_2":Cr(640,480,30),"480p_3":Cr(640,480,15),"720p":Cr(1280,720,5),"720p_auto":ot(1280,720,30,900,3e3),"720p_1":Cr(1280,720,5),"720p_2":Cr(1280,720,30),"720p_3":Cr(1280,720,15),"1080p":Cr(1920,1080,5),"1080p_1":Cr(1920,1080,5),"1080p_2":Cr(1920,1080,30),"1080p_3":Cr(1920,1080,15)},tz={"1SL1TL":_S(1,1),"3SL3TL":_S(3,3),"2SL3TL":_S(2,3)};function br(e){return e||(e="480p_1"),typeof e=="string"?Object.assign({},$Y[e]):e}function gS(e){return typeof e=="string"?Object.assign({},ez[e]):e}function Np(e){return typeof e=="string"?Object.assign({},tz[e]):e}const nz={speech_low_quality:nd(16e3,!1),speech_standard:nd(32e3,!1,18),music_standard:nd(48e3,!1),standard_stereo:nd(48e3,!0,56),high_quality:nd(48e3,!1,128),high_quality_stereo:nd(48e3,!0,192)};function Dp(e){return typeof e=="string"?Object.assign({},nz[e]):e}const Ia=[];function FO(e){return Zt(e,"mediaSource",["screen","window","application"]),!0}let ye=(function(e){return e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track",e})({}),ht=(function(e){return e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream",e.SCREEN_LOW_TRACK="screen_low_track",e})({}),id=(function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e})({}),iz=(function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",e})({}),rz=(function(e){return e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e[e.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",e})({}),Oa=(function(e){return e.TRANSCEIVER_UPDATED="transceiver-updated",e.SEI_TO_SEND="sei-to-send",e.SEI_RECEIVED="sei-received",e.TRACK_UPDATED="track-updated",e})({}),rd=(function(e){return e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed",e})({}),ir=(function(e){return e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.VIDEO_STATE_CHANGED="video-state-changed",e.PLAY_START="play-start",e.PLAY_END="play-end",e.FIRST_FRAME_RENDER="first-frame-render",e})({}),sd=(function(e){return e.AUDIO="audio",e.VIDEO="video",e.DATA="data",e})({}),Wi=(function(e){return e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source",e})({});(function(e){e.UPDATE_TRACK_SOURCE="update-track-source"})({});const ES={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},SS={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},BO={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},sz={uplinkNetworkQuality:0,downlinkNetworkQuality:0},WO={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let si=(function(e){return e.ON_TRACK="on_track",e.ON_NODE="on_node",e})({}),Gi=(function(e){return e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints",e})({}),jl=(function(e){return e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND",e})({}),Na=(function(e){return e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e})({}),Vn=(function(e){return e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata",e})({}),Ts=(function(e){return e[e.VideoStateStopped=0]="VideoStateStopped",e[e.VideoStateStarting=1]="VideoStateStarting",e[e.VideoStateDecoding=2]="VideoStateDecoding",e[e.VideoStateFrozen=3]="VideoStateFrozen",e})({});const yS={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let Pp=(function(e){return e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error",e})({});function tt(e,t,n,i,r){var s,o,a={};return Object.keys(i).forEach((function(c){a[c]=i[c]})),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=$i(s=_R(o=n.slice()).call(o)).call(s,(function(c,u){return u(e,t,c)||c}),a),r&&a.initializer!==void 0&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),a.initializer===void 0?(Object.defineProperty(e,t,a),null):a}function q(e,t,n){return(t=(function(i){var r=(function(s,o){if(typeof s!="object"||!s)return s;var a=s[Symbol.toPrimitive];if(a!==void 0){var c=a.call(s,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(s)})(i);return typeof r=="symbol"?r:r+""})(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function GO(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Ot(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?GO(Object(n),!0).forEach((function(i){q(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):GO(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class HO extends Vt{set _mediaStreamTrack(t){t!==this.mediaStreamTrack&&(this.safeEmit(Oa.TRACK_UPDATED,t),this.mediaStreamTrack=t)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(t,n){super(),q(this,"trackMediaType",void 0),q(this,"_ID",void 0),q(this,"_rtpTransceiver",void 0),q(this,"_lowRtpTransceiver",void 0),q(this,"_hints",[]),q(this,"_isClosed",!1),q(this,"_originMediaStreamTrack",void 0),q(this,"mediaStreamTrack",void 0),q(this,"_external",{}),this._ID=n||mt(8,"track-"),this._originMediaStreamTrack=t,this.mediaStreamTrack=t,(function(i){ie(Ia).call(Ia,i)||Ia.push(i)})(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){return t||wo((()=>{var n;Se.reportApiInvoke(null,{name:xt.GET_MEDIA_STREAM_TRACK,options:[],tag:Ct.TRACER}).onSuccess(((n=this._mediaStreamTrack)===null||n===void 0?void 0:n.label)||"")}),this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===id.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,(function(t){const n=Ia.indexOf(t);n!==-1&&Ia.splice(n,1)})(this),this.emit(rd.CLOSED),this.removeAllListeners(Oa.SEI_RECEIVED)}_updateRtpTransceiver(t,n){if(n===id.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(Oa.TRANSCEIVER_UPDATED,t,n)}}class od extends HO{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(t,n){super(t,n),q(this,"_enabled",!0),q(this,"_muted",!1),q(this,"_isExternalTrack",!1),q(this,"_isClosed",!1),q(this,"_enabledMutex",void 0),q(this,"processor",void 0),q(this,"_processorContext",void 0),q(this,"_handleTrackEnded",(()=>{this.onTrackEnded()})),this._enabledMutex=new Cn("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,n;return(t=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,S.debug("[".concat(this.getTrackId(),"] close")),this.emit(ye.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=i,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await wt(this,ye.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){S.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(rd.TRACK_ENDED)}stateCheck(t,n){if(S.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(n,"]")),Tr(n,t),this._enabled&&this._muted&&t==="enabled"&&n===!1)throw new J(N.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",S);if(!this._enabled&&!this._muted&&t==="muted"&&n===!0)throw new J(N.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",S)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():de.resolve([])}}const KO=window.AudioContext||window.webkitAudioContext;let TS,Hi=null;const yt=new class extends Vt{constructor(){super(...arguments),q(this,"prevState",void 0),q(this,"curState",void 0),q(this,"currentTime",void 0),q(this,"currentTimeStuckAt",void 0),q(this,"interruptDetectorTrack",void 0),q(this,"onLocalAudioTrackMute",(()=>{S.info("ios15-interruption-start"),this.emit(Dn.IOS_15_16_INTERRUPTION_START)})),q(this,"onLocalAudioTrackUnmute",(async()=>{S.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?S.info("ios15-interruption-end-canceled"):(Hi&&await Hi.suspend(),this.emit(Dn.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(e){S.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){S.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function ad(){if(!Hi){if((function(){if(!KO)return void S.error("your browser is not support web audio");S.info("create audio context");const e=Ot({},I("WEBAUDIO_INIT_OPTIONS"));S.debug("audio context init option:",JSON.stringify(e)),Hi=new KO(e),yt.curState=Hi.state,Hi.onstatechange=()=>{yt.prevState=yt.curState,yt.curState=Hi?Hi.state:void 0;const{prevState:t,curState:n}=yt,i=n==="running",r=n==="interrupted",s=t==="running",o=t==="suspended",a=t==="interrupted",c=st().osVersion;(Yn()||yr())&&s&&r&&(S.info("ios".concat(c,"-interruption-start")),yt.emit(Dn.IOS_INTERRUPTION_START)),(Yn()||yr())&&(o||a)&&i&&(S.info("ios".concat(c,"-interruption-end")),yt.emit(Dn.IOS_INTERRUPTION_END)),t!==n&&yt.emit(Dn.STATE_CHANGE,n,t)},setInterval((()=>{var t;const n=(t=Hi)===null||t===void 0?void 0:t.currentTime;yt.currentTime!==n?(yt.currentTimeStuckAt&&(S.debug("AudioContext current time resume at ".concat(n)),yt.currentTimeStuckAt=void 0),yt.currentTime=n):(n!==yt.currentTimeStuckAt&&(Se.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:Ct.TRACER}).onSuccess(),S.warning("AudioContext current time stuck at ".concat(n))),yt.currentTimeStuckAt=n)}),5e3),(async function(t){const n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,r,s=!1,o=!1,a=!1;function c(O){t.state==="running"?u(!1):Yn()||yr()?t.state==="suspended"&&(u(!0),O&&t.resume().then(p,p)):t.state!=="closed"&&(u(!0),O&&t.resume().then(p,p))}function u(O){if(s!==O){s=O;for(let D=0,x=n;D<x.length;D+=1){const B=x[D];O?window.addEventListener(B,m,{capture:!0,passive:!0}):window.removeEventListener(B,m,{capture:!0,passive:!0})}}}function p(){c(!1)}function m(){c(!0)}function _(){let O;try{O=i.play(),O?O.then(v,v):(i.addEventListener("playing",v),i.addEventListener("abort",v),i.addEventListener("error",v))}catch{v()}}function g(O){a||(i.paused?O?(b(!1),a=!0,_()):b(!0):b(!1))}function b(O){if(o!==O){o=O;for(let D=0,x=n;D<x.length;D++){const B=x[D];O?window.addEventListener(B,R,{capture:!0,passive:!0}):window.removeEventListener(B,R,{capture:!0,passive:!0})}}}function v(){i.removeEventListener("playing",v),i.removeEventListener("abort",v),i.removeEventListener("error",v),a=!1,g(!1)}function R(){g(!0)}if(Yn()&&I("IOS_BG_TAG")){const O=t.createMediaStreamDestination(),D=document.createElement("div");D.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=D.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=O.stream,r=()=>{if(I("IOS_AUTO_RESTART_BG_TAG")&&i&&i.srcObject&&!a&&(!i.paused||o!==!0)){i.paused||i.pause();try{a=!0,_()}catch{a=!1}return!0}},g(!0)}return yt.on(Dn.STATE_CHANGE,(function(){c(!0)})),c(!1),r})(Hi).then((t=>{TS=t}))})(),!Hi)throw new J(N.NOT_SUPPORTED,"can not create audio context");return Hi}return Hi}function Da(e){if((function(){if(vS!==null)return vS;const i=ad(),r=i.createBufferSource(),s=i.createGain(),o=i.createGain();r.connect(s),r.connect(o),r.disconnect(s);let a=!1;try{r.disconnect(s)}catch{a=!0}return r.disconnect(),vS=a,a})())return;const t=e.connect,n=e.disconnect;e.connect=(i,r,s)=>{var o;return e._inputNodes||(e._inputNodes=[]),ie(o=e._inputNodes).call(o,i)||(i instanceof AudioNode?(e._inputNodes.push(i),t.call(e,i,r,s)):t.call(e,i,r)),e},e.disconnect=(i,r,s)=>{n.call(e),i?Sp(e._inputNodes,i):e._inputNodes=[];for(const o of e._inputNodes)t.call(e,o)}}let vS=null;function RS(e,t){let n=!1;const i=1/t;if(I("DISABLE_WEBAUDIO")){const r=window.setInterval((()=>{n?window.clearInterval(r):e(performance.now()/1e3)}),1e3*i)}else{const r=ad();let s=r.createGain();s.gain.value=0,s.connect(r.destination);const o=()=>{if(n)return void(s=null);const a=r.createOscillator();a.onended=o,a.connect(s),a.start(0),a.stop(r.currentTime+i),e(r.currentTime)};o()}return()=>{n=!0}}class YO{constructor(){q(this,"context",void 0),q(this,"analyserNode",void 0),q(this,"sourceNode",void 0),this.context=ad(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t?.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||Yn()||yr()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const i=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(i);for(let r=0;r<t.length;++r)t[r]=i[r]/128-1}const n=$i(t).call(t,((i,r)=>i+r*r),0)/t.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,n;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode)}catch{S.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class zO extends Vt{get processSourceNode(){return this.sourceNode}set processedNode(t){var n;if(!this.isDestroyed&&this._processedNode!==t){try{var i;(i=this.sourceNode)===null||i===void 0||i.disconnect(this.outputNode)}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),q(this,"outputNode",void 0),q(this,"outputTrack",void 0),q(this,"isPlayed",!1),q(this,"sourceNode",void 0),q(this,"context",void 0),q(this,"audioBufferNode",void 0),q(this,"destNode",void 0),q(this,"audioOutputLevel",0),q(this,"volumeLevelAnalyser",void 0),q(this,"_processedNode",void 0),q(this,"playNode",void 0),q(this,"isDestroyed",!1),q(this,"onNoAudioInput",void 0),q(this,"isNoAudioInput",!1),q(this,"_noAudioInputCount",0),this.context=ad(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Da(this.outputNode),this.volumeLevelAnalyser=new YO}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(Wi.ON_AUDIO_BUFFER,(function(i){for(let r=0;r<i.outputBuffer.numberOfChannels;r+=1){const s=i.outputBuffer.getChannelData(r);for(let o=0;o<s.length;o+=1)s[o]=0}return i.inputBuffer})(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Xe().webAudioMediaStreamDest)throw new J(N.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&yp((()=>{yt.emit("autoplay-failed")})),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;Yn()||yr()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const n=this.volumeLevelAnalyser.getAnalyserNode();let i;n.getFloatTimeDomainData?(i=new Float32Array(n.fftSize),n.getFloatTimeDomainData(i)):(i=new Uint8Array(n.fftSize),n.getByteTimeDomainData(i));let r=!1;for(let s=0;s<i.length;s++)i[s]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await En(200),await this.checkHasAudioInput(t?t+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,n;(t=this.processedNode)===null||t===void 0||t.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class CS extends zO{get isFreeze(){return!1}constructor(t,n,i){var r;if(super(),q(this,"sourceNode",void 0),q(this,"track",void 0),q(this,"clonedTrack",void 0),q(this,"audioElement",void 0),q(this,"isCurrentTrackCloned",!1),q(this,"isRemoteTrack",!1),q(this,"originVolumeLevelAnalyser",void 0),q(this,"rebuildWebAudio",(async()=>{if(S.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void S.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then((()=>S.info("resume success"))),S.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;const c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),Da(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const u=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(u,this.context.currentTime),Da(this.outputNode),this.emit(Wi.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),t.kind!=="audio")throw new J(N.UNEXPECTED_ERROR);this.track=t;const s=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(s),Da(this.sourceNode),i){const a=i.clone();a.enabled=!0,this.clonedTrack=a,S.debug("create an unmuted track ".concat(a.id," from the original track ").concat(i.id," to get the volume"));const c=this.context.createMediaStreamSource(new MediaStream([a]));Da(c),this.originVolumeLevelAnalyser=new YO,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=s;const o=st();n&&o.os===gn.IOS&&Number((r=o.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(yt.on(Dn.STATE_CHANGE,(()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()})),this.checkHasAudioInput().then((a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)})))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const n=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(n),Da(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Wi.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),yt.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const n=t.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),S.debug("create an unmuted track ".concat(n.id," from the original track ").concat(t.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([n]));Da(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function qO(e,t,n){const i=(s,o)=>s?typeof s!="number"?s.max||s.exact||s.ideal||s.min||o:s:o,r={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:i(t.height,1080),maxWidth:i(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(r.video.mandatory.maxFrameRate=t.frameRate.max,r.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(r.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function oz(e,t){const n=await XO(e.mediaSource),{sourceId:i,audio:r}=await(function(s){let o=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new de(((a,c)=>{const u=document.createElement("div");u.innerText="share screen",u.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const p=document.createElement("div");p.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const m=document.createElement("div");m.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",m.setAttribute("style","height: 12%;");const _=document.createElement("div");_.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const g=document.createElement("div");g.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const b=document.createElement("button");b.innerHTML="cancel",b.setAttribute("style","width: 85px;"),b.onclick=()=>{document.body.removeChild(O);const D=new Error("NotAllowedError");D.name="NotAllowedError",c(D)};let v=o;const R=document.createElement("div");if(o){const D=document.createElement("input");D.setAttribute("type","checkbox");const x=document.createElement("span");D.setAttribute("style","margin-right: 6px;"),x.innerText="Share audio",D.checked=v,D.onchange=()=>{v=D.checked},R.appendChild(D),R.appendChild(x)}g.appendChild(R),g.appendChild(b),p.appendChild(m),p.appendChild(_),p.appendChild(g);const O=document.createElement("div");O.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),O.appendChild(u),O.appendChild(p),document.body.appendChild(O),s.map((D=>{if(D.id){const x=document.createElement("div");x.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let B=D.thumbnail;try{const{width:G}=B.getSize();G>1920&&(B=B.resize({width:1920}))}catch(G){throw G&&G.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),G}x.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+B.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+D.name.replace(/[\u00A0-\u9999<>\&]/g,(function(G){return"&#"+G.charCodeAt(0)+";"}))+"</span>",x.onclick=()=>{document.body.removeChild(O),a({sourceId:D.id,audio:v})},_.appendChild(x)}}))}))})(n,t);return await qO(i,e,r)}async function XO(e){let t=["window","screen"];e!=="application"&&e!=="window"||(t=["window"]),e==="screen"&&(t=["screen"]);const n=sO();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new J(N.ELECTRON_IS_NULL);let i=null;try{var r;i=((r=n.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:t}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{i=null}i&&i.then||(i=new de(((s,o)=>{n.desktopCapturer.getSources({types:t},((a,c)=>{a?o(a):s(c)}))})));try{return await i}catch(s){throw new J(N.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,s.toString())}}const bS=new Cn("safari");let JO=!1,QO=!1;async function Ki(e,t){let n=0,i=null;for(;n<2;)try{i=await az(e,t,n>0);break}catch(r){if(r instanceof J)throw S.error("[".concat(t,"] ").concat(r.toString())),r;const s=Lp(r.name||r.code||r,r.message);if(s.code===N.MEDIA_OPTION_INVALID){S.debug("[".concat(t,"] detect media option invalid, retry")),n+=1,await En(500);continue}throw S.error("[".concat(t,"] ").concat(s.toString())),s}if(!i)throw new J(N.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function az(e,t,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new J(N.NOT_SUPPORTED,"can not find getUserMedia");n&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const i=Xe(),r=new MediaStream;if(e.audioSource&&r.addTrack(e.audioSource),e.videoSource&&r.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return S.debug("Using Video Source/ Audio Source"),r;if(e.screen)if(sO())e.screen.sourceId?cd(r,await qO(e.screen.sourceId,e.screen,!!e.screenAudio)):cd(r,await oz(e.screen,!!e.screenAudio));else if(Xs()&&e.screen.extensionId&&e.screen.mandatory){if(!i.getStreamFromExtension)throw new J(N.NOT_SUPPORTED,"This browser does not support screen sharing");S.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const _=await(o=e.screen.extensionId,a=t,new de(((g,b)=>{try{chrome.runtime.sendMessage(o,{getStream:!0},(v=>{if(!v||!v.streamId)return S.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),v),void b(new J(N.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));g(v.streamId)}))}catch(v){S.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(o,")"),v.toString()),b(new J(N.CHROME_PLUGIN_NOT_INSTALL))}})));e.screen.mandatory.chromeMediaSourceId=_,cd(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(i.getDisplayMedia){var s;e.screen.mediaSource&&FO(e.screen.mediaSource);const _={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:(s=e.screen.displaySurface)!==null&&s!==void 0?s:e.screen.mediaSource==="screen"?"monitor":e.screen.mediaSource},{selfBrowserSurface:g,surfaceSwitching:b,systemAudio:v,preferCurrentTab:R,windowAudio:O,monitorTypeSurfaces:D}=e.screen,x={selfBrowserSurface:g,surfaceSwitching:b,systemAudio:v,preferCurrentTab:R,windowAudio:O,monitorTypeSurfaces:D};!g&&delete x.selfBrowserSurface,!b&&delete x.surfaceSwitching,!v&&delete x.systemAudio,!R&&delete x.preferCurrentTab,!O&&delete x.windowAudio,!D&&delete x.monitorTypeSurfaces,S.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:_,audio:e.screenAudio,controls:x})),cd(r,await navigator.mediaDevices.getDisplayMedia(Ot({video:_,audio:e.screenAudio},x)))}else{if(!Nt())throw S.error("[".concat(t,"] This browser does not support screenSharing")),new J(N.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&FO(e.screen.mediaSource);const _={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};S.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(_))),cd(r,await navigator.mediaDevices.getUserMedia(_))}}var o,a;if(!e.video&&!e.audio)return r;let c={video:e.video,audio:e.audio},u=I("MEDIA_DEVICE_CONSTRAINTS");if(u)try{typeof u=="string"&&(u=JSON.parse(u)),c=$E(c,u)}catch{}S.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(c)),st();let p,m=null;(Rn()||Yn()||Ep())&&(m=await bS.lock());try{p=await navigator.mediaDevices.getUserMedia(c)}catch(_){throw m&&m(),_}return c.audio&&(JO=!0),c.video&&(QO=!0),cd(r,p),m&&m(),r}function Lp(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new J(N.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new J(N.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new J(N.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new J(N.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new J(N.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new J(N.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return S.error("getUserMedia unexpected error",e),new J(N.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function cd(e,t){const n=e.getVideoTracks()[0],i=e.getAudioTracks()[0],r=t.getVideoTracks()[0],s=t.getAudioTracks()[0];s&&(i&&e.removeTrack(i),e.addTrack(s)),r&&(n&&e.removeTrack(n),e.addTrack(r))}const Yi=new class extends Vt{get state(){return this._state}set state(e){e!==this._state&&(this.emit(Na.STATE_CHANGE,e),this._state=e)}constructor(){super(),q(this,"_state",jl.IDLE),q(this,"isAccessMicrophonePermission",!1),q(this,"isAccessCameraPermission",!1),q(this,"lastAccessMicrophonePermission",!1),q(this,"lastAccessCameraPermission",!1),q(this,"checkdeviceMatched",!1),q(this,"deviceInfoMap",new Map),this.init().then((()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval((()=>{(I("ENUMERATE_DEVICES_INTERVAL")||(Nl()||gp()===gn.HARMONY_OS)&&Ss())&&this.updateDevicesInfo()}),I("ENUMERATE_DEVICES_INTERVAL_TIME"))})).catch((e=>S.error(e.toString())))}async enumerateDevices(e,t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw new J(N.NOT_SUPPORTED,"enumerateDevices() not supported.");const i=await navigator.mediaDevices.enumerateDevices(),r=this.checkMediaDeviceInfoIsOk(i);let s=!this.isAccessMicrophonePermission&&e,o=!this.isAccessCameraPermission&&t;r.audio&&(s=!1),r.video&&(o=!1);let a=null,c=null,u=null;if(!n&&(s||o)){if(bS.isLocked&&(S.debug("[device manager] wait GUM lock"),(await bS.lock())(),S.debug("[device manager] GUM unlock")),JO&&(s=!1,this.isAccessMicrophonePermission=!0),QO&&(o=!1,this.isAccessCameraPermission=!0),S.debug("[device manager] check media device permissions",e,t,s,o),s&&o){try{u=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(p){const m=Lp(p.name||p.code||p,p.message);if(m.code===N.PERMISSION_DENIED)throw m;S.warning("getUserMedia failed in getDevices",m)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(s){try{a=await navigator.mediaDevices.getUserMedia({audio:e})}catch(p){const m=Lp(p.name||p.code||p,p.message);if(m.code===N.PERMISSION_DENIED)throw m;S.warning("getUserMedia failed in getDevices",m)}this.isAccessMicrophonePermission=!0}else if(o){try{c=await navigator.mediaDevices.getUserMedia({video:t})}catch(p){const m=Lp(p.name||p.code||p,p.message);if(m.code===N.PERMISSION_DENIED)throw m;S.warning("getUserMedia failed in getDevices",m)}this.isAccessCameraPermission=!0}S.debug("[device manager] mic permission",e,"cam permission",t)}try{const p=await navigator.mediaDevices.enumerateDevices();return a&&a.getTracks().forEach((m=>m.stop())),c&&c.getTracks().forEach((m=>m.stop())),u&&u.getTracks().forEach((m=>m.stop())),a=null,c=null,u=null,p}catch(p){return a&&a.getTracks().forEach((m=>m.stop())),c&&c.getTracks().forEach((m=>m.stop())),u&&u.getTracks().forEach((m=>m.stop())),a=null,c=null,u=null,new J(N.ENUMERATE_DEVICES_FAILED,p.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((t=>t.kind==="audioinput"))}async getCamerasDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter((t=>t.kind==="videoinput"))}async getSpeakers(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter((t=>t.kind==="audiooutput"))}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach((n=>{n.device.label===e&&(t=n.device.deviceId)})),t}async getDeviceById(e){const t=(await this.enumerateDevices(!0,!0,!0)).find((n=>n.deviceId===e));if(!t)throw new J(N.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=jl.INITING;try{await this.updateDevicesInfo(),this.state=jl.INITEND}catch(e){throw this.state=jl.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")?(S.warning("Device Detection functionality cannot start properly.",e.toString()),e):new J(N.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.")}}async updateDevicesInfo(){const e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),n=[];if(e[0]&&e[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const r=e.find((o=>o.kind==="audioinput"&&o.deviceId==="default")),s=e.find((o=>o.kind==="audiooutput"&&o.deviceId==="default"));r&&s?s.groupId===r.groupId?S.debug("[device-check] default input ".concat(r.label," and output ").concat(s.label," is the same group")):S.debug("[device-check] default input ".concat(r.label," and output ").concat(s.label," is not the same group")):S.debug("[device-check] default input or output not found")}const i=this.checkMediaDeviceInfoIsOk(e);if(e.forEach((r=>{if(!r.deviceId)return;const s=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((s?s.state:"INACTIVE")!=="ACTIVE"){const o={initAt:t,updateAt:t,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),o),n.push(o)}s&&(s.updateAt=t)})),this.deviceInfoMap.forEach(((r,s)=>{r.state==="ACTIVE"&&r.updateAt!==t&&(r.state="INACTIVE",n.push(r))})),this.state!==jl.INITEND)return i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach((r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Na.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Na.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Na.PLAYOUT_DEVICE_CHANGED,r)}})),i.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),i.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){const t=e.filter((r=>r.kind==="audioinput")),n=e.filter((r=>r.kind==="videoinput")),i={audio:!1,video:!1};for(const r of t)if(r.label&&r.deviceId){i.audio=!0;break}for(const r of n)if(r.label&&r.deviceId){i.video=!0;break}return i}};let wS=!1;const pi=new class extends Vt{constructor(){super(...arguments),q(this,"onAutoplayFailed",void 0),q(this,"onAudioAutoplayFailed",void 0)}};function ZO(){if(wS)return I("FLS_AUTOPLAY_EMITS")?(pi.onAutoplayFailed&&pi.onAutoplayFailed(),pi.emit("autoplay-failed")):void 0;{const e=t=>{t.preventDefault(),wS=!1,Dl()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};wS=!0,Dl()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),S.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),pi.onAutoplayFailed?pi.onAutoplayFailed():pi.onAudioAutoplayFailed?S.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):S.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),pi.emit("autoplay-failed")}}function $O(e,t,n,i){if(!e)return;const r=Se.getBaseInfoBySessionId(e);if(!r)return;const s=r.info,o=Date.now(),a=Ot(Ot({},s),{},{vid:s.vid===void 0?0:Number(s.vid),lts:o,elapse:o-r.startTime,cbRegistered:pi.onAutoplayFailed||pi.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:t,trackId:i,extend:void 0});Se.send({type:Mt.AUTOPLAY_FAILED,data:a},!0)}const cz=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Jn=new class{constructor(){q(this,"onAutoplayFailed",void 0),q(this,"elementMap",new Map),q(this,"elementStateMap",new Map),q(this,"elementsNeedToResume",[]),q(this,"sinkIdMap",new Map),q(this,"autoResumeAfterInterruption",(e=>de.all(Array.from(this.elementMap.entries()).map((async t=>{let[n,i]=t;const r=this.elementStateMap.get(n),s=i.srcObject.getAudioTracks()[0],o=s&&s.readyState;if(S.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(o," ").concat(e)),o==="live"){if(e)return i.pause(),i.play();if(yt.curState==="running")return qc()?(i.pause(),i.play()):r&&r==="paused"?i.play():void 0}}))))),q(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{Array.from(this.elementMap.entries()).forEach((e=>{let[t,n]=e;const i=n.srcObject.getAudioTracks()[0];i&&i.readyState==="live"&&(S.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())}))})),this.autoResumeAudioElement(),yt.on(Dn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),yt.on(Dn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),yt.on(Dn.STATE_CHANGE,(()=>{Yn()&&yt.prevState==="suspended"&&yt.curState==="running"&&this.autoResumeAfterInterruption()}))}async setSinkID(e,t){const n=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),n)try{await n.setSinkId(t)}catch(i){throw new J(N.PERMISSION_DENIED,"can not set sink id: "+i.toString())}}play(e,t,n,i){if(this.elementMap.has(t))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,r),this.elementMap.set(t,r),this.elementStateMap.set(t,Vn.INIT),this.setVolume(t,n);const s=this.sinkIdMap.get(t);if(s)try{r.setSinkId(s).catch((a=>{S.warning("[".concat(t,"] set sink id failed"),a.toString())}))}catch(a){S.warning("[".concat(t,"] set sink id failed"),a.toString())}const o=r.play();o&&o.then&&o.catch((a=>{i&&$O(i,"audio",a.message,t),S.warning("audio element play warning",a.toString()),this.elementMap.has(t)&&a.name==="NotAllowedError"&&(S.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),yp((()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),ZO()})))}))}updateTrack(e,t){const n=this.elementMap.get(e);n&&(n.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&this.elementStateMap.get(e)==="playing"}setVolume(e,t){const n=this.elementMap.get(e);n&&(t=Math.max(0,Math.min(100,t)),n.volume=t/100)}getVolume(e){const t=this.elementMap.get(e);return t?t.volume:0}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const n=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(n,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){cz.forEach((n=>{t.addEventListener(n,(i=>{const r=this.elementStateMap.get(e),s=i.type==="pause"?"paused":i.type;if(S.debug("[".concat(e,"] audio-element-status change ").concat(r," => ").concat(s)),i.type==="error"){const o=t?.error;o&&S.error("[".concat(e,"] media error, code: ").concat(o.code,", message: ").concat(o.message))}this.elementStateMap.set(e,s)}))}))}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach((t=>{t.play().then((n=>{S.debug("Auto resume audio element success")})).catch((n=>{S.warning("Auto resume audio element failed!",n)}))})),this.elementsNeedToResume=[]};new de((t=>{document.body?t():window.addEventListener("load",(()=>t()))})).then((()=>{Dl()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))}))}};function Kt(){return function(e,t,n){const i=n.value;return typeof i=="function"&&(n.value=function(){this._isClosed&&new J(N.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",S);for(var r=arguments.length,s=new Array(r),o=0;o<r;o++)s[o]=arguments[o];const a=i.apply(this,s);return a instanceof de?new de(((c,u)=>{a.then(c).catch(u)})):a}),n}}class eN extends Vt{constructor(t){super(),q(this,"name","VideoProcessorDestination"),q(this,"ID","0"),q(this,"_source",void 0),q(this,"videoContext",void 0),q(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new J(N.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new J(N.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(si.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(si.ON_TRACK,void 0)}}class tN extends Vt{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,n){super(),q(this,"constraintsMap",new Map),q(this,"statsRegistry",[]),q(this,"usageRegistry",[]),q(this,"trackId",void 0),q(this,"direction",void 0),q(this,"_chained",!1),this.trackId=t,this.direction=n}async getConstraints(){return await sn(this,Gi.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,n){var i;return S.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(n,t),wt(this,Gi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Ii(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var n;if(this.constraintsMap.has(t))return S.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),wt(this,Gi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Ii(n=this.constraintsMap).call(n)))}registerStats(t,n,i){this.statsRegistry.find((r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n))||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:n,cb:i})}unregisterStats(t,n){const i=this.statsRegistry.findIndex((r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n));i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:n,processorName:i,type:r,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:n,processorName:i,type:r,stats:o})}catch(o){S.error(new J(N.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,n){this.usageRegistry.find((i=>i.processorID===t.ID&&i.processorName===t.name))||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:n})}unregisterUsage(t){const n=this.usageRegistry.findIndex((i=>i.processorID===t.ID&&i.processorName===t.name));n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof de&&(i=await i),t.push(Ot(Ot({},i),{},{direction:this.direction}))}catch(i){S.error("gather extension usage error",i)}return t}getDirection(){return this.direction}}class nN extends Vt{constructor(t){super(),q(this,"name","AudioProcessorDestination"),q(this,"ID","0"),q(this,"inputTrack",void 0),q(this,"inputNode",void 0),q(this,"audioProcessorContext",void 0),q(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new J(N.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new J(N.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(si.ON_TRACK,void 0),this.emit(si.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(si.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(si.ON_NODE,this.inputNode))}}class iN extends Vt{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,n,i){super(),q(this,"constraintsMap",new Map),q(this,"statsRegistry",[]),q(this,"audioContext",void 0),q(this,"trackId",void 0),q(this,"direction",void 0),q(this,"usageRegistry",[]),q(this,"_chained",!1),this.audioContext=t,this.trackId=n,this.direction=i}async getConstraints(){return sn(this,Gi.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,n){var i;return S.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(n,t),wt(this,Gi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Ii(i=this.constraintsMap).call(i)))}async requestRevertConstraints(t){var n;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),wt(this,Gi.REQUEST_UPDATE_CONSTRAINTS,Array.from(Ii(n=this.constraintsMap).call(n)))}registerStats(t,n,i){this.statsRegistry.find((r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n))||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:n,cb:i})}unregisterStats(t,n){const i=this.statsRegistry.findIndex((r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n));i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:n,processorName:i,type:r,cb:s}of this.statsRegistry)try{const o=s();t.push({processorID:n,processorName:i,type:r,stats:o})}catch(o){S.error(new J(N.UNEXPECTED_ERROR,o.message))}return t}registerUsage(t,n){this.usageRegistry.find((i=>i.processorID===t.ID&&i.processorName===t.name))||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:n})}unregisterUsage(t){const n=this.usageRegistry.findIndex((i=>i.processorID===t.ID&&i.processorName===t.name));n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof de&&(i=await i),t.push(Ot(Ot({},i),{},{direction:this.direction}))}catch(i){S.error("gather extension usage error",i)}return t}getDirection(){return this.direction}}class AS extends Vt{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),q(this,"context",void 0),q(this,"processSourceNode",void 0),q(this,"outputTrack",void 0),q(this,"processedNode",void 0),q(this,"clonedTrack",void 0),q(this,"outputNode",void 0),this.outputNode=new dz}setVolume(){}createOutputTrack(){throw new J(N.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class dz{disconnect(){}connect(){}}function rN(e){return new de(((t,n)=>{let i=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const s=Yn()?"canplay":"playing";r.addEventListener(s,(()=>{const o=r.videoWidth,a=r.videoHeight;!o&&Nt()||(i=!0,r.srcObject=null,r.remove(),t([o,a]))})),r.srcObject=new MediaStream([e]),r.play().catch(kl),setTimeout((()=>{i||(r.srcObject=null,r.remove(),t([r.videoWidth,r.videoHeight]))}),4e3)}))}function kp(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const n=br(e.encoderConfig);return n.width!=null&&(t.width=n.width),n.height!=null&&(t.height=n.height),!Q0()&&n.frameRate&&(t.frameRate=n.frameRate),G0()&&typeof t.frameRate=="object"&&(t.frameRate.max=60),Nt()&&(t.frameRate={ideal:30,max:30}),t}function sN(e){const t={};return Q0()||(e.AGC!==void 0&&(t.autoGainControl=e.AGC),e.AEC!==void 0&&(t.echoCancellation=e.AEC),e.ANS!==void 0&&(t.noiseSuppression=e.ANS,Xs()&&e.ANS&&(t.googHighpassFilter=e.ANS))),t}function oN(e){const t=sN(e);if(e.encoderConfig){const n=Dp(e.encoderConfig);t.channelCount=n.stereo?2:1,t.sampleRate=n.sampleRate,t.sampleSize=n.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),Nl()&&(t.sampleRate=void 0),t}const aN=e=>{const t=e._encoderConfig;if(!t)return;const{frameRate:n,width:i,height:r}=e.getMediaStreamTrackSettings();let{frameRate:s=n,width:o=i,height:a=r}=t;if(!s||!o||!a)return;o=Qc(o),a=Qc(a),s=Qc(s);const{max:c,min:u}=(function(g,b,v){const R=200*Math.pow(v/15,.6)*Math.pow(g*b/640/360,.75);return{min:Math.floor(R),max:Math.floor(4*R)}})(o,a,s),{bitrateMax:p,bitrateMin:m}=t||{};p||S.debug("calculate bitrate: [w: ".concat(o,", h: ").concat(a,", fps: ").concat(s,"] => [brMax: ").concat(p,", brMin: ").concat(m,"]"));const{maxFramerate:_}=I("ENCODER_CONFIG_LIMIT");return _&&typeof _=="number"&&(s=Math.min(s,_)),{frameRate:s,bitrateMax:p||c,bitrateMin:m||u,scaleResolutionDownBy:1,scale:0}},cN=async(e,t,n)=>await(async(i,r,s)=>{const o=(function(u){const p=[];for(let m=0;m<u.length;m+=2)p.push(parseInt(u.slice(m,m+2),16));return Uint8Array.from(p)})(gO(""+r+s)).slice(0,16),a=o.slice(0,12),c=await window.crypto.subtle.importKey("raw",o,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,i))})(e.buffer,t,n),IS=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new de(((n,i)=>{t.toBlob((async r=>{if(t.remove(),r){const s=await dN(r);n({buffer:s,width:t.width,height:t.height})}else i(new J(N.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,1)}))},dN=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)};var lN,uN,hN,pN,mN,fN,_N,gN,EN,SN,yN,TN,vN,RN,CN,bN,wN,AN,Bt,IN,ON,NN,DN,PN,LN,vs,kN,xN,MN,UN,VN,jN,FN,BN,WN,GN,HN,KN,YN,Mn;let Yt=(lN=Ae({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),uN=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),hN=Kt(),pN=Zc("LocalAudioTrack","_enabledMutex"),mN=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),fN=Kt(),_N=Zc("LocalAudioTrack","_enabledMutex"),gN=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),EN=Kt(),SN=Kt(),yN=Kt(),TN=Ae({argsMap:e=>[e.getTrackId()]}),vN=Kt(),RN=Ae({argsMap:e=>[e.getTrackId()]}),CN=Kt(),bN=Ae({argsMap:e=>[e.getTrackId()]}),wN=Ae({argsMap:(e,t)=>[e.getTrackId(),t.name]}),AN=Ae({argsMap:e=>[e.getTrackId()]}),tt((Bt=class extends od{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?Jn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,n,i){super(e,n),q(this,"trackMediaType",sd.AUDIO),q(this,"_encoderConfig",void 0),q(this,"_trackSource",void 0),q(this,"metadata",[]),q(this,"_enabled",!0),q(this,"_volume",100),q(this,"_useAudioElement",!0),q(this,"_bypassWebAudio",!1),q(this,"processor",void 0),q(this,"_processorContext",void 0),q(this,"_processorDestination",void 0),q(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!i,this._trackSource=new AS,I("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),I("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Rn()&&!Hi?setTimeout((()=>this.initWebAudio())):this.initWebAudio()}setVolume(e){Rt(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&Jn.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void S.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,wt(this,ye.NEED_REPLACE_TRACK,this).then((()=>{S.debug("[".concat(this.getTrackId(),"] replace web audio track success"))})).catch((n=>{S.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)})))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!xO())throw new J(N.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Jn.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,n){return this._setEnabled(e,t,n)}async _setEnabled(e,t,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await wt(this,ye.NEED_ENABLE_TRACK,this),S.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(i){throw n||(this._enabled=!1),S.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await wt(this,ye.NEED_DISABLE_TRACK,this)}catch(i){throw n||(this._enabled=!0),S.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,S.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await wt(this,ye.NEED_MUTE_TRACK,this):await wt(this,ye.NEED_UNMUTE_TRACK,this))}getStats(){return wo((()=>{S.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")}),"localAudioTrackGetStatsWarning"),Di(this,ye.GET_STATS)||Ot({},ES)}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Wi.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Wi.ON_AUDIO_BUFFER),this._source.on(Wi.ON_AUDIO_BUFFER,(n=>e(n)))}play(){S.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(S.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Jn.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){S.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Jn.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];S.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Jn.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await wt(this,ye.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return de.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new J(N.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new J(N.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(e){e.on(si.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await wt(this,ye.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await wt(this,ye.NEED_REPLACE_TRACK,this))})),e.on(si.ON_NODE,(t=>{this._source.processedNode=t}))}unbindProcessorDestinationEvents(e){e.removeAllListeners(si.ON_TRACK),e.removeAllListeners(si.ON_NODE)}bindProcessorContextEvents(e){e.on(Gi.REQUEST_CONSTRAINTS,(async t=>{t(this._originMediaStreamTrack.getSettings())}))}unbindProcessorContextEvents(e){e.removeAllListeners(Gi.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof AS&&(this._trackSource=new CS(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new iN(this._source.context,this.getTrackId(),"local"),t=new nN(e);return this._processorContext=e,this._processorDestination=t,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(t),this._source.on(Wi.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})})),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(Jn.stop(this.getTrackId()),this._source.play()),wt(this,ye.NEED_REPLACE_MIXING_TRACK,this).then((()=>{S.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))})).catch((n=>{S.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n)}))),{processorContext:e,processorDestination:t}}}).prototype,"setVolume",[lN],Object.getOwnPropertyDescriptor(Bt.prototype,"setVolume"),Bt.prototype),tt(Bt.prototype,"setPlaybackDevice",[uN,hN],Object.getOwnPropertyDescriptor(Bt.prototype,"setPlaybackDevice"),Bt.prototype),tt(Bt.prototype,"setEnabled",[pN,mN,fN],Object.getOwnPropertyDescriptor(Bt.prototype,"setEnabled"),Bt.prototype),tt(Bt.prototype,"setMuted",[_N,gN,EN],Object.getOwnPropertyDescriptor(Bt.prototype,"setMuted"),Bt.prototype),tt(Bt.prototype,"getStats",[SN],Object.getOwnPropertyDescriptor(Bt.prototype,"getStats"),Bt.prototype),tt(Bt.prototype,"setAudioFrameCallback",[yN],Object.getOwnPropertyDescriptor(Bt.prototype,"setAudioFrameCallback"),Bt.prototype),tt(Bt.prototype,"play",[TN,vN],Object.getOwnPropertyDescriptor(Bt.prototype,"play"),Bt.prototype),tt(Bt.prototype,"stop",[RN,CN],Object.getOwnPropertyDescriptor(Bt.prototype,"stop"),Bt.prototype),tt(Bt.prototype,"close",[bN],Object.getOwnPropertyDescriptor(Bt.prototype,"close"),Bt.prototype),tt(Bt.prototype,"pipe",[wN],Object.getOwnPropertyDescriptor(Bt.prototype,"pipe"),Bt.prototype),tt(Bt.prototype,"unpipe",[AN],Object.getOwnPropertyDescriptor(Bt.prototype,"unpipe"),Bt.prototype),Bt),Fl=(IN=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),ON=Kt(),NN=Zc("MicrophoneAudioTrack","_enabledMutex"),DN=Ae({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),PN=Kt(),LN=Ae({argsMap:e=>[e.getTrackId()]}),tt((vs=class extends Yt{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,n,i){super(e,t.encoderConfig?Dp(t.encoderConfig):{},i,I("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),q(this,"_config",void 0),q(this,"_deviceName","default"),q(this,"_constraints",void 0),q(this,"_originalConstraints",void 0),q(this,"_enabled",!0),this._config=t,this._constraints=n,this._originalConstraints=n,this._deviceName=e.label,typeof t.bypassWebAudio=="boolean"&&(this._bypassWebAudio=t.bypassWebAudio),(qc()||KE())&&yt.bindInterruptDetectorTrack(this)}async setDevice(e){if(S.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await Yi.getDeviceById(e),n={};n.audio=Ot({},this._constraints),n.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let i=null;try{i=await Ki(n,this.getTrackId())}catch(r){throw S.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),i=await Ki({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const t=await Yi.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}S.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,n){if(t)return S.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),e),I("AUTO_RESET_AUDIO_ROUTE")&&(Yn()||yr())){const o=navigator.audioSession;o&&(e||(o.type="playback"),o.type="auto")}if(!e){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(i=this._source.clonedTrack)===null||i===void 0||i.stop(),n||(this._enabled=!1);try{await wt(this,ye.NEED_DISABLE_TRACK,this)}catch(o){throw S.error("[".concat(this.getTrackId(),"] setEnabled false failed"),o.toString()),o}return}const r=Ot({},this._constraints),s=Yi.searchDeviceIdByName(this._deviceName);s&&!r.deviceId&&(r.deviceId=s);try{n||(this._enabled=!0);const o=await Ki({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(o.getAudioTracks()[0],!1),await wt(this,ye.NEED_ENABLE_TRACK,this)}catch(o){throw n||(this._enabled=!1),S.error("[".concat(this.getTrackId(),"] setEnabled true failed"),o.toString()),o}S.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(qc()||KE())&&yt.unbindInterruptDetectorTrack(this),Ia.some((e=>(function(t){return"__className__"in t&&t.__className__==="MicrophoneAudioTrack"})(e)))||TS&&TS()&&(Se.reportApiInvoke(null,{name:"BG_AUDIO_TAG_RESTART",options:{},tag:Ct.TRACER}).onSuccess(),S.debug("restart background audio tag success"))}onTrackEnded(){if((Yn()||yr())&&this._enabled&&!this._isClosed&&yt.duringInterruption){const e=async()=>{yt.off(Dn.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(S.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};yt.on(Dn.IOS_INTERRUPTION_END,e)}else S.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(rd.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,n=Yi.searchDeviceIdByName(this._deviceName);if(n&&!t.deviceId&&(t.deviceId=n),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const i=await Ki({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(Gi.REQUEST_UPDATE_CONSTRAINTS,(async(t,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}}))}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(Gi.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[IN,ON],Object.getOwnPropertyDescriptor(vs.prototype,"setDevice"),vs.prototype),tt(vs.prototype,"setEnabled",[NN,DN,PN],Object.getOwnPropertyDescriptor(vs.prototype,"setEnabled"),vs.prototype),tt(vs.prototype,"close",[LN],Object.getOwnPropertyDescriptor(vs.prototype,"close"),vs.prototype),vs),lz=(kN=Ae({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),xN=Kt(),MN=Ae({argsMap:e=>[e.getTrackId()]}),UN=Kt(),VN=Ae({argsMap:e=>[e.getTrackId()]}),jN=Kt(),FN=Ae({argsMap:e=>[e.getTrackId()]}),BN=Kt(),WN=Ae({argsMap:e=>[e.getTrackId()]}),GN=Kt(),HN=Ae({argsMap:e=>[e.getTrackId()]}),KN=Ae({argsMap:e=>[e.getTrackId()]}),YN=Kt(),tt((Mn=class extends Yt{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,n,i){super(t.createOutputTrack(),n,i),q(this,"source",void 0),q(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=t,this._bufferSource.on(Wi.AUDIO_SOURCE_STATE_CHANGE,(r=>{this.safeEmit(rd.SOURCE_STATE_CHANGE,r)}));try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){Rt(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}).prototype,"startProcessAudioBuffer",[kN,xN],Object.getOwnPropertyDescriptor(Mn.prototype,"startProcessAudioBuffer"),Mn.prototype),tt(Mn.prototype,"pauseProcessAudioBuffer",[MN,UN],Object.getOwnPropertyDescriptor(Mn.prototype,"pauseProcessAudioBuffer"),Mn.prototype),tt(Mn.prototype,"seekAudioBuffer",[VN,jN],Object.getOwnPropertyDescriptor(Mn.prototype,"seekAudioBuffer"),Mn.prototype),tt(Mn.prototype,"resumeProcessAudioBuffer",[FN,BN],Object.getOwnPropertyDescriptor(Mn.prototype,"resumeProcessAudioBuffer"),Mn.prototype),tt(Mn.prototype,"stopProcessAudioBuffer",[WN,GN],Object.getOwnPropertyDescriptor(Mn.prototype,"stopProcessAudioBuffer"),Mn.prototype),tt(Mn.prototype,"close",[HN],Object.getOwnPropertyDescriptor(Mn.prototype,"close"),Mn.prototype),tt(Mn.prototype,"setAudioBufferPlaybackSpeed",[KN,YN],Object.getOwnPropertyDescriptor(Mn.prototype,"setAudioBufferPlaybackSpeed"),Mn.prototype),Mn);class dn extends Yt{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=ad().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,mt(8,"track-mix-")),q(this,"trackList",void 0),q(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(S.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):S.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){S.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}Sp(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach((n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(t.stereo=!0))})),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach((n=>{n instanceof dn?n.emit(Oa.TRANSCEIVER_UPDATED,t):n._updateRtpTransceiver(t)})))}}class uz extends zO{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(Wi.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),q(this,"audioBuffer",void 0),q(this,"sourceNode",void 0),q(this,"startPlayTime",0),q(this,"startPlayOffset",0),q(this,"pausePlayTime",0),q(this,"options",void 0),q(this,"currentLoopCount",0),q(this,"currentPlaybackSpeed",100),q(this,"_currentState","stopped"),this.audioBuffer=t,this.options=n,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){this.currentState==="stopped"?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):S.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=t,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const zN=new Map;function qN(e,t){if(e.length===0||t.length===0)return 1/0;const n=tS(e),i=tS(t);return Math.floor(i/n)}class OS{get rendFrameRate(){const t=Math.max(1,qN(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/t)}get videoElementStatus(){return this._isInPage?this._videoElementStatus:Vn.DESTROYED}set videoElementStatus(t){t!==this._videoElementStatus&&(S.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}get videoState(){return this._videoState}set videoState(t){var n;t!==this._videoState&&(this._videoState=t,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState))}constructor(t){q(this,"trackId",void 0),q(this,"config",void 0),q(this,"onFirstVideoFrameDecoded",void 0),q(this,"onFirstVideoFrameRender",void 0),q(this,"onVideoBufferReady",void 0),q(this,"onVideoStateChanged",void 0),q(this,"freezeTimeCounterList",[]),q(this,"renderFreezeAccTime",0),q(this,"renderFreezeAccTime2",0),q(this,"isKeepLastFrame",!1),q(this,"isDestroyed",!1),q(this,"timeUpdatedCount",0),q(this,"freezeTime",0),q(this,"playbackTime",0),q(this,"lastTimeUpdatedTime",0),q(this,"autoplayFailed",!1),q(this,"videoTrack",void 0),q(this,"videoElement",void 0),q(this,"cacheVideoElement",void 0),q(this,"cancelRVFId",void 0),q(this,"internal",!1),q(this,"_render_interframe_delays",[]),q(this,"_render_interframe_delays_sizes",[]),q(this,"_videoState",Ts.VideoStateStopped),q(this,"videoElementCheckInterval",void 0),q(this,"videoElementFreezeTimeout",void 0),q(this,"_videoElementStatus",Vn.NONE),q(this,"_isInPage",!0),q(this,"isGettingVideoDimensions",!1),q(this,"startGetVideoDimensions",(()=>{const n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return S.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()})),q(this,"autoResumeAfterInterruption",(()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&yt.curState==="running"&&(S.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(B0())),X0()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),q(this,"handleVideoEvents",(n=>{switch(n.type){case"play":case"playing":n.type==="play"&&S.debug("[".concat(this.trackId,"] video element status: play")),this.startGetVideoDimensions(),this.videoElementStatus=Vn.PLAYING;break;case"loadeddata":if(this.videoState=Ts.VideoStateStarting,this.onFirstVideoFrameRender&&this.onFirstVideoFrameRender(),this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Vn.CANPLAY;break;case"stalled":this.videoElementStatus=Vn.STALLED;break;case"suspend":this.videoElementStatus=Vn.SUSPEND;break;case"pause":this.videoElementStatus=Vn.PAUSED,Yn()||yr()||Rn()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(S.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Vn.WAITING;break;case"abort":this.videoElementStatus=Vn.ABORT;break;case"ended":this.videoElementStatus=Vn.ENDED;break;case"emptied":this.videoElementStatus=Vn.EMPTIED;break;case"error":{const i=this.videoElement.error;i&&(this.videoElementStatus=Vn.ERROR,S.error("[".concat(this.trackId,"] media error: ").concat(i.message," (").concat(i.code,")")));break}case"timeupdate":{const i=performance.now();if(this.timeUpdatedCount+=1,this.onVideoBufferReady&&this.timeUpdatedCount>I("BUFFER_READY_FRAMES")&&this.onVideoBufferReady(),this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=i);const r=i-this.lastTimeUpdatedTime,s=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=i,Pi.lastVisibleTime<Pi.lastHiddenTime||s<Pi.lastHiddenTime||s<Pi.lastVisibleTime||this.isSkipCalcRenderFreezeTime())return;for(r>I("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;const o=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(o),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}})),q(this,"autoResumeAfterInterruptionOnIOS15_16",(()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(S.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(B0())),X0()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))})),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),yt.on(Dn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),yt.on(Dn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const n=this.videoElement.play();n&&n.catch&&n.catch((r=>{t&&$O(t,"video",r.message,this.trackId),r.name==="NotAllowedError"?(S.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):S.warning("[".concat(this.trackId,"] play warning: "),r)}));const i=st();if((i.name==="Safari"&&Number(i.version)===15||qc())&&n&&n.then){const r=()=>{this.config.mirror&&!this.config.noStyle&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(r).catch(r)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const n=t.getContext("2d");if(!n)return S.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,t.width,t.height);const i=n.getImageData(0,0,t.width,t.height);return t.remove(),i}async getCurrentFrameToUint8Array(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const r=i.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,i.width,i.height),new de(((s,o)=>{i.toBlob((async a=>{if(i.remove(),a){const c=await dN(a);s({buffer:c,width:i.width,height:i.height})}else o(new J(N.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),t,n<0?.1:n>1?1:n)}))):await IS(t)}destroy(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this.isDestroyed=!0,yt.off(Dn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),yt.off(Dn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),t?this.videoElement.pause():this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Ts.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=Vn.INIT,!this.videoElementCheckInterval&&(XN.forEach((s=>{this.videoElement.addEventListener(s,this.handleVideoEvents)})),this.videoElementCheckInterval=window.setInterval((()=>{this._isInPage=(function(s){return s!==document.body&&document.body.contains(s)})(this.videoElement)}),1e3),I("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,n;let s;const o=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",o),this.videoElementFreezeTimeout=window.setTimeout(a,I("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Ts.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Ts.VideoStateFrozen:document.addEventListener("visibilitychange",o))},c=(u,p)=>{if(this.videoElementStatus===Vn.PLAYING){if(s){const g=p.presentationTime-s.presentationTime,b=p.presentedFrames-s.presentedFrames;this._render_interframe_delays_sizes.push(b),this._render_interframe_delays.push(g);const v=tS(this._render_interframe_delays_sizes),R=v-this._render_interframe_delays_sizes[0];if(v>30&&R>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===Ts.VideoStateStarting&&(this.videoState=Ts.VideoStateDecoding),this.videoState===Ts.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,I("VIDEO_FREEZE_DURATION"))),g<I("VIDEO_FREEZE_DURATION")&&this.videoState===Ts.VideoStateFrozen&&(this.videoState=Ts.VideoStateDecoding),g>I("VIDEO_FREEZE_DURATION")&&Pi.lastVisibleTime>=Pi.lastHiddenTime&&s.timestamp>Pi.lastVisibleTime&&s.timestamp>Pi.lastHiddenTime){const O=Math.min(66,qN(this._render_interframe_delays_sizes,this._render_interframe_delays)),D=Math.max(0,g-(b-1)*O);this.renderFreezeAccTime2+=D>O?D:0,this.renderFreezeAccTime+=g}}s=Ot(Ot({},p),{},{timestamp:u})}else this.isSkipCalcRenderFreezeTime()&&(s=Ot(Ot({},p),{},{timestamp:u}));var m,_;I("ENABLE_VIDEO_FRAME_CALLBACK")&&(this.cancelRVFId=(m=(_=this.videoElement).requestVideoFrameCallback)===null||m===void 0?void 0:m.call(_,c))};this.cancelRVFId=(t=(n=this.videoElement).requestVideoFrameCallback)===null||t===void 0?void 0:t.call(n,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),Nl()&&!I("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const i=st();this.config.noStyle||(i.name==="Safari"&&Number(i.version)===15||qc()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover"),this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Nt()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Nt()&&this.videoElement.load());const r=this.videoElement.play();r!==void 0&&r.catch((s=>{S.debug("[".concat(this.trackId,"] playback interrupted"),s.toString())}))}resetVideoElement(){var t,n;XN.forEach((i=>{this.videoElement&&this.videoElement.removeEventListener(i,this.handleVideoEvents)})),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.cancelRVFId&&this.videoElement&&((t=(n=this.videoElement).cancelVideoFrameCallback)===null||t===void 0||t.call(n,this.cancelRVFId),this.cancelRVFId=void 0),this.videoElementStatus=Vn.NONE}isSkipCalcRenderFreezeTime(){return this.videoElementStatus===Vn.DESTROYED||this.internal}handleAutoPlayFailed(){const t=n=>{n.preventDefault(),this.videoElement.play().then((()=>{S.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))})).catch((i=>{S.error(i)})),this.autoplayFailed=!1,Dl()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};Dl()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),ZO()}}const XN=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class xp extends OS{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];super(t),q(this,"container",void 0),q(this,"slot",void 0),this.slot=t.element,this.internal=n,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const n=t.element;var i;!this.internal||this.slot?(n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()):(this.slot=n,n&&this.container?(this.internal=!1,this.container.id="agora-video-player-".concat(this.trackId),this.videoElement.id="video_".concat(this.trackId),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",(i=this.slot)===null||i===void 0||i.appendChild(this.container)):this.createElements())}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var n;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,i):await IS(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{var t;this.container.remove(),(t=this.slot)===null||t===void 0||t.removeChild(this.container)}catch{}this.container=void 0}}createElements(){var t;this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",I("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),(t=this.slot)===null||t===void 0||t.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var JN,QN,ZN,$N,eD,tD,nD,iD,rD,sD,oD,aD,cD,dD,lD,uD,hD,pD,mD,fD,_D,gD,ED,SD,yD,TD,vD,RD,Je,CD,bD,wD,AD,ID,OD,ND,DD,zi;let bt=(JN=Ae({argsMap:(e,t,n)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),QN=Kt(),ZN=Ae({argsMap:e=>[e.getTrackId()]}),$N=Zc("LocalVideoTrack","_enabledMutex"),eD=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),tD=Kt(),nD=Zc("LocalVideoTrack","_enabledMutex"),iD=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),rD=Kt(),sD=Ae({argsMap:(e,t)=>[e.getTrackId(),t,e._saveEncodeBitrateRatio]}),oD=Kt(),aD=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),cD=Kt(),dD=Kt(),lD=Ae({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),uD=Kt(),hD=Kt(),pD=Kt(),mD=Ae({argsMap:e=>[e.getTrackId()]}),fD=Kt(),_D=Kt(),gD=Kt(),ED=Kt(),SD=Kt(),yD=Ae({argsMap:(e,t)=>[e.getTrackId(),t.name]}),TD=Ae({argsMap:e=>[e.getTrackId()]}),vD=Ae({argsMap:e=>[e.getTrackId()]}),RD=Ae({argsMap:(e,t,n)=>[e.getTrackId(),t.label,n]}),Je=class y2 extends od{get videoHeight(){if(Rn()){const{height:t}=this._mediaStreamTrack.getSettings();return this._videoHeight=t,this._videoHeight}return this._videoHeight}get videoWidth(){if(Rn()){const{width:t}=this._mediaStreamTrack.getSettings();return this._videoWidth=t,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Vn.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,n,i,r,s,o){if(super(t,s),q(this,"trackMediaType",sd.VIDEO),q(this,"_player",void 0),q(this,"isUseScaleResolutionDownBy",!1),q(this,"_videoVisibleTimer",null),q(this,"_previousVideoVisibleStatus",void 0),q(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),q(this,"_encoderConfig",void 0),q(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),q(this,"_optimizationMode",void 0),q(this,"_saveEncodeBitrateRatio",1),q(this,"_videoHeight",void 0),q(this,"_videoWidth",void 0),q(this,"_forceBitrateLimit",void 0),q(this,"_enabled",!0),q(this,"_processorDestination",void 0),q(this,"_processorContext",void 0),Rn()){const{width:a,height:c}=t.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=i,this._optimizationMode=r,this._hints=o||[],n&&this._hints.indexOf(ht.CUSTOM_TRACK)!==-1?this._encoderConfig=Dt(n):this._encoderConfig=n,this._hints.indexOf(ht.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(WE(at.CHROME,115)&&gp().indexOf("Windows")!==-1){const a=(function(c,u){if("VideoFrame"in window&&"TransformStream"in window&&Xe().supportWebRTCInsertableStream){const p=new MediaStreamTrackProcessor(c),m=new MediaStreamTrackGenerator({kind:"video"});let _,g,b=Date.now();const v=()=>{R&&(clearInterval(R),R=void 0),_&&(_.close(),_=void 0),c.stop(),g=void 0,m.removeEventListener("ended",v)};let R=window.setInterval((()=>{if(g&&_&&Date.now()-b>1e3)try{m.readyState==="live"?g.enqueue(_.clone()):v()}catch{v()}}),1e3);const O=new TransformStream({transform:(D,x)=>{m.readyState==="live"?(g=x,b=Date.now(),_===void 0?(_=D,x.enqueue(D.clone())):(x.enqueue(_),_=D)):D.close()}});return m.addEventListener("ended",v),p.readable.pipeThrough(O).pipeTo(m.writable),m}})(t);a&&(S.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}n&&this._hints.indexOf(ht.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new tN(this.getTrackId(),"local"),this._processorDestination=new eN(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const r=document.getElementById(t);r?t=r:(S.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}S.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const i=Ot(Ot(Ot({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new OS(i):this._player=new xp(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(rd.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}}),I("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,S.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await wt(this,ye.NEED_DISABLE_TRACK,this)}catch(i){throw S.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}return n||(this._enabled=!1),void S.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await wt(this,ye.NEED_ENABLE_TRACK,this)}catch(i){throw S.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}S.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,S.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await wt(this,ye.NEED_MUTE_TRACK,this):await wt(this,ye.NEED_UNMUTE_TRACK,this))}async setSaveEncodeBitrateRatio(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this._saveEncodeBitrateRatio;if(this._saveEncodeBitrateRatio!==1&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*t),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*t),S.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(t)),this._saveEncodeBitrateRatio=1;try{await wt(this,ye.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(S)}}}async setEncoderConfiguration(t,n){if(!this._enabled)throw new J(N.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t=br(t),I("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const i=kp({encoderConfig:t});(Rn()||Yn()||yr())&&(i.deviceId=void 0),S.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(r){const s=new J(N.UNEXPECTED_ERROR,r.toString());throw S.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}}this._encoderConfig=t,this._hints.indexOf(ht.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await wt(this,ye.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(S)}}getStats(){return wo((()=>{S.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")}),"localVideoTrackGetStatsWarning"),Di(this,ye.GET_STATS)||Ot({},SS)}async setBeautyEffect(t){S.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,n):await IS(t)}async findClosestProfile(){const{width:t,height:n,frameRate:i}=this.getMediaStreamTrackSettings(),{width:r,height:s,frameRate:o}=this._encoderConfig||{},a=Qc(this._videoWidth||t||r||0),c=Qc(this._videoHeight||n||s||0),u=(function(p,m,_){if(!Array.isArray(I("VIDEO_ENCODER_CONFIG_LIST"))||I("VIDEO_ENCODER_CONFIG_LIST").length===0)return!1;const g=Math.min(p,m);return!(g>=480)&&Ot(Ot({},I("VIDEO_ENCODER_CONFIG_LIST").find((b=>b.height>g))),{},{frameRate:_})})(a,c,Qc(i||o||15));if(u)return S.debug("[".concat(this.getTrackId(),"] find closest profile, ").concat(a,"x").concat(c," => ").concat(JSON.stringify(u))),this.setEncoderConfiguration(u)}async setBitrateLimit(t){S.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t&&(this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate))}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void S.error(N.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const n=this._optimizationMode;try{this._optimizationMode=t,await wt(this,ye.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(i){throw this._optimizationMode=n,S.error("[".concat(this.getTrackId(),"] set optimization mode failed"),i.toString()),i}S.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return S.error(N.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,S.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){rN(this._originMediaStreamTrack).then((t=>{let[n,i]=t;this._videoHeight=i,this._videoWidth=n})).catch(kl)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new J(N.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");S.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=br(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf(ht.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await wt(this,ye.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(S)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:n,frameRate:i}=this.getMediaStreamTrackSettings();if(!t||!n||!i)return;const{bitrateMax:r,bitrateMin:s}=this._encoderConfig;if(s==null||r==null){const{max:o,min:a}=(function(c,u,p,m,_){const g=I("BITRATE_ADAPTER_TYPE");if(g==="DEFAULT_BITRATE")return{min:m,max:_};if(_===void 0){const b=Math.floor(200*Math.pow(p/15,.6)*Math.pow(c*u/640/360,.75));_=g==="STANDARD_BITRATE"?4*b:2*b,m=m??b}else m=m??Math.floor(_/10);return{min:m,max:_}})(t,n,i,s,r);if(this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=o,I("VIDEO_STANDARD_BITRATE_VERSION")&&s==null&&r==null){const[c,u]=(function(p,m,_){const g=4*Math.floor(2e5*Math.pow(_/15,.6)*Math.pow(p*m/230400,.75)),b=p*m,v=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),R=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]);let O=Ii(v).call(v).next().value,D=1;if(v.has(b))O=v.get(b);else{var x;const he=la(x=Array.from(v.entries())).call(x,((Oe,Ge)=>{let[Ue]=Oe,[ct]=Ge;return Ue-ct})),De=he.find((Oe=>{let[Ge]=Oe;return Ge>b}));if(De){const Oe=he.indexOf(De);if(Oe>0){const Ge=he[Oe-1],Ue=(b-Ge[0])/(De[0]-Ge[0]);O=Ge[1]+Ue*(De[1]-Ge[1])}else O=De[1]}else O=he[he.length-1][1]}if(R.has(b))D=R.get(b);else{var B;const he=la(B=Array.from(R.entries())).call(B,((Oe,Ge)=>{let[Ue]=Oe,[ct]=Ge;return Ue-ct})),De=he.find((Oe=>{let[Ge]=Oe;return Ge>b}));if(De){const Oe=he.indexOf(De);if(Oe>0){const Ge=he[Oe-1],Ue=(b-Ge[0])/(De[0]-Ge[0]);D=Ge[1]+Ue*(De[1]-Ge[1])}else D=De[1]}else D=he[he.length-1][1]}const G=I("VIDEO_NEW_BITRATE_RATIO");G&&G>0&&(O=G/100);const j=Math.floor(g*O),H=Math.floor(65e4*Math.pow(p*m/230400,.5)*Math.pow(_/15,.69));let Z=j;const ne=I("VIDEO_STANDARD_BITRATE_VERSION");return ne&&ne>0&&(ne===1?Z=g:ne===2?Z=j:ne===3&&(Z=H)),[Math.floor(Z/1e3),D]})(t,n,i);this._encoderConfig.bitrateMax=c,this._encoderConfig.bitrateMin=a?Math.min(a,c):c,this._saveEncodeBitrateRatio=u,S.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(t,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else S.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(o,", brMin: ").concat(a,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var t,n;const i=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),r={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:i?.parentElement},{element:s,slot:o}=r;if(this.isPlaying&&s instanceof HTMLVideoElement&&o instanceof HTMLElement){const a=iO.checkOneElementVisible(s),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const u=Se.reportApiInvoke(null,{tag:Ct.TRACER,name:xt.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?u.onSuccess("Video is visible"):u.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new J(N.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new J(N.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;t&&(i=Ot(Ot({},i),br(t))),i=Ra(i);const r=mt(8,"track-video-cloned-"),s=new y2(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,Ra(this._scalabilityMode),this._optimizationMode,r,Ra(this._hints));return t&&i&&s.setEncoderConfiguration(i),S.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),s}async replaceTrack(t,n){if(!(t instanceof MediaStreamTrack))throw new J(N.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new J(N.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,n,!0),this.updateMediaStreamTrackResolution()}sendSeiData(t){if(wo((()=>{Se.reportApiInvoke(null,{name:xt.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:Ct.TRACER}).onSuccess("")}),this._mediaStreamTrack.id||this.getTrackId()),!I("ENABLE_VIDEO_SEI")||!I("ENABLE_ENCODED_TRANSFORM"))return void S.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(t instanceof Uint8Array==0)return new J(N.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const n=this.getRTCRtpTransceiver();if(!n)return void S.warning("Video track is not published, SEI can not be send");const i=n.sender.getParameters();if(i.codecs.length===0)return;const r=i.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"||r==="video/h265"?this.safeEmit("sei-to-send",t):S.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(si.ON_TRACK,(async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await wt(this,ye.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await wt(this,ye.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(si.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Gi.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Gi.REQUEST_CONSTRAINTS)}},tt(Je.prototype,"play",[JN,QN],Object.getOwnPropertyDescriptor(Je.prototype,"play"),Je.prototype),tt(Je.prototype,"stop",[ZN],Object.getOwnPropertyDescriptor(Je.prototype,"stop"),Je.prototype),tt(Je.prototype,"setEnabled",[$N,eD,tD],Object.getOwnPropertyDescriptor(Je.prototype,"setEnabled"),Je.prototype),tt(Je.prototype,"setMuted",[nD,iD,rD],Object.getOwnPropertyDescriptor(Je.prototype,"setMuted"),Je.prototype),tt(Je.prototype,"setSaveEncodeBitrateRatio",[sD,oD],Object.getOwnPropertyDescriptor(Je.prototype,"setSaveEncodeBitrateRatio"),Je.prototype),tt(Je.prototype,"setEncoderConfiguration",[aD,cD],Object.getOwnPropertyDescriptor(Je.prototype,"setEncoderConfiguration"),Je.prototype),tt(Je.prototype,"getStats",[dD],Object.getOwnPropertyDescriptor(Je.prototype,"getStats"),Je.prototype),tt(Je.prototype,"setBeautyEffect",[lD,uD],Object.getOwnPropertyDescriptor(Je.prototype,"setBeautyEffect"),Je.prototype),tt(Je.prototype,"getCurrentFrameData",[hD],Object.getOwnPropertyDescriptor(Je.prototype,"getCurrentFrameData"),Je.prototype),tt(Je.prototype,"getCurrentFrameImage",[pD],Object.getOwnPropertyDescriptor(Je.prototype,"getCurrentFrameImage"),Je.prototype),tt(Je.prototype,"findClosestProfile",[mD,fD],Object.getOwnPropertyDescriptor(Je.prototype,"findClosestProfile"),Je.prototype),tt(Je.prototype,"setBitrateLimit",[_D],Object.getOwnPropertyDescriptor(Je.prototype,"setBitrateLimit"),Je.prototype),tt(Je.prototype,"setOptimizationMode",[gD],Object.getOwnPropertyDescriptor(Je.prototype,"setOptimizationMode"),Je.prototype),tt(Je.prototype,"setScalabiltyMode",[ED],Object.getOwnPropertyDescriptor(Je.prototype,"setScalabiltyMode"),Je.prototype),tt(Je.prototype,"updateMediaStreamTrackResolution",[SD],Object.getOwnPropertyDescriptor(Je.prototype,"updateMediaStreamTrackResolution"),Je.prototype),tt(Je.prototype,"pipe",[yD],Object.getOwnPropertyDescriptor(Je.prototype,"pipe"),Je.prototype),tt(Je.prototype,"unpipe",[TD],Object.getOwnPropertyDescriptor(Je.prototype,"unpipe"),Je.prototype),tt(Je.prototype,"close",[vD],Object.getOwnPropertyDescriptor(Je.prototype,"close"),Je.prototype),tt(Je.prototype,"replaceTrack",[RD],Object.getOwnPropertyDescriptor(Je.prototype,"replaceTrack"),Je.prototype),Je),Mp=(CD=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),bD=Kt(),wD=Zc("CameraVideoTrack","_enabledMutex"),AD=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),ID=Kt(),OD=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),ND=Kt(),DD=Ae({argsMap:e=>[e.getTrackId()]}),zi=class T2 extends bt{get __className__(){return"CameraVideoTrack"}constructor(t,n,i,r,s,o){super(t,br(n.encoderConfig),r,s,o),q(this,"_config",void 0),q(this,"_originalConstraints",void 0),q(this,"_constraints",void 0),q(this,"_enabled",!0),q(this,"_deviceName","default"),q(this,"tryResumeVideoForIOS15_16WeChat",(async()=>{(qc()||KE())&&!(function(){const a=st();if(a.os!==gn.IOS||!a.osVersion)return!1;const c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2})()&&J0()&&this._enabled&&!this._isClosed&&(S.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())})),this._config=n,this._originalConstraints=i,this._constraints=i,this._deviceName=t.label,this._encoderConfig=br(this._config.encoderConfig),yt.on(Dn.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),yt.on(Dn.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(S.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const n=await Yi.getDeviceById(t),i={};i.video=Ot({},this._constraints),i.video.deviceId={exact:t},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await Ki(i,this.getTrackId())}catch(s){throw S.error("[".concat(this.getTrackId(),"] setDevice failed"),s.toString()),r=await Ki({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),s}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(n){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await Yi.getDeviceById(t);this._deviceName=n.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(n){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}S.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){S.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));const n={video:Ot(Ot({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let i=null;try{i=await Ki(n,this.getTrackId())}catch(r){throw S.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),i=await Ki({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=Ot({},n.video),S.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const i=await Ki({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}await wt(this,ye.NEED_ENABLE_TRACK,this)}catch(i){throw S.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),S.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await wt(this,ye.NEED_DISABLE_TRACK,this)}catch(i){throw S.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}S.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,n){if(!this._enabled)throw new J(N.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t=br(t),I("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate||t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate||t.bitrateMin);const i=Dt(this._config);i.encoderConfig=t;const r=kp(i);(Rn()||Yn()||yr())&&(r.deviceId=void 0),S.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(s){const o=new J(N.UNEXPECTED_ERROR,s.toString());throw S.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}this._config=i,this._constraints=r,this._originalConstraints=r,this._encoderConfig=t,this._hints.indexOf(ht.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await wt(this,ye.NEED_UPDATE_VIDEO_ENCODER,this)}catch(s){return s.throw(S)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((Yn()||yr())&&this._enabled&&!this._isClosed&&yt.duringInterruption){const t=async()=>{yt.off(Dn.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(S.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};yt.on(Dn.IOS_INTERRUPTION_END,t)}else S.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(rd.TRACK_ENDED)}async renewMediaStreamTrack(t){const n=t||this._constraints,i=Yi.searchDeviceIdByName(this._deviceName);if(i&&!n.deviceId&&(n.deviceId={exact:i}),this._enabled){const r=await Ki({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),yt.off(Dn.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),yt.off(Dn.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;t&&(i=Ot(Ot({},i),br(t))),i=Ra(i);const r=mt(8,"track-cam-cloned-"),s=new T2(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,Ra(Ot(Ot({},this._config),{},{encoderConfig:i})),Ra(this._constraints),Ra(this._scalabilityMode),this._optimizationMode,r);return t&&i&&s.setEncoderConfiguration(i),S.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),s}bindProcessorContextEvents(){this.processorContext.on(Gi.REQUEST_UPDATE_CONSTRAINTS,(async(t,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}})),this.processorContext.on(Gi.REQUEST_CONSTRAINTS,(async t=>{t(this._originMediaStreamTrack.getSettings())}))}},tt(zi.prototype,"setDevice",[CD,bD],Object.getOwnPropertyDescriptor(zi.prototype,"setDevice"),zi.prototype),tt(zi.prototype,"setEnabled",[wD,AD,ID],Object.getOwnPropertyDescriptor(zi.prototype,"setEnabled"),zi.prototype),tt(zi.prototype,"setEncoderConfiguration",[OD,ND],Object.getOwnPropertyDescriptor(zi.prototype,"setEncoderConfiguration"),zi.prototype),tt(zi.prototype,"close",[DD],Object.getOwnPropertyDescriptor(zi.prototype,"close"),zi.prototype),zi);function PD(e){const t=mt(8,"track-cus-"),n=Se.reportApiInvoke(null,{id:t,tag:Ct.TRACER,name:xt.CREATE_CUSTOM_AUDIO_TRACK,options:[e]}),i=new Yt(e.mediaStreamTrack,e.encoderConfig?Dp(e.encoderConfig):{},t,!1);return S.info("create custom audio track success with config",e,"trackId",i.getTrackId()),n.onSuccess(i.getTrackId()),i}function NS(e,t,n,i){n.optimizationMode&&(i&&i.width&&i.height?(n.encoderConfig=Ot(Ot({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(t.contentHint=n.optimizationMode,t.contentHint===n.optimizationMode?S.debug("[".concat(e,"] set content hint to"),n.optimizationMode):S.debug("[".concat(e,"] set content hint failed")))):S.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}var LD,kD,xD,MD,rr,UD,VD,jD,FD,BD,WD,GD,Un;class HD extends HO{getUserId(){return this._userId}constructor(t,n,i,r){super(t,"track-".concat(t.kind,"-").concat(n,"-").concat(r.clientId,"_").concat(mt(5,""))),q(this,"_userId",void 0),q(this,"_uintId",void 0),q(this,"_isDestroyed",!1),q(this,"store",void 0),q(this,"processor",void 0),q(this,"processorContext",void 0),this._userId=n,this._uintId=i,this.store=r}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,S.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let dd=(LD=Ae({argsMap:(e,t,n)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),kD=Ae({argsMap:e=>[e.getTrackId()]}),xD=Ae({argsMap:(e,t)=>[e.getTrackId(),t.name]}),MD=Ae({argsMap:e=>[e.getTrackId()]}),tt((rr=class extends HD{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Vn.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,n,i,r){super(e,t,n,i),q(this,"_videoVisibleTimer",null),q(this,"_previousVideoVisibleStatus",void 0),q(this,"_clearPreviousVideoVisibleStatus",(()=>this._previousVideoVisibleStatus=void 0)),q(this,"trackMediaType",sd.VIDEO),q(this,"_videoWidth",void 0),q(this,"_videoHeight",void 0),q(this,"_player",void 0),q(this,"_prePlayer",void 0),q(this,"processorDestination",void 0),q(this,"processorContext",void 0),this._prePlayer=r,this.updateMediaStreamTrackResolution(),this.processorContext=new tN(this.getTrackId(),"remote"),this.processorDestination=new eN(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return wo((()=>{S.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")}),"remoteVideoTrackGetStatsWarning"),Di(this,ye.GET_STATS)||Ot({},WO)}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.safeEmit(ir.PLAY_START),typeof e=="string"){const i=document.getElementById(e);i?e=i:(S.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}S.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const n=Ot(Ot({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});if(this._player)this._player.updateConfig(n);else{let i=!1,r=!1;e instanceof HTMLVideoElement?(this._player=new OS(n),this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0,r=!0)):this._prePlayer&&!this._prePlayer.isDestroyed?(this._player=this._prePlayer,this._prePlayer=void 0,i=this._player.videoState>0,this._player.updateConfig(n)):this._player=new xp(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(ir.FIRST_FRAME_DECODED),r&&this.safeEmit(ir.FIRST_FRAME_RENDER)},this._player.onVideoStateChanged=s=>{this.safeEmit(ir.VIDEO_STATE_CHANGED,s)},i&&(this._player.onFirstVideoFrameDecoded(),this._player.onVideoStateChanged(this._player.videoState))}this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval((()=>{try{const i=this.getVideoElementVisibleStatus();this.safeEmit(ir.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}}),I("CHECK_VIDEO_VISIBLE_INTERVAL")),this.safeEmit(ir.PLAY_END)}stop(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(e),this._player=void 0,S.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){rN(this._originMediaStreamTrack).then((e=>{let[t,n]=e;this._videoHeight=n,this._videoWidth=t})).catch(kl)}_updatePlayerSource(){S.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const n=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),i={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:n?.parentElement},{element:r,slot:s}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&s instanceof HTMLElement){const o=iO.checkOneElementVisible(r),a=Object.assign({},o);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;const c=Se.reportApiInvoke(null,{tag:Ct.TRACER,name:xt.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(n){throw new J(N.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new J(N.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(si.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(si.ON_TRACK)}_destroy(){this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0),super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(Oa.SEI_RECEIVED,e)}}).prototype,"play",[LD],Object.getOwnPropertyDescriptor(rr.prototype,"play"),rr.prototype),tt(rr.prototype,"stop",[kD],Object.getOwnPropertyDescriptor(rr.prototype,"stop"),rr.prototype),tt(rr.prototype,"pipe",[xD],Object.getOwnPropertyDescriptor(rr.prototype,"pipe"),rr.prototype),tt(rr.prototype,"unpipe",[MD],Object.getOwnPropertyDescriptor(rr.prototype,"unpipe"),rr.prototype),rr),ld=(UD=Ae({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),VD=Ae({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),jD=Ae({argsMap:(e,t)=>[e.getTrackId(),t]}),FD=Ae({argsMap:e=>[e.getTrackId()]}),BD=Ae({argsMap:e=>[e.getTrackId()]}),WD=Ae({argsMap:(e,t)=>[e.getTrackId(),t.name]}),GD=Ae({argsMap:e=>[e.getTrackId()]}),tt((Un=class extends HD{get isPlaying(){return this._useAudioElement?Jn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,n,i){super(e,t,n,i),q(this,"trackMediaType",sd.AUDIO),q(this,"_source",void 0),q(this,"_useAudioElement",!0),q(this,"_volume",100),q(this,"processorContext",void 0),q(this,"processorDestination",void 0),q(this,"_played",!1),q(this,"_bypassWebAudio",!1),I("DISABLE_WEBAUDIO")?(this._source=new AS,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new CS(e,!0),I("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Wi.RECEIVE_TRACK_BUFFER,(()=>{this.safeEmit(ir.FIRST_FRAME_DECODED)})),this.processorContext=new iN(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new nN(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Wi.UPDATE_SOURCE,(()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})}))}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Wi.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Wi.ON_AUDIO_BUFFER),this._source.on(Wi.ON_AUDIO_BUFFER,(n=>e(n)))}setVolume(e){this._volume=e,this._useAudioElement?Jn.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}setAmplifiedVolume(e){this._useAudioElement&&this._played&&(Jn.stop(this.getTrackId()),this._source.play()),this._useAudioElement=!1,e=Math.min(e,I("MAX_WEBAUDIO_VOLUME")),this._volume=e,this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!xO())throw new J(N.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Jn.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getVolume(){return this._useAudioElement?Jn.getVolume(this.getTrackId()):this._source instanceof CS?this._source.getAudioVolume():0}getStats(){return wo((()=>{S.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")}),"remoteAudioTrackGetStatsWarning"),Di(this,ye.GET_STATS)||Ot({},BO)}play(){S.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(S.debug("[".concat(this.getTrackId(),"] use audio element to play")),Jn.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):(S.debug("[".concat(this.getTrackId(),"] use audio context to play")),this._source.play())}stop(){S.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Jn.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];S.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Jn.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new J(N.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new J(N.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new J(N.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(si.ON_TRACK,(async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(si.ON_NODE,(e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(si.ON_TRACK),this.processorDestination.removeAllListeners(si.ON_NODE)}}).prototype,"setVolume",[UD],Object.getOwnPropertyDescriptor(Un.prototype,"setVolume"),Un.prototype),tt(Un.prototype,"setAmplifiedVolume",[VD],Object.getOwnPropertyDescriptor(Un.prototype,"setAmplifiedVolume"),Un.prototype),tt(Un.prototype,"setPlaybackDevice",[jD],Object.getOwnPropertyDescriptor(Un.prototype,"setPlaybackDevice"),Un.prototype),tt(Un.prototype,"play",[FD],Object.getOwnPropertyDescriptor(Un.prototype,"play"),Un.prototype),tt(Un.prototype,"stop",[BD],Object.getOwnPropertyDescriptor(Un.prototype,"stop"),Un.prototype),tt(Un.prototype,"pipe",[WD],Object.getOwnPropertyDescriptor(Un.prototype,"pipe"),Un.prototype),tt(Un.prototype,"unpipe",[GD],Object.getOwnPropertyDescriptor(Un.prototype,"unpipe"),Un.prototype),Un);const Pi=new class extends Vt{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),q(this,"_lastHiddenTime",0),q(this,"_lastVisibleTime",0),q(this,"needUploadStats",[]),q(this,"isCollectingStats",!1),document.addEventListener("visibilitychange",(()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),this.isCollectingStats&&this.needUploadStats.push(document.visibilityState==="visible"?1:0),S.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)}))}startCollectStats(){this.isCollectingStats=!0,this.needUploadStats.push(this.visibility==="visible"?1:0)}stopCollectStats(){this.isCollectingStats=!1,this.needUploadStats.length=0}};class KD extends Vt{constructor(t,n){super(),q(this,"trackMediaType",sd.DATA),q(this,"_version",1),q(this,"_type",3),q(this,"_config",void 0),q(this,"_originDataChannel",void 0),q(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),q(this,"_dataStreamPacketHandler",{serialize:i=>i,deserialize:i=>i}),q(this,"_datachannelEventMap",new Map),this._config=t,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader()}useDataStream(t){this._dataStreamPacketHandler=t}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return I("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,n;return(t=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,n;return(t=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new de(((t,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();const i=setTimeout((()=>{var r;n(new J(N.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))}),1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new J(N.DATACHANNEL_CONNECTION_TIMEOUT)}}else n(new J(N.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))}))}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){const t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[Pp.OPEN,Pp.CLOSE,Pp.ERROR].forEach((n=>{const i=()=>{this.emit(n)};this._datachannelEventMap.set(n,i),t.addEventListener(n,i)}))}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach((n=>{let[i,r]=n;t.removeEventListener(i,r)})),this._datachannelEventMap.clear()}}class hz extends KD{constructor(t){super(t),q(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const i=n.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(i).getUint8(3);if(r!==this.id)return void(I("SHOW_DATASTREAM2_LOG")&&S.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let s=n.data.slice(this._dataStreamPacketHeader.byteLength);s=this._dataStreamPacketHandler.deserialize(s),this.emit(Pp.MESSAGE,s)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class pz extends KD{send(t){if(this._originDataChannel){let n=t;n=this._dataStreamPacketHandler.serialize(t);const i=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}}function Up(){const e=new Blob([atob("Y29uc3QgdD0idmlkZW8vaDI2NCIsZT0idmlkZW8vaDI2NSI7ZnVuY3Rpb24gbih0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLHI9W10sbz0wO2Zvcig7ci5sZW5ndGg8bjspbyszPG4mJjA9PT1hW29dJiYwPT09YVtvKzFdJiYzPT09YVtvKzJdJiYoMD09PWFbbyszXXx8MT09PWFbbyszXXx8Mj09PWFbbyszXXx8Mz09PWFbbyszXSk/KHIucHVzaChhW29dLGFbbysxXSxhW28rM10pLG8rPTQpOihyLnB1c2goYVtvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkocil9ZnVuY3Rpb24gYShhLHIpe3N3aXRjaChyKXtjYXNlIHQ6cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IERhdGFWaWV3KHQuZGF0YSk7bGV0IGE9MDtmb3IoO2ErNDx0LmRhdGEuYnl0ZUxlbmd0aDspe2lmKDA9PT1lLmdldFVpbnQ4KGErMCkmJjA9PT1lLmdldFVpbnQ4KGErMSkmJjA9PT1lLmdldFVpbnQ4KGErMikmJjE9PT1lLmdldFVpbnQ4KGErMykmJjY9PT1lLmdldFVpbnQ4KGErNCkpe2xldCByPWErNixvPTAsaT0wO2Zvcig7MjU1PT09KGk9ZS5nZXRVaW50OChyKyspKTspbys9MjU1O28rPWk7Y29uc3Qgcz1uKHQuZGF0YSxyLG8pO3JldHVybiBuZXcgVWludDhBcnJheShzKX1hKyt9cmV0dXJuIG51bGx9KGEpO2Nhc2UgZTpyZXR1cm4gZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRGF0YVZpZXcodC5kYXRhKTtsZXQgYT0wO2Zvcig7YSs1PHQuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PWUuZ2V0VWludDgoYSswKSYmMD09PWUuZ2V0VWludDgoYSsxKSYmMD09PWUuZ2V0VWludDgoYSsyKSYmMT09PWUuZ2V0VWludDgoYSszKSYmNzg9PT1lLmdldFVpbnQ4KGErNCkmJjE9PT1lLmdldFVpbnQ4KGErNSkmJjEwMT09PWUuZ2V0VWludDgoYSs2KSl7bGV0IHI9YSs3LG89MCxpPTA7Zm9yKDsyNTU9PT0oaT1lLmdldFVpbnQ4KHIrKykpOylvKz0yNTU7bys9aTtjb25zdCBzPW4odC5kYXRhLHIsbyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KHMpfWErK31yZXR1cm4gbnVsbH0oYSk7ZGVmYXVsdDpyZXR1cm4gbnVsbH19ZnVuY3Rpb24gcih0KXtjb25zdCBlPXQubGVuZ3RoO2xldCBuPVtdLGE9MDtmb3IoO2E8ZTspYSsyPGUmJjA9PT10W2FdJiYwPT09dFthKzFdJiYoMD09PXRbYSsyXXx8MT09PXRbYSsyXXx8Mj09PXRbYSsyXXx8Mz09PXRbYSsyXSk/KG4ucHVzaCh0W2FdLHRbYSsxXSwzLHRbYSsyXSksYSs9Myk6KG4ucHVzaCh0W2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShuKX1mdW5jdGlvbiBvKG4sYSxvKXtzd2l0Y2gobyl7Y2FzZSB0OnJldHVybiBmdW5jdGlvbih0LGUpe2NvbnN0IG49cihlKSxhPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihhLzI1NSksaT1hJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK2ErdC5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNitmXT0yNTUsZisrO3JldHVybiBzWzYrZl09aSxmKysscy5zZXQobiw2K2YpLHMuc2V0KG5ldyBVaW50OEFycmF5KHQpLDYrZithKSxzLmJ1ZmZlcn0obixhKTtjYXNlIGU6cmV0dXJuIGZ1bmN0aW9uKHQsZSl7Y29uc3Qgbj1yKGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxpPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNytvKzErYSsxK3QuYnl0ZUxlbmd0aCk7c1swXT0wLHNbMV09MCxzWzJdPTAsc1szXT0xLHNbNF09Nzgsc1s1XT0xLHNbNl09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNytmXT0yNTUsZisrO3JldHVybiBzWzcrZl09aSxmKysscy5zZXQobiw3K2YpLGYrPWEsc1s3K2ZdPTEyOCxmKysscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNytmKSxzLmJ1ZmZlcn0obixhKTtkZWZhdWx0OnJldHVybiBudWxsfX1mdW5jdGlvbiBpKG4pe2lmKG4ubGVuZ3RoPDUpcmV0dXJuIiI7bGV0IGE9LTE7Zm9yKGxldCB0PTA7dDxuLmxlbmd0aC0zO3QrKyl7aWYoMD09PW5bdF0mJjA9PT1uW3QrMV0mJjE9PT1uW3QrMl0pe2E9dDticmVha31pZih0PG4ubGVuZ3RoLTQmJjA9PT1uW3RdJiYwPT09blt0KzFdJiYwPT09blt0KzJdJiYxPT09blt0KzNdKXthPXQ7YnJlYWt9fWlmKC0xPT09YSlyZXR1cm4iIjtjb25zdCByPWErKDA9PT1uW2ErMl0/NDozKTtpZihyPj1uLmxlbmd0aClyZXR1cm4iIjtjb25zdCBvPW5bcl07aWYoMTI4Jm8pcmV0dXJuIiI7aWYoKG8+PjEmNjMpPj0zMilyZXR1cm4gZTtpZihyKzE8bi5sZW5ndGgpe2lmKDA9PSgyNDgmbltyKzFdKSlyZXR1cm4gZX1yZXR1cm4oMzEmbyk8PTMxP3Q6IiJ9Y29uc3Qgcz03MSxmPTEsbD0yLHU9MSxnPTI7dmFyIGM7ZnVuY3Rpb24gZCh0LGU9ITEpe2NvbnN0IG49dC5nZXRVaW50OCgwKTtpZihuIT09cylyZXR1cm47Y29uc3QgYT10LmdldFVpbnQxNigxKSxyPWYrbCthLG89bmV3IFVpbnQ4QXJyYXkodC5ieXRlTGVuZ3RoLXIpO28uc2V0KG5ldyBVaW50OEFycmF5KHQuYnVmZmVyLHIsdC5ieXRlTGVuZ3RoLXIpKTtjb25zdCBpPXttOm4sdGx2TGVuOmEsdGx2OltdLGZyYW1lOm99O2xldCBkPWYrbDtmb3IoO2Q8cjspe2NvbnN0IG49dC5nZXRVaW50OChkKSxhPXQuZ2V0VWludDE2KGQrdSkscj11K2c7aWYobj09PWMuQVVESU9fTEVWRUwpe2xldCBvPXQuZ2V0VWludDgoZCtyKTtmb3IobGV0IGU9MTtlPGE7ZSsrKW89bzw8OHx0LmdldFVpbnQ4KGQrcitlKTtpLnRsdi5wdXNoKHt0YWc6bixsZW5ndGg6YSx2YWx1ZTplPzEyN15vPj4xOjEyNyZvfSl9ZWxzZSBpZihuPT09Yy5NRVRBREFUQXx8bj09PWMuQVVESU9fNjRfQklUX1BUUyl7Y29uc3QgZT1uZXcgVWludDhBcnJheShhKTtmb3IobGV0IG49MDtuPGE7bisrKWVbbl09dC5nZXRVaW50OChkK3Irbik7aS50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZX0pfWQrPXIrYX1yZXR1cm4gaX0hZnVuY3Rpb24odCl7dFt0LkFVRElPX0xFVkVMPTFdPSJBVURJT19MRVZFTCIsdFt0Lk1FVEFEQVRBPTJdPSJNRVRBREFUQSIsdFt0LkFVRElPXzY0X0JJVF9QVFM9M109IkFVRElPXzY0X0JJVF9QVFMifShjfHwoYz17fSkpLHNlbGYub25ydGN0cmFuc2Zvcm09dD0+e2NvbnN0IGU9dC50cmFuc2Zvcm1lcixuPVtdLHI9W107bGV0IGg9bnVsbDtlLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9dD0+e3QuZGF0YS5zZWkmJm4ucHVzaCh0LmRhdGEuc2VpKSx0LmRhdGEubWV0YWRhdGEmJnIucHVzaCh0LmRhdGEubWV0YWRhdGEpfSxzZWxmLnBvc3RNZXNzYWdlKCJzdGFydGVkIik7Y29uc3QgcD1lLnJlYWRhYmxlLmdldFJlYWRlcigpLFU9ZS53cml0YWJsZS5nZXRXcml0ZXIoKTsic2VpLXJ4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KG4udmFsdWUuZGF0YSkpLHI9YShuLnZhbHVlLHQpO2lmKHImJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtzZWk6cn0pLCFoKXtjb25zdCB0PW4udmFsdWUuZ2V0TWV0YWRhdGEoKXx8e307aD17dHlwZTpuLnZhbHVlLnR5cGUscnRwVGltZXN0YW1wOm4udmFsdWUudGltZXN0YW1wLHBheWxvYWRUeXBlOnQucGF5bG9hZFR5cGV8fDAsc3NyYzp0LnN5bmNocm9uaXphdGlvblNvdXJjZXx8MCxsZW5ndGg6bi52YWx1ZS5kYXRhLmJ5dGVMZW5ndGgsLi4uIm1pbWVUeXBlImluIHQ/e21pbWVUeXBlOnQubWltZVR5cGV9Ont9fSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7Zmlyc3RGcmFtZUluZm86aH0pfX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToic2VpLXR4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigoYT0+e2lmKCFhLmRvbmUpe2lmKGEudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KGEudmFsdWUuZGF0YSkpLGU9bi5zaGlmdCgpO2lmKGUpe2NvbnN0IG49byhhLnZhbHVlLmRhdGEsZSx0KTtuJiYoYS52YWx1ZS5kYXRhPW4pfX1VLndyaXRlKGEudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtcngiPT09ZS5vcHRpb25zLm5hbWU/ZnVuY3Rpb24gdChlKXtwLnJlYWQoKS50aGVuKChuPT57aWYoIW4uZG9uZSl7aWYobi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PW5ldyBEYXRhVmlldyhuLnZhbHVlLmRhdGEpLGE9dC5nZXRVaW50OCgwKTtsZXQgcjtpZigwIT0oMTI4JmEpJiY3MSE9PWEpe2NvbnN0IGU9ZnVuY3Rpb24odCl7aWYodC5ieXRlTGVuZ3RoPD0wKXJldHVybltdO2NvbnN0IGU9W107bGV0IG49MDtmb3IoO248dC5ieXRlTGVuZ3RoOyl7Y29uc3QgYT0oMTI4JnQuZ2V0VWludDgobikpPj43LHI9MTI3JnQuZ2V0VWludDgobik7aWYoIShhJiZuKzQ8PXQuYnl0ZUxlbmd0aCkpe24rKzticmVha317Y29uc3QgYT10LmdldFVpbnQzMihuLCExKSxvPSgxNjc3NjE5MiZhKT4+MTAsaT0xMDIzJmE7ZS5wdXNoKHtwdDpyLHRzX29mZnNldDpvLGxlbmd0aDppLGRhdGE6bmV3IFVpbnQ4QXJyYXl9KSxuKz00fX1sZXQgYT10LmJ5dGVMZW5ndGgtbjtmb3IoY29uc3QgciBvZiBlKXtpZihyLmxlbmd0aD5hKXJldHVybiBjb25zb2xlLndhcm4oIkJyb2tlbiByZWQgcGF5bG9hZCIpLFtdO3IubGVuZ3RoPjAmJihyLmRhdGE9bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sci5sZW5ndGgpLG4rPXIubGVuZ3RoLGEtPXIubGVuZ3RoKX1pZihhPjApe2NvbnN0IHI9e3B0OmUubGVuZ3RoPjA/ZVtlLmxlbmd0aC0xXS5wdDowLHRzX29mZnNldDowLGxlbmd0aDphLGRhdGE6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sYSl9O2UucHVzaChyKX1yZXR1cm4gZX0odCk7aWYoZS5sZW5ndGg+MCl7Y29uc3QgdD1mdW5jdGlvbih0KXtsZXQgZT0wO2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKWUrPW48dC5sZW5ndGgtMT80OjEsZSs9dFtuXS5sZW5ndGg7Y29uc3Qgbj1uZXcgVWludDhBcnJheShlKTtsZXQgYT0wO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKWlmKGU8dC5sZW5ndGgtMSl7Y29uc3Qgcj0oMjE0NzQ4MzY0OHwoMTI3JnRbZV0ucHQpPDwyNHwoMjYyMTQzJnRbZV0udHNfb2Zmc2V0KTw8MTB8MTAyMyZ0W2VdLmxlbmd0aCk+Pj4wO25bYSsrXT1yPj4yNCYyNTUsblthKytdPXI+PjE2JjI1NSxuW2ErK109cj4+OCYyNTUsblthKytdPTI1NSZyfWVsc2UgblthKytdPTEyNyZ0W2VdLnB0O2Zvcihjb25zdCBlIG9mIHQpbi5zZXQoZS5kYXRhLGEpLGErPWUubGVuZ3RoO3JldHVybiBufShlLm1hcCgodD0+e2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkodC5sZW5ndGgpO2Uuc2V0KHQuZGF0YSk7Y29uc3Qgbj1kKG5ldyBEYXRhVmlldyhlLmJ1ZmZlcikpO3JldHVybiBuPy5mcmFtZSYmKHQuZGF0YT1uPy5mcmFtZSkscj1uLHR9KSkpO24udmFsdWUuZGF0YT10LmJ1ZmZlcn19ZWxzZSByPWQodCksciYmKG4udmFsdWUuZGF0YT1yLmZyYW1lLmJ1ZmZlcik7aWYocil7bGV0IHQ9ci50bHYuZmluZCgodD0+dC50YWc9PT1jLk1FVEFEQVRBKSk7aWYodCYmdC52YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkmJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHttZXRhZGF0YTp0LnZhbHVlfSksdD1yLnRsdi5maW5kKCh0PT50LnRhZz09PWMuQVVESU9fNjRfQklUX1BUUykpLHQmJnQudmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5JiY4PT10LnZhbHVlLmxlbmd0aCl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcodC52YWx1ZS5idWZmZXIpLmdldEJpZ1VpbnQ2NCgwLCEwKTt0JiZ0LnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3B0czpufSl9fX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtdHgiPT09ZS5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtnZXRNZXRhZGF0YTohMH0pLG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1yLnNoaWZ0KCk7dCYmKG4udmFsdWUuZGF0YT1mdW5jdGlvbih0LGUsbil7Y29uc3QgYT1uLmJ5dGVMZW5ndGgscj1hK3UrZyxvPWYrbCtyLGk9bmV3IEFycmF5QnVmZmVyKHQuYnl0ZUxlbmd0aCtvKSxjPW5ldyBEYXRhVmlldyhpKTtjLnNldFVpbnQ4KDAscyksYy5zZXRVaW50MTYoMSxyKSxjLnNldFVpbnQ4KDMsZSksYy5zZXRVaW50MTYoNCxhKTtmb3IobGV0IHQ9MDt0PGE7dCsrKWMuc2V0VWludDgoNit0LG5bdF0pO2NvbnN0IGQ9bmV3IFVpbnQ4QXJyYXkoYy5idWZmZXIpO3JldHVybiBkLnNldChuZXcgVWludDhBcnJheSh0KSxvKSxkLmJ1ZmZlcn0obi52YWx1ZS5kYXRhLGMuQVVESU9fNjRfQklUX1BUUyx0KSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSl9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKTsK")],{type:"text/javascript"});return setTimeout((()=>Mh.revokeObjectURL(e)),0),new Worker(Mh.createObjectURL(e))}const YD=71,DS=1,PS=2,LS=1,zD=2;var Io=(function(e){return e[e.AUDIO_LEVEL=1]="AUDIO_LEVEL",e[e.METADATA=2]="METADATA",e[e.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",e})(Io||{});function kS(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=e.getUint8(0);if(n!==YD)return;const i=e.getUint16(1),r=DS+PS+i,s=new Uint8Array(e.byteLength-r);s.set(new Uint8Array(e.buffer,r,e.byteLength-r));const o={m:n,tlvLen:i,tlv:[],frame:s};let a=DS+PS;for(;a<r;){const c=e.getUint8(a),u=e.getUint16(a+LS),p=LS+zD;if(c===Io.AUDIO_LEVEL){let m=e.getUint8(a+p);for(let _=1;_<u;_++)m=m<<8|e.getUint8(a+p+_);o.tlv.push({tag:c,length:u,value:t?127^m>>1:127&m})}else if(c===Io.METADATA||c===Io.AUDIO_64_BIT_PTS){const m=new Uint8Array(u);for(let _=0;_<u;_++)m[_]=e.getUint8(a+p+_);o.tlv.push({tag:c,length:u,value:m})}a+=p+u}return o}const Vp=new Map,jp=127,Pa=1e-10,xS=139/13,Fp=new Map;function MS(e,t,n){const i="".concat(e,"-").concat(t,"-").concat(n);let r=0;return Fp.has(i)?r=Fp.get(i):(r=Math.log((function(o,a){const c=o-a;a<c&&(a=c);let u=1;for(let p=o,m=1;p>a;p--,m++)u=u*p/m;return u})(t,e))+e*Math.log(.5)+(t-e)*Math.log(1-.5)-Math.log(n)+n*e,Fp.set(i,r)),r<Pa&&(r=Pa),r}function qD(e,t,n){const i=t.length,r=e.length/i;let s=!1;for(let o=0,a=0;o<i;o++){let c=0;for(let u=a+r;a<u;a++)e[a]>n&&c++;t[o]!==c&&(t[o]=c,s=!0)}return s}window.cache=Fp;let mz=0;class XD{constructor(t){q(this,"id",void 0),q(this,"immediates",[]),q(this,"lastNonSilence",-1),q(this,"immediateSpeechActivityScore",Pa),q(this,"lastLevelChangedTime",Date.now()),q(this,"levels",[]),q(this,"longs",[]),q(this,"longSpeechActivityScore",Pa),q(this,"mediums",[]),q(this,"mediumSpeechActivityScore",Pa),q(this,"minLevel",0),q(this,"nextMinLevel",0),q(this,"nextMinLevelWindowLength",0),q(this,"energyScore",0),this.id=t||"".concat(mz++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){const t=this.immediates,n=this.levels,i=this.minLevel+xS;let r=!1;for(let s=0;s<t.length;++s){let o=n[s];o<i&&(o=0);const a=Math.floor(o/xS);t[s]!==a&&(t[s]=a,r=!0)}return r}computeLongs(){return qD(this.mediums,this.longs,4)}computeMediums(){return qD(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=MS(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(t){this.longSpeechActivityScore=MS(this.longs[0],10,47),this.longSpeechActivityScore>Pa&&(this.lastNonSilence=t)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=MS(this.mediums[0],5,24)}evaluateSpeechActivityScores(t){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(t)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var t;return"[".concat(_R(t=[...this.levels]).call(t).join(),"]")}getSpeechActivityScore(t){switch(t){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+t)}}levelChanged(t,n){if(this.lastLevelChangedTime<=n){this.lastLevelChangedTime=n;let i=t;return t<0&&(i=0),t>jp&&(i=jp),this.levels.unshift(i),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(i),i>=this.minLevel+xS?i:i/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(t){if(t!==0){if(this.minLevel===0||this.minLevel>t)return this.minLevel=t,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=t,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>t&&(this.nextMinLevel=t),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let n=Math.sqrt(this.minLevel*this.nextMinLevel);n<0?n=0:n>jp&&(n=jp),this.minLevel=n,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class fz{constructor(t){q(this,"algorithm",void 0),this.algorithm=t}execute(){let t=!this.algorithm;if(!t)try{const n=this.algorithm.runInDecisionMaker(this);n<=0?t=!0:setTimeout(this.execute.bind(this),n)}catch{t=!0}t&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class US{constructor(t,n,i){q(this,"isDominant",void 0),q(this,"energyRanking",void 0),q(this,"energyScore",void 0),this.isDominant=t,this.energyRanking=n,this.energyScore=i}}class _z extends Vt{constructor(t){super(),q(this,"dominantId",null),q(this,"lastDecisionTime",0),q(this,"lastLevelChangedTime",0),q(this,"lastLevelIdleTime",0),q(this,"relativeSpeechActivities",[]),q(this,"speakers",new Map),q(this,"enableSilence",!1),q(this,"timeoutToSilenceInterval",0),q(this,"decisionMaker",null),q(this,"loudest",[]),q(this,"numLoudestToTrack",3),q(this,"energyExpireTimeMs",250),q(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=t,this.enableSilence=t>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,n=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=t,n!=null&&(this.energyExpireTimeMs=n),i!=null&&(this.energyAlphaPct=i),this.loudest.length>t&&this.loudest.splice(t)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(t){return this.loudest.some((n=>n.id===t))}levelChanged(t,n){const i=Date.now(),r=this.getOrCreateSpeaker(t);this.lastLevelChangedTime<i&&(this.lastLevelChangedTime=i,this.maybeStartDecisionMaker());const s=r.levelChanged(n,i);return this.updateLoudestList(r,s,i)}runInDecisionMaker(t){return this.decisionMaker!==t||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(t){this.decisionMaker===t&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(t){t.forEach((n=>{this.speakers.has(n.id)||this.speakers.set(n.id,n)}))}removeSpeakers(t){t.forEach((n=>{this.speakers.delete(n.id)}))}getOrCreateSpeaker(t){let n=this.speakers.get(t);return n||(n=new XD(t),this.speakers.set(t,n),this.maybeStartDecisionMaker()),n}updateLoudestList(t,n,i){const r=t.id===this.dominantId;if(n<0){let c=0;for(;c<this.loudest.length&&this.loudest[c]!==t;)++c;return new US(r,c,t.energyScore)}if(t.energyScore=Math.floor((this.energyAlphaPct*n+(100-this.energyAlphaPct)*t.energyScore+50)/100),this.numLoudestToTrack===0)return new US(r,0,t.energyScore);const s=i-this.energyExpireTimeMs;let o=0;for(;o<this.loudest.length;){const c=this.loudest[o];if(c.getLastLevelChangedTime()<s&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(o,1);else if(c.id!==t.id)++o;else if(this.loudest.splice(o,1),this.loudest.length<this.numLoudestToTrack)break}let a=0;for(;a<this.loudest.length&&!(this.loudest[a].energyScore<t.energyScore);)++a;return a<this.numLoudestToTrack&&(this.loudest.splice(a,0,t),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new US(r,a,t.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new fz(this),this.decisionMaker.execute())}makeDecision(t){let n=null,i=null;const r=this.speakers.size;let s=null;if(r===0)s=null;else if(r===1){var o;const a=Ii(o=this.speakers).call(o).next().value;this.enableSilence&&a&&(s=a.id,a.evaluateSpeechActivityScores(t),t-a.lastNonSilence>this.timeoutToSilenceInterval&&(s=null))}else{let a=this.dominantId==null?null:this.speakers.get(this.dominantId);if(a==null){const p=this.speakers.entries().next();p.value&&(s=p.value[0],a=p.value[1])}else s=a.id;a?.evaluateSpeechActivityScores(t);const c=this.relativeSpeechActivities;let u=2;for(const p of this.speakers.entries()){const[m,_]=p;if(_===a)continue;_.evaluateSpeechActivityScores(t);for(let R=0;R<c.length;++R){const O=a==null?Pa:a.getSpeechActivityScore(R);c[R]=Math.log(_.getSpeechActivityScore(R)/O)}const g=c[0],b=c[1],v=c[2];g>3&&b>2&&v>0&&b>u&&(u=b,s=m)}this.enableSilence&&a!=null&&s===a.id&&t-a.lastNonSilence>this.timeoutToSilenceInterval&&(s=null)}s==null&&!this.enableSilence||s===this.dominantId||(n=this.dominantId,this.dominantId=s,i=this.dominantId),i==null&&!this.enableSilence||i===n||this.emit("ActiveSpeakerChanged",i)}_runInDecisionMaker(){const t=Date.now(),n=300-(t-this.lastLevelIdleTime);let i=0;n<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(t),this.lastLevelIdleTime=t):i=n;let r=300-(t-this.lastDecisionTime);return r<=0&&(this.lastDecisionTime=t,this.makeDecision(t),r=300-(Date.now()-t)),r>0&&i>r&&(i=r),i}timeoutIdleLevels(t){const n=[];for(const r of Ii(i=this.speakers).call(i)){var i;const s=t-r.getLastLevelChangedTime();36e5<s&&(this.dominantId==null||r.id!==this.dominantId)?n.push(r.id):300<s&&r.levelTimedOut()}n.forEach((r=>this.speakers.delete(r)))}}const ud=new Map;let qr=null,Bp=null;const JD=3;let La=[];const Xr=new Map,Wp=new Map;class gz{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(t,n){q(this,"id",void 0),q(this,"track",void 0),q(this,"score",0),q(this,"active",!0),q(this,"muted",!1),q(this,"timer",0),q(this,"actives",0),q(this,"inactives",0),this.id=t,this.track=n,this.setActive(Xr.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){const t=this.active;this.active=this.activeRate>=.8;const{actives:n,inactives:i}=(function(){const r=[],s=[];return Array.from(Ii(Xr).call(Xr)).forEach((o=>{o.active?r.push(o):s.push(o)})),{actives:r,inactives:s}})();if(n.length>3){let r;n.forEach((s=>{(!r||r.score>s.score)&&(r=s)})),r&&r.setActive(!1)}if(n.length<3&&i.length>0){let r;i.forEach((s=>{(!r||r.score<s.score)&&s.id!==this.id&&(r=s)})),r&&t&&!this.active&&(r.samples>40&&r.activeRate-this.activeRate>.4?r.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(t){this.active=t,this.resetTimer(),this.setMuted(!t)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){const t=(function(n){let i;return Array.from(Ii(Xr).call(Xr)).forEach((r=>{!r.active||r.id===n||r.samples<40||(!i||r.score<i.score)&&(i=r)})),i})(this.id);t&&this.activeRate-t.activeRate>.4&&(t.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){const t=(function(n){let i;return Array.from(Ii(Xr).call(Xr)).forEach((r=>{r.active||r.id===n||r.samples<40||(!i||r.score>i.score)&&(i=r)})),i})(this.id);t&&t.activeRate-this.activeRate>.4&&(t.setActive(!0),this.setActive(!1))}addSample(t){t?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(t){this.track&&(this.track.enabled=!t,this.muted=t)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout((()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()}),1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let Gp;function QD(e){const t=Xr.get(e);t&&(Xr.delete(e),t.clearTimer())}const Hp=new Map,Ez=new Map,VS="video/h264",jS="video/h265";function ZD(e,t,n){let i=new Uint8Array(e,t,n),r=[],s=0;for(;r.length<n;)s+3<n&&i[s]===0&&i[s+1]===0&&i[s+2]===3&&(i[s+3]===0||i[s+3]===1||i[s+3]===2||i[s+3]===3)?(r.push(i[s],i[s+1],i[s+3]),s+=4):(r.push(i[s]),s++);return new Uint8Array(r)}function $D(e){const t=e.length;let n=[],i=0;for(;i<t;)i+2<t&&e[i]===0&&e[i+1]===0&&(e[i+2]===0||e[i+2]===1||e[i+2]===2||e[i+2]===3)?(n.push(e[i],e[i+1],3,e[i+2]),i+=3):(n.push(e[i]),i++);return new Uint8Array(n)}function eP(e){if(e.length<5)return"";let t=-1;for(let r=0;r<e.length-3;r++){if(e[r]===0&&e[r+1]===0&&e[r+2]===1){t=r;break}if(r<e.length-4&&e[r]===0&&e[r+1]===0&&e[r+2]===0&&e[r+3]===1){t=r;break}}if(t===-1)return"";const n=t+(e[t+2]===0?4:3);if(n>=e.length)return"";const i=e[n];return 128&i?"":(i>>1&63)>=32||n+1<e.length&&(248&e[n+1])==0?jS:(31&i)<=31?VS:""}const Kp=new Map,Bl=new Map;(function(){const e=st();Sn.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),Sn.getStreamFromExtension=e.name===at.CHROME&&Number(e.version)>34,Sn.supportUnifiedPlan=(function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let n=!1;try{t.addTransceiver("audio"),n=!0}catch{}return t.close(),n})(),Sn.supportMinBitrate=e.name===at.CHROME||e.name===at.EDGE,Sn.supportSetRtpSenderParameters=(function(){const t=st();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Ss()||!(!Rn()&&!Ep())||t.name===at.FIREFOX&&Number(t.version)>=64)})(),e.name===at.SAFARI&&(Number(e.version)>=14?Sn.supportDualStream=!0:Sn.supportDualStream=!1),Sn.webAudioMediaStreamDest=(function(){const t=st();return!(t.name===at.SAFARI&&Number(t.version)<12)})(),Sn.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",Sn.supportWebGL=typeof WebGLRenderingContext<"u",Sn.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Ss()||(Sn.webAudioWithAEC=!0),Sn.supportShareAudio=(function(){const t=st();return(t.os===gn.WIN_10||t.os===gn.WIN_81||t.os===gn.WIN_7||t.os===gn.LINUX||t.os===gn.MAC_OS||t.os===gn.CHROMIUM_OS)&&t.name===at.CHROME&&Number(t.version)>=74})(),Sn.supportDataChannel=!!(Yr(76)||GE(68)||K0(14)),Sn.supportPCSetConfiguration=(function(){const t=window.RTCPeerConnection;return!Nt()&&!!t&&t.prototype.setConfiguration instanceof Function})(),Sn.supportWebRTCEncodedTransform=Yr(87)||W0()||GE(117),Sn.supportWebRTCInsertableStream=(function(){const t=st();return(t.name===at.CHROME||t.name===at.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window})(),Sn.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,Sn.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,Sn.supportSuppressLocalAudioPlayback=VO(),Sn.supportRestrictOwnAudio=jO(),yp((()=>{Sn.supportDualStreamEncoding=(function(){const t=st();return!!I("DISABLE_WEBAUDIO")||t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&I("CHROME_DUAL_STREAM_USE_ENCODING"))})(),S.debug("browser ua: ",navigator.userAgent),S.info("browser info: ",e),S.info("browser compatibility: ",Sn)}))})();const Sz=["CHINA","GLOBAL"],tP=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],ka=[],hd=[];function xa(e,t){return!!t&&ka.some((n=>n.uid===e&&n.channelName===t))}function FS(){return hd.length>0}var yz=cI.forEach,nP=qu("forEach")?[].forEach:function(e){return yz(this,e,arguments.length>1?arguments[1]:void 0)};pt({target:"Array",proto:!0,forced:[].forEach!==nP},{forEach:nP});var Tz=Zi("Array","forEach"),vz=_o,Rz=Hn,Cz=W,bz=Tz,BS=Array.prototype,wz={DOMTokenList:!0,NodeList:!0},Az=function(e){var t=e.forEach;return e===BS||Cz(BS,e)&&t===BS.forEach||Rz(wz,vz(e))?bz:t},Iz=y(Az),Oz=ps,iP=eh;pt({target:"Object",stat:!0,forced:w((function(){iP(1)}))},{keys:function(e){return iP(Oz(e))}});var Nz=y(Mi.Object.keys),Dz=y(pR),Pz=y(fR),Lz=pt,rP=$d,kz=mh,xz=ei,sP=e_,Mz=fo,Uz=po,Vz=Sg,jz=rn,Fz=Eo,Bz=ZA("slice"),Wz=jz("species"),WS=Array,Gz=Math.max;Lz({target:"Array",proto:!0,forced:!Bz},{slice:function(e,t){var n,i,r,s=Uz(this),o=Mz(s),a=sP(e,o),c=sP(t===void 0?o:t,o);if(rP(s)&&(n=s.constructor,(kz(n)&&(n===WS||rP(n.prototype))||xz(n)&&(n=n[Wz])===null)&&(n=void 0),n===WS||n===void 0))return Fz(s,a,c);for(i=new(n===void 0?WS:n)(Gz(c-a,0)),r=0;a<c;a++,r++)a in s&&Vz(i,r,s[a]);return i.length=r,i}});var Hz=Zi("Array","slice"),Kz=W,Yz=Hz,GS=Array.prototype,zz=function(e){var t=e.slice;return e===GS||Kz(GS,e)&&t===GS.slice?Yz:t},qz=y(zz);function le(e,t,n,i,r){var s,o,a,c={};return Iz(s=Nz(i)).call(s,(function(u){c[u]=i[u]})),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=Dz(o=Pz(a=qz(n).call(n)).call(a)).call(o,(function(u,p){return p(e,t,u)||u}),c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0?(qA(e,t,c),null):c}let Yp=(function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e})({}),HS=(function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e})({}),sr=(function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e[e.REQ_DOWNGRADE_FALLBACK=27]="REQ_DOWNGRADE_FALLBACK",e})({}),oi=(function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e})({}),we=(function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.K_VOS_FALLBACK=30]="K_VOS_FALLBACK",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e})({}),$e=(function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e})({}),Te=(function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.PRE_CONNECT_PC="pre_connect_pc",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e.RECOVER_NOTIFICATION="recover_notification",e.VOS_FALLBACK="vos_fallback",e.VOS_FALLBACK_PROMISE="vos_fallback_promise",e})({}),Ce=(function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SET_DUAL_STREAM_MODE="set_dual_stream_mode",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.CONFIGURE="configure",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e.DOWNGRADE_CODEC="downgrade_codec",e})({}),Ma=(function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e})({}),Le=(function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e.ENABLE_MULTI_STREAM="enable_multi_stream",e})({}),ai=(function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e})({}),Ve=(function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e.ON_FALLBACK="websocket:on_fallback",e})({});function zp(e){if(typeof e!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw S.error("Invalid Channel Name ".concat(e)),new Y(N.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function qp(e){if(t=e,!(typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295||eO(e,1,255)))throw new Y(N.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;typeof e=="string"&&S.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Zs=(function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e})({});const Xz={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},KS={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function YS(e,t){Nn(e.url,"".concat(t,".url"),1,1e3,!1),Wt(e.x)||Rt(e.x,"".concat(t,".x"),0,1e4),Wt(e.y)||Rt(e.y,"".concat(t,".y"),0,1e4),Wt(e.width)||Rt(e.width,"".concat(t,".width"),0,1e4),Wt(e.height)||Rt(e.height,"".concat(t,".height"),0,1e4),Wt(e.zOrder)||Rt(e.zOrder,"".concat(t,".zOrder"),0,255),Wt(e.alpha)||Rt(e.alpha,"".concat(t,".alpha"),0,1,!1)}const Jz={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let Oo=(function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e})({}),zS=(function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e})({}),ln=(function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e})({});function oP(e){if(!e.channelName)throw new Y(N.INVALID_PARAMS,"invalid channelName in info");if(typeof e.uid!="number")throw new Y(N.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&Nn(e.token,"info.token",1,2047),qp(e.uid),zp(e.channelName),!0}let mi=(function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e})({}),$s=(function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e})({}),yi=(function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e})({}),pd=(function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e})({}),_t=(function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e})({}),Xt=(function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.PRE_CONNECT_PC="pre-connect_pc",e.UPDATE_GATEWAY_CONFIG="update-gateway-config",e.VOS_FALLBACK="vos-fallback",e.VOS_FALLBACK_PROMISE="vos-fallback-promise",e.RESET_SIGNAL="reset-signal",e.DATACHANNEL_FAILBACK="datachannel-failback",e})({}),Xp=(function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e})({}),yn=(function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e})({}),lt=(function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e})({});const aP=[lt.AFRICA,lt.ASIA,lt.CHINA,lt.EUROPE,lt.GLOBAL,lt.INDIA,lt.JAPAN,lt.NORTH_AMERICA,lt.OCEANIA,lt.OVERSEA,lt.SOUTH_AMERICA];let jn=(function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e})({});const Jp={CHINA:{},ASIA:{CODE:jn.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:jn.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:jn.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:jn.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:jn.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:jn.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:jn.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:jn.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:jn.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:jn.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:jn.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:jn.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:jn.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};dS&&(Jp.CHINA={CODE:jn.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Jr=(function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",e.UPDATE_REMOTE_VIDEO_STREAM_TYPE="update_remote_video_stream_type",e.FALLBACK_TO_HLS="fallback_to_hls",e.UPDATE_VOS_CONFIGURE="update_vos_configure",e})({});function cP(e){return!!e&&!(!e.uplink||!e.id)&&e.uplink.max_bitrate!==void 0&&e.uplink.min_bitrate!==void 0}class dP extends Vt{constructor(t,n){super(),C(this,"onICEConnectionStateChange",void 0),C(this,"onConnectionStateChange",void 0),C(this,"onDTLSTransportStateChange",void 0),C(this,"onDTLSTransportError",void 0),C(this,"onICETransportStateChange",void 0),C(this,"onFirstAudioReceived",void 0),C(this,"onFirstVideoReceived",void 0),C(this,"onFirstAudioDecoded",void 0),C(this,"onFirstVideoDecoded",void 0),C(this,"onFirstVideoRender",void 0),C(this,"onFirstVideoBufferReady",void 0),C(this,"onFirstVideoDecodedTimeout",void 0),C(this,"onSelectedLocalCandidateChanged",void 0),C(this,"onSelectedRemoteCandidateChanged",void 0),C(this,"onICECandidateError",void 0),C(this,"getLocalVideoStats",void 0)}}class Qp extends dP{constructor(t,n){super(t,n),C(this,"establishPromise",void 0)}}let _e=(function(e){return e.VIDEO="video",e.AUDIO="audio",e})({}),bn=(function(e){return e.UDP_RELAY="udp_relay",e.UDP_TCP_RELAY="udp_tcp_relay",e.TCP_RELAY="tcp_relay",e.RELAY="relay",e})({}),eo=(function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.TCP_RESTART=3]="TCP_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e})({});const lP=["disconnected","failed"];let re=(function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e})({}),ut=(function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e})({}),be=(function(e){return e.AudioMetadata="audioMetadata",e.AudioPts="audioPts",e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e.FirstVideoPreRender="FirstVideoPreRender",e.FirstVideoBufferReady="FirstVideoBufferReady",e})({}),wr=(function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e})({}),Ar=(function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e})({}),wn=(function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e})({}),No=(function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e})({}),un=(function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e})({}),Rs=(function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e})({}),or=(function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e})({}),Qr=(function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e})({}),md=(function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e})({}),Jt=(function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e})({}),fd=(function(e){return e.ABORT="abort",e})({}),Do=(function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e})({}),Qz=(function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e})({});const Zz={[Yp.ACCESS_POINT]:{[oi.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[oi.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[oi.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[oi.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[oi.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[oi.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[oi.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Yp.UNILBS]:{[sr.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[sr.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[sr.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[sr.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[sr.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[sr.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[sr.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[sr.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[sr.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[sr.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[sr.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[sr.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1},[sr.REQ_DOWNGRADE_FALLBACK]:{desc:"request downgrade fallback",retry:!1}},[Yp.STRING_UID_ALLOCATOR]:{[HS.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[HS.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[HS.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function _d(e){const t=Zz[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};const n=t[e%1e4];if(!n){if(Math.floor(e/1e4)===Yp.ACCESS_POINT){const i=e%1e4;if(i.toString()[0]==="1")return{desc:e.toString(),retry:!1};if(i.toString()[0]==="2")return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}const $z={[we.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[we.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[we.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[we.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[we.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[we.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[we.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[we.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[we.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[we.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[we.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[we.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[we.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[we.K_VOS_FALLBACK]:{desc:"K_VOS_FALLBACK",action:"tryNext"},[we.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[we.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[we.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[we.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[we.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[we.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[we.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[we.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[we.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[we.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[we.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[we.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[we.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[we.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[we.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[we.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[we.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[we.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[we.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[we.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[we.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[we.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[we.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[we.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[we.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[we.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[we.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[we.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[we.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[we.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[we.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[we.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[we.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[we.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[we.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[we.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[we.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[we.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[we.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[we.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[we.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[we.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[we.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[we.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[we.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[we.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[we.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[we.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[we.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[we.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[we.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Ua(e){return $z[e]||{desc:"UNKNOWN_ERROR_".concat(e),action:"failed"}}function uP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function qS(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?uP(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):uP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function XS(e,t){if(typeof e=="string")return e;const{proxy:n,host:i,port:r}=e;if(t){const s=I("JOIN_GATEWAY_FALLBACK_PORT")||443;return s===443?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(s,"/ws/?p=").concat(Number(r)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}const eq=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,tq=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,nq=/wss:\/\/(.+):([0-9]+)\/?/,iq=/wss:\/\/(.[^\/]+)\/?/;let rq=0;class sq{constructor(t,n){C(this,"id",0),C(this,"store",void 0),C(this,"recordIndex",void 0),C(this,"websockets",[]),C(this,"try443PortDuration",2e3),C(this,"forceCloseWSDuration",5e3),C(this,"try443PortTimeout",null),C(this,"forceCloseTimeout",null),C(this,"isTry443PortFailed",!1),C(this,"isNormalPortFailed",!1),C(this,"useDoubleDomain",!1),C(this,"useProxy",!1),C(this,"startTime",Date.now()),this.id=++rq,this.try443PortDuration=I("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach((t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()})),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var t;const n=Date.now()-this.startTime;for(var i=arguments.length,r=new Array(i),s=0;s<i;s++)r[s]=arguments[s];S.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...r)}createWebSocket(t,n,i){this.logger("createWebSocket:",t,{isTry443Port:n,hasTimeoutDetection:i});const r=I("GATEWAY_DOMAINS"),s=Date.now(),o=[],a=r.find((_=>{var g;return ie(g=t.host).call(g,_)}));a||(this.useDoubleDomain=!1);const c=[];if(this.useDoubleDomain)r.forEach((_=>{c.push(XS(qS(qS({},t),{},{host:t.host.replace(a,_)}),n))}));else{const _=qS({},t);if(n&&a){const g=r.find((b=>b!==a));g&&(_.host=_.host.replace(a,g))}c.push(XS(_,n))}try{c.forEach((_=>{const g=new WebSocket(_);g.binaryType="arraybuffer",o.push(g),this.logger("ws is connecting:",g.url)}))}catch(_){if(this.logger("ws create failed"),o.forEach((g=>g.close())),o.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,n,i);if(!n&&Number(t.port)!==443)return this.createWebSocket(t,!0,i);throw new Y(N.WS_ERR,"init websocket failed! Error: ".concat(_.toString()))}const u=Ol();this.store&&this.store.recordJoinChannelService({urls:o.map((_=>_.url)),service:"gateway"},this.recordIndex),o.forEach((_=>{_.onopen=()=>{this.logger("onopen: ws ".concat(_.url," open cost ").concat(Date.now()-s,"ms")),this.websockets.forEach((g=>{g!==_&&(g.onopen=null,g.onclose=null,g.onmessage=null,g.close(),this.logger("close backup websocket: ".concat(g.url)))})),this.websockets.length=0,u.resolve(_)},_.onclose=g=>{this.logger("onclose: ws ".concat(_.url," closed cost ").concat(Date.now()-s,"ms state: ").concat(_.readyState));const b=o.every((v=>v.readyState===WebSocket.CLOSED||v.readyState===WebSocket.CLOSING));this.logger("".concat(n?"443":"47xx"," websocket closed, all failed: ").concat(b)),b&&(n||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(g.reason)),u.reject({code:g.code,reason:Xp.A_ROUND_WS_FAILED})):!n&&b&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),m()),n?this.isTry443PortFailed=b:this.isNormalPortFailed=b},_.onmessage=g=>this.logger("".concat(_.url," onmessage: ").concat(g.data))})),this.websockets.push(...o);const p=()=>{this.websockets.forEach((_=>_.readyState!==WebSocket.OPEN&&_.close()))},m=()=>{if(u.isResolved)return p();st().os===gn.MAC_OS&&Nt()&&p(),this.createWebSocket(t,!0,!0).then((_=>{u.resolve(_)})).catch((_=>{this.isNormalPortFailed&&u.reject(_),this.logger("try 443 port to create ws failed")})),this.forceCloseTimeout=window.setTimeout((()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",u.isResolved),this.forceCloseTimeout=null,p()}),this.forceCloseWSDuration)};return i||(()=>{if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout((()=>{this.forceCloseTimeout=null,p()}),this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout((()=>{this.logger("2s timeout, isWebsocket created: ",u.isResolved),this.try443PortTimeout=null,m()}),this.try443PortDuration)})(),u.promise}chooseBestWebsocket(t,n,i,r){return this.useDoubleDomain=!!n,typeof t=="string"&&(t=(function(s){let o,a,c;return[,o,a,c]=s.match(eq)||[],o||([,a,c]=s.match(tq)||[]),a&&c||([,a,c]=s.match(nq)||[]),a&&c||([,a]=s.match(iq)||[]),a||S.warning("un-destructible url: ",s),{proxy:o,host:a,port:c||"443"}})(t)),this.recordIndex=r,this.useProxy=!!t.proxy,i&&this.useProxy&&(S.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(t,!!i,!1).finally((()=>this.clearTimeout()))}}function hP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}class pP extends Vt{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var n;ie(n=["tryNext","recover"]).call(n,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(Ve.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Ve.CONNECTED):this._state==="closed"?this.emit(Ve.CLOSED):this._state==="failed"&&this.emit(Ve.FAILED))}resetReconnectCount(t){S.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],s=arguments.length>4&&arguments[4]!==void 0&&arguments[4],o=arguments.length>5?arguments[5]:void 0;super(),C(this,"_websocketUrl",null),C(this,"connectionID",0),C(this,"currentURLIndex",0),C(this,"urls",[]),C(this,"_reconnectMode","tryNext"),C(this,"reconnectReason",void 0),C(this,"_initMutex",void 0),C(this,"name",void 0),C(this,"_state","closed"),C(this,"reconnectInterrupter",void 0),C(this,"websocket",void 0),C(this,"retryConfig",void 0),C(this,"reconnectCount",0),C(this,"forceCloseTimeout",5e3),C(this,"onlineReconnectListener",void 0),C(this,"useCompress",void 0),C(this,"tryDoubleDomain",!1),C(this,"use443PortOnly",!1),C(this,"wsInflateLength",0),C(this,"wsDeflateLength",0),C(this,"closeEstablishingWs",(()=>{})),C(this,"store",void 0),C(this,"joinGatewayRecordIndex",void 0),this.store=o,this.name=t,this.retryConfig=(function(m){for(var _=1;_<arguments.length;_++){var g=arguments[_]!=null?arguments[_]:{};_%2?hP(Object(g),!0).forEach((function(b){C(m,b,g[b])})):Object.getOwnPropertyDescriptors?Object.defineProperties(m,Object.getOwnPropertyDescriptors(g)):hP(Object(g)).forEach((function(b){Object.defineProperty(m,b,Object.getOwnPropertyDescriptor(g,b))}))}return m})({},n),this.useCompress=i,this.tryDoubleDomain=r,this.use443PortOnly=s,this._initMutex=new Cn("websocket",o?o.clientId:void 0);const{timeout:a,timeoutFactor:c}=n,u=Math.max(300,Math.floor(3*a/5)),p=Math.max(1.2,Math.floor(8*c)/10);ii.ONLINE&&(this.retryConfig.timeout=u,this.retryConfig.timeoutFactor=p),Gt.on(Ta.NETWORK_STATE_CHANGE,((m,_)=>{m!==_&&(this.resetReconnectCount("network state change: ".concat(_," -> ").concat(m)),m===ii.ONLINE?(this.retryConfig.timeout=u,this.retryConfig.timeoutFactor=p):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))}))}getConnection(){return this.websocket||void 0}async init(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=n,this.urls=t,this.state="connecting";try{var r;const s=Ol(),o=this.urls[this.currentURLIndex];(r=this.store)===null||r===void 0||r.beforeConnect(),(function(a){return!(Op()||I("USE_NEW_TOKEN")||!I("ENABLE_PREALLOC_PC")&&(a==null||!a.autoSubscribe||I("FORCE_DISABLE_AUTO_SUB")))})(this.store)&&this.emit(un.PRE_CONNECT_PC),this.createWebSocketConnection(o).then(s.resolve).catch(s.reject),this.once(Ve.CLOSED,(()=>{s.reject(new J(N.WS_DISCONNECT))})),this.once(Ve.CONNECTED,s.resolve),await s.promise}catch{}finally{i()}}close(t,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const i=this.websocket;n?setTimeout((()=>i.close()),500):i.close(),this.websocket=void 0,this._websocketUrl=null}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,n){if(!this.websocket)return void S.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),S.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);const i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:n})}sendMessage(t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new J(N.WS_ABORT,"websocket is not ready");try{n||(t=JSON.stringify(t)),this.websocket.send(t)}catch(i){throw new J(N.WS_ERR,"send websocket message error"+i.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var n;const i=Ol();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const r=p=>{var m;(m=this.store)===null||m===void 0||m.signalChannelOpen(),S.debug("[".concat(this.name,"] websocket opened:"),p),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},s=async p=>{var m;if(S.debug("[".concat(this.name,"] websocket close ").concat((m=this.websocket)===null||m===void 0?void 0:m.url,", code: ").concat(p.code,", reason: ").concat(p.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new J(N.WS_DISCONNECT,"websocket close: ".concat(p.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=p.reason,this.state="reconnecting");const _=Di(this,Ve.WILL_RECONNECT,this.reconnectMode,p.reason)||this.reconnectMode,g=await this.reconnectWithAction(_);if(this.state==="closed")return void S.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!g)return i.reject(new J(N.WS_DISCONNECT,"websocket reconnect failed: ".concat(p.code))),this.close(!0);i.resolve()}},o=p=>{this.emit(Ve.ON_MESSAGE,p)},a=p=>{S.warn("[".concat(this.connectionID,"] ws open error ").concat(p))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),I("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=I("GATEWAY_WSS_ADDRESS")),S.debug("[".concat(this.name,"] start connect, url:"),t);const c=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var u;this._websocketUrl=XS(t);const p=await this.chooseBestWebsocketConnection(t);this.websocket=p,r&&r(this.websocket.url),this.websocket.onclose=s,this.websocket.onmessage=o,this.websocket.onerror=a,(u=this.store)===null||u===void 0||u.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(p){const m=this.state==="closed",_=p instanceof J,g=_&&p.code===N.WS_ABORT,b=_&&p.code===N.WS_ERR,v=_?p.message:p&&(p.reason||p.toString());S.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(v)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:g?"aborted":"error",errors:[p]},c),m||b?(i.reject(m?new J(N.WS_DISCONNECT,"websocket is closed: ".concat(v)):new J(N.WS_ERR,"init websocket failed: ".concat(v))),b&&S.error("[".concat(this.name,"] init websocket failed: ").concat(v))):s&&s(p)}return i.promise}async reconnectWithAction(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;S.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||Gt.isOnline||!Gt.onlineWaiter||(this.onlineReconnectListener=Gt.onlineWaiter.then((()=>{this.onlineReconnectListener=void 0})));let i=!0;if(this.reconnectInterrupter=()=>i=!1,n){const o=Tp(this.reconnectCount,this.retryConfig);S.debug("[".concat(this.name,"] wait ").concat(o,"ms to reconnect websocket, mode: ").concat(t)),await de.race([En(o),this.onlineReconnectListener||new de((()=>{}))])}if(this._state==="closed"||!i)return!1;this.reconnectCount+=1;const r=async(o,a)=>{this.emit(Ve.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(o)};try{if(t==="retry")await r(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);S.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await r(this.urls[this.currentURLIndex],t)}else t==="recover"&&(S.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await sn(this,Ve.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],t))}catch(o){var s;S.error("[".concat(this.name,"] reconnect failed ").concat(o&&o.toString()));const a=o==null||(s=o.data)===null||s===void 0?void 0:s.desc;if(Array.isArray(a)){if(ie(a).call(a,"dynamic key expired"))return this.emit(Ve.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1;if(ie(a).call(a,"request downgrade fallback"))return this.emit(Ve.ON_FALLBACK),!1}return this.reconnectWithAction(t,n)}return!0}}class JS extends pP{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,n){const i=Ol(),r=(function(o,a){return new sq(o,a)})(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{S.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),i.reject(new J(N.WS_ABORT,"choose best websocket aborted"))};const s=I("GATEWAY_DOMAINS");return S.debug("[choose-best-ws] currentDomain: ",t,", domains: ",s,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,n).then(i.resolve).catch(i.reject),i.promise.finally((()=>{this.closeEstablishingWs=void 0}))}}class Wl extends pP{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,n){return new de(((i,r)=>{let s=!1;const o=[];this.closeEstablishingWs=()=>{S.debug("[choose-best-ws] close establishing websockets"),o.forEach((b=>{b.onclose=null,b.onopen=null,b.onmessage=null,b.close()})),r(new J(N.WS_ABORT,"choose best websocket aborted"))};const a=I("GATEWAY_DOMAINS");let c;const u=t.indexOf("?h="),p=a.find((b=>u!==-1?ie(t).call(t,b,u):ie(t).call(t,b)));S.debug("[choose-best-ws] currentDomain: ",p,", domains: ",a);let m=!this.tryDoubleDomain||!p;if(!m&&p){var _;const b=Date.now();try{a.forEach((v=>{const R=u===-1?t.replace(p,v):t.substr(0,u)+t.substr(u).replace(p,v),O=new WebSocket(R);O.binaryType="arraybuffer",o.push(O),S.debug("[choose-best-ws] ws is connecting:",O.url)}))}catch{for(S.debug("[choose-best-ws] ws create failed, fallback to single url"),o.forEach((R=>R.close()));o.length;)o.pop();m=!0}(_=this.store)===null||_===void 0||_.recordJoinChannelService({urls:o.map((v=>v.url)),service:"gateway"},n),o.forEach((v=>{v.onopen=()=>{if(s)return;const R=Date.now()-b;S.debug("[choose-best-ws] ws open cost ".concat(R,"ms")),o.filter((O=>O!==v)).forEach((O=>{S.debug("[choose-best-ws]close backup websocket: ".concat(O.url)),O.close()})),s=!0,i(v)},v.onclose=R=>{c=R,!s&&(o.find((O=>!(O.readyState===WebSocket.CLOSED||O.readyState===WebSocket.CLOSING)))||(S.debug("[choose-best-ws] all websocket is closed"),s=!0,r(c)))},v.onmessage=R=>{S.debug("[choose-best-ws]".concat(v.url," onmessage: ").concat(R.data))}})),En(this.forceCloseTimeout).then((()=>{o.forEach((v=>{v.readyState!==WebSocket.OPEN&&v.close()}))}))}if(m){var g;let b;S.debug("[choose-best-ws] use single url: ",t),(g=this.store)===null||g===void 0||g.recordJoinChannelService({urls:[t],service:"gateway"},n);try{b=new WebSocket(t),o.push(b),b.binaryType="arraybuffer"}catch(v){const R=new J(N.WS_ERR,"init websocket failed! Error: ".concat(v.toString()));return S.error("[".concat(this.name,"]").concat(R)),void r(R)}b.onopen=()=>{i(b)},b.onclose=v=>{r(v)},b.onmessage=v=>{S.debug("[choose-best-ws]".concat(b.url," onmessage: ").concat(v.data))},En(this.forceCloseTimeout).then((()=>{b&&b.readyState!==WebSocket.OPEN&&b.close()}))}})).then((i=>(this.closeEstablishingWs=void 0,i))).catch((i=>{throw this.closeEstablishingWs=void 0,i}))}}class mP extends Vt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===$e.CONNECTED?this.emit(Te.WS_CONNECTED):t===$e.RECONNECTING?this.emit(Te.WS_RECONNECTING,this._websocketReconnectReason):t===$e.CLOSED&&this.emit(Te.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,n){super(),C(this,"__name__","AgoraRTCSignal"),C(this,"_disconnectedReason",void 0),C(this,"_websocketReconnectReason",void 0),C(this,"_connectionState",$e.CLOSED),C(this,"reconnectToken",void 0),C(this,"websocket",void 0),C(this,"openConnectionTime",void 0),C(this,"clientId",void 0),C(this,"lastMsgTime",Date.now()),C(this,"uploadCache",[]),C(this,"uploadCacheInterval",void 0),C(this,"rttRolling",new nS(5)),C(this,"pingpongTimer",void 0),C(this,"wsInflateDataTimer",void 0),C(this,"pingpongTimeoutCount",0),C(this,"ortc",void 0),C(this,"joinResponse",void 0),C(this,"multiIpOption",void 0),C(this,"initError",void 0),C(this,"spec",void 0),C(this,"store",void 0),C(this,"onWebsocketMessage",(i=>{if(i.data instanceof ArrayBuffer)return void this.emit(Te.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===Le.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Le.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ze.UID_BANNED);break;case 15:this.close(Ze.IP_BANNED);break;case 16:this.close(Ze.CHANNEL_BANNED)}if(r._type===Le.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case we.ERR_LICENSE_MISSING:this.close(Ze.LICENSE_MISSING);break;case we.ERR_LICENSE_EXPIRED:this.close(Ze.LICENSE_EXPIRED);break;case we.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ze.LICENSE_MINUTES_EXCEEDED);break;case we.ERR_LICENSE_PERIOD_INVALID:this.close(Ze.LICENSE_PERIOD_INVALID);break;case we.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ze.LICENSE_MULTIPLE_SDK_SERVICE);break;case we.ERR_LICENSE_ILLEGAL:this.close(Ze.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new JS("gateway-".concat(this.clientId),this.spec.retryConfig,!0,I("JOIN_GATEWAY_USE_DUAL_DOMAIN"),I("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===$e.CONNECTED&&this.reconnect("retry",kn.OFFLINE)}))}async request(t,n,i,r){const s=mt(6,""),o={_id:s,_type:t,_message:n},a=this.websocket.connectionID,c=()=>new de(((b,v)=>{if(this.connectionState===$e.CONNECTED)return b();const R=()=>{this.off(Te.WS_CLOSED,O),b()},O=()=>{this.off(Te.WS_CONNECTED,R),v(new Y(N.WS_ABORT))};this.once(Te.WS_CONNECTED,R),this.once(Te.WS_CLOSED,O),t!==Ce.PUBLISH&&t!==Ce.PUBLISH_DATASTREAM&&t!==Ce.SUBSCRIBE&&t!==Ce.SUBSCRIBE_DATASTREAM&&t!==Ce.UNSUBSCRIBE&&t!==Ce.UNSUBSCRIBE_DATASTREAM&&t!==Ce.UNPUBLISH&&t!==Ce.UNPUBLISH_DATASTREAM&&t!==Ce.CONTROL&&t!==Ce.RESTART_ICE||this.once(Te.DISCONNECT_P2P,(()=>{v(new Y(N.DISCONNECT_P2P))})),t!==Ce.PUBLISH&&t!==Ce.RESTART_ICE||this.once(Te.ABORT_P2P_EXECUTION,(()=>{v(new Y(N.DISCONNECT_P2P))}))}));if(this.connectionState!==$e.CONNECTING&&this.connectionState!==$e.RECONNECTING||t===Ce.JOIN||t===Ce.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const u=new de(((b,v)=>{let R=!1;const O=(x,B)=>{R=!0,b({isSuccess:x==="success",message:B||{}}),this.off(Te.WS_CLOSED,D),this.off(Te.WS_RECONNECTING,D),this.emit(Te.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(s),O);const D=()=>{v(new Y(N.WS_ABORT,"type: ".concat(t))),this.off(Te.WS_CLOSED,D),this.off(Te.WS_RECONNECTING,D),this.off("res-@".concat(s),O)};this.once(Te.WS_CLOSED,D),this.once(Te.WS_RECONNECTING,D),En(I("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||R||(S.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(Te.REQUEST_TIMEOUT,t,n))}))}));let p=null;try{p=await u}catch(b){if(this.connectionState===$e.CLOSED||t===Ce.LEAVE)throw new Y(N.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?b.throw():t===Ce.JOIN||t===Ce.REJOIN?null:(await c(),await this.request(t,n))}if(p.isSuccess)return p.message;const m=Number(p.message.error_code||p.message.code),_=Ua(m),g=new Y(N.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(p.message.error_str),{code:m,data:p.message,desc:_.desc});return _.action==="success"?p.message:(S.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(m,", message: ").concat(_.desc,", action: ").concat(_.action)),m===we.ERR_TOO_MANY_BROADCASTERS?((t===Ce.JOIN||t===Ce.REJOIN)&&(this.initError=g,this.close()),g.throw()):_.action==="failed"?g.throw():_.action==="quit"?(this.initError=g,this.close(),g.throw()):(m===we.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=p.message.option,S.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",kn.MULTI_IP)):this.reconnect(_.action,kn.SERVER_ERROR),t===Ce.JOIN||t===Ce.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new de((i=>{const r=s=>{(!n||n(s))&&(this.off(t,r),i(s))};this.on(t,r)}))}uploadWRTCStats(t){if(!this.store.sessionId)return void S.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Ma.WRTC_STATS,n)}upload(t,n){const i={_type:t,_message:n};try{this.websocket.sendMessage(i)}catch{const s=I("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==$e.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)}),I("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,n){const i={_type:t,_message:n};this.websocket.sendMessage(i)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new de(((n,i)=>{this.once(Te.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(Te.WS_CLOSED,(r=>i(this.initError||new Y(N.WS_ABORT,r)))),this.connectionState=$e.CONNECTING,this.websocket.init(t).catch(i),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval((()=>{this.handleWsInflateData()}),2e4)}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||Ze.LEAVE,this.connectionState=$e.CLOSED,S.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(Te.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await sn(this,Te.REQUEST_JOIN_INFO);this.store.joinReq();const n=await this.request(Ce.JOIN,t);if(this.ortc=t?.ortc,this.store.joinRep(),!n)return this.emit(Te.REPORT_JOIN_GATEWAY,Xp.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(Te.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=$e.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new Y(N.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=va(this,Te.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const n=await this.request(Ce.REJOIN,t);return!!n&&(this.connectionState=$e.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach((i=>{this.emit(Le.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Le.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Le.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Le.MUTE_AUDIO,{uid:i.uid}):this.emit(Le.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Le.MUTE_VIDEO,{uid:i.uid}):this.emit(Le.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Le.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Le.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Le.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Le.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Le.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})})),!0)}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}async downgradeCodec(t){if(!this.ortc)return!1;const n={downgrade_codec:t,ortc:this.ortc};return!!await this.request(Ce.DOWNGRADE_CODEC,n)}handleNotification(t){S.debug("[".concat(this.clientId,"] receive notification: "),t);const n=Ua(t.code);if(t.code===28&&"detail"in t&&(S.info("[".concat(this.clientId,"] receive recover notification: "),t.detail),this.emit(Te.RECOVER_NOTIFICATION,t.detail)),n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?t.code===we.ERR_REPEAT_JOIN_CHANNEL&&I("IGNORE_UID_CHECK")?void this.close(Ze.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ze.UID_BANNED),void this.close()):t.code===we.K_VOS_FALLBACK&&"detail"in t?(S.info("[".concat(this.clientId,"] receive vos fallback notification: "),t.detail),t.detail==="FALLBACKCN"&&I("ENABLE_QUALITY_FALLBACK")?void sn(this,Te.VOS_FALLBACK_PROMISE,t.detail).then((()=>{this.reconnect("recover",n.desc)})).catch((i=>{S.debug("[".concat(this.clientId,"] cancel vos fallback cn, error: "),i)})):t.detail==="fallback_hls"&&I("ENABLE_FALLBACK_TO_HLS")?(this.emit(Te.VOS_FALLBACK,t.detail),void this.close(Ze.FALLBACK_TO_HLS)):this.reconnect(n.action,n.desc)):void this.reconnect(n.action,kn.SERVER_ERROR);S.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=I("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(S.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>I("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",kn.TIMEOUT):this.request(Ce.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),I("REPORT_STATS")&&this.send(Ce.PING_BACK,{pingpongElapse:i})})).catch((i=>{}))}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:n}=this.websocket.getWsInflateData();t!==0&&n!==0&&this.upload(Ma.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(Ve.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(Te.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(Ve.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ve.CLOSED,(()=>{this.connectionState=$e.CLOSED})),this.websocket.on(Ve.FAILED,(()=>{this._disconnectedReason=Ze.NETWORK_ERROR,this.connectionState=$e.CLOSED})),this.websocket.on(Ve.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===$e.CONNECTED?this.connectionState=$e.RECONNECTING:this.connectionState=$e.CONNECTING})),this.websocket.on(Ve.WILL_RECONNECT,((t,n,i)=>{const r=va(this,Te.IS_P2P_DISCONNECTED),s=r||t!=="retry";r&&t==="retry"&&(S.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",n=Xp.P2P_DISCONNECTED),s&&(S.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(Te.REPORT_JOIN_GATEWAY,n||Xp.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(Te.DISCONNECT_P2P)),i(t)})),this.websocket.on(Ve.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{S.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",kn.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(Te.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof Y){if(t.code===N.UNEXPECTED_RESPONSE&&t.data.code===we.ERR_NO_AUTHORIZED)return this.initError=new Y(N.TOKEN_EXPIRE,"dynamic key expired"),void this.close(Ze.TOKEN_EXPIRE);S.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",kn.SERVER_ERROR):(this.initError=t,this.close())}}))})),this.websocket.on(Ve.REQUEST_NEW_URLS,((t,n)=>{sn(this,Te.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)})),this.websocket.on(Ve.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Le.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(un.PRE_CONNECT_PC,(()=>{this.emit(Te.PRE_CONNECT_PC)})),this.websocket.on(Ve.ON_FALLBACK,(()=>{I("ENABLE_FALLBACK_TO_HLS")&&this.emit(Te.VOS_FALLBACK,"fallback_hls")}))}}let oq=(function(e){return e.NATIVE_RTC="native_rtc",e.NATIVE_RTM="native_rtm",e.WEB_RTC="web_rtc",e.WEB_RTM="web_rtm",e})({}),en=(function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e})({});function fP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Zp(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?fP(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let QS=0;function Ir(e){const t=I("TURN_DOMAINS");QS=(QS+1)%t.length;const n=t[QS]||"edge.agora.io";return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(n):(S.debug("Cannot recognized as ip address: ".concat(e,", use as host2")),e)}function $p(e){try{const t=I("TURN_DOMAINS"),n=I("GATEWAY_DOMAINS").concat(t).find((i=>ie(e).call(e,i)));return n?e.split(".".concat(n))[0].replace(/-/g,"."):e}catch{return S.debug("serverUrlToIp error, fallback to url",e),e}}function ZS(e,t){e.addresses||(e.addresses=[]);const n=(function(a,c){if(I("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return a.map((m=>{let{ip:_,port:g}=m;return{address:"".concat(_,":").concat(g)}}));const u=I("GATEWAY_DOMAINS");let p=u[1]&&ie(c).call(c,u[1])?1:0;return a.map((m=>{let{domain_prefix:_,port:g,ip:b}=m;if(_)return{address:"".concat(_,".").concat(u[p++%u.length],":").concat(g)};const v=/^[\.\:\d]+$/.test(b),R=v?"".concat(b.replace(/[^\d]/g,"-"),".").concat(u[p++%u.length],":").concat(g):"".concat(b,":").concat(g);return v||S.debug("Cannot recognized as ip address: ".concat(b,", use as host3")),{ip:b,port:g,address:R}}))})(e.addresses,t),i=Array.isArray(e.detail)&&e.detail[18];if(i&&typeof i=="string"){const a=i.split(";");for(let c=0;c<a.length;c++){var r;const u=ti(r=a[c]).call(r);n[c]&&u&&(n[c].ip6=u)}}const s=e.detail&&e.detail.candidate;let o;if(s){const[a,c]=s.split(":");a&&c&&(o={port:Number(c),ip:a,address:"".concat(a,":").concat(c)})}return{gatewayAddrs:n,apGatewayAddress:o,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function fi(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function _P(e){const t=e._encoderConfig;if(!t)return{};const n={resolution:t.width&&t.height?"".concat(fi(t.width),"x").concat(fi(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(n.maxFrameRate=t.frameRate,n.minFrameRate=t.frameRate):t.frameRate&&(n.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,n.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),n}function em(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function Gl(e,t){let n,i,r;switch(t){case en.CHOOSE_SERVER:i=4096,r="choose server";break;case en.CLOUD_PROXY:i=1048576,r="proxy";break;case en.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case en.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new Y(N.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach((s=>{s.buffer&&s.buffer.flag===i&&(n={code:s.buffer.code,addresses:(s.buffer.edges_services||[]).map((o=>Zp(Zp({},o),{},{ticket:s.buffer.cert}))),server_ts:e.enter_ts,uid:s.buffer.uid,cid:s.buffer.cid,cname:s.buffer.cname,detail:Zp(Zp({},s.buffer.detail),e.detail),flag:s.buffer.flag,opid:e.opid,cert:s.buffer.cert})})),!n)throw new Y(N.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return n}async function gP(e,t){return await de.all(e.addresses.map((async n=>({address:Ir(n.ip),tcpport:n.port,udpport:n.port,username:t&&I("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():xn.username,password:t&&I("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await XE(t.toString()):xn.password}))))}function $S(e,t){const n=t.getMediaStreamTrack(!0).getSettings(),i=t.videoHeight||n.height,r=t.videoWidth||n.width;return i&&r?Math.max(Math.min(i,r)/Math.min(fi(e.height),fi(e.width)),1):(S.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Po(e){let{candidateType:t,relayProtocol:n,type:i,address:r,port:s,protocol:o}=e;const a={candidateType:t,relayProtocol:n,protocol:o};if(i!=="local-candidate"){const c=r.split(".");c.length>=4&&(c[1]="*",c[2]="*"),a.address=c.join("."),a.port=s}return a}function Cs(e){const t=e.split(":"),n=e.split(/[-.]/),i=ie(e).call(e,"-")?"-":".";let r=e;return t.length>1?n.length>1?(n[1]="**",r=n[0]+i+"**:"+t[t.length-1]):r=t.length>2?t[0]+i+"**:"+t[t.length-1]:"**:"+t[t.length-1]:n.length>1&&(r=n[0]+i+"**"),r}function EP(e,t){return e.getTransceivers().find((n=>n.sender.track===t||n.receiver.track===t))}function Hl(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:I("SVC_MODE");if(I("ENABLE_SVC"))return(function(t){return t in Cp})(e)?e:Cp.L1T3}const SP={[_e.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[_e.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function yP(e){e.send&&(gd(_e.VIDEO,e.send.videoExtensions),gd(_e.AUDIO,e.send.audioExtensions)),e.recv&&(gd(_e.VIDEO,e.recv.videoExtensions),gd(_e.AUDIO,e.recv.audioExtensions)),e.sendrecv&&(gd(_e.VIDEO,e.sendrecv.videoExtensions),gd(_e.AUDIO,e.sendrecv.audioExtensions))}function TP(e,t){e.send&&(tm(_e.VIDEO,e.send.videoExtensions,t.send.videoExtensions),tm(_e.AUDIO,e.send.audioExtensions,t.send.audioExtensions)),e.recv&&(tm(_e.VIDEO,e.recv.videoExtensions,t.recv.videoExtensions),tm(_e.AUDIO,e.recv.audioExtensions,t.recv.audioExtensions))}function tm(e,t,n){t.forEach((i=>{var r;const s=SP[e].find((a=>{var c;let{key:u}=a;return ie(c=i.extensionName).call(c,u)}));if(!s)return;const o=n.find((a=>{let{extensionName:c}=a;return ie(c).call(c,s.key)}));o&&ie(r=o.extensionName).call(r,"gdpr_forbidden")&&(i.extensionName=o.extensionName)}))}function gd(e,t){t.forEach((n=>{var i;const r=SP[e].find((s=>{var o;let{key:a}=s;return ie(o=n.extensionName).call(o,a)}));ie(i=n.extensionName).call(i,"gdpr_forbidden")&&r&&(n.extensionName=r.extensionName)}))}function vP(e){return e==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||ie(e).call(e,"abs-send-time")}function nm(e){return e==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||ie(e).call(e,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function RP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function CP(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?RP(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):RP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function Kl(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:s,filterAudioFec:o,filterAudioCodec:a,filterVideoCodec:c,unsupportedVideoUplinkCodec:u,unsupportedVideoDownlinkCodec:p}=t,{useXR:m}=n;let _=[],g=[],b=[],v=[],R=!1,O=!1;if(ri(e).mediaDescriptions.forEach((x=>{i&&i!==x.attributes.direction||(x.media.mediaType!=="video"||R||(g=x.attributes.payloads,v=x.attributes.extmaps,R=!0),x.media.mediaType!=="audio"||O||(_=x.attributes.payloads,b=x.attributes.extmaps,O=!0))})),!v||g.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!b||_.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(g.forEach((x=>{var B;(B=x.rtpMap)!==null&&B!==void 0&&B.clockRate&&(x.rtpMap.clockRate=parseInt(x.rtpMap.clockRate)),m&&x.rtcpFeedbacks.push({type:"rrtr"})})),_.forEach((x=>{var B;(B=x.rtpMap)!==null&&B!==void 0&&B.clockRate&&(x.rtpMap.clockRate=parseInt(x.rtpMap.clockRate)),m&&x.rtcpFeedbacks.push({type:"rrtr"})})),r&&(_=_.filter((x=>{var B;return((B=x.rtpMap)===null||B===void 0?void 0:B.encodingName.toLowerCase())!=="rtx"})),g=g.filter((x=>{var B;return((B=x.rtpMap)===null||B===void 0?void 0:B.encodingName.toLowerCase())!=="rtx"}))),s){const x=g.filter((j=>{var H;return/(red)|(ulpfec)|(flexfec)/i.test(((H=j.rtpMap)===null||H===void 0?void 0:H.encodingName)||"")})),B=Lo(x,g).map((j=>j.payloadType)),G=[...x.map((j=>j.payloadType)),...B];g=g.filter((j=>!ie(G).call(G,j.payloadType)))}if(o&&(_=_.filter((x=>{var B;return!/(red)|(ulpfec)|(flexfec)/i.test(((B=x.rtpMap)===null||B===void 0?void 0:B.encodingName)||"")}))),a&&a?.length>0&&(_=_.filter((x=>{var B;return ie(a).call(a,((B=x.rtpMap)===null||B===void 0?void 0:B.encodingName.toLowerCase())||"")}))),c&&c?.length>0){const x=g.filter((B=>{var G;return ie(c).call(c,((G=B.rtpMap)===null||G===void 0?void 0:G.encodingName.toLowerCase())||"")}));g=x.concat(r?[]:Lo(x,g))}const D=I("UNSUPPORTED_VIDEO_CODEC");if(D&&D.length>0){const x=g.filter((j=>j.rtpMap&&ie(D).call(D,j.rtpMap.encodingName.toLowerCase()))),B=Lo(x,g),G=x.concat(B).map((j=>j.payloadType));g=g.filter((j=>!ie(G).call(G,j.payloadType))),S.debug("unsupportedVideoCodec: ".concat(D,", toBeRemoved: ").concat(G))}if(u&&u.length>0&&i==="sendonly"){const x=g.filter((j=>j.rtpMap&&ie(u).call(u,j.rtpMap.encodingName.toLowerCase()))),B=Lo(x,g),G=x.concat(B).map((j=>j.payloadType));g=g.filter((j=>!ie(G).call(G,j.payloadType))),S.debug("unsupportedVideoUplinkCodec: ".concat(u,", toBeRemoved: ").concat(G))}if(p&&p.length>0&&i==="recvonly"){const x=g.filter((j=>j.rtpMap&&ie(p).call(p,j.rtpMap.encodingName.toLowerCase()))),B=Lo(x,g),G=x.concat(B).map((j=>j.payloadType));g=g.filter((j=>!ie(G).call(G,j.payloadType))),S.debug("unsupportedVideoDownlinkCodec: ".concat(p,", toBeRemoved: ").concat(G))}return{audioCodecs:_,videoCodecs:g,audioExtensions:b,videoExtensions:v}}function bs(e){const t=ri(e);let n,i;for(const r of t.mediaDescriptions){if(!n){const s=r.attributes.iceUfrag,o=r.attributes.icePwd;if(!s||!o)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:s,icePwd:o}}if(!i){const s=r.attributes.fingerprints;s.length>0&&(i={fingerprints:s})}}if(!i&&t.attributes.fingerprints.length>0&&(i={fingerprints:t.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:i}}function ey(e,t){const n=[],i=e.attributes.ssrcGroups.filter((o=>o.semantic==="FID")),r=e.attributes.ssrcGroups.find((o=>o.semantic==="SIM")),s=e.attributes.ssrcs;if(r)r.ssrcIds.forEach((o=>{var a;const c=(a=i.find((u=>u.ssrcIds[0]===o)))===null||a===void 0?void 0:a.ssrcIds[1];n.push({ssrcId:o,rtx:t?c:void 0})}));else if(i.length>0){const o=i[0].ssrcIds[0],a=i[0].ssrcIds[1];n.push({ssrcId:o,rtx:t?a:void 0})}else{if(s.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:s[0].ssrcId})}return n}function bP(e,t,n){const{cname:i}=e;let r=[];t&&(r=wP(t)),r.length===0&&(r=e.iceParameters.candidates.map((p=>({foundation:p.foundation,componentId:"1",transport:p.protocol,priority:p.priority.toString(),connectionAddress:p.ip,port:p.port.toString(),type:p.type,extension:{}}))),S.debug("Using candidates from gateway."));const s={fingerprints:e.dtlsParameters.fingerprints.map((p=>({hashFunction:p.algorithm,fingerprint:p.fingerprint})))},o={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let a;switch(e.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}const c=zl(e.rtpCapabilities),u=[];return Array.isArray(n)&&n.length>0&&n.forEach((p=>{u.push({kind:_e.VIDEO,ssrcMsg:[{ssrcId:p.v,rtx:p.v_rtx}],mslabel:"".concat(p.v,"_").concat(p.a)},{kind:_e.AUDIO,ssrcMsg:[{ssrcId:p.a}],mslabel:"".concat(p.v,"_").concat(p.a)})})),{dtlsParameters:s,iceParameters:o,candidates:r,rtpCapabilities:c,setup:a,cname:i,preSSRCs:u}}function wP(e){let t=[];return e.ip&&typeof e.port=="number"&&(t=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],S.debug("Using remote candidate from AP ".concat(Cs(e.ip),":").concat(e.port)),e.ip6&&(t.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),S.debug("Using IPV6 remote candidate from AP ".concat(Cs(e.ip6),":").concat(e.port)))),t}function Yl(e,t,n){const i=[],r=[];return e.forEach((s=>{let{ssrcId:o,rtx:a}=s;const c=mt(8,"track-"),u={ssrcId:o,attributes:CP({label:c,mslabel:n=n||mt(10,""),msid:"".concat(n," ").concat(c)},t&&{cname:t})};if(i.push(u),a!==void 0){const p={ssrcId:a,attributes:CP({label:c,mslabel:n,msid:"".concat(n," ").concat(c)},t&&{cname:t})};i.push(p),r.push({semantic:"FID",ssrcIds:[o,a]})}})),e.length>1&&r.push({semantic:"SIM",ssrcIds:e.map((s=>{let{ssrcId:o}=s;return o}))}),{ssrcs:i,ssrcGroups:r}}function Va(e,t){t instanceof Yt&&e.attributes.payloads.forEach((n=>{var i;const r=(i=n.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),r==="opus"&&typeof I("OPUS_PTIME")=="number"?n.fmtp.parameters.ptime=I("OPUS_PTIME"):n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";const s=t._encoderConfig;s&&(r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(s.bitrate&&!Nt()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*s.bitrate))),s.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(s.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(s.sampleRate)),s.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1")),t instanceof Fl&&r==="opus"&&t._config.DTX&&(n.fmtp.parameters.usedtx="1"))}))}function ty(e){const t=e.attributes.unrecognized.findIndex((n=>n.attField==="x-google-flag"&&n.attValue==="conference"));t!==-1&&e.attributes.unrecognized.splice(t,1)}function ny(e,t){var n;if(e.attributes.payloads.forEach((r=>{var s;((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())==="h264"&&r.fmtp&&r.fmtp.parameters&&I("ENABLE_UP_SPS_PPS")&&(r.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")})),!(t instanceof bt&&t._encoderConfig&&t._hints.indexOf(ht.SCREEN_TRACK)===-1))return;const i=t._encoderConfig;Xe().supportMinBitrate&&i.bitrateMin&&e.attributes.payloads.forEach((r=>{var s,o;ie(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(i.bitrateMin))})),Xe().supportMinBitrate&&!ie(n=t._hints).call(n,ht.LOW_STREAM)&&i.bitrateMax&&e.attributes.payloads.forEach((r=>{var s,o;ie(s=["h264","h265","vp8","vp9","av1"]).call(s,((o=r.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(I("X_GOOGLE_START_BITRATE")||Math.floor(i.bitrateMax)))}))}function AP(e){if(e.media.mediaType!=="video")return;const t=st();if(t.name!==at.SAFARI&&t.os!==gn.IOS)return;const n=e.attributes.extmaps.findIndex((i=>/video-orientation/g.test(i.extensionName)));n!==-1&&e.attributes.extmaps.splice(n,1)}function im(e,t,n){if(!t)return;let i,r;if(e.media.mediaType==="video"?(i=n.videoExtensions,r=n.videoCodecs):(i=n.audioExtensions,r=n.audioCodecs),t.twcc===!0){const s=i.find((o=>nm(o.extensionName)));if(s){const o=s.extensionName;e.attributes.extmaps.find((c=>nm(c.extensionName)))||e.attributes.extmaps.push({entry:s.entry,extensionName:o}),(function(c,u){return u.filter((p=>!!c.find((m=>m.payloadType===p.payloadType&&!!m.rtcpFeedbacks.find((_=>_.type==="transport-cc"))))))})(r,e.attributes.payloads).forEach((c=>{c.rtcpFeedbacks.find((u=>u.type==="transport-cc"))||c.rtcpFeedbacks.push({type:"transport-cc"})}))}}else if(t.twcc===!1){const s=e.attributes.extmaps.findIndex((o=>nm(o.extensionName)));s!==-1&&e.attributes.extmaps.splice(s,1),e.attributes.payloads.forEach((o=>{const a=o.rtcpFeedbacks.findIndex((c=>c.type==="transport-cc"));a!==-1&&o.rtcpFeedbacks.splice(a,1)}))}if(t.remb===!0){const s=i.find((o=>vP(o.extensionName)));if(s){const o=s.extensionName;e.attributes.extmaps.find((c=>c.extensionName===o))||e.attributes.extmaps.push({entry:s.entry,extensionName:o}),(function(c,u){return u.filter((p=>!!c.find((m=>m.payloadType===p.payloadType&&!!m.rtcpFeedbacks.find((_=>_.type==="goog-remb"))))))})(r,e.attributes.payloads).forEach((c=>{c.rtcpFeedbacks.find((u=>u.type==="goog-remb"))||c.rtcpFeedbacks.push({type:"goog-remb"})}))}}else if(t.remb===!1){const s=e.attributes.extmaps.findIndex((o=>vP(o.extensionName)));s!==-1&&e.attributes.extmaps.splice(s,1),e.attributes.payloads.forEach((o=>{const a=o.rtcpFeedbacks.findIndex((c=>c.type==="goog-remb"));a!==-1&&o.rtcpFeedbacks.splice(a,1)}))}}function iy(e,t,n){if(Nt()||e.media.mediaType!=="video"||!(t instanceof bt)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!I("SIMULCAST")||n==="vp9"&&I("ENABLE_SVC")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;const i=n==="vp8"?2:t._scalabilityMode.numSpatialLayers,r=e.attributes.ssrcs[0],s=e.attributes.ssrcGroups.find((a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId)),o={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)e.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:Dt(r.attributes)}),o.ssrcIds.push(r.ssrcId+a),s&&(e.attributes.ssrcs.push({ssrcId:s.ssrcIds[1]+a,attributes:Dt(r.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,s.ssrcIds[1]+a]}));e.attributes.ssrcGroups.unshift(o)}async function IP(){try{const e=new RTCPeerConnection;e.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:Cp.L1T3}]});const t=await e.createOffer();if(!t.sdp)return void e.close();const n=ri(t.sdp).mediaDescriptions[0];if(!n)return;const i=n.attributes.extmaps.find((r=>r.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension"));return e.close(),i}catch{return}}async function ry(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const i=(await n.createOffer()).sdp,{send:r,recv:s,sendrecv:o}=(function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},u=arguments.length>2?arguments[2]:void 0;const p=Kl(u,a,c,"sendonly"),m=Kl(u,a,c,"recvonly"),_={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},g={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},b={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Or(p,m,"videoExtensions",_,g,b),Or(p,m,"videoCodecs",_,g,b),Or(p,m,"audioExtensions",_,g,b),Or(p,m,"audioCodecs",_,g,b),I("RAISE_H264_BASELINE_PRIORITY")){const v=[],R=[];if(b.videoCodecs.forEach(((O,D)=>{var x;if(((x=O.rtpMap)===null||x===void 0?void 0:x.encodingName.toLocaleLowerCase())==="h264"){var B,G;const j=b.videoCodecs[D+1],H=j&&PP(O,j),Z=(B=O.fmtp)===null||B===void 0?void 0:B.parameters["profile-level-id"],ne=(G=O.fmtp)===null||G===void 0?void 0:G.parameters["packetization-mode"];!Z||Z!==I("FIRST_H264_PROFILE_LEVEL_ID")||I("FIRST_PACKETIZATION_MODE")&&ne!==I("FIRST_PACKETIZATION_MODE")?H?R.push([O,j]):R.push([O]):H?v.push([O,j]):v.push([O])}})),v.length>0&&R.length>0){S.debug("raising H264 baseline profile priority"),b.videoCodecs.forEach(((D,x)=>{var B;if(((B=D.rtpMap)===null||B===void 0?void 0:B.encodingName.toLocaleLowerCase())==="h264"){const G=PP(D,b.videoCodecs[x+1]),j=v.shift()||R.shift()||[];j.length>0&&(G?b.videoCodecs.splice(x,2,...j):b.videoCodecs.splice(x,1,...j))}}));const O=g.videoCodecs.filter((D=>{var x,B;return((x=D.rtpMap)===null||x===void 0?void 0:x.encodingName.toLocaleLowerCase())==="h264"&&((B=D.fmtp)===null||B===void 0?void 0:B.parameters["profile-level-id"])!==I("FIRST_H264_PROFILE_LEVEL_ID")}));if(O.length>0){const D=Lo(O,g.videoCodecs).map((B=>B.payloadType)),x=[...O.map((B=>B.payloadType)),...D];g.videoCodecs=g.videoCodecs.filter((B=>!ie(x).call(x,B.payloadType)))}I("FILTER_SEND_H264_BASELINE")&&(_.videoCodecs=_.videoCodecs.filter((D=>{var x,B;return!(((x=D.rtpMap)===null||x===void 0?void 0:x.encodingName.toLocaleLowerCase())==="h264"&&((B=D.fmtp)===null||B===void 0?void 0:B.parameters["profile-level-id"])!==I("FIRST_H264_PROFILE_LEVEL_ID"))})))}return{send:_,recv:g,sendrecv:b}}return{send:_,recv:g,sendrecv:b}})(e,t,i);try{n.close()}catch{}return{send:r,recv:s,sendrecv:o}}function OP(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=Kl(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Or(e,t,"videoExtensions",n,i,r),Or(e,t,"videoCodecs",n,i,r),Or(e,t,"audioExtensions",n,i,r),Or(e,t,"audioCodecs",n,i,r),I("RAISE_H264_BASELINE_PRIORITY")){const s=r.videoCodecs.findIndex((o=>o.rtpMap&&o.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&o.fmtp&&o.fmtp.parameters["profile-level-id"]==="42001f"));if(s!==-1){const o=r.videoCodecs.findIndex((a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"));if(o<s){S.debug("raising H264 baseline profile priority");const a=r.videoCodecs[s];r.videoCodecs.splice(s,1),r.videoCodecs.splice(o,0,a)}o!==-1&&(i.videoCodecs=i.videoCodecs.filter((a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f"))))}}return{send:n,recv:i,sendrecv:r}}function Or(e,t,n,i,r,s){if(n==="videoExtensions"||n==="audioExtensions"){const o=[];return e[n].forEach((a=>{t[n].some(((c,u)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return o.push(u),!0}))?s[n].push(a):i[n].push(a)})),void t[n].forEach(((a,c)=>{o.indexOf(c)===-1&&r[n].push(a)}))}if(n==="videoCodecs"||n==="audioCodecs"){const o=[];return e[n].forEach((a=>{t[n].some(((c,u)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return o.push(u),!0}))?s[n].push(a):i[n].push(a)})),void t[n].forEach(((a,c)=>{o.indexOf(c)===-1&&r[n].push(a)}))}}function zl(e){const{send:t,recv:n,sendrecv:i}=e;if(!i){if(!t||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:n}}let r,s;return t?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...t.audioCodecs,...i.audioCodecs],r.videoCodecs=[...t.videoCodecs,...i.videoCodecs],r.audioExtensions=[...t.audioExtensions,...i.audioExtensions],r.videoExtensions=[...t.videoExtensions,...i.videoExtensions]):r=Dt(i),n?(s={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},s.audioCodecs=[...n.audioCodecs,...i.audioCodecs],s.videoCodecs=[...n.videoCodecs,...i.videoCodecs],s.audioExtensions=[...n.audioExtensions,...i.audioExtensions],s.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):s=Dt(i),{send:r,recv:s}}function Ed(e){e.media.mediaType==="audio"&&e.attributes.payloads.filter((t=>{var n;return((n=t.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"})).forEach((t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"}))}function ql(e,t,n,i){let r=[];if(e===_e.VIDEO){if(I("H264_PROFILE_LEVEL_ID")&&i==="h264"&&(r=t.videoCodecs.filter((s=>{var o;return ie(o=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(o,i)&&s&&s.fmtp&&s.fmtp.parameters["profile-level-id"]===I("H264_PROFILE_LEVEL_ID")}))),!Array.isArray(r)||r.length===0){let s=[];const o=[],a=[],c=[];if(n.videoCodecs.forEach((u=>{const p=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"";ie(p).call(p,i)?s.push(u):ie(p).call(p,"vp9")?o.push(u):ie(p).call(p,"vp8")?a.push(u):ie(p).call(p,"h264")&&c.push(u)})),s.length===0){let u="";o.length!==0?(s=o,u="vp9"):a.length!==0?(s=a,u="vp8"):c.length!==0&&(s=c,u="h264"),S.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(u))}s.length!==0&&(r=t.videoCodecs.filter((u=>s.some((p=>p.payloadType===u.payloadType)))))}if(r.length===0&&(S.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),r=t.videoCodecs),I("USE_PUB_RTX")||I("USE_SUB_RTX")){const s=Lo(r,t.videoCodecs);r=[...r,...s]}}else{r=t.audioCodecs.filter((o=>{var a;return ie(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,i)}));const s=t.audioCodecs.filter((o=>{var a;return ie(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,"red")}));r.length===0&&(S.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=t.audioCodecs.filter((o=>{var a;return ie(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,"opus")}))),I("ENABLE_AUDIO_RED")&&s.length!==0&&(r=[...s,...r])}return r}function Lo(e,t){const n=e.map((i=>i.payloadType.toString()));return t.filter((i=>i.rtpMap&&i.rtpMap.encodingName==="rtx"&&i.fmtp&&i.fmtp.parameters.apt&&ie(n).call(n,i.fmtp&&i.fmtp.parameters.apt)))}async function Ti(e,t,n){const i=t.toString(),r=NP(i,"offer","remote","exchangeSDP");await e.setRemoteDescription({type:"offer",sdp:i});const s=await e.createAnswer();if(!s.sdp)throw new Error("cannot get answer sdp");let o=s.sdp;o=sy(o,n||{}),r?.(o||""),await e.setLocalDescription({type:"answer",sdp:o})}function sy(e,t,n){if(I("FORBID_MODIFY_LOCAL_OFFER_SDP"))return e;const i=ri(e),{useXR:r}=t;return i.mediaDescriptions.forEach((s=>{var o;s.attributes.mid&&(Array.isArray(n)&&!ie(n).call(n,s.attributes.mid)||(s.media.mediaType==="audio"&&Ed(s),s.media.mediaType==="video"&&(function(a){a.media.mediaType==="video"&&I("ENABLE_DOWN_SPS_PPS")&&a.attributes.payloads.filter((c=>{var u;return((u=c.rtpMap)===null||u===void 0?void 0:u.encodingName.toLowerCase())==="h264"})).forEach((c=>{c.fmtp||(c.fmtp={parameters:{}}),c.fmtp.parameters["sps-pps-idr-in-keyframe"]="1"}))})(s),r&&ie(o=["audio","video"]).call(o,s.media.mediaType)&&s.attributes.payloads.forEach((a=>{a.rtcpFeedbacks.findIndex((c=>c.type==="rrtr"))===-1&&a.rtcpFeedbacks.push({type:"rrtr"})}))))})),Qs(i)}function NP(e,t,n,i){if(I("SDP_LOGGING"))return S.upload("exchanging ".concat(n," ").concat(t," SDP during P2PConnection.").concat(i,`
`),e),t==="offer"?r=>{NP(r,"answer",n==="local"?"remote":"local",i)}:void 0}async function DP(e,t,n){try{var i;if(!Xe().supportSetRtpSenderParameters||!(function(c){return c==="vp9"||c==="av1"})(e)||!I("ENABLE_SVC"))return;const r={},s={},o=t.getParameters(),a=(i=o.encodings)===null||i===void 0?void 0:i[0];s.scalabilityMode=Hl(n),a&&Object.assign(a,s),Object.assign(o,r),await t.setParameters(o),S.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(o.encodings)))}catch(r){S.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",r)}}function rm(e){const t=I("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(t)&&t.length>0)&&t.some((n=>ie(e).call(e,n)))}function PP(e,t){try{var n;return((n=e.fmtp)===null||n===void 0?void 0:n.parameters.apt)===t.payloadType.toString()}catch{return!1}}function LP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Li(e,t){return typeof I(e)===t?I(e):void 0}function aq(){try{const e=I("EXPERIMENTS")||{};return typeof e=="string"||Array.isArray(e)?{}:(function(t){for(var n=1;n<arguments.length;n++){var i=arguments[n]!=null?arguments[n]:{};n%2?LP(Object(i),!0).forEach((function(r){C(t,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):LP(Object(i)).forEach((function(r){Object.defineProperty(t,r,Object.getOwnPropertyDescriptor(i,r))}))}return t})({},e)}catch(e){return S.debug("handle gateway attributes failed: ",e),{}}}const kP={};function ws(e){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&S.debug("install service ".concat(e.name)),kP[e.name]=e}function Zr(e){const t=kP[e];if(!t)throw new J(N.INVALID_OPERATION,"".concat(e," not found, please use AgoraRTC.use(").concat(e,"Service) to load it first"));return t}function xP(e,t){return Zr("DataStream").create(e,t)}function sm(){return Zr("InterceptFrame").create()}function MP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function An(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?MP(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):MP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const oy=new Map;class cq extends Vt{get state(){return this._state}set state(t){if(t===this._state)return;const n=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(Xt.CONNECTION_STATE_CHANGE,t,n,this._disconnectedReason):this.emit(Xt.CONNECTION_STATE_CHANGE,t,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){S.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,n){var i,r,s;super(),C(this,"store",void 0),C(this,"joinInfo",void 0),C(this,"key",void 0),C(this,"ntpOffset",0),C(this,"usingProxy",!1),C(this,"signal",void 0),C(this,"role",void 0),C(this,"isPreallocation",void 0),C(this,"isPreSub",void 0),C(this,"inChannelInfo",{joinAt:null,duration:0}),C(this,"spec",void 0),C(this,"_state","DISCONNECTED"),C(this,"_statsCollector",void 0),C(this,"_disconnectedReason",void 0),C(this,"isSignalRecover",!1),C(this,"hasChangeBGPAddress",!1),C(this,"trafficStatsInterval",void 0),C(this,"networkQualityInterval",void 0),C(this,"_joinGatewayStartTime",0),C(this,"_signalTimeout",!1),C(this,"_clientRoleOptions",void 0),C(this,"_isProactiveJoin",!1),this.store=t,this.spec=n,this.signal=this.store.useP2P?(i={spec:An(An({},n),{},{retryConfig:n.websocketRetryConfig}),store:t},(r=(s=Zr("P2PChannel")).createSubmodule)===null||r===void 0?void 0:r.call(s,i)):this.store.useDcSignal?(function(o){return Zr("DataChannelSignal").create(o)})({spec:An(An({},n),{},{retryConfig:n.websocketRetryConfig}),store:t}):new mP(An(An({},n),{},{retryConfig:n.websocketRetryConfig}),t),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}setUsingProxy(t){this.usingProxy=t}async join(t,n,i){if(this.store.useDcSignal){let p=!1;t.cloudProxyServer!=="disabled"?(S.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),p=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(S.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),p=!0):t.apResponse.addresses.some((m=>m.fingerprint))||I("FINGERPRINT")||(S.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),p=!0),p&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const r=Date.now();let s=oy.get(t.cname);if(s||(s=new Map,oy.set(t.cname,s)),this._isProactiveJoin=!0,s.has(t.uid)){const p=new Y(N.UID_CONFLICT);throw Se.joinGateway(t.sid,{lts:r,succ:!1,ec:p.code,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!t.proxyServer||this.usingProxy,signalChannel:this.store.useDcSignal?"1":"0",preload:t.preload}),p}s.set(t.uid,!0),this.joinInfo=t,this.key=n;let o=0;this.joinGatewayStartTime=r;const a=t.proxyServer,c=this.store.useDcSignal?"datachannel":"websocket";try{S.debug("[".concat(this.store.clientId,"] use ").concat(c," join uid ").concat(o));const p=t.gatewayAddrs.map((_=>{let{address:g}=_;const[b,v]=g.split(":"),R={host:b,port:v};return t.proxyServer&&(R.proxy=t.proxyServer),R}));let m;m=this.store.useDcSignal?await this.signal.init(t.apResponse.addresses):await this.signal.init(p),o=m.uid,S.debug("[".concat(this.store.clientId,"] ").concat(c," join uid ").concat(o," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(p){var u;throw p.code===N.INIT_DATACHANNEL_TIMEOUT&&this.signal.__name__==="AgoraRTCSignal"||Se.joinGateway(t.sid,{lts:r,succ:!1,ec:((u=p.data)===null||u===void 0?void 0:u.desc)||p.code,errorMsg:p.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!a||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:t.preload}),p&&p.code===N.INIT_DATACHANNEL_TIMEOUT?(S.warning("[".concat(this.store.clientId,"] User join datachannel failed"),p.toString()),this.resetSignal(),p):(S.error("[".concat(this.store.clientId,"] User join failed"),p.toString()),s.delete(t.uid),this.signal.close(),p)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),S.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval((()=>{this.updateTrafficStats().catch((p=>{S.warning("[".concat(this.store.clientId,"] get traffic stats error"),p.toString())}))}),3e3),this.networkQualityInterval=window.setInterval((()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Xt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Xt.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Xt.NETWORK_QUALITY,{uplinkNetworkQuality:em(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:em(this._statsCollector.trafficStats.B_dnq)}):this.emit(Xt.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})}),2e3),this.store.joinGatewayEnd(),o}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==Ze.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==$e.CONNECTED||await(function(i,r){return r===1/0?i:de.race([i,xY(r)])})(this.signal.request(Ce.LEAVE,void 0,!0),3e3)}catch(i){S.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),i)}this.signal.close(n),n!==Ze.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:I("PUB_EXTEND"),twcc:!!I("PUBLISH_TWCC"),rtx:!!I("USE_PUB_RTX")};try{return(await this.signal.request(Ce.PUBLISH,r,!0))._message}catch(s){if(i&&s.data&&s.data.code===we.ERR_PUBLISH_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),s.toString()),await this.tryUnpubBeforeRepub(t,n),this.publish(t,n,!1);throw s}}async publishDataChannel(t,n,i){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const s={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(r=n.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request(Ce.PUBLISH_DATASTREAM,s,!0)}catch(o){if(i&&o.data&&o.data.code===we.ERR_PUBLISH_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),o.toString()),await this.tryUnpubDataChannelBeforeRepub(t,n),this.publishDataChannel(t,n,!1);throw o}}async unpublish(t,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Ce.UNPUBLISH,{stream_id:n,ortc:t},!0)}catch(i){S.warning("[".concat(this.store.clientId,"] unpublish warning: "),i)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await de.all(t.map((n=>this.signal.request(Ce.UNPUBLISH_DATASTREAM,{channel_id:n},!0))))}catch(n){S.warning("unpublish datachannels warning: ",n)}}async presubscribe(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!I("SUBSCRIBE_TWCC"),rtx:!!I("USE_SUB_RTX")||void 0,extend:I("SUB_EXTEND"),svc:Array.isArray(I("SVC"))&&I("SVC").length!==0?I("SVC"):void 0};try{return await this.signal.request(Ce.PRE_SUBSCRIBE,r,!0)}catch(s){if(i&&s.data&&s.data.code===we.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),s.toString()),this.presubscribe(t,n,!1);throw s}}async subscribe(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!I("SUBSCRIBE_TWCC"),rtx:!!I("USE_SUB_RTX"),extend:I("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(I("SVC"))&&I("SVC").length!==0?I("SVC"):void 0};try{return(await this.signal.request(Ce.SUBSCRIBE,r,!0))._message}catch(s){if(i&&s.data&&s.data.code===we.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),s.toString()),await this.tryUnsubBeforeResub(t,n),await this.subscribe(t,n,!1);throw s}}async subscribeDataChannel(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const r={uid:t,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request(Ce.SUBSCRIBE_DATASTREAM,r,!0)}catch(s){if(i&&s.data&&s.data.code===we.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),s.toString()),await this.tryUnsubDataChannelBeforeResub(t,n),await this.subscribeDataChannel(t,n,!1);throw s}}async subscribeAll(t,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!I("USE_SUB_RTX"),twcc:!!I("SUBSCRIBE_TWCC"),svc:Array.isArray(I("SVC"))&&I("SVC").length!==0?I("SVC"):void 0};try{return await this.signal.request(Ce.SUBSCRIBE_STREAMS,i,!0)}catch(r){if(n&&r.data&&r.data.code===we.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw r}}async setVideoProfile(t){const n=(function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let r=i.frameRate,s=i.width,o=i.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,s||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,r||(a=!1)),a?{stream_type:0,width:s,height:o,fps:r,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0})(t);if(n)return this.signal.request(Ce.SET_VIDEO_PROFILE,n);S.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,n){try{await this.signal.request(Ce.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:n},!0)}catch(i){S.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),i)}}async unsubscribeDataChannel(t,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await de.all(t.map((i=>this.signal.request(Ce.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:n},!0))))}catch(i){S.warning("unsubscribeDataChannel warning: ",i)}}async massUnsubscribe(t){try{await this.signal.request(Ce.UNSUBSCRIBE_STREAMS,t,!0)}catch(n){S.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n)}}async reconnectPC(t){const{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=t;return{gatewayEstablishParams:await this.signal.request(Ce.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Ce.GATEWAY_INFO)}async renewToken(t){await this.signal.request(Ce.RENEW_TOKEN,t),this.key=t.token}updateClientRole(t,n){n&&(this._clientRoleOptions=Object.assign({},n)),I("CLIENT_ROLE_OPTIONS")&&(S.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(I("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},I("CLIENT_ROLE_OPTIONS"))),this.role=t}async setClientRole(t,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),I("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},I("CLIENT_ROLE_OPTIONS")),S.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(I("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=t);let i,r=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0;const s=Object.assign({},n);delete s.delay,delete s.level,await this.signal.request(Ce.SET_CLIENT_ROLE,An(An({role:t,level:r,delay:i},s),{},{client_ts:Date.now()})),this.role=t}async setDualStreamMode(t,n,i){await this.signal.request(Ce.SET_DUAL_STREAM_MODE,{mode:t},i,n)}async setRemoteVideoStreamType(t,n){await this.signal.request(Ce.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:n})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(Ce.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,n){await this.signal.request(Ce.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:n})}async pickSVCLayer(t,n){await this.signal.request(Ce.PICK_SVC_LAYER,{stream_id:t,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})}async setRTM2Flag(t){await this.signal.request(Ce.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,n,i){if(this.store.useP2P)return this.signal.sendExtensionMessage(t,n,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),An({},this.inChannelInfo)}async setConfigure(t){if(t&&Array.isArray(t)&&t.length!==0)return this.signal.request(Ce.CONFIGURE,t)}async getGatewayVersion(){return(await this.signal.request(Ce.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=oy.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0),this.usingProxy=!1}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=(function(n){let i;return i=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),i?{username:xn.username,password:xn.password,turnServerURL:i[2],tcpport:parseInt(i[3])+30,udpport:parseInt(i[3])+30,forceturn:!1}:null})((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(An(An({},xn),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const t=await this.signal.request(Ce.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach((n=>{const i=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find((r=>r.peer_uid===n.peer_uid));i&&i.B_st!==n.B_st&&yp((()=>{this.emit(Xt.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st)}))})),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){var n,i,r,s;if(!this.joinInfo||!this.key)throw new Y(N.UNEXPECTED_ERROR,"can not generate join message, no join info");const o=Object.assign({},this.joinInfo.apResponse);let a=I("REPORT_APP_SCENARIO");if(typeof a!="string")try{a=JSON.stringify(a)}catch{a=void 0}var c;a&&a.length>128&&(a=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(Xt.UPDATE_GATEWAY_CONFIG),c=this.store.clientId,ie(hd).call(hd,c)||hd.push(c);const u=Vl(this.store),p=!((n=this.isPreallocation)===null||n===void 0||!n.call(this)),m=MO(this.store),_=aq(),g=Yr(87)||W0()||GE(117),b=((function(){const D=st();if(D.name!==at.SAFARI||!D.browserVersion)return!1;const x=D.browserVersion.split(".");return Number(x[0])>18||Number(x[0])===18&&Number(x[1])>=4})()||Y0(18,4,!1))&&HE(18,6,!0)&&this.spec.codec==="h264"&&I("ENABLE_ABSSENDTIME_AS_SENTTS"),v=!(((i=o.detail)===null||i===void 0?void 0:i[3])!=="CN"||!I("ENABLE_QUALITY_FALLBACK"))&&I("ENABLE_QUALITY_FALLBACK"),R=!!I("ENABLE_AP_MULTI_IP")&&((r=o.detail)===null||r===void 0?void 0:r[5])==="multi-ip",O=An({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:tr,browser:navigator.userAgent,process_id:I("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:R||this.hasChangeBGPAddress,ap_response:o,extend:I("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:a,attributes:{userAttributes:An(An({enableEncodedTransform:(!!I("ENABLE_AUDIO_METADATA")||!!I("ENABLE_AUDIO_PTS"))&&g||!!I("ENABLE_AUDIO_TOPN")&&WE(at.CHROME,87,116)||void 0,enableAudioMetadata:!!I("ENABLE_AUDIO_METADATA")&&g,enableAudioPts:!!I("ENABLE_AUDIO_PTS")&&g,topnSmoothLevel:I("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:I("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:I("TOPN_SWITCH_HOLD_MS"),topnAudioGain:I("TOPN_AUDIO_GAIN"),enableNetworkQualityProbe:this.store.networkQualityProbe,enablePublishedUserList:I("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:I("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:Li("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:Li("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:Li("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:I("USE_PUB_RTX")===!0||I("USE_SUB_RTX")===!0||void 0,disableFEC:I("DISABLE_FEC"),enableNTPReport:!!I("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:m,enableFulllinkAvSync:!!I("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:Li("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!I("FORCE_ENABLE_AUT_CC")||!Op()&&(!!I("ENABLE_AUT_FEEDBACK")||void 0),rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!I("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:Li("USE_XR","boolean"),enableLossbasedBwe:Li("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!I("FORCE_ENABLE_AUT_CC")||!Op()&&(!!I("ENABLE_AUT_CC")||void 0),enableCCFallback:Li("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:p,preSubNum:u?Li("PRE_SUB_NUM","number"):void 0,enablePubTWCC:Li("PUBLISH_TWCC","boolean"),enableSubTWCC:Li("SUBSCRIBE_TWCC","boolean"),enablePubRTX:Li("USE_PUB_RTX","boolean"),enableSubRTX:Li("USE_SUB_RTX","boolean"),enableSubSVC:I("ENABLE_SVC")?I("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(I("SVC"))&&I("SVC").length!==0?I("SVC"):void 0,enableSvcExtended:I("ENABLE_SVC")&&Array.isArray(I("SVC_EXTENDED"))&&I("SVC_EXTENDED").length!==0?I("SVC_EXTENDED"):void 0,enableVosFallback:I("ENABLE_VOS_FALLBACK"),enableQualityFallback:v},_),{},{audioDuplicate:Li("ENABLE_AUDIO_RED","boolean")?(s=Li("AUDIO_DUPLICATE_NUM","number"))!==null&&s!==void 0?s:2:void 0,senttsUsesAbsSendTime:!!b||void 0,enableDualStreamFlag:Li("ENABLE_DUAL_STREAM_FLAG","boolean")})},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(O.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(O.aes_mode=this.joinInfo.aesmode,I("ENCRYPT_AES")?(O.aes_secret=this.joinInfo.aespassword,O.aes_encrypt=!0):O.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(O.aes_salt=this.joinInfo.aessalt)),o.addresses[this.signal.websocket.currentURLIndex]&&(O.ap_response.ticket=o.addresses[this.signal.websocket.currentURLIndex].ticket,delete o.addresses),this.joinInfo.defaultVideoStream!==void 0&&(O.default_video_stream=this.joinInfo.defaultVideoStream),O}getRejoinMessage(){if(!this.joinInfo)throw new Y(N.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(Te.WS_RECONNECT_CREATE_CONNECTION,(t=>{this.joinGatewayStartTime=Date.now()})),this.signal.on(Te.WS_RECONNECTING,(t=>{this.joinInfo&&Se.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||kn.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",Se.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())})),this.signal.on(Te.WS_CLOSED,(t=>{let n;switch(t){case Ze.LEAVE:n=kn.LEAVE;break;case Ze.UID_BANNED:case Ze.IP_BANNED:case Ze.CHANNEL_BANNED:case Ze.SERVER_ERROR:n=kn.SERVER_ERROR;break;case Ze.FALLBACK:n=kn.FALLBACK;break;case Ze.LICENSE_MISSING:case Ze.LICENSE_EXPIRED:case Ze.LICENSE_MINUTES_EXCEEDED:case Ze.LICENSE_PERIOD_INVALID:case Ze.LICENSE_MULTIPLE_SDK_SERVICE:case Ze.LICENSE_ILLEGAL:case Ze.TOKEN_EXPIRE:n=t;break;default:n=kn.NETWORK_ERROR}S.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+kn.NETWORK_ERROR)),this.joinInfo&&Se.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===Ze.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=t,t!==Ze.FALLBACK&&(this.state="DISCONNECTED"),this.reset()})),this.signal.on(Te.WS_CONNECTED,(()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){const t=I("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;t&&(t.level||t.delay)&&(S.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(t.level,", delay: ").concat(t.delay)),this.setClientRole(this.role,t))}if(Se.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void S.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));St("EVENT_REPORT_DOMAIN",t[1]),St("EVENT_REPORT_BACKUP_DOMAIN",t[1]),St("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}})),this.signal.on(Le.ON_UPLINK_STATS,(t=>{this._statsCollector.updateUplinkStats(t)})),this.signal.on(Te.REQUEST_RECOVER,((t,n,i)=>{if(!this.joinInfo)return i(new Y(N.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,sn(this,Xt.REQUEST_NEW_GATEWAY_LIST).then(n).catch(i)})),this.signal.on(Te.REQUEST_JOIN_INFO,(async(t,n,i)=>{var r,s,o;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));const a=Dt((r=this.joinInfo)===null||r===void 0?void 0:r.turnServer);if(I("NEW_TURN_MODE")&&a&&((s=this.joinInfo)===null||s===void 0?void 0:s.cloudProxyServer)==="disabled"){var c;let _=a.servers.map((v=>"turnServerURL"in v&&I("USE_TURN_IP")?An(An({},v),{},{turnServerURL:$p(v.turnServerURL)}):v)),g=(c=a.serversFromGateway)===null||c===void 0?void 0:c.map((v=>I("USE_TURN_IP")?An(An({},v),{},{turnServerURL:$p(v.turnServerURL)}):v));const b=this.signal.currentURLIndex;_.length>0&&(_=[_[b%_.length]],a.servers=_),Array.isArray(g)&&g.length>0&&(g=[g[0]],a.serversFromGateway=g),S.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(b))}const{iceParameters:u,dtlsParameters:p,rtpCapabilities:m}=await sn(this,Xt.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:a,cloudProxyServer:(o=this.joinInfo)===null||o===void 0?void 0:o.cloudProxyServer});try{t(this.getJoinMessage({ortc:{iceParameters:u,dtlsParameters:p,rtpCapabilities:m,version:"2"}}))}catch(_){n(_)}})),this.signal.on(Te.REQUEST_REJOIN_INFO,(t=>{t(this.getRejoinMessage())})),this.signal.on(Te.REPORT_JOIN_GATEWAY,((t,n)=>{if(!this.joinInfo)return;let i,r="";var s;t instanceof Y?(i=((s=t.data)===null||s===void 0?void 0:s.desc)||t.code,r=t.message):i=t,Se.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:i,errorMsg:r,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload})})),this.signal.on(Te.IS_P2P_DISCONNECTED,(t=>{t(va(this,Xt.IS_P2P_DISCONNECTED))})),this.signal.on(Te.DISCONNECT_P2P,(()=>{this.emit(Xt.DISCONNECT_P2P)})),this.signal.on(Te.REQUEST_SUCCESS,(()=>{this._signalTimeout=!1})),this.signal.on(Te.REQUEST_TIMEOUT,(()=>{this._signalTimeout=!0})),this.signal.on(Te.JOIN_RESPONSE,(t=>{const n=this.getCurrentGatewayAddress();this.emit(Xt.JOIN_RESPONSE,t,n)})),this.signal.on(Te.PRE_CONNECT_PC,(async(t,n)=>{if(this.joinInfo){var i,r;this.updateTurnConfigFromSignal();const o=this.getCurrentGatewayAddress(),a=Dt((i=this.joinInfo)===null||i===void 0?void 0:i.turnServer);if(I("NEW_TURN_MODE")&&a&&((r=this.joinInfo)===null||r===void 0?void 0:r.cloudProxyServer)==="disabled"){var s;let u=a.servers.map((_=>"turnServerURL"in _&&I("USE_TURN_IP")?An(An({},_),{},{turnServerURL:$p(_.turnServerURL)}):_)),p=(s=a.serversFromGateway)===null||s===void 0?void 0:s.map((_=>I("USE_TURN_IP")?An(An({},_),{},{turnServerURL:$p(_.turnServerURL)}):_));const m=this.signal.currentURLIndex;u.length>0&&(u=[u[m%u.length]],a.servers=u),Array.isArray(p)&&p.length>0&&(p=[p[0]],a.serversFromGateway=p),S.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(m,",in pre pc"))}const c=I("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(o&&c){const u=wP(o);sn(this,Xt.PRE_CONNECT_PC,{candidates:u,fingerprint:c,turnServer:a}).then((p=>{t?.(p)})).catch(n||(()=>{}))}}})),this.signal.on(Te.RECOVER_NOTIFICATION,(t=>{this.joinInfo&&typeof I("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(I("AP_REQUEST_DETAIL"),";").concat(t))})),this.signal.on(Te.VOS_FALLBACK,(t=>{this.emit(Xt.VOS_FALLBACK,t)})),this.signal.on(Te.DATACHANNEL_FAILBACK,(t=>{S.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Xt.DATACHANNEL_FAILBACK)}))}async tryUnsubBeforeResub(t,n){try{await this.signal.request(Ce.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[n]},!0)}catch(i){throw S.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),i),i}}async tryUnsubDataChannelBeforeResub(t,n){try{await this.signal.request(Ce.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(i){throw S.warning("unsubscribe datachannel warning",i),i}}async tryUnpubBeforeRepub(t,n){try{await this.signal.request(Ce.UNPUBLISH,{stream_id:t,ortc:n},!0)}catch(i){throw S.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}}async tryUnpubDataChannelBeforeRepub(t,n){try{await this.signal.request(Ce.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(i){throw S.warning("unpublish datastream warning: ",i),i}}async tryMassUnsubBeforeResub(t){const n={users:t.map((i=>({stream_id:i.stream_id,stream_type:i.stream_type})))};try{await this.signal.request(Ce.UNSUBSCRIBE_STREAMS,n,!0)}catch(i){throw S.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}}async muteLocal(t,n){const i={action:t.find((r=>r.stream_type===_t.Audio))?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:n};try{await this.signal.request(Ce.CONTROL,i,!0,!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(t,n){const i={action:t.find((r=>r.stream_type===_t.Audio))?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:n};try{await this.signal.request(Ce.CONTROL,i,!0,!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(t,n){const i={action:t===_e.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Ce.CONTROL,i,!0,!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(t,n){const i={action:t===_e.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(Ce.CONTROL,i,!0,!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,n){this.signal.upload(t,n)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(Ce.RESTART_ICE,n,!0)}catch(i){throw S.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),i),i}}reconnect(t,n){this.state==="CONNECTED"&&this.signal.reconnect(t||void 0,n||kn.P2P_FAILED)}getCurrentGatewayAddress(){var t,n;if(!I("GATEWAY_WSS_ADDRESS"))return I("USE_CANDIDATE_FROM_AP_DETAIL")&&(t=this.joinInfo)!==null&&t!==void 0&&t.apGatewayAddress?(S.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(n=this.joinInfo)!==null&&n!==void 0&&n.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(Ce.SET_PARAMETER,{enablePublishAudioFilter:t})}downgradeCodec(t){this.signal.downgradeCodec(t)}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Ze.FALLBACK)),this.store.useDcSignal=!1,this.signal=new mP(An(An({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Xt.RESET_SIGNAL)}}let om=0,ay=0;function $r(e,t,n,i){return new de(((r,s)=>{t.timeout=t.timeout||I("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),om+=ys(t.data)):n&&(t.data.size?om+=t.data.size:t.data instanceof FormData?om+=hO(t.data):om+=ys(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ui.request(t).then((o=>{typeof o.data=="string"?ay+=ys(o.data):o.data instanceof ArrayBuffer||o.data instanceof Uint8Array?ay+=o.data.byteLength:ay+=ys(JSON.stringify(o.data)),i&&r({data:o.data,headers:o.headers}),r(o.data)})).catch((o=>{ui.isCancel(o)?s(new Y(N.OPERATION_ABORTED,"cancel token canceled")):o.code==="ECONNABORTED"?s(new Y(N.NETWORK_TIMEOUT,o.message)):o.response?s(new Y(N.NETWORK_RESPONSE_ERROR,o.response.status)):s(new Y(N.NETWORK_ERROR,o.message))}))}))}(function(){var e;function t(ee){var ce=0;return function(){return ce<ee.length?{done:!1,value:ee[ce++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(ee,ce,ge){return ee==Array.prototype||ee==Object.prototype||(ee[ce]=ge.value),ee},i,r=(function(ee){ee=[typeof globalThis=="object"&&globalThis,ee,typeof window=="object"&&window,typeof self=="object"&&self,typeof f=="object"&&f];for(var ce=0;ce<ee.length;++ce){var ge=ee[ce];if(ge&&ge.Math==Math)return ge}throw Error("Cannot find global object")})(this);function s(ee,ce){if(ce)e:{var ge=r;ee=ee.split(".");for(var te=0;te<ee.length-1;te++){var T=ee[te];if(!(T in ge))break e;ge=ge[T]}(ce=ce(te=ge[ee=ee[ee.length-1]]))!=te&&ce!=null&&n(ge,ee,{configurable:!0,writable:!0,value:ce})}}function o(ee){return(ee={next:ee})[Symbol.iterator]=function(){return this},ee}function a(ee){var ce=typeof Symbol<"u"&&Symbol.iterator&&ee[Symbol.iterator];return ce?ce.call(ee):{next:t(ee)}}if(s("Symbol",(function(ee){function ce(T,k){this.A=T,n(this,"description",{configurable:!0,writable:!0,value:k})}if(ee)return ee;ce.prototype.toString=function(){return this.A};var ge="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",te=0;return function T(k){if(this instanceof T)throw new TypeError("Symbol is not a constructor");return new ce(ge+(k||"")+"_"+te++,k)}})),s("Symbol.iterator",(function(ee){if(ee)return ee;ee=Symbol("Symbol.iterator");for(var ce="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),ge=0;ge<ce.length;ge++){var te=r[ce[ge]];typeof te=="function"&&typeof te.prototype[ee]!="function"&&n(te.prototype,ee,{configurable:!0,writable:!0,value:function(){return o(t(this))}})}return ee})),typeof Object.setPrototypeOf=="function")i=Object.setPrototypeOf;else{var c;e:{var u={};try{u.__proto__={a:!0},c=u.a;break e}catch{}c=!1}i=c?function(ee,ce){if(ee.__proto__=ce,ee.__proto__!==ce)throw new TypeError(ee+" is not extensible");return ee}:null}var p=i;function m(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function _(ee){if(ee.m)throw new TypeError("Generator is already running");ee.m=!0}function g(ee,ce){return ee.h=3,{value:ce}}function b(ee){this.g=new m,this.G=ee}function v(ee,ce,ge,te){try{var T=ce.call(ee.g.j,ge);if(!(T instanceof Object))throw new TypeError("Iterator result "+T+" is not an object");if(!T.done)return ee.g.m=!1,T;var k=T.value}catch(F){return ee.g.j=null,ee.g.s(F),R(ee)}return ee.g.j=null,te.call(ee.g,k),R(ee)}function R(ee){for(;ee.g.h;)try{var ce=ee.G(ee.g);if(ce)return ee.g.m=!1,{value:ce.value,done:!1}}catch(ge){ee.g.v=void 0,ee.g.s(ge)}if(ee.g.m=!1,ee.g.l){if(ce=ee.g.l,ee.g.l=null,ce.F)throw ce.D;return{value:ce.return,done:!0}}return{value:void 0,done:!0}}function O(ee){this.next=function(ce){return ee.o(ce)},this.throw=function(ce){return ee.s(ce)},this.return=function(ce){return(function(ge,te){_(ge.g);var T=ge.g.j;return T?v(ge,"return"in T?T.return:function(k){return{value:k,done:!0}},te,ge.g.return):(ge.g.return(te),R(ge))})(ee,ce)},this[Symbol.iterator]=function(){return this}}function D(ee,ce){return ce=new O(new b(ce)),p&&ee.prototype&&p(ce,ee.prototype),ce}if(m.prototype.o=function(ee){this.v=ee},m.prototype.s=function(ee){this.l={D:ee,F:!0},this.h=this.C||this.u},m.prototype.return=function(ee){this.l={return:ee},this.h=this.u},b.prototype.o=function(ee){return _(this.g),this.g.j?v(this,this.g.j.next,ee,this.g.o):(this.g.o(ee),R(this))},b.prototype.s=function(ee){return _(this.g),this.g.j?v(this,this.g.j.throw,ee,this.g.o):(this.g.s(ee),R(this))},s("Array.prototype.entries",(function(ee){return ee||function(){return(function(ce,ge){ce instanceof String&&(ce+="");var te=0,T=!1,k={next:function(){if(!T&&te<ce.length){var F=te++;return{value:ge(F,ce[F]),done:!1}}return T=!0,{done:!0,value:void 0}}};return k[Symbol.iterator]=function(){return k},k})(this,(function(ce,ge){return[ce,ge]}))}})),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var x=function(ee,ce){for(var ge=0;ge<ee.length;ge++)ce(ee[ge])},B=function(ee){return ee.replace(/\r?\n|\r/g,`\r
`)},G=function(ee,ce,ge){return ce instanceof Blob?(ge=ge!==void 0?ge+"":typeof ce.name=="string"?ce.name:"blob",ce.name===ge&&Object.prototype.toString.call(ce)!=="[object Blob]"||(ce=new File([ce],ge)),[String(ee),ce]):[String(ee),String(ce)]},j=function(ee,ce){if(ee.length<ce)throw new TypeError(ce+" argument required, but only "+ee.length+" present.")},H=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,Z=H.FormData,ne=H.XMLHttpRequest&&H.XMLHttpRequest.prototype.send,he=H.Request&&H.fetch,De=H.navigator&&H.navigator.sendBeacon,Oe=H.Element&&H.Element.prototype,Ge=H.Symbol&&Symbol.toStringTag;Ge&&(Blob.prototype[Ge]||(Blob.prototype[Ge]="Blob"),"File"in H&&!File.prototype[Ge]&&(File.prototype[Ge]="File"));try{new File([],"")}catch{H.File=function(ce,ge,te){return ce=new Blob(ce,te||{}),Object.defineProperties(ce,{name:{value:ge},lastModified:{value:+(te&&te.lastModified!==void 0?new Date(te.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Ge&&Object.defineProperty(ce,Ge,{value:"File"}),ce}}var Ue=function(ee){return ee.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},ct=function(ee){this.i=[];var ce=this;ee&&x(ee.elements,(function(ge){if(ge.name&&!ge.disabled&&ge.type!=="submit"&&ge.type!=="button"&&!ge.matches("form fieldset[disabled] *"))if(ge.type==="file"){var te=ge.files&&ge.files.length?ge.files:[new File([],"",{type:"application/octet-stream"})];x(te,(function(T){ce.append(ge.name,T)}))}else ge.type==="select-multiple"||ge.type==="select-one"?x(ge.options,(function(T){!T.disabled&&T.selected&&ce.append(ge.name,T.value)})):ge.type==="checkbox"||ge.type==="radio"?ge.checked&&ce.append(ge.name,ge.value):(te=ge.type==="textarea"?B(ge.value):ge.value,ce.append(ge.name,te))}))};if((e=ct.prototype).append=function(ee,ce,ge){j(arguments,2),this.i.push(G(ee,ce,ge))},e.delete=function(ee){j(arguments,1);var ce=[];ee=String(ee),x(this.i,(function(ge){ge[0]!==ee&&ce.push(ge)})),this.i=ce},e.entries=function ee(){var ce,ge=this;return D(ee,(function(te){if(te.h==1&&(ce=0),te.h!=3)return ce<ge.i.length?te=g(te,ge.i[ce]):(te.h=0,te=void 0),te;ce++,te.h=2}))},e.forEach=function(ee,ce){j(arguments,1);for(var ge=a(this),te=ge.next();!te.done;te=ge.next()){var T=a(te.value);te=T.next().value,T=T.next().value,ee.call(ce,T,te,this)}},e.get=function(ee){j(arguments,1);var ce=this.i;ee=String(ee);for(var ge=0;ge<ce.length;ge++)if(ce[ge][0]===ee)return ce[ge][1];return null},e.getAll=function(ee){j(arguments,1);var ce=[];return ee=String(ee),x(this.i,(function(ge){ge[0]===ee&&ce.push(ge[1])})),ce},e.has=function(ee){j(arguments,1),ee=String(ee);for(var ce=0;ce<this.i.length;ce++)if(this.i[ce][0]===ee)return!0;return!1},e.keys=function ee(){var ce,ge,te,T,k=this;return D(ee,(function(F){if(F.h==1&&(ce=a(k),ge=ce.next()),F.h!=3)return ge.done?void(F.h=0):(te=ge.value,T=a(te),g(F,T.next().value));ge=ce.next(),F.h=2}))},e.set=function(ee,ce,ge){j(arguments,2),ee=String(ee);var te=[],T=G(ee,ce,ge),k=!0;x(this.i,(function(F){F[0]===ee?k&&(k=!te.push(T)):te.push(F)})),k&&te.push(T),this.i=te},e.values=function ee(){var ce,ge,te,T,k=this;return D(ee,(function(F){if(F.h==1&&(ce=a(k),ge=ce.next()),F.h!=3)return ge.done?void(F.h=0):(te=ge.value,(T=a(te)).next(),g(F,T.next().value));ge=ce.next(),F.h=2}))},ct.prototype._asNative=function(){for(var ee=new Z,ce=a(this),ge=ce.next();!ge.done;ge=ce.next()){var te=a(ge.value);ge=te.next().value,te=te.next().value,ee.append(ge,te)}return ee},ct.prototype._blob=function(){var ee="----formdata-polyfill-"+Math.random(),ce=[],ge="--"+ee+`\r
Content-Disposition: form-data; name="`;return this.forEach((function(te,T){return typeof te=="string"?ce.push(ge+Ue(B(T))+`"\r
\r
`+B(te)+`\r
`):ce.push(ge+Ue(B(T))+'"; filename="'+Ue(te.name)+`"\r
Content-Type: `+(te.type||"application/octet-stream")+`\r
\r
`,te,`\r
`)})),ce.push("--"+ee+"--"),new Blob(ce,{type:"multipart/form-data; boundary="+ee})},ct.prototype[Symbol.iterator]=function(){return this.entries()},ct.prototype.toString=function(){return"[object FormData]"},Oe&&!Oe.matches&&(Oe.matches=Oe.matchesSelector||Oe.mozMatchesSelector||Oe.msMatchesSelector||Oe.oMatchesSelector||Oe.webkitMatchesSelector||function(ee){for(var ce=(ee=(this.document||this.ownerDocument).querySelectorAll(ee)).length;0<=--ce&&ee.item(ce)!==this;);return-1<ce}),Ge&&(ct.prototype[Ge]="FormData"),ne){var Ut=H.XMLHttpRequest.prototype.setRequestHeader;H.XMLHttpRequest.prototype.setRequestHeader=function(ee,ce){Ut.call(this,ee,ce),ee.toLowerCase()==="content-type"&&(this.B=!0)},H.XMLHttpRequest.prototype.send=function(ee){ee instanceof ct?(ee=ee._blob(),this.B||this.setRequestHeader("Content-Type",ee.type),ne.call(this,ee)):ne.call(this,ee)}}he&&(H.fetch=function(ee,ce){return ce&&ce.body&&ce.body instanceof ct&&(ce.body=ce.body._blob()),he.call(this,ee,ce)}),De&&(H.navigator.sendBeacon=function(ee,ce){return ce instanceof ct&&(ce=ce._asNative()),De.call(this,ee,ce)}),H.FormData=ct}})();const Xl=()=>{const e=I("AREAS");return e.length===0&&e.push(lt.GLOBAL),$i(e).call(e,((t,n,i)=>{const r=UP(n);return r?i===0?r:"".concat(t,",").concat(r):t}),"")},UP=e=>e===lt.OVERSEA?"".concat(jn.ASIA,",").concat(jn.EUROPE,",").concat(jn.AFRICA,",").concat(jn.NORTH_AMERICA,",").concat(jn.SOUTH_AMERICA,",").concat(jn.OCEANIA):jn[e],dq=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map((n=>{const i=Jp[n],r=Object.keys(i);r&&r.map((s=>{s!=="CODE"&&(t[s]=t[s].concat(i[s]))}))})),t},am={GLOBAL:{ASIA:[lt.CHINA,lt.JAPAN,lt.INDIA,lt.KOREA,lt.HKMC],EUROPE:[],NORTH_AMERICA:[lt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},cm=Object.keys(am[lt.GLOBAL]),cy=[lt.CHINA,lt.NORTH_AMERICA,lt.EUROPE,lt.ASIA,lt.JAPAN,lt.INDIA,lt.OCEANIA,lt.SOUTH_AMERICA,lt.AFRICA,lt.KOREA,lt.HKMC,lt.US],lq=function(e,t){let n=[];if(ie(e).call(e,lt.GLOBAL)){const s=[lt.GLOBAL,lt.OVERSEA],o=Object.keys(Jp);if(t===lt.GLOBAL)throw new Y(N.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===lt.CHINA)n=[lt.OVERSEA];else if(r=t,ie(cm).call(cm,r)){const a=(i=t,am[lt.GLOBAL][i]||[]),c=[...s,t,...a];n=o.filter((u=>!ie(c).call(c,u)))}else if((function(a){let c=!1;return cm.forEach((u=>{var p;ie(p=am[lt.GLOBAL][u]).call(p,a)&&(c=!0)})),c})(t)){const a=(function(u){let p;return cm.forEach((m=>{var _;ie(_=am[lt.GLOBAL][m]).call(_,u)&&(p=m)})),p})(t),c=[...s,a,t];n=o.filter((u=>!ie(c).call(c,u)))}else n=e;n=(function(a){const c=[];return cy.forEach((u=>{ie(a).call(a,u)&&c.push(u)})),c.concat(a.filter((u=>!ie(cy).call(cy,u))))})(n)}else n=e;var i,r;return n};function VP(e){var t,n;if(!e&&ie(t=I("AREAS")).call(t,lt.EXTENSIONS))return S.debug("update area from ap : reset"),void dy(Sz,!0);if(!ie(n=I("AREAS")).call(n,lt.GLOBAL)||!e)return;let i=Jp.EXTENSIONS;i&&(i={CODE:UP(lt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},S.debug("update area from ap success: ".concat(e,",config is "),i),St("AREAS",[lt.EXTENSIONS],!0),Object.keys(i).map((r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?St(r,i[r][0]):St(r,i[r])})))}function dy(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=Se.reportApiInvoke(null,{name:xt.SET_AREA,options:e,tag:Ct.TRACER});try{let i=[];if(typeof e=="string"&&(i=[e]),Array.isArray(e)&&(e.forEach((s=>{if(!ie(aP).call(aP,s))throw new Y(N.INVALID_PARAMS,"invalid area code")})),i=e),Object.prototype.toString.call(e)==="[object Object]"){const{areaCode:s,excludedArea:o}=e;if(!s)throw new Y(N.INVALID_PARAMS,"area code is needed");let a=s;typeof s=="string"&&(a=[s]),i=o?lq(a,o):a}if(!t){if(Bi.AREAS){const s=new Y(N.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(s),void S.warning("setArea is prohibited because of config-distribute")}if(ie(i).call(i,lt.GLOBAL)&&I("AREAS")===lt.EXTENSIONS){const s=new Y(N.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(s),void S.warning("setArea is prohibited because of ap extensions")}}St("AREAS",i,t);const r=dq(i);Object.keys(r).map((s=>{s==="LOG_UPLOAD_SERVER"||s==="EVENT_REPORT_DOMAIN"||s==="EVENT_REPORT_BACKUP_DOMAIN"||s==="PROXY_SERVER_TYPE3"?St(s,r[s][0]):St(s,r[s])})),S.debug("set area success:",i.join(","))}catch(i){throw n.onError(i),i}n.onSuccess()}function jP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function As(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?jP(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):jP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let ly=1;function uq(e,t,n,i,r){ly+=1;const s={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:ly,requestId:ly,version:tr,cname:n.cname},o={service_name:t,json_body:JSON.stringify(s)};let a,c,u=e[0];return zr((async()=>{a=Date.now();const p=await $r(u,{data:o,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,p.code!==0){const g=new Y(N.UNEXPECTED_RESPONSE,"live streaming ap error, code"+p.code,{retry:!0,responseTime:c});throw S.error(g.toString()),g}const m=JSON.parse(p.json_body);if(m.code!==200){const g=new Y(N.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(m.code,", reason: ").concat(m.reason),{code:m.code,responseTime:c});throw S.error(g.toString()),g}if(!m.servers||m.servers.length===0){const g=new Y(N.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:m.code,responseTime:c});throw S.error(g.toString()),g}const _=(function(g,b){return{addressList:g.servers.map((v=>"wss://".concat(v.address.replace(/\./g,"-"),".").concat(I("WORKER_DOMAIN"),":").concat(v.wss,"?serviceName=").concat(encodeURIComponent(b)))),workerToken:g.workerToken,vid:g.vid}})(m,t);return I("LIVE_STREAMING_ADDRESS")&&(_.addressList=I("LIVE_STREAMING_ADDRESS")instanceof Array?I("LIVE_STREAMING_ADDRESS"):[I("LIVE_STREAMING_ADDRESS")]),As(As({},_),{},{responseTime:c})}),((p,m)=>(Se.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(p.addressList),firstSuccess:m===0,responseTime:c,serverIp:e[m%e.length]}),!1)),((p,m)=>(Se.apworkerEvent(n.sid,{success:!1,sc:p.data&&p.data.code||200,serviceName:t,responseTime:c,serverIp:e[m%e.length]}),!!(p.code!==N.OPERATION_ABORTED&&p.code!==N.UNEXPECTED_RESPONSE||p.data&&p.data.retry)&&(u=e[(m+1)%e.length],!0))),r)}let uy=1;function FP(e,t,n,i){let{url:r,areaCode:s}=e;const{clientId:o,sid:a}=t,c=Date.now();let u;const p=t.role,[m,_]=py(t,s,[en.CHOOSE_SERVER]);let g=Gt.networkState;return zr((async()=>{g&&Gt.networkState===ii.OFFLINE&&Gt.onlineWaiter&&await de.race([Gt.onlineWaiter,En(i&&i.maxRetryTimeout||$t.maxRetryTimeout)]),g=Gt.networkState;const{data:b,headers:v}=await $r(r,{data:m,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);u=v.http3==="1"?1:-1,Se.reportResourceTiming(r,a),WP(b,r,t,c,[en.CHOOSE_SERVER],u);const R=Gl(b,en.CHOOSE_SERVER);return hy(R),ZS(R,r)}),(b=>(b&&Se.joinChooseServer(a,{role:p,lts:c,succ:!0,csAddr:r,opid:_,serverList:b.gatewayAddrs.map((v=>v.address)),ec:null,cid:b.cid.toString(),uid:b.uid.toString(),csIp:b.csIp,unilbsServerIds:[en.CHOOSE_SERVER].toString(),isHttp3:u,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:b.res.detail&&b.res.detail[38],vid:b.vid}),!1)),(b=>b.code!==N.OPERATION_ABORTED&&(b.code===N.CAN_NOT_GET_GATEWAY_SERVER?b.data.retry:(Se.joinChooseServer(a,{role:p,lts:c,succ:!1,csAddr:r,serverList:null,opid:_,ec:b.code,csIp:b.data&&b.data.csIp,unilbsServerIds:[en.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:g}),isHttp3:u,corssRegionTagReq:t.apRequestDetail}),S.warning("[".concat(o||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),b),!0))),i)}function BP(e,t,n,i){let r,{url:s,areaCode:o,serviceIds:a}=e;const c=Date.now(),u=t.role,[p,m]=py(t,o,a);let _;return zr((async()=>{_&&Gt.networkState===ii.OFFLINE&&Gt.onlineWaiter&&await de.race([Gt.onlineWaiter,En(i&&i.maxRetryTimeout||$t.maxRetryTimeout)]),_=Gt.networkState;const{data:g,headers:b}=await $r(s,{data:p,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=b.http3==="1"?1:-1,Se.reportResourceTiming(s,t.sid),WP(g,s,t,c,a,r);const v=Gl(g,en.CHOOSE_SERVER),R=Gl(g,t.cloudProxyServer==="proxy5"?en.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?en.CLOUD_PROXY:en.CLOUD_PROXY_FALLBACK),O=performance.getEntriesByName(s),D=O[O.length-1];let x;return D&&(x={name:D.name,protocol:"nextHopProtocol"in D?D.nextHopProtocol:"",dnscost:"domainLookupEnd"in D&&"domainLookupStart"in D&&typeof D.domainLookupEnd=="number"&&typeof D.domainLookupStart=="number"?D.domainLookupEnd-D.domainLookupStart:-1,tcpTlsCost:"connectEnd"in D&&"connectStart"in D&&typeof D.connectEnd=="number"&&typeof D.connectStart=="number"?D.connectEnd-D.connectStart:-1,reqCost:"requestStart"in D&&typeof D.requestStart=="number"&&"responseEnd"in D&&typeof D.responseEnd=="number"?D.responseEnd-D.requestStart:-1,handleCost:"leave_ts"in g&&"enter_ts"in g&&typeof g.leave_ts=="number"&&typeof g.enter_ts=="number"?g.leave_ts-g.enter_ts:-1}),hy(v),{gatewayInfo:ZS(v,s),proxyInfo:R,url:s,resourceTimingInfo:x}}),(g=>{var b;return g.gatewayInfo&&Se.joinChooseServer(t.sid,{role:u,lts:c,succ:!0,csAddr:s,serverList:g.gatewayInfo.gatewayAddrs.map((v=>v.address)),ec:null,opid:m,cid:g.gatewayInfo.cid.toString(),uid:g.gatewayInfo.uid.toString(),csIp:g.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:g.gatewayInfo.res.detail&&g.gatewayInfo.res.detail[38],vid:(b=g.gatewayInfo)===null||b===void 0?void 0:b.vid,resourceTimingInfo:g.resourceTimingInfo?JSON.stringify(g.resourceTimingInfo):void 0}),g.proxyInfo&&Se.joinWebProxyAP(t.sid,{lts:c,sucess:1,apServerAddr:s,turnServerAddrList:g.proxyInfo.addresses.map((v=>v.ip)).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:a.toString()}),!1}),(g=>g.code!==N.OPERATION_ABORTED&&(g.code===N.CAN_NOT_GET_GATEWAY_SERVER?g.data.retry:(Se.joinWebProxyAP(t.sid,{lts:c,sucess:0,apServerAddr:s,turnServerAddrList:null,errorCode:g.code,eventType:t.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:_})}),S.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),g),!0))),i)}const WP=(e,t,n,i,r,s)=>{const{sid:o,clientId:a,cloudProxyServer:c}=n,u=[],p=m=>{m.flag===4096?Se.joinChooseServer(o,{role:n.role,lts:i,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:m.error.message,csIp:m.error.data&&m.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:s,corssRegionTagReq:n.apRequestDetail}):m.flag!==1048576&&m.flag!==4194304&&m.flag!==4194310||Se.joinWebProxyAP(o,{lts:i,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:m.error.code,eventType:c,unilbsServerIds:r.toString()})};if(e.response_body.forEach((m=>{const _=m.buffer.code;if(m.uri===23&&_===0&&!m.buffer.edges_services)if(m.buffer.flag===4194310)S.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),m.buffer.edges_services=[];else{const g={error:new Y(N.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:I("NO_EDGES_RETRY"),csIp:e.detail[502]}),flag:m.buffer.flag};u.push(g),p(g)}if(_!==0){const g=_d(_),b={error:new Y(N.CAN_NOT_GET_GATEWAY_SERVER,g.desc,{desc:g.desc,retry:g.retry,csIp:e.detail[502]}),flag:m.buffer.flag};m.buffer.flag===4194310?S.warning(b.error.toString()):u.push(b),p(b)}})),u.length)throw S.warning("[".concat(a||"sid-".concat(o.slice(0,6)),"] multi unilbs ").concat(t," failed, ").concat(u.map((m=>"flag: ".concat(m.flag,", message: ").concat(m.error.message,", retry: ").concat(m.error.data.retry))).join(" | "))),new Y(N.CAN_NOT_GET_GATEWAY_SERVER,u.map((m=>"flag: ".concat(m.flag,", message: ").concat(m.error.message))).join(" | "),{retry:!!u.find((m=>m.error.data.retry)),csIp:e.detail[502],desc:[...new Set(u.map((m=>{var _;return m==null||(_=m.error)===null||_===void 0||(_=_.data)===null||_===void 0?void 0:_.desc})).filter((m=>!!m)))]})},hy=e=>{var t,n,i,r;if(e.addresses&&e.addresses.length===0&&e.code===0)throw new Y(N.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(I("AP_AREA")&&((i=e.detail)!==null&&i!==void 0&&i[23]&&typeof((r=e.detail)===null||r===void 0?void 0:r[23])=="string"?VP(e.detail[23].toLowerCase()):VP()),(t=e.detail)!==null&&t!==void 0&&t[19]&&typeof((n=e.detail)===null||n===void 0?void 0:n[19])=="string"){const o=e.detail[19],a=o?.split(";");for(let c=0;c<a.length;c++){var s;const u=ti(s=a[c]).call(s);e.addresses[c]&&a&&(e.addresses[c].fingerprint=u)}}if(I("GATEWAY_ADDRESS")&&I("GATEWAY_ADDRESS").length>0){S.debug("assign gateway address to",I("GATEWAY_ADDRESS"));const o=I("GATEWAY_ADDRESS").map((a=>{var c,u;const p=(c=(u=e.addresses.find((m=>m.ip===a.ip&&m.port===a.port)))===null||u===void 0?void 0:u.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:a.fingerprint||p}}));e.addresses=o}},hq=(e,t)=>{if(e.response_body&&e.response_body.length){const n=e.response_body[0];if(n.buffer.code!==0){const i=_d(n.buffer.code);throw new Y(N.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(i.desc),{retry:i.retry})}return n.buffer.ticket}throw S.debug("update ticket request received ap response without response body:",t),new Y(N.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},py=(e,t,n)=>{const i=Math.floor(Math.random()*1e12),r=e.role==="host"?"1":e.role==="audience"?"2":void 0,s={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:As(As(As({6:e.stringUid,11:t,12:I("USE_NEW_TOKEN")?"1":void 0},r?{17:r}:{}),{},{22:t},e.apRequestDetail?{33:e.apRequestDetail}:{}),e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:n,uid:e.uid||0}}]};s.request_bodies.forEach((a=>{e.multiIP&&e.multiIP.gateway_ip&&(a.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))}));const o=new FormData;return o.append("request",JSON.stringify(s)),[o,i]},pq=(e,t)=>{const n=Math.floor(Math.random()*1e12),i={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map((s=>({ip:s.ip,port:s.port})))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,n]};let Sd=0;function yd(e){return de.all(e.map((t=>t.then((n=>{throw n}),(n=>n))))).then((t=>{throw t}),(t=>t))}const Jl=async e=>{let{fragementLength:t,referenceList:n,asyncMapHandler:i,allFailedhandler:r,promisesCollector:s}=e,o=0;const a=t;let c,u=0;const p=async()=>{const m=(()=>{const _=o*a,g=_+a;return n.slice(_,g).map(i)})();s&&s.push(...m);try{c=await yd(m)}catch(_){if(u+=a,o++,!(u>=n.length))return void await p();r(_)}m.forEach((_=>_.cancel()))};return await p(),c},GP=async e=>{let{referenceList:t,asyncMapHandler:n,closeFn:i}=e;const r=t.length;let s=0;const o=async()=>{const a=n(t.shift());try{return await a}catch(c){if(s++,s>=r||i!=null&&i(c))throw c;return o()}};return o()};async function mq(){if(typeof VideoDecoder>"u")return!0;let e;const t=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,85,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,149,160,133,4,144,43,122,168,159,120,159,205,39,82,131,57,52,87,187,68,23,248,134,204,226,97,17,49,183,55,236,219,249,221,98,208,215,190,59,179,167,213,47,1,246,150,14,194,245,159,83,35,64,103,218,38,21,82,3,135,21,185,84,248,134],n=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,148,62,134,140,92,172,141,77,35,94,181,164,65,169,65,156,154,43,221,162,11,252,67,102,113,48,136,137,219,62,43,113,239,23,126,250,186,252,10,138,218,25,193,244,74,68,194,209,107,23,52,206,199,78,72,98,103,151,71,96,62,51,210,158,72,231,158],i=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,143,233,163,51,196,98,95,151,224,22,134,33,240,150,248,67,18,34,196,142,81,238,173,140,80,205,232,132,144,67,12,131,157,4,171,243,86,122,35,6,166,184,243,85,126,13,206,103,152,62,168,160,187,2,241,138,52,211,72,121,128,151,63,147,128,19,42],r=[18,0,50,138,1,48,192,64,253,248,65,17,67,192,32,0,16,0,0,0,0,0,0,0,195,12,48,144,64,32,0,209,75,61,9,204,25,115,79,226,115,63,63,208,70,210,220,153,126,241,237,37,107,195,153,1,99,112,230,189,209,169,130,10,11,22,167,215,159,205,197,7,183,162,26,48,254,141,134,103,32,16,235,45,1,15,18,119,169,110,206,251,51,115,202,60,148,1,46,39,109,25,28,86,168,15,77,211,239,2,58,43,146,26,230,184,81,48,140,226,226,250,222,146,171,133,164,13,188,180,64,122,142,146,32,208,238,170,193,35,53,44,225],s=[18,0,50,107,48,0,133,125,248,65,26,195,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,204,24,122,65,56,165,18,52,206,218,4,187,51,97,9,29,191,90,253,106,185,31,197,155,52,205,245,185,203,131,20,226,25,124,95,113,220,113,141,15,15,104,211,144,152,237,150,157,127,51,143,24,231,218,171,255,176,241,128,229,149,150,148,66,245,228,91,27,182,228,136,61,182,237,133,45,220,24,103,214,152],o=[18,0,50,122,48,1,9,253,248,65,26,67,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,198,182,231,242,220,235,163,140,12,36,36,166,46,132,210,4,71,23,218,132,27,30,17,45,244,79,31,243,195,136,100,169,76,88,142,85,204,217,121,168,29,163,198,17,251,223,73,12,212,244,139,123,151,179,75,216,96,208,136,40,229,42,59,149,10,116,228,85,99,93,221,108,255,140,248,20,30,167,122,109,206,164,108,197,110,251,23,243,133,160,63,13,207,177,12,128];return await new de(((c,u)=>{let p;(async function(){e&&e.state!=="closed"||await(async function(){e=new VideoDecoder({output:_=>{_.close(),clearTimeout(p),c(!0)},error:_=>{clearTimeout(p),c(!1)}}),await e.configure({codec:"av01.0.05M.08",width:160,height:90})})();const m=[t,n,i,r,s,o];for(let _=0;_<m.length;_++){const g=new EncodedVideoChunk({type:_==0?"key":"delta",timestamp:33333*_,duration:33333,data:new Uint8Array(m[_])});try{await e.decode(g)}catch{return void c(!1)}}})(),p=setTimeout((()=>{c(!1)}),5e3)}))}async function dm(e,t,n,i){return{gatewayInfo:await(async function(s,o,a,c){let u=null;const p=[],m=async()=>{const g=I("WEBCS_DOMAIN").slice(0,I("AJAX_REQUEST_CONCURRENT")).map((R=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(R+"/api/v2/transpond/webrtc?v=2"):"https://".concat(R,"/api/v2/transpond/webrtc?v=2"),areaCode:Xl()}))),b=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:g.map((R=>R.url))}),v=await Jl({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:g,asyncMapHandler:R=>(S.debug("[".concat(s.clientId,"] Connect to choose_server:"),R.url),FP(R,s,o,a)),allFailedhandler:R=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},b),R[0]},promisesCollector:p});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},b),v},_=async()=>{if(await En(1e3),u!==null)return u;const g=I("WEBCS_DOMAIN_BACKUP_LIST").map((R=>({url:s.proxyServer?"https://".concat(s.proxyServer,"/ap/?url=").concat(R+"/api/v2/transpond/webrtc?v=2"):"https://".concat(R,"/api/v2/transpond/webrtc?v=2"),areaCode:Xl()}))),b=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:g.map((R=>R.url))}),v=await Jl({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:g,asyncMapHandler:R=>(S.debug("[".concat(s.clientId,"] Connect to backup choose_server:"),R.url),FP(R,s,o,a)),allFailedhandler:R=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},b),R[0]},promisesCollector:p});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},b),v};try{return u=await yd([m(),_()]),p.length&&p.forEach((g=>g.cancel&&typeof g.cancel=="function"&&g.cancel())),u}catch(g){throw g[0]}})(e,t,n,i)}}async function HP(e,t,n,i,r){const s=e.cloudProxyServer;if(s==="disabled"){if(e.useLocalAccessPoint)return await dm(e,t,n,r);if(I("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:_,proxyInfo:g}=await zP(e,t,n,r);if(e.turnServer&&e.turnServer.mode!=="auto")return{gatewayInfo:_};const b=g.map((v=>({turnServerURL:v.address,tcpport:v.tcpport||xn.tcpport,udpport:v.udpport||xn.udpport,username:v.username||xn.username,password:v.password||xn.password,forceturn:!1,security:!0})));if(r.useP2P){var o;const v=(o=e.uid)!==null&&o!==void 0?o:_.uid,R="glb:".concat(v.toString()),O=await XE(R),D=g.map((x=>({turnServerURL:x.address,tcpport:x.tcpport||xn.tcpport,udpport:x.udpport||xn.udpport,username:R,password:O,forceturn:!1,security:!0})));b.push(...D)}return e.turnServer={mode:"manual",servers:b},{gatewayInfo:_}}return await dm(e,t,n,r)}const{proxyInfo:a,gatewayInfo:c}=await zP(e,t,n,r),u={gatewayInfo:c},p=a.map((_=>({turnServerURL:_.address,tcpport:s==="proxy3"?void 0:_.tcpport?_.tcpport:xn.tcpport,udpport:s==="proxy4"?void 0:_.udpport?_.udpport:xn.udpport,username:_.username||xn.username,password:_.password||xn.password,forceturn:s!=="proxy4",security:s==="proxy5"})));if(r.useP2P){var m;const _=(m=e.uid)!==null&&m!==void 0?m:c.uid,g="glb:".concat(_.toString()),b=await XE(g),v=a.map((R=>({turnServerURL:R.address,tcpport:s==="proxy3"?void 0:R.tcpport||xn.tcpport,udpport:s==="proxy4"?void 0:R.udpport||xn.udpport,username:g,password:b,forceturn:s!=="proxy4",security:s==="proxy5"})));p.push(...v)}return e.turnServer={mode:"manual",servers:p},S.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(s)),u}async function KP(e,t,n,i,r){const s=I("ACCOUNT_REGISTER").slice(0,I("AJAX_REQUEST_CONCURRENT"));let o=[];o=t.proxyServer?s.map((c=>"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1"))):s.map((c=>"https://".concat(c,"/api/v1")));const a=r?.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:o});try{const c=await(async function(u,p,m,_,g){const b=Date.now(),v={sid:m.sid,opid:10,appid:m.appId,string_uid:p};let R=u[0];const O=await zr((()=>$r(R+"".concat(R.indexOf("?")===-1?"?":"&","action=stringuid"),{data:v,cancelToken:_,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}})),((D,x)=>{if(D.code===0){if(D.uid<=0||D.uid>=Math.pow(2,32))throw S.error("Invalid Uint Uid ".concat(p," => ").concat(D.uid),D),Se.reqUserAccount(v.sid,{lts:b,success:!1,serverAddr:R,stringUid:v.string_uid,uid:D.uid,errorCode:N.INVALID_UINT_UID_FROM_STRING_UID,extend:v}),new Y(N.INVALID_UINT_UID_FROM_STRING_UID);return Se.reqUserAccount(v.sid,{lts:b,success:!0,serverAddr:R,stringUid:v.string_uid,uid:D.uid,errorCode:null,extend:v}),!1}const B=_d(D.code);return B.retry&&(R=u[(x+1)%u.length]),Se.reqUserAccount(v.sid,{lts:b,success:!1,serverAddr:R,stringUid:v.string_uid,uid:D.uid,errorCode:B.desc,extend:v}),B.retry}),((D,x)=>D.code!==N.OPERATION_ABORTED&&(Se.reqUserAccount(v.sid,{lts:b,success:!1,serverAddr:R,stringUid:v.string_uid,uid:null,errorCode:D.code,extend:v}),R=u[(x+1)%u.length],!0)),g);if(O.code!==0){const D=_d(O.code);throw new Y(N.UNEXPECTED_RESPONSE,D.desc)}return O})(o,e,t,n,i);return r?.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r?.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function fq(e,t,n){const i=I("ACCOUNT_REGISTER");let r=[];r=t.proxyServer?i.map((s=>"https://".concat(t.proxyServer,"/ap/?url=").concat(s+"/api/v1"))):i.map((s=>"https://".concat(s,"/api/v1")));try{return await GP({referenceList:r,asyncMapHandler:o=>(async function(a,c,u,p){const m=Date.now(),_={sid:u.sid,opid:10,appid:u.appId,string_uid:c};try{const g=await $r(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:_,cancelToken:p,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(g.code!==0){const b=_d(g.code);throw new Y(N.UNEXPECTED_RESPONSE,"preload sua error:".concat(b.desc),b)}if(g.uid<=0||g.uid>=Math.pow(2,32))throw new Y(N.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:m,url:a,req:_,uid:g.uid,elapse:Date.now()-m}}catch(g){throw g}})(o,e,t,n),closeFn:o=>o.code===N.OPERATION_ABORTED||o.code===N.UNEXPECTED_RESPONSE&&!o.data.retry})}catch(s){throw s}}async function _q(e,t,n){const i=I("CDS_AP").slice(0,I("AJAX_REQUEST_CONCURRENT")).map((c=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config"))),r=i.map((c=>(function(u,p,m,_){const g=st(),b={flag:64,cipher_method:0,features:As(As(As(As(As({install_id:cS(),device:g.name,system:g.os,system_general:navigator.userAgent,vendor:p.appId,version:tr,cname:p.cname,session_id:p.sid,proxyServer:p.proxyServer,sdk_type:oq.WEB_RTC,browser_name:g.name,browser_version:g.version,user_agent:navigator.userAgent,channel_name:p.cname},p.stringUid&&{string_uid:p.stringUid}),p.uid&&{uid:p.uid+""}),g.os&&{os_name:g.os}),g.osVersion&&{os_version:g.osVersion}),{},{detail:""})};return zr((()=>$r(u,{data:b,timeout:1e3,cancelToken:m,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}})),void 0,(v=>v.code!==N.OPERATION_ABORTED),_)})(c,e,t,n)));let s=null,o=null,a={};try{s=await yd(r)}catch(c){if(c.code===N.OPERATION_ABORTED)throw c;o=c}if(r.forEach((c=>c.cancel())),Se.reportApiInvoke(e.sid,{name:xt.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:s}}).onSuccess(),s&&s.test_tags)try{a=(function(c){if(!c.test_tags)return{};const u=c.test_tags,p=Object.keys(u),m={};return p.forEach((_=>{var g;const b=ti(g=_.slice(4)).call(g),v=JSON.parse(u[_]),R=v[1];m[b]={tag:v[0]||"",value:R}})),m})(s)}catch{}return a}async function YP(e,t){const n=I("WEBCS_DOMAIN").concat(I("WEBCS_DOMAIN_BACKUP_LIST")).map((i=>({url:"https://".concat(i,"/api/v2/transpond/webrtc?v=2"),areaCode:Xl(),serviceIds:[en.CHOOSE_SERVER,en.CLOUD_PROXY_FALLBACK]})));try{return await GP({referenceList:n,asyncMapHandler:r=>(async function(s,o,a){let c,{url:u,areaCode:p,serviceIds:m}=s;const _=Date.now(),[g,b]=py(o,p,m);let v=Gt.networkState;try{v&&Gt.networkState===ii.OFFLINE&&Gt.onlineWaiter&&await de.race([Gt.onlineWaiter,En($t.maxRetryTimeout)]),v=Gt.networkState;const{data:R,headers:O}=await $r(u,{data:g,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=O.http3==="1"?1:-1,(G=>{const j=[];if(G.response_body.forEach((H=>{const Z=H.buffer.code;if(H.uri===23&&Z===0&&!H.buffer.edges_services)if(H.buffer.flag===4194310)H.buffer.edges_services=[];else{const ne={error:new Y(N.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:I("NO_EDGES_RETRY"),csIp:G.detail[502]}),flag:H.buffer.flag};j.push(ne)}if(Z!==0){const ne=_d(Z),he={error:new Y(N.CAN_NOT_GET_GATEWAY_SERVER,ne.desc,{desc:ne.desc,retry:ne.retry,csIp:G.detail[502]}),flag:H.buffer.flag};H.buffer.flag===4194310?S.warning(he.error.toString()):j.push(he)}})),j.length)throw new Y(N.CAN_NOT_GET_GATEWAY_SERVER,j.map((H=>"flag: ".concat(H.flag,", message: ").concat(H.error.message))).join(" | "),{retry:!!j.find((H=>H.error.data.retry)),csIp:G.detail[502],desc:[...new Set(j.map((H=>{var Z;return H==null||(Z=H.error)===null||Z===void 0||(Z=Z.data)===null||Z===void 0?void 0:Z.desc})).filter((H=>!!H)))]})})(R);const x=Gl(R,en.CHOOSE_SERVER),B=Gl(R,en.CLOUD_PROXY_FALLBACK);return hy(x),{gatewayInfo:ZS(x,u),proxyInfo:B,opid:b,requestTime:_,url:u,isHttp3:c,elapse:Date.now()-_}}catch(R){throw R}})(r,e,t),closeFn:r=>r.code===N.OPERATION_ABORTED||r.code===N.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(i){throw i}}async function zP(e,t,n,i){const r=I("PROXY_SERVER_TYPE3"),s=(g,b,v)=>{let R=v||r;return Array.isArray(R)&&(R=b%2==0&&r[1]||r[0]),"https://".concat(R,"/ap/?url=").concat(g)};let o=null;const a=[],c=async()=>{const g=I("WEBCS_DOMAIN").slice(0,I("AJAX_REQUEST_CONCURRENT")).map(((R,O)=>{let D;return D=e.cloudProxyServer==="disabled"&&e.proxyServer?s("".concat(R,"/api/v2/transpond/webrtc?v=2"),O,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(R,"/api/v2/transpond/webrtc?v=2"):s("".concat(R,"/api/v2/transpond/webrtc?v=2"),O),{url:D,areaCode:Xl(),serviceIds:[en.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?en.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?en.CLOUD_PROXY:en.CLOUD_PROXY_FALLBACK]}})),b=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:g.map((R=>R.url))}),v=await Jl({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:g,asyncMapHandler:R=>(S.debug("[".concat(e.clientId,"] Connect to choose_server:"),R.url),BP(R,e,t,n)),allFailedhandler:R=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},b),R[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},b),v},u=async()=>{if(await En(1e3),o!==null)return o;const g=I("WEBCS_DOMAIN_BACKUP_LIST").map(((R,O)=>{let D;return D=e.cloudProxyServer==="disabled"&&e.proxyServer?s("".concat(R,"/api/v2/transpond/webrtc?v=2"),O,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(R,"/api/v2/transpond/webrtc?v=2"):s("".concat(R,"/api/v2/transpond/webrtc?v=2"),O),{url:D,areaCode:Xl(),serviceIds:[en.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?en.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?en.CLOUD_PROXY:en.CLOUD_PROXY_FALLBACK]}})),b=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:g.map((R=>R.url))}),v=await Jl({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:g,asyncMapHandler:R=>(S.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),R.url),BP(R,e,t,n)),allFailedhandler:R=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},b),R[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},b),v};let p,m,_;try{({gatewayInfo:p,proxyInfo:m,url:_}=await yd([c(),u()]))}catch(g){throw g[0]}if(a.length&&a.forEach((g=>g.cancel&&typeof g.cancel=="function"&&g.cancel())),!p||!m)throw new Y(N.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=_,e.cloudProxyServer!=="disabled"&&Array.isArray(r)&&_){const g=/^https?:\/\/(.+?)(\/.*)?$/.exec(_)[1];ie(r).call(r,g)&&(e.proxyServer=g,S.setProxyServer(g),Se.setProxyServer(g))}return o={gatewayInfo:p,proxyInfo:await gP(m,p.uid)},o}async function gq(e,t,n){const i=I("UAP_AP").slice(0,I("AJAX_REQUEST_CONCURRENT")).map((s=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(s+"/api/v1?action=uap"):"https://".concat(s,"/api/v1?action=uap"))),r=i.map((s=>(function(o,a,c,u){const p={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:tr,cname:a.cname,uid:a.uid.toString(),requestId:uy,seq:uy};uy+=1;const m={service_name:"tele_channel",json_body:JSON.stringify(p)};return zr((async()=>{const _=await $r(o,{data:m,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(_.code!==0){const b=new Y(N.UNEXPECTED_RESPONSE,"cross channel ap error, code"+_.code,{retry:!0});throw S.error(b.toString()),b}const g=JSON.parse(_.json_body);if(g.code!==200){const b=new Y(N.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(g.code,", reason: ").concat(g.reason));throw S.error(b.toString()),b}if(!g.servers||g.servers.length===0){const b=new Y(N.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw S.error(b.toString()),b}return{vid:g.vid,workerToken:g.workerToken,addressList:(I("CHANNEL_MEDIA_RELAY_SERVERS")||g.servers).map((b=>"wss://".concat(b.address.replace(/\./g,"-"),".").concat(I("WORKER_DOMAIN"),":").concat(b.wss)))}}),void 0,(_=>!!(_.code!==N.OPERATION_ABORTED&&_.code!==N.UNEXPECTED_RESPONSE||_.data&&_.data.retry)),u)})(s,e,t,n)));try{const s=await yd(r);return r.forEach((o=>o.cancel())),s}catch(s){throw s[0]}}async function Eq(e,t,n){let i=null;const r=[],s=async o=>{const a=I(o?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map((c=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2")));return o&&(await En(1e3),i!==null)?i:await Jl({fragementLength:I("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(S.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(o?"backup":""," choose_server:"),c),(function(u,p,m,_){const[g]=pq(p,[en.CHOOSE_SERVER]);let b=Gt.networkState;return zr((async()=>{b&&Gt.networkState===ii.OFFLINE&&Gt.onlineWaiter&&await de.race([Gt.onlineWaiter,En(_&&_.maxRetryTimeout||$t.maxRetryTimeout)]),b=Gt.networkState;const v=await $r(u,{data:g,cancelToken:m,headers:{"Content-Type":"multipart/form-data;"}},!0);return hq(v,u)}),(()=>!1),(v=>v.code!==N.OPERATION_ABORTED&&(v.code===N.UPDATE_TICKET_FAILED?v.data.retry:(S.warning("[".concat(p.clientId,"] update ticket network error, retry"),v),!0))),_)})(c,e,t,n)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return i=await yd([s(!1),s(!0)]),r.length&&r.forEach((o=>o.cancel&&typeof o.cancel=="function"&&o.cancel())),i}catch(o){throw o[0]}}function qP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function my(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?qP(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):qP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class Sq extends Vt{get isSuccess(){return!!this.configs}constructor(t,n){super(),C(this,"configs",void 0),C(this,"store",void 0),C(this,"joinInfo",void 0),C(this,"cancelToken",void 0),C(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),C(this,"interval",void 0),C(this,"mutex",void 0),C(this,"mutableParamsRead",!1),C(this,"configCache",{}),C(this,"limit_bitrate",void 0),this.mutex=new Cn("config-distribute",t),this.store=n}startGetConfigDistribute(t,n){this.joinInfo=t,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),I("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval((()=>{this.updateConfigDistribute()}),I("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,Se.reportApiInvoke(null,{options:void 0,name:xt.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Ct.TRACER}).onSuccess(JSON.stringify(Bi))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void S.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const n=await this.mutex.lock();try{t=await _q(this.joinInfo,this.cancelToken,this.retryConfig),S.debug("[config-distribute] get config distribute",JSON.stringify(t));const i=(function(r){var s;const o=la(s=Object.keys(r).filter((u=>/^webrtc_ng_global_parameter/.test(u)))).call(s);for(let u=0;u<o.length;u++)for(let p=o.length-1;p>u;p--){const m=o[p],_=r[m].value;if(typeof _.__priority=="number"){const g=_.__priority,b=o[p-1],v=r[b].value;if(typeof v.__priority=="number"){if(!(g>v.__priority))continue;{const R=m;o[p]=o[p-1],o[p-1]=R}}else{const R=m;o[p]=o[p-1],o[p-1]=R}}}const a=Date.now(),c={};return o.forEach((u=>{const p=r[u].value.__expires;p&&p<=a||(c[u]=r[u])})),c})(t);this.cacheGlobalParameterConfig(i),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=i}catch(i){const r=new Y(N.NETWORK_RESPONSE_ERROR,i);S.warning("[config-distribute] ".concat(r.toString()))}finally{n()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(t){cP(t)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==t.id&&this.emit(Jr.UPDATE_BITRATE_LIMIT,t):this.emit(Jr.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.limit_bitrate&&my({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(t){try{const n={},i=Object.keys(t),r=[];i.forEach((s=>{const o=t[s].value;n[s]=o;const a=o.__id;if(a&&this.configCache[s]&&this.configCache[s].__id===a)return;const c=o.__type,u=t[s].value,p=t[s].tag;let m=0;c?c===AO.REALTIME&&(m=1):Object.keys(u).some((_=>Object.prototype.hasOwnProperty.call(hS,_)||!FS()&&Object.prototype.hasOwnProperty.call(wp,_)?(m=1,!0):void 0)),r.push({tag:p,isApplied:m,feature:s,params:JSON.stringify(o)})})),r.forEach((s=>{let{tag:o,feature:a,params:c,isApplied:u}=s;this.store.sessionId&&Se.abTest(this.store.sessionId,{intSucc:1,isApplied:u,tag:o,feature:a,params:c,cid:this.store.cid,uid:this.store.intUid})})),this.configCache=n}catch(n){S.debug("handleABTestConfigDistribute error",n)}}cacheGlobalParameterConfig(t){const n=(function(r){const s={};return Object.keys(r).forEach((o=>{const a=r[o].value,c=a.__expires,u=a.__type;Object.keys(a).forEach((p=>{p==="__id"||p==="__type"||p==="__priority"||p==="__expires"||Object.prototype.hasOwnProperty.call(s,p)||(s[p]=my(my({value:a[p]},c&&{expires:c}),u&&{type:u}))}))})),s})(t);try{var i;const r=(i=n.LIMIT_BITRATE)===null||i===void 0?void 0:i.value;delete n.LIMIT_BITRATE,r&&cP(r)&&this.handleBitrateLimit(r),this.limit_bitrate=r,this.handleGlobalParameterConfig(n),this.handleABTestConfigDistribute(t),(function(a){try{const c=Date.now();Object.keys(a).forEach((u=>{const{value:p,type:m,expires:_}=a[u];_&&_<=c||((m===AO.REALTIME||Object.prototype.hasOwnProperty.call(hS,u))&&(Bi[u]=p,ft[u]=p,S.debug("Update realtime parameters from config distribute",u,p)),m||FS()||!Object.prototype.hasOwnProperty.call(wp,u)||(Bi[u]=p,ft[u]=p,S.debug("Update gateway parameters from config distribute",u,p)))}))}catch(c){S.error("Error update config immediately: ".concat(a),c.message)}})(n);const s=JSON.stringify(n),o=window.btoa(s);window.localStorage.setItem("websdk_ng_global_parameter",o),S.debug("Caching global parameters ".concat(s))}catch(r){S.error("Error caching global parameters:",r.message)}}handleGlobalParameterConfig(t){try{const n=Date.now();Object.keys(t).forEach((i=>{switch(i){case"CLIENT_ROLE_OPTIONS":if(Object.prototype.hasOwnProperty.call(ft,i)){const{value:s,expires:o}=t[i];if(o&&o<=n)return;eS(ft[i],s)||(Bi[i]=s,ft[i]=s,this.emit(Jr.UPDATE_CLIENT_ROLE_OPTIONS,s),S.debug("Updating client role options: ".concat(JSON.stringify(s))))}break;case"REMOTE_VIDEO_STREAM_TYPE":if(Object.prototype.hasOwnProperty.call(ft,i)){var r;const{value:s,expires:o}=t[i];if(o&&o<=n)return;typeof s=="number"&&ie(r=[0,1,4,5,6,7,8,9]).call(r,s)&&(Bi[i]={value:s},ft[i]=s,this.emit(Jr.UPDATE_REMOTE_VIDEO_STREAM_TYPE,s),S.debug("Updating client remote stream type: ".concat(JSON.stringify(s))))}break;case"ENABLE_FORCE_HLS":if(Object.prototype.hasOwnProperty.call(ft,i)){const{value:s,expires:o}=t[i];if(o&&o<=n)return;eS(ft[i],s)||(Bi[i]=s,ft[i]=s,this.emit(Jr.FALLBACK_TO_HLS,s),S.debug("Updating enable force hls: ".concat(JSON.stringify(s))))}break;case"VOS_CONFIGURE":if(Object.prototype.hasOwnProperty.call(ft,i)){const{value:s,expires:o}=t[i];if(o&&o<=n)return;eS(ft[i],s)||(Bi[i]=s,ft[i]=s,this.emit(Jr.UPDATE_VOS_CONFIGURE,s),S.debug("Updating vos configure: ".concat(JSON.stringify(s))))}}}))}catch(n){S.error("Error handling global parameter config:",n.message)}}}class yq extends Vt{constructor(){super(...arguments),C(this,"resultStorage",new Map)}setLocalAudioStats(t,n,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(i,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(i,n))}setLocalVideoStats(t,n,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(i,n)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(i,n)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(i)),!n.muted&&this.record("VIDEO_ENCODE_FAILED",t,this.checResolutionSent(i))}setRemoteAudioStats(t,n){const i=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(n))}setRemoteVideoStats(t,n){const i=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(n))}record(t,n,i){if(I("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const r=this.resultStorage.get(t);if(!r)return;r.result.push(i);const s=t==="VIDEO_ENCODE_FAILED"?I("ENCODE_EXCEPTION_TIMES"):5;if(r.result.length>=s){var o;const a=ie(o=r.result).call(o,!0);r.isPrevNormal&&!a&&this.emit("exception",fy[t],t,n),!r.isPrevNormal&&a&&this.emit("exception",fy[t]+2e3,t+"_RECOVER",n),r.isPrevNormal=a,r.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,n){return n instanceof dn&&!n.isActive||!!n.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,n){let i=null;n._encoderConfig&&n._encoderConfig.frameRate&&(i=fi(n._encoderConfig.frameRate));const r=t.captureFrameRate;return!i||!r||!(i>10&&r<5||i<10&&i>=5&&r<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checResolutionSent(t){var n;return!(!t.codecType||ie(n=I("ENCODE_EXCEPTION_VALIDATE_CODEC")).call(n,t.codecType.toLocaleLowerCase()))||!t.captureFrameRate||t.sendFrameRate!==0||t.sendResolutionWidth!==0||t.sendResolutionHeight!==0}checkSendVideoBitrate(t,n){return!!n.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,n){return n instanceof dn&&!n.isActive||!!n.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}const fy={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003,VIDEO_ENCODE_FAILED:2004},Fn=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}measureFromPublishStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}};function XP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function ja(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?XP(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):XP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class Ql{constructor(t){C(this,"store",void 0),C(this,"onStatsException",void 0),C(this,"onUploadPublishDuration",void 0),C(this,"onStatsChanged",void 0),C(this,"onVideoCodecChanged",void 0),C(this,"localStats",new Map),C(this,"remoteStats",new Map),C(this,"updateStatsInterval",void 0),C(this,"trafficStats",void 0),C(this,"trafficStatsPeerList",[]),C(this,"uplinkStats",void 0),C(this,"exceptionMonitor",void 0),C(this,"p2pChannel",void 0),C(this,"scalabilityMode",Cp.L1T1),C(this,"updateStats",(()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))})),this.store=t,this.exceptionMonitor=new yq,this.exceptionMonitor.on("exception",((n,i,r)=>{this.onStatsException&&this.onStatsException(n,i,r)}))}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(re.LocalAudioTrack)||ja({},ES)}getLocalVideoTrackStats(){return this.localStats.get(re.LocalVideoTrack)||ja({},SS)}getRemoteAudioTrackStats(t){const n=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find((c=>c.peer_uid===s));return a&&(o.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),o},i={};if(t){var r;const s=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.audioStats;s&&(i[t]=n(t,s))}else Array.from(this.remoteStats.entries()).forEach((s=>{let[o,{audioStats:a}]=s;a&&(i[o]=n(o,a))}));return i}getRemoteNetworkQualityStats(t){const n={};if(t){var i;const r=(i=this.remoteStats.get(t))===null||i===void 0?void 0:i.networkStats;r&&(n[t]=r)}else Array.from(this.remoteStats.entries()).forEach((r=>{let[s,{networkStats:o}]=r;o&&(n[s]=o)}));return n}getNetworkQuality(){let t=0,n=0;return this.trafficStats&&(t=em(this.trafficStats.B_unq),n=em(this.trafficStats.B_dnq)),{uplinkNetworkQuality:t,downlinkNetworkQuality:n}}getRemoteVideoTrackStats(t){const n=(s,o)=>{if(!this.trafficStats)return o;const a=this.trafficStats.peer_delay.find((c=>c.peer_uid===s));return a&&(o.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),o},i={};if(t){var r;const s=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.videoStats;s&&(i[t]=n(t,s))}else Array.from(this.remoteStats.entries()).forEach((s=>{let[o,{videoStats:a}]=s;a&&(i[o]=n(o,a))}));return i}getRTCStats(){let t=0,n=0,i=0,r=0;const s=this.localStats.get(re.LocalAudioTrack);s&&(t+=s.sendBytes,n+=s.sendBitrate);const o=this.localStats.get(re.LocalVideoTrack);o&&(t+=o.sendBytes,n+=o.sendBitrate);const a=this.localStats.get(re.LocalVideoLowTrack);a&&(t+=a.sendBytes,n+=a.sendBitrate),this.remoteStats.forEach((u=>{let{audioStats:p,videoStats:m}=u;p&&(i+=p.receiveBytes,r+=p.receiveBitrate),m&&(i+=m.receiveBytes,r+=m.receiveBitrate)}));let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:n,SendBytes:t,RecvBytes:i,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter((n=>n.B_ppad!==void 0||n.B_ppvd!==void 0)),t.peer_delay.filter((n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1)).forEach((n=>{var i;const r=(i=this.p2pChannel)===null||i===void 0?void 0:i.getRemoteMedia(n.peer_uid),s=r!=null&&r.videoSSRC?Fn.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,o=r!=null&&r.audioSSRC?Fn.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,s>o?s:o),this.trafficStatsPeerList.push(n.peer_uid))})),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&S.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,n,i){if(!t)return!1;const r=!!i&&n.framesDecodeFreezeTime>i.framesDecodeFreezeTime,s=!i||n.framesDecodeCount>i.framesDecodeCount;return r||!s}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach((n=>{let[i,r]=n;switch(i){case re.LocalVideoTrack:case re.LocalVideoLowTrack:{const a=r,c=ja({},SS),u=t.getStats(),p=t.getLocalMedia(i);if(u){const m=u.videoSend.find((_=>_.ssrc===p?.ssrcs[0].ssrcId));if(m){const _=t.getLocalVideoSize(),g=t.getEncoderConfig(re.LocalVideoTrack);var s;(m.codec==="H264"||m.codec==="H265"||m.codec==="VP8"||m.codec==="VP9"||m.codec==="AV1X"||m.codec==="AV1")&&(c.codecType=m.codec,a?.codecType!==m.codec&&((s=this.onVideoCodecChanged)===null||s===void 0||s.call(this,m.codec.toLocaleLowerCase()))),c.sendBytes=m.bytes,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0,m.inputFrame?(c.captureFrameRate=m.inputFrame.frameRate,c.captureResolutionHeight=m.inputFrame.height,c.captureResolutionWidth=m.inputFrame.width):_&&(c.captureResolutionWidth=_.width,c.captureResolutionHeight=_.height),m.sentFrame?(c.sendFrameRate=m.sentFrame.frameRate,c.sendResolutionHeight=m.sentFrame.height,c.sendResolutionWidth=m.sentFrame.width):_&&(c.sendResolutionWidth=_.width,c.sendResolutionHeight=_.height),m.avgEncodeMs&&(c.encodeDelay=m.avgEncodeMs),g&&g.bitrateMax?c.targetSendBitrate=1e3*g.bitrateMax:m.targetBitrate&&(c.targetSendBitrate=m.targetBitrate),c.sendPackets=m.packets,c.sendPacketsLost=m.packetsLost,c.sendJitterMs=m.jitterMs,c.sendRttMs=m.rttMs,c.totalDuration=a?a.totalDuration+1:1,c.totalFreezeTime=a?a.totalFreezeTime:0,this.isLocalVideoFreeze(m)&&(c.totalFreezeTime+=1),m.scalabilityMode&&this.scalabilityMode!==m.scalabilityMode&&(S.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(m.scalabilityMode)),this.scalabilityMode=m.scalabilityMode)}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;this.localStats.set(i,c),(a?.sendResolutionWidth!==c.sendResolutionWidth||a?.sendResolutionHeight!==c.sendResolutionHeight)&&((o=this.onStatsChanged)===null||o===void 0||o.call(this,"resolution",{width:c.sendResolutionWidth,height:c.sendResolutionHeight})),c&&p&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,p.track,c);break}case re.LocalAudioTrack:{const a=r,c=ja({},ES),u=t.getStats(),p=t.getLocalMedia(i);if(u){const m=u.audioSend.find((_=>_.ssrc===p?.ssrcs[0].ssrcId));if(m){if(m.codec!=="opus"&&m.codec!=="aac"&&m.codec!=="PCMU"&&m.codec!=="PCMA"&&m.codec!=="G722"||(c.codecType=m.codec),m.inputLevel)c.sendVolumeLevel=Math.round(32767*m.inputLevel);else{const _=t.getLocalAudioVolume();_&&(c.sendVolumeLevel=Math.round(32767*_))}c.sendBytes=m.bytes,c.sendPackets=m.packets,c.sendPacketsLost=m.packetsLost,c.sendJitterMs=m.jitterMs,c.sendRttMs=m.rttMs,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0}}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(re.LocalAudioTrack,c),c&&p&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,p.track,c);break}}}))}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach((n=>{var i,r;let[s,{videoStats:o,audioStats:a,videoPcStats:c}]=n;const u=a,p=o,m=c,_=ja({},BO),g=ja({},WO),b=ja({},sz),{audioTrack:v,videoTrack:R,audioSSRC:O,videoSSRC:D}=t.getRemoteMedia(s);let x;x=this.store.useP2P?t.getStats(!0):t.getStats();const B=(i=x)===null||i===void 0?void 0:i.audioRecv.find((Z=>Z.ssrc===O)),G=(r=x)===null||r===void 0?void 0:r.videoRecv.find((Z=>Z.ssrc===D)),j=this.trafficStats&&this.trafficStats.peer_delay.find((Z=>Z.peer_uid===s));if(B&&(B.codec!=="opus"&&B.codec!=="aac"&&B.codec!=="PCMU"&&B.codec!=="PCMA"&&B.codec!=="G722"||(_.codecType=B.codec),B.outputLevel?_.receiveLevel=Math.round(32767*B.outputLevel):v&&(_.receiveLevel=Math.round(32767*v.getVolumeLevel())),_.receiveBytes=B.bytes,_.receivePackets=B.packets,_.receivePacketsLost=B.packetsLost,_.receivePacketsDiscarded=B.packetsDiscarded,_.packetLossRate=_.receivePacketsLost/(_.receivePackets+_.receivePacketsLost),_.receiveBitrate=u?8*Math.max(0,_.receiveBytes-u.receiveBytes):0,_.totalDuration=u?u.totalDuration+1:1,_.totalFreezeTime=u?u.totalFreezeTime:0,_.freezeRate=_.totalFreezeTime/_.totalDuration,_.receiveDelay=B.jitterBufferMs,_.totalDuration>10&&Ql.isRemoteAudioFreeze(v)&&(_.totalFreezeTime+=1)),G){var H;G.codec!=="H264"&&G.codec!=="H265"&&G.codec!=="VP8"&&G.codec!=="VP9"&&G.codec!=="AV1X"&&G.codec!=="AV1"||(g.codecType=G.codec),g.receiveBytes=G.bytes,g.receiveBitrate=p?8*Math.max(0,g.receiveBytes-p.receiveBytes):0,g.decodeFrameRate=G.decodeFrameRate<0?0:G.decodeFrameRate,g.renderFrameRate=G.decodeFrameRate<0?0:G.decodeFrameRate,G.outputFrame&&(g.renderFrameRate=G.outputFrame.frameRate),G.receivedFrame?(g.receiveFrameRate=G.receivedFrame.frameRate,g.receiveResolutionHeight=G.receivedFrame.height,g.receiveResolutionWidth=G.receivedFrame.width):R&&(g.receiveResolutionHeight=R._videoHeight||0,g.receiveResolutionWidth=R._videoWidth||0),G.framesRateFirefox!==void 0&&(g.receiveFrameRate=Math.round(G.framesRateFirefox)),g.receivePackets=G.packets,g.receivePacketsLost=G.packetsLost,g.packetLossRate=g.receivePacketsLost/(g.receivePackets+g.receivePacketsLost);const Z=p?p.totalFreezeTime:0,ne=p?p.totalDuration:0;g.totalDuration=p?p.totalDuration+1:1,g.totalFreezeTime=(H=G.totalFreezesDuration)!==null&&H!==void 0?H:Z||0,g.receiveDelay=G.jitterBufferMs||0;const he=!!D&&t.getRemoteVideoIsReady(D);G.totalFreezesDuration===void 0&&R&&he&&Ql.isRemoteVideoFreeze(R,G,m)&&(g.totalFreezeTime+=1),g.freezeRate=Math.max(0,Math.min((g.totalFreezeTime-Z)/(g.totalDuration-ne),1))}j&&(_.end2EndDelay=j.B_ad,g.end2EndDelay=j.B_vd,_.transportDelay=j.B_ed,g.transportDelay=j.B_ed,_.currentPacketLossRate=j.B_ealr4/100,g.currentPacketLossRate=j.B_evlr4/100,b.uplinkNetworkQuality=j.B_punq?j.B_punq:0,b.downlinkNetworkQuality=j.B_pdnq?j.B_pdnq:0),this.remoteStats.set(s,{audioStats:_,videoStats:g,videoPcStats:G,networkStats:b}),v&&this.exceptionMonitor.setRemoteAudioStats(v,_),R&&this.exceptionMonitor.setRemoteVideoStats(R,g)}))}}class JP{constructor(){C(this,"destChannelMediaInfos",new Map),C(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){oP(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){oP(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){zp(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function QP(e){if(!(e instanceof JP))return new Y(N.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),n=e.getDestChannelMediaInfo();if(!t)return new Y(N.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new Y(N.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class ko{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,n){C(this,"uid",void 0),C(this,"_uintid",void 0),C(this,"_trust_in_room_",!0),C(this,"_trust_audio_enabled_state_",!0),C(this,"_trust_video_enabled_state_",!0),C(this,"_trust_audio_mute_state_",!0),C(this,"_trust_video_mute_state_",!0),C(this,"_audio_muted_",!1),C(this,"_video_muted_",!1),C(this,"_audio_enabled_",!0),C(this,"_video_enabled_",!0),C(this,"_audio_added_",!1),C(this,"_video_added_",!1),C(this,"_is_pre_created",!1),C(this,"_video_pre_subscribed",!1),C(this,"_audio_pre_subscribed",!1),C(this,"_trust_video_stream_added_state_",!0),C(this,"_trust_audio_stream_added_state_",!0),C(this,"_audioTrack",void 0),C(this,"_videoTrack",void 0),C(this,"_dataChannels",[]),C(this,"_audioSSRC",void 0),C(this,"_videoSSRC",void 0),C(this,"_audioOrtc",void 0),C(this,"_videoOrtc",void 0),C(this,"_cname",void 0),C(this,"_rtxSsrcId",void 0),C(this,"_videoMid",void 0),C(this,"_audioMid",void 0),this.uid=t,this._uintid=n}}function ZP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function _y(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?ZP(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ZP(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const Tq=e=>`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1 2
a=msid-semantic: WMS
a=ice-lite`.concat(e?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:2
`),lm="9",gy=2e4,um=4e4;let $P=class{get localCapabilities(){return Dt(this._localCapabilities)}get rtpCapabilities(){return Dt(this._rtpCapabilities)}get candidates(){return Dt(this._candidates)}get iceParameters(){return Dt(this._iceParameters)}get dtlsParameters(){return Dt(this._dtlsParameters)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],i=arguments.length>3&&arguments[3]!==void 0&&arguments[3];C(this,"sessionDesc",void 0),C(this,"_localCapabilities",void 0),C(this,"_rtpCapabilities",void 0),C(this,"_candidates",void 0),C(this,"_originCandidates",void 0),C(this,"_iceParameters",void 0),C(this,"_isUseExtmapAllowMixed",void 0),C(this,"_isUseLocalCodecs",void 0),C(this,"_isUseDataChannel",void 0),C(this,"_dtlsParameters",void 0),C(this,"setup",void 0),C(this,"currentMidIndex",void 0),C(this,"cname",void 0),C(this,"useLocalCodecsMids",[]),C(this,"preloadSsrcs",[]),C(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=t,this._isUseLocalCodecs=n,this._isUseDataChannel=i,e=Dt(e);const{iceParameters:r,dtlsParameters:s,candidates:o,rtpCapabilities:a,setup:c,localCapabilities:u,cname:p}=e;this._rtpCapabilities=a,this._candidates=o,this._originCandidates=Dt(o),this._iceParameters=r,this._dtlsParameters=s,this._localCapabilities=u,this.setup=c,this.cname=p,[this.sessionDesc]=this.updateRemoteRTPCapabilities(a),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(e){return e.length===this.preloadSsrcs.length&&e.every((t=>{var n;return ie(n=this.preloadSsrcs).call(n,t)}))}preloadRemoteMedia(e){let t=0;const n=[],i=[];for(;e>0;){const r=[_y({ssrcId:um+t},I("USE_SUB_RTX")?{rtx:um+t+1}:{})],s="".concat(um+t,"_").concat(gy+t),{ssrcs:o,ssrcGroups:a}=Yl(r,this.cname,I("SYNC_GROUP")?s:void 0),c=this.preCreateOrRecycleSendMedia("video",o,a,void 0),u=[{ssrcId:gy+t}],p="".concat(um+t,"_").concat(gy+t),{ssrcs:m,ssrcGroups:_}=Yl(u,this.cname,I("SYNC_GROUP")?p:void 0),g=this.preCreateOrRecycleSendMedia("audio",m,_,void 0);e--,t+=2,n.push(c,g),i.push(o[0].ssrcId,m[0].ssrcId)}return this.useLocalCodecsMids.push(...n),this.preloadSsrcs=i,{mids:n,preSSRCs:i,isAvailable:!0}}preCreateOrRecycleSendMedia(e,t,n,i){const r=this.rtpCapabilities.send.videoCodecs,s=this._isUseLocalCodecs||r.length===0?this.localCapabilities.recv:this.rtpCapabilities.send;S.debug("create or recycle send media without remote rtp capabilities, ssrcs ",t[0].ssrcId);const o=e===_e.VIDEO?s.videoCodecs:s.audioCodecs,a=e===_e.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const c="".concat(this.currentMidIndex);let u={media:{mediaType:e,port:lm,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.map((p=>p.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:a,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:o,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(c)}};return u=this.mungSendMediaDesc(u,i),this.sessionDesc.mediaDescriptions.push(u),this.updateBundleMids(),c}toString(){return Qs(this.sessionDesc)}send(e,t,n,i){const{ssrcs:r,ssrcGroups:s}=Yl(t,this.cname,I("SYNC_GROUP")?n:void 0),o=this.findPreloadMediaDesc(r);if(o){if(Nt()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,o.attributes.mid),i&&(i.twcc||i.remb)){const a=this.sessionDesc.mediaDescriptions.indexOf(o);return this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(o,i),{mid:o.attributes.mid,needExchangeSDP:!0}}return{mid:o.attributes.mid,needExchangeSDP:!1}}{const a=this.findAvailableMediaIndex(e,r);let c;return a===-1||a===1&&(Rn()||(function(){const u=st();return!(u.name!==at.CHROME||!u.osVersion)&&Number(u.version)<=90})()||Yr(143)||bo(143)||I("RESERVE_MID_1_MLINE")||I("ENABLE_ENCODED_TRANSFORM")&&Xs())||a===0&&!(function(u){const p=st();return!(p.name!==at.FIREFOX||!p.osVersion)&&Number(p.version)===u})(138)&&I("USE_SUB_RTX")||q0()?(c=this.createOrRecycleSendMedia(e,r,s,"sendonly",i),this.updateBundleMids()):(c=Dt(this.sessionDesc.mediaDescriptions[a]),c.attributes.direction="sendonly",c.attributes.ssrcs=r,c.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[a]=this.mungSendMediaDesc(c,i)),Nt()&&this.firefoxSsrcMidMap.set(r[0].ssrcId,c.attributes.mid),{mid:c.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map((r=>{let{kind:s,ssrcMsg:o,mslabel:a}=r;return this.send(s,o,a)})),n=[];let i=!1;return t.forEach((r=>{let{mid:s,needExchangeSDP:o}=r;o&&(i=!0),n.push(s)})),{mids:n,needExchangeSDP:i}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>n.attributes.mid&&e.indexOf(n.attributes.mid)!==-1));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((n=>{n.attributes.mid==="0"||Nt()||q0()?n.attributes.ssrcs=[]:(n.attributes.ssrcs=[],n.attributes.direction="inactive",n.media.port="0")})),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find((n=>n.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find((n=>n.attributes.mid===e));if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>ie(e).call(e,n.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((n=>{n.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>ie(e).call(e,n.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((n=>{n.attributes.direction="recvonly"}))}receive(e,t,n,i){e.forEach(((r,s)=>{this.createOrRecycleRecvMedia(r,[],"recvonly",t,n,i[s])})),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>e.indexOf(n.attributes.mid)!==-1));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((n=>{n.media.port="0",n.attributes.direction="inactive"})),this.updateBundleMids()}updateRemoteRTPCapabilities(e){const t=this.sessionDesc||ri((n=this._isUseExtmapAllowMixed,this._isUseDataChannel?Tq(n):`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(n?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var n;this._rtpCapabilities=e;let i=!1;const r=this.rtpCapabilities.send,s=this.localCapabilities.send,o=this.localCapabilities.recv,a=o.videoCodecs,c=o.audioCodecs,u=o.videoExtensions,p=o.audioExtensions;for(const b of t.mediaDescriptions){var m;if(b.attributes.direction!=="sendonly"||typeof b.attributes.mid!="string"||!ie(m=this.useLocalCodecsMids).call(m,b.attributes.mid)){if(i=!0,b.attributes.iceUfrag=this._iceParameters.iceUfrag,b.attributes.icePwd=this._iceParameters.icePwd,b.attributes.fingerprints=this._dtlsParameters.fingerprints,b.attributes.candidates=this._candidates,b.attributes.setup=this.setup,b.media.mediaType==="application"&&(b.attributes.sctpPort="5000"),b.media.mediaType==="video")if(this._isUseLocalCodecs&&b.attributes.direction==="sendonly"){var _;b.media.fmts=a.map((R=>R.payloadType.toString(10))),b.attributes.payloads=a,b.attributes.extmaps=u;const v=b.attributes.mid;typeof v!="string"||ie(_=this.useLocalCodecsMids).call(_,v)||this.useLocalCodecsMids.push(v)}else if(r.videoCodecs.length===0){const v=s.videoCodecs.filter((R=>{var O,D;return(O=R.rtpMap)===null||O===void 0?void 0:ie(D=O.encodingName.toLowerCase()).call(D,"vp8")}));v.length===0&&v.push(s.videoCodecs[0]),b.media.fmts=v.map((R=>R.payloadType.toString(10))),b.attributes.payloads=v,b.attributes.extmaps=[]}else b.media.fmts=r.videoCodecs.map((v=>v.payloadType.toString(10))),b.attributes.payloads=r.videoCodecs,b.attributes.extmaps=r.videoExtensions;if(b.media.mediaType==="audio")if(this._isUseLocalCodecs&&b.attributes.direction==="sendonly"){var g;b.media.fmts=c.map((R=>R.payloadType.toString(10))),b.attributes.payloads=c,b.attributes.extmaps=p;const v=b.attributes.mid;typeof v!="string"||ie(g=this.useLocalCodecsMids).call(g,v)||this.useLocalCodecsMids.push(v)}else if(r.audioCodecs.length===0){const v=s.audioCodecs.filter((R=>{var O,D;return(O=R.rtpMap)===null||O===void 0?void 0:ie(D=O.encodingName.toLowerCase()).call(D,"opus")}))||[s.audioCodecs[0]];b.media.fmts=v.map((R=>R.payloadType.toString(10))),b.attributes.payloads=v,b.attributes.extmaps=[]}else b.media.fmts=r.audioCodecs.map((v=>v.payloadType.toString(10))),b.attributes.payloads=r.audioCodecs,b.attributes.extmaps=r.audioExtensions,Ed(b)}}return this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1,[this.sessionDesc,i]}updateCandidates(e){const t=this._originCandidates.filter((i=>i.transport==="udp")),n=[];if(t.forEach((i=>{n.push(_y(_y({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))})),t.length!==0){switch(e){case bn.TCP_RELAY:this._candidates=n;break;case bn.UDP_TCP_RELAY:case bn.RELAY:this._candidates=[...t,...n];break;default:this._candidates=t}for(const i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}}restartICE(e){e=Dt(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex((n=>{const i=n.media.mediaType===e&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(Nt()){if(i){const r=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(r||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!r||r!==n.attributes.mid)}return!1}return i}))}createOrRecycleDataChannel(){for(const n of this.sessionDesc.mediaDescriptions)if(n.media.mediaType==="application")return{mediaDesc:n,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:lm,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,n,i,r,s){const o=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,c=ql(o,a,this.localCapabilities.send,o===_e.VIDEO?i:r),u=o===_e.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;const p="".concat(this.currentMidIndex);let m={media:{mediaType:o,port:lm,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map((g=>g.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(p)}};m=this.mungRecvMediaDsec(m,e,s);const _=this.findFirstClosedMedia(o);if(_){const g=this.sessionDesc.mediaDescriptions.indexOf(_);this.sessionDesc.mediaDescriptions[g]=m}else this.sessionDesc.mediaDescriptions.push(m);return m}updateRemoteDtlsParameters(e){const t=new Set(this._dtlsParameters.fingerprints.map((r=>r.fingerprint))),n=new Set(e.map((r=>r.fingerprint)));let i=!1;t.size!==n.size&&(i=!0);for(const r of t)n.has(r)||(i=!0);return i}updateRemoteCodec(e,t,n){const i=[...new Set(this._rtpCapabilities.recv.videoCodecs.map((m=>m.rtpMap&&m.rtpMap.encodingName.toLowerCase()||"")).filter((m=>{var _;return ie(_=Object.keys(Aa)).call(_,m)})))],r=new Set(t);if(i.every((m=>r.has(m))))return S.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const s=this._rtpCapabilities.recv.videoCodecs.filter((m=>t.some((_=>{var g;return ie(g=m.rtpMap&&m.rtpMap.encodingName.toLowerCase()||"").call(g,_)}))));if(s.length===0)return S.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(i," codecs: ").concat(t)),!1;const o=[...new Set(s.map((m=>m.rtpMap&&m.rtpMap.encodingName.toLowerCase()||"")))];let a;if(S.debug("updateRemoteCodec, from ".concat(i," to ").concat(o)),e.length===0)a=this.sessionDesc.mediaDescriptions.filter((m=>m.media.mediaType==="video"&&m.attributes.direction==="recvonly"));else if(a=this.sessionDesc.mediaDescriptions.filter((m=>m.attributes.mid&&m.media.mediaType==="video"&&ie(e).call(e,m.attributes.mid)&&m.attributes.direction==="recvonly")),a.length!==e.length)return S.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;if(I("USE_PUB_RTX")||I("USE_SUB_RTX")){const m=Lo(s,this.rtpCapabilities.recv.videoCodecs);s.push(...m)}this._rtpCapabilities.recv.videoCodecs=s;const c=this.localCapabilities.send,u=this.rtpCapabilities.recv,p=ql(_e.VIDEO,u,c,n);return a.forEach((m=>{const _=p.map((g=>g.payloadType.toString(10)));S.debug("updateRemoteCodec mid: ".concat(m.attributes.mid,", from"),m.attributes.payloads,"to",p),m.attributes.payloads=p,m.media.fmts=_})),S.debug("updateRemoteCodec success, mids: ".concat(e,", codecs: ").concat(t,", remote recv: ").concat(this._rtpCapabilities.recv.videoCodecs.length,", remote send: ").concat(this._rtpCapabilities.send.videoCodecs.length)),!0}createOrRecycleSendMedia(e,t,n,i,r){const s=this.rtpCapabilities.send.videoCodecs,o=this._isUseLocalCodecs||s.length===0?this.localCapabilities.recv:this.rtpCapabilities.send,a=e===_e.VIDEO?o.videoCodecs:o.audioCodecs,c=e===_e.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const u="".concat(this.currentMidIndex);let p={media:{mediaType:e,port:lm,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((_=>_.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(u)}};p=this.mungSendMediaDesc(p,r);const m=this.findFirstClosedMedia(e);if(m){const _=this.sessionDesc.mediaDescriptions.indexOf(m);this.sessionDesc.mediaDescriptions[_]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>e.media.port!=="0")).map((e=>e.attributes.mid))}mungRecvMediaDsec(e,t,n){const i=Dt(e);return ty(i),Va(i,t),ny(i,t),AP(i),im(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=Dt(e);return n.attributes&&n.attributes.payloads&&Array.isArray(n.attributes.payloads)&&n.attributes.payloads.length>0&&n.attributes.payloads.forEach((i=>{i.rtpMap&&i.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&I("ENABLE_DOWN_SPS_PPS")&&(i.fmtp&&i.fmtp.parameters||(i.fmtp={parameters:{}}),i.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")})),im(n,t,this.localCapabilities.recv),Ed(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((i=>i.attributes.mid===e));if(n!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=i}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>Nt()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0"))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return((n=t.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===e[0].ssrcId}))}getSSRC(e){var t;return(t=this.sessionDesc.mediaDescriptions.find((n=>n.attributes.mid===e)))===null||t===void 0?void 0:t.attributes.ssrcs}};function eL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function to(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?eL(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):eL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}var Td=(function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e})(Td||{});const hm=new Map;function tL(e,t,n,i){let{scale:r}=e;if(r===0&&i===Td.UP||r>=t.length-1&&i===Td.DOWN)return e;let s=to(to({},e),{},{scale:i===Td.DOWN?++r:--r});switch(n){case"maintain-framerate":s=to(to({},s),t[r].motion);break;case"maintain-resolution":s=to(to({},s),t[r].detail);break;case"balanced":s=to(to({},s),t[r].balanced)}return s}function nL(e,t){if(t){const n={overUse:0,underUse:0,adaptationList:iL(t)};hm.set(e,n)}else hm.delete(e)}function iL(e){const t=to({},e),{bitrateMax:n,frameRate:i,scaleResolutionDownBy:r,bitrateMin:s}=t,{MIN_FRAME_RATE:o,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:u,BITRATE_MAX_THRESHOLD:p,BWE_SCALE_UP_THRESHOLD:m,BWE_SCALE_DOWN_THRESHOLD:_,PERF_SCALE_DOWN_THRESHOLD:g,PERF_SCALE_UP_THRESHOLD:b,BALANCE_BITRATE_FACTOR:v,BALANCE_FRAMERATE_FACTOR:R,BALANCE_RESOLUTION_FACTOR:O,MOTION_RESOLUTION_FACTOR:D,MOTION_BITRATE_FACTOR:x,DETAIL_FRAMERATE_FACTOR:B,DETAIL_BITRATE_FACTOR:G}=lS,j=Math.min(t.frameRate,a),H=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(_,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(g,1)*j),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:s},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:s},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:s}}];for(let Z=1;Z<=c;Z++){const ne={bwe_up:Math.round(Math.pow(m,Z)*n),bwe_down:Math.round(Math.pow(_,Z+1)*n),fps_up:Math.round(Math.pow(b,Z)*j),fps_down:Math.round(Math.pow(g,Z+1)*j)},he={scaleResolutionDownBy:r/Math.pow(O,Z),frameRate:Math.max(Math.round(Math.pow(R,Z)*i),o),bitrateMax:Math.max(Math.round(Math.pow(v,Z)*n),p),bitrateMin:Math.max(Math.round(Math.pow(v,Z)*s),u)},De={scaleResolutionDownBy:r/Math.pow(D,Z),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(x,Z)*n),p),bitrateMin:Math.max(Math.round(Math.pow(x,Z)*s),u)},Oe={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(B,Z)*i),o),bitrateMax:Math.max(Math.round(Math.pow(G,Z)*n),p),bitrateMin:Math.max(Math.round(Math.pow(G,Z)*s),u)};H.push({scale:Z,threshold:ne,balanced:he,motion:De,detail:Oe})}return H}function vq(e,t,n,i,r,s){const o=hm.get(e)||{overUse:0,underUse:0,adaptationList:iL(r)},{adaptationList:a}=o;hm.set(e,o);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:u}=lS,{scale:p}=i;let m,_;return typeof t=="number"&&t>0&&(function(g,b,v,R){if(b>=v.length)return!1;let{threshold:{fps_down:O}}=v[b];return I("FORCE_AG_HIGH_FRAMERATE")&&R==="maintain-framerate"&&(O=v[0].threshold.fps_down),g<O})(t,p,a,s)&&(o.overUse++,_=$c.CPU,o.overUse>c)||typeof n=="number"&&n>0&&(function(g,b,v){if(b>=v.length)return!1;const{threshold:{bwe_down:R}}=v[b];return g<R})(n,p,a)&&(o.overUse++,_=$c.BANDWIDTH,o.overUse>c)?(o.overUse=0,o.underUse=0,m=tL(i,a,s,Td.DOWN),[m,_]):(typeof t=="number"&&t>0&&typeof n=="number"&&n>0&&(function(g,b,v,R){if(b===0)return;let{threshold:{fps_up:O}}=v[b];return I("FORCE_AG_HIGH_FRAMERATE")&&R==="maintain-framerate"&&(O=v[1].threshold.fps_up),g>O})(t,p,a,s)&&(function(g,b,v){if(b===0)return;const{threshold:{bwe_up:R}}=v[b];return g>R})(n,p,a)&&(o.underUse++,o.underUse>u&&(o.overUse=0,o.underUse=0,m=tL(i,a,s,Td.UP),m.scale===0&&(_=$c.NONE))),[m,_])}function rL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Ey(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?rL(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function sL(e){var t;return!!I("ENABLE_AG_ADAPTATION")&&!!(e instanceof Mp||ie(t=e._hints).call(t,ht.CUSTOM_TRACK))&&(!!I("FORCE_SUPPORT_AG_ADAPTATION")||!!(Y0(14,0,!1)&&z0(17,4,!0)||K0(14)&&HE(17,4,!0)))}const pm=new Map;function oL(e,t,n,i,r,s){if(vd(e,n),r(t),i!=="balanced"&&i!=="maintain-framerate"&&i!=="maintain-resolution")return;let o=-1;nL(e,t);const a=window.setInterval((()=>{const u=pm.get(e);if(!I("ENABLE_AG_ADAPTATION")||!u)return vd(e,n),void r(t);const p=s();if(p.sendPackets>0&&p.OutgoingAvailableBandwidth>0){if(o===-1)return void(o=Date.now());if(Date.now()-o<1e3)return;const m=p.sendFrameRate,_=p.OutgoingAvailableBandwidth,[g,b]=vq(e,m,_,u.adaptationConfig,t,i);b&&(n.qualityLimitationReason=b),g&&u.adaptationConfig.scale!==g.scale&&(S.debug("[".concat(e,"] applyAdaptation: ").concat(n.qualityLimitationReason,`
           sendFps `).concat(m,", bwe ").concat(_,", switch from ").concat(u.adaptationConfig.scale," to ").concat(g.scale," ")),u.adaptationConfig=Ey(Ey({},u.adaptationConfig),g),r(g))}}),I("CHECK_LOCAL_STATS_INTERVAL")),c=Ey({},t);pm.set(e,{timer:a,adaptationConfig:c,originConfig:t,adaptationFunc:r}),S.debug("[".concat(e,"] start adaptation, originConfig: ").concat(JSON.stringify(t),", degradationPreference: ").concat(i))}function vd(e,t){const n=pm.get(e);if(n){const{timer:i}=n;window.clearTimeout(i),pm.delete(e)}t.qualityLimitationReason=$c.NONE,nL(e)}function Rq(e,t){var n;let i;switch(t){case re.LocalAudioTrack:i=_t.Audio;break;case re.LocalVideoTrack:i=ie(n=e._hints).call(n,ht.SCREEN_TRACK)?_t.Screen:_t.High;break;case re.LocalVideoLowTrack:i=_t.Low}return i}function Sy(e){const t=Xe();if(e.some((n=>n._bypassWebAudio)))throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function yy(e,t){Sy(e);const n=new dn;return e.forEach((i=>n.addAudioTrack(i))),n}const Cq=!Xe().supportUnifiedPlan||I("CHROME_FORCE_PLAN_B")&&Ss();function Zl(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(e.useDcSignal)return n={spec:t,store:e},Zr("DataChannelConnection").create(n);var n;return Cq?(function(r){return Zr("PlanBConnection").create(r)})({spec:t,store:e}):new qi(t,e)}function Ty(e){return e&&(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")}function vy(e){try{if(e.iceServers)return!1;if(e.turnServer&&e.turnServer.mode!=="off"){if(ya(e.turnServer.servers))return!1;if(I("FORCE_TURN_TCP")||e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).some((t=>t.forceturn)))return!0}return!1}catch{return!1}}var nt;function aL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function es(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?aL(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):aL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let qi=(nt=class rc extends Qp{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var n;return ie(n=Object.keys(Aa)).call(n,t)})))]}constructor(t,n){super(t,n),C(this,"id",mt(5,"connection-")),C(this,"store",void 0),C(this,"peerConnection",void 0),C(this,"forceTurn",!1),C(this,"remoteSDP",void 0),C(this,"initialOffer",void 0),C(this,"transportEventReceiver",void 0),C(this,"statsFilter",void 0),C(this,"extension",{useXR:I("USE_XR")}),C(this,"localCapabilities",void 0),C(this,"remoteCodecs",void 0),C(this,"localCandidateCount",0),C(this,"allCandidatesReceived",!1),C(this,"isPreallocation",!1),C(this,"isPreRender",!1),C(this,"preMediaMap",new Map),C(this,"dataStreamChannelMap",new Map),C(this,"establishPromise",void 0),C(this,"recoveredDataChannelIds",[]),C(this,"currentDataChannelId",1),C(this,"supportAV1RtpSpec",!1),C(this,"mutex",void 0),C(this,"qualityLimitationReason",$c.NONE),C(this,"isFirstConnected",!1),this.store=n,this.forceTurn=vy(t),this.mutex=new Cn("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(rc.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=bp(this.peerConnection,I("STATS_UPDATE_INTERVAL"),void 0,Nt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void S.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else S.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=bs(n.sdp),r=await ry({filterRTX:!I("USE_PUB_RTX")&&!I("USE_SUB_RTX"),filterVideoFec:I("FILTER_VIDEO_FEC"),filterAudioFec:I("FILTER_AUDIO_FEC"),filterVideoCodec:I("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:I("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:I("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=zl(r),this.initialOffer=n,I("ENABLE_SVC")&&this.store.codec=="av1"){const o=await IP();var t;o&&(this.supportAV1RtpSpec=!0,(t=r.send)===null||t===void 0||t.videoExtensions.push(o))}let s;return n.sdp&&rm(n.sdp)&&(s=Dt(r),yP(s)),es(es({},i),{},{rtpCapabilities:s||r,offerSDP:n.sdp})}catch(n){throw new J(N.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&rm(this.initialOffer.sdp)&&TP(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new $P(es(es({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!I("ENABLE_PRE_SUB_WITH_PRE_PC")||!I("PRE_USE_LOCAL_CODECS"))&&Vl(this.store)),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),i=sy(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r?.(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const s=this.peerConnection.getTransceivers()[0];if(s!=null&&s.receiver&&this.tryBindTransportEvents(s.receiver),Vl(this.store))if(t.preallocation&&I("ENABLE_PRE_SUB_WITH_PRE_PC")){const o=I("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(o);await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{const{preSSRCs:o=[]}=t,a=o.map((u=>u.ssrcMsg[0].ssrcId));if(o.length===0)return;const{mids:c}=this.remoteSDP.batchSend(o.map((u=>Object.assign({},u))));await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}presetMedia(t,n){t.forEach(((i,r)=>{this.peerConnection.getTransceivers().forEach((s=>{if(s.mid!=null&&i===s.mid&&s.receiver.track){const o=s.receiver.track;let a;o.kind==="video"&&I("ENABLE_PRE_RENDER")&&(a=new xp({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(mt(5,""))},!0),a.updateVideoTrack(o),a.onFirstVideoFrameRender=()=>{var c;const u=this.preMediaMap.get(n[r]);u&&(u.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,n[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,n[r])},a.play(this.store.sessionId||void 0),this.isPreRender=!0),this.preMediaMap.set(n[r],{mid:i,track:o,player:a,transceiver:s})}})),this.store.peerReceiver()}))}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let n=!1;const{rtpCapabilities:i}=t;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const o=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||o}const{preSSRCs:r=[]}=t,s=r.map((o=>o.ssrcMsg[0].ssrcId));if(!this.remoteSDP.checkPreloadSsrcs(s)){const o=[],a=[];if(Array.from(this.preMediaMap.entries()).every((c=>{let[u,{mid:p,player:m,track:_}]=c;return o.push(p),a.push(u),this.preMediaMap.delete(u),m&&m.destroy(),!0})),o.length>0&&(this.remoteSDP.stopSending(o),await Ti(this.peerConnection,this.remoteSDP,this.extension),S.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),Se.reportApiInvoke(this.store.sessionId,{name:xt.PRELOAD_MEDIA_FAILED,options:[r,a],tag:Ct.TRACER}).onSuccess()),r.length>0){const{mids:c}=this.remoteSDP.batchSend(r.map((u=>Object.assign({},u))));await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(c,s)}}n?(await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):S.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(n.toString()))}}send(t,n,i){var r=this;return li((function*(){const s=yield He(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=Hl();t.forEach((R=>{const O=r.peerConnection.addTransceiver(R._mediaStreamTrack,es({direction:"sendonly"},R.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));o.push(O),R._updateRtpTransceiver(O)})),Nt()&&I("SIMULCAST")===!0&&(yield He(r.applySimulcastForFirefox(o,t)));const c=yield He(r.peerConnection.createOffer()),u=r.remoteSDP.predictReceivingMids(t.length),p=r.mungSendOfferSDP(c.sdp,t,u),m=ri(p),_=u.map((R=>{const O=m.mediaDescriptions.find((D=>D.attributes.mid===R));if(!O)throw new Error("Cannot extract ssrc from mediaDescription.");return ey(O,I("USE_PUB_RTX"))}));let g;try{g=yield _}catch(R){g=[],r.remoteSDP.receive(t,n,i,g);const O=r.remoteSDP.toString();throw yield He(r.peerConnection.setLocalDescription({type:"offer",sdp:p})),yield He(r.peerConnection.setRemoteDescription({type:"answer",sdp:O})),yield He(r.stopSending(u,!0)),R}r.remoteSDP.receive(t,n,i,g);const b=r.remoteSDP.toString(),v=r.logSDPExchange(p,"offer","local","send");return yield He(r.peerConnection.setLocalDescription({type:"offer",sdp:p})),yield He(r.applySimulcastEncodings(o,t)),yield He(r.applySendEncodings(o,t)),v?.(b),yield He(r.peerConnection.setRemoteDescription({type:"answer",sdp:b})),o.map(((R,O)=>{const D=u[O];return{localSSRC:_[O],id:D,transceiver:R}}))}catch(o){throw o instanceof J?o:new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}}))()}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);if(i&&i.readyState==="open")S.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const s=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof s!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:I("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)}n.forEach((s=>{s._updateOriginDataChannel(i)}));const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),S.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else S.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof J?i:new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(t){try{const n=this.dataStreamChannelMap.get(t);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(t)}catch(n){throw n instanceof J?n:new J(N.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(t,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter((c=>t.indexOf(c.mid)!==-1));if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map((c=>{var u;vd(this.id+c.mid,this),c.direction="inactive",(u=c.stop)===null||u===void 0||u.call(c)}));const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,n,i,r);o&&(await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP.")));const a=this.peerConnection.getTransceivers().find((c=>c.mid===s));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:s,transceiver:a}}catch(s){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(t);return i&&(await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),n.map((r=>{const s=this.peerConnection.getTransceivers().find((o=>o.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}}))}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");t.forEach((s=>{Array.from(this.preMediaMap.entries()).some((o=>{let[a,{mid:c,player:u}]=o;if(c===s)return this.preMediaMap.delete(a),u&&u.destroy(),!0}))})),this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((o=>{o.direction="inactive"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((async(o,a)=>{o.direction="sendonly"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return li((function*(){const i=yield He(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=Xe().supportPCSetConfiguration,s=I("FORCE_TURN_TCP")||n.forceTurn;if(t===bn.RELAY&&!r)return;if(r&&!s){const m=t===bn.RELAY?"relay":"all",_=n.peerConnection.getConfiguration();_.iceTransportPolicy!==m&&(S.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(_.iceTransportPolicy,"] to [").concat(m,"]")),_.iceTransportPolicy=m,n.peerConnection.setConfiguration(_))}n.remoteSDP.updateCandidates(t);const o=yield He(n.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=bs(o.sdp),{remoteIceParameters:c}=yield a.iceParameters;n.remoteSDP.restartICE(c);const u=n.remoteSDP.toString(),p=n.logSDPExchange(o.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield He(n.peerConnection.setLocalDescription(o)),p?.(u),yield He(n.peerConnection.setRemoteDescription({type:"answer",sdp:u}))}catch(r){S.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}}))()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(bn.TCP_RELAY),await Ti(this.peerConnection,this.remoteSDP,this.extension)}catch(n){S.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach((n=>{vd(this.id+n.mid,this)})),this.preMediaMap.forEach((n=>{let{player:i}=n;i&&i.destroy()})),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return es(es({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new J(N.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getTransceivers().filter((r=>r.mid===t));i.length===1&&(this.isVP8Simulcast(n)?Nt()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getTransceivers().find((r=>r.mid===n));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:es(es({},Rr),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:es(es({},Rr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var n;const i="code: ".concat(t.errorCode,", message: ").concat(t.errorText),r=t.port?"local: ".concat(t.port):"",s=Cs(t.url||"");S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(i,"), url: ").concat(s||"",", host_candidate:").concat(r)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),I("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]},i=t.cloudProxyServer||"disabled";return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&(ya(t.turnServer.servers)?n.iceServers=t.turnServer.servers:I("NEW_TURN_MODE")&&n.iceServers&&i==="disabled"?(I("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&n.iceServers.push(...rc.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):n.iceServers.push(...rc.newTurnServerConfigToIceServers(t.turnServer.servers)),I("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...rc.turnServerConfigToIceServers(t.turnServer.servers)),I("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...rc.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),I("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((r=>{r.forceturn&&(n.iceTransportPolicy="relay")})))),I("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Ir(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!I("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}static newTurnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{const r=I("NEW_TURN_MODE");r===1?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Ir(i.turnServerURL),":443?transport=tcp")}):r===4&&(n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Ir(i.turnServerURL),":443?transport=tcp")}))})),n}tryBindTransportEvents(t){const n=t.transport;if(n){this.transportEventReceiver=t,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in r?r.error:r)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const r=n?.iceTransport.state;var s;r&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:s}=i.getSelectedCandidatePair()||{};if(r&&s){const o=r.address+":"+r.port,a=s.address+":"+s.port;S.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(Cs(o)),", remote ").concat(JSON.stringify(Cs(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i,r;if(n||(n=this.peerConnection.getSenders().find((R=>R.track===t._mediaStreamTrack))),!n)return S.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return S.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Xe().supportSetRtpSenderParameters)return S.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const a=EP(this.peerConnection,t._mediaStreamTrack),c=aN(t);if(sL(t)&&a&&n&&c&&this.getLocalVideoStats&&ie(i=["vp8","vp9"]).call(i,this.store.codec)){var u;const v=s.degradationPreference||(ie(u=t._hints).call(u,ht.CUSTOM_TRACK)?I("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");oL(this.id+a.mid,c,this,v,(R=>{n&&this.updateAdaptation(n,R)}),this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var p;const{bitrateMax:v,frameRate:R,scaleResolutionDownBy:O}=t._encoderConfig;v&&(o.maxBitrate=1e3*v),(ie(p=t._hints).call(p,ht.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(R&&(o.maxFramerate=fi(R)),O&&O>=1&&(o.scaleResolutionDownBy=O))}const{maxFramerate:m}=I("ENCODER_CONFIG_LIMIT");if(m&&typeof m=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,m):m),I("DSCP_TYPE")&&Ss()){var _;const v=I("DSCP_TYPE");ie(_=["very-low","low","medium","high"]).call(_,v)&&(o.networkPriority=v)}const g=n.getParameters(),b=(r=g.encodings)===null||r===void 0?void 0:r[0];Nt()&&!b&&(s.encodings=[o]),b&&Object.assign(b,o),Object.assign(g,s),S.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(g.encodings))),await n.setParameters(g),await DP(this.store.codec,n,I("SVC_MODE"))}async updateAdaptation(t,n){var i,r;if(!t)return S.debug("[updateAdaptation] no rtpSender found");if(!Xe().supportSetRtpSenderParameters)return S.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:o,frameRate:a,scaleResolutionDownBy:c}=n;o&&(s.maxBitrate=1e3*o),a&&(s.maxFramerate=fi(a)),c&&c>=1&&ie(i=["vp8","vp9"]).call(i,this.store.codec)&&(s.scaleResolutionDownBy=c);const u=t.getParameters(),p=(r=u.encodings)===null||r===void 0?void 0:r[0];p&&Object.assign(p,s),Object.assign(u,{});try{await t.setParameters(u),S.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(u.encodings)))}catch(m){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?S.debug("[updateAdaptation] peerConnection not connected}"):S.debug("[updateAdaptation] updateRtpSenderEncodings failed",m):S.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,n){try{if(!Xe().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=n[i];s instanceof bt&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,i){if(I("FORBID_MODIFY_LOCAL_OFFER_SDP"))return t;const r=ri(t);return n.forEach(((s,o)=>{const a=i[o],c=r.mediaDescriptions.find((u=>u.attributes.mid===a));c&&(Va(c,s),iy(c,s,this.store.codec))})),Qs(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let c=0;c<t.length;c++){var i,r,s,o,a;const u=t[c],p=n[c];if(p instanceof bt&&!ie(i=p._hints).call(i,ht.LOW_STREAM)&&(r=p._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=p._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=p._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=p._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const m={},_={high:1e3*(p._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{rid:"m",active:!0,maxBitrate:_.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:_.high}];const g=u.sender.getParameters();await u.sender.setParameters(Object.assign(g,m))}}}async applySimulcastEncodings(t,n){if(!Nt()&&t.length===n.length)for(let i=0;i<t.length;i++){const r=n[i];if(r instanceof bt&&this.isVP8Simulcast(r)){const s=t[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var n,i,r,s,o;return!!(t instanceof bt&&I("SIMULCAST")&&this.store.codec==="vp8"&&!ie(n=t._hints).call(n,ht.LOW_STREAM)&&(i=t._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,r){if(I("SDP_LOGGING"))return S.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),t),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(t){if(Xe().supportPCSetConfiguration){const n=rc.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}t.isPreallocation&&(this.isPreallocation=!0)}},le(nt.prototype,"updateRemoteRTPCapabilities",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"updateRemoteRTPCapabilities"),nt.prototype),le(nt.prototype,"connect",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"connect"),nt.prototype),le(nt.prototype,"updateRemoteConnect",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"updateRemoteConnect"),nt.prototype),le(nt.prototype,"createDataChannels",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"createDataChannels"),nt.prototype),le(nt.prototype,"receive",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"receive"),nt.prototype),le(nt.prototype,"batchReceive",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"batchReceive"),nt.prototype),le(nt.prototype,"stopReceiving",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"stopReceiving"),nt.prototype),le(nt.prototype,"muteRemote",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"muteRemote"),nt.prototype),le(nt.prototype,"unmuteRemote",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"unmuteRemote"),nt.prototype),le(nt.prototype,"muteLocal",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"muteLocal"),nt.prototype),le(nt.prototype,"unmuteLocal",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"unmuteLocal"),nt.prototype),le(nt.prototype,"close",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"close"),nt.prototype),le(nt.prototype,"updateEncoderConfig",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"updateEncoderConfig"),nt.prototype),le(nt.prototype,"updateSendParameters",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"updateSendParameters"),nt.prototype),le(nt.prototype,"replaceTrack",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"replaceTrack"),nt.prototype),le(nt.prototype,"updateAdaptation",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"updateAdaptation"),nt.prototype),le(nt.prototype,"getRemoteSSRC",[_i],Object.getOwnPropertyDescriptor(nt.prototype,"getRemoteSSRC"),nt.prototype),nt);function _i(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}function Ry(e,t){let n=document.createElement("video"),i=document.createElement("canvas");n.setAttribute("style","display:none"),i.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),i.width=fi(t.width),i.height=fi(t.height);const r=fi(t.framerate||15);document.body.append(n),document.body.append(i);let s=e._mediaStreamTrack;n.srcObject=new MediaStream([s]),n.play().catch(kl);const o=i.getContext("2d");if(!o)throw new Y(N.UNEXPECTED_ERROR,"can not get canvas context");const a=Xe(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!n)return i.stopCapture&&i.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const p=n.videoWidth,m=n.videoHeight/p,_=i.width*m;Math.abs(_-i.height)>=2&&(S.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(_)),i.height=_)}o.drawImage(n,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),s!==e._mediaStreamTrack&&(s=e._mediaStreamTrack,n.srcObject=new MediaStream([s]))},i.stopCapture=RS((()=>i.startCapture&&i.startCapture()),r);const u=c.stop;return c.stop=()=>{u.call(c),n&&(n.remove(),n.srcObject=null,n=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),S.debug("clean low stream renderer")},c}var cL=(function(e){return e[e.Video_Send_Type=190]="Video_Send_Type",e})(cL||{}),ts=(function(e){return e[e.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",e[e.Video_Send_Freeze=2082]="Video_Send_Freeze",e[e.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",e[e.Video_Recv_Freeze=2084]="Video_Recv_Freeze",e[e.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",e[e.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",e[e.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",e[e.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",e})(ts||{}),Me=(function(e){return e[e.Video_Send_Retransmit=2062]="Video_Send_Retransmit",e[e.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",e[e.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",e[e.Video_Send_Transmit=2066]="Video_Send_Transmit",e[e.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",e[e.Video_Capture_Height=2033]="Video_Capture_Height",e[e.Video_Capture_Width=2035]="Video_Capture_Width",e[e.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",e[e.Video_Send_Low_Height=2073]="Video_Send_Low_Height",e[e.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",e[e.Video_Send_Low_Width=2077]="Video_Send_Low_Width",e[e.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",e[e.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",e[e.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",e[e.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",e[e.Video_Send_Width=2003]="Video_Send_Width",e[e.Video_Send_Height=2004]="Video_Send_Height",e[e.Video_Send_Disabled=2095]="Video_Send_Disabled",e[e.Video_Send_Adaptation=2032]="Video_Send_Adaptation",e[e.Video_Send_Player_Status=2128]="Video_Send_Player_Status",e[e.Video_Send_Nacks=2009]="Video_Send_Nacks",e[e.Video_Send_Plis=2010]="Video_Send_Plis",e[e.Video_Send_Firs=2011]="Video_Send_Firs",e[e.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",e[e.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",e[e.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",e[e.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",e[e.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",e[e.Video_Send_Bitrate=2012]="Video_Send_Bitrate",e[e.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",e[e.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",e[e.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",e[e.Audio_Send_Level=2038]="Audio_Send_Level",e[e.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",e[e.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",e[e.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",e[e.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",e[e.Audio_Send_Freeze=2081]="Audio_Send_Freeze",e[e.Audio_Send_Disabled=2096]="Audio_Send_Disabled",e[e.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",e[e.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",e[e.Video_Recv_Height=2019]="Video_Recv_Height",e[e.Video_Recv_Width=2018]="Video_Recv_Width",e[e.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",e[e.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",e[e.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",e[e.Video_Recv_Nacks=2026]="Video_Recv_Nacks",e[e.Video_Recv_Plis=2027]="Video_Recv_Plis",e[e.Video_Recv_Firs=2028]="Video_Recv_Firs",e[e.Video_Recv_Disabled=2101]="Video_Recv_Disabled",e[e.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",e[e.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",e[e.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",e[e.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",e[e.Audio_Render_Level=2043]="Audio_Render_Level",e[e.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",e[e.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",e[e.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",e[e.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",e[e.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",e[e.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",e[e.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",e[e.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",e[e.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",e[e.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",e[e.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",e[e.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",e})(Me||{}),Tn=(function(e){return e[e.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",e[e.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",e[e.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",e[e.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",e[e.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",e[e.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",e[e.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",e[e.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",e[e.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",e[e.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",e[e.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",e[e.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",e[e.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",e[e.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",e[e.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",e[e.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",e[e.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",e[e.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",e[e.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",e[e.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",e[e.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",e[e.Audio_Recv_AV_Sync_TIME=2237]="Audio_Recv_AV_Sync_TIME",e})(Tn||{}),Pn=(function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e[e.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",e})(Pn||{}),Rd=(function(e){return e[e.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",e[e.PAGE_VISIBILITY=2233]="PAGE_VISIBILITY",e})(Rd||{}),Cy=(function(e){return e[e.Transport_Send_Bitrate=2234]="Transport_Send_Bitrate",e[e.Transport_Recv_Bitrate=2235]="Transport_Recv_Bitrate",e})(Cy||{});const Fa=1e3,mm=6,$l=3,bq=Math.max(mm,$l,60);function Ie(e,t,n){n!=null&&Number.isFinite(n)&&(e[t]=Math.round(Math.max(0,n)))}function dL(e){const t={[Pn.CONN_TYPE]:0,[Pn.RTT]:e.rtt,[Pn.STATS_UPDATE_INTERVAL]:e.updateInterval?Math.round(Math.max(0,e.updateInterval)):void 0};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=e.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(t[Pn.CONN_TYPE]=1),n==="tcp"&&(t[Pn.CONN_TYPE]=3),n==="tls"&&(t[Pn.CONN_TYPE]=4);break}case"srflx":t[Pn.CONN_TYPE]=2;break;case"unknown":t[Pn.CONN_TYPE]=5;break;default:t[Pn.CONN_TYPE]=0}return t}function lL(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class uL extends Vt{constructor(t){super(),C(this,"store",void 0),C(this,"uploadWRTCStatsTimer",void 0),C(this,"uploadOutboundDenoiserStatsTimer",void 0),C(this,"uploadExtStatsTimer",void 0),C(this,"uploadExtUsageStatsTimer",void 0),C(this,"uploadInboundExtStatsTimer",void 0),C(this,"requestStats",void 0),C(this,"requestTransportStats",void 0),C(this,"requestLocalMedia",void 0),C(this,"requestRemoteMedia",void 0),C(this,"requestAllTracks",void 0),C(this,"requestVideoIsReady",void 0),C(this,"requestUploadStats",void 0),C(this,"requestUpload",void 0),C(this,"uploadOutboundStarted",!1),C(this,"uploadInboundStarted",!1),C(this,"uploadTransportStarted",!1),C(this,"uploadBaseStatsStarted",!1),C(this,"uploadExtensionUsageStarted",!1),C(this,"lastRecvStats",void 0),C(this,"lastSendStats",void 0),C(this,"lastRefRecvStats",void 0),C(this,"lastRefSendStats",void 0),C(this,"lastNormalRecvStats",void 0),C(this,"lastNormalSendStats",void 0),C(this,"lastExtendStats",{}),C(this,"needUploadStats",{}),C(this,"needUploadRenderFreezeTime",!0),C(this,"lastUploadCompensateTime",-1),C(this,"uploadCompensateDeltaTime",0),this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;const n=t%$l==0,i=t%mm==0,r=t%60==0;let s,o;if(this.uploadTransportStarted&&(s=this.requestStats(),this.store.useP2P&&(o=this.requestStats(!0))),!s&&this.uploadOutboundStarted&&(s=this.requestStats()),!o&&this.uploadInboundStarted&&(o=this.requestStats(!0)),s||o){var a;const c={};if(this.uploadTransportStarted&&s){const p=this.getTransportStats(s,n?this.lastRefSendStats:void 0,o,n);p&&(c.misc=[p])}if(this.uploadOutboundStarted&&s){const p=this.getOutboundStats(s,i?this.lastNormalSendStats:void 0,n?this.lastRefSendStats:void 0,this.lastSendStats,r);p&&(c.outbound=[p])}if(this.uploadInboundStarted&&o){this.uploadCompensateStats(t);const p=this.getInboundStats(o,i?this.lastNormalRecvStats:void 0,n?this.lastRefRecvStats:void 0,this.lastRecvStats);p&&(c.inbound=p)}const u=(a=this.requestTransportStats)===null||a===void 0?void 0:a.call(this).connectState;if(u&&(Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[Rd.RTC_PEER_CONNECTION_STATE]=aS[u]):c.misc=[{addition:{[Rd.RTC_PEER_CONNECTION_STATE]:aS[u]}}]),Pi.needUploadStats.length>0||i){const p=Pi.needUploadStats.shift()||(Pi.visibility==="visible"?1:0);Array.isArray(c.misc)?c.misc[0]&&c.misc[0].addition&&(c.misc[0].addition[Rd.PAGE_VISIBILITY]=p):c.misc=[{addition:{[Rd.PAGE_VISIBILITY]:p}}]}this.needUploadStats.sendType&&(Array.isArray(c.outbound)&&c.outbound[0]&&c.outbound[0].high&&(c.outbound[0].high[cL.Video_Send_Type]=this.needUploadStats.sendType),this.needUploadStats.sendType=void 0),this.requestUploadStats(c)}this.lastRecvStats=o,this.lastSendStats=s,i&&(this.lastNormalRecvStats=o,this.lastNormalSendStats=s),n&&(this.lastRefRecvStats=o,this.lastRefSendStats=s)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0,Pi.startCollectStats();let t=1;this.uploadWRTCStatsTimer=window.setInterval((()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var n,i;const r=(n=this.requestTransportStats)===null||n===void 0?void 0:n.call(this);return void(r&&((i=this.requestUploadStats)===null||i===void 0||i.call(this,{misc:[{addition:{[Rd.RTC_PEER_CONNECTION_STATE]:aS[r.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(t),++t===bq+1&&(t=1)}),Fa)}uploadCompensateStats(t){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const n=t%$l==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!n)return;if(this.lastUploadCompensateTime===-1)return void(this.lastUploadCompensateTime=Date.now());const i=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=i,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;const r=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*r;const s=this.requestStats(!0);new Array(r).fill(0).forEach((()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const o={};if(this.uploadInboundStarted&&s){const a=this.requestRemoteMedia()||[],c=[];a.forEach((u=>{let[p,m]=u;const _={peer:p.uid};if(p._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(p._videoSSRC)&&m.has(_e.VIDEO)&&p.videoTrack){const g=(function(b,v,R){if(!v.videoRecv.find((D=>D.ssrc===b)))return;const O={};if(R&&R._player){const D=R._player,{renderFreezeAccTime2:x,videoElementStatus:B}=D;if(Pi.visibility==="visible"&&B===Vn.PLAYING&&Xe().supportRequestVideoFrameCallback){const G=Math.min(6e3,x);D.renderFreezeAccTime2=Math.max(0,x-G),Ie(O,ts.Video_Render_Freeze_Time_Render2,G),I("USE_NEW_RENDER_FREEZE_TIME")&&Ie(O,ts.Video_Render_Freeze_Time_Render,G)}}return O})(p._videoSSRC,s,p.videoTrack);g&&(_.video=g)}_.video&&c.push(_)})),c.length>0&&(o.inbound=c,this.requestUploadStats(o))}}))}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(t,n,i,r){if(!this.requestStats)return;if(!r)return t.rtt==null?void 0:{addition:{[Pn.RTT]:t.rtt,[Pn.CONN_TYPE]:void 0,[Pn.STATS_UPDATE_INTERVAL]:t.updateInterval||void 0}};const s=dL(t);if(this.store.useP2P){if(i){const o=dL(i);s[Pn.CONN_TYPE]&&o[Pn.CONN_TYPE]&&(s[Pn.CONN_TYPE]+=o[Pn.CONN_TYPE]<<3)}s[Pn.CONN_TYPE]?s[Pn.CONN_TYPE]+=110:s[Pn.CONN_TYPE]=110}else{s[Pn.CONN_TYPE]?s[Pn.CONN_TYPE]+=100:s[Pn.CONN_TYPE]=100;const o=(function(a,c){return c?[Math.ceil(8*(a.transport.bytesSent-c.transport.bytesSent)/(a.timestamp-c.timestamp)),Math.ceil(8*(a.transport.bytesReceived-c.transport.bytesReceived)/(a.timestamp-c.timestamp))]:[0,0]})(t,n);s[Cy.Transport_Send_Bitrate]=o[0],s[Cy.Transport_Recv_Bitrate]=o[1]}return{addition:s}}getOutboundStats(t,n,i,r,s){if(!this.requestUploadStats||!this.requestLocalMedia)return;const o=this.requestLocalMedia();if(!o||o.length===0)return;let a,c,u;return o.forEach((p=>{let[m,{track:_,ssrcs:g}]=p;switch(m){case re.LocalVideoLowTrack:case re.LocalVideoTrack:if(m===re.LocalVideoTrack){var b;const v=(function(x,B,G,j,H,Z){const ne=B.videoSend.find((Ge=>Ge.ssrc===x));if(!ne)return;const he={},{sentFrame:De,inputFrame:Oe}=ne;if(j&&(Ie(he,ts.Video_Send_Qp_Sum,ne.qpSumPerFrame),Oe&&De)){const Ge=Oe.frameRate,Ue=De.frameRate;he[ts.Video_Send_Freeze]=(function(ct,Ut){let ee=!0;return ee=!(ct<=5)&&(ct<=10?Ut<3:ct<=20?Ut<4:Ut<5),ee})(Ge,Ue)?1:0}if(H){switch(De&&(Ie(he,Me.Video_Send_Height,De.height),Ie(he,Me.Video_Send_Width,De.width),Ie(he,Me.Video_Send_Frame_Rate,De.frameRate)),he[Me.Video_Send_Disabled]=G._originMediaStreamTrack&&!G._originMediaStreamTrack.enabled||G._mediaStreamTrack&&!G._mediaStreamTrack.enabled?1:0,ne.adaptionChangeReason){case"none":he[Me.Video_Send_Adaptation]=0;break;case"cpu":he[Me.Video_Send_Adaptation]=1;break;case"bandwidth":he[Me.Video_Send_Adaptation]=2;break;case"other":he[Me.Video_Send_Adaptation]=3}let Ge=0;ne.adaptionChangeReason&&(Ge+=lL(ne.adaptionChangeReason)),B.qualityLimitationReason&&(Ge+=lL(B.qualityLimitationReason)<<3),he[Me.Video_Send_Adaptation]=Ge,he[Me.Video_Send_Player_Status]=yS[G._player?G._player.videoElementStatus:"uninit"],Ie(he,Me.Video_Send_Nacks,ne.nacksCount),Ie(he,Me.Video_Send_Plis,ne.plisCount),Ie(he,Me.Video_Send_Firs,ne.firsCount),Ie(he,Me.Video_Send_Avg_Encode,ne.avgEncodeMs),Ie(he,Me.Video_Send_Huge_Frame_Sent,ne.hugeFramesSent),Ie(he,Me.Video_Send_Bytes_Retransmit,ne.retransmittedBytesSent),Ie(he,Me.Video_Send_Packages_Retransmit,ne.retransmittedPacketsSent),Ie(he,Me.Video_Send_Key_Frames_Encoded,ne.keyFramesEncoded);const Ue=H.videoSend.find((ct=>ct.ssrc===x));if(Ue){let ct=Fa*$l;Ue.timestamp&&ne.timestamp&&(ct=ne.timestamp-Ue.timestamp),Ue.packets!=null&&ne.packets!=null&&Ie(he,Me.Video_Send_Package_Rate,1e3*(ne.packets-Ue.packets)/ct),ne.packetsLost!=null&&Ue.packetsLost!=null&&Ie(he,Me.Video_Send_Package_Lost,ne.packetsLost-Ue.packetsLost),Ue.bytes!=null&&ne.bytes!=null&&Ie(he,Me.Video_Send_Bitrate,8*(ne.bytes-Ue.bytes)/ct)}}return he})(g[0].ssrcId,t,_,n,i),R=_.__className__==="CameraVideoTrack"?3:ie(b=_._hints).call(b,ht.SCREEN_TRACK)?7:10;(this.lastExtendStats.sendType!==R||s)&&(this.needUploadStats={sendType:R},this.lastExtendStats.sendType=R);const O=_&&(function(x,B,G,j){const H=B.videoSend.find((ne=>ne.ssrc===x));if(!H)return null;const Z={};if(j){const ne=H.inputFrame,he=ne&&ne.height||G.videoHeight||0,De=ne&&ne.width||G.videoWidth||0,Oe=ne&&ne.frameRate||0;Ie(Z,Me.Video_Capture_Height,he),Ie(Z,Me.Video_Capture_Width,De),Ie(Z,Me.Video_Capture_Frame_Rate,Oe)}return Z})(g[0].ssrcId,t,_,!!i),D=(function(x,B){const G={};return B&&(Ie(G,Me.Video_Send_Retransmit,x.bitrate.retransmit),Ie(G,Me.Video_Send_Target_Encoded,x.bitrate.targetEncoded),Ie(G,Me.Video_Send_Actual_Encoded,x.bitrate.actualEncoded),Ie(G,Me.Video_Send_Transmit,x.bitrate.transmit),Ie(G,Me.Video_Send_Bandwidth,x.sendBandwidth)),G})(t,!!i);c=Object.assign({},v,O,D)}else u=(function(v,R,O,D,x){const B=R.videoSend.find((j=>j.ssrc===v));if(!B)return;const G={};if(D){const j=B.sentFrame;j&&(Ie(G,Me.Video_Send_Low_Height,j.height),Ie(G,Me.Video_Send_Low_Width,j.width),Ie(G,Me.Video_Send_Low_Frame_Rate,j.frameRate));const H=D.videoSend.find((Z=>Z.ssrc===v));if(H){let Z=Fa*mm;H.timestamp&&B.timestamp&&(Z=B.timestamp-H.timestamp),H.packets!=null&&B.packets!=null&&Ie(G,Me.Video_Send_Low_Package_Rate,1e3*(B.packets-H.packets)/Z),B.packetsLost!=null&&H.packetsLost!=null&&Ie(G,Me.Video_Send_Low_Package_Lost,B.packetsLost-H.packetsLost),H.bytes!=null&&B.bytes!=null&&Ie(G,Me.Video_Send_Low_Bitrate,8*(B.bytes-H.bytes)/Z)}}return G})(g[0].ssrcId,t,0,i);break;case re.LocalAudioTrack:a=_&&(function(v,R,O,D,x,B){const G=R.audioSend.find((H=>H.ssrc===v));if(!G)return;const j={};if(x){j[Me.Audio_Send_Disabled]=O._originMediaStreamTrack&&!O._originMediaStreamTrack.enabled||O._mediaStreamTrack&&!O._mediaStreamTrack.enabled?1:0;const H=100*O._source.getAccurateVolumeLevel(),Z=G.inputLevel;if(Z!=null){const he=Math.ceil(50*Math.log10(100*Z+1));Ie(j,Me.Audio_Send_Level,he)}Ie(j,Me.Audio_Capture_PCM_Level,H),Ie(j,Me.Audio_Send_AEC_Return_Loss,G.aecReturnLoss),Ie(j,Me.Audio_Send_AEC_Return_Loss_Enhancement,G.aecReturnLossEnhancement),Ie(j,Me.Audio_Send_Bytes_Retransmit,G.retransmittedBytesSent),Ie(j,Me.Audio_Send_Packages_Retransmit,G.retransmittedPacketsSent),j[Me.Audio_Send_Freeze]=0;const ne=x.audioSend.find((he=>he.ssrc===v));if(ne){let he=Fa*mm;ne.timestamp&&G.timestamp&&(he=G.timestamp-ne.timestamp),ne.bytes!=null&&G.bytes!=null&&Ie(j,Me.Audio_Send_Bitrate,8*(G.bytes-ne.bytes)/he),ne.packets!=null&&G.packets!=null&&Ie(j,Me.Audio_Send_Package_Rate,1e3*(G.packets-ne.packets)/he)}}return j})(g[0].ssrcId,t,_,0,i)}})),{high:c,low:u,audio:a}}getInboundStats(t,n,i,r){if(!this.requestRemoteMedia)return;const s=this.requestRemoteMedia()||[],o=[];return s.forEach((a=>{let[c,u]=a;const p={peer:c.uid};let m;if(u.has(_e.VIDEO)&&c.videoTrack){const _=c._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(c._videoSSRC)||!1,g=c.videoTrack?(function(b,v,R,O,D,x,B,G){const j=v.videoRecv.find((Ue=>Ue.ssrc===b));if(!j)return;const H={},{receivedFrame:Z,outputFrame:ne,decodeFrameRate:he}=j;Ie(H,Tn.Video_Render_Frame_Rate_Decode,he),j.framesRateFirefox&&Ie(H,Tn.Video_Recv_Frame_Rate,j.framesRateFirefox),Z&&Ie(H,Tn.Video_Recv_Frame_Rate,Z.frameRate),Ie(H,Tn.Video_Recv_Frame_Dropped,j.framesDroppedCount),Ie(H,Tn.Video_Recv_Bytes_Retransmit,j.retransmittedBytesReceived),Ie(H,Tn.Video_Recv_Packages_Retransmit,j.retransmittedPacketsReceived),Ie(H,Tn.Video_Recv_Packages_Discarded,j.packetsDiscarded),Ie(H,Tn.Video_Recv_Avg_Decode,j.avgDecodeMs),Ie(H,Tn.Video_Recv_Avg_Processing_Delay,j.avgProcessingDelayMs),Ie(H,Tn.Video_Recv_Avg_Assembly_Time,j.avgFramesAssembledFromMultiplePacketsMs),Ie(H,Tn.Video_Recv_Avg_Inter_Frame_Delay,j.avgInterFrameDelayMs),Ie(H,Tn.Video_Recv_Key_Frames_Decoded,j.keyFramesDecoded);const De=G&&G.videoRecv.find((Ue=>Ue.ssrc===b));if(De){const Ue=v.timestamp-G.timestamp||Fa;j.packetsLost!=null&&De.packetsLost!=null&&Ie(H,Tn.Video_Recv_Package_Lost,j.packetsLost-De.packetsLost),De.bytes!=null&&j.bytes!=null&&Ie(H,Tn.Video_Recv_Bitrate,8*(j.bytes-De.bytes)/Ue),De.packets!=null&&j.packets!=null&&Ie(H,Tn.Video_Recv_Package_Rate,1e3*(j.packets-De.packets)/Ue)}const Oe=x&&x.videoRecv.find((Ue=>Ue.ssrc===b));if(Oe&&(Ie(H,ts.Video_Recv_Qp_Sum,j.qpSumPerFrame),H[ts.Video_Recv_Freeze]=O&&Ql.isRemoteVideoFreeze(R,j,Oe)?1:0),B){var Ge;const Ue=B.videoRecv.find((Ut=>Ut.ssrc===b));Z?(Ie(H,Me.Video_Recv_Height,Z.height),Ie(H,Me.Video_Recv_Width,Z.width)):R&&(Ie(H,Me.Video_Recv_Height,R._videoHeight||0),Ie(H,Me.Video_Recv_Width,R._videoWidth||0)),ne&&Ie(H,Me.Video_Recv_Frame_Rate_Output,ne.frameRate);const ct=(Ge=R._player)===null||Ge===void 0?void 0:Ge.rendFrameRate.toFixed(0);if(ct&&Ie(H,Me.Video_Render_Frame_Rate_Render,+ct),Ie(H,Me.Video_Recv_Jitter_Buffer,j.jitterBufferMs),Ie(H,Me.Video_Recv_Current_Delay,j.currentDelayMs),Ie(H,Me.Video_Recv_Firs,j.firsCount),Ie(H,Me.Video_Recv_Nacks,j.nacksCount),Ie(H,Me.Video_Recv_Plis,j.plisCount),R){H[Me.Video_Recv_Disabled]=R._originMediaStreamTrack.enabled&&R._mediaStreamTrack.enabled?0:1;const Ut=R._player;if(Ut){const{freezeTimeCounterList:ee,renderFreezeAccTime:ce,renderFreezeAccTime2:ge,videoElementStatus:te}=Ut;if(ee&&ee.length>0&&Ie(H,ts.Video_Render_Freeze_Time,ee.splice(0,1)[0]),D&&Pi.visibility==="visible"&&te===Vn.PLAYING&&Xe().supportRequestVideoFrameCallback){const T=Math.min(6e3,ge);Ut.renderFreezeAccTime2=Math.max(0,ge-T),Ie(H,ts.Video_Render_Freeze_Time_Render2,T);const k=Math.min(6e3,ce);Ut.renderFreezeAccTime=Math.max(0,ce-k),Ie(H,ts.Video_Render_Freeze_Time_Render,I("USE_NEW_RENDER_FREEZE_TIME")?T:k)}if(typeof j.totalFreezesDuration=="number"){const T=Ue&&Ue.totalFreezesDuration?j.totalFreezesDuration-Ue.totalFreezesDuration:j.totalFreezesDuration;Ie(H,Me.Video_Render_Freeze_Duration,1e3*T)}}}if(H[Me.Video_Recv_Player_Status]=yS[R._player?R._player.videoElementStatus:"uninit"],Ue&&j.totalInterFrameDelay!==void 0&&j.totalSquaredInterFrameDelay!==void 0&&Ue.totalInterFrameDelay!==void 0&&Ue.totalSquaredInterFrameDelay!==void 0){const Ut=j.totalInterFrameDelay-Ue.totalInterFrameDelay,ee=j.totalSquaredInterFrameDelay-Ue.totalSquaredInterFrameDelay,ce=j.framesDecodeCount-Ue.framesDecodeCount,ge=Ut/ce*1e3,te=Math.round(1e3*Math.sqrt((ee-Math.pow(Ut,2)/ce)/ce));!isNaN(te)&&ge+te>Math.max(3*ge,ge+150)&&(H[Me.Video_Recv_I_Frame_Delay]=te)}}return H})(c._videoSSRC,t,c.videoTrack,_===!0,this.needUploadRenderFreezeTime,n,i,r):void 0;if(g&&(p.video=g),c.videoTrack){const b=t.videoRecv.find((v=>v.ssrc===c._videoSSRC));b&&b.estimatedPlayoutTimestamp&&(m=b.estimatedPlayoutTimestamp)}}if(u.has(_e.AUDIO)&&c.audioTrack){const _=c.audioTrack?(function(g,b,v,R,O,D){const x=b.audioRecv.find((H=>H.ssrc===g));if(!x)return;const B={};Ie(B,Tn.Audio_Recv_Jitter,x.jitterMs),Ie(B,Tn.Audio_Recv_Bytes_Retransmit,x.retransmittedBytesReceived),Ie(B,Tn.Audio_Recv_Packages_Retransmit,x.retransmittedPacketsReceived),Ie(B,Tn.Audio_Recv_Packages_Discarded,x.packetsDiscarded),Ie(B,Tn.Audio_Recv_Avg_Processing_Delay,x.avgProcessingDelayMs);const G=D&&D.audioRecv.find((H=>H.ssrc===g));if(G){const H=Fa;x.packets!=null&&G.packets!=null&&Ie(B,Tn.Audio_Recv_Package_Rate,1e3*(x.packets-G.packets)/H),x.packetsLost!=null&&G.packetsLost!=null&&Ie(B,Tn.Audio_Recv_Package_Lost,x.packetsLost-G.packetsLost)}if(R){const{receivedFrames:H,droppedFrames:Z}=x;H!=null&&Z!=null&&(B[ts.Audio_Recv_Freeze]=(j=H)===0||100*Z/j>20?1:0)}var j;if(O){const H=100*v._source.getAccurateVolumeLevel(),Z=x.outputLevel;if(Z!=null){const he=Math.ceil(50*Math.log10(100*Z+1));Ie(B,Me.Audio_Render_Level,he)}Ie(B,Me.Audio_Recv_PCM_Level,H),v&&(B[Me.Audio_Recv_Disabled]=v._originMediaStreamTrack.enabled&&v._mediaStreamTrack.enabled?0:1),Ie(B,Me.Audio_Recv_Jitter_Buffer,x.jitterBufferMs),Ie(B,Me.Audio_Recv_Current_Delay,x.jitterBufferMs),B[Me.Audio_Recv_Player_Status]=yS[Jn.getPlayerState(v.getTrackId())];const ne=O.audioRecv.find((he=>he.ssrc===g));if(ne){ne.bytes!=null&&x.bytes!=null&&Ie(B,Me.Audio_Recv_Bitrate,8*(x.bytes-ne.bytes)/(Fa*$l));const he=x.concealedSamples-ne.concealedSamples;he>0&&Ie(B,Me.Audio_Recv_Concealed_Samples,he);const De=x.totalSamplesReceived-ne.totalSamplesReceived;De>0&&Ie(B,Me.Audio_Recv_Total_Samples_Received,De);const Oe=x.freezeSamples80-ne.freezeSamples80;Oe>0&&Ie(B,Me.Audio_Render_Freeze_Samples_80ms,Oe);const Ge=x.freezeSamples200-ne.freezeSamples200;Ge>0&&Ie(B,Me.Audio_Render_Freeze_Samples_200ms,Ge);const Ue=x.freezeMs80-ne.freezeMs80;Ie(B,Me.Audio_Render_Freeze_Time_80ms,Ue<0?0:Ue);const ct=x.freezeMs200-ne.freezeMs200;Ie(B,Me.Audio_Render_Freeze_Time_200ms,ct<0?0:ct)}}return B})(c._audioSSRC,t,c.audioTrack,n,i,r):void 0;if(_&&(p.audio=_),c.audioTrack&&m){const g=t.audioRecv.find((b=>b.ssrc===c._audioSSRC));if(g&&g.estimatedPlayoutTimestamp){const b=g.estimatedPlayoutTimestamp-m;p.audio?p.audio[Tn.Audio_Recv_AV_Sync_TIME]=b:p.audio={[Tn.Audio_Recv_AV_Sync_TIME]:b}}}}(p.video||p.audio)&&o.push(p)})),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval((()=>{if(!this.requestAllTracks||!this.requestUpload)return;const t=(this.requestAllTracks()||[]).find((n=>n instanceof Fl));if(t&&t._external.getDenoiserStats){const n=t._external.getDenoiserStats();n&&this.requestUpload(Ma.DENOISER_STATS,n)}}),2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval((()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach((t=>{t.getProcessorStats().forEach((n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)}))}))}),2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval((()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach((t=>{let[n,i]=t;i.has(_e.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach((r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})),i.has(_e.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach((r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}))}))}),2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const t=new Map;this.uploadExtUsageStatsTimer=window.setInterval((async()=>{const n=Date.now(),i={connectionInterval:I("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n};let r=[];const s=this.requestAllTracks&&this.requestAllTracks()||[];for(const u of s)!u.muted&&u.enabled&&(r=r.concat(await u.getProcessorUsage()));const o=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[u,p]of o)p.has(_e.VIDEO)&&u.videoTrack&&(r=r.concat(await u.videoTrack.getProcessorUsage())),p.has(_e.AUDIO)&&u.audioTrack&&(r=r.concat(await u.audioTrack.getProcessorUsage()));if(r.length===0)return;i.details=(function(u,p){const m={};for(const{id:v,value:R,level:O,direction:D}of u){var _;const x=(_=p.get(v))!==null&&_!==void 0?_:0,B=R===2?x+I("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:x;var g,b;p.set(v,B),m[v]?(R===2&&(m[v].value=R),O>m[v].level&&(m[v].level=O),D==="remote"&&(m[v].remoteUidCount+=1),m[v].totalTs=(g=p.get(v))!==null&&g!==void 0?g:0):m[v]={value:R,level:O,remoteUidCount:D==="local"?0:1,totalTs:(b=p.get(v))!==null&&b!==void 0?b:0}}return Object.keys(m).map((v=>{const{level:R,value:O,totalTs:D}=m[v];return{id:v,level:R,value:O,totalTs:D}}))})(r,t);const a=Date.now(),c=a>n?a:n+1;this.requestUpload&&this.requestUpload(Ma.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c})}),I("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1,Pi.stopCollectStats()}}const wq=I("ICE_RESTART_INTERVAL");let fm=new Map,Cd=new Map,xo=[bn.UDP_TCP_RELAY,bn.TCP_RELAY,bn.RELAY],by=I("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Xe().supportPCSetConfiguration;function hL(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=fm.get(e.id);n&&(window.clearTimeout(n),fm.delete(e.id));const i=Cd.get(e.id);t&&i&&i.index===xo.length-1&&(S.debug("[".concat(e.id,"] reset ICE restart policy")),Cd.delete(e.id))}function pL(e,t,n){if(fm.size===0&&Cd.size===0&&(Array.isArray(I("RESTART_SEQUENCE"))&&I("RESTART_SEQUENCE").length>0&&!(function(a,c){if(a.length!==c.length)return!1;for(let u=0;u<a.length;u+=1){const p=a[u];if(a.filter((m=>m===p)).length!==c.filter((m=>m===p)).length)return!1}return!0})(xo,I("RESTART_SEQUENCE"))&&(xo=I("RESTART_SEQUENCE").filter((a=>{var c;if(ie(c=Object.values(bn)).call(c,a))return!0})),S.debug("use reconnection policy from config distribution, queues: ".concat(xo.join(" => ")))),by=I("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Xe().supportPCSetConfiguration),xo.length===0)return void n();let i,{index:r=0,type:s}=Cd.get(e.id)||{};if(by&&s===bn.RELAY)return void n();let o=s&&r>=xo.length-1;if(by)s=bn.RELAY;else{if(o)return void n();s?(r++,s=xo[r]):(s=xo[0],r=0)}S.debug("[".concat(e.id,"] choose ICE restart policy: ").concat(s,", index: ").concat(r)),t(s),Cd.set(e.id,{index:r,type:s}),i=window.setTimeout((()=>pL(e,t,n)),wq),fm.set(e.id,i)}var Qe;function mL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Is(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?mL(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):mL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}function fL(e){var t,n,i,r=2;for(typeof Symbol<"u"&&(n=cp,i=Symbol.iterator);r--;){if(n&&(t=e[n])!=null)return t.call(e);if(i&&(t=e[i])!=null)return new _m(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function _m(e){function t(n){if(Object(n)!==n)return de.reject(new TypeError(n+" is not an object."));var i=n.done;return de.resolve(n.value).then((function(r){return{value:r,done:i}}))}return _m=function(n){this.s=n,this.n=n.next},_m.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?de.resolve({value:n,done:!0}):t(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?de.reject(n):t(i.apply(this.s,arguments))}},new _m(e)}let Ba=(Qe=class extends Vt{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(be.StateChange,t,this._state)}constructor(e,t){super(),C(this,"isPlanB",void 0),C(this,"store",void 0),C(this,"statsUploader",void 0),C(this,"connection",void 0),C(this,"localTrackMap",new Map),C(this,"remoteUserMap",new Map),C(this,"localDataChannels",[]),C(this,"remoteDataChannelMap",new Map),C(this,"pendingLocalTracks",[]),C(this,"pendingRemoteTracks",[]),C(this,"pendingLocalDataChannels",[]),C(this,"pendingRemoteDataChannels",[]),C(this,"statsCollector",void 0),C(this,"shouldForwardP2PCreation",void 0),C(this,"iceFailedCount",0),C(this,"dtlsFailedCount",0),C(this,"mutex",void 0),C(this,"_state",ut.Disconnected),C(this,"_pcStatsUploadType",I("NEW_ICE_RESTART")?eo.FIRST_CONNECTION:eo.OLD_FIRST_CONNECTION),C(this,"_isStartRestartIce",!1),C(this,"_restartTimer",void 0),C(this,"_isTryConnecting",!1),C(this,"_iceError",null),C(this,"_forceTurn",!1),C(this,"_isWaitPcToRePub",!1),C(this,"handleMuteLocalTrack",(async(n,i,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==ut.Connected)return void r(new J(N.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const o=this.filterTobeMutedTracks(n);if(o.length===0)return void i();const a=o.find((u=>u[0]==="videoLowTrack"));if(a){const u=a[1];this.store.enableInstantMuteRestore?(u.track._originMediaStreamTrack.enabled=!1,S.info("[".concat(this.store.clientId,"] P2PChannel muteLocalLowTrack without close sender because enableInstantMuteRestore is true"))):u.track._originMediaStreamTrack.stop()}this.store.enableInstantMuteRestore?S.info("[".concat(this.store.clientId,"] P2PChannel muteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.muteLocal(o.map((u=>{let[,{id:p}]=u;return p})));const c=this.createMuteMessage(o);await wt(this,be.RequestMuteLocal,c),i()}catch(o){r(o)}finally{s()}})),C(this,"handleUnmuteLocalTrack",(async(n,i,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==ut.Connected)return void r(new J(N.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const o=this.filterTobeUnmutedTracks(n);if(o.length===0)return void i();const a=o.find((u=>u[0]==="videoLowTrack"));if(a){const u=a[1];if(this.store.enableInstantMuteRestore)u.track._originMediaStreamTrack.enabled=!0,S.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalLowTrack without close sender because enableInstantMuteRestore is true"));else{if(u.track._originMediaStreamTrack.stop(),!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding){const p=n._mediaStreamTrack.clone();u.track._mediaStreamTrack=p,u.track._originMediaStreamTrack=p}else{const p=Ry(n,va(this,be.RequestLowStreamParameter));u.track._mediaStreamTrack=p,u.track._originMediaStreamTrack=p}await new de(((p,m)=>{this.handleReplaceTrack(u.track,p,m,!0)}))}}this.store.enableInstantMuteRestore?S.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.unmuteLocal(o.map((u=>{let[,{id:p}]=u;return p})));const c=this.createUnmuteMessage(o);await wt(this,be.RequestUnmuteLocal,c),i()}catch(o){r(o)}finally{s()}})),C(this,"handleUpdateVideoEncoder",(async(n,i,r,s)=>{let o;s||(o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{const c=this.localTrackMap.get(re.LocalVideoTrack);if(!this.connection||!c||c.track!==n||this.state!==ut.Connected)return void i();const{id:u,track:p}=c;await this.connection.updateSendParameters(u,p),await this.connection.updateEncoderConfig(u,p),this.emit(be.UpdateVideoEncoder,p),i()}catch(c){r(c)}finally{var a;(a=o)===null||a===void 0||a()}})),C(this,"handleUpdateVideoSendParameters",(async(n,i,r)=>{const s=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(re.LocalVideoTrack);if(!this.connection||!o||o.track!==n||this.state!==ut.Connected)return void i();const{id:a,track:c}=o;await this.connection.updateSendParameters(a,c),i()}catch(o){r(o)}finally{s()}})),C(this,"handleReplaceMixingTrack",(async(n,i,r,s)=>{if(!this.connection||this.state!==ut.Connected)return void i();const o=yy([n]);let a;S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(o.getTrackId(),"]")),typeof s=="boolean"&&s||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(n,o),i()}catch(u){r(u)}finally{var c;(c=a)===null||c===void 0||c()}})),C(this,"handleReplaceTrack",(async(n,i,r,s)=>{let o;S.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof s=="boolean"&&s||(o=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;const u=Array.from(this.localTrackMap.entries()).find((p=>{let[,{track:m}]=p;return n===m}));if(!this.connection||!u||this.state!==ut.Connected)return void i();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(n,u[1].id)),this.isPlanB){const p=u[1];p.id=n._mediaStreamTrack.id,this.localTrackMap.set(u[0],p)}if(u[0]===re.LocalVideoTrack&&!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding){const p=this.localTrackMap.get(re.LocalVideoLowTrack);if(p){const m=n._mediaStreamTrack.clone();p.track._originMediaStreamTrack.stop(),p.track._mediaStreamTrack=m,p.track._originMediaStreamTrack=m,await new de(((_,g)=>{this.handleReplaceTrack(p.track,_,g,!0)}))}}i()}catch(u){r(u)}finally{var c;(c=o)===null||c===void 0||c()}})),C(this,"handleGetRTCStats",(n=>{n(this.statsCollector.getRTCStats())})),C(this,"handleGetLocalVideoStats",(n=>{n(this.statsCollector.getLocalVideoTrackStats())})),C(this,"handleGetLocalAudioStats",(n=>{n(this.statsCollector.getLocalAudioTrackStats())})),C(this,"handleGetRemoteVideoStats",(n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid])),C(this,"handleGetRemoteAudioStats",(n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid])),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new uL(this.store),this.bindStatsUploaderEvents(),this.mutex=new Cn("P2PChannel-mutex",this.store.clientId),this.isPlanB=!Xe().supportUnifiedPlan||I("CHROME_FORCE_PLAN_B")&&Ss(),this.shouldForwardP2PCreation=I("FORWARD_P2P_CREATION")&&Xe().supportPCSetConfiguration&&Z0(),this.shouldForwardP2PCreation&&(this.connection=Zl(this.store),this.emit(be.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var n;this.state=ut.New,this._forceTurn=vy(e),S.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));const i=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if((!this.shouldForwardP2PCreation||i||t)&&((i||t)&&this.connection&&(S.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=Zl(this.store,e),this.emit(be.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new J(N.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=I("NEW_ICE_RESTART")?eo.FIRST_CONNECTION:eo.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e){if(!this.connection)throw new J(N.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");if(!this.isPreallocation()||this.state!==ut.Connected){this.store.peerConnectionStart();const t=await this.connection.connect(e);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=ut.Connected,t}if(this.connection instanceof qi&&this.connection.checkDtlsParameters(e.dtlsParameters.fingerprints))return S.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] dtls parameters mismatch, try next.")),Se.reportApiInvoke(this.store.sessionId,{name:xt.MISMATCH_DTLS_PARAMETERS,options:[e.dtlsParameters.fingerprints],tag:Ct.TRACER}).onSuccess(),void setTimeout((()=>{this.emit(be.RequestReconnect)}));await this.connection.updateRemoteConnect(e)}updateRemoteRTPCapabilities(e){const t=Array.from(this.localTrackMap.entries()).filter((r=>{var s;let[o]=r;return ie(s=[re.LocalVideoLowTrack,re.LocalVideoTrack]).call(s,o)})),n=t.map((r=>{let[,{id:s}]=r;return s})),i=t.map((r=>{let[s]=r;return s}));if(this.connection instanceof qi||this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"){if(Se.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!ie(e).call(e,this.store.codec)){const r=["vp9","vp8","h264"].find((s=>ie(e).call(e,s)));r&&(this.store.codec=r,S.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(n,e)}}async getEstablishParams(){var e;return this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof qi&&this.connection.peerConnectionState!=="closed"&&ie(e=[ut.New,ut.Connected]).call(e,this.state)?this.connection.establishPromise:void 0}async publishDataChannel(e){if(!this.connection||this.state!==ut.Connected){if(this.state===ut.Disconnected)throw new J(N.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return e.forEach((n=>{var i;ie(i=this.pendingLocalDataChannels).call(i,n)||this.pendingLocalDataChannels.push(n)})),[]}const t=this.filterTobePublishedDataChannels(e);return t.length===0?[]:(t.forEach((n=>{const i=Date.now();this.store.publish(n.id.toString(),"datachannel",i)})),await this.connection.createDataChannels(this.store.uid,t),t.forEach((n=>{this.localDataChannels.push(n);const i=Date.now();this.store.publish(n.id+"","datachannel",void 0,i)})),e.map((n=>({streamId:n.id,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:n.metadata,channelId:n._originDataChannelId}))))}publish(e,t,n){var i=this;return li((function*(){const r=yield He(i.mutex.lock("From P2PChannel.publish"));try{var s;const o=i.connection&&ie(s=["disconnected","failed"]).call(s,i.connection.peerConnectionState);if(!i.connection||i.state!==ut.Connected||o){if(i.state===ut.Disconnected)throw new J(N.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(e);const c=e.filter((u=>i.pendingLocalTracks.indexOf(u)===-1));return i.pendingLocalTracks=i.pendingLocalTracks.concat(c),void(o&&(i._isWaitPcToRePub=!0))}i.store.pubId=i.store.pubId+1,Fn.markPublishStart(i.store.clientId,i.store.pubId);const a=i.filterTobePublishedTracks(e,t,n);if(a.length===0)return void(yield He(i.tryToUnmuteAudio(e)));yield*zc(fL(i.doPublish(i.connection,a)))}finally{r()}}))()}doPublish(e,t){var n=this;return li((function*(){t.forEach((_=>{let{track:g,type:b}=_;const v=Date.now();n.store.publish(g.getTrackId(),b===re.LocalAudioTrack?"audio":"video",v)})),n.bindLocalTrackEvents(t);const i=t.map((_=>{let{track:g}=_;return g})),r=yield He(e.send(i,n.store.codec,n.store.audioCodec)),s=(yield He(r.next())).value,o=n.createGatewayPublishMessage(t,s);let a;try{a=yield o}catch(_){throw r.throw(_),_?.code===N.WS_ABORT&&t.forEach((g=>{let{track:b}=g;n.pendingLocalTracks.indexOf(b)===-1&&n.pendingLocalTracks.push(b)})),n.unbindLocalTrackEvents(t),_}const c=n.mapPubResToRemoteConfig(o,a,i),u=(yield He(r.next(c))).value;if(n.state===ut.Disconnected)throw new J(N.UNEXPECTED_ERROR,"PeerConnection already disconnected.");I("ENABLE_VIDEO_SEI");const p=I("ENABLE_ENCODED_TRANSFORM"),m=I("ENABLE_AUDIO_METADATA");i.forEach((async _=>{const g=_.getRTCRtpTransceiver();if(!g||!p)return;const{interceptLocalVideoFrame:b,interceptLocalAudioFrame:v}=sm();_.trackMediaType===_e.VIDEO?await b(g.sender,_):_.trackMediaType===_e.AUDIO&&await v(g.sender,{metadata:m?()=>{const R=_.metadata.shift();return R&&R.value}:void 0})})),t.forEach((_=>{let{type:g}=_;n.statsCollector.addLocalStats(g)})),n.assignLocalTracks(t,u),n.statsUploader.startUploadOutboundStats(),t.forEach((_=>{let{track:g,type:b}=_;const v=Date.now();n.store.publish(g.getTrackId(),b===re.LocalAudioTrack?"audio":"video",void 0,v)}))}))()}async updateVideoStreamParameter(e,t){const n=this.localTrackMap.get(t);if(!n||!this.connection)return;if(!(n.track instanceof bt))return S.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");const{track:i}=n,r=(function(s,o){const a={};return s.height&&s.width&&(a.scaleResolutionDownBy=$S(s,o)),a.maxFramerate=s.framerate?fi(s.framerate):void 0,a.maxBitrate=s.bitrate?1e3*s.bitrate:void 0,a})(e,i);if(i._encoderConfig||(i._encoderConfig={}),t!==re.LocalVideoLowTrack||!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const s=i._originMediaStreamTrack;if(!s.canvas)return S.warn("[".concat(i.getTrackId(),"] no canvas on track"));(function(o,a){const c=o.canvas;a.width&&(c.width=fi(a.width)),a.height&&(c.height=fi(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=RS((()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture()}),fi(a.framerate)))})(s,e)}r.maxBitrate!=null&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(i._encoderConfig.frameRate&&typeof i._encoderConfig.frameRate=="object"?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),S.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i)}publishLowStream(e){var t=this;return li((function*(){if(!t.connection||t.state!==ut.Connected)return;const n=yield He(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const r=t.localTrackMap.get(re.LocalVideoTrack);if(!r)throw new J(N.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(re.LocalVideoLowTrack))throw new J(N.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const s=[{track:t.getLowVideoTrack(r.track,e),type:re.LocalVideoLowTrack}];if(yield*zc(fL(t.doPublish(t.connection,s))),r.track.muted||!r.track.enabled){var i;const o=(i=t.localTrackMap.get(re.LocalVideoLowTrack))===null||i===void 0?void 0:i.id;o!==void 0&&(yield He(t.connection.muteLocal([o])))}}finally{n()}}))()}async republish(){this.pendingLocalTracks.length>0&&(S.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await sn(this,be.RequestRePublish,this.pendingLocalTracks),this.emit(be.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(S.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await sn(this,be.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:n,kind:i}=this.pendingRemoteTracks[t];(i!==_e.AUDIO||n._audio_added_&&n._audioSSRC)&&(i!==_e.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await sn(this,be.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:n}of this.pendingRemoteTracks)await this.subscribe(t,n,n===_e.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach((t=>{let{user:n}=t;this.emit(be.MediaReconnectEnd,n.uid)})),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==ut.Connected)return void e.forEach((i=>{const r=this.pendingLocalTracks.indexOf(i);r!==-1&&this.pendingLocalTracks.splice(r,1)}));const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const n=t.find((i=>i[0]==="videoLowTrack"));return n&&n[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==ut.Connected)return void e.forEach((n=>{const i=this.pendingLocalDataChannels.indexOf(n);i!==-1&&this.pendingLocalDataChannels.splice(i,1)}));const t=this.filterTobeUnpublishedDataChannels(e);return t.length!==0?(t.forEach((n=>{const i=this.localDataChannels.indexOf(n);i!==-1&&this.localDataChannels.splice(i,1)})),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),t.map((n=>n.id))):void 0}async unpublishLowStream(){if(!this.connection||this.state!==ut.Connected)return;const e=this.localTrackMap.get(re.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[re.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const n=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map((i=>{let[,{id:r}]=i;return r}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((i=>{let[r,{track:s}]=i;return{type:r,track:s}}))),t.forEach((i=>{let[r]=i;this.statsCollector.removeLocalStats(r)})),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(e,t){if(!this.connection||this.state!==ut.Connected)throw new J(N.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=t.filter((i=>{var r;return!((r=this.remoteDataChannelMap.get(e))!==null&&r!==void 0&&r.get(i.id))}));if(n.length!==0)return await this.connection.createDataChannels(e.uid,n),n.forEach((i=>{var r;this.remoteDataChannelMap.has(e)?(r=this.remoteDataChannelMap.get(e))===null||r===void 0||r.set(i.id,i):this.remoteDataChannelMap.set(e,new Map([[i.id,i]]));const s=this.pendingRemoteDataChannels.findIndex((o=>{let{user:a,id:c}=o;return a.uid===e.uid&&c===i.id}));s!==-1&&this.pendingRemoteDataChannels.splice(s,1)})),n.map((i=>i.id))}async subscribe(e,t,n,i,r){var s;if(!this.connection||this.state!==ut.Connected)throw new J(N.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((s=this.remoteUserMap.get(e))!==null&&s!==void 0&&s.has(t))return;let o,a,c,u;const p=this.connection.getPreMedia(n);if(p)S.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(n,", no need to send sub to gateway.")),c=p.transceiver,o=p.track,a=p.mid,u=p.player,p.firstVideoRender&&this.store.firstVideoFrameDecoded(e.uid,{firstPreRender:p.firstVideoRender});else if(r){const g=r.find((v=>{let{stream_type:R}=v;return R===t}));if(!g)throw new J(N.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const b=await this.connection.receive(t,g.ssrcs,String(e._uintid),g.attributes);(this.connection instanceof qi||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=b.transceiver),o=b.track,a=b.id}else{const g=await this.connection.receive(t,[{ssrcId:n,rtx:i}],String(e._uintid),void 0);(this.connection instanceof qi||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(c=g.transceiver),o=g.track,a=g.id}if(t===_e.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new ld(o,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new dd(o,e.uid,e._uintid,this.store,u),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId())),e._videoTrack.once(ir.PLAY_START,(()=>{this.store.firstVideoFrameDecoded(e.uid,{playStart:Date.now()})})),e._videoTrack.once(ir.PLAY_END,(()=>{this.store.firstVideoFrameDecoded(e.uid,{playEnd:Date.now()}),this.reportVideoFirstFrameRender(e)})),u?e._videoTrack.once(ir.FIRST_FRAME_RENDER,(()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)})):e._videoTrack.once(ir.FIRST_FRAME_DECODED,(()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)}))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack)),c&&I("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:g,interceptRemoteAudioFrame:b}=sm();t==_e.VIDEO?await g(c.receiver,{onSei:I("ENABLE_VIDEO_SEI")&&(v=>{var R;return(R=e._videoTrack)===null||R===void 0?void 0:R._onSei(v)}),onFirstFrame:v=>{var R;const O=Array.from(zn(R=this.remoteUserMap).call(R)).find((D=>D._videoSSRC===v.ssrc));O&&this.store.firstVideoFrameDecoded(O.uid,{firstReceivedEncodedFrame:Date.now(),frameType:v.type,rtpTimestamp:v.rtpTimestamp,framePayloadType:v.payloadType,frameDataLength:v.length,mimeType:v.mimeType})}}):t==_e.AUDIO&&await b(c.receiver,{enableTopn:!!I("ENABLE_AUDIO_TOPN"),enableMetadata:!!I("ENABLE_AUDIO_METADATA"),enablePts:!!I("ENABLE_AUDIO_PTS"),onMetadata:v=>{this.safeEmit(be.AudioMetadata,v)},onPts:v=>{this.safeEmit(be.AudioPts,v)}})}const m=this.remoteUserMap.get(e);m?m.set(t,a):this.remoteUserMap.set(e,new Map([[t,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const _=this.pendingRemoteTracks.findIndex((g=>{let{user:b,kind:v}=g;return b.uid===e.uid&&t===v}));_!==-1&&(this.pendingRemoteTracks.splice(_,1),this.emit(be.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==ut.Connected)throw new J(N.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter((r=>{var s;let{user:o,mediaType:a}=r;return!((s=this.remoteUserMap.get(o))!==null&&s!==void 0&&s.has(a))}));const t=[],n=new Map;e.forEach((r=>{if(!this.connection)return;const s=this.connection.getPreMedia(r.ssrcId);if(s){const{track:o,mid:a,transceiver:c,player:u}=s;n.set(r.ssrcId,{track:o,id:a,transceiver:c,player:u})}else t.push(r)}));const i=await this.connection.batchReceive(t.map((r=>{let{user:s,mediaType:o,ssrcId:a,rtxSsrcId:c}=r;return{kind:o,ssrcMsg:[{ssrcId:a,rtx:c}],mslabel:String(s._uintid)}})));t.forEach(((r,s)=>{n.set(r.ssrcId,i[s])}));for(const{user:r,mediaType:s,ssrcId:o}of e){const a=n.get(o);if(!a)return void S.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(r.uid," subscribe data,").concat(s,", ").concat(o));const{track:c,id:u,transceiver:p,player:m}=a;if(p&&I("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:b,interceptRemoteAudioFrame:v}=sm();s==_e.VIDEO?await b(p.receiver,{onSei:I("ENABLE_VIDEO_SEI")&&(R=>{var O;return(O=r._videoTrack)===null||O===void 0?void 0:O._onSei(R)}),onFirstFrame:R=>{var O;const D=Array.from(zn(O=this.remoteUserMap).call(O)).find((x=>x._videoSSRC===R.ssrc));D&&this.store.firstVideoFrameDecoded(D.uid,{firstReceivedEncodedFrame:Date.now(),frameType:R.type,rtpTimestamp:R.rtpTimestamp,framePayloadType:R.payloadType,frameDataLength:R.length,mimeType:R.mimeType})}}):s==_e.AUDIO&&await v(p.receiver,{enableTopn:!!I("ENABLE_AUDIO_TOPN"),enableMetadata:!!I("ENABLE_AUDIO_METADATA"),enablePts:!!I("ENABLE_AUDIO_PTS"),onMetadata:R=>{this.safeEmit(be.AudioMetadata,R)},onPts:R=>{this.safeEmit(be.AudioPts,R)}})}if(s===_e.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(c):(r._audioTrack=new ld(c,r.uid,r._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),p&&r._audioTrack._updateRtpTransceiver(p),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(c):(r._videoTrack=new dd(c,r.uid,r._uintid,this.store,m),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),p&&r._videoTrack._updateRtpTransceiver(p),this.bindRemoteTrackEvents(r,r._videoTrack)),I("ENABLE_VIDEO_SEI")&&p){const{interceptRemoteVideoFrame:b,interceptRemoteAudioFrame:v}=sm();s==_e.VIDEO?await b(p.receiver,{onSei:R=>{var O;(O=r._videoTrack)===null||O===void 0||O._onSei(R)},onFirstFrame:R=>{var O;const D=Array.from(zn(O=this.remoteUserMap).call(O)).find((x=>x._videoSSRC===R.ssrc));D&&this.store.firstVideoFrameDecoded(D.uid,{firstReceivedEncodedFrame:Date.now(),frameType:R.type,rtpTimestamp:R.rtpTimestamp,framePayloadType:R.payloadType,frameDataLength:R.length,mimeType:R.mimeType})}}):s==_e.AUDIO&&await v(p.receiver)}const _=this.remoteUserMap.get(r);_?_.set(s,u):this.remoteUserMap.set(r,new Map([[s,u]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();const g=this.pendingRemoteTracks.findIndex((b=>{let{user:v,kind:R}=b;return v.uid===r.uid&&s===R}));g!==-1&&(this.pendingRemoteTracks.splice(g,1),this.emit(be.MediaReconnectEnd,r.uid))}}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter((o=>{let{user:a,kind:c}=o;return t!==void 0?a.uid===e.uid&&t===c:a.uid===e.uid}));if(i.forEach((o=>{const a=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(a,1)})),this.connection&&this.state===ut.Connected||n||i.forEach((o=>{let{kind:a}=o;var c;if(a===_e.AUDIO)(c=e._audioTrack)===null||c===void 0||c._destroy(),e._audioTrack=void 0;else if(a===_e.VIDEO){var u;(u=e._videoTrack)===null||u===void 0||u._destroy(),e._videoTrack=void 0}})),!this.connection||this.state!==ut.Connected)return;const r=this.filterTobeUnSubscribedTracks(e,t);if(r.length===0)return;await this.connection.stopReceiving(r.map((o=>{let[,{id:a}]=o;return a})));const s=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach((o=>{let[a,{kind:c}]=o;var u,p;if(c===_e.VIDEO&&a._videoSSRC&&((u=this.connection)===null||u===void 0||u.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===_e.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),n||((p=a._videoTrack)===null||p===void 0||p._destroy(),a._videoTrack=void 0);else if(c===_e.AUDIO){var m;this.unbindRemoteTrackEvents(a._audioTrack),!n&&((m=a._audioTrack)===null||m===void 0||m._destroy(),a._audioTrack=void 0)}})),s}async unsubscribeDataChannel(e,t){if(t.forEach((r=>{const s=this.pendingRemoteDataChannels.findIndex((o=>o.id===r.id));s!==-1&&this.pendingRemoteDataChannels.splice(s,1)})),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(e,t);if(n.length===0)return;t.forEach((r=>{r._close()}));const i=this.remoteDataChannelMap.get(e);return n.forEach((r=>{i&&i.delete(r.id)})),i&&i.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),n.map((r=>r.id))}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:r,mediaType:s}of e){const o=this.pendingRemoteTracks.filter((a=>{let{user:c,kind:u}=a;return s!==void 0?c.uid===r.uid&&s===u:c.uid===r.uid}));o.forEach((a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)})),t=t.concat(o)}if(!this.connection||this.state!==ut.Connected)return void t.forEach((r=>{let{user:s,kind:o}=r;var a;if(o===_e.AUDIO)(a=s._audioTrack)===null||a===void 0||a._destroy(),s._audioTrack=void 0;else if(o===_e.VIDEO){var c;(c=s._videoTrack)===null||c===void 0||c._destroy(),s._videoTrack=void 0}}));const n=$i(e).call(e,((r,s)=>{let{user:o,mediaType:a}=s;const c=this.filterTobeUnSubscribedTracks(o,a);return r.concat(c)}),[]);if(n.length===0)return;await this.connection.stopReceiving(n.map((r=>{let[,{id:s}]=r;return s})));const i=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach((r=>{let[s,{kind:o}]=r;var a,c;if(o===_e.VIDEO&&s._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),o===_e.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),(c=s._videoTrack)===null||c===void 0||c._destroy(),s._videoTrack=void 0;else if(o===_e.AUDIO){var u;this.unbindRemoteTrackEvents(s._audioTrack),(u=s._audioTrack)===null||u===void 0||u._destroy(),s._audioTrack=void 0}})),i}isPreSubScribe(e){return!this.connection||this.state!==ut.Connected?!1:!!this.connection.getPreMedia(e)}async muteRemote(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void S.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void S.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===_e.VIDEO?e._videoSSRC:e._audioSSRC;i!==void 0&&this.connection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void S.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(t)||S.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}addAudioMetadata(e){const t=this.localTrackMap.get(re.LocalAudioTrack),n=t&&t.track;n&&n.metadata.push(e)}getAllTracks(e){const t=this.localTrackMap.get(re.LocalAudioTrack);if(t?.track instanceof dn){const n=t.track;return Array.from(this.localTrackMap.entries()).filter((i=>{let[r]=i;return r!==re.LocalAudioTrack})).filter((i=>{let[r]=i;return!(e&&r===re.LocalVideoLowTrack)})).map((i=>{let[,{track:r}]=i;return r})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((n=>{let[i]=n;return!(e&&i===re.LocalVideoLowTrack)})).map((n=>{let[,{track:i}]=n;return i}))}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,i,r){if(e){const o=this.localTrackMap.get(re.LocalAudioTrack),a=i?this.localTrackMap.get(re.LocalVideoLowTrack):this.localTrackMap.get(re.LocalVideoTrack);Se.publish(this.store.sessionId,{eventElapse:Fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(ht.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var s;n||(n=[]);const o=n.find((c=>c instanceof Yt)),a=i?(s=this.localTrackMap.get(re.LocalVideoTrack))===null||s===void 0?void 0:s.track:n.find((c=>c instanceof bt));Se.publish(this.store.sessionId,{eventElapse:Fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(ht.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===_e.VIDEO?n._videoSSRC:n._audioSSRC;r&&Se.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===_e.VIDEO,audio:i===_e.AUDIO,peerid:n.uid,subscribeRequestid:r,p2pid:this.store.p2pId,eventElapse:Fn.measureFromSubscribeStart(this.store.clientId,r),preSsrc:this.isPreSubScribe(r)})}reset(){S.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Cn("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=Zl(this.store),this.emit(be.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(re.LocalAudioTrack);if(e?.track instanceof dn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((n=>{t.removeAudioTrack(n)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=ut.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.connection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(re.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(re.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof bt||t&&t.track instanceof Yt?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(zn(t=this.remoteUserMap).call(t)).find((i=>i.uid===e));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(re.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=la(e).call(e,((n,i)=>n.level-i.level)),e}async disconnectForReconnect(){this.connection&&(S.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=ut.Reconnecting,I("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&((n=t._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=Zl(this.store),this.emit(be.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[n,{track:i}]=e;switch(n){case re.LocalVideoTrack:ie(t=i._hints).call(t,ht.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case re.LocalAudioTrack:i instanceof dn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case re.LocalVideoLowTrack:}})),this.emit(be.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;Array.from(zn(n).call(n)).forEach((i=>{this.setPendingRemoteMedia(t,i)})),this.emit(be.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach((e=>{this.pendingLocalDataChannels.push(e)})),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach((e=>{let[t,n]=e;Array.from(zn(n).call(n)).forEach((i=>{this.setPendingRemoteDataChannel(t,i)}))})),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),S.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const n of this.pendingRemoteDataChannels){const{user:i,id:r}=n;if((e instanceof ko?e.uid:e)===i.uid&&r===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof ko?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return li((function*(){if(!t.connection||t.state!==ut.Connected)return;const n=yield He(t.mutex.lock("From P2PChannel.restartICE"));let i;try{i=yield He(t.connection.restartICE(e));const s=yield He(i.next());if(s.done)return;const o=s.value,a=yield o;switch(Ty(t.connection)&&t.reportPCStats(Date.now(),!1,t._pcStatsUploadType),e){case bn.UDP_TCP_RELAY:t._pcStatsUploadType=eo.UDP_TCP_RESTART;break;case bn.TCP_RELAY:t._pcStatsUploadType=eo.TCP_RESTART;break;case bn.RELAY:t._pcStatsUploadType=eo.RELAY_RESTART;break;default:t._pcStatsUploadType=eo.OLD_RESTART}t._isTryConnecting=!0,i.next(a)}catch(s){var r;(r=i)===null||r===void 0||r.throw(s)}finally{n()}}))()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(re.LocalVideoTrack),n=this.localTrackMap.get(re.LocalAudioTrack),i=e.videoSend.find((g=>g.ssrc===t?.ssrcs[0].ssrcId)),r=e.audioSend.find((g=>g.ssrc===n?.ssrcs[0].ssrcId));if(!i||!r)return 1;const s=Di(this,be.NeedSignalRTT),o=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=o&&a?(o+a)/2:o||a,u=(c&&s?(c+s)/2:c||s)||0,p=100*e.sendPacketLossRate*.7/50+.3*u/1500,m=p<.17?1:p<.36?2:p<.59?3:p<.1?4:5,_=t?.track;if(_&&_._encoderConfig&&_._hints.indexOf(ht.SCREEN_TRACK)===-1){const g=_._encoderConfig.bitrateMax,b=e.bitrate.actualEncoded;if(g&&b){const v=(1e3*g-b)/(1e3*g);return tP[v<.15?0:v<.3?1:v<.45?2:v<.6?3:4][m]}}return m}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,s=i._videoSSRC,o=e.audioRecv.find((b=>b.ssrc===r)),a=e.videoRecv.find((b=>b.ssrc===s));if(!o&&!a)return void(t+=1);const c=Di(this,be.NeedSignalRTT),u=e.rtt,p=(u&&c?(u+c)/2:u||c)||0,m=o?o.jitterMs:void 0,_=e.recvPacketLossRate;let g=.7*_*100/50+.3*p/1500;m&&(g=.6*_*100/50+.2*p/1500+.2*m/400),t+=g<.1?1:g<.17?2:g<.36?3:g<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new de(((t,n)=>{this.handleMuteLocalTrack(e,t,n)}))}async replaceTrack(e,t){var n;if(S.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(t.getTrackId(),"]")),!this.connection||this.state!==ut.Connected)return;const i=Array.from(this.localTrackMap.entries()).find((s=>{let[,{track:o}]=s;return e===o}));if(!i)return;const r=i[0];if(e!==t&&(this.unbindLocalTrackEvents([{track:e,type:r}]),this.bindLocalTrackEvents([{track:t,type:r}]),i[1].track=t),await((n=this.connection)===null||n===void 0?void 0:n.replaceTrack(t,i[1].id)),this.isPlanB){const s=i[1];s.id=t._mediaStreamTrack.id,this.localTrackMap.set(r,s)}if(r===re.LocalVideoTrack&&!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding){const s=this.localTrackMap.get(re.LocalVideoLowTrack);if(s){const o=e._mediaStreamTrack.clone();s.track._originMediaStreamTrack.stop(),s.track._mediaStreamTrack=o,s.track._originMediaStreamTrack=o,await new de(((a,c)=>{this.handleReplaceTrack(s.track,a,c,!0)}))}}}filterTobePublishedTracks(e,t,n){const i=[],r=this.getAllTracks();e=Jc(e=e.filter((c=>r.indexOf(c)===-1)));let s,o=!1;const a=this.localTrackMap.get(re.LocalAudioTrack);for(const c of e){if(c instanceof bt&&(this.localTrackMap.has(re.LocalVideoTrack)||o?new J(N.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:re.LocalVideoTrack}),o=!0),t)){const u=this.getLowVideoTrack(c,n);i.push({track:u,type:re.LocalVideoLowTrack})}if(c instanceof Yt)if(a){const u=a.track;if(u instanceof dn)Sy([c]),u.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{const p=yy([u,c]);S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(p.getTrackId(),"]")),this.replaceTrack(u,p)}}else s instanceof dn?(Sy([c]),s.addAudioTrack(c)):s||!c._useAudioElement&&Xe().webAudioMediaStreamDest&&!c._bypassWebAudio?s=yy(s?[c,s]:[c]):s=c}return s&&(S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(s.getTrackId(),"]")),i.push({track:s,type:re.LocalAudioTrack})),i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=Jc(e=e.filter((i=>n.indexOf(i)!==-1)));for(const i of e){if(i instanceof Yt){const r=this.localTrackMap.get(re.LocalAudioTrack);if(!r)continue;r.track instanceof dn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(t.push([re.LocalAudioTrack,r]),r.track.close())):t.push([re.LocalAudioTrack,r])}if(i instanceof bt){const r=this.localTrackMap.get(re.LocalVideoTrack);if(!r)continue;t.push([re.LocalVideoTrack,r]);const s=this.localTrackMap.get(re.LocalVideoLowTrack);s&&t.push([re.LocalVideoLowTrack,s])}}return t}filterTobePublishedDataChannels(e){return e=(e=Jc(e)).filter((t=>this.localDataChannels.findIndex((n=>n.id===t.id))===-1))}filterTobeUnpublishedDataChannels(e){return e=(e=(e=Jc(e)).filter((t=>this.localDataChannels.indexOf(t)!==-1))).filter((t=>t._originDataChannel))}bindLocalTrackEvents(e){e.forEach((t=>{let{track:n,type:i}=t;switch(i){case re.LocalVideoTrack:n.addListener(ye.GET_STATS,this.handleGetLocalVideoStats),n.addListener(ye.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(ye.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(ye.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(ye.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case re.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case re.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof dn?e.trackList.forEach((n=>{n.addListener(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(ye.GET_STATS,this.handleGetLocalAudioStats),n.addListener(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(ye.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(ye.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(ye.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((t=>{let[n,{track:i}]=t;return{track:i,type:n}}))),e.forEach((t=>{let{track:n,type:i}=t;switch(i){case re.LocalVideoTrack:n.off(ye.GET_STATS,this.handleGetLocalVideoStats),n.off(ye.GET_RTC_STATS,this.handleGetRTCStats),n.off(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(ye.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(ye.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(ye.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case re.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case re.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof dn?e.trackList.forEach((t=>{t.off(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ye.GET_STATS,this.handleGetLocalAudioStats),t.off(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(ye.GET_STATS,this.handleGetLocalAudioStats),e.off(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ye.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ye.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof dd&&t.addListener(ye.GET_STATS,(n=>{n(this.handleGetRemoteVideoStats(e))})),t instanceof ld&&t.addListener(ye.GET_STATS,(n=>{n(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ye.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;n.has(_e.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(_e.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((n,i)=>{var r;let s,o,{track:a,type:c}=n;switch(c){case re.LocalAudioTrack:s=_t.Audio,o={dtx:a instanceof Fl&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case re.LocalVideoTrack:s=ie(r=a._hints).call(r,ht.SCREEN_TRACK)?_t.Screen:_t.High,o=Is(Is({},_P(a)),{},{codec:this.store.codec,svc_mode:Hl()});break;case re.LocalVideoLowTrack:s=_t.Low,o=Is(Is({},_P(a)),{},{codec:this.store.codec,svc_mode:Hl()})}return{stream_type:s,attributes:o,ssrcs:t[i]}}))}createGatewayUnpublishMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case re.LocalVideoTrack:i=ie(n=s._hints).call(n,ht.SCREEN_TRACK)?_t.Screen:_t.High;break;case re.LocalAudioTrack:i=_t.Audio;break;case re.LocalVideoLowTrack:i=_t.Low}return{stream_type:i,ssrcs:o,mid:a}}))}assignLocalTracks(e,t){e.forEach(((n,i)=>{let{track:r,type:s}=n;this.localTrackMap.set(s,{track:r,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((t=>{let[n]=t;this.localTrackMap.delete(n)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(be.PeerConnectionStateChange,t),t==="connecting"&&e instanceof qi&&!Nt()&&I("FIRST_TCP_CANDIDATE")&&window.setTimeout((()=>{t==="connecting"&&e.extendCandidate()}),I("FIRST_TCP_CANDIDATE_INTERVAL")),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),e instanceof qi&&hL(e,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=eo.DISCONNECTED_OR_FAILED,Di(this,be.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){const n=this.pendingLocalTracks.map((r=>r.getTrackId())),i=this.pendingLocalDataChannels.map((r=>"dc_".concat(r.id)));Se.reportApiInvoke(this.store.sessionId,{name:xt.REPUB_AFTER_PC_CONNECTED,options:n.concat(i),tag:Ct.TRACER}).onSuccess(),this.republish()}if(I("NEW_ICE_RESTART")&&e instanceof qi&&!Nt()&&!this._forceTurn&&!this.store.useDcSignal){if(ie(lP).call(lP,t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const n=r=>{Ty(e)&&(S.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(r)),Di(this,be.QueryClientConnectionState)==="CONNECTED"&&this.emit(be.RequestRestartICE,r))},i=()=>{Ty(e)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),S.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout((()=>this.emit(be.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout((()=>{pL(e,n,i)}),800))}}else{if(t==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout((()=>{e.iceConnectionState==="disconnected"&&I("ICE_RESTART")&&Di(this,be.QueryClientConnectionState)==="CONNECTED"&&this.emit(be.RequestRestartICE)}),800),void setTimeout((()=>{e.peerConnectionState==="disconnected"&&(S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout((()=>this.emit(be.P2PLost)),0),this.iceFailedCount+=1,this.requestReconnect())}),4e3);t==="failed"&&(S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout((()=>this.emit(be.P2PLost)),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),Se.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:Ct.TRACER}).onSuccess(),this.emit(be.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var n;const i=Array.from(zn(n=this.remoteUserMap).call(n)).find((s=>s._audioSSRC===t));var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(ir.FIRST_FRAME_DECODED),Se.firstRemoteFrame(this.store.sessionId,cn.FIRST_AUDIO_DECODE,Mt.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:Fn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var n;const i=Array.from(zn(n=this.remoteUserMap).call(n)).find((r=>r._audioSSRC===t));i&&Se.firstRemoteFrame(this.store.sessionId,cn.FIRST_AUDIO_RECEIVED,Mt.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:Fn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,n,i)=>{var r;const s=Array.from(zn(r=this.remoteUserMap).call(r)).find((o=>o._videoSSRC===t));s&&this.store.firstVideoFrameDecoded(s.uid,{firstDecoded:Date.now()}),this.reportVideoFirstFrameDecoded(t,n,i)},e.onFirstVideoRender=t=>{var n;const i=Array.from(zn(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===t));i&&(this.store.firstVideoFrameDecoded(i.uid,{firstPreRender:Date.now()}),this.reportVideoFirstFrameRender(i),this.emit(be.FirstVideoPreRender,i.uid,t))},e.onFirstVideoReceived=t=>{var n;const i=Array.from(zn(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===t));i&&(this.store.firstVideoFrameDecoded(i.uid,{firstReceived:Date.now()}),Se.firstRemoteFrame(this.store.sessionId,cn.FIRST_VIDEO_RECEIVED,Mt.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:Fn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstVideoBufferReady=t=>{var n;const i=Array.from(zn(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===t));i&&this.emit(be.FirstVideoBufferReady,i.uid,t)},e.onSelectedLocalCandidateChanged=(t,n)=>{const i=t.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(be.ConnectionTypeChange,i),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Po(n))," -> ").concat(JSON.stringify(Po(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,n)=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Po(n))," -> ").concat(JSON.stringify(Po(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.getLocalVideoStats=()=>{const t=this.statsCollector.getLocalVideoTrackStats(),n=this.statsCollector.getRTCStats();return Is(Is({},t),n)},e.onICECandidateError=t=>{this._iceError=t}}fallbackConnection(){S.debug("[".concat(this.store.clientId,"] [P2PChannel] try to fallback connection")),this.state===ut.Connected?(S.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&this.resetConnection(this.connection),this.shouldForwardP2PCreation&&(this.connection=Zl(this.store),this.emit(be.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)))}resetConnection(e){e instanceof qi&&(function(t){Cd.delete(t.id),hL(t)})(e),e.close(),this.emit(be.PeerConnectionStateChange,"closed"),(function(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.getLocalVideoStats=void 0})(e),this._isWaitPcToRePub=!1}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const n=this.localTrackMap.get(re.LocalAudioTrack);if(e instanceof Yt&&n?.track instanceof dn)return n.track.isActive||t.push([re.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return e===s}));if(i&&(t.push(i),i[0]===re.LocalVideoTrack)){const r=this.localTrackMap.get(re.LocalVideoLowTrack);r&&t.push([re.LocalVideoLowTrack,r])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(re.LocalAudioTrack);if(e instanceof Yt&&n?.track instanceof dn)return n.track.isActive&&t.push([re.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return e===s}));if(i)if(i[0]===re.LocalVideoTrack){t.push(i);const r=this.localTrackMap.get(re.LocalVideoLowTrack);r&&t.push([re.LocalVideoLowTrack,r])}else t.push(i);return t}createMuteMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case re.LocalAudioTrack:i=_t.Audio;break;case re.LocalVideoTrack:i=ie(n=s._hints).call(n,ht.SCREEN_TRACK)?_t.Screen:_t.High;break;case re.LocalVideoLowTrack:i=_t.Low}return{stream_type:i,ssrcs:o,mid:a}}))}createUnmuteMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case re.LocalAudioTrack:i=_t.Audio;break;case re.LocalVideoTrack:i=ie(n=s._hints).call(n,ht.SCREEN_TRACK)?_t.Screen:_t.High;break;case re.LocalVideoLowTrack:i=_t.Low}return{stream_type:i,ssrcs:o,mid:a}}))}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach((r=>{let[s,o]=r;n.push([e,{kind:s,id:o}])}));return n}filterTobeUnSubscribedDataChannels(e,t){const n=[];return t.forEach((i=>{var r;(r=this.remoteDataChannelMap.get(e))!==null&&r!==void 0&&r.has(i.id)&&n.push(i)})),n}createUnsubscribeMessage(e){const t=[];return e.forEach((n=>{let[i,{kind:r,id:s}]=n;switch(r){case _e.VIDEO:return void(i._videoSSRC&&t.push({stream_type:_e.VIDEO,ssrcId:i._videoSSRC}));case _e.AUDIO:return void(i._audioSSRC&&t.push({stream_type:_e.AUDIO,ssrcId:i._audioSSRC}))}})),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach((n=>{let[i,{kind:r}]=n;if(t.has(i)){let s=t.get(i);r===_e.VIDEO?s|=yn.Video:s|=yn.Audio,t.set(i,s)}else r===_e.VIDEO?t.set(i,yn.Video):t.set(i,yn.Audio)})),{users:Array.from(t.entries()).map((n=>{let[i,r]=n;return{stream_id:i.uid,stream_type:r}}))}}withdrawRemoteTracks(e){e.forEach((t=>{let[n,{kind:i}]=t;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(re.LocalVideoTrack),n=this.localTrackMap.get(re.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new de(((i,r)=>{this.handleUpdateVideoEncoder(t.track,i,r,!0)}))),n&&e.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new de(((i,r)=>{this.handleUpdateVideoEncoder(n.track,i,r,!0)})))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}isPreallocation(){return!(!this.connection||!("name"in this.connection)||this.connection.name!=="DataChannelConnection"||this.connection.peerConnectionState==="closed")||this.connection instanceof qi&&this.connection.isPreallocation}isPreSub(){return(this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof qi)&&this.connection.isPreSub()}isPreRender(){return this.connection instanceof qi&&this.connection.isPreRender}mapPubResToRemoteConfig(e,t,n){return e.map(((i,r)=>{var s;let{stream_type:o}=i;const a=(s=t.find((c=>{let{stream_type:u}=c;return o===u})))===null||s===void 0?void 0:s.attributes;if(a&&I("DISABLE_SCREEN_SHARE_REMB")){const c=n[r]._hints;(ie(c).call(c,ht.SCREEN_TRACK)||ie(c).call(c,ht.SCREEN_LOW_TRACK))&&(a.remb=!1,S.debug("disable remb for screen share, hints:",c))}return a}))}async tryToUnmuteAudio(e){for(let n=0;n<e.length;n++)if(e[n]instanceof Yt){var t;const i=this.filterTobeUnmutedTracks(e[n]);if(i.length===0)continue;await((t=this.connection)===null||t===void 0?void 0:t.unmuteLocal(i.map((s=>{let[,{id:o}]=s;return o}))));const r=this.createUnmuteMessage(i);return void await wt(this,be.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.connection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(be.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(be.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var e;return{connectState:((e=this.connection)===null||e===void 0?void 0:e.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await En(Tp(this.dtlsFailedCount,$t)),this.emit(be.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await sn(this,be.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(be.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(re.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof bt))}throwIfTrackTypeNotMatch(e){if(e.filter((t=>t instanceof bt)).length>1)throw new J(N.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((t=>t instanceof Yt)).length>1&&(e.some((t=>t instanceof Yt&&t._bypassWebAudio))||!Xe().webAudioMediaStreamDest))throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof bt&&this.pendingLocalTracks.some((n=>n instanceof bt)))throw new J(N.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Yt&&this.pendingLocalTracks.some((n=>n instanceof Yt))&&(!Xe().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((n=>n instanceof Yt&&n._bypassWebAudio))))throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){var n;const i=!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding,r=Is(Is({},{width:160,height:120,framerate:15,bitrate:50}),t);let s;s=i?e._mediaStreamTrack.clone():Ry(e,r);const o=mt(8,"track-low-"),a=new bt(s,Is(Is({},i&&{scaleResolutionDownBy:$S(r,e)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return a.on(Oa.TRANSCEIVER_UPDATED,(c=>{e._updateRtpTransceiver(c,id.LOW_STREAM)})),a._hints.push(ht.LOW_STREAM),ie(n=e._hints).call(n,ht.SCREEN_TRACK)&&a._hints.push(ht.SCREEN_LOW_TRACK),e.on("sei-to-send",(c=>{a.emit("sei-to-send",c)})),e.addListener(ye.NEED_CLOSE,(()=>{a.close()})),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof qi){var r,s,o,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:u,dtlsTransportState:p,peerConnectionState:m}=this.connection,{local:_,remote:g}=await this.connection.getSelectedCandidatePair();Se.pcStats(this.store.sessionId,{startTime:c,eventElapse:e-c||0,iceconnectionsate:u,dtlsstate:p,connectionstate:m,intSucc:t?1:2,error:this._iceError||i||"",selectedLocalCandidateProtocol:(r=_?.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(s=_.candidateType)!==null&&s!==void 0?s:"",selectedLocalCandidateAddress:"".concat(_.address,":").concat(_.port),selectedRemoteCandidateProtocol:(o=g.protocol)!==null&&o!==void 0?o:"",selectedRemoteCandidateType:(a=g.candidateType)!==null&&a!==void 0?a:"",selectedRemoteCandidateAddress:"".concat(g.address,":").concat(g.port),restartCnt:n,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameRender(e){const t=this.store.keyMetrics,n=t.firstVideoFrameDecoded.find((p=>p.userId===e.uid));if(!n)return;const{isInternalUpload:i,isExternalUpload:r}=n;if(i&&r)return;const{subscribeEnd:s,firstPreRender:o,peerPublishDuration:a,peerPubStatusMs:c}=n;let{firstRender:u=0}=n;if(s&&(u||o)&&a&&c){n.isInternalUpload=!0;const{playEnd:p}=n;p&&(n.isExternalUpload=!0);const{firstPreRender:m=0}=n;u=m||u;const _=e.videoTrack,g={peer:e._uintid,width:_?._videoWidth||0,height:_?._videoHeight||0,ssrc:e._videoSSRC||0,p2pid:this.store.p2pId,peerPublishDuration:a,peerPubStatusMs:c,joinChannelStart:t.joinStart||0,preloadStart:t.preloadStart||0,preloadEnd:t.preloadEnd||0,apStart:t.requestAPStart||0,apEnd:t.requestAPEnd||0,suaEnd:t.requestSUAEnd||0,beforeConnect:t.beforeConnect||0,peerReceiver:t.peerReceiver||0,ice:t.iceConnectionEnd||0,pc:t.peerConnectionEnd||0,signalConnected:t.signalConnected||0,joinReq:t.joinReq||0,joinRes:t.joinRep||0,userJoinNotify:n.userJoinNotify||0,videoAddNotify:n.videoAddNotify||0,subscribeStart:n.subscribeStart||0,subscribeEnd:n.subscribeEnd||0,firstReceived:n.firstReceived||0,firstDecoded:n.firstDecoded||0,firstPreRender:m||0,firstRender:p?Math.max(u,p):Math.max(u,s),playStart:n.playStart||0,playEnd:n.playEnd||0,isPreSub:!(!e._videoSSRC||!this.isPreSubScribe(e._videoSSRC)),isPrePc:this.isPreallocation(),isPreInstantVideo:MO(this.store),firstReceivedEncodedFrame:n.firstReceivedEncodedFrame||0,frameType:n.frameType||"",rtpTimestamp:n.rtpTimestamp||0,framePayloadType:n.framePayloadType||0,frameDataLength:n.frameDataLength||0,mimeType:n.mimeType||""};Se.firstXLAPeerFirstVideoFrame(this.store.sessionId,g)}}reportVideoFirstFrameDecoded(e,t,n,i){var r;const s=Array.from(zn(r=this.remoteUserMap).call(r)).find((o=>o._videoSSRC===e));if(s){i||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,a=o.subscribe.find((c=>c.userId===s.uid&&c.type==="video"));Se.firstRemoteVideoDecode(this.store.sessionId,cn.FIRST_VIDEO_DECODE,Mt.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:t,videoheight:n,subscribeElapse:Fn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0,firstFrame:a?.firstFrame||0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.connection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const s=await this.connection.getRemoteSSRC(r);return s!==void 0&&s!==n}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:n}]=e;t===re.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,id.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}},le(Qe.prototype,"startP2PConnection",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"startP2PConnection"),Qe.prototype),le(Qe.prototype,"connect",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"connect"),Qe.prototype),le(Qe.prototype,"updateRemoteRTPCapabilities",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"updateRemoteRTPCapabilities"),Qe.prototype),le(Qe.prototype,"publishDataChannel",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"publishDataChannel"),Qe.prototype),le(Qe.prototype,"unpublish",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"unpublish"),Qe.prototype),le(Qe.prototype,"unpublishDataChannel",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"unpublishDataChannel"),Qe.prototype),le(Qe.prototype,"unpublishLowStream",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"unpublishLowStream"),Qe.prototype),le(Qe.prototype,"subscribeDataChannel",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"subscribeDataChannel"),Qe.prototype),le(Qe.prototype,"subscribe",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"subscribe"),Qe.prototype),le(Qe.prototype,"massSubscribe",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"massSubscribe"),Qe.prototype),le(Qe.prototype,"unsubscribe",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"unsubscribe"),Qe.prototype),le(Qe.prototype,"unsubscribeDataChannel",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"unsubscribeDataChannel"),Qe.prototype),le(Qe.prototype,"massUnsubscribe",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"massUnsubscribe"),Qe.prototype),le(Qe.prototype,"muteRemote",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"muteRemote"),Qe.prototype),le(Qe.prototype,"unmuteRemote",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"unmuteRemote"),Qe.prototype),le(Qe.prototype,"hasRemoteMediaWithLock",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"hasRemoteMediaWithLock"),Qe.prototype),le(Qe.prototype,"disconnectForReconnect",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"disconnectForReconnect"),Qe.prototype),le(Qe.prototype,"updateBitrateLimit",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"updateBitrateLimit"),Qe.prototype),le(Qe.prototype,"remoteMediaSsrcChanged",[Qn],Object.getOwnPropertyDescriptor(Qe.prototype,"remoteMediaSsrcChanged"),Qe.prototype),Qe);function Qn(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From P2PChannel.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}function _L(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function gL(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?_L(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_L(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const Aq=Date.now(),Iq=20,wy=new Map,gm=new Map;async function EL(e){const t=wy.get(e),n=Array.isArray(t)&&t[t.length-1],i=gm.get(e);if(!n)return void(i.isSyncing=!1);const r={uid:n.uid,payload:n.payload};i.firstRecvTs===0&&(i.firstRecvTs=n.recvTs,i.firstSendTs=n.sendTs);const s=n.sendTs-i.firstSendTs,o=s-(Date.now()-i.firstRecvTs);o>0&&(i.firstRecvTs=Date.now()-s);let a=n.mediaDelay+o;a<=0?(t.pop(),SL(n.context,r),a=0):a=Math.min(a,Iq),setTimeout((()=>t.length&&EL(e)),a)}function SL(e,t){e.safeEmit(Ye.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function Oq(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return SL(n,{uid:e.uid,payload:e.payload});const i="".concat(n.id,"-").concat(e.uid),r=wy.get(i)||[],s=r.findIndex((u=>e.sendTs>=u.sendTs)),o=gL(gL({},e),{},{context:n,mediaDelay:t,recvTs:Date.now()});s===-1?r.push(o):r.splice(s,0,o),wy.set(i,r);let a=!1;var c;gm.has(i)?a=!((c=gm.get(i))===null||c===void 0||!c.isSyncing):gm.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||EL(i)}const Nq=st().name;function yL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function TL(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?yL(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):yL(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const bd="websdk_ng_cache_parameter",Dq=I("MAX_PRELOAD_ASYNC_LENGTH"),Pq=1e4,Wa=new Map,Ga=[];let Ay=null,Iy=0,Oy=0;const Em=new Map,vL=new Uint8Array([241,141,127,212,103,139,200,225,251,157,127,139,143,2,22,163]),Lq=(function(e,t){const n=[];let i=0;const r=async()=>{const s=n.shift();s&&await s(),n.length>0&&i<t?r():i--};return async function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];return new de((async(c,u)=>{n.push((async()=>{try{const p=await e(...o);c(p)}catch(p){u(p)}})),i<t&&(i++,r())}))}})(Dy,Dq),Ny=ui.CancelToken.source();class kq{constructor(){C(this,"_audioContext",null)}createMuteAudioTrack(){this._audioContext=new AudioContext;const t=this._audioContext.sampleRate,n=10*t,i=this._audioContext.createBuffer(2,n,t),r=this._audioContext.createBufferSource();r.buffer=i;const s=this._audioContext.createMediaStreamDestination();return r.connect(s),r.start(),s.stream.getAudioTracks()[0]}close(){this._audioContext&&(this._audioContext.close(),this._audioContext=null)}}async function Dy(e,t,n,i,r,s,o){try{if(!I("ENABLE_PRELOAD"))return;if(!Xe().supportWebCrypto)return void wo((()=>{S.warn("Your browser does not support preloading, this feature  be run in a secure environment")}),"preload_webcrypto_not_supported");if(!n&&n!==null)throw new J(N.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&Nn(n,"token",1,2047),Nn(e,"appid",1,2047),zp(t),i&&qp(i);const a=ba();S.debug("preload channel ".concat(t,", uid is ").concat(i));const c={appId:e,cname:t,token:n||e,uid:typeof i!="string"?i:null,sid:a,proxyServer:r,role:o};let u,p;typeof i=="string"?(c.stringUid=i,[p,u]=await de.all([fq(i,{sid:a,appId:e},Ny.token),YP(TL(TL({},c),{},{token:n||e,uid:0}),Ny.token)]),c.uid=p.uid,u.gatewayInfo.uid=c.uid,u.gatewayInfo.res.uid=c.uid):(s&&(c.stringUid=s),u=await YP(c,Ny.token));const m={sid:a,appId:e,cname:t,token:n||e,uid:c.stringUid||i,intUid:c.uid||u.gatewayInfo.uid,stringUid:c.stringUid,ts:Date.now(),sua:p,ap:u};await Ly(m),Iy++}catch(a){throw Oy++,(function(c){Ay||(Ay=window.setTimeout((()=>{let p="";Em.forEach(((m,_)=>{p+="".concat(_,": ").concat(m," ;")})),Se.reportApiInvoke(null,{name:xt.PRELOAD,options:{success:Iy,failed:Oy,err:p}}).onError(c),Iy=0,Oy=0,Em.clear(),Ay=null}),Pq));const u=Em.get(c.code)||0;Em.set(c.code,u+1)})(a),a}}async function Py(e){try{if(I("AP_REQUEST_DETAIL")||I("ENABLE_ROLE_SELECT_EDGE"))return;const t=RL(e);if(!t||e.cloudProxyServer!=="disabled")return;const n=await(async function(i,r){try{const s=await window.crypto.subtle.importKey("raw",lO(r),"AES-GCM",!1,["decrypt"]),o=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:vL},s,Ca(i));return JSON.parse(window.atob(Ao(new Uint8Array(o))))}catch{return}})(t,e.token||e.appId);if(!n||!(function(i,r){return i.cname===r.cname&&i.appId===r.appId&&i.token===r.token?r.stringUid?i.stringUid===r.stringUid:typeof r.uid=="number"?i.uid===r.uid:i.uid==r.uid:!1})(n,e))return;if(n&&Date.now()-n.ts<I("AP_CACHE_LIFETIME"))return n}catch(t){S.warn("Error get preloadInfo",t.message)}}function RL(e){let t;try{if(t=wL(bd),!t)return;const n=JSON.parse(t),i=AL(e),r=(function(o,a){for(let c=o.length-1;c>=0;c--)if(a(o[c]))return c;return-1})(n,(o=>i in o));if(r===-1)return;const s=n.splice(r,1)[0];return Sm(bd,JSON.stringify(n)),s[i]}catch(n){S.warn("Error delete preload info: ".concat(t),n.message),Sm(bd,"")}}async function Ly(e){let t;try{e.uid&&RL({appId:e.appId,cname:e.cname,token:e.token,uid:e.uid,stringUid:e.stringUid});const n=AL(e),i=await(async function(s,o){try{const a=await window.crypto.subtle.importKey("raw",lO(o),"AES-GCM",!1,["encrypt"]),c=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:vL},a,Ca(window.btoa(JSON.stringify(s))));return Ao(new Uint8Array(c))}catch{return}})(e,e.token||e.appId);if(!i)return;t=wL(bd);const r=t?JSON.parse(t):[];r.push({[n]:i}),r.length>I("AP_CACHE_NUM")&&r.shift(),Sm(bd,JSON.stringify(r))}catch(n){S.warn("Error caching server parameters:",n.message),Sm(bd,"")}}function ky(e){if(e){let t=Wa.get(e);t&&(window.clearTimeout(t),t=null,Wa.delete(e)),ie(Ga).call(Ga,e)||e.cloudProxyServer!=="disabled"||Ga.push(e)}if(Wa.size<I("AP_CACHE_NUM")&&Ga.length>0){const t=Ga.shift();Wa.set(t,window.setTimeout((async()=>{const{appId:n,cname:i,token:r,stringUid:s,uid:o,proxyServer:a,role:c}=t;try{await Lq(n,i,r,o,a,s,c),Wa.has(t)&&ky(t)}catch(u){S.warn("update preload failed",u.message),CL(t)}}),I("AP_UPDATE_INTERVAL")))}}function CL(e){const t=Ga.indexOf(e);t!==-1&&Ga.splice(t,1);let n=Wa.get(e);n&&(window.clearTimeout(n),n=null,Wa.delete(e),ky())}function bL(e,t){const n=e.sua,i=e.ap;t&&n&&Se.reqUserAccount(e.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:t,uid:e.intUid,errorCode:null,extend:n.req}),Se.reportResourceTiming(e.ap.url,e.sid),Se.joinWebProxyAP(e.sid,{lts:i.requestTime,elapse:i.elapse,sucess:1,apServerAddr:i.url,turnServerAddrList:i.proxyInfo.addresses.map((r=>r.ip)).join(","),eventType:"disabled",unilbsServerIds:[en.CHOOSE_SERVER,en.CLOUD_PROXY_FALLBACK].toString()}),Se.joinChooseServer(e.sid,{lts:i.requestTime,elapse:i.elapse,succ:!0,csAddr:i.url,opid:i.opid,serverList:i.gatewayInfo.gatewayAddrs.map((r=>r.address)),ec:null,cid:i.gatewayInfo.cid.toString(),uid:i.gatewayInfo.uid.toString(),csIp:i.gatewayInfo.csIp,unilbsServerIds:[en.CHOOSE_SERVER].toString(),isHttp3:i.isHttp3})}function wL(e){return window.atob(window.localStorage.getItem(e)||"")}function Sm(e,t){window.localStorage.setItem(e,window.btoa(t))}function AL(e){let t="".concat(e.appId,"_").concat(e.cname);return typeof e.uid=="string"&&(t+="_s_".concat(e.uid)),typeof e.uid=="number"&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),gO(t)}function xq(e){let t=(function(){const n=Vq.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}})();return(function(n,i){let r=n.appId;r!==void 0&&(tn(i,10),Mo(i,r));let s=n.cid;s!==void 0&&(tn(i,16),tn(i,s));let o=n.cname;o!==void 0&&(tn(i,26),Mo(i,o));let a=n.deviceId;a!==void 0&&(tn(i,34),Mo(i,a));let c=n.elapse;c!==void 0&&(tn(i,40),Uo(i,c));let u=n.fileSize;u!==void 0&&(tn(i,48),Uo(i,wd(u)));let p=n.height;p!==void 0&&(tn(i,56),Uo(i,wd(p)));let m=n.jpg;m!==void 0&&(tn(i,66),tn(i,m.length),OL(i,m));let _=n.networkType;_!==void 0&&(tn(i,72),Uo(i,wd(_)));let g=n.osType;g!==void 0&&(tn(i,80),Uo(i,wd(g)));let b=n.requestId;b!==void 0&&(tn(i,90),Mo(i,b));let v=n.sdkVersion;v!==void 0&&(tn(i,98),Mo(i,v));let R=n.sequence;R!==void 0&&(tn(i,104),Uo(i,wd(R)));let O=n.sid;O!==void 0&&(tn(i,114),Mo(i,O));let D=n.timestamp;D!==void 0&&(tn(i,120),Uo(i,D));let x=n.uid;x!==void 0&&(tn(i,128),tn(i,x));let B=n.vid;B!==void 0&&(tn(i,136),tn(i,B));let G=n.width;G!==void 0&&(tn(i,144),Uo(i,wd(G)));let j=n.service;j!==void 0&&(tn(i,152),tn(i,j));let H=n.callbackData;H!==void 0&&(tn(i,162),tn(i,H.length),OL(i,H));let Z=n.ticket;Z!==void 0&&(tn(i,170),Mo(i,Z));let ne=n.vendorConfigs;ne!==void 0&&(tn(i,178),Mo(i,ne))})(e,t),(function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)})(t)}function Mq(e){return(function(n){let i={};e:for(;!jq(n);){let r=eu(n);switch(r>>>3){case 0:break e;case 1:i.code=eu(n);break;case 2:i.msg=NL(n,eu(n));break;case 3:i.requestId=NL(n,eu(n));break;case 4:i.timestamp=Fq(n,!1);break;default:Uq(n,7&r)}}return i})({bytes:t=e,offset:0,limit:t.length});var t}function Uq(e,t){switch(t){case 0:for(;128&Nr(e););break;case 2:xy(e,eu(e));break;case 5:xy(e,4);break;case 1:xy(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function wd(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let Vq=[];function xy(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function jq(e){return e.offset>=e.limit}function ym(e,t){let n=e.bytes,i=e.offset,r=e.limit,s=i+t;if(s>n.length){let o=new Uint8Array(2*s);o.set(n),e.bytes=o}return e.offset=s,s>r&&(e.limit=s),i}function IL(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function OL(e,t){let n=ym(e,t.length);e.bytes.set(t,n)}function NL(e,t){let n=IL(e,t),i=String.fromCharCode,r=e.bytes,s="",o="";for(let a=0;a<t;a++){let c,u,p,m,_=r[a+n];(128&_)==0?o+=i(_):(224&_)==192?a+1>=t?o+=s:(c=r[a+n+1],(192&c)!=128?o+=s:(m=(31&_)<<6|63&c,m<128?o+=s:(o+=i(m),a++))):(240&_)==224?a+2>=t?o+=s:(c=r[a+n+1],u=r[a+n+2],(49344&(c|u<<8))!=32896?o+=s:(m=(15&_)<<12|(63&c)<<6|63&u,m<2048||m>=55296&&m<=57343?o+=s:(o+=i(m),a+=2))):(248&_)==240?a+3>=t?o+=s:(c=r[a+n+1],u=r[a+n+2],p=r[a+n+3],(12632256&(c|u<<8|p<<16))!=8421504?o+=s:(m=(7&_)<<18|(63&c)<<12|(63&u)<<6|63&p,m<65536||m>1114111?o+=s:(m-=65536,o+=i(55296+(m>>10),56320+(1023&m)),a+=3))):o+=s}return o}function Mo(e,t){let n=t.length,i=0;for(let o=0;o<n;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+t.charCodeAt(++o)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}tn(e,i);let r=ym(e,i),s=e.bytes;for(let o=0;o<n;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+t.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function Nr(e){return e.bytes[IL(e,1)]}function DL(e,t){let n=ym(e,1);e.bytes[n]=t}function eu(e){let t,n=0,i=0;do t=Nr(e),n<32&&(i|=(127&t)<<n),n+=7;while(128&t);return i}function tn(e,t){for(t>>>=0;t>=128;)DL(e,127&t|128),t>>>=7;DL(e,t)}function Fq(e,t){let n,i=0,r=0,s=0;return n=Nr(e),i=127&n,128&n&&(n=Nr(e),i|=(127&n)<<7,128&n&&(n=Nr(e),i|=(127&n)<<14,128&n&&(n=Nr(e),i|=(127&n)<<21,128&n&&(n=Nr(e),r=127&n,128&n&&(n=Nr(e),r|=(127&n)<<7,128&n&&(n=Nr(e),r|=(127&n)<<14,128&n&&(n=Nr(e),r|=(127&n)<<21,128&n&&(n=Nr(e),s=127&n,128&n&&(n=Nr(e),s|=(127&n)<<7))))))))),{low:i|r<<28,high:r>>>4|s<<24,unsigned:t}}function Uo(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,s=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,o=ym(e,s),a=e.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?i>>>21|128:i>>>21&127;case 7:a[o+6]=s!==7?i>>>14|128:i>>>14&127;case 6:a[o+5]=s!==6?i>>>7|128:i>>>7&127;case 5:a[o+4]=s!==5?128|i:127&i;case 4:a[o+3]=s!==4?n>>>21|128:n>>>21&127;case 3:a[o+2]=s!==3?n>>>14|128:n>>>14&127;case 2:a[o+1]=s!==2?n>>>7|128:n>>>7&127;case 1:a[o]=s!==1?128|n:127&n}}const PL={},LL={},Tm=4294967296,Bq=Tm*Tm,kL=Bq/2;ML(0,!0);const xL=ML(0),Wq=tu(0,-2147483648,!1),Gq=tu(-1,2147483647,!1);function ML(e,t){let n,i,r;return t?(r=0<=(e>>>=0)&&e<256)&&(i=LL[e],i)?i:(n=tu(e,0,!0),r&&(LL[e]=n),n):(r=-128<=(e|=0)&&e<128)&&(i=PL[e],i)?i:(n=tu(e,e<0?-1:0,!1),r&&(PL[e]=n),n)}function tu(e,t,n){return{low:0|e,high:0|t,unsigned:!!n}}function UL(e,t){if(isNaN(e))return xL;{if(e<=-kL)return Wq;if(e+1>=kL)return Gq}return e<0?xL:tu(e%Tm|0,e/Tm|0,t)}function VL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}class My extends Vt{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const n=this._connectionState;this._connectionState=t,this.emit(Qr.CONNECTION_STATE_CHANGE,t,n)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this._qualityRatio}),6e4))}constructor(t){var n;super(),C(this,"name","AgoraRTCImageModeration"),C(this,"_connectionState",or.CONNECTING),C(this,"_sequence",0),C(this,"_moderationStartTime",void 0),C(this,"_workerConnection",void 0),C(this,"_workerMessageLengthLimit",void 0),C(this,"_qualityRatio",void 0),C(this,"_connectInfo",void 0),C(this,"_cancelTokenSource",ui.CancelToken.source()),C(this,"_retryConfig",void 0),C(this,"_moderationInterval",void 0),C(this,"_moderationTimer",null),C(this,"_moderationMode",1),C(this,"_quality",1),C(this,"_qualityTimer",null),C(this,"_ticket",void 0),C(this,"_moderationIntervalMinimum",void 0),C(this,"_uploadFailedNum",0),C(this,"_uploadNum",0),C(this,"_uploadTimer",null),C(this,"_extraInfo",void 0),C(this,"_vendor",""),C(this,"_encoder",new TextEncoder),C(this,"_moderationId",void 0),C(this,"inspectImage",(()=>{if(this.connectionState!==or.CONNECTED)throw new Y(N.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval((()=>{this.connectionState===or.CONNECTED?this.requestToInspectImage():S.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)}),this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()})),this._moderationId=mt(5,"image-moderation-"),this._workerMessageLengthLimit=I("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=I("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=t.interval)!==null&&n!==void 0?n:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=I("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Wl("worker-"+this._moderationId,$t),this.on(Qr.STATE_CHANGE,((i,r)=>{S.debug("[".concat(this._moderationId,"] Moderation operation :").concat(md[i]," ").concat(r||""))})),this.handleWorkerEvents()}async init(t,n){this.emit(Qr.STATE_CHANGE,md.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=n,new de(((r,s)=>{this.on(Qr.CONNECTION_STATE_CHANGE,((o,a)=>{o===or.CONNECTED&&r()})),this.requestAP(t,i,n).then((o=>{this.connectWorker(o)})).catch((o=>{s(o)}))}))}updateConfig(t){var n;this._moderationInterval=(n=t.interval)!==null&&n!==void 0?n:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),S.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===or.CONNECTED&&this.inspectImage()}async requestAP(t,n,i){const r=I("WEBCS_DOMAIN").map((c=>"https://".concat(c,"/api/v1"))),s=await(function(c,u,p,m){let{appId:_,areaCode:g,cname:b,sid:v,token:R,uid:O}=u;Sd++;const D="moderation_plugin",x={service_name:D,json_body:JSON.stringify({appId:_,areaCode:g,cname:b,command:"allocateEdge",requestId:Sd,seq:Sd,sid:v,appToken:R,ts:Date.now(),uid:O+""})};let B,G,j=c[0];return zr((async()=>{B=Date.now();const H=await $r(j,{data:x,cancelToken:p,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(G=Date.now()-B,H.code!==0){const Oe=new Y(N.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+H.code,{retry:!0,responseTime:G});throw S.error(Oe.toString()),Oe}const Z=JSON.parse(H.json_body);if(Z.code!==200){const Oe=new Y(N.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(Z.code,", reason: ").concat(Z.reason),{code:Z.code,responseTime:G});throw S.error(Oe.toString()),Oe}if(!Z.servers||!Array.isArray(Z.servers)||Z.servers.length===0){const Oe=new Y(N.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:Z.code,responseTime:G});throw S.error(Oe.toString()),Oe}if(!Z.servers.some((Oe=>!!Oe.wss))){const Oe=new Y(N.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:Z.code,responseTime:G});throw S.error(Oe.toString()),Oe}const ne=I("IMAGE_MODERATION_WORKER_WSS");if(ne)return{addressList:[ne],workerToken:Z.workerToken,vid:Z.vid,responseTime:G};const he=I("IMAGE_MODERATION_WORKER_HOST");return{addressList:Z.servers.map((Oe=>{let{address:Ge,wss:Ue}=Oe;if(Ge&&Ue)return"wss://".concat(Ge.replace(/\./g,"-"),".").concat(he,":").concat(Ue,"/moderation")})).filter((Oe=>!!Oe)),workerToken:Z.workerToken,vid:Z.vid,ticket:Z.appTicket,responseTime:G}}),((H,Z)=>(Se.apworkerEvent(v,{success:!0,sc:200,serviceName:D,responseDetail:JSON.stringify(H.addressList),firstSuccess:Z===0,responseTime:G,serverIp:c[Z%c.length]}),!1)),((H,Z)=>(Se.apworkerEvent(v,{success:!1,sc:H.data&&H.data.code||200,serviceName:D,responseTime:G,serverIp:c[Z%c.length]}),!!(H.code!==N.OPERATION_ABORTED&&H.code!==N.UNEXPECTED_RESPONSE||H.data&&H.data.retry)&&(j=c[(Z+1)%c.length],!0))),m)})(r,t,n,i);this.emit(Qr.STATE_CHANGE,md.AP_CONNECTED);const{addressList:o,ticket:a}=s;return this._ticket=a,o}async connectWorker(t){this.emit(Qr.STATE_CHANGE,md.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(Ve.CONNECTED,(async()=>{this.emit(Qr.STATE_CHANGE,md.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=or.CONNECTED})),this._workerConnection.on(Ve.CLOSED,(()=>{this.connectionState=or.CLOSED})),this._workerConnection.on(Ve.FAILED,(()=>{this.connectionState=or.CLOSED})),this._workerConnection.on(Ve.RECONNECTING,(()=>{this.connectionState=this.connectionState===or.CONNECTED?or.RECONNECTING:or.CONNECTING})),this._workerConnection.on(Ve.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const n=Mq(new Uint8Array(t.data));I("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&S.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,S.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout((()=>{Se.reportApiInvoke(this._connectInfo.sid||null,{name:xt.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:Ct.TRACER}).onError(new Y(N.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null}),I("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else S.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(Ve.WILL_RECONNECT,((t,n,i)=>{t==="recover"&&i(t),i("tryNext")})),this._workerConnection.on(Ve.REQUEST_NEW_URLS,((t,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(n)}))}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=Di(this,Qr.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(I("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&S.debug("Only the track being played can be inspected"));this._sequence++;const i=await this.generateRequestData(t,n);this._workerConnection.sendMessage(i,!0,!0)}else I("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&S.debug("Only the track being published can be inspected")}async generateRequestData(t,n){let{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c}=n;const u=Date.now(),p=await t.getCurrentFrameImage("image/jpeg",this.quality),m=await cN(p,i,r),_=this._sequence+"-"+s+"-"+c+"-"+u+"-"+mt(12,""),g={appId:i,cid:s,cname:r,deviceId:"",elapse:My.intToLong(Number(u-this._moderationStartTime)),fileSize:p.buffer.byteLength,height:p.height,width:p.width,jpg:m,networkType:6,osType:7,requestId:_,sdkVersion:"4.24.2",sequence:this._sequence,sid:a,timestamp:UL(u),uid:c,vid:o,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete g.callbackData;const b=xq(g);if(b.byteLength<this._workerMessageLengthLimit){if(I("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const v=(function(R){for(var O=1;O<arguments.length;O++){var D=arguments[O]!=null?arguments[O]:{};O%2?VL(Object(D),!0).forEach((function(x){C(R,x,D[x])})):Object.getOwnPropertyDescriptors?Object.defineProperties(R,Object.getOwnPropertyDescriptors(D)):VL(Object(D)).forEach((function(x){Object.defineProperty(R,x,Object.getOwnPropertyDescriptor(D,x))}))}return R})({},g);delete v.jpg,S.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(v))}return b}{const v=this.quality*this._qualityRatio;return this.quality=v,await this.generateRequestData(t,{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ui.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=or.CLOSED,this.emit(Qr.STATE_CHANGE,md.CLOSED)}}function jL(e){if(Rt(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new Y(N.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(e&&e.vendor&&e.vendor.length>1024)throw new Y(N.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const Hq={name:"ImageModeration",create:function(e){let{config:t}=e;return jL(t),new My(t)}};var FL,BL,WL,GL,HL,KL,YL,zL,qL,XL,JL,QL,ZL,$L,ek,tk,nk,ik,rk,sk,ok,ak,ck,dk,lk,uk,hk,pk,mk,fk,_k,gk,Ek,Sk,yk,Tk,vk,Rk,Ck,bk,wk,Ak,me;function Ik(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Dr(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?Ik(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ik(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}Cn.setLogger(S);let Kq=(FL=Ae(),BL=Ae({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof od))return[t];t=[t]}return t.map((n=>n?Object(n).toString():"null"))}}),WL=Ae({argsMap:(e,t)=>(t||(t=[]),Array.isArray(t)||t.trackMediaType!==sd.DATA?(Array.isArray(t)||(t=[t]),t.map((n=>n.getTrackId()))):[t.getChannelId()])}),GL=Ae({argsMap:(e,t,n,i)=>[typeof t=="object"?t.uid:t,n,i]}),HL=Ae({argsMap:(e,t,n)=>[t,n]}),KL=Ae({argsMap:(e,t)=>t.map((n=>{let{user:i,mediaType:r}=n;return[i?.uid,r]}))}),YL=Ae({argsMap:(e,t,n,i)=>[typeof t=="object"?t.uid:t,n,i]}),zL=Ae({argsMap:(e,t)=>t.map((n=>{let{user:i,mediaType:r}=n;return{uid:i?.uid,mediaType:r}}))}),qL=Ae(),XL=Ae(),JL=Ae(),QL=Ae(),ZL=Ae(),$L=Ae(),ek=Ae(),tk=Ae(),nk=Ae(),ik=Ae(),rk=Ae(),sk=Ae(),ok=Ae(),ak=Ae(),ck=Ae(),dk=Ae(),lk=Ae({argsMap:(e,t)=>[t]}),uk=Ae(),hk=Ae(),pk=Ae(),mk=Ae(),fk=Ae(),_k=Ae(),gk=Ae(),Ek=Ae(),Sk=Ae({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),yk=Ae(),Tk=Ae(),vk=Ae(),Rk=Ae(),Ck=Ae(),bk=Ae(),wk=Ae({reportResult:!0}),Ak=Ae(),me=class extends Vt{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e,t){let n;if(super(),C(this,"store",void 0),C(this,"_uid",void 0),C(this,"_channelName",void 0),C(this,"_uintUid",void 0),C(this,"_users",[]),C(this,"_config",void 0),C(this,"_clientId",void 0),C(this,"_appId",void 0),C(this,"_sessionId",null),C(this,"_key",void 0),C(this,"_rtmConfig",{}),C(this,"_joinInfo",void 0),C(this,"_gateway",void 0),C(this,"_statsCollector",void 0),C(this,"_configDistribute",void 0),C(this,"_leaveMutex",void 0),C(this,"_publishMutex",void 0),C(this,"_renewTokenMutex",void 0),C(this,"_subscribeMutex",void 0),C(this,"_encryptionMode","none"),C(this,"_encryptionSecret",null),C(this,"_encryptionSalt",null),C(this,"_encryptDataStream",!1),C(this,"_encryptDataStreamKey",null),C(this,"_encryptDataStreamIv",null),C(this,"_proxyServer",void 0),C(this,"_turnServer",{servers:[],mode:"auto"}),C(this,"_cloudProxyServerMode","disabled"),C(this,"_isDualStreamEnabled",!1),C(this,"_defaultStreamFallbackType",void 0),C(this,"_lowStreamParameter",void 0),C(this,"_streamFallbackTypeCacheMap",new Map),C(this,"_remoteStreamTypeCacheMap",new Map),C(this,"_axiosCancelSource",ui.CancelToken.source()),C(this,"_audioVolumeIndicationInterval",void 0),C(this,"_networkQualityInterval",void 0),C(this,"_userOfflineTimeout",void 0),C(this,"_streamRemovedTimeout",void 0),C(this,"_rteDetailInterval",void 0),C(this,"_liveTranscodeStreamingClient",void 0),C(this,"_liveRawStreamingClient",void 0),C(this,"_channelMediaRelayClient",void 0),C(this,"_networkQualitySensitivity","normal"),C(this,"_p2pChannel",void 0),C(this,"_useLocalAccessPoint",!1),C(this,"_setLocalAPVersion",void 0),C(this,"_joinAndNotLeaveYet",!1),C(this,"_numberOfJoinCount",0),C(this,"_joinResponse",null),C(this,"_remoteDefaultVideoStreamType",void 0),C(this,"_inspect",void 0),C(this,"_moderation",void 0),C(this,"_license",void 0),C(this,"_pendingPublishedUsers",[]),C(this,"ntpAlignErrorCount",0),C(this,"remoteInboundOffset",0),C(this,"_peerConnectionState",void 0),C(this,"_pendingRtpCapabilityChange",void 0),C(this,"_fallbackServerInfo",void 0),C(this,"_dualStreamMode",void 0),C(this,"_handleLocalTrackEnable",((r,s,o)=>{this.publish(r,!1).then(s).catch(o)})),C(this,"_handleLocalTrackDisable",((r,s,o)=>{this.unpublish(r).then(s).catch(o)})),C(this,"_handleUserOnline",(r=>{if(I("BLOCK_LOCAL_CLIENT")&&xa(r.uid,this.channelName))return void S.debug("[".concat(r.uid,"] will be ignored in local"));this.isStringUID&&typeof r.uid!="string"&&S.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const s=this._users.find((o=>o.uid===r.uid));if(s)s._trust_in_room_=!0,s._is_pre_created&&(s._is_pre_created=!1,this.safeEmit(Ye.USER_JOINED,s));else{const o=new ko(r.uid,r.uint_id||r.uid);this._users.push(o),S.debug("[".concat(this._clientId,"] user online"),r.uid),this.store.firstVideoFrameDecoded(o.uid,{userJoinNotify:Date.now()}),this.safeEmit(Ye.USER_JOINED,o)}})),C(this,"_handleUserOffline",(r=>{if(I("BLOCK_LOCAL_CLIENT")&&xa(r.uid,this.channelName))return;const s=this._users.find((o=>o.uid===r.uid));s&&(this._handleRemoveStream(r),this._handleRemoveDataChannels(r),s._audio_pre_subscribed||s._video_pre_subscribed?s._is_pre_created=!0:Sp(this._users,s),this._remoteStreamTypeCacheMap.delete(s.uid),this._streamFallbackTypeCacheMap.delete(s.uid),S.debug("[".concat(this._clientId,"] user offline"),r.uid,"reason:",r.reason),this.safeEmit(Ye.USER_LEAVED,s,r.reason))})),C(this,"_handleAddAudioOrVideoStream",((r,s,o,a,c,u,p,m)=>{if(I("BLOCK_LOCAL_CLIENT")&&xa(s,this.channelName))return;const _=this._users.find((v=>v.uid===s));if(!_)return void S.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));S.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(r)),this.store.subscribe(_.uid,r,void 0,void 0,void 0,Date.now()),r==="video"&&this.store.firstVideoFrameDecoded(_.uid,{videoAddNotify:Date.now()});const g=r==="audio"?_.hasAudio:_.hasVideo;_._uintid||(_._uintid=u||s),r==="audio"?_._trust_audio_stream_added_state_=!0:_._trust_video_stream_added_state_=!0,r==="audio"?(_._audio_added_=!0,o!==void 0&&(_._audioSSRC=o),a!==void 0&&(_._cname=a),p&&(_._audioOrtc=p)):(_._video_added_=!0,o!==void 0&&(_._videoSSRC=o),a!==void 0&&(_._cname=a),m!==void 0&&(_._rtxSsrcId=m),p&&(_._videoOrtc=p)),(r==="audio"?_.hasAudio:_.hasVideo)&&!g&&(S.info("[".concat(this._clientId,"] remote user ").concat(_.uid," published ").concat(r)),this.safeEmit(Ye.USER_PUBLISHED,_,r)),r==="video"?Se.onGatewayStream(this._sessionId,cn.ON_ADD_VIDEO_STREAM,Mt.ON_ADD_VIDEO_STREAM,{peer:u||s,ssrc:_._videoSSRC}):Se.onGatewayStream(this._sessionId,cn.ON_ADD_AUDIO_STREAM,Mt.ON_ADD_AUDIO_STREAM,{peer:u||s,ssrc:_._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(_,r,o).then((v=>{if(v&&(S.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(_.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Ba))return this._p2pChannel.unsubscribe(_,r,!0).then((()=>this._subscribe(_,r,!0).catch((R=>{S.error("[".concat(this._clientId,"] resubscribe error"),R.toString())}))))})),this._p2pChannel.hasPendingRemoteMedia(_,r)&&(S.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(_.uid," after reconnect.")),this._subscribe(_,r,!0).catch((v=>{S.error("[".concat(this._clientId,"] resubscribe error"),v.toString())})));const b=this._getEncodingName(c);r==="video"&&(b==="unknown"?this.safeEmit(Ye.AV1_DECODABLE_RESULT,!1):Rn()||Yn()||b?.toLocaleLowerCase()!==Aa.av1||mq().then((v=>{I("FLS_ENABLE_AV1_DECODE_DETECT")&&this.safeEmit(Ye.AV1_DECODABLE_RESULT,v),v||this._gateway.downgradeCodec(b)})))})),C(this,"_handleRemoveStream",(r=>{if(I("BLOCK_LOCAL_CLIENT")&&xa(r.uid,this.channelName))return;const s=this._users.find((a=>a.uid===r.uid));if(!s)return void S.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));S.debug("[".concat(this._clientId,"] stream removed with uid ").concat(r.uid));let o=()=>{};s.hasAudio&&s.hasVideo?o=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(Ye.USER_UNPUBLISHED,s,"audio"),S.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(Ye.USER_UNPUBLISHED,s,"video")}:s.hasVideo?o=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished video track")),this.safeEmit(Ye.USER_UNPUBLISHED,s,"video")}:s.hasAudio&&(o=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(s.uid," unpublished audio track")),this.safeEmit(Ye.USER_UNPUBLISHED,s,"audio")}),s._video_pre_subscribed||s._audio_pre_subscribed||(s._trust_audio_stream_added_state_=!0,s._trust_video_stream_added_state_=!0,s._audio_added_=!1,s._video_added_=!1,this._p2pChannel instanceof Ba&&this._p2pChannel.unsubscribe(s).then((a=>{if(a)return this._gateway.unsubscribe(a,s.uid)})),s._audioSSRC=void 0,s._videoSSRC=void 0,s._audioOrtc=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),Se.onGatewayStream(this._sessionId,cn.ON_REMOVE_STREAM,Mt.ON_REMOVE_STREAM,{peer:r.uint_id||r.uid}),o()})),C(this,"_handleSetStreamLocalEnable",((r,s,o)=>{if(I("BLOCK_LOCAL_CLIENT")&&xa(s,this.channelName))return;const a=this._users.find((p=>p.uid===s));if(!a)return void S.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));S.debug("[".concat(this._clientId,"] local ").concat(r," ").concat(o?"enabled":"disabled"," with uid ").concat(s));const c=r==="audio"?a.hasAudio:a.hasVideo;if(r==="audio"){a._trust_audio_enabled_state_=!0;const p=a._audio_enabled_;if(a._audio_enabled_=o,a._audio_enabled_===p)return;{const m=a._audio_enabled_?"enable-local-audio":"disable-local-audio";S.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(s,", msg: ").concat(m)),this.safeEmit(Ye.USER_INFO_UPDATED,s,m)}}else{a._trust_video_enabled_state_=!0;const p=a._video_enabled_;if(a._video_enabled_=o,a._video_enabled_===p)return;{const m=a._video_enabled_?"enable-local-video":"disable-local-video";S.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(s,", msg: ").concat(m)),this.safeEmit(Ye.USER_INFO_UPDATED,s,m)}}const u=r==="audio"?a.hasAudio:a.hasVideo;return c!==u?!c&&u?(S.info("[".concat(this._clientId,"] remote user ").concat(s," published ").concat(r)),void this.safeEmit(Ye.USER_PUBLISHED,a,r)):(r==="video"&&a._videoTrack&&a._videoTrack._destroy(),r==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,r),S.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished ").concat(r)),void this.safeEmit(Ye.USER_UNPUBLISHED,a,r)):void 0})),C(this,"_handleMuteStream",((r,s,o)=>{if(I("BLOCK_LOCAL_CLIENT")&&xa(r,this.channelName))return;S.debug("[".concat(this._clientId,"] receive mute message"),r,s,o);const a=this._users.find((p=>p.uid===r));if(!a)return void S.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r));const c=s==="audio"?a.hasAudio:a.hasVideo;if(s==="audio"){a._trust_audio_mute_state_=!0;const p=a._audio_muted_;if(a._audio_muted_=o,a._audio_muted_===p)return;{const m=a._audio_muted_?"mute-audio":"unmute-audio";S.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(m)),this.safeEmit(Ye.USER_INFO_UPDATED,r,m)}}else{a._trust_video_mute_state_=!0;const p=a._video_muted_;if(a._video_muted_=o,a._video_muted_===p)return;{const m=a._video_muted_?"mute-video":"unmute-video";S.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(m)),this.safeEmit(Ye.USER_INFO_UPDATED,r,m)}}const u=s==="audio"?a.hasAudio:a.hasVideo;if(c!==u){if(!c&&u)return(s==="audio"?a._audioSSRC:a._videoSSRC)?(S.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(s)),void this.safeEmit(Ye.USER_PUBLISHED,a,s)):void S.warning("[".concat(this._clientId,"] remote user ").concat(r," receive ").concat(s," unmute message  before add stream message, ").concat(s," SSRC doesn't exist yet."));s==="video"&&a._videoTrack&&!a._video_pre_subscribed&&a._videoTrack._destroy(),s==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,s),S.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(s)),this.safeEmit(Ye.USER_UNPUBLISHED,a,s)}})),C(this,"_handleP2PLost",(async r=>{S.debug("[".concat(this._clientId,"] receive p2p lost"),r),parseInt(r.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():S.warning("[".concat(this._clientId,"] P2PLost stream not found"),r)})),C(this,"_handleTokenWillExpire",(()=>{S.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Ye.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)})),C(this,"_handleBeforeUnload",(r=>{r.type==="beforeunload"&&r.returnValue!==void 0&&r.returnValue!==""||(this.leave(),S.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))})),C(this,"_handleUpdateNetworkQuality",(()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(Ye.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const r={downlinkNetworkQuality:0,uplinkNetworkQuality:0};r.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),r.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Ye.NETWORK_QUALITY,r)})),C(this,"_handleP2PAddAudioOrVideoStream",((r,s,o,a)=>{const c=this._users.find((p=>p.uid===s));if(!c)return void S.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));S.debug("[".concat(this._clientId,"] stream added with uid ").concat(s,", type ").concat(r)),this.store.subscribe(c.uid,r,void 0,void 0,void 0,Date.now());const u=r==="audio"?c.hasAudio:c.hasVideo;r==="audio"?c._trust_audio_stream_added_state_=!0:c._trust_video_stream_added_state_=!0,r==="audio"?(c._audio_added_=!0,o!==void 0&&(c._audioSSRC=o),a!==void 0&&(c._audioMid=a)):(c._video_added_=!0,o!==void 0&&(c._videoSSRC=o),a!==void 0&&(c._videoMid=a)),(r==="audio"?c.hasAudio:c.hasVideo)&&!u&&(S.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published ").concat(r)),this.safeEmit(Ye.USER_PUBLISHED,c,r)),this._p2pChannel.hasPendingRemoteMedia(c,r)&&(S.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(c.uid," after reconnect.")),this._subscribe(c,r,!0).catch((p=>{S.error("[".concat(this._clientId,"] resubscribe error"),p.toString())})))})),this._config=e,this._clientId=t||mt(5,"client-"),this.store=new class{constructor(r,s,o,a,c){xe(this,"state",void 0),this.state={codec:r,audioCodec:s,mode:o,clientId:a,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[],firstVideoFrameDecoded:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:wa.Default,hasStartJoinChannel:!1,isABTestSuccess:!1,rteUrl:void 0,rteSid:void 0,autoSubscribe:!1,enableInstantMuteRestore:!1,networkQualityProbe:!1,useDcSignal:!!c}}dispatch(r){this.state=(function(s,o){switch(o.type){case Pe.SET_SESSION_ID:return ae(ae({},s),{},{sessionId:o.sessionId});case Pe.SET_P2P_ID:return ae(ae({},s),{},{p2pId:o.p2pId});case Pe.SET_UID:return ae(ae({},s),{},{uid:o.uid});case Pe.SET_INT_UID:return ae(ae({},s),{},{intUid:o.intUid});case Pe.SET_PUB_ID:return ae(ae({},s),{},{pubId:o.pubId});case Pe.KEY_METRIC_CLIENT_CREATED:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{clientCreated:o.metric})});case Pe.KEY_METRIC_JOIN_START:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{joinStart:o.metric})});case Pe.KEY_METRIC_PRELOAD_START:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{preloadStart:o.metric})});case Pe.KEY_METRIC_PRELOAD_END:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{preloadEnd:o.metric})});case Pe.KEY_METRIC_JOIN_END:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{joinEnd:o.metric})});case Pe.KEY_METRIC_REQUEST_AP_START:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{requestAPStart:o.metric})});case Pe.KEY_METRIC_REQUEST_AP_END:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{requestAPEnd:o.metric})});case Pe.KEY_METRIC_REQUEST_SUA_END:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{requestSUAEnd:o.metric})});case Pe.KEY_METRIC_BEFORE_CONNECT:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{beforeConnect:o.metric})});case Pe.KEY_METRIC_PEER_RECEIVER:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{peerReceiver:o.metric})});case Pe.KEY_METRIC_SIGNAL_CONNECTED:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{signalConnected:o.metric})});case Pe.KEY_METRIC_JOIN_REQ:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{joinReq:o.metric})});case Pe.KEY_METRIC_JOIN_REP:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{joinRep:o.metric})});case Pe.KEY_METRIC_JOIN_GATEWAY_START:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{joinGatewayStart:o.metric})});case Pe.KEY_METRIC_JOIN_GATEWAY_END:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{joinGatewayEnd:o.metric})});case Pe.KEY_METRIC_PEER_CONNECTION_START:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{peerConnectionStart:o.metric})});case Pe.KEY_METRIC_PEER_CONNECTION_END:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{peerConnectionEnd:o.metric})});case Pe.KEY_METRIC_DESCRIPTION_START:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{descriptionStart:o.metric})});case Pe.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{signalChannelOpen:o.metric})});case Pe.KEY_METRIC_ICE_CONNECTION_END:return ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{iceConnectionEnd:o.metric})});case Pe.KEY_METRIC_PUBLISH:{const a=s.keyMetrics.publish,c=a.findIndex((u=>u.trackId===o.metric.trackId));return c!==-1?(a[c]=ae(ae({},a[c]),o.metric),ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{publish:[...a]})})):ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{publish:[...s.keyMetrics.publish,o.metric]})})}case Pe.KEY_METRIC_SUBSCRIBE:{const a=s.keyMetrics.subscribe,c=a.findIndex((u=>u.userId===o.metric.userId&&u.type===o.metric.type));return c!==-1?(a[c]=ae(ae({},a[c]),o.metric),ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{subscribe:[...a]})})):ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{subscribe:[...s.keyMetrics.subscribe,o.metric]})})}case Pe.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED:{const a=s.keyMetrics.firstVideoFrameDecoded,c=a.findIndex((u=>u.userId===o.metric.userId));return c!==-1?(a[c]=ae(ae({},a[c]),o.metric),ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{firstVideoFrameDecoded:[...a]})})):ae(ae({},s),{},{keyMetrics:ae(ae({},s.keyMetrics),{},{firstVideoFrameDecoded:[...s.keyMetrics.firstVideoFrameDecoded,o.metric]})})}case Pe.RESET_FIRST_VIDEO_FRAME_DECODED:return s.keyMetrics.firstVideoFrameDecoded=[],s;case Pe.SET_CLOUD_PROXY_SERVER_MODE:return s.cloudProxyServerMode=o.mode,s;case Pe.RECORD_JOIN_CHANNEL_SERVICE:return typeof o.index!="number"?s.joinChannelServiceRecords=[...s.joinChannelServiceRecords,o.record]:(s.joinChannelServiceRecords[o.index]=ae(ae({},s.joinChannelServiceRecords[o.index]),o.record),s.joinChannelServiceRecords=[...s.joinChannelServiceRecords]),s;case Pe.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return s.joinChannelServiceRecords=[],s;case Pe.RESET_KEY_METRICS:return s.keyMetrics={publish:[],subscribe:[],firstVideoFrameDecoded:[]},s;case Pe.SET_USE_P2P:return ae(ae({},s),{},{useP2P:o.val});case Pe.SET_TRANSPORT_TYPE:return ae(ae({},s),{},{p2pTransport:o.val});case Pe.SET_RTE_URL:return ae(ae({},s),{},{rteUrl:o.rteUrl});case Pe.SET_RTE_SID:return ae(ae({},s),{},{rteSid:o.rteSid});default:return s}})(this.state,r)}get useDcSignal(){return this.state.useDcSignal}set useDcSignal(r){this.state.useDcSignal=r}set autoSubscribe(r){this.state.autoSubscribe=r}get autoSubscribe(){return this.state.autoSubscribe}set enableInstantMuteRestore(r){this.state.enableInstantMuteRestore=r}get enableInstantMuteRestore(){return this.state.enableInstantMuteRestore}set networkQualityProbe(r){this.state.networkQualityProbe=r}get networkQualityProbe(){return this.state.networkQualityProbe}set sessionId(r){this.dispatch({type:Pe.SET_SESSION_ID,sessionId:r})}get sessionId(){return this.state.sessionId}set rteUrl(r){this.dispatch({type:Pe.SET_RTE_URL,rteUrl:r})}get rteUrl(){return this.state.rteUrl}set rteSid(r){this.dispatch({type:Pe.SET_RTE_SID,rteSid:r})}get rteSid(){return this.state.rteSid}set cid(r){this.state.cid=r}get cid(){return this.state.cid}set codec(r){this.state.codec=r}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(r){this.dispatch({type:Pe.SET_P2P_ID,p2pId:r})}get p2pId(){return this.state.p2pId}set dcId(r){this.dispatch({type:Pe.SET_DC_ID,dcId:r})}get dcId(){return this.state.dcId}set uid(r){this.dispatch({type:Pe.SET_UID,uid:r})}get uid(){return this.state.uid}set intUid(r){this.dispatch({type:Pe.SET_INT_UID,intUid:r})}get intUid(){return this.state.intUid}set pubId(r){this.dispatch({type:Pe.SET_PUB_ID,pubId:r})}get pubId(){return this.state.pubId}set cloudProxyServerMode(r){this.dispatch({type:Pe.SET_CLOUD_PROXY_SERVER_MODE,mode:r})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(r){this.dispatch({type:Pe.SET_USE_P2P,val:r})}get useP2P(){return this.state.useP2P}set p2pTransport(r){this.dispatch({type:Pe.SET_TRANSPORT_TYPE,val:r})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(r){this.state.hasStartJoinChannel=r}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(r){this.state.isABTestSuccess=r}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:Pe.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:Pe.KEY_METRIC_JOIN_START,metric:Date.now()})}preloadStart(){this.dispatch({type:Pe.KEY_METRIC_PRELOAD_START,metric:Date.now()})}preloadEnd(){this.dispatch({type:Pe.KEY_METRIC_PRELOAD_END,metric:Date.now()})}joinEnd(){this.dispatch({type:Pe.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:Pe.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:Pe.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}requestSUAEnd(){this.dispatch({type:Pe.KEY_METRIC_REQUEST_SUA_END,metric:Date.now()})}beforeConnect(){this.dispatch({type:Pe.KEY_METRIC_BEFORE_CONNECT,metric:Date.now()})}peerReceiver(){this.dispatch({type:Pe.KEY_METRIC_PEER_RECEIVER,metric:Date.now()})}signalConnected(){this.dispatch({type:Pe.KEY_METRIC_SIGNAL_CONNECTED,metric:Date.now()})}joinReq(){this.dispatch({type:Pe.KEY_METRIC_JOIN_REQ,metric:Date.now()})}joinRep(){this.dispatch({type:Pe.KEY_METRIC_JOIN_REP,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:Pe.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:Pe.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:Pe.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:Pe.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}firstVideoFrameDecoded(r,s){this.dispatch({type:Pe.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED,metric:ae({userId:r},s)})}descriptionStart(){this.dispatch({type:Pe.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:Pe.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:Pe.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(r,s,o,a){this.dispatch({type:Pe.KEY_METRIC_PUBLISH,metric:ae(ae({trackId:r,type:s},o&&{publishStart:o}),a&&{publishEnd:a})})}subscribe(r,s,o,a,c,u,p){this.dispatch({type:Pe.KEY_METRIC_SUBSCRIBE,metric:ae(ae(ae(ae(ae({userId:r,type:s},o&&{subscribeStart:o}),a&&{subscribeEnd:a}),c&&{firstFrame:c}),u&&{streamAdded:u}),p&&{firstDecoded:p})})}massSubscribe(r,s,o,a){r.forEach((c=>{this.dispatch({type:Pe.KEY_METRIC_SUBSCRIBE,metric:ae(ae(ae({userId:c.userId,type:c.type},s&&{subscribeStart:s}),o&&{subscribeEnd:o}),a&&{firstFrame:a})})}))}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(r,s){r.service==="gateway"&&Array.isArray(r.urls)&&(r.urls=r.urls.map((o=>o.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2"))));try{return typeof s!="number"?(this.dispatch({type:Pe.RECORD_JOIN_CHANNEL_SERVICE,record:ae(ae({},r),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(s<0||s>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Pe.RECORD_JOIN_CHANNEL_SERVICE,record:r,index:s}),s)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Pe.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:Pe.RESET_KEY_METRICS})}resetFirstVideoFrameDecoded(){this.dispatch({type:Pe.RESET_FIRST_VIDEO_FRAME_DECODED})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}}(e.codec,e.audioCodec,e.mode,this._clientId,I("SIGNAL_CHANNEL")===1),this._leaveMutex=new Cn("client-leave",this._clientId),this._publishMutex=new Cn("client-publish",this._clientId),this._renewTokenMutex=new Cn("client-renewtoken",this._clientId),this._subscribeMutex=new Cn("client-subscribe",this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),S.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(tr," build: ").concat(uS,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{JE(e.clientRoleOptions),n=Object.assign({},e.clientRoleOptions)}catch(r){S.warning("[".concat(this._clientId,"] ").concat(r.toString()))}var i;this._statsCollector=new Ql(this.store),this._statsCollector.onStatsException=(r,s,o)=>{S.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(r,", msg: ").concat(s,", uid: ").concat(o)),r===fy.VIDEO_ENCODE_FAILED&&this.localTracks.forEach((a=>{a instanceof Mp&&I("ENABLE_ENCODE_EXCEPTION")&&a.findClosestProfile()})),this.safeEmit(Ye.EXCEPTION,{code:r,msg:s,uid:o})},this._statsCollector.onUploadPublishDuration=(r,s,o,a)=>{const c=this._users.find((u=>u.uid===r));c&&(this.store.keyMetrics&&(this.store.firstVideoFrameDecoded(c.uid,{peerPublishDuration:o,peerPubStatusMs:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(c)),Se.peerPublishStatus(this._sessionId,{subscribeElapse:a,audioPublishDuration:s,videoPublishDuration:o,peer:c._uintid}))},this._statsCollector.onVideoCodecChanged=r=>{if(I("VIDEO_STANDARD_BITRATE_VERSION")&&(r==="av1"||r==="h265"||r==="h264")){const s=this.localTracks.find((o=>o instanceof bt));s&&s._saveEncodeBitrateRatio!==1&&s.setSaveEncodeBitrateRatio(r==="h264"?I("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P=e.mode==="p2p",this._gateway=new cq(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||$t,httpRetryConfig:e.httpRetryConfig||$t,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:n}),this._configDistribute=new Sq(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(i={store:this.store,statsCollector:this._statsCollector},Zr("P2PChannel").create(i)),this._handleP2PEvents()):this._p2pChannel=new Ba(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,n,i,r){let s=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],o=arguments.length>6&&arguments[6]!==void 0&&arguments[6];St("JOIN_GATEWAY_USE_443PORT_ONLY",s),St("JOIN_GATEWAY_USE_DUAL_DOMAIN",o);const a=this._gateway.signal.websocket;return a instanceof JS&&(a.use443PortOnly=s,a.tryDoubleDomain=o),(async function(c,u,p){fp.get(c)||fp.set(c,[]),_p.get(c)||_p.set(c,u),Es.get(c)||Es.set(c,0);const m=fp.get(c),_=_p.get(c);if(!m||!_)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Es.get(c)===_){const O=Ol();m.push(O),await O.promise}Es.set(c,Es.get(c)+1);for(var g=arguments.length,b=new Array(g>3?g-3:0),v=3;v<g;v++)b[v-3]=arguments[v];const R=await p(...b);return Es.set(c,Es.get(c)-1),Es.get(c)===_-1&&m.length>0&&(m[0].resolve(),m.shift()),Es.get(c)===0&&(fp.set(c,[]),_p.set(c,0),Es.set(c,0)),R})("client.join",I("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,n,i,r)}async join(e,t,n,i,r){const s=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);const o=(vp||vp||(vp=(window.location.protocol.split(":")[0]||"").toUpperCase(),vp))==="HTTPS",a=SO()?window.isSecureContext:"Browser Not Support";(!SO()&&!o||!window.isSecureContext)&&S.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let c;Se.setAppId(e);try{if(!n&&n!==null)throw new Y(N.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));if(n&&Nn(n,"token",1,2047),Nn(e,"appid",1,2047),zp(t),i&&qp(i),r)if(typeof r=="string")Nn(r,"optionalInfo",1,256),c=r;else{if(typeof r!="object")throw new Y(N.INVALID_PARAMS,"Invalid options: options is not a string or object");{const{autoSubscribe:R,enableInstantMuteRestore:O,networkQualityProbe:D}=r;R&&(Tr(R,"autoSubscribe"),S.info("[".concat(this._clientId,"] join: autoSubscribe: ").concat(R)),this.store.autoSubscribe=R),O&&(Tr(O,"enableInstantMuteRestore"),S.info("[".concat(this._clientId,"] join: enableInstantMuteRestore: ").concat(O)),this.store.enableInstantMuteRestore=O),D&&(Tr(D,"networkQualityProbe"),S.info("[".concat(this._clientId,"] join: networkQualityProbe: ").concat(D)),this.store.networkQualityProbe=D)}}}catch(R){throw Se.reportApiInvoke(ba(),{name:xt.JOIN,options:[e,t,n,i],states:{isHttps:o,isSecureContext:a},tag:Ct.TRACER}).onError(R),R}if(this._leaveMutex.isLocked&&(S.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),S.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const R=new Y(N.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw Se.reportApiInvoke(ba(),{name:xt.JOIN,options:[e,t,n,i],states:{isHttps:o,isSecureContext:a},tag:Ct.TRACER}).onError(R),R}this._gateway.state="CONNECTING",this.store.preloadStart();const u=await Py({appId:e,cname:t,uid:i,stringUid:typeof i=="string"?i:void 0,token:n||e,cloudProxyServer:this._cloudProxyServerMode});if(this.store.preloadEnd(),!this._joinAndNotLeaveYet)throw new Y(N.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const p=u?.sid||ba();S.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(s)),this._sessionId||(this._sessionId=p,this.store.sessionId=this._sessionId);const m=Se.reportApiInvoke(this._sessionId,{id:this._clientId,name:xt.JOIN,options:[e,t,n,i],states:{isHttps:o,isSecureContext:a},tag:Ct.TRACER}),_=Dr(Dr(Dr({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:typeof i!="string"?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:c,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!u},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:I("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(_.setLocalAPVersion=this._setLocalAPVersion),typeof i=="string"&&(_.stringUid=i,this._uintUid?(_.uid=this._uintUid,this._uintUid=void 0):_.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(_.aesmode=this._encryptionMode,_.aespassword=await(async R=>{const O=(function(G){const j=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),H=new Uint8Array(new ArrayBuffer(j.length));for(let Z=0;Z<j.length;Z+=1)H[Z]=j.charCodeAt(Z);return H})(),D=await window.crypto.subtle.importKey("spki",O,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),x=qE(R),B=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},D,x);return(function(G){let j="";for(let H=0;H<G.length;H+=1)j+=String.fromCharCode(G[H]);return window.btoa(j)})(new Uint8Array(B))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new Y(N.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(_.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const R=new TextEncoder,O=I("USE_PURE_ENCRYPTION_MASTER_KEY")?R.encode(_.appId+this._encryptionSecret+this._encryptionSecret):R.encode(_.appId+_.cname+this._encryptionSecret);this._encryptDataStreamIv=await(async function(D,x,B){const G=await window.crypto.subtle.importKey("raw",x,"PBKDF2",!1,["deriveBits","deriveKey"]),j=D==="aes-128-gcm2"?128:256,H=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:OO,hash:"SHA-256",salt:B},G,j+FY);return new Uint8Array(H).subarray(j/8)})(this._encryptionMode,O,Ca(this._encryptionSalt)),this._encryptDataStreamKey=await(async function(D,x,B){const G=await window.crypto.subtle.importKey("raw",x,"PBKDF2",!1,["deriveBits","deriveKey"]),j=D==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:OO,hash:"SHA-256",salt:B},G,{name:"AES-GCM",length:j},!0,["encrypt","decrypt"])})(this._encryptionMode,O,Ca(this._encryptionSalt))}else a?S.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):S.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,S.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:t,appId:e,stringUid:_.stringUid});const g=this._sessionId;setTimeout((()=>{this.connectionState==="CONNECTING"&&g===this._sessionId&&Se.joinChannelTimeout(this._sessionId,5)}),5e3);try{var b;let R;const O=_.cloudProxyServer;if(ie(b=["proxy3","proxy4","proxy5"]).call(b,O)){const j=I("PROXY_SERVER_TYPE3");Array.isArray(j)?_.proxyServer=j[0]:_.proxyServer=j}if(Se.setProxyServer(_.proxyServer),S.setProxyServer(_.proxyServer),this.store.requestAPStart(),u){if(S.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(_.stringUid?", ".concat(_.stringUid," => ").concat(u.intUid):""," ")),_.stringUid&&!_.uid&&(_.uid=u.intUid),R={gatewayInfo:u.ap.gatewayInfo},I("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&_.turnServer.mode==="auto")if(u.ap.proxyInfo.addresses.length===0)S.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const j=(await gP(u.ap.proxyInfo,u.ap.gatewayInfo.uid)).map((H=>({turnServerURL:H.address,tcpport:H.tcpport||xn.tcpport,udpport:H.udpport||xn.udpport,username:H.username||xn.username,password:H.password||xn.password,forceturn:!1,security:!0})));_.turnServer={mode:"manual",servers:j}}bL(u,_.stringUid)}else{if(_.stringUid&&!_.uid){let j;[j,R]=await de.all([KP(_.stringUid,_,this._axiosCancelSource.token,this._config.httpRetryConfig||$t,this.store).finally((()=>{this.store.requestSUAEnd()})),HP(_,this._axiosCancelSource.token,this._config.httpRetryConfig||$t,!0,this.store).finally((()=>{this.store.requestAPEnd()}))]),S.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(_.stringUid," => ").concat(j)),_.uid=j,R.gatewayInfo.uid=j,R.gatewayInfo.res.uid=j}else R=await HP(_,this._axiosCancelSource.token,this._config.httpRetryConfig||$t,!0,this.store);if(!this._joinAndNotLeaveYet)throw new Y(N.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout((()=>{this._configDistribute.startGetConfigDistribute(_,this._axiosCancelSource.token),this._configDistribute.on(Jr.UPDATE_BITRATE_LIMIT,(j=>{this._p2pChannel.updateBitrateLimit(j)})),this._configDistribute.on(Jr.UPDATE_CLIENT_ROLE_OPTIONS,(j=>{this._setClientRoleOptions(j)})),this._configDistribute.on(Jr.UPDATE_REMOTE_VIDEO_STREAM_TYPE,(j=>{var H;ie(H=[0,1,4,5,6,7,8,9]).call(H,j)&&(this.remoteUsers.forEach((Z=>{this._remoteStreamTypeCacheMap.get(Z.uid)!==j&&this.setRemoteVideoStreamType(Z.uid,j)})),this.setRemoteDefaultVideoStreamType(j))})),this._configDistribute.on(Jr.FALLBACK_TO_HLS,(j=>{j&&this.safeEmit(Ye.FALLBACK_TO_HLS,QE.CONFIG)})),this._configDistribute.on(Jr.UPDATE_VOS_CONFIGURE,(j=>{this._gateway.setConfigure(j).catch((H=>{S.debug("[".concat(this._clientId,"] auto set vos config failed"),H)}))}))}),0),this._key=n||e;const D=R.gatewayInfo,x=_.uid?_.uid:D.uid;this._joinInfo=Dr(Dr({},_),{},{cid:D.cid,uid:x,vid:D.vid,apResponse:D.res,apGatewayAddress:D.apGatewayAddress,uni_lbs_ip:D.uni_lbs_ip,gatewayAddrs:D.gatewayAddrs}),this.store.intUid=x,this.store.cid=D.cid;const B=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new Y(N.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));m.onSuccess(B),this._appId=e,this._channelName=_.cname,this._uid=B,this.store.uid=B,setTimeout((()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),!Rn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(Rn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()}),0);const G=_.stringUid?"string uid: ".concat(_.stringUid,",uid: ").concat(_.uid):"uid: ".concat(this._uid);return S.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(G)),setTimeout((()=>{S.startUpload()}),5e3),this.store.joinEnd(),v=this,ie(ka).call(ka,v)||ka.push(v),this._cloudProxyServerMode==="disabled"&&Xe().supportWebCrypto&&I("ENABLE_PRELOAD")&&ky(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0),this._sessionId&&Se.reportRteDetail(this._sessionId),this._rteDetailInterval=window.setInterval((()=>{this._sessionId&&Se.reportRteDetail(this._sessionId)}),I("RTE_DETAIL_REPORT_INTERVAL")||6e4),B}catch(R){const O=Array.isArray(R)?R[0]:R;throw O&&O.code===N.OPERATION_ABORTED?S.warning("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),O):S.error("[".concat(this._clientId,"] join number: ").concat(s,", Joining channel failed, rollback"),O),O.code!==N.OPERATION_ABORTED&&this._numberOfJoinCount===s&&(this._gateway.state="DISCONNECTED",this._reset()),m.onError(O),O}var v}async _joinGateway(){if(!this._joinInfo||!this._key)throw new Y(N.INVALID_OPERATION);try{return await this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!I("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}catch(e){if(e.code===N.INIT_DATACHANNEL_TIMEOUT){if(this._gateway.leave(!0,Ze.FALLBACK),S.debug("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new Y(N.INVALID_OPERATION);return Se.reportApiInvoke(this._sessionId,{name:xt.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:Ct.TRACER}).onSuccess(),await this._joinGateway()}throw e}}async leave(){S.info("[".concat(this._clientId,"] Leaving channel"));const e=()=>{!Rn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(Rn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),(function(n){const i=ka.indexOf(n);i!==-1&&ka.splice(i,1)})(this),this._statsCollector.stopUpdateStats()};this.store.useDcSignal||e();const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return S.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED",Ze.LEAVE),S.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t(),this.store.useDcSignal&&e()}async publish(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof od))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new Y(N.INVALID_PARAMS,"param list is empty");const n=e;if(this._gateway.role==="audience")throw new Y(N.INVALID_OPERATION,"audience can not publish stream");for(const r of n){if(!(r instanceof od))throw new Y(N.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&t)throw new Y(N.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}S.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map((r=>"".concat(r.getTrackId()," ")))));const i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&n.forEach((r=>{const s=this._configDistribute.getBitrateLimit();r instanceof bt&&s&&r.setBitrateLimit(s.uplink)}));try{await this._publishHighStream(n),S.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map((r=>"".concat(r.getTrackId()," ")))))}catch(r){throw S.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{i()}}async _publishDataChannel(e){if(e==null)throw new Y(N.INVALID_PARAMS,"parameter is not local track or datachannel config, config is ".concat(JSON.stringify(e)));Rt(e.id,"id",0,65535,!0),Tr(e.ordered,"ordered"),Nn(e.metadata,"metadata",0,512),S.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const t=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex((r=>r.id===e.id))!==-1)throw new Y(N.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new Y(N.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&I("FORCE_TURN")&&!I("TURN_ENABLE_TCP")&&!I("TURN_ENABLE_UDP"))throw new Y(N.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=(function(r){return xP(r,!1)})(e),i=await this._p2pChannel.publishDataChannel([n]);if(i.length>0){if(typeof n._originDataChannelId!="number")throw S.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new Y(N.CREATE_DATACHANNEL_ERROR);try{await de.all(i.map((r=>this._uid&&this._gateway.publishDataChannel(this._uid,r,!0)))),await n._waitTillOpen()}catch(r){if(r.code!==N.DISCONNECT_P2P)throw r}}return S.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw S.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{t()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new Y(N.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof od))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);S.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map((i=>"".concat(i.getTrackId()," ")))," "));const n=await this._publishMutex.lock();try{if(this.store.useP2P){const i=await this._p2pChannel.unpublish(t);i&&await this._gateway.sendExtensionMessage(Jt.UNPUBLISH,{unpubMsg:i},!0)}else{const i=await this._p2pChannel.unpublish(t);i&&await this._gateway.unpublish(i,this._uid),S.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map((r=>"".concat(r.getTrackId())))))}}catch(i){throw S.error("[".concat(this._clientId,"] unpublish error"),i.toString()),i}finally{n&&n()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),S.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map((n=>"".concat(n.id," ")))," "));const t=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(e);n&&await this._gateway.unpublishDataChannel(n),S.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map((i=>"".concat(i.id)))))}catch(n){throw S.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{t&&t()}}async subscribe(e,t,n){if(!(e instanceof ko)){const i=this.remoteUsers.find((r=>r.uid===e));if(!i)throw new Y(N.INVALID_REMOTE_USER,"user is not in the channel");e=i}return t==="datachannel"?this._subscribeDataChannel(e,n):this._subscribe(e,t)}async presubscribe(e,t){if(Zt(t,"mediaType",["audio","video"]),this.store.useP2P)throw new Y(N.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new Y(N.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=t===_e.AUDIO,i=t===_e.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:s,ortc:o,rtxSsrcId:a,cname:c,uint_id:u}=await this._gateway.presubscribe(e,t,!0);if(s==null)throw new Y(N.UNEXPECTED_RESPONSE,"no ssrc id");let p=this._users.find((_=>_.uid===e));p||(p=new ko(e,u||e),p._is_pre_created=!0,this._users.push(p)),c&&(p._cname=c),p._uintid||(p._uintid=u||e),n&&(p._audioSSRC=s,p._audio_pre_subscribed=!0,o&&(p._audioOrtc=o)),i&&(p._videoSSRC=s,p._video_pre_subscribed=!0,o&&(p._videoOrtc=o),a!=null&&(p._rtxSsrcId=a)),S.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(s)),await this._p2pChannel.subscribe(p,t,s,a,o);const m=n?p._audioTrack:p._videoTrack;if(!m)throw new Y(N.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(p._trust_audio_stream_added_state_=!0,p._audio_added_=!0),i&&(p._trust_video_stream_added_state_=!0,p._video_added_=!0),m}catch(s){throw S.error("[".concat(this._clientId,"] presub user ").concat(e," error"),s),s}finally{r()}}async _subscribeDataChannel(e,t){var n;if(Rt(t,"channelId",0,65535,!0),!this._joinInfo)throw new Y(N.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find((a=>a===e)))throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new Y(N.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new Y(N.INVALID_REMOTE_USER,"user is not published");const r=(n=e._dataChannels)===null||n===void 0?void 0:n.find((a=>a.id===t));if(!r)throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new Y(N.REMOTE_USER_IS_NOT_PUBLISHED);const s=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const a=await this._p2pChannel.subscribeDataChannel(e,[r]);if(a&&ie(a).call(a,r.id))try{var o;if(typeof r._originDataChannelId!="number")throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new Y(N.CREATE_DATACHANNEL_ERROR);const c={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(o=r.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(e.uid,c,!0),await r._waitTillOpen()}catch(c){if(c?.code!==N.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[r]),c;await this._p2pChannel.unsubscribeDataChannel(e,[r]),this._p2pChannel.setPendingRemoteDataChannel(e,r.id)}return S.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),r}finally{s()}}async _p2pSubscribe(e,t,n){if(Zt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new Y(N.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((s=>s===e))){const s=new Y(N.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),s}if(!e.hasAudio&&!e.hasVideo){const s=new Y(N.INVALID_REMOTE_USER,"user is not published");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),s}if(!n&&(t==="audio"&&!e.hasAudio||t==="video"&&!e.hasVideo)){const s=new Y(N.REMOTE_USER_IS_NOT_PUBLISHED);throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),s}const r=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const o=t==="audio"?e._audioSSRC:e._videoSSRC,a=t==="audio"?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(e,t,o,a)}catch(o){throw o}S.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((o=>{S.warning("[".concat(this._clientId,"] auto set fallback failed"),o)}));const s=t==="audio"?e._audioTrack:e._videoTrack;if(!s)throw new Y(N.UNEXPECTED_ERROR,"can not find remote track in user object");return s}catch(s){throw S.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),s),s}finally{r()}}async _subscribe(e,t,n){if(this.store.useP2P)return this._p2pSubscribe(e,t);if(Zt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new Y(N.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find((u=>u===e))){const u=new Y(N.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),u}if(!e.hasAudio&&!e.hasVideo){const u=new Y(N.INVALID_REMOTE_USER,"user is not published");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),u}if(!(n||(t!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(t!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){const u=new Y(N.REMOTE_USER_IS_NOT_PUBLISHED);throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),u}let r=t==="audio"?e._audioSSRC:e._videoSSRC,s=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,a={stream_type:t==="audio"?_e.AUDIO:_e.VIDEO,ssrcId:r};t==="video"&&this.store.firstVideoFrameDecoded(e.uid,{subscribeStart:Date.now()});const c=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const p=t==="audio"?e._audioSSRC:e._videoSSRC;p!==void 0&&p!==r&&(r=p,s=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,a={stream_type:t==="audio"?_e.AUDIO:_e.VIDEO,ssrcId:r}),Fn.markSubscribeStart(this.store.clientId,r),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,r,o,s);try{this._p2pChannel.isPreSubScribe(r)||await this._gateway.subscribe(e.uid,a,!0)}catch(m){if(m?.code!==N.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),m;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(p){throw this._p2pChannel.reportSubscribeEvent(!1,p?.code,e,t),p}S.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch((p=>{S.warning("[".concat(this._clientId,"] auto set fallback failed"),p)}));const u=t==="audio"?e._audioTrack:e._videoTrack;if(!u)throw new Y(N.UNEXPECTED_ERROR,"can not find remote track in user object");return t==="video"&&(this.store.firstVideoFrameDecoded(e.uid,{subscribeEnd:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(e)),u}catch(u){throw S.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),u),u}finally{c()}}async massSubscribe(e){if(Js(e,"subscribeList"),!this._joinInfo)throw new Y(N.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),n=new Map,i=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map((a=>{let{user:c,mediaType:u}=a;return"user: ".concat(c?.uid,", mediaType: ").concat(u)})).join("; ")));const r=(e=[...e]).map((a=>{let{user:c,mediaType:u}=a;return{user:c,mediaType:u}})),s=await this._p2pChannel.globalLock();try{var o;for(let c=e.length-1;c>=0;c--){const u=e[c],{user:p,mediaType:m}=u;if(Zt(m,"mediaType",["audio","video"]),!p){const v=new Y(N.INVALID_PARAMS,"user property does not exist in subscribeList item");throw S.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),v}if(!this._users.find((v=>v===p))){const v=new Y(N.INVALID_REMOTE_USER,"user is not in the channel");S.error("[".concat(this._clientId,"] can not massSubscribe ").concat(p.uid,", this user is not in the channel")),r[c].error=v,e.splice(c,1);continue}if(m==="audio"&&(!p.hasAudio||p._audioSSRC===void 0)||m==="video"&&(!p.hasVideo||p._videoSSRC===void 0)){const v=new Y(N.REMOTE_USER_IS_NOT_PUBLISHED);S.error("[".concat(this._clientId,"] can not subscribe ").concat(p.uid," with mediaType ").concat(m,", remote user is not published")),r[c].error=v,e.splice(c,1);continue}const g=yn.Video|yn.LwoVideo,b=n.get(p);if(b){if(m==="video"?b&g:b&yn.Audio){e.splice(c,1),S.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(p.uid,", mediaType:").concat(m," twice"));continue}n.set(p,b|(m==="video"?g:yn.Audio))}else n.set(p,m==="video"?g:yn.Audio)}for(let c=e.length-1;c>=0;c--){const u=e[c],{user:p,mediaType:m}=u,_=yn.Video|yn.LwoVideo;if(this._p2pChannel.hasRemoteMedia(p,m)){await this._p2pChannel.unmuteRemoteNoLock(p,m);const g=n.get(p);n.set(p,m==="video"?g^_:g^yn.Audio),e.splice(c,1)}}this.store.massSubscribe(e.map((c=>({userId:c.user.uid,type:c.mediaType}))),t);let a=$i(o=Array.from(n.entries())).call(o,((c,u)=>{let[p,m]=u;if(m===0)return c;const _={stream_id:p.uid,stream_type:m};return m&yn.Audio&&(_.audio_ssrc=p._audioSSRC),m&yn.Video&&(_.video_ssrc=p._videoSSRC),c.push(_),c}),[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map((u=>{let{user:p,mediaType:m}=u;return{user:p,mediaType:m,ssrcId:m===_e.VIDEO?p._videoSSRC:p._audioSSRC,rtxSsrcId:m===_e.VIDEO?p._rtxSsrcId:void 0}})));const c=new Map;if(a=a.filter((u=>u.video_ssrc&&!this._p2pChannel.isPreSubScribe(u.video_ssrc)||u.audio_ssrc&&!this._p2pChannel.isPreSubScribe(u.audio_ssrc)||!u.video_ssrc&&!u.audio_ssrc)),a.length>0){const u=await this._gateway.subscribeAll(a,!0);(u?.users||[]).forEach((p=>{let{stream_id:m,video_error_code:_,audio_error_code:g,error_code:b}=p;(_||g||b)&&c.set(m,{video_error_code:_,audio_error_code:g,error_code:b})}))}if(Array.from(c.entries()).length>0){const u=[];Array.from(c.entries()).forEach((p=>{let[m,_]=p;const g=this.remoteUsers.find((b=>b.uid===m));if(g){let b;_.error_code||_.video_error_code&&_.audio_error_code?b=void 0:_.video_error_code?b=_e.VIDEO:_.audio_error_code&&(b=_e.AUDIO),u.push({user:g,mediaType:b})}})),u.length>0&&await this._p2pChannel.massUnsubscribeNoLock(u)}for(const u of r){const p=c.get(u.user.uid);if(p){const m=p.error_code||u.mediaType==="audio"&&p.audio_error_code||u.mediaType==="video"&&p.video_error_code;if(m){const _=Ua(m);S.error("user:".concat(u.user.uid," mediaType:").concat(u.mediaType," has massSubscribe error ").concat(_.desc)),u.error=new Y(N.SUBSCRIBE_FAILED,"code ".concat(m,": ").concat(_.desc))}}u.error||(u.mediaType==="video"?u.track=u.user.videoTrack:u.track=u.user.audioTrack)}return this.store.massSubscribe(r.filter((u=>!u.error)).map((u=>({userId:u.user.uid,type:u.mediaType}))),void 0,Date.now()),r.forEach((u=>{var p;Se.subscribe(this.store.sessionId,{succ:!!u.error,ec:((p=u.error)===null||p===void 0?void 0:p.code)||null,video:u.mediaType===_e.VIDEO,audio:u.mediaType===_e.AUDIO,peerid:u.user.uid,subscribeRequestid:u.mediaType===_e.VIDEO?u.user._videoSSRC:u.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t),preSsrc:this._p2pChannel.isPreSubScribe(u.user._videoSSRC)},!0)})),S.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map((u=>{let{user:p,mediaType:m}=u;return"user: ".concat(p?.uid,", mediaType: ").concat(m)})).join("; "))),r}catch(c){throw await this._p2pChannel.massUnsubscribeNoLock(e),c}}finally{s(),i()}}async unsubscribe(e,t,n){if(!(e instanceof ko)){const s=this.remoteUsers.find((o=>o.uid===e));if(!s)throw new Y(N.INVALID_REMOTE_USER,"user is not in the channel");e=s}if(t||this.store.useP2P){if(t==="datachannel")return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(t&&Zt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new Y(N.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find((s=>s===e))){const s=new Y(N.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),s}S.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));const r=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(e,t);else{const s=await this._p2pChannel.unsubscribe(e,t);s&&await this._gateway.unsubscribe(s,e.uid),t&&t!=="audio"||(e._audio_pre_subscribed=!1),t&&t!=="video"||(e._video_pre_subscribed=!1),e._is_pre_created&&Sp(this._users,e),S.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(s){if(s.code===N.DISCONNECT_P2P)return void S.warning("disconnecting p2p, abort unsubscribe request.");throw S.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),s.toString()),s}finally{r()}}async _unsubscribeDataChannel(e,t){if(t&&Rt(t,"id",0,65535,!0),!this._joinInfo)throw new Y(N.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find((r=>r===e))){const r=new Y(N.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),r}let i;if(typeof t=="number"){const r=e._dataChannels.find((s=>s.id===t));r&&(i=[r])}else i=e._dataChannels;if(i===void 0){const r=new Y(N.REMOTE_USER_IS_NOT_PUBLISHED);throw S.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),r}S.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i.map((r=>r.id))));try{const r=await this._p2pChannel.unsubscribeDataChannel(e,i);r&&await this._gateway.unsubscribeDataChannel(r,e.uid),S.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===N.DISCONNECT_P2P)return void S.warning("disconnecting p2p, abort unsubscribe request.");throw S.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),r.toString()),r}}async massUnsubscribe(e){if(Js(e,"unsubscribeList"),!this._joinInfo)throw new Y(N.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");S.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map((n=>{let{user:i,mediaType:r}=n;return"user: ".concat(i?.uid,", mediaType: ").concat(r,";")})).join())),e=[...e];const t=new Map;for(let n=e.length-1;n>=0;n--){const{user:i,mediaType:r}=e[n];if(!i){const a=new Y(N.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw S.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(Zt(r,"mediaType",["video","audio",void 0]),!this._users.find((a=>a===i))){S.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),e.splice(n,1);continue}const o=yn.Video|yn.LwoVideo;if(t.has(i)){const a=t.get(i);let c;switch(r){case"video":c=a&o;break;case"audio":c=a&yn.Audio;break;default:c=a&(yn.Audio|o)}if(c){S.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),e.splice(n,1);continue}r?r==="audio"?t.set(i,a|yn.Audio):r==="video"&&t.set(i,a|o):t.set(i,a|yn.Audio|o)}else r?r==="audio"?t.set(i,yn.Audio):r==="video"&&t.set(i,o):t.set(i,yn.Audio|o)}try{const n=await this._p2pChannel.massUnsubscribe(e);n&&await this._gateway.massUnsubscribe(n),S.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map((i=>{let{user:r,mediaType:s}=i;return"user: ".concat(r?.uid,", mediaType: ").concat(s,";")})).join()))}catch(n){if(n.code===N.DISCONNECT_P2P)return void S.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw S.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(e){(function(n){if(!n)throw new J(N.INVALID_PARAMS);Wt(n.width)||YE(n.width,"streamParameter.width"),Wt(n.height)||YE(n.height,"streamParameter.height"),Wt(n.framerate)||YE(n.framerate,"streamParameter.framerate"),Wt(n.bitrate)||Rt(n.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&S.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),S.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,re.LocalVideoLowTrack)}async setDualStreamMode(e,t){Zt(e,"mode",[0,1,-1]);try{switch(t&&await this.setLowStreamParameter(t),this._dualStreamMode=e,this._joinInfo?this._gateway.setDualStreamMode(e).catch((n=>{S.warning("[".concat(this._clientId,"] set dual stream mode failed"),n.toString())})):S.debug("[".concat(this._clientId,"] haven't joined yet, cache dual stream mode ").concat(e)),e){case Xc.AUTO_SIMULCAST_STREAM:S.info("[".concat(this._clientId,"] set dual stream mode to ").concat(e));break;case Xc.DISABLE_SIMULCAST_STREM:return this.disableDualStream();case Xc.ENABLE_SIMULCAST_STREAM:return this.enableDualStream()}}catch(n){throw S.error("[".concat(this._clientId,"] set dual stream mode error"),n.toString()),n}}async enableDualStream(){if(!Xe().supportDualStream)throw Se.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new Y(N.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new Y(N.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw Se.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,this._dualStreamMode=Xc.ENABLE_SIMULCAST_STREAM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch((e=>{S.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())})),Se.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),S.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)return this._isDualStreamEnabled=!1,void S.info("[".concat(this._clientId,"] disable dual stream before join"));if(this._p2pChannel.getLocalMedia(re.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw Se.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,this._dualStreamMode=Xc.DISABLE_SIMULCAST_STREM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch((e=>{S.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())})),Se.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),S.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if((function(i){Zt(i,"role",["audience","host"])})(e),t&&JE(t),this.mode==="rtc"||this.mode==="p2p")throw S.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new Y(N.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&e==="host")throw new Y(N.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new Y(N.INVALID_OPERATION,"can not set client role to audience when publishing stream");const n=this._config.role;if(this._joinInfo&&(this._joinInfo.role=e),e!==n&&I("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(e,t),this._config.role=e,this._gateway.reconnect("recover",kn.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(e,t),this._config.role=e),S.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level)),n==="audience"&&e!=="audience"&&this._pendingRtpCapabilityChange&&this._p2pChannel instanceof Ba){const{video_codec:i}=this._pendingRtpCapabilityChange;this._p2pChannel.updateRemoteRTPCapabilities(i.map((r=>r.toLowerCase())).filter((r=>{var s;return ie(s=Object.keys(Aa)).call(s,r)})))}}async _setClientRoleOptions(e){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let t=!1;try{e&&JE(e),await this._gateway.setClientRole(this._config.role,e),t=!0}catch{}finally{S.info("[".concat(this._clientId,"] set client role options ").concat(t?"succeed":"failed",", options is ").concat(e))}}getRemoteInboundOffset(){var e;const t=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const n=t.timestamp-Date.now();return Math.abs(n)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(Nn(e,"proxyServer"),!t){if(this.connectionState!=="DISCONNECTED")throw new Y(N.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new Y(N.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,Se.setProxyServer(this._proxyServer),S.setProxyServer(this._proxyServer),S.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if(this.connectionState!=="DISCONNECTED")throw new Y(N.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new Y(N.INVALID_OPERATION,"You have already set the proxy")}if(ya(e))return this._turnServer={servers:e,mode:"original-manual"},void S.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map((n=>n.urls)).join(","),"."));e.forEach((n=>aO(n))),this._turnServer={servers:e,mode:"manual"},S.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new Y(N.INVALID_OPERATION,"you should set license before join channel");if(Nn(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new Y(N.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,S.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new Y(N.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new Y(N.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let n;switch(e===void 0&&(e=3),e){case 1:case 2:throw new Y(N.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new Y(N.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,S.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new Y(N.INVALID_OPERATION,"Stop proxy server after leave channel");Se.setProxyServer(),S.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",S.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new Y(N.INVALID_PARAMS,"accessPoints is required.");Js(e.accessPoints.serverList,"accessPoints.serverList"),Nn(e.accessPoints.domain,"accessPoints.domain");const t=(_,g)=>{Rt(_,g,0,65535,!0)};let n=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new Y(N.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");I("CLOSE_AFB_FOR_LOCAL_AP")&&(St("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),St("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=e.accessPoints.domain,s=e.accessPoints.serverList.map((_=>i.test(_)?"".concat(_.replace(/\./g,"-"),".").concat(r):_)),o=s.map((_=>"".concat(_,":").concat(n)));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,St("WEBCS_DOMAIN",o),St("WEBCS_DOMAIN_BACKUP_LIST",o),St("GATEWAY_DOMAINS",[r]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(Js(e.report.hostname,"report.hostname"),St("EVENT_REPORT_DOMAIN",e.report.hostname[0]),St("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(St("EVENT_REPORT_DOMAIN",s[0]),St("EVENT_REPORT_BACKUP_DOMAIN",s[1]||s[0]));let a=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),a=e.report.port),St("STATS_COLLECTOR_PORT",a),e.report?St("ENABLE_EVENT_REPORT",!0):St("ENABLE_EVENT_REPORT",!1);let c="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(Js(e.log.hostname,"log.hostname"),c=e.log.hostname[0]):c=s[0];let u=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),u=e.log.port),St("LOG_UPLOAD_SERVER","".concat(c,":").concat(u));let p=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(Js(e.cds.hostname,"cds.hostname"),p=e.cds.hostname):p=s;let m=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),m=e.cds.port),St("CDS_AP",p.map((_=>"".concat(_,":").concat(m)))),e.cds?St("ENABLE_CONFIG_DISTRIBUTE",!0):St("ENABLE_CONFIG_DISTRIBUTE",!1),S.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(Js(e,"serverList"),Nn(t,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new Y(N.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map((i=>n.test(i)?"".concat(i.replace(/\./g,"-"),".").concat(t):i)),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,St("WEBCS_DOMAIN",e),St("WEBCS_DOMAIN_BACKUP_LIST",e),St("GATEWAY_DOMAINS",[t]),St("EVENT_REPORT_DOMAIN",e[0]),St("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),St("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),S.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(Zt(e,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw S.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else S.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){Zt(t,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout((()=>{const n=this._users.find((i=>i.uid===e));n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution()}),2e3)}catch(n){throw S.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}S.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){Zt(t,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(n){throw S.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}S.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,n,i){(function(s){Zt(s,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),Nn(t,"secret");const r=["aes-128-gcm2","aes-256-gcm2"];if(ie(r).call(r,e)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new Y(N.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new Y(N.INVALID_PARAMS,"current encrypt mode does not need salt");if(i){if(Tr(i,"encryptDataStream"),!ie(r).call(r,e))throw new Y(N.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(t)||S.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=t,n&&(this._encryptionSalt=Ao(n))}async renewToken(e){if(Nn(e,"token",1,2047),!this._key||!this._joinInfo)throw new Y(N.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(I("USE_NEW_TOKEN")){S.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await Eq(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||$t);S.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:i})}else S.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});S.debug("[".concat(this._clientId,"] renewToken success"))}catch(i){throw this._key=t,this._joinInfo.token=t,S.error("[".concat(this._clientId,"] renewToken failed"),i.toString()),i}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?S.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval((()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(Ye.VOLUME_INDICATOR,e)}),I("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if(this.codec!=="h264")throw new Y(N.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new Y(N.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new Y(N.LIVE_STREAMING_TASK_CONFLICT);const n=t?Zs.TRANSCODE:Zs.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(e,n)}setLiveTranscoding(e){return this._createLiveStreamingClient(Zs.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter((n=>n&&n.hasUrl(e)));if(!t.length)throw new Y(N.INVALID_PARAMS,"can not find live streaming url to stop");await de.all(t.map((n=>n&&n.stopLiveStreamingTask(e))))}async startChannelMediaRelay(e){QP(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){QP(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(e){this._p2pChannel instanceof Ba&&this._p2pChannel.addAudioMetadata(e)}async sendStreamMessage(e){var t;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new Y(N.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){const r=new TextEncoder;e.payload=r.encode(e.payload)}let i=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&ie(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)&&(i=!0,e.payload=await(async function(r,s,o){var a;const c=$i(a=Array.from(o)).call(a,((v,R)=>v+R),0),u={serverTs:0,seq:BY++,length:o.length,checkSum:c},p=new Uint8Array(_O(c,2)),m=new ArrayBuffer(td),_=new DataView(m);_.setUint32(0,u.serverTs),_.setUint16(4,u.seq),_.setUint16(6,u.length),_.setUint16(8,u.checkSum);const g=16-o.length%16;o=uO(o,new Uint8Array(g));const b=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:r,tagLength:IO,additionalData:p},s,o);return uO(new Uint8Array(m),new Uint8Array(b))})(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new Y(N.INVALID_PARAMS,i?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(Ce.DATA_STREAM,{payload:Ao(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-Aq},!n)}sendMetadata(e){if(!this._joinInfo)throw new Y(N.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new Y(N.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Ce.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Ao(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(JY),!this._joinInfo)throw new Y(N.INVALID_OPERATION,"can not send custom report, not joined");await Se.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){const e=this._statsCollector.getRemoteNetworkQualityStats();if(I("DELETE_NEQ_AFTER_USER_LEAVE")){const t=this._users.map((n=>n.uid+""));Object.keys(e).forEach((n=>{ie(t).call(t,n)||delete e[n]}))}return e}getNetworkQuality(){return this._statsCollector.getNetworkQuality()}async pickSVCLayer(e,t){Zt(t.spatialLayer,"spatialLayer",[0,1,2,3]),Zt(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(n){throw S.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(e){const{apRTM:t=!1,rtmFlag:n}=e;if(Tr(t,"apRTM"),Rt(n,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=n,S.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(S.debug("[".concat(this._clientId,"] reset client")),(function(e){const t=hd.indexOf(e);t!==-1&&hd.splice(t,1)})(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this.store.autoSubscribe=!1,this._pendingRtpCapabilityChange=void 0,this._axiosCancelSource.cancel(),this._axiosCancelSource=ui.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&CL(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0,this._sessionId&&Se.reportRteDetail(this._sessionId)),this._fallbackServerInfo=void 0,this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&Se.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this.store.resetFirstVideoFrameDecoded(),this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach((e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach((t=>t._close())),e._dataChannels.length=0)})),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Cn("client-publish",this._clientId),this._subscribeMutex=new Cn("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,t){var n;const i=e||ba();e?S.debug("[".concat(this._clientId,"] new Session ").concat(i)):S.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));const r=e?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i,Se.addSid(i);const s={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:t?.stringUid||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1,rteUrl:this.store.rteUrl,rteSid:this.store.rteSid};Se.sessionInit(this._sessionId,Dr({cname:t.channel,appid:t.appId},s)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new Y(N.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&I("FORCE_TURN")&&!I("TURN_ENABLE_TCP")&&!I("TURN_ENABLE_UDP"))throw new Y(N.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");S.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){const i=(await n.next()).value;if(i){try{await this._gateway.sendExtensionMessage(Jt.PUBLISH,i,!0)}catch(r){throw n.throw(r),r}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const i=(await n.next()).value;if(i){var t;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(s){if(s.code!==N.DISCONNECT_P2P)throw n.throw(s),s}await n.next(((t=r)===null||t===void 0?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const r of e)r instanceof bt&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig).catch((s=>{S.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))})),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,e),n?.code===N.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new Y(N.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new Y(N.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));S.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await n.next()).value;if(i){var t;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(s){if(s.code!==N.DISCONNECT_P2P)throw n.throw(s),s}n.next(((t=r)===null||t===void 0?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n?.code,void 0,!0),n?.code===N.WS_ABORT)return;throw n}}_createLiveStreamingClient(e){const t=()=>{if(!this._joinInfo||!this._appId)return new Y(N.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const n=(i={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},Zr("LiveStreaming").create(i));var i;return n.onLiveStreamError=(r,s)=>{Se.reportApiInvoke(this._sessionId,{name:xt.ON_LIVE_STREAM_ERROR,options:[r,s],tag:Ct.TRACER}).onSuccess(),this.safeEmit(Ye.LIVE_STREAMING_ERROR,r,s)},n.onLiveStreamWarning=(r,s)=>{Se.reportApiInvoke(this._sessionId,{name:xt.ON_LIVE_STREAM_WARNING,options:[r,s],tag:Ct.TRACER}).onSuccess(),this.safeEmit(Ye.LIVE_STREAMING_WARNING,r,s)},n.on(zS.REQUEST_WORKER_MANAGER_LIST,((r,s,o)=>{if(!this._joinInfo)return o(new Y(N.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(a,c,u,p){const m=I("UAP_AP").slice(0,I("AJAX_REQUEST_CONCURRENT")).map((_=>c.proxyServer?"https://".concat(c.proxyServer,"/ap/?url=").concat(_+"/api/v1?action=uap"):"https://".concat(_,"/api/v1?action=uap")));return await uq(m,a,c,u,p)})(r,this._joinInfo,this._axiosCancelSource.token,$t).then(s).catch(o)})),n};return e===Zs.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||t(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||t(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new Y(N.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:n}=this.getLocalVideoStats(),i=(e={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:t,height:n}},Zr("ChannelMediaRelay").create(e));i.on("state",(r=>{r===yi.RELAY_STATE_FAILURE&&i&&i.dispose(),this.safeEmit(Ye.CHANNEL_MEDIA_RELAY_STATE,r)})),i.on("event",(r=>{this.safeEmit(Ye.CHANNEL_MEDIA_RELAY_EVENT,r)})),this._channelMediaRelayClient=i,this._statsCollector.onStatsChanged=(r,s)=>{var o;r==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(s))}}var e;return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){const{added:n,deleted:i}=e,r=[];if(t){const s=[];this._users.forEach((o=>{o._dataChannels.forEach((a=>{n.every((c=>c.uid!==o._uintid||c.stream_id!==a.id))&&s.push({uid:o._uintid,stream_id:a.id,ordered:a.ordered,max_retrans_times:a.maxRetransmits,metadata:a.metadata})}))})),s.length>0&&this._handleUpdateDataChannel({added:[],deleted:s})}Array.isArray(n)&&n.length>0&&n.forEach((s=>{const{uid:o,stream_id:a,ordered:c,max_retrans_times:u,metadata:p}=s,m=this._users.find((_=>_._uintid===o));if(!m)return void S.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(S.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(o)),ie(r).call(r,m)||r.push(m),m._uintid||(m._uintid=o),m._dataChannels.findIndex((_=>_.id===s.stream_id))===-1){const _={id:a,ordered:!!c,maxRetransmits:u,metadata:p},g=(function(b){return xP(b,!0)})(_);m._dataChannels.push(g),S.info("[".concat(this._clientId,"] remote user ").concat(m.uid," published datachannel")),t||this.safeEmit(Ye.USER_PUBLISHED,m,"datachannel",_)}this._p2pChannel.hasPendingRemoteDataChannel(m,s.stream_id)&&(S.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(m.uid," after reconnect.")),this._subscribeDataChannel(m,s.stream_id).catch((_=>{S.error("[".concat(this._clientId,"] resubscribe datachannel error"),_.toString())})))})),t&&(this.safeEmit(Ye.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach((s=>{const{uid:o,stream_id:a}=s,c=this._users.find((p=>p._uintid===o));if(!c)return void S.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const u=c._dataChannels.find((p=>p.id===s.stream_id));u&&(S.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(o)),this._p2pChannel.unsubscribeDataChannel(c,[u]).then((p=>{if(c._dataChannels=c._dataChannels.filter((m=>m!==u)),p)return this._gateway.unsubscribeDataChannel(p,c.uid)})),S.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished datachannel ,id:").concat(u.id)),this.safeEmit(Ye.USER_UNPUBLISHED,c,"datachannel",u._config))}))}_getEncodingName(e){var t,n;if(!this._joinResponse)return;const i=(t=this._joinResponse.ortc.rtpCapabilities.sendrecv)===null||t===void 0?void 0:t.videoCodecs;if(!i)return;for(const a of i){var r;if(a.payloadType===e)return a==null||(r=a.rtpMap)===null||r===void 0?void 0:r.encodingName}const s=(n=this._joinResponse.ortc.rtpCapabilities.recv)===null||n===void 0?void 0:n.videoCodecs;if(s)for(const a of s){var o;if(a.payloadType===e)return a==null||(o=a.rtpMap)===null||o===void 0?void 0:o.encodingName}return e===0?"unknown":void 0}_handleRemoveDataChannels(e){const t=this._users.find((n=>n.uid===e.uid));if(t){if(t._dataChannels!==void 0&&t._dataChannels.length>0){S.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach((i=>{this.safeEmit(Ye.USER_UNPUBLISHED,t,"datachannel",i._config)}))};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then((i=>{if(i)return this._gateway.unsubscribeDataChannel(i,t.uid)})),n()}}else S.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Xt.UPDATE_GATEWAY_CONFIG,(()=>{(function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void S.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),n=Date.now();Object.keys(t).forEach((i=>{const{value:r,type:s,expires:o}=t[i];o&&o<=n||s||FS()||!Object.prototype.hasOwnProperty.call(wp,i)||(Bi[i]=r,ft[i]=r,S.debug("Update gateway parameters from config distribute",i,r))}))}catch(t){S.error("Error update config from local cache",t.message)}})()})),this._gateway.on(Xt.DISCONNECT_P2P,(async()=>{await this._p2pChannel.disconnectForReconnect()})),this._gateway.on(Xt.CONNECTION_STATE_CHANGE,((e,t,n)=>{var i;if(n===Ze.FALLBACK)return;const r=()=>{this.safeEmit(Ye.CONNECTION_STATE_CHANGE,e,t,n)};if(Se.reportApiInvoke(this._sessionId||((i=this._gateway.joinInfo)===null||i===void 0?void 0:i.sid)||null,{name:xt.CONNECTION_STATE_CHANGE,options:[e,t,n],tag:Ct.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:n})),S.info("[".concat(this._clientId,"] signal connection state change: ").concat(t," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void r();if(e==="RECONNECTING")this._users.forEach((o=>{o._trust_in_room_=!1,o._trust_audio_enabled_state_=!1,o._trust_video_enabled_state_=!1,o._trust_audio_mute_state_=!1,o._trust_video_mute_state_=!1,o._trust_audio_stream_added_state_=!1,o._trust_video_stream_added_state_=!1,o._is_pre_created||(o._audio_pre_subscribed||(o._audioSSRC=void 0,o._audioOrtc=void 0),o._video_pre_subscribed||(o._videoSSRC=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),o._cname=void 0)})),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var s;this._streamFallbackTypeCacheMap.forEach(((o,a)=>{this._gateway.setStreamFallbackOption(a,o).catch((c=>{S.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)}))})),this._remoteStreamTypeCacheMap.forEach(((o,a)=>{this._gateway.setRemoteVideoStreamType(a,o).catch((c=>{S.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)}))})),I("VOS_CONFIGURE")&&Array.isArray(I("VOS_CONFIGURE"))&&I("VOS_CONFIGURE").length>0&&(this._gateway.setConfigure(I("VOS_CONFIGURE")).catch((o=>{S.debug("[".concat(this._clientId,"] auto set vos config failed"),o)})),S.debug("[".concat(this._clientId,"] ws connected auto set vos config"))),this._remoteDefaultVideoStreamType!==void 0&&((s=this._joinInfo)===null||s===void 0?void 0:s.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then((()=>{S.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))})).catch((o=>{S.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(o))})),this._dualStreamMode&&this._gateway.setDualStreamMode(this._dualStreamMode).catch((o=>{S.warning("[".concat(this._clientId,"] auto set dual stream mode failed"),o)})),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout((()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter((o=>!o._trust_in_room_)).forEach((o=>{S.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(o.uid)),this._handleUserOffline({uid:o.uid})})))}),3e3),this._streamRemovedTimeout=window.setTimeout((()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach((o=>{o._trust_audio_mute_state_||(S.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,_e.AUDIO,!1)),o._trust_video_mute_state_||(S.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(o.uid)),this._handleMuteStream(o.uid,_e.VIDEO,!1)),o._trust_audio_enabled_state_||(S.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(o.uid)),this._handleSetStreamLocalEnable("audio",o.uid,!0)),o._trust_video_enabled_state_||(S.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(o.uid)),this._handleSetStreamLocalEnable("video",o.uid,!0)),o._trust_video_stream_added_state_||(S.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(o.uid)),this._handleResetAddStream(o,"video")),o._trust_audio_stream_added_state_||(S.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(o.uid)),this._handleResetAddStream(o,"audio")),o._video_added_||o._audio_added_||(S.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(o.uid)),this._handleRemoveStream({uid:o.uid,uint_id:o._uintid}))})))}),1e3))}r()})),this._gateway.on(Xt.REQUEST_NEW_GATEWAY_LIST,(async(e,t)=>{if(!this._joinInfo)return t(new Y(N.UNEXPECTED_ERROR,"can not recover, no join info"));try{let n;if(this._fallbackServerInfo)n=this._fallbackServerInfo,this._fallbackServerInfo=void 0,this._joinInfo.preload=!1,Se.reportApiInvoke(this._sessionId,{name:xt.VOS_FALLBACK_CN,options:{cur:n.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!0},tag:Ct.TRACER}).onSuccess(),S.info("[".concat(this._clientId,"] use fallback cn server info"));else{const r=await Py(Dr(Dr({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));r?(n=r.ap,bL(r),this._joinInfo.preload=!0):(n=await dm(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||$t,this.store),this._joinInfo.preload=!1)}this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);const i=[];n.gatewayInfo.gatewayAddrs.forEach((r=>{let{address:s}=r;const[o,a]=s.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:o,port:a}):i.push({host:o,port:a})})),e(i)}catch(n){t(n)}})),this._gateway.on(Xt.NETWORK_QUALITY,(e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(Ye.NETWORK_QUALITY,e)})),this._gateway.on(Xt.STREAM_TYPE_CHANGE,((e,t)=>{this.safeEmit(Ye.STREAM_TYPE_CHANGED,e,t),Se.reportApiInvoke(this._sessionId,{name:xt.STREAM_TYPE_CHANGE,options:[e,t],tag:Ct.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))})),this._gateway.isPreSub=()=>"isPreSub"in this._p2pChannel&&this._p2pChannel.isPreSub(),this._gateway.isPreallocation=()=>"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation(),this._gateway.on(Xt.IS_P2P_DISCONNECTED,(e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)})),this._gateway.on(Xt.REQUEST_P2P_CONNECTION_PARAMS,(async(e,t,n)=>{try{let i=await this._p2pChannel.getEstablishParams();i&&"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation()||(i=await this._p2pChannel.startP2PConnection(e)),t(i)}catch(i){n(i)}})),this._gateway.on(Xt.JOIN_RESPONSE,((e,t)=>{if(this.store.useP2P)return;let n;this._joinResponse=e,e.attributes?n=e.attributes.userAttributes.preSubSsrcs:S.debug("no attributes in joinResponse");const i=bP(e.ortc,t,n);this._p2pChannel.connect(i)})),this._gateway.on(Xt.PRE_CONNECT_PC,(async(e,t,n)=>{const{candidates:i,fingerprint:r,turnServer:s}=e;if(this._joinInfo&&i.length>0&&!this._p2pChannel.isPlanB){const{cert:a,cid:c}=this._joinInfo.apResponse,u="".concat(c,"_").concat(a);if(u.length<4||u.length>256)return void S.debug("[".concat(this._clientId,"] ufrag length is not valid, length: ").concat(u.length));await this._p2pChannel.startP2PConnection({turnServer:s,cloudProxyServer:this._joinInfo.cloudProxyServer,isPreallocation:!0});try{var o;t(await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(c,"_").concat(a),icePwd:"".concat(c,"_").concat(a)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(o=I("FINGERPRINT"))!==null&&o!==void 0?o:r}]},candidates:i,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0}))}catch(p){p.code&&p.code===N.EXCHANGE_SDP_FAILED&&await this._p2pChannel.startP2PConnection({turnServer:s,cloudProxyServer:this._joinInfo.cloudProxyServer},!0),n(p)}}})),this._gateway.on(Xt.VOS_FALLBACK,(e=>{e==="fallback_hls"&&this.safeEmit(Ye.FALLBACK_TO_HLS,QE.VOSERROR)})),this._gateway.on(Xt.RESET_SIGNAL,(()=>{this._p2pChannel instanceof Ba&&this._p2pChannel.fallbackConnection(),this._handleGatewaySignalEvents()})),this._gateway.on(Xt.DATACHANNEL_FAILBACK,(()=>{Se.reportApiInvoke(this._sessionId,{name:xt.DATACHANNEL_FAILBACK,options:{},tag:Ct.TRACER}).onSuccess(),this._joinGateway()}))}_handleGatewaySignalEvents(){this._gateway.signal.on(Le.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Le.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Le.ON_ADD_AUDIO_STREAM,(e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc))),this._gateway.signal.on(Le.ON_ADD_VIDEO_STREAM,(e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc,e.rtxSsrcId))),this._gateway.signal.on(Le.ON_REMOTE_DATASTREAM_UPDATE,(e=>{this._handleUpdateDataChannel(e)})),this._gateway.signal.on(Le.ON_REMOTE_FULL_DATASTREAM_INFO,(e=>{this._handleUpdateDataChannel({added:e.datastreams||[],deleted:[]},!0)})),this._gateway.signal.on(Le.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Le.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Le.MUTE_AUDIO,(e=>this._handleMuteStream(e.uid,_e.AUDIO,!0))),this._gateway.signal.on(Le.UNMUTE_AUDIO,(e=>this._handleMuteStream(e.uid,_e.AUDIO,!1))),this._gateway.signal.on(Le.MUTE_VIDEO,(e=>this._handleMuteStream(e.uid,_e.VIDEO,!0))),this._gateway.signal.on(Le.UNMUTE_VIDEO,(e=>this._handleMuteStream(e.uid,_e.VIDEO,!1))),this._gateway.signal.on(Le.RECEIVE_METADATA,(e=>{const t=Ca(e.metadata);this.safeEmit(Ye.RECEIVE_METADATA,e.uid,t)})),this._gateway.signal.on(Le.ON_DATA_STREAM,(async e=>{var t;if(!e)return;let n=Ca(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&ie(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)){if(e.payload.length<td)throw new Y(N.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(td));n=await(async function(s,o,a){const c=a.subarray(0,td),u=c.slice(8,td),p=(u[0]<<8)+u[1],m=(c[6]<<8)+c[7],_=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:s,tagLength:IO,additionalData:new Uint8Array(_O(p,2))},o,a.subarray(td));return new Uint8Array(_).subarray(0,m)})(this._encryptDataStreamIv,this._encryptDataStreamKey,n)}let i=0;if(e.ordered||e.syncWithAudio){const r=this._p2pChannel.getStats(),s=this.remoteUsers.find((a=>a.uid===e.uid)),o=r?.audioRecv.find((a=>a.ssrc===s?._audioSSRC));i=o?.jitterBufferMs}(i==null||Number.isNaN(i))&&(i=0),Oq(Dr(Dr({},e),{},{payload:n}),i,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(Le.ON_CRYPT_ERROR,(()=>{wo((()=>{S.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Ye.CRYPT_ERROR)}),this._sessionId)})),this._gateway.signal.on(Le.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Le.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{S.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Ze.TOKEN_EXPIRE),this.safeEmit(Ye.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()})),this._gateway.signal.on(Le.ON_STREAM_FALLBACK_UPDATE,(e=>{S.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(Ye.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")})),this._gateway.signal.on(Le.ENABLE_MULTI_STREAM,(e=>{this._dualStreamMode===Xc.AUTO_SIMULCAST_STREAM&&this.enableDualStream().catch((t=>{S.debug("[".concat(this._clientId,"] set dual stream mode error"),t.toString())}))})),this._gateway.signal.on(Le.ON_PUBLISH_STREAM,(e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),S.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))})),this._gateway.signal.on(Le.ENABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)})),this._gateway.signal.on(Le.DISABLE_LOCAL_VIDEO,(e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)})),this._gateway.signal.on(Te.REQUEST_TIMEOUT,((e,t)=>{if(this._joinInfo)switch(e){case Ce.PUBLISH:{if(!t)return;const r=t.ortc;if(r){var n,i;const s=r.some((c=>{let{stream_type:u}=c;return u===_t.Audio})),o=r.some((c=>{let{stream_type:u}=c;return u!==_t.Audio})),a=r.some((c=>{let{stream_type:u}=c;return u===_t.Screen||u===_t.ScreenLow}));t.state==="offer"&&Se.publish(this._joinInfo.sid,{eventElapse:Fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:N.TIMEOUT,audio:s,video:o,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:s?(n=r.find((c=>{let{stream_type:u}=c;return u===_t.Audio})))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:o?(i=r.find((c=>{let{stream_type:u}=c;return u!==_t.Audio})))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0})}break}case Ce.SUBSCRIBE:t&&Se.subscribe(this._joinInfo.sid,{succ:!1,ec:N.TIMEOUT,audio:t.stream_type===_e.AUDIO,video:t.stream_type===_e.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:Fn.measureFromSubscribeStart(this.store.clientId,t.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(t.ssrcId)})}})),this._gateway.signal.on(Le.ON_P2P_OK,(e=>{this.uid,this._uid})),this._gateway.signal.on(Le.ON_PUBLISHED_USER_LIST,(e=>{if(e==null||!e.users)return;I("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter((i=>!xa(i.string_id||i.stream_id,this.channelName))));const t=[],n=[];for(const i of e.users){let r=this._users.find((p=>p._uintid===i.stream_id));r?r._trust_in_room_=!0:(r=new ko(i.string_id||i.stream_id,i.stream_id),this._users.push(r),this.store.firstVideoFrameDecoded(r.uid,{userJoinNotify:Date.now()}),this.getListeners(Ye.PUBLISHED_USER_LIST).length===0&&(S.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(Ye.USER_JOINED,r)));const s=yn.Audio&i.stream_type,o=(yn.Video|yn.LwoVideo)&i.stream_type,a=(65280&i.stream_type)!=0,c=s&&r.hasAudio,u=o&&r.hasVideo;o&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=i.video_ssrc,r._rtxSsrcId=i.video_rtx),s&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=i.audio_ssrc),s&&!c&&this.getListeners(Ye.PUBLISHED_USER_LIST).length===0&&(S.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(Ye.USER_PUBLISHED,r,"audio")),o&&!u&&this.getListeners(Ye.PUBLISHED_USER_LIST).length===0&&(S.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(Ye.USER_PUBLISHED,r,"video")),(s&&!c||o&&!u||a)&&t.push(r),o&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&n.push({user:r,mediaType:"video"}),s&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&n.push({user:r,mediaType:"audio"})}n.length>0&&(S.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map((i=>"user: ".concat(i.user.uid,", mediaType: ").concat(i.mediaType))).join("; ")," ")),this.massSubscribe(n).catch((i=>{S.error("[".concat(this._clientId,"] mass resubscribe error"),i.toString())}))),this.getListeners(Ye.PUBLISHED_USER_LIST).length>0?I("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(S.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map((i=>i.uid)).join(", "))),this.safeEmit(Ye.PUBLISHED_USER_LIST,t)):S.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map((i=>i.uid)).join(", ")))})),this._gateway.signal.on(Le.ON_RTP_CAPABILITY_CHANGE,(e=>{const{video_codec:t}=e;if(this._p2pChannel instanceof Ba){if(this.role==="audience"&&I("UPDATE_RTP_CAP_IN_HOST"))return this._pendingRtpCapabilityChange=e,void S.debug("[".concat(this._clientId,"] no need to change rtp capability because of audience, params: ").concat(JSON.stringify(e)));this._p2pChannel.updateRemoteRTPCapabilities(t.map((n=>n.toLowerCase())).filter((n=>{var i;return ie(i=Object.keys(Aa)).call(i,n)})))}})),this._gateway.signal.on(Te.VOS_FALLBACK_PROMISE,(async(e,t,n)=>{if(e==="FALLBACKCN"&&I("ENABLE_QUALITY_FALLBACK")){if(!this._joinInfo)return n(new Y(N.UNEXPECTED_ERROR,"can not recover, no join info"));S.info("[".concat(this._clientId,"] try fallback to cn, start request new server info"));const r=this._joinInfo.apRequestDetail;try{this._joinInfo.apRequestDetail=e;const s=await dm(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||$t,this.store);if(I("QUALITY_FALLBACK_REHEARSAL"))return Se.reportApiInvoke(this._sessionId,{name:xt.VOS_FALLBACK_CN,options:{cur:s.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:Ct.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r,void n();this._fallbackServerInfo=s,t()}catch(s){var i;const o=s==null||(i=s.data)===null||i===void 0?void 0:i.desc;I("QUALITY_FALLBACK_REHEARSAL")?(Se.reportApiInvoke(this._sessionId,{name:xt.VOS_FALLBACK_CN,options:{cur:"failed, errorReason: "+o||"unknown",prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:Ct.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=r):Array.isArray(o)&&ie(o).call(o,"request downgrade fallback")&&this.safeEmit(Ye.FALLBACK_TO_HLS,QE.AP_ERROR),n(s)}}else n()}))}_handleP2PEvents(){this._gateway.signal.on(Le.ON_USER_OFFLINE,(()=>{this._p2pChannel.disconnectForReconnect()})),this._gateway.signal.on(Jt.PUBLISH,((e,t,n)=>{const{uid:i}=e;e.forEach((r=>{const{kind:s,ssrcs:o,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(s,i,o[0].ssrcId,a);const u=this._users.find((p=>p.uid===i));return u&&this.store.useP2P?this._p2pChannel.mockSubscribe(u,s,o[0].ssrcId,a).then((()=>{t()})).catch(n):t(),this._handleMuteStream(i,s,!!c)}))})),this._gateway.signal.on(Jt.CALL,(async(e,t,n)=>{if(this.store.useP2P)try{var i;t(await this._p2pChannel.startP2P({turnServer:(i=this._joinInfo)===null||i===void 0?void 0:i.turnServer},e))}catch(r){n(r)}})),this._gateway.signal.on(Te.P2P_CONNECTION,(async e=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(e)})),this._gateway.signal.on(Jt.UNPUBLISH,(async(e,t,n)=>{if(this.store.useP2P){const{unpubMsg:i,uid:r}=e,s=this._users.find((o=>o.uid===r));if(!s)return S.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void t();try{i.forEach((async o=>{let{stream_type:a}=o;const c=a===_t.Audio?_e.AUDIO:_e.VIDEO;await this._p2pChannel.unsubscribe(s,c),this._handleMuteStream(r,c,!0)})),t()}catch(o){n(o)}}})),this._gateway.signal.on(Jt.CONTROL,(async(e,t)=>{const{action:n}=e;switch(n){case Do.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,_e.VIDEO,!0);break;case Do.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,_e.AUDIO,!0);break;case Do.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,_e.VIDEO,!1);break;case Do.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,_e.AUDIO,!1)}})),this._gateway.signal.on(Jt.RESTART_ICE,(async(e,t,n)=>{if(this.store.useP2P)try{const{direction:i,iceParameter:r}=e;i!==ai.SEND_ONLY||r?t(await this._p2pChannel.restartICE(i,r)):(this._p2pChannel.handleDisconnect(i),t())}catch(i){n(i)}})),this._gateway.signal.on(Jt.CANDIDATE,(e=>{if(this.store.useP2P){const{candidate:t,direction:n}=e;this._p2pChannel.addRemoteCandidate(t,n)}})),this._p2pChannel.on(be.RequestP2PRestartICE,(async(e,t,n)=>{try{const{direction:i}=e;t(await this._gateway.sendExtensionMessage(Jt.RESTART_ICE,e,i===ai.SEND_ONLY))}catch(i){n(i)}})),this._p2pChannel.on(be.LocalCandidate,(e=>{this._gateway.sendExtensionMessage(Jt.CANDIDATE,JSON.stringify(e),!0)})),this._p2pChannel.on(be.RequestP2PMuteLocal,(async(e,t,n)=>{try{await this._gateway.sendExtensionMessage(Jt.CONTROL,e,!0),t()}catch(i){n(i)}})),this._p2pChannel.on(be.RequestP2PUnmuteRemote,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===N.DISCONNECT_P2P?t():n(i)}else t()})),this._p2pChannel.on(be.RequestP2PMuteRemote,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===N.DISCONNECT_P2P?t():n(i)}else t()})),this._p2pChannel.on(be.StateChange,((e,t)=>{t===ut.Connected&&this._p2pChannel.republish()}))}_handleP2PChannelEvents(){this._p2pChannel.on(be.PeerConnectionStateChange,(e=>{const t=this._peerConnectionState;e!==t&&(this.safeEmit(Ye.PEERCONNECTION_STATE_CHANGE,e,t),this._peerConnectionState=e)})),this._p2pChannel.on(be.RequestMuteLocal,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===N.DISCONNECT_P2P?t():n(i)}else t()})),this._p2pChannel.on(be.RequestUnmuteLocal,(async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===N.DISCONNECT_P2P?t():n(i)}else t()})),this._p2pChannel.on(be.RequestRePublish,((e,t,n)=>{this.publish(e,!1).then(t).catch(n)})),this._p2pChannel.on(be.RequestRePublishDataChannel,((e,t,n)=>{de.all(e.map((async i=>{const r=await this._p2pChannel.publishDataChannel([i]);try{r.forEach((s=>{this._uid&&this._gateway.publishDataChannel(this._uid,s,!0)}))}catch(s){if(s.code!==N.DISCONNECT_P2P)throw s}}))).then(t).catch(n)})),this._p2pChannel.on(be.RequestReSubscribe,(async(e,t,n)=>{try{for(const{user:i,kind:r}of e)r===_e.VIDEO?await this.subscribe(i,"video"):await this.subscribe(i,"audio");t()}catch(i){n(i)}})),this._p2pChannel.on(be.RequestUpload,((e,t)=>{this._gateway.upload(e,t)})),this._p2pChannel.on(be.RequestUploadStats,(e=>{this._gateway.uploadWRTCStats(e)})),this._p2pChannel.on(be.MediaReconnectStart,(e=>{this.safeEmit(Ye.MEDIA_RECONNECT_START,e)})),this._p2pChannel.on(be.MediaReconnectEnd,(e=>{this.safeEmit(Ye.MEDIA_RECONNECT_END,e)})),this._p2pChannel.on(be.NeedSignalRTT,(e=>{e(this._gateway.getSignalRTT())})),this._p2pChannel.on(be.RequestRestartICE,(async e=>{if(this.store.useP2P)return;const t=await this._p2pChannel.restartICE(e),n=await t.next();if(n.done)return;const i=n.value;let r;try{r=await this._gateway.restartICE({iceParameters:i})}catch(o){return void t.throw(o)}const{iceParameters:s}=(function(o){const a=o.iceParameters;return{iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}})(r);await t.next({remoteIceParameters:s})})),this._p2pChannel.on(be.RequestReconnect,(async()=>{this._gateway.reconnect()})),this._p2pChannel.on(be.RequestReconnectPC,(async()=>{var e;const{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:r,gatewayAddress:s}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:n,rtpCapabilities:i}),o=bP(r,s);await this._p2pChannel.connect(o),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()})),this._p2pChannel.on(be.RequestUnpublishForReconnectPC,(async(e,t,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),t()):n()})),this._p2pChannel.on(be.P2PLost,(()=>{this.safeEmit(Ye.P2P_LOST,this.store.uid)})),this._p2pChannel.on(be.UpdateVideoEncoder,(e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)})),this._p2pChannel.on(be.ConnectionTypeChange,(e=>{this.safeEmit(Ye.IS_USING_CLOUD_PROXY,e),this._gateway.setUsingProxy(e)})),this._p2pChannel.on(be.FirstVideoBufferReady,((e,t)=>{this.safeEmit(Ye.FIRST_VIDEO_BUFFER_READY,e,t)})),this._p2pChannel.on(be.FirstVideoPreRender,((e,t)=>{this.safeEmit(Ye.FIRST_VIDEO_PRE_RENDER,e,t)})),this._p2pChannel.on(be.RequestLowStreamParameter,(e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})})),this._p2pChannel.on(be.QueryClientConnectionState,(e=>{e(this.connectionState)})),this._p2pChannel.on(be.AudioMetadata,(e=>{this.safeEmit(Ye.AUDIO_METADATA,e)})),this._p2pChannel.on(be.AudioPts,(e=>{this.safeEmit(Ye.AUDIO_PTS,Number(e))}))}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new Y(N.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new Y(N.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const n=(t={config:e},Zr("ContentInspect").create(t));this._inspect=n,this.handleVideoInspectEvents(n);const{appId:i,cname:r,sid:s,token:o,uid:a,cid:c,vid:u}=this._joinInfo;await n.init({appId:i,areaCode:"",cname:r,sid:s,token:o,uid:a,cid:c,vid:u?Number(u):0},$t)}catch(n){throw Array.isArray(n)?n[0]:n}var t}handleVideoInspectEvents(e){e.on(wn.CONNECTION_STATE_CHANGE,((t,n)=>{if(this.safeEmit(Ye.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,n),n===wr.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(Ye.CONTENT_INSPECT_ERROR,new Y(N.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}})),e.on(wn.INSPECT_RESULT,((t,n)=>{var i;if(n?.code===N.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return S.debug("Stop inspect content because that has left channel"),this==null||(i=this._inspect)===null||i===void 0||i.close(),void(this._inspect=void 0);this.safeEmit(Ye.CONTENT_INSPECT_RESULT,t,n)})),e.on(wn.CLIENT_LOCAL_VIDEO_TRACK,(t=>{t(this.localTracks.filter((n=>n.trackMediaType==="video"))[0])}))}async disableContentInspect(){if(!this._inspect)throw new Y(N.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(Tr(e,"enabled"),e){if(!t)throw new Y(N.INVALID_PARAMS,"config is required");if(jL(t),!this._joinInfo)throw new Y(N.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(t);else{const i=(n={config:t},Zr("ImageModeration").create(n));this._moderation=i,this.handleImageModerationEvents(i);const{appId:r,cname:s,sid:o,token:a,uid:c,cid:u,vid:p}=this._joinInfo;await i.init({appId:r,areaCode:"",cname:s,sid:o,token:a,uid:c,cid:u,vid:p?Number(p):0},$t)}}catch(i){throw Array.isArray(i)?i[0]:i}}else{var n;if(!this._moderation)throw new Y(N.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(i){throw Array.isArray(i)?i[0]:i}}}handleImageModerationEvents(e){e.on(Qr.CONNECTION_STATE_CHANGE,((t,n)=>{if(this.safeEmit(Ye.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,n),t===or.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new Y(N.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}})),e.on(Qr.CLIENT_LOCAL_VIDEO_TRACK,(t=>{t(this.localTracks.filter((n=>n.trackMediaType==="video"))[0])}))}setP2PTransport(e){if((function(t){Zt(t,"transport",["default","auto","relay","sd-rtn"])})(e),this.mode!=="p2p")throw new Y(N.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,S.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}getJoinChannelServiceRecords(){return S.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){Tr(e,"enabled"),St("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_setRteInfo(e,t){this.store.rteUrl=e,this.store.rteSid=t}_isPreRender(){return"isPreRender"in this._p2pChannel&&this._p2pChannel.isPreRender()}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}},le(me.prototype,"leave",[FL],Object.getOwnPropertyDescriptor(me.prototype,"leave"),me.prototype),le(me.prototype,"publish",[BL],Object.getOwnPropertyDescriptor(me.prototype,"publish"),me.prototype),le(me.prototype,"unpublish",[WL],Object.getOwnPropertyDescriptor(me.prototype,"unpublish"),me.prototype),le(me.prototype,"subscribe",[GL],Object.getOwnPropertyDescriptor(me.prototype,"subscribe"),me.prototype),le(me.prototype,"presubscribe",[HL],Object.getOwnPropertyDescriptor(me.prototype,"presubscribe"),me.prototype),le(me.prototype,"massSubscribe",[KL],Object.getOwnPropertyDescriptor(me.prototype,"massSubscribe"),me.prototype),le(me.prototype,"unsubscribe",[YL],Object.getOwnPropertyDescriptor(me.prototype,"unsubscribe"),me.prototype),le(me.prototype,"massUnsubscribe",[zL],Object.getOwnPropertyDescriptor(me.prototype,"massUnsubscribe"),me.prototype),le(me.prototype,"setLowStreamParameter",[qL],Object.getOwnPropertyDescriptor(me.prototype,"setLowStreamParameter"),me.prototype),le(me.prototype,"setDualStreamMode",[XL],Object.getOwnPropertyDescriptor(me.prototype,"setDualStreamMode"),me.prototype),le(me.prototype,"enableDualStream",[JL],Object.getOwnPropertyDescriptor(me.prototype,"enableDualStream"),me.prototype),le(me.prototype,"disableDualStream",[QL],Object.getOwnPropertyDescriptor(me.prototype,"disableDualStream"),me.prototype),le(me.prototype,"setClientRole",[ZL],Object.getOwnPropertyDescriptor(me.prototype,"setClientRole"),me.prototype),le(me.prototype,"_setClientRoleOptions",[$L],Object.getOwnPropertyDescriptor(me.prototype,"_setClientRoleOptions"),me.prototype),le(me.prototype,"setProxyServer",[ek],Object.getOwnPropertyDescriptor(me.prototype,"setProxyServer"),me.prototype),le(me.prototype,"setTurnServer",[tk],Object.getOwnPropertyDescriptor(me.prototype,"setTurnServer"),me.prototype),le(me.prototype,"setLicense",[nk],Object.getOwnPropertyDescriptor(me.prototype,"setLicense"),me.prototype),le(me.prototype,"startProxyServer",[ik],Object.getOwnPropertyDescriptor(me.prototype,"startProxyServer"),me.prototype),le(me.prototype,"stopProxyServer",[rk],Object.getOwnPropertyDescriptor(me.prototype,"stopProxyServer"),me.prototype),le(me.prototype,"setLocalAccessPointsV2",[sk],Object.getOwnPropertyDescriptor(me.prototype,"setLocalAccessPointsV2"),me.prototype),le(me.prototype,"setLocalAccessPoints",[ok],Object.getOwnPropertyDescriptor(me.prototype,"setLocalAccessPoints"),me.prototype),le(me.prototype,"setRemoteDefaultVideoStreamType",[ak],Object.getOwnPropertyDescriptor(me.prototype,"setRemoteDefaultVideoStreamType"),me.prototype),le(me.prototype,"setRemoteVideoStreamType",[ck],Object.getOwnPropertyDescriptor(me.prototype,"setRemoteVideoStreamType"),me.prototype),le(me.prototype,"setStreamFallbackOption",[dk],Object.getOwnPropertyDescriptor(me.prototype,"setStreamFallbackOption"),me.prototype),le(me.prototype,"setEncryptionConfig",[lk],Object.getOwnPropertyDescriptor(me.prototype,"setEncryptionConfig"),me.prototype),le(me.prototype,"renewToken",[uk],Object.getOwnPropertyDescriptor(me.prototype,"renewToken"),me.prototype),le(me.prototype,"enableAudioVolumeIndicator",[hk],Object.getOwnPropertyDescriptor(me.prototype,"enableAudioVolumeIndicator"),me.prototype),le(me.prototype,"startLiveStreaming",[pk],Object.getOwnPropertyDescriptor(me.prototype,"startLiveStreaming"),me.prototype),le(me.prototype,"setLiveTranscoding",[mk],Object.getOwnPropertyDescriptor(me.prototype,"setLiveTranscoding"),me.prototype),le(me.prototype,"stopLiveStreaming",[fk],Object.getOwnPropertyDescriptor(me.prototype,"stopLiveStreaming"),me.prototype),le(me.prototype,"startChannelMediaRelay",[_k],Object.getOwnPropertyDescriptor(me.prototype,"startChannelMediaRelay"),me.prototype),le(me.prototype,"updateChannelMediaRelay",[gk],Object.getOwnPropertyDescriptor(me.prototype,"updateChannelMediaRelay"),me.prototype),le(me.prototype,"stopChannelMediaRelay",[Ek],Object.getOwnPropertyDescriptor(me.prototype,"stopChannelMediaRelay"),me.prototype),le(me.prototype,"sendCustomReportMessage",[Sk],Object.getOwnPropertyDescriptor(me.prototype,"sendCustomReportMessage"),me.prototype),le(me.prototype,"pickSVCLayer",[yk],Object.getOwnPropertyDescriptor(me.prototype,"pickSVCLayer"),me.prototype),le(me.prototype,"setRTMConfig",[Tk],Object.getOwnPropertyDescriptor(me.prototype,"setRTMConfig"),me.prototype),le(me.prototype,"enableContentInspect",[vk],Object.getOwnPropertyDescriptor(me.prototype,"enableContentInspect"),me.prototype),le(me.prototype,"disableContentInspect",[Rk],Object.getOwnPropertyDescriptor(me.prototype,"disableContentInspect"),me.prototype),le(me.prototype,"setImageModeration",[Ck],Object.getOwnPropertyDescriptor(me.prototype,"setImageModeration"),me.prototype),le(me.prototype,"setP2PTransport",[bk],Object.getOwnPropertyDescriptor(me.prototype,"setP2PTransport"),me.prototype),le(me.prototype,"getJoinChannelServiceRecords",[wk],Object.getOwnPropertyDescriptor(me.prototype,"getJoinChannelServiceRecords"),me.prototype),le(me.prototype,"setPublishAudioFilterEnabled",[Ak],Object.getOwnPropertyDescriptor(me.prototype,"setPublishAudioFilterEnabled"),me.prototype),me);function Ok(){var e;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=mt(5,"client-"),i=Se.reportApiInvoke(null,{id:n,name:xt.CREATE_CLIENT,options:[t],tag:Ct.TRACER});try{(function(r){Zt(r.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Zt(r.mode,"config.mode",["rtc","live","p2p"]),r.audioCodec!==void 0&&Zt(r.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),r.proxyServer!==void 0&&Nn(r.proxyServer,"config.proxyServer",1,1e4),r.turnServer!==void 0&&aO(r.turnServer),r.httpRetryConfig!==void 0&&oO(r.httpRetryConfig),r.websocketRetryConfig!==void 0&&oO(r.websocketRetryConfig)})(t)}catch(r){throw i.onError(r),r}return(z0(16,0,!0)||HE(16,0,!0))&&(t.codec==="vp9"&&(t.codec="vp8",S.debug("browser not support vp9, force use vp8")),St("UNSUPPORTED_VIDEO_CODEC",["vp9"])),t.audioCodec===void 0&&(t.audioCodec="opus"),i.onSuccess(),new Kq(Dr(Dr({forceWaitGatewayResponse:!0},t),{},{role:ie(e=["rtc","p2p"]).call(e,t.mode)?"host":t.role||"audience"}),n)}function Yq(){let e=!1;const t=st();return(t.name===at.CHROME&&Number(t.version)>=58&&(Kr.engine.name!=="WebKit"||(function(){const n=st();if(Ep()){if(n.os===gn.MAC_OS)return!0;if(n.os===gn.IOS){const i=Kr.os.version&&Kr.os.version.split(".");if(i&&Number(i[0])===14&&i[1]&&Number(i[1])>=3||i&&Number(i[0])>14)return!0}}return!1})())||t.name===at.FIREFOX&&Number(t.version)>=56||t.name===at.OPERA&&Number(t.version)>=45||t.name===at.SAFARI&&Number(t.version)>=11||t.name==="WebKit"&&(Yn()||yr())&&t.osVersion&&Number(t.osVersion.split(".")[0])>=11||J0()||st().name===at.QQ)&&(e=!0),e}class nu{constructor(t,n){C(this,"id",0),C(this,"element",void 0),C(this,"peerPair",void 0),C(this,"context",void 0),C(this,"audioPlayerElement",void 0),C(this,"audioTrack",void 0),nu.count+=1,this.id=nu.count,this.element=t,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const n=document.createElement("audio");n.srcObject=new MediaStream([t.track]),n.play(),this.audioPlayerElement=n}}async switchSdp(){if(!this.peerPair)return;const t=async(i,r)=>{const s=r==="offer"?await i.createOffer():await i.createAnswer();return await i.setLocalDescription(s),i.iceGatheringState==="complete"?i.localDescription:new de((o=>{i.onicegatheringstatechange=()=>{i.iceGatheringState==="complete"&&o(i.localDescription)}}))},n=async(i,r)=>await i.setRemoteDescription(r);try{const i=await t(this.peerPair[0],"offer");await n(this.peerPair[1],i);const r=await t(this.peerPair[1],"answer");await n(this.peerPair[0],r)}catch(i){throw new Y(N.LOCAL_AEC_ERROR,i.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let n;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(n)}catch(r){throw new Y(N.LOCAL_AEC_ERROR,r.toString()).print()}if(!n)throw new Y(N.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=n.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,n=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp()}close(){S.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach((t=>{t.close()})),this.peerPair=void 0,this.audioPlayerElement=void 0}}var Nk,vm;C(nu,"count",0);const zq=window.AudioContext||window.webkitAudioContext,qq=new(Nk=Ae({report:Se}),le((vm=class{constructor(){C(this,"units",[]),C(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return S.debug("the system does not need to process local aec"),-1;this.context||(this.context=new zq);let t=this.units.find((n=>n&&n.getElement()===e));return t||(t=new nu(e,this.context),this.units.push(t)),t.startEchoCancellation(),S.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return st().name!==at.SAFARI}}).prototype,"processExternalMediaAEC",[Nk],Object.getOwnPropertyDescriptor(vm.prototype,"processExternalMediaAEC"),vm.prototype),vm);function Dk(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Pk(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?Dk(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Dk(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}const Uy=window||document;function Lk(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!Uy)return;const n=on._cspEventHandlerPointer;if(n&&t)return void console.error(n,t);const i=r=>{if(!(r&&r.blockedURI&&(on.onSecurityPolicyViolation||on.getListeners(Rs.SECURITY_POLICY_VIOLATION).length>0)))return;const s=r.blockedURI;I("CSP_DETECTED_HOSTNAME_LIST").some((o=>ie(s).call(s,o)))&&(on.onSecurityPolicyViolation&&typeof on.onSecurityPolicyViolation=="function"&&on.onSecurityPolicyViolation(r),on.getListeners(Rs.SECURITY_POLICY_VIOLATION).length>0&&on.safeEmit(Rs.SECURITY_POLICY_VIOLATION,r))};n&&Uy.removeEventListener("securitypolicyviolation",n),(t||e&&typeof e=="function"||on.getListeners(Rs.SECURITY_POLICY_VIOLATION).length>0)&&Uy.addEventListener("securitypolicyviolation",i),on._cspEventHandlerPointer=i}var Xq=W,Jq=Jg,kk=RegExp.prototype,Qq=function(e){return e===kk||Xq(kk,e)?Jq(e):e.flags},Zn=y(Qq);function Ad(e){let t=e.length;for(;--t>=0;)e[t]=0}const Vy=256,xk=286,iu=30,ru=15,jy=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Rm=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Zq=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Mk=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),no=new Array(576);Ad(no);const su=new Array(60);Ad(su);const ou=new Array(512);Ad(ou);const au=new Array(256);Ad(au);const Fy=new Array(29);Ad(Fy);const Cm=new Array(iu);function By(e,t,n,i,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=e&&e.length}let Uk,Vk,jk;function Wy(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}Ad(Cm);const Fk=e=>e<256?ou[e]:ou[256+(e>>>7)],cu=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},Xi=(e,t,n)=>{e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,cu(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)},Os=(e,t,n)=>{Xi(e,n[2*t],n[2*t+1])},Bk=(e,t)=>{let n=0;do n|=1&e,e>>>=1,n<<=1;while(--t>0);return n>>>1},Wk=(e,t,n)=>{const i=new Array(16);let r,s,o=0;for(r=1;r<=ru;r++)o=o+n[r-1]<<1,i[r]=o;for(s=0;s<=t;s++){let a=e[2*s+1];a!==0&&(e[2*s]=Bk(i[a]++,a))}},Gk=e=>{let t;for(t=0;t<xk;t++)e.dyn_ltree[2*t]=0;for(t=0;t<iu;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},Hk=e=>{e.bi_valid>8?cu(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},Kk=(e,t,n,i)=>{const r=2*t,s=2*n;return e[r]<e[s]||e[r]===e[s]&&i[t]<=i[n]},Gy=(e,t,n)=>{const i=e.heap[n];let r=n<<1;for(;r<=e.heap_len&&(r<e.heap_len&&Kk(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!Kk(t,i,e.heap[r],e.depth));)e.heap[n]=e.heap[r],n=r,r<<=1;e.heap[n]=i},Yk=(e,t,n)=>{let i,r,s,o,a=0;if(e.sym_next!==0)do i=255&e.pending_buf[e.sym_buf+a++],i+=(255&e.pending_buf[e.sym_buf+a++])<<8,r=e.pending_buf[e.sym_buf+a++],i===0?Os(e,r,t):(s=au[r],Os(e,s+Vy+1,t),o=jy[s],o!==0&&(r-=Fy[s],Xi(e,r,o)),i--,s=Fk(i),Os(e,s,n),o=Rm[s],o!==0&&(i-=Cm[s],Xi(e,i,o)));while(a<e.sym_next);Os(e,256,t)},Hy=(e,t)=>{const n=t.dyn_tree,i=t.stat_desc.static_tree,r=t.stat_desc.has_stree,s=t.stat_desc.elems;let o,a,c,u=-1;for(e.heap_len=0,e.heap_max=573,o=0;o<s;o++)n[2*o]!==0?(e.heap[++e.heap_len]=u=o,e.depth[o]=0):n[2*o+1]=0;for(;e.heap_len<2;)c=e.heap[++e.heap_len]=u<2?++u:0,n[2*c]=1,e.depth[c]=0,e.opt_len--,r&&(e.static_len-=i[2*c+1]);for(t.max_code=u,o=e.heap_len>>1;o>=1;o--)Gy(e,n,o);c=s;do o=e.heap[1],e.heap[1]=e.heap[e.heap_len--],Gy(e,n,1),a=e.heap[1],e.heap[--e.heap_max]=o,e.heap[--e.heap_max]=a,n[2*c]=n[2*o]+n[2*a],e.depth[c]=(e.depth[o]>=e.depth[a]?e.depth[o]:e.depth[a])+1,n[2*o+1]=n[2*a+1]=c,e.heap[1]=c++,Gy(e,n,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((p,m)=>{const _=m.dyn_tree,g=m.max_code,b=m.stat_desc.static_tree,v=m.stat_desc.has_stree,R=m.stat_desc.extra_bits,O=m.stat_desc.extra_base,D=m.stat_desc.max_length;let x,B,G,j,H,Z,ne=0;for(j=0;j<=ru;j++)p.bl_count[j]=0;for(_[2*p.heap[p.heap_max]+1]=0,x=p.heap_max+1;x<573;x++)B=p.heap[x],j=_[2*_[2*B+1]+1]+1,j>D&&(j=D,ne++),_[2*B+1]=j,B>g||(p.bl_count[j]++,H=0,B>=O&&(H=R[B-O]),Z=_[2*B],p.opt_len+=Z*(j+H),v&&(p.static_len+=Z*(b[2*B+1]+H)));if(ne!==0){do{for(j=D-1;p.bl_count[j]===0;)j--;p.bl_count[j]--,p.bl_count[j+1]+=2,p.bl_count[D]--,ne-=2}while(ne>0);for(j=D;j!==0;j--)for(B=p.bl_count[j];B!==0;)G=p.heap[--x],G>g||(_[2*G+1]!==j&&(p.opt_len+=(j-_[2*G+1])*_[2*G],_[2*G+1]=j),B--)}})(e,t),Wk(n,u,e.bl_count)},zk=(e,t,n)=>{let i,r,s=-1,o=t[1],a=0,c=7,u=4;for(o===0&&(c=138,u=3),t[2*(n+1)+1]=65535,i=0;i<=n;i++)r=o,o=t[2*(i+1)+1],++a<c&&r===o||(a<u?e.bl_tree[2*r]+=a:r!==0?(r!==s&&e.bl_tree[2*r]++,e.bl_tree[32]++):a<=10?e.bl_tree[34]++:e.bl_tree[36]++,a=0,s=r,o===0?(c=138,u=3):r===o?(c=6,u=3):(c=7,u=4))},qk=(e,t,n)=>{let i,r,s=-1,o=t[1],a=0,c=7,u=4;for(o===0&&(c=138,u=3),i=0;i<=n;i++)if(r=o,o=t[2*(i+1)+1],!(++a<c&&r===o)){if(a<u)do Os(e,r,e.bl_tree);while(--a!=0);else r!==0?(r!==s&&(Os(e,r,e.bl_tree),a--),Os(e,16,e.bl_tree),Xi(e,a-3,2)):a<=10?(Os(e,17,e.bl_tree),Xi(e,a-3,3)):(Os(e,18,e.bl_tree),Xi(e,a-11,7));a=0,s=r,o===0?(c=138,u=3):r===o?(c=6,u=3):(c=7,u=4)}};let Xk=!1;const Jk=(e,t,n,i)=>{Xi(e,0+(i?1:0),3),Hk(e),cu(e,n),cu(e,~n),n&&e.pending_buf.set(e.window.subarray(t,t+n),e.pending),e.pending+=n};var $q=e=>{Xk||((()=>{let t,n,i,r,s;const o=new Array(16);for(i=0,r=0;r<28;r++)for(Fy[r]=i,t=0;t<1<<jy[r];t++)au[i++]=r;for(au[i-1]=r,s=0,r=0;r<16;r++)for(Cm[r]=s,t=0;t<1<<Rm[r];t++)ou[s++]=r;for(s>>=7;r<iu;r++)for(Cm[r]=s<<7,t=0;t<1<<Rm[r]-7;t++)ou[256+s++]=r;for(n=0;n<=ru;n++)o[n]=0;for(t=0;t<=143;)no[2*t+1]=8,t++,o[8]++;for(;t<=255;)no[2*t+1]=9,t++,o[9]++;for(;t<=279;)no[2*t+1]=7,t++,o[7]++;for(;t<=287;)no[2*t+1]=8,t++,o[8]++;for(Wk(no,287,o),t=0;t<iu;t++)su[2*t+1]=5,su[2*t]=Bk(t,5);Uk=new By(no,jy,257,xk,ru),Vk=new By(su,Rm,0,iu,ru),jk=new By(new Array(0),Zq,0,19,7)})(),Xk=!0),e.l_desc=new Wy(e.dyn_ltree,Uk),e.d_desc=new Wy(e.dyn_dtree,Vk),e.bl_desc=new Wy(e.bl_tree,jk),e.bi_buf=0,e.bi_valid=0,Gk(e)},eX=(e,t,n,i)=>{let r,s,o=0;e.level>0?(e.strm.data_type===2&&(e.strm.data_type=(a=>{let c,u=4093624447;for(c=0;c<=31;c++,u>>>=1)if(1&u&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<Vy;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(e)),Hy(e,e.l_desc),Hy(e,e.d_desc),o=(a=>{let c;for(zk(a,a.dyn_ltree,a.l_desc.max_code),zk(a,a.dyn_dtree,a.d_desc.max_code),Hy(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*Mk[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(e),r=e.opt_len+3+7>>>3,s=e.static_len+3+7>>>3,s<=r&&(r=s)):r=s=n+5,n+4<=r&&t!==-1?Jk(e,t,n,i):e.strategy===4||s===r?(Xi(e,2+(i?1:0),3),Yk(e,no,su)):(Xi(e,4+(i?1:0),3),((a,c,u,p)=>{let m;for(Xi(a,c-257,5),Xi(a,u-1,5),Xi(a,p-4,4),m=0;m<p;m++)Xi(a,a.bl_tree[2*Mk[m]+1],3);qk(a,a.dyn_ltree,c-1),qk(a,a.dyn_dtree,u-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,o+1),Yk(e,e.dyn_ltree,e.dyn_dtree)),Gk(e),i&&Hk(e)},tX=(e,t,n)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=n,t===0?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(au[n]+Vy+1)]++,e.dyn_dtree[2*Fk(t)]++),e.sym_next===e.sym_end),nX=e=>{Xi(e,2,3),Os(e,256,no),(t=>{t.bi_valid===16?(cu(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(e)},iX={_tr_init:$q,_tr_stored_block:Jk,_tr_flush_block:eX,_tr_tally:tX,_tr_align:nX},du=(e,t,n,i)=>{let r=65535&e|0,s=e>>>16&65535|0,o=0;for(;n!==0;){o=n>2e3?2e3:n,n-=o;do r=r+t[i++]|0,s=s+r|0;while(--o);r%=65521,s%=65521}return r|s<<16|0};const rX=new Uint32Array((()=>{let e,t=[];for(var n=0;n<256;n++){e=n;for(var i=0;i<8;i++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t})());var ci=(e,t,n,i)=>{const r=rX,s=i+n;e^=-1;for(let o=i;o<s;o++)e=e>>>8^r[255&(e^t[o])];return-1^e},Ha={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},bm={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:sX,_tr_stored_block:Ky,_tr_flush_block:oX,_tr_tally:Vo,_tr_align:aX}=iX,{Z_NO_FLUSH:jo,Z_PARTIAL_FLUSH:cX,Z_FULL_FLUSH:dX,Z_FINISH:Pr,Z_BLOCK:Qk,Z_OK:gi,Z_STREAM_END:Zk,Z_STREAM_ERROR:Ns,Z_DATA_ERROR:lX,Z_BUF_ERROR:Yy,Z_DEFAULT_COMPRESSION:uX,Z_FILTERED:hX,Z_HUFFMAN_ONLY:wm,Z_RLE:pX,Z_FIXED:mX,Z_DEFAULT_STRATEGY:fX,Z_UNKNOWN:_X,Z_DEFLATED:Am}=bm,zy=286,gX=30,EX=19,SX=2*zy+1,yX=15,Ka=258,Ds=262,Id=42,Ya=113,lu=666,za=(e,t)=>(e.msg=Ha[t],t),$k=e=>2*e-(e>4?9:0),Fo=e=>{let t=e.length;for(;--t>=0;)e[t]=0},TX=e=>{let t,n,i,r=e.w_size;t=e.hash_size,i=t;do n=e.head[--i],e.head[i]=n>=r?n-r:0;while(--t);t=r,i=t;do n=e.prev[--i],e.prev[i]=n>=r?n-r:0;while(--t)};let Bo=(e,t,n)=>(t<<e.hash_shift^n)&e.hash_mask;const ar=e=>{const t=e.state;let n=t.pending;n>e.avail_out&&(n=e.avail_out),n!==0&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+n),e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,t.pending===0&&(t.pending_out=0))},cr=(e,t)=>{oX(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,ar(e.strm)},qt=(e,t)=>{e.pending_buf[e.pending++]=t},uu=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},qy=(e,t,n,i)=>{let r=e.avail_in;return r>i&&(r=i),r===0?0:(e.avail_in-=r,t.set(e.input.subarray(e.next_in,e.next_in+r),n),e.state.wrap===1?e.adler=du(e.adler,t,r,n):e.state.wrap===2&&(e.adler=ci(e.adler,t,r,n)),e.next_in+=r,e.total_in+=r,r)},ex=(e,t)=>{let n,i,r=e.max_chain_length,s=e.strstart,o=e.prev_length,a=e.nice_match;const c=e.strstart>e.w_size-Ds?e.strstart-(e.w_size-Ds):0,u=e.window,p=e.w_mask,m=e.prev,_=e.strstart+Ka;let g=u[s+o-1],b=u[s+o];e.prev_length>=e.good_match&&(r>>=2),a>e.lookahead&&(a=e.lookahead);do if(n=t,u[n+o]===b&&u[n+o-1]===g&&u[n]===u[s]&&u[++n]===u[s+1]){s+=2,n++;do;while(u[++s]===u[++n]&&u[++s]===u[++n]&&u[++s]===u[++n]&&u[++s]===u[++n]&&u[++s]===u[++n]&&u[++s]===u[++n]&&u[++s]===u[++n]&&u[++s]===u[++n]&&s<_);if(i=Ka-(_-s),s=_-Ka,i>o){if(e.match_start=t,o=i,i>=a)break;g=u[s+o-1],b=u[s+o]}}while((t=m[t&p])>c&&--r!=0);return o<=e.lookahead?o:e.lookahead},Od=e=>{const t=e.w_size;let n,i,r;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-Ds)&&(e.window.set(e.window.subarray(t,t+t-i),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),TX(e),i+=t),e.strm.avail_in===0)break;if(n=qy(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=n,e.lookahead+e.insert>=3)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=Bo(e,e.ins_h,e.window[r+1]);e.insert&&(e.ins_h=Bo(e,e.ins_h,e.window[r+3-1]),e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Ds&&e.strm.avail_in!==0)},tx=(e,t)=>{let n,i,r,s=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,o=0,a=e.strm.avail_in;do{if(n=65535,r=e.bi_valid+42>>3,e.strm.avail_out<r||(r=e.strm.avail_out-r,i=e.strstart-e.block_start,n>i+e.strm.avail_in&&(n=i+e.strm.avail_in),n>r&&(n=r),n<s&&(n===0&&t!==Pr||t===jo||n!==i+e.strm.avail_in)))break;o=t===Pr&&n===i+e.strm.avail_in?1:0,Ky(e,0,0,o),e.pending_buf[e.pending-4]=n,e.pending_buf[e.pending-3]=n>>8,e.pending_buf[e.pending-2]=~n,e.pending_buf[e.pending-1]=~n>>8,ar(e.strm),i&&(i>n&&(i=n),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+i),e.strm.next_out),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i,e.block_start+=i,n-=i),n&&(qy(e.strm,e.strm.output,e.strm.next_out,n),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n)}while(o===0);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),o?4:t!==jo&&t!==Pr&&e.strm.avail_in===0&&e.strstart===e.block_start?2:(r=e.window_size-e.strstart,e.strm.avail_in>r&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,r+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),r>e.strm.avail_in&&(r=e.strm.avail_in),r&&(qy(e.strm,e.window,e.strstart,r),e.strstart+=r,e.insert+=r>e.w_size-e.insert?e.w_size-e.insert:r),e.high_water<e.strstart&&(e.high_water=e.strstart),r=e.bi_valid+42>>3,r=e.pending_buf_size-r>65535?65535:e.pending_buf_size-r,s=r>e.w_size?e.w_size:r,i=e.strstart-e.block_start,(i>=s||(i||t===Pr)&&t!==jo&&e.strm.avail_in===0&&i<=r)&&(n=i>r?r:i,o=t===Pr&&e.strm.avail_in===0&&n===i?1:0,Ky(e,e.block_start,n,o),e.block_start+=n,ar(e.strm)),o?3:1)},Xy=(e,t)=>{let n,i;for(;;){if(e.lookahead<Ds){if(Od(e),e.lookahead<Ds&&t===jo)return 1;if(e.lookahead===0)break}if(n=0,e.lookahead>=3&&(e.ins_h=Bo(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),n!==0&&e.strstart-n<=e.w_size-Ds&&(e.match_length=ex(e,n)),e.match_length>=3)if(i=Vo(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do e.strstart++,e.ins_h=Bo(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!=0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=Bo(e,e.ins_h,e.window[e.strstart+1]);else i=Vo(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(cr(e,!1),e.strm.avail_out===0))return 1}return e.insert=e.strstart<2?e.strstart:2,t===Pr?(cr(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(cr(e,!1),e.strm.avail_out===0)?1:2},Nd=(e,t)=>{let n,i,r;for(;;){if(e.lookahead<Ds){if(Od(e),e.lookahead<Ds&&t===jo)return 1;if(e.lookahead===0)break}if(n=0,e.lookahead>=3&&(e.ins_h=Bo(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,n!==0&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-Ds&&(e.match_length=ex(e,n),e.match_length<=5&&(e.strategy===hX||e.match_length===3&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-3,i=Vo(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=r&&(e.ins_h=Bo(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!=0);if(e.match_available=0,e.match_length=2,e.strstart++,i&&(cr(e,!1),e.strm.avail_out===0))return 1}else if(e.match_available){if(i=Vo(e,0,e.window[e.strstart-1]),i&&cr(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=Vo(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===Pr?(cr(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(cr(e,!1),e.strm.avail_out===0)?1:2};function Ps(e,t,n,i,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=r}const hu=[new Ps(0,0,0,0,tx),new Ps(4,4,8,4,Xy),new Ps(4,5,16,8,Xy),new Ps(4,6,32,32,Xy),new Ps(4,4,16,16,Nd),new Ps(8,16,32,32,Nd),new Ps(8,16,128,128,Nd),new Ps(8,32,128,256,Nd),new Ps(32,128,258,1024,Nd),new Ps(32,258,258,4096,Nd)];function vX(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Am,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*SX),this.dyn_dtree=new Uint16Array(2*(2*gX+1)),this.bl_tree=new Uint16Array(2*(2*EX+1)),Fo(this.dyn_ltree),Fo(this.dyn_dtree),Fo(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(yX+1),this.heap=new Uint16Array(2*zy+1),Fo(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*zy+1),Fo(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const pu=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==Id&&t.status!==57&&t.status!==69&&t.status!==73&&t.status!==91&&t.status!==103&&t.status!==Ya&&t.status!==lu?1:0},nx=e=>{if(pu(e))return za(e,Ns);e.total_in=e.total_out=0,e.data_type=_X;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?57:t.wrap?Id:Ya,e.adler=t.wrap===2?0:1,t.last_flush=-2,sX(t),gi},ix=e=>{const t=nx(e);return t===gi&&(n=>{n.window_size=2*n.w_size,Fo(n.head),n.max_lazy_match=hu[n.level].max_lazy,n.good_match=hu[n.level].good_length,n.nice_match=hu[n.level].nice_length,n.max_chain_length=hu[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0})(e.state),t},rx=(e,t,n,i,r,s)=>{if(!e)return Ns;let o=1;if(t===uX&&(t=6),i<0?(o=0,i=-i):i>15&&(o=2,i-=16),r<1||r>9||n!==Am||i<8||i>15||t<0||t>9||s<0||s>mX||i===8&&o!==1)return za(e,Ns);i===8&&(i=9);const a=new vX;return e.state=a,a.strm=e,a.status=Id,a.wrap=o,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=t,a.strategy=s,a.method=n,ix(e)};var RX=(e,t)=>{if(pu(e)||t>Qk||t<0)return e?za(e,Ns):Ns;const n=e.state;if(!e.output||e.avail_in!==0&&!e.input||n.status===lu&&t!==Pr)return za(e,e.avail_out===0?Yy:Ns);const i=n.last_flush;if(n.last_flush=t,n.pending!==0){if(ar(e),e.avail_out===0)return n.last_flush=-1,gi}else if(e.avail_in===0&&$k(t)<=$k(i)&&t!==Pr)return za(e,Yy);if(n.status===lu&&e.avail_in!==0)return za(e,Yy);if(n.status===Id&&n.wrap===0&&(n.status=Ya),n.status===Id){let r=Am+(n.w_bits-8<<4)<<8,s=-1;if(s=n.strategy>=wm||n.level<2?0:n.level<6?1:n.level===6?2:3,r|=s<<6,n.strstart!==0&&(r|=32),r+=31-r%31,uu(n,r),n.strstart!==0&&(uu(n,e.adler>>>16),uu(n,65535&e.adler)),e.adler=1,n.status=Ya,ar(e),n.pending!==0)return n.last_flush=-1,gi}if(n.status===57){if(e.adler=0,qt(n,31),qt(n,139),qt(n,8),n.gzhead)qt(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),qt(n,255&n.gzhead.time),qt(n,n.gzhead.time>>8&255),qt(n,n.gzhead.time>>16&255),qt(n,n.gzhead.time>>24&255),qt(n,n.level===9?2:n.strategy>=wm||n.level<2?4:0),qt(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(qt(n,255&n.gzhead.extra.length),qt(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=ci(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(qt(n,0),qt(n,0),qt(n,0),qt(n,0),qt(n,0),qt(n,n.level===9?2:n.strategy>=wm||n.level<2?4:0),qt(n,3),n.status=Ya,ar(e),n.pending!==0)return n.last_flush=-1,gi}if(n.status===69){if(n.gzhead.extra){let r=n.pending,s=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+s>n.pending_buf_size;){let a=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>r&&(e.adler=ci(e.adler,n.pending_buf,n.pending-r,r)),n.gzindex+=a,ar(e),n.pending!==0)return n.last_flush=-1,gi;r=0,s-=a}let o=new Uint8Array(n.gzhead.extra);n.pending_buf.set(o.subarray(n.gzindex,n.gzindex+s),n.pending),n.pending+=s,n.gzhead.hcrc&&n.pending>r&&(e.adler=ci(e.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0}n.status=73}if(n.status===73){if(n.gzhead.name){let r,s=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>s&&(e.adler=ci(e.adler,n.pending_buf,n.pending-s,s)),ar(e),n.pending!==0)return n.last_flush=-1,gi;s=0}r=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,qt(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>s&&(e.adler=ci(e.adler,n.pending_buf,n.pending-s,s)),n.gzindex=0}n.status=91}if(n.status===91){if(n.gzhead.comment){let r,s=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>s&&(e.adler=ci(e.adler,n.pending_buf,n.pending-s,s)),ar(e),n.pending!==0)return n.last_flush=-1,gi;s=0}r=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,qt(n,r)}while(r!==0);n.gzhead.hcrc&&n.pending>s&&(e.adler=ci(e.adler,n.pending_buf,n.pending-s,s))}n.status=103}if(n.status===103){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(ar(e),n.pending!==0))return n.last_flush=-1,gi;qt(n,255&e.adler),qt(n,e.adler>>8&255),e.adler=0}if(n.status=Ya,ar(e),n.pending!==0)return n.last_flush=-1,gi}if(e.avail_in!==0||n.lookahead!==0||t!==jo&&n.status!==lu){let r=n.level===0?tx(n,t):n.strategy===wm?((s,o)=>{let a;for(;;){if(s.lookahead===0&&(Od(s),s.lookahead===0)){if(o===jo)return 1;break}if(s.match_length=0,a=Vo(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++,a&&(cr(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===Pr?(cr(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(cr(s,!1),s.strm.avail_out===0)?1:2})(n,t):n.strategy===pX?((s,o)=>{let a,c,u,p;const m=s.window;for(;;){if(s.lookahead<=Ka){if(Od(s),s.lookahead<=Ka&&o===jo)return 1;if(s.lookahead===0)break}if(s.match_length=0,s.lookahead>=3&&s.strstart>0&&(u=s.strstart-1,c=m[u],c===m[++u]&&c===m[++u]&&c===m[++u])){p=s.strstart+Ka;do;while(c===m[++u]&&c===m[++u]&&c===m[++u]&&c===m[++u]&&c===m[++u]&&c===m[++u]&&c===m[++u]&&c===m[++u]&&u<p);s.match_length=Ka-(p-u),s.match_length>s.lookahead&&(s.match_length=s.lookahead)}if(s.match_length>=3?(a=Vo(s,1,s.match_length-3),s.lookahead-=s.match_length,s.strstart+=s.match_length,s.match_length=0):(a=Vo(s,0,s.window[s.strstart]),s.lookahead--,s.strstart++),a&&(cr(s,!1),s.strm.avail_out===0))return 1}return s.insert=0,o===Pr?(cr(s,!0),s.strm.avail_out===0?3:4):s.sym_next&&(cr(s,!1),s.strm.avail_out===0)?1:2})(n,t):hu[n.level].func(n,t);if(r!==3&&r!==4||(n.status=lu),r===1||r===3)return e.avail_out===0&&(n.last_flush=-1),gi;if(r===2&&(t===cX?aX(n):t!==Qk&&(Ky(n,0,0,!1),t===dX&&(Fo(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),ar(e),e.avail_out===0))return n.last_flush=-1,gi}return t!==Pr?gi:n.wrap<=0?Zk:(n.wrap===2?(qt(n,255&e.adler),qt(n,e.adler>>8&255),qt(n,e.adler>>16&255),qt(n,e.adler>>24&255),qt(n,255&e.total_in),qt(n,e.total_in>>8&255),qt(n,e.total_in>>16&255),qt(n,e.total_in>>24&255)):(uu(n,e.adler>>>16),uu(n,65535&e.adler)),ar(e),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?gi:Zk)},CX=(e,t)=>{let n=t.length;if(pu(e))return Ns;const i=e.state,r=i.wrap;if(r===2||r===1&&i.status!==Id||i.lookahead)return Ns;if(r===1&&(e.adler=du(e.adler,t,n,0)),i.wrap=0,n>=i.w_size){r===0&&(Fo(i.head),i.strstart=0,i.block_start=0,i.insert=0);let c=new Uint8Array(i.w_size);c.set(t.subarray(n-i.w_size,n),0),t=c,n=i.w_size}const s=e.avail_in,o=e.next_in,a=e.input;for(e.avail_in=n,e.next_in=0,e.input=t,Od(i);i.lookahead>=3;){let c=i.strstart,u=i.lookahead-2;do i.ins_h=Bo(i,i.ins_h,i.window[c+3-1]),i.prev[c&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=c,c++;while(--u);i.strstart=c,i.lookahead=2,Od(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,e.next_in=o,e.input=a,e.avail_in=s,i.wrap=r,gi},mu={deflateInit:(e,t)=>rx(e,t,Am,15,8,fX),deflateInit2:rx,deflateReset:ix,deflateResetKeep:nx,deflateSetHeader:(e,t)=>pu(e)||e.state.wrap!==2?Ns:(e.state.gzhead=t,gi),deflate:RX,deflateEnd:e=>{if(pu(e))return Ns;const t=e.state.status;return e.state=null,t===Ya?za(e,lX):gi},deflateSetDictionary:CX,deflateInfo:"pako deflate (from Nodeca project)"};const bX=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var Im={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const n=t.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const i in n)bX(n,i)&&(e[i]=n[i])}}return e},flattenChunks:e=>{let t=0;for(let i=0,r=e.length;i<r;i++)t+=e[i].length;const n=new Uint8Array(t);for(let i=0,r=0,s=e.length;i<s;i++){let o=e[i];n.set(o,r),r+=o.length}return n}};let sx=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{sx=!1}const fu=new Uint8Array(256);for(let e=0;e<256;e++)fu[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;fu[254]=fu[254]=1;var _u={string2buf:e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let t,n,i,r,s,o=e.length,a=0;for(r=0;r<o;r++)n=e.charCodeAt(r),(64512&n)==55296&&r+1<o&&(i=e.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Uint8Array(a),s=0,r=0;s<a;r++)n=e.charCodeAt(r),(64512&n)==55296&&r+1<o&&(i=e.charCodeAt(r+1),(64512&i)==56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?t[s++]=n:n<2048?(t[s++]=192|n>>>6,t[s++]=128|63&n):n<65536?(t[s++]=224|n>>>12,t[s++]=128|n>>>6&63,t[s++]=128|63&n):(t[s++]=240|n>>>18,t[s++]=128|n>>>12&63,t[s++]=128|n>>>6&63,t[s++]=128|63&n);return t},buf2string:(e,t)=>{const n=t||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,t));let i,r;const s=new Array(2*n);for(r=0,i=0;i<n;){let o=e[i++];if(o<128){s[r++]=o;continue}let a=fu[o];if(a>4)s[r++]=65533,i+=a-1;else{for(o&=a===2?31:a===3?15:7;a>1&&i<n;)o=o<<6|63&e[i++],a--;a>1?s[r++]=65533:o<65536?s[r++]=o:(o-=65536,s[r++]=55296|o>>10&1023,s[r++]=56320|1023&o)}}return((o,a)=>{if(a<65534&&o.subarray&&sx)return String.fromCharCode.apply(null,o.length===a?o:o.subarray(0,a));let c="";for(let u=0;u<a;u++)c+=String.fromCharCode(o[u]);return c})(s,r)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let n=t-1;for(;n>=0&&(192&e[n])==128;)n--;return n<0||n===0?t:n+fu[e[n]]>t?n:t}},ox=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const ax=Object.prototype.toString,{Z_NO_FLUSH:wX,Z_SYNC_FLUSH:AX,Z_FULL_FLUSH:IX,Z_FINISH:OX,Z_OK:Om,Z_STREAM_END:NX,Z_DEFAULT_COMPRESSION:DX,Z_DEFAULT_STRATEGY:PX,Z_DEFLATED:LX}=bm;function Nm(e){this.options=Im.assign({level:DX,method:LX,chunkSize:16384,windowBits:15,memLevel:8,strategy:PX},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new ox,this.strm.avail_out=0;let n=mu.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==Om)throw new Error(Ha[n]);if(t.header&&mu.deflateSetHeader(this.strm,t.header),t.dictionary){let i;if(i=typeof t.dictionary=="string"?_u.string2buf(t.dictionary):ax.call(t.dictionary)==="[object ArrayBuffer]"?new Uint8Array(t.dictionary):t.dictionary,n=mu.deflateSetDictionary(this.strm,i),n!==Om)throw new Error(Ha[n]);this._dict_set=!0}}function cx(e,t){const n=new Nm(t);if(n.push(e,!0),n.err)throw n.msg||Ha[n.err];return n.result}Nm.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize;let r,s;if(this.ended)return!1;for(s=t===~~t?t:t===!0?OX:wX,typeof e=="string"?n.input=_u.string2buf(e):ax.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;)if(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(s===AX||s===IX)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(r=mu.deflate(n,s),r===NX)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=mu.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===Om;if(n.avail_out!==0){if(s>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(n.avail_in===0)break}else this.onData(n.output)}return!0},Nm.prototype.onData=function(e){this.chunks.push(e)},Nm.prototype.onEnd=function(e){e===Om&&(this.result=Im.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var kX={deflate:cx,deflateRaw:function(e,t){return(t=t||{}).raw=!0,cx(e,t)}};const Dm=16209;var xX=function(e,t){let n,i,r,s,o,a,c,u,p,m,_,g,b,v,R,O,D,x,B,G,j,H,Z,ne;const he=e.state;n=e.next_in,Z=e.input,i=n+(e.avail_in-5),r=e.next_out,ne=e.output,s=r-(t-e.avail_out),o=r+(e.avail_out-257),a=he.dmax,c=he.wsize,u=he.whave,p=he.wnext,m=he.window,_=he.hold,g=he.bits,b=he.lencode,v=he.distcode,R=(1<<he.lenbits)-1,O=(1<<he.distbits)-1;e:do{g<15&&(_+=Z[n++]<<g,g+=8,_+=Z[n++]<<g,g+=8),D=b[_&R];t:for(;;){if(x=D>>>24,_>>>=x,g-=x,x=D>>>16&255,x===0)ne[r++]=65535&D;else{if(!(16&x)){if((64&x)==0){D=b[(65535&D)+(_&(1<<x)-1)];continue t}if(32&x){he.mode=16191;break e}e.msg="invalid literal/length code",he.mode=Dm;break e}B=65535&D,x&=15,x&&(g<x&&(_+=Z[n++]<<g,g+=8),B+=_&(1<<x)-1,_>>>=x,g-=x),g<15&&(_+=Z[n++]<<g,g+=8,_+=Z[n++]<<g,g+=8),D=v[_&O];n:for(;;){if(x=D>>>24,_>>>=x,g-=x,x=D>>>16&255,!(16&x)){if((64&x)==0){D=v[(65535&D)+(_&(1<<x)-1)];continue n}e.msg="invalid distance code",he.mode=Dm;break e}if(G=65535&D,x&=15,g<x&&(_+=Z[n++]<<g,g+=8,g<x&&(_+=Z[n++]<<g,g+=8)),G+=_&(1<<x)-1,G>a){e.msg="invalid distance too far back",he.mode=Dm;break e}if(_>>>=x,g-=x,x=r-s,G>x){if(x=G-x,x>u&&he.sane){e.msg="invalid distance too far back",he.mode=Dm;break e}if(j=0,H=m,p===0){if(j+=c-x,x<B){B-=x;do ne[r++]=m[j++];while(--x);j=r-G,H=ne}}else if(p<x){if(j+=c+p-x,x-=p,x<B){B-=x;do ne[r++]=m[j++];while(--x);if(j=0,p<B){x=p,B-=x;do ne[r++]=m[j++];while(--x);j=r-G,H=ne}}}else if(j+=p-x,x<B){B-=x;do ne[r++]=m[j++];while(--x);j=r-G,H=ne}for(;B>2;)ne[r++]=H[j++],ne[r++]=H[j++],ne[r++]=H[j++],B-=3;B&&(ne[r++]=H[j++],B>1&&(ne[r++]=H[j++]))}else{j=r-G;do ne[r++]=ne[j++],ne[r++]=ne[j++],ne[r++]=ne[j++],B-=3;while(B>2);B&&(ne[r++]=ne[j++],B>1&&(ne[r++]=ne[j++]))}break}}break}}while(n<i&&r<o);B=g>>3,n-=B,g-=B<<3,_&=(1<<g)-1,e.next_in=n,e.next_out=r,e.avail_in=n<i?i-n+5:5-(n-i),e.avail_out=r<o?o-r+257:257-(r-o),he.hold=_,he.bits=g};const Pm=15,MX=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),UX=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),VX=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),jX=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var gu=(e,t,n,i,r,s,o,a)=>{const c=a.bits;let u,p,m,_,g,b,v=0,R=0,O=0,D=0,x=0,B=0,G=0,j=0,H=0,Z=0,ne=null;const he=new Uint16Array(16),De=new Uint16Array(16);let Oe,Ge,Ue,ct=null;for(v=0;v<=Pm;v++)he[v]=0;for(R=0;R<i;R++)he[t[n+R]]++;for(x=c,D=Pm;D>=1&&he[D]===0;D--);if(x>D&&(x=D),D===0)return r[s++]=20971520,r[s++]=20971520,a.bits=1,0;for(O=1;O<D&&he[O]===0;O++);for(x<O&&(x=O),j=1,v=1;v<=Pm;v++)if(j<<=1,j-=he[v],j<0)return-1;if(j>0&&(e===0||D!==1))return-1;for(De[1]=0,v=1;v<Pm;v++)De[v+1]=De[v]+he[v];for(R=0;R<i;R++)t[n+R]!==0&&(o[De[t[n+R]]++]=R);if(e===0?(ne=ct=o,b=20):e===1?(ne=MX,ct=UX,b=257):(ne=VX,ct=jX,b=0),Z=0,R=0,v=O,g=s,B=x,G=0,m=-1,H=1<<x,_=H-1,e===1&&H>852||e===2&&H>592)return 1;for(;;){Oe=v-G,o[R]+1<b?(Ge=0,Ue=o[R]):o[R]>=b?(Ge=ct[o[R]-b],Ue=ne[o[R]-b]):(Ge=96,Ue=0),u=1<<v-G,p=1<<B,O=p;do p-=u,r[g+(Z>>G)+p]=Oe<<24|Ge<<16|Ue|0;while(p!==0);for(u=1<<v-1;Z&u;)u>>=1;if(u!==0?(Z&=u-1,Z+=u):Z=0,R++,--he[v]==0){if(v===D)break;v=t[n+o[R]]}if(v>x&&(Z&_)!==m){for(G===0&&(G=x),g+=O,B=v-G,j=1<<B;B+G<D&&(j-=he[B+G],!(j<=0));)B++,j<<=1;if(H+=1<<B,e===1&&H>852||e===2&&H>592)return 1;m=Z&_,r[m]=x<<24|B<<16|g-s|0}}return Z!==0&&(r[g+Z]=v-G<<24|64<<16|0),a.bits=x,0};const{Z_FINISH:dx,Z_BLOCK:FX,Z_TREES:Lm,Z_OK:qa,Z_STREAM_END:BX,Z_NEED_DICT:WX,Z_STREAM_ERROR:Lr,Z_DATA_ERROR:lx,Z_MEM_ERROR:ux,Z_BUF_ERROR:GX,Z_DEFLATED:hx}=bm,km=16180,xm=16190,io=16191,Jy=16192,Qy=16194,Mm=16199,Um=16200,Zy=16206,In=16209,px=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function HX(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Xa=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<km||t.mode>16211?1:0},mx=e=>{if(Xa(e))return Lr;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=km,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,qa},fx=e=>{if(Xa(e))return Lr;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,mx(e)},_x=(e,t)=>{let n;if(Xa(e))return Lr;const i=e.state;return t<0?(n=0,t=-t):(n=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Lr:(i.window!==null&&i.wbits!==t&&(i.window=null),i.wrap=n,i.wbits=t,fx(e))},gx=(e,t)=>{if(!e)return Lr;const n=new HX;e.state=n,n.strm=e,n.window=null,n.mode=km;const i=_x(e,t);return i!==qa&&(e.state=null),i};let $y,eT,Ex=!0;const KX=e=>{if(Ex){$y=new Int32Array(512),eT=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(gu(1,e.lens,0,288,$y,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;gu(2,e.lens,0,32,eT,0,e.work,{bits:5}),Ex=!1}e.lencode=$y,e.lenbits=9,e.distcode=eT,e.distbits=5},Sx=(e,t,n,i)=>{let r;const s=e.state;return s.window===null&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),i>=s.wsize?(s.window.set(t.subarray(n-s.wsize,n),0),s.wnext=0,s.whave=s.wsize):(r=s.wsize-s.wnext,r>i&&(r=i),s.window.set(t.subarray(n-i,n-i+r),s.wnext),(i-=r)?(s.window.set(t.subarray(n-i,n),0),s.wnext=i,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0};var YX=(e,t)=>{let n,i,r,s,o,a,c,u,p,m,_,g,b,v,R,O,D,x,B,G,j,H,Z=0;const ne=new Uint8Array(4);let he,De;const Oe=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Xa(e)||!e.output||!e.input&&e.avail_in!==0)return Lr;n=e.state,n.mode===io&&(n.mode=Jy),o=e.next_out,r=e.output,c=e.avail_out,s=e.next_in,i=e.input,a=e.avail_in,u=n.hold,p=n.bits,m=a,_=c,H=qa;e:for(;;)switch(n.mode){case km:if(n.wrap===0){n.mode=Jy;break}for(;p<16;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if(2&n.wrap&&u===35615){n.wbits===0&&(n.wbits=15),n.check=0,ne[0]=255&u,ne[1]=u>>>8&255,n.check=ci(n.check,ne,2,0),u=0,p=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&u)<<8)+(u>>8))%31){e.msg="incorrect header check",n.mode=In;break}if((15&u)!==hx){e.msg="unknown compression method",n.mode=In;break}if(u>>>=4,p-=4,j=8+(15&u),n.wbits===0&&(n.wbits=j),j>15||j>n.wbits){e.msg="invalid window size",n.mode=In;break}n.dmax=1<<n.wbits,n.flags=0,e.adler=n.check=1,n.mode=512&u?16189:io,u=0,p=0;break;case 16181:for(;p<16;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if(n.flags=u,(255&Zn(n))!==hx){e.msg="unknown compression method",n.mode=In;break}if(57344&Zn(n)){e.msg="unknown header flags set",n.mode=In;break}n.head&&(n.head.text=u>>8&1),512&Zn(n)&&4&n.wrap&&(ne[0]=255&u,ne[1]=u>>>8&255,n.check=ci(n.check,ne,2,0)),u=0,p=0,n.mode=16182;case 16182:for(;p<32;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}n.head&&(n.head.time=u),512&Zn(n)&&4&n.wrap&&(ne[0]=255&u,ne[1]=u>>>8&255,ne[2]=u>>>16&255,ne[3]=u>>>24&255,n.check=ci(n.check,ne,4,0)),u=0,p=0,n.mode=16183;case 16183:for(;p<16;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}n.head&&(n.head.xflags=255&u,n.head.os=u>>8),512&Zn(n)&&4&n.wrap&&(ne[0]=255&u,ne[1]=u>>>8&255,n.check=ci(n.check,ne,2,0)),u=0,p=0,n.mode=16184;case 16184:if(1024&Zn(n)){for(;p<16;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}n.length=u,n.head&&(n.head.extra_len=u),512&Zn(n)&&4&n.wrap&&(ne[0]=255&u,ne[1]=u>>>8&255,n.check=ci(n.check,ne,2,0)),u=0,p=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&Zn(n)&&(g=n.length,g>a&&(g=a),g&&(n.head&&(j=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(s,s+g),j)),512&Zn(n)&&4&n.wrap&&(n.check=ci(n.check,i,g,s)),a-=g,s+=g,n.length-=g),n.length))break e;n.length=0,n.mode=16186;case 16186:if(2048&Zn(n)){if(a===0)break e;g=0;do j=i[s+g++],n.head&&j&&n.length<65536&&(n.head.name+=String.fromCharCode(j));while(j&&g<a);if(512&Zn(n)&&4&n.wrap&&(n.check=ci(n.check,i,g,s)),a-=g,s+=g,j)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&Zn(n)){if(a===0)break e;g=0;do j=i[s+g++],n.head&&j&&n.length<65536&&(n.head.comment+=String.fromCharCode(j));while(j&&g<a);if(512&Zn(n)&&4&n.wrap&&(n.check=ci(n.check,i,g,s)),a-=g,s+=g,j)break e}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&Zn(n)){for(;p<16;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if(4&n.wrap&&u!==(65535&n.check)){e.msg="header crc mismatch",n.mode=In;break}u=0,p=0}n.head&&(n.head.hcrc=Zn(n)>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=io;break;case 16189:for(;p<32;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}e.adler=n.check=px(u),u=0,p=0,n.mode=xm;case xm:if(n.havedict===0)return e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,n.hold=u,n.bits=p,WX;e.adler=n.check=1,n.mode=io;case io:if(t===FX||t===Lm)break e;case Jy:if(n.last){u>>>=7&p,p-=7&p,n.mode=Zy;break}for(;p<3;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}switch(n.last=1&u,u>>>=1,p-=1,3&u){case 0:n.mode=16193;break;case 1:if(KX(n),n.mode=Mm,t===Lm){u>>>=2,p-=2;break e}break;case 2:n.mode=16196;break;case 3:e.msg="invalid block type",n.mode=In}u>>>=2,p-=2;break;case 16193:for(u>>>=7&p,p-=7&p;p<32;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if((65535&u)!=(u>>>16^65535)){e.msg="invalid stored block lengths",n.mode=In;break}if(n.length=65535&u,u=0,p=0,n.mode=Qy,t===Lm)break e;case Qy:n.mode=16195;case 16195:if(g=n.length,g){if(g>a&&(g=a),g>c&&(g=c),g===0)break e;r.set(i.subarray(s,s+g),o),a-=g,s+=g,c-=g,o+=g,n.length-=g;break}n.mode=io;break;case 16196:for(;p<14;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if(n.nlen=257+(31&u),u>>>=5,p-=5,n.ndist=1+(31&u),u>>>=5,p-=5,n.ncode=4+(15&u),u>>>=4,p-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=In;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;p<3;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}n.lens[Oe[n.have++]]=7&u,u>>>=3,p-=3}for(;n.have<19;)n.lens[Oe[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,he={bits:n.lenbits},H=gu(0,n.lens,0,19,n.lencode,0,n.work,he),n.lenbits=he.bits,H){e.msg="invalid code lengths set",n.mode=In;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;Z=n.lencode[u&(1<<n.lenbits)-1],R=Z>>>24,O=Z>>>16&255,D=65535&Z,!(R<=p);){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if(D<16)u>>>=R,p-=R,n.lens[n.have++]=D;else{if(D===16){for(De=R+2;p<De;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if(u>>>=R,p-=R,n.have===0){e.msg="invalid bit length repeat",n.mode=In;break}j=n.lens[n.have-1],g=3+(3&u),u>>>=2,p-=2}else if(D===17){for(De=R+3;p<De;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}u>>>=R,p-=R,j=0,g=3+(7&u),u>>>=3,p-=3}else{for(De=R+7;p<De;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}u>>>=R,p-=R,j=0,g=11+(127&u),u>>>=7,p-=7}if(n.have+g>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=In;break}for(;g--;)n.lens[n.have++]=j}}if(n.mode===In)break;if(n.lens[256]===0){e.msg="invalid code -- missing end-of-block",n.mode=In;break}if(n.lenbits=9,he={bits:n.lenbits},H=gu(1,n.lens,0,n.nlen,n.lencode,0,n.work,he),n.lenbits=he.bits,H){e.msg="invalid literal/lengths set",n.mode=In;break}if(n.distbits=6,n.distcode=n.distdyn,he={bits:n.distbits},H=gu(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,he),n.distbits=he.bits,H){e.msg="invalid distances set",n.mode=In;break}if(n.mode=Mm,t===Lm)break e;case Mm:n.mode=Um;case Um:if(a>=6&&c>=258){e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,n.hold=u,n.bits=p,xX(e,_),o=e.next_out,r=e.output,c=e.avail_out,s=e.next_in,i=e.input,a=e.avail_in,u=n.hold,p=n.bits,n.mode===io&&(n.back=-1);break}for(n.back=0;Z=n.lencode[u&(1<<n.lenbits)-1],R=Z>>>24,O=Z>>>16&255,D=65535&Z,!(R<=p);){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if(O&&(240&O)==0){for(x=R,B=O,G=D;Z=n.lencode[G+((u&(1<<x+B)-1)>>x)],R=Z>>>24,O=Z>>>16&255,D=65535&Z,!(x+R<=p);){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}u>>>=x,p-=x,n.back+=x}if(u>>>=R,p-=R,n.back+=R,n.length=D,O===0){n.mode=16205;break}if(32&O){n.back=-1,n.mode=io;break}if(64&O){e.msg="invalid literal/length code",n.mode=In;break}n.extra=15&O,n.mode=16201;case 16201:if(n.extra){for(De=n.extra;p<De;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}n.length+=u&(1<<n.extra)-1,u>>>=n.extra,p-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;Z=n.distcode[u&(1<<n.distbits)-1],R=Z>>>24,O=Z>>>16&255,D=65535&Z,!(R<=p);){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if((240&O)==0){for(x=R,B=O,G=D;Z=n.distcode[G+((u&(1<<x+B)-1)>>x)],R=Z>>>24,O=Z>>>16&255,D=65535&Z,!(x+R<=p);){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}u>>>=x,p-=x,n.back+=x}if(u>>>=R,p-=R,n.back+=R,64&O){e.msg="invalid distance code",n.mode=In;break}n.offset=D,n.extra=15&O,n.mode=16203;case 16203:if(n.extra){for(De=n.extra;p<De;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}n.offset+=u&(1<<n.extra)-1,u>>>=n.extra,p-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=In;break}n.mode=16204;case 16204:if(c===0)break e;if(g=_-c,n.offset>g){if(g=n.offset-g,g>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=In;break}g>n.wnext?(g-=n.wnext,b=n.wsize-g):b=n.wnext-g,g>n.length&&(g=n.length),v=n.window}else v=r,b=o-n.offset,g=n.length;g>c&&(g=c),c-=g,n.length-=g;do r[o++]=v[b++];while(--g);n.length===0&&(n.mode=Um);break;case 16205:if(c===0)break e;r[o++]=n.length,c--,n.mode=Um;break;case Zy:if(n.wrap){for(;p<32;){if(a===0)break e;a--,u|=i[s++]<<p,p+=8}if(_-=c,e.total_out+=_,n.total+=_,4&n.wrap&&_&&(e.adler=n.check=Zn(n)?ci(n.check,r,_,o-_):du(n.check,r,_,o-_)),_=c,4&n.wrap&&(Zn(n)?u:px(u))!==n.check){e.msg="incorrect data check",n.mode=In;break}u=0,p=0}n.mode=16207;case 16207:if(n.wrap&&Zn(n)){for(;p<32;){if(a===0)break e;a--,u+=i[s++]<<p,p+=8}if(4&n.wrap&&u!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=In;break}u=0,p=0}n.mode=16208;case 16208:H=BX;break e;case In:H=lx;break e;case 16210:return ux;default:return Lr}return e.next_out=o,e.avail_out=c,e.next_in=s,e.avail_in=a,n.hold=u,n.bits=p,(n.wsize||_!==e.avail_out&&n.mode<In&&(n.mode<Zy||t!==dx))&&Sx(e,e.output,e.next_out,_-e.avail_out),m-=e.avail_in,_-=e.avail_out,e.total_in+=m,e.total_out+=_,n.total+=_,4&n.wrap&&_&&(e.adler=n.check=Zn(n)?ci(n.check,r,_,e.next_out-_):du(n.check,r,_,e.next_out-_)),e.data_type=n.bits+(n.last?64:0)+(n.mode===io?128:0)+(n.mode===Mm||n.mode===Qy?256:0),(m===0&&_===0||t===dx)&&H===qa&&(H=GX),H},ro={inflateReset:fx,inflateReset2:_x,inflateResetKeep:mx,inflateInit:e=>gx(e,15),inflateInit2:gx,inflate:YX,inflateEnd:e=>{if(Xa(e))return Lr;let t=e.state;return t.window&&(t.window=null),e.state=null,qa},inflateGetHeader:(e,t)=>{if(Xa(e))return Lr;const n=e.state;return(2&n.wrap)==0?Lr:(n.head=t,t.done=!1,qa)},inflateSetDictionary:(e,t)=>{const n=t.length;let i,r,s;return Xa(e)?Lr:(i=e.state,i.wrap!==0&&i.mode!==xm?Lr:i.mode===xm&&(r=1,r=du(r,t,n,0),r!==i.check)?lx:(s=Sx(e,t,n,n),s?(i.mode=16210,ux):(i.havedict=1,qa)))},inflateInfo:"pako inflate (from Nodeca project)"},zX=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const yx=Object.prototype.toString,{Z_NO_FLUSH:qX,Z_FINISH:XX,Z_OK:Eu,Z_STREAM_END:tT,Z_NEED_DICT:nT,Z_STREAM_ERROR:JX,Z_DATA_ERROR:Tx,Z_MEM_ERROR:QX}=bm;function Vm(e){this.options=Im.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(15&t.windowBits)==0&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new ox,this.strm.avail_out=0;let n=ro.inflateInit2(this.strm,t.windowBits);if(n!==Eu)throw new Error(Ha[n]);if(this.header=new zX,ro.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=_u.string2buf(t.dictionary):yx.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(n=ro.inflateSetDictionary(this.strm,t.dictionary),n!==Eu)))throw new Error(Ha[n])}function vx(e,t){const n=new Vm(t);if(n.push(e),n.err)throw n.msg||Ha[n.err];return n.result}Vm.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let s,o,a;if(this.ended)return!1;for(o=t===~~t?t:t===!0?XX:qX,yx.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),s=ro.inflate(n,o),s===nT&&r&&(s=ro.inflateSetDictionary(n,r),s===Eu?s=ro.inflate(n,o):s===Tx&&(s=nT));n.avail_in>0&&s===tT&&n.state.wrap>0&&e[n.next_in]!==0;)ro.inflateReset(n),s=ro.inflate(n,o);switch(s){case JX:case Tx:case nT:case QX:return this.onEnd(s),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(n.avail_out===0||s===tT))if(this.options.to==="string"){let c=_u.utf8border(n.output,n.next_out),u=n.next_out-c,p=_u.buf2string(n.output,c);n.next_out=u,n.avail_out=i-u,u&&n.output.set(n.output.subarray(c,c+u),0),this.onData(p)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(s!==Eu||a!==0){if(s===tT)return s=ro.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,!0;if(n.avail_in===0)break}}return!0},Vm.prototype.onData=function(e){this.chunks.push(e)},Vm.prototype.onEnd=function(e){e===Eu&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Im.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var ZX={inflate:vx,inflateRaw:function(e,t){return(t=t||{}).raw=!0,vx(e,t)}};const{deflate:$X,deflateRaw:e9}=kX,{inflate:t9,inflateRaw:n9}=ZX;var i9=$X,r9=e9,s9=t9,o9=n9,Rx=(function(e){return e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE",e})(Rx||{});class a9{constructor(){C(this,"_sequence",0),C(this,"_startTime",Date.now()),C(this,"isUseOneByte",!0)}get startTime(){const t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){const n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){const a=new Uint8Array(4);a.set([1,0,0,0]);const c={id:0,length:4,data:a.buffer},u={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};n.commonPacketHeader.extension=1,n.extension=u,n.payload=this.compress(t),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;I("SHOW_DATASTREAM2_LOG")&&S.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));const i=new ArrayBuffer(n.commonPacketHeader.length),r=new Uint8Array(i),s=new DataView(i);let o=0;if(s.setUint16(o,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),o+=2,s.setUint32(o,n.commonPacketHeader.sequence,!0),o+=4,s.setUint16(o,n.commonStreamHeader,!0),o+=2,n.extension){const a=this.serializeExtension(n.extension);r.set(new Uint8Array(a),o),o+=a.byteLength}if(r.set(new Uint8Array(n.payload),o),o+=n.payload.byteLength,o!==n.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);const n=new DataView(t);let i=0;const r=n.getUint16(i,!0);i+=2;const s={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:n.getUint16(i+2,!0)<<16|n.getUint16(i,!0)};let o,a;if(i+=4,I("SHOW_DATASTREAM2_LOG")&&S.debug("receive data header: ".concat(JSON.stringify(s))),n.getUint16(i,!0),i+=2,s.extension){a=this.deserializeExtension(t.slice(i)),i+=2+a.length,o=t.slice(i);let c=!1;if(a.datas.length>0){const u=a.datas.find((p=>p.id===0));u&&(c=(1&new DataView(u.data).getUint32(0,!0))==1)}o=c?this.decompress(o):o}else o=t.slice(8);return o}serializeExtension(t){const{profile:n,length:i,datas:r}=t,s=new ArrayBuffer(i+2),o=new Uint8Array(s),a=new DataView(s);let c=0;if(a.setUint8(c++,n),a.setUint8(c++,i),r.forEach((u=>{n?(a.setUint8(c++,u.id),a.setUint8(c++,u.length),o.set(new Uint8Array(u.data),c),c+=u.data.byteLength):(a.setUint8(c++,u.id|u.length<<4),o.set(new Uint8Array(u.data),c),c+=u.data.byteLength)})),c!==i+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(i+2));return s}deserializeExtension(t){const n=new DataView(t);let i=0;const r=n.getUint8(i);i++;const s=n.getUint8(i);i++;const o=r===Rx.TWO_BYTE,a=[],c=new DataView(t,2);let u=0;for(;u<s;){let p=0,m=0,_=new ArrayBuffer(0);o?(p=c.getUint8(u),u++,m=c.getUint8(u),u++):(p=15&c.getUint8(u),m=c.getUint8(u)>>4,u++),m>0&&(_=c.buffer.slice(u+2,u+2+m),u+=_.byteLength),a.push({id:p,length:m,data:_})}if(u!==s)throw Error("parse error");return{profile:r,length:s,datas:a}}decompress(t){return s9(new Uint8Array(t))}compress(t){return i9(new Uint8Array(t))}}const c9={name:"DataStream",create:(e,t)=>{const n=t?new hz(e):new pz(e);return n.useDataStream(new a9),n}};class d9 extends Vt{constructor(t,n,i){super(),C(this,"ws",void 0),C(this,"requestId",1),C(this,"heartBeatTimer",void 0),C(this,"joinInfo",void 0),C(this,"clientId",void 0),C(this,"onOpen",(()=>{this.emit("open"),this.startHeartBeatCheck()})),C(this,"onClose",(r=>{this.emit("close"),this.dispose()})),C(this,"onMessage",(r=>{const s=JSON.parse(r.data);if(!s||s.command!=="serverResponse"||!s.requestId)return s&&s.command==="serverStatus"&&s.serverStatus&&s.serverStatus.command?(this.emit("status",s.serverStatus),void this.emit(s.serverStatus.command,s.serverStatus)):void 0;this.emit("req_".concat(s.requestId),s)})),this.joinInfo=t,this.clientId=n,this.ws=new Wl("cross-channel-".concat(this.clientId),i),this.ws.on(Ve.RECONNECTING,(()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")})),this.ws.on(Ve.CONNECTED,this.onOpen),this.ws.on(Ve.ON_MESSAGE,this.onMessage),this.ws.on(Ve.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){const n=this.requestId++;return t.requestId=n,t.seq=n,this.ws.sendMessage(t),n}waitStatus(t){return new de(((n,i)=>{const r=window.setTimeout((()=>{i(new Y(N.TIMEOUT,"wait status timeout, status: ".concat(t)))}),5e3);this.once(t,(s=>{window.clearTimeout(r),s.state&&s.state!==0?i(new Y(N.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):n(void 0)})),this.once("dispose",(()=>{window.clearTimeout(r),i(new Y(N.WS_ABORT))}))}))}async request(t){if(this.ws.state==="closed")throw new Y(N.WS_DISCONNECT);const n=()=>new de(((o,a)=>{this.ws.once(Ve.CLOSED,(()=>a(new Y(N.WS_ABORT)))),this.ws.once(Ve.CONNECTED,o)}));this.ws.state!=="connected"&&await n();const i=this.sendMessage(t),r=new de(((o,a)=>{const c=()=>{a(new Y(N.WS_ABORT))};this.ws.once(Ve.RECONNECTING,c),this.ws.once(Ve.CLOSED,c),this.once("req_".concat(i),o),En(3e3).then((()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(Ve.RECONNECTING,c),this.ws.off(Ve.CLOSED,c),a(new Y(N.TIMEOUT,"cross channel ws request timeout"))}))})),s=await r;if(!s||s.code!==200)throw new Y(N.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(s)));return s}async connect(t){this.ws.removeAllListeners(Ve.REQUEST_NEW_URLS),this.ws.on(Ve.REQUEST_NEW_URLS,(n=>{n(t)})),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const n=this.requestId++;return t.requestId=n,this.ws.sendMessage(t),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval((()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})}),3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class l9 extends Vt{set state(t){t!==this._state&&(t!==yi.RELAY_STATE_FAILURE&&(this.errorCode=pd.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,n,i,r,s){super(),C(this,"joinInfo",void 0),C(this,"sid",void 0),C(this,"clientId",void 0),C(this,"cancelToken",ui.CancelToken.source()),C(this,"workerToken",void 0),C(this,"requestId",0),C(this,"signal",void 0),C(this,"prevChannelMediaConfig",void 0),C(this,"httpRetryConfig",void 0),C(this,"_resolution",void 0),C(this,"_state",yi.RELAY_STATE_IDLE),C(this,"errorCode",pd.RELAY_OK),C(this,"onStatus",(o=>{S.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(o))),o&&o.command&&(o.command==="onAudioPacketReceived"&&this.emit("event",$s.PACKET_RECEIVED_AUDIO_FROM_SRC),o.command==="onVideoPacketReceived"&&this.emit("event",$s.PACKET_RECEIVED_VIDEO_FROM_SRC),o.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=pd.SRC_TOKEN_EXPIRED,this.state=yi.RELAY_STATE_FAILURE),o.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=pd.DEST_TOKEN_EXPIRED,this.state=yi.RELAY_STATE_FAILURE))})),C(this,"onReconnect",(async()=>{S.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",$s.NETWORK_DISCONNECTED),this.state=yi.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch((o=>{this.state!==yi.RELAY_STATE_IDLE&&(S.error("auto restart channel media relay failed",o.toString()),this.errorCode=pd.SERVER_CONNECTION_LOST,this.state=yi.RELAY_STATE_FAILURE)}))})),this.joinInfo=t,this.clientId=n,this.sid=ba(),this.signal=new d9(this.joinInfo,this.clientId,i),this.httpRetryConfig=r,this._resolution=s}async startChannelMediaRelay(t){if(this.state!==yi.RELAY_STATE_IDLE)throw new Y(N.INVALID_OPERATION);this.state=yi.RELAY_STATE_CONNECTING,await this.connect(),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new Y(N.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new Y(N.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new Y(N.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==yi.RELAY_STATE_RUNNING)throw new Y(N.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==yi.RELAY_STATE_RUNNING)throw new Y(N.INVALID_OPERATION);const n=this.genMessage(mi.SetVideoProfile);await this.signal.request(n),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),S.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=yi.RELAY_STATE_IDLE,this.dispose()}dispose(){S.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=ui.CancelToken.source(),this.state=yi.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await gq(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",$s.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const n=this.genMessage(mi.SetSdkProfile,t);await this.signal.request(n),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const i=this.genMessage(mi.SetSourceChannel,t);await this.signal.request(i),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",$s.PACKET_JOINED_SRC_CHANNEL),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const r=this.genMessage(mi.SetSourceUserId,t);await this.signal.request(r),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const s=this.genMessage(mi.SetDestChannel,t);await this.signal.request(s),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",$s.PACKET_JOINED_DEST_CHANNEL),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const o=this.genMessage(mi.StartPacketTransfer,t);await this.signal.request(o),this.emit("event",$s.PACKET_SENT_TO_DEST_CHANNEL),this.state=yi.RELAY_STATE_RUNNING,S.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const n=this.genMessage(mi.UpdateDestChannel,t);await this.signal.request(n),this.emit("event",$s.PACKET_UPDATE_DEST_CHANNEL),S.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(mi.StopPacketTransfer);await this.signal.request(t),S.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,n){const i=[],r=[],s=[];this.requestId+=1;const o={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:tr,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};o.sdkVersion==="4.24.2"&&(o.sdkVersion="0.0.1");let a=null,c=null;switch(t){case mi.SetSdkProfile:return o.clientRequest={command:"SetSdkProfile",type:"multi_channel"},o;case mi.SetSourceChannel:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new Y(N.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},o;case mi.SetSourceUserId:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new Y(N.UNEXPECTED_ERROR,"can not find source config");return o.clientRequest={command:"SetSourceUserId",uid:c.uid+""},o;case mi.SetDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new Y(N.UNEXPECTED_ERROR,"can not find dest config");return a.forEach((u=>{i.push(u.channelName),r.push(u.uid+""),s.push(u.token||this.joinInfo.appId)})),o.clientRequest={command:"SetDestChannel",channelName:i,uid:r,token:s},o;case mi.StartPacketTransfer:return o.clientRequest={command:"StartPacketTransfer"},o;case mi.Reconnect:return o.clientRequest={command:"Reconnect"},o;case mi.StopPacketTransfer:return o.clientRequest={command:"StopPacketTransfer"},o;case mi.UpdateDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new Y(N.UNEXPECTED_ERROR,"can not find dest config");return a.forEach((u=>{i.push(u.channelName),r.push(u.uid+""),s.push(u.token||this.joinInfo.appId)})),o.clientRequest={command:"UpdateDestChannel",channelName:i,uid:r,token:s},o;case mi.SetVideoProfile:o.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return o}}const u9={name:"ChannelMediaRelay",create:function(e){return new l9(e.joinInfo,e.clientId,e.websocketRetryConfig||$t,e.httpRetryConfig||$t,e.resolution)}};function Cx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Su(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?Cx(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Cx(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class h9 extends Vt{constructor(t,n,i,r){super(),C(this,"spec",void 0),C(this,"token",void 0),C(this,"websocket",void 0),C(this,"pingpongTimer",void 0),C(this,"reconnectMode","retry"),C(this,"serviceMode",void 0),C(this,"reqId",0),C(this,"commandReqId",0),C(this,"handleWebSocketOpen",(()=>{this.reconnectMode="retry",this.startPingPong()})),C(this,"handleWebSocketMessage",(s=>{if(!s.data)return;const o=JSON.parse(s.data);o.requestId?this.emit("@".concat(o.requestId,"-").concat(o.sid),o):(Se.workerEvent(this.spec.sid,{actionType:"status",serverCode:o.code,workerType:this.serviceMode===Zs.TRANSCODE?1:2}),this.emit(Oo.PUBLISH_STREAM_STATUS,o))})),this.spec=n,this.token=t,this.serviceMode=r,this.websocket=new Wl("live-streaming",i),this.websocket.on(Ve.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Ve.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Ve.REQUEST_NEW_URLS,((s,o)=>{sn(this,Oo.REQUEST_NEW_ADDRESS).then(s).catch(o)})),this.websocket.on(Ve.RECONNECTING,(()=>{this.websocket.reconnectMode=this.reconnectMode}))}init(t){return this.websocket.init(t)}async request(t,n,i,r){this.reqId+=1,t==="request"&&(this.commandReqId+=1);const s=this.commandReqId,o=this.reqId;if(!o||!this.websocket)throw new Y(N.UNEXPECTED_ERROR);const a=Su({command:t,sdkVersion:tr==="4.24.2"?"0.0.1":tr,seq:o,requestId:o,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new Y(N.WS_DISCONNECT);const c=()=>new de(((_,g)=>{this.websocket.once(Ve.CLOSED,(()=>g(new Y(N.WS_ABORT)))),this.websocket.once(Ve.CONNECTED,_)}));this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const u=new de(((_,g)=>{const b=()=>{g(new Y(N.WS_ABORT))};this.websocket.once(Ve.RECONNECTING,b),this.websocket.once(Ve.CLOSED,b),this.once("@".concat(o,"-").concat(this.spec.sid),(v=>{_(v)}))}));r&&Se.workerEvent(this.spec.sid,Su(Su({},r),{},{requestId:s,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));const p=Date.now();this.websocket.sendMessage(a);let m=null;try{m=await u}catch(_){if(this.websocket.state==="closed")throw _;return await c(),await this.request(t,n,i)}return r&&Se.workerEvent(this.spec.sid,Su(Su({},r),{},{requestId:s,actionType:"response",payload:JSON.stringify(m.serverResponse),serverCode:m.code,success:m.code===200,responseTime:Date.now()-p})),m.code!==200&&this.handleResponseError(m),m}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t=tr==="4.24.2"?"0.0.1":tr;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case ln.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void S.warning("live stream response already exists stream");case ln.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case ln.LIVE_STREAM_RESPONSE_BAD_STREAM:case ln.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new Y(N.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case ln.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream")return;throw new Y(N.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ln.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new Y(N.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case ln.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const n=new Y(N.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Oo.WARNING,n,t.serverResponse.url)}case ln.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const n=new Y(N.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Oo.WARNING,n,t.serverResponse.url)}case ln.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new Y(N.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ln.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new Y(N.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case ln.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const n=new Y(N.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Oo.WARNING,n,t.serverResponse.url)}case ln.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new Y(N.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case ln.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new Y(N.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case ln.LIVE_STREAM_RESPONSE_WORKER_LOST:case ln.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream")return;throw new Y(N.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ln.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new Y(N.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new Y(N.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ln.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ln.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ln.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ln.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new Y(N.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval((()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(kl)}),6e3)}}function bx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function vi(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?bx(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):bx(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class p9 extends Vt{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:$t,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:$t;super(),C(this,"onLiveStreamWarning",void 0),C(this,"onLiveStreamError",void 0),C(this,"spec",void 0),C(this,"retryTimeout",1e4),C(this,"connection",void 0),C(this,"httpRetryConfig",void 0),C(this,"wsRetryConfig",void 0),C(this,"streamingTasks",new Map),C(this,"isStartingStreamingTask",!1),C(this,"taskMutex",new Cn("live-streaming")),C(this,"cancelToken",ui.CancelToken.source()),C(this,"transcodingConfig",void 0),C(this,"uapResponse",void 0),C(this,"lastTaskId",1),C(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=i,this.wsRetryConfig=n}async setTranscodingConfig(t){const n=vi(vi({},Jz),t);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(S.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map((o=>vi(vi(vi({},Xz),o),{},{zOrder:o.zOrder?o.zOrder+1:1})))),(function(o){Wt(o.width)||Rt(o.width,"config.width",0,1e4),Wt(o.height)||Rt(o.height,"config.height",0,1e4),Wt(o.videoBitrate)||Rt(o.videoBitrate,"config.videoBitrate",1,1e6),Wt(o.videoFrameRate)||Rt(o.videoFrameRate,"config.videoFrameRate"),Wt(o.lowLatency)||Tr(o.lowLatency,"config.lowLatency"),Wt(o.audioSampleRate)||Zt(o.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Wt(o.audioBitrate)||Rt(o.audioBitrate,"config.audioBitrate",1,128),Wt(o.audioChannels)||Zt(o.audioChannels,"config.audioChannels",[1,2,3,4,5]),Wt(o.videoGop)||Rt(o.videoGop,"config.videoGop"),Wt(o.videoCodecProfile)||Zt(o.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Wt(o.userCount)||Rt(o.userCount,"config.userCount",0,17),Wt(o.backgroundColor)||Rt(o.backgroundColor,"config.backgroundColor",0,16777215),Wt(o.userConfigExtraInfo)||Nn(o.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),o.transcodingUsers&&!Wt(o.transcodingUsers)&&(Js(o.transcodingUsers,"config.transcodingUsers"),o.transcodingUsers.forEach(((a,c)=>{qp(a.uid),Wt(a.x)||Rt(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),Wt(a.y)||Rt(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),Wt(a.width)||Rt(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),Wt(a.height)||Rt(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),Wt(a.zOrder)||Rt(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),Wt(a.alpha)||Rt(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)}))),Wt(o.watermark)||YS(o.watermark,"watermark"),Wt(o.backgroundImage)||YS(o.backgroundImage,"backgroundImage"),o.images&&!Wt(o.images)&&(Js(o.images,"config.images"),o.images.forEach(((a,c)=>{YS(a,"images[".concat(c,"]"))})))})(n);const i=[];n.images&&i.push(...n.images.map((o=>vi(vi(vi({},KS),o),{},{zOrder:255})))),n.backgroundImage&&(i.push(vi(vi(vi({},KS),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(i.push(vi(vi(vi({},KS),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=i,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map((o=>vi({},o))),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);const r=(n.userConfigs||[]).map((o=>typeof o.uid=="number"?de.resolve(o.uid):KP(o.uid,this.spec,this.cancelToken.token,this.httpRetryConfig)));if((await de.all(r)).forEach(((o,a)=>{n.userConfigs&&n.userConfigs[a]&&(n.userConfigs[a].uid=o)})),this.transcodingConfig=n,this.connection)try{var s;const o=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Ii(s=this.streamingTasks).call(s)).map((a=>a.taskId)).join("#")});S.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(o.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(o){if(!o.data||!o.data.retry)throw o;o.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach((a=>{S.warning("[".concat(this.spec.clientId,"] live streaming receive error"),o.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,o).then((()=>{S.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))})).catch((c=>{S.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}))}))}}async startLiveStreamingTask(t,n,i){if(!this.transcodingConfig&&n===Zs.TRANSCODE)throw new Y(N.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const r={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};S.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(n));const s=await this.taskMutex.lock();if(!this.connection&&i)return void s();if(this.streamingTasks.get(t)&&!i)return s(),new Y(N.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n))}catch(a){throw s(),a}n===Zs.TRANSCODE&&(r.transcodingConfig=vi({},this.transcodingConfig)),this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const o=this.lastTaskId++;try{const a=new de(((u,p)=>{En(this.retryTimeout).then((()=>{if(i)return p(i);const m=this.statusError.get(t);return m?(this.statusError.delete(t),p(m)):void 0}))})),c=await de.race([this.connection.request("request",{clientRequest:r},!0,{url:t,command:"PublishStream",workerType:n===Zs.TRANSCODE?1:2,requestByUser:!i,tid:o.toString()}),a]);this.isStartingStreamingTask=!1,S.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(t,{clientRequest:r,mode:n,url:t,taskId:o}),s()}catch(a){if(s(),this.isStartingStreamingTask=!1,!a.data||!a.data.retry||i)throw a;return a.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,n,a)):await this.startLiveStreamingTask(t,n,a)}}stopLiveStreamingTask(t){return new de(((n,i)=>{const r=this.streamingTasks.get(t);if(!r||!this.connection)return new Y(N.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const s=r.mode;r.abortTask=()=>{S.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),n()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:r.url}},!1,{url:t,command:"UnPublishStream",workerType:s===Zs.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then((o=>{S.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(o.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),n()})).catch(i)}))}resetAllTask(){var t;const n=Array.from(Ii(t=this.streamingTasks).call(t));this.terminate();for(const i of n)this.startLiveStreamingTask(i.url,i.mode).catch((r=>{this.onLiveStreamError&&this.onLiveStreamError(i.url,r)}))}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=ui.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new Y(N.UNEXPECTED_ERROR,"live streaming connection has already connected");const n=await sn(this,zS.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=n,this.connection=new h9(n.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(Oo.WARNING,((i,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,i))),this.connection.on(Oo.PUBLISH_STREAM_STATUS,(i=>this.handlePublishStreamServer(i))),this.connection.on(Oo.REQUEST_NEW_ADDRESS,((i,r)=>{if(!this.connection)return r(new Y(N.UNEXPECTED_ERROR,"can not get new live streaming address list"));sn(this,zS.REQUEST_WORKER_MANAGER_LIST,t).then((s=>{this.uapResponse=s,i(s.addressList)})).catch(r)})),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(t){const n=t.serverStatus&&t.serverStatus.url||"empty_url",i=this.streamingTasks.get(n),r=t.reason;switch(t.code){case ln.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ln.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ln.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ln.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const o=new Y(N.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(i)return S.error(o.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,o);if(!this.isStartingStreamingTask)return;this.statusError.set(n,o)}case ln.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const o=new Y(N.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,o)}case ln.LIVE_STREAM_RESPONSE_WORKER_LOST:case ln.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var s;if(!this.connection)return;this.connection.tryNextAddress();const o=Array.from(Ii(s=this.streamingTasks).call(s));for(const a of o)a.abortTask?a.abortTask():(S.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new Y(N.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then((()=>{S.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)})).catch((c=>{S.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})));return}}}hasUrl(t){return this.streamingTasks.has(t)}}const m9={name:"LiveStreaming",create:function(e){return new p9(e.joinInfo,e.websocketRetryConfig||$t,e.httpRetryConfig||$t)}};function f9(e){let t=Ix();return(function(n,i){let r=n.appId;r!==void 0&&(gt(i,10),Ls(i,r));let s=n.cid;s!==void 0&&(gt(i,16),gt(i,s));let o=n.cname;o!==void 0&&(gt(i,26),Ls(i,o));let a=n.deviceId;a!==void 0&&(gt(i,34),Ls(i,a));let c=n.elapse;c!==void 0&&(gt(i,40),Wo(i,c));let u=n.fileSize;u!==void 0&&(gt(i,48),Wo(i,Dd(u)));let p=n.height;p!==void 0&&(gt(i,56),Wo(i,Dd(p)));let m=n.jpg;m!==void 0&&(gt(i,66),gt(i,m.length),(function(Ut,ee){let ce=Pd(Ut,ee.length);Ut.bytes.set(ee,ce)})(i,m));let _=n.networkType;_!==void 0&&(gt(i,72),Wo(i,Dd(_)));let g=n.osType;g!==void 0&&(gt(i,80),Wo(i,Dd(g)));let b=n.requestId;b!==void 0&&(gt(i,90),Ls(i,b));let v=n.sdkVersion;v!==void 0&&(gt(i,98),Ls(i,v));let R=n.sequence;R!==void 0&&(gt(i,104),Wo(i,Dd(R)));let O=n.sid;O!==void 0&&(gt(i,114),Ls(i,O));let D=n.timestamp;D!==void 0&&(gt(i,120),Wo(i,D));let x=n.uid;x!==void 0&&(gt(i,128),gt(i,x));let B=n.vid;B!==void 0&&(gt(i,136),gt(i,B));let G=n.width;G!==void 0&&(gt(i,144),Wo(i,Dd(G)));let j=n.service;j!==void 0&&(gt(i,152),gt(i,j));let H=n.callbackData;H!==void 0&&(gt(i,162),Ls(i,H));let Z=n.jpgEncryption;Z!==void 0&&(gt(i,168),gt(i,Z));let ne=n.requestType;ne!==void 0&&(gt(i,176),gt(i,ne));let he=n.scorePorn;he!==void 0&&(gt(i,185),aT(i,he));let De=n.scoreSexy;De!==void 0&&(gt(i,193),aT(i,De));let Oe=n.scoreNeutral;Oe!==void 0&&(gt(i,201),aT(i,Oe));let Ge=n.scene;Ge!==void 0&&(gt(i,208),gt(i,Ge));let Ue=n.ossFilePrefix;Ue!==void 0&&(gt(i,218),Ls(i,Ue));let ct=n.serviceVendor;if(ct!==void 0)for(let Ut of ct){gt(i,226);let ee=Ix();E9(Ut,ee),gt(i,ee.limit),v9(i,ee),T9(ee)}})(e,t),(function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)})(t)}function _9(e){return(function(n){let i={};e:for(;!Ox(n);){let r=ks(n);switch(r>>>3){case 0:break e;case 1:i.code=ks(n);break;case 2:i.msg=Nx(n,ks(n));break;case 3:{let s=S9(n);i.data=g9(n),n.limit=s;break}default:wx(n,7&r)}}return i})({bytes:t=e,offset:0,limit:t.length});var t}function g9(e){let t={};e:for(;!Ox(e);){let n=ks(e);switch(n>>>3){case 0:break e;case 1:t.requestId=Nx(e,ks(e));break;case 2:t.requestType=ks(e)>>>0;break;case 3:t.scorePorn=oT(e);break;case 4:t.scoreSexy=oT(e);break;case 5:t.scoreNeutral=oT(e);break;case 6:t.requestScene=ks(e)>>>0;break;case 7:t.scene=ks(e)>>>0;break;default:wx(e,7&n)}}return t}function E9(e,t){let n=e.service;n!==void 0&&(gt(t,8),gt(t,n));let i=e.vendor;i!==void 0&&(gt(t,16),gt(t,i));let r=e.token;r!==void 0&&(gt(t,26),Ls(t,r));let s=e.callbackUrl;s!==void 0&&(gt(t,34),Ls(t,s))}function S9(e){let t=ks(e),n=e.limit;return e.limit=e.offset+t,n}function wx(e,t){switch(t){case 0:for(;128&Dx(e););break;case 2:rT(e,ks(e));break;case 5:rT(e,4);break;case 1:rT(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let y9=new Float32Array(1);new Uint8Array(y9.buffer);let iT=new Float64Array(1),Ri=new Uint8Array(iT.buffer);function Dd(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let Ax=[];function Ix(){const e=Ax.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function T9(e){Ax.push(e)}function rT(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function Ox(e){return e.offset>=e.limit}function Pd(e,t){let n=e.bytes,i=e.offset,r=e.limit,s=i+t;if(s>n.length){let o=new Uint8Array(2*s);o.set(n),e.bytes=o}return e.offset=s,s>r&&(e.limit=s),i}function sT(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function Nx(e,t){let n=sT(e,t),i=String.fromCharCode,r=e.bytes,s="",o="";for(let a=0;a<t;a++){let c,u,p,m,_=r[a+n];(128&_)==0?o+=i(_):(224&_)==192?a+1>=t?o+=s:(c=r[a+n+1],(192&c)!=128?o+=s:(m=(31&_)<<6|63&c,m<128?o+=s:(o+=i(m),a++))):(240&_)==224?a+2>=t?o+=s:(c=r[a+n+1],u=r[a+n+2],(49344&(c|u<<8))!=32896?o+=s:(m=(15&_)<<12|(63&c)<<6|63&u,m<2048||m>=55296&&m<=57343?o+=s:(o+=i(m),a+=2))):(248&_)==240?a+3>=t?o+=s:(c=r[a+n+1],u=r[a+n+2],p=r[a+n+3],(12632256&(c|u<<8|p<<16))!=8421504?o+=s:(m=(7&_)<<18|(63&c)<<12|(63&u)<<6|63&p,m<65536||m>1114111?o+=s:(m-=65536,o+=i(55296+(m>>10),56320+(1023&m)),a+=3))):o+=s}return o}function Ls(e,t){let n=t.length,i=0;for(let o=0;o<n;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+t.charCodeAt(++o)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}gt(e,i);let r=Pd(e,i),s=e.bytes;for(let o=0;o<n;o++){let a=t.charCodeAt(o);a>=55296&&a<=56319&&o+1<n&&(a=(a<<10)+t.charCodeAt(++o)-56613888),a<128?s[r++]=a:(a<2048?s[r++]=a>>6&31|192:(a<65536?s[r++]=a>>12&15|224:(s[r++]=a>>18&7|240,s[r++]=a>>12&63|128),s[r++]=a>>6&63|128),s[r++]=63&a|128)}}function v9(e,t){let n=Pd(e,t.limit),i=e.bytes,r=t.bytes;for(let s=0,o=t.limit;s<o;s++)i[s+n]=r[s]}function Dx(e){return e.bytes[sT(e,1)]}function Px(e,t){let n=Pd(e,1);e.bytes[n]=t}function oT(e){let t=sT(e,8),n=e.bytes;return Ri[0]=n[t++],Ri[1]=n[t++],Ri[2]=n[t++],Ri[3]=n[t++],Ri[4]=n[t++],Ri[5]=n[t++],Ri[6]=n[t++],Ri[7]=n[t++],iT[0]}function aT(e,t){let n=Pd(e,8),i=e.bytes;iT[0]=t,i[n++]=Ri[0],i[n++]=Ri[1],i[n++]=Ri[2],i[n++]=Ri[3],i[n++]=Ri[4],i[n++]=Ri[5],i[n++]=Ri[6],i[n++]=Ri[7]}function ks(e){let t,n=0,i=0;do t=Dx(e),n<32&&(i|=(127&t)<<n),n+=7;while(128&t);return i}function gt(e,t){for(t>>>=0;t>=128;)Px(e,127&t|128),t>>>=7;Px(e,t)}function Wo(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,s=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,o=Pd(e,s),a=e.bytes;switch(s){case 10:a[o+9]=r>>>7&1;case 9:a[o+8]=s!==9?128|r:127&r;case 8:a[o+7]=s!==8?i>>>21|128:i>>>21&127;case 7:a[o+6]=s!==7?i>>>14|128:i>>>14&127;case 6:a[o+5]=s!==6?i>>>7|128:i>>>7&127;case 5:a[o+4]=s!==5?128|i:127&i;case 4:a[o+3]=s!==4?n>>>21|128:n>>>21&127;case 3:a[o+2]=s!==3?n>>>14|128:n>>>14&127;case 2:a[o+1]=s!==2?n>>>7|128:n>>>7&127;case 1:a[o]=s!==1?128|n:127&n}}function Lx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}const R9=new Map([["moderation",1],["supervise",2]]);class C9 extends Vt{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const n=this._connectionState;this._connectionState=t,this.emit(wn.CONNECTION_STATE_CHANGE,n,t)}get inspectType(){return this._inspectType}set inspectType(t){var n;this._inspectMode=$i(n=t.map((i=>R9.get(i)||0))).call(n,((i,r)=>i+r)),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout((()=>{this.quality=this._quality/this.qualityRatio}),6e4))}constructor(t){super(),C(this,"name","AgoraRTCVideoContentInspect"),C(this,"_connectionState",wr.CONNECTING),C(this,"_innerConnectionState",void 0),C(this,"sequence",0),C(this,"inspectStartTime",void 0),C(this,"workerManagerConnection",void 0),C(this,"workerConnection",void 0),C(this,"workerMessageLengthLimit",void 0),C(this,"inspectIntervalMinimum",void 0),C(this,"qualityRatio",void 0),C(this,"_connectInfo",void 0),C(this,"_cancelTokenSource",ui.CancelToken.source()),C(this,"_retryConfig",void 0),C(this,"wmSequence",0),C(this,"inspectInterval",void 0),C(this,"inspectTimer",null),C(this,"ossFilePrefix",void 0),C(this,"extraInfo",void 0),C(this,"_inspectType",void 0),C(this,"_inspectMode",void 0),C(this,"_quality",1),C(this,"qualityTimer",null),C(this,"_inspectId",void 0),C(this,"_needWorkUrlOnly",!1),C(this,"inspectImage",(()=>{if(this.connectionState!==wr.CONNECTED)throw new Y(N.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval((()=>{this.connectionState===wr.CONNECTED?this.requestToInspectImage():S.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)}),this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()})),this._inspectId=mt(5,"inspect-"),this.workerMessageLengthLimit=I("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=I("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=I("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Wl("worker-manager-"+this._inspectId,$t),this.on(wn.STATE_CHANGE,((n,i)=>{this._innerConnectionState=n,S.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Ar[n]," ").concat(i||""))})),this.handleWorkerManagerEvents(),this.workerConnection=new Wl("worker-"+this._inspectId,$t),this.handleWorkerEvents()}async init(t,n){this.emit(wn.STATE_CHANGE,Ar.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=n,new de(((r,s)=>{this.on(wn.CONNECTION_STATE_CHANGE,((o,a)=>{a===wr.CONNECTED&&r()})),this.requestAP(t,i,n).then((o=>{this.connectWorkerManager(o)})).catch((o=>{s(o)}))}))}async requestAP(t,n,i){const r=I("WEBCS_DOMAIN").map((a=>"https://".concat(a,"/api/v1"))),s=await(function(a,c,u,p){let{appId:m,areaCode:_,cname:g,sid:b,token:v,uid:R}=c;Sd++;const O="image_moderation_api",D={service_name:O,json_body:JSON.stringify({appId:m,areaCode:_,cname:g,command:"allocateEdge",requestId:Sd,seq:Sd,sid:b,token:v,ts:Date.now(),uid:R+""})};let x,B,G=a[0];return zr((async()=>{x=Date.now();const j=await $r(G,{data:D,cancelToken:u,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(B=Date.now()-x,j.code!==0){const Oe=new Y(N.UNEXPECTED_RESPONSE,"image inspect ap error, code"+j.code,{retry:!0,responseTime:B});throw S.error(Oe.toString()),Oe}const H=JSON.parse(j.json_body);if(H.code!==200){const Oe=new Y(N.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(H.code,", reason: ").concat(H.reason),{code:H.code,responseTime:B});throw S.error(Oe.toString()),Oe}if(!H.servers||!Array.isArray(H.servers)||H.servers.length===0){const Oe=new Y(N.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:H.code,responseTime:B});throw S.error(Oe.toString()),Oe}const Z=I("VIDEO_INSPECT_WORKER_MANAGER_WSS");if(Z)return{addressList:[Z],workerToken:H.workerToken,vid:H.vid,responseTime:B};const ne=I("VIDEO_INSPECT_WORKER_MANAGER_HOST"),he=I("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:H.servers.map((Oe=>{let{address:Ge,wss:Ue}=Oe;if(Ge&&Ue)return"wss://".concat(Ge.replace(/\./g,"-"),".").concat(ne,":").concat(he||Ue)})).filter((Oe=>!!Oe)),workerToken:H.workerToken,vid:H.vid,responseTime:B}}),((j,H)=>(Se.apworkerEvent(b,{success:!0,sc:200,serviceName:O,responseDetail:JSON.stringify(j.addressList),firstSuccess:H===0,responseTime:B,serverIp:a[H%a.length]}),!1)),((j,H)=>(Se.apworkerEvent(b,{success:!1,sc:j.data&&j.data.code||200,serviceName:O,responseTime:B,serverIp:a[H%a.length]}),!!(j.code!==N.OPERATION_ABORTED&&j.code!==N.UNEXPECTED_RESPONSE||j.data&&j.data.retry)&&(G=a[(H+1)%a.length],!0))),p)})(r,t,n,i);this.emit(wn.STATE_CHANGE,Ar.AP_CONNECTED);const{addressList:o}=s;return this.wmSequence++,o}async connectWorkerManager(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(wn.STATE_CHANGE,Ar.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Ve.CONNECTED,(async()=>{this.emit(wn.STATE_CHANGE,Ar.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.24.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(Ve.CLOSED,(()=>{this._innerConnectionState<Ar.GET_WORKER_MANAGER_RESPONSE&&S.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))})),this.workerManagerConnection.on(Ve.FAILED,(()=>{this._innerConnectionState<Ar.GET_WORKER_MANAGER_RESPONSE&&S.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))})),this.workerManagerConnection.on(Ve.RECONNECTING,(()=>{this._innerConnectionState<Ar.GET_WORKER_MANAGER_RESPONSE&&S.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))})),this.workerManagerConnection.on(Ve.ON_MESSAGE,(async t=>{this.emit(wn.STATE_CHANGE,Ar.GET_WORKER_MANAGER_RESPONSE);const n=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(t.data);if(i.code!==200)throw S.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new Y(N.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&n))throw S.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new Y(N.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const r=I("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,s=n.replace(/:\d+\/?$/,":".concat(r));this.emit(wn.STATE_CHANGE,Ar.CONNECT_WORKER,s),this._needWorkUrlOnly?this.emit(wn.REQUEST_NEW_WORKER_URL,s):await this.connectWorker(s)}})),this.workerManagerConnection.on(Ve.WILL_RECONNECT,((t,n,i)=>{i(t)})),this.workerManagerConnection.on(Ve.REQUEST_NEW_URLS,((t,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(n)}))}handleWorkerEvents(){this.workerConnection.on(Ve.CONNECTED,(async()=>{this.emit(wn.STATE_CHANGE,Ar.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=wr.CONNECTED})),this.workerConnection.on(Ve.ON_MESSAGE,(async t=>{if(t.data instanceof ArrayBuffer){const i=_9(new Uint8Array(t.data));if(I("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&S.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(i)),i.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(wn.INSPECT_RESULT,void 0,void 0);if(i.data&&i.data.scorePorn&&i.data.scoreSexy&&i.data.scoreNeutral){var n;const r={porn:i.data.scorePorn,sexy:i.data.scoreSexy,neutral:i.data.scoreNeutral},s=$i(n=Object.keys(r)).call(n,((a,c)=>r[a]>r[c]?a:c),"porn"),o=Object.keys(r).find((a=>a===s));this.emit(wn.INSPECT_RESULT,o)}else this.emit(wn.INSPECT_RESULT,void 0,new Y(N.UNEXPECTED_RESPONSE,i.code+"","There is an unexpected data on message"))}else this.emit(wn.INSPECT_RESULT,void 0,new Y(N.UNEXPECTED_RESPONSE,i.code+"",i.msg))}else S.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(wn.INSPECT_RESULT,void 0,new Y(N.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(Ve.CLOSED,(()=>{this.connectionState=wr.CLOSED})),this.workerConnection.on(Ve.FAILED,(()=>{this.connectionState=wr.CLOSED})),this.workerConnection.on(Ve.RECONNECTING,(()=>{this.connectionState=this.connectionState===wr.CONNECTED?wr.RECONNECTING:wr.CONNECTING})),this.workerConnection.on(Ve.WILL_RECONNECT,((t,n,i)=>{t==="recover"&&i(t),i("tryNext")})),this.workerConnection.on(Ve.REQUEST_NEW_URLS,((t,n)=>{this.workerManagerConnection.close(),this.once(wn.REQUEST_NEW_WORKER_URL,(i=>{t([i])})),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then((i=>{this.connectWorkerManager(i,!0)})).catch((i=>{n(i)}))}))}async requestToInspectImage(){this.sequence++;const t=Di(this,wn.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(wn.INSPECT_RESULT,void 0,new Y(N.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(t,n);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(wn.INSPECT_RESULT,void 0,new Y(N.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,n){let{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c}=n;const u=Date.now(),p=await t.getCurrentFrameImage("image/jpeg",this.quality),m=await cN(p,i,r),_=this.sequence+"-"+s+"-"+c+"-"+u+"-"+mt(12,""),g={appId:i,cid:s,cname:r,deviceId:"",elapse:(b=Number(u-this.inspectStartTime),{low:b|=0,high:b>>31,unsigned:b>=0}),fileSize:m.byteLength,jpgEncryption:2,height:p.height,width:p.width,jpg:m,networkType:6,osType:7,requestId:_,sdkVersion:"4.24.2",sequence:this.sequence,sid:a,timestamp:UL(u),uid:c,vid:o,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var b;this.extraInfo===void 0&&delete g.callbackData,this.ossFilePrefix===void 0&&delete g.ossFilePrefix;const v=f9(g);if(v.byteLength<this.workerMessageLengthLimit){if(I("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const R=(function(O){for(var D=1;D<arguments.length;D++){var x=arguments[D]!=null?arguments[D]:{};D%2?Lx(Object(x),!0).forEach((function(B){C(O,B,x[B])})):Object.getOwnPropertyDescriptors?Object.defineProperties(O,Object.getOwnPropertyDescriptors(x)):Lx(Object(x)).forEach((function(B){Object.defineProperty(O,B,Object.getOwnPropertyDescriptor(x,B))}))}return O})({},g);delete R.jpg,S.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(R))}return v}{const R=this.quality*this.qualityRatio;return this.quality=R,await this.generateRequestData(t,{appId:i,cname:r,cid:s,vid:o,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ui.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=wr.CLOSED,this.emit(wn.STATE_CHANGE,Ar.CLOSED)}}const b9={name:"ContentInspect",create:function(e){let{config:t}=e;return(function(n){if(!n)throw new Y(N.INVALID_PARAMS,"inspectConfig is necessary.");if(!n.inspectType||!Array.isArray(n.inspectType))throw new Y(N.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const i=[...new Set(n.inspectType)];i.forEach((r=>{var s;if(!ie(s=["supervise","moderation"]).call(s,r))throw new Y(N.INVALID_PARAMS,"".concat(r," is not a valid inspect type."))})),n.inspectType=i}if(n&&n.extraInfo&&n.extraInfo.length>1024)throw new Y(N.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")})(t),new C9(t)}};var kx=y(Mi.Object.getOwnPropertySymbols),w9=pt,A9=t_.indexOf,I9=qu,cT=Tt([].indexOf),xx=!!cT&&1/cT([1],1,-0)<0;w9({target:"Array",proto:!0,forced:xx||!I9("indexOf")},{indexOf:function(e){var t=arguments.length>1?arguments[1]:void 0;return xx?cT(this,e,t)||0:A9(this,e,t)}});var O9=Zi("Array","indexOf"),N9=W,D9=O9,dT=Array.prototype,P9=function(e){var t=e.indexOf;return e===dT||N9(dT,e)&&t===dT.indexOf?D9:t},Mx=y(P9);function L9(e,t){if(e==null)return{};var n,i,r=(function(o,a){if(o==null)return{};var c={};for(var u in o)if({}.hasOwnProperty.call(o,u)){if(Mx(a).call(a,u)!==-1)continue;c[u]=o[u]}return c})(e,t);if(kx){var s=kx(e);for(i=0;i<s.length;i++)n=s[i],Mx(t).call(t,n)===-1&&{}.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}let Ux=class{get localCapabilities(){return Dt(this._localCapabilities)}get rtpCapabilities(){return Dt(this._rtpCapabilities)}get candidates(){return Dt(this._candidates)}get iceParameters(){return Dt(this._iceParameters)}get dtlsParameters(){return Dt(this._dtlsParameters)}constructor(e){C(this,"sessionDesc",void 0),C(this,"_localCapabilities",void 0),C(this,"_rtpCapabilities",void 0),C(this,"_candidates",void 0),C(this,"_iceParameters",void 0),C(this,"_dtlsParameters",void 0),C(this,"setup",void 0),C(this,"currentMidIndex",void 0),C(this,"cname","o/i14u9pJrxRKAsu"),C(this,"firefoxSsrcMidMap",new Map),e=Dt(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,localCapabilities:s,direction:o,setup:a,videoCodec:c,audioCodec:u}=e;let p;this.setup=a,p=o===ai.RECEIVE_ONLY?ri(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):ri(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=s;const m=o===ai.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,_=o===ai.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,g=o===ai.RECEIVE_ONLY?r.send.videoCodecs:ql(_e.VIDEO,m,_,c),b=o===ai.RECEIVE_ONLY?r.send.audioCodecs:ql(_e.AUDIO,m,_,u);for(const v of p.mediaDescriptions)v.attributes.iceUfrag=t.iceUfrag,v.attributes.icePwd=t.icePwd,v.attributes.fingerprints=n.fingerprints,v.attributes.candidates=i,v.attributes.setup=this.setup,v.media.mediaType==="application"&&(v.attributes.sctpPort="5000"),v.media.mediaType==="video"&&(v.media.fmts=g.map((R=>R.payloadType.toString(10))),v.attributes.payloads=g,v.attributes.extmaps=m.videoExtensions),v.media.mediaType==="audio"&&(v.media.fmts=b.map((R=>R.payloadType.toString(10))),v.attributes.payloads=b,v.attributes.extmaps=m.audioExtensions,Ed(v));this.sessionDesc=p,this.currentMidIndex=p.mediaDescriptions.length-1}toString(){return Qs(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every((t=>this.hasMid(t))):this.sessionDesc.mediaDescriptions.some((t=>t.attributes.mid===e))}send(e,t,n,i,r){n=n.replace(/ /g,"-");const{ssrcs:s,ssrcGroups:o}=Yl(t,this.cname,I("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(s);if(a){if(Nt()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,s,i);let u;return c===-1?(u=this.createOrRecycleSendMedia(e,s,o,"sendonly",i,r),this.updateBundleMids()):(u=Dt(this.sessionDesc.mediaDescriptions[c]),u.attributes.direction="sendonly",u.attributes.ssrcs=s,u.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(u,r)),Nt()&&this.firefoxSsrcMidMap.set(s[0].ssrcId,u.attributes.mid),{needExchangeSDP:!0,mid:u.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>n.attributes.mid&&e.indexOf(n.attributes.mid)!==-1));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach((n=>{n.attributes.ssrcs=[]})),this.updateBundleMids()}receive(e,t,n){const i=[];return e.forEach((r=>{const s=r._mediaStreamTrack.kind,o=this.findAvailableRecvMediaIndex(s);let a,c=!1;o===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",t,n),this.updateBundleMids()):(a=Dt(this.sessionDesc.mediaDescriptions[o]),a.attributes.direction="recvonly"),i.push({mid:a.attributes.mid,needCreateTransceiver:c})})),i}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>e.indexOf(n.attributes.mid)!==-1));if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach((n=>{n.media.port="0",n.attributes.direction="inactive"})),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:n,address:i,port:r,type:s,relatedAddress:o,relatedPort:a,priority:c}=new RTCIceCandidate(e),u={foundation:t??"",componentId:"1",transport:n??"",priority:c?c+"":"",connectionAddress:i??"",port:r?r+"":"",type:s?s+"":"",relAddr:o??"",relPort:a?a+"":"",extension:{}};this.candidates.some((p=>p.priority===u.priority&&p.connectionAddress===u.connectionAddress&&p.port===u.port))||(this._candidates.push(u),this.sessionDesc.mediaDescriptions.forEach((p=>{p.attributes.candidates=this.candidates})))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,n,i,r){const s=e._mediaStreamTrack.kind,o=this.rtpCapabilities.recv,a=ql(s,o,this.localCapabilities.send,s===_e.AUDIO?r:i),c=s===_e.VIDEO?o.videoExtensions:o.audioExtensions,u="".concat(++this.currentMidIndex);let p={media:{mediaType:s,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((_=>_.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(u)}};p=this.mungRecvMediaDsec(p,e);const m=this.findFirstClosedMedia(s);if(m){const _=this.sessionDesc.mediaDescriptions.indexOf(m);this.sessionDesc.mediaDescriptions[_]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>ie(e).call(e,n.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((n=>{n.attributes.direction="inactive"}))}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter((n=>ie(e).call(e,n.attributes.mid||"")));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach((n=>{n.attributes.direction="recvonly"}))}findAvailableMediaIndex(e,t,n){return this.sessionDesc.mediaDescriptions.findIndex((i=>{const r=i.media.mediaType===e&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(Nt()){if(r){const s=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(s||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!s||s!==i.attributes.mid)}return!1}return r&&i.attributes.mid===n}))}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex((t=>{const n=t.media.mediaType===e&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&n}))}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}restartICE(e){e=Dt(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach((t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd}))}createOrRecycleSendMedia(e,t,n,i,r,s){const o=this.rtpCapabilities.send,a=e===_e.VIDEO?o.videoCodecs:o.audioCodecs,c=e===_e.VIDEO?o.videoExtensions:o.audioExtensions;Nt()&&(r="".concat(++this.currentMidIndex));let u={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map((m=>m.payloadType.toString(10)))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};u=this.mungSendMediaDesc(u,s);const p=this.findFirstClosedMedia(e);if(p){const m=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[m]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}mungRecvMediaDsec(e,t,n){const i=Dt(e);return ty(i),Va(i,t),ny(i,t),AP(i),im(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=Dt(e);return im(n,t,this.localCapabilities.recv),Ed(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex((i=>i.attributes.mid===e));if(n!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=i}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter((e=>e.media.port!=="0")).map((e=>e.attributes.mid))}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find((t=>{var n;return((n=t.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===e[0].ssrcId}))}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find((t=>Nt()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0"))}};const k9=["sdp"];var Pt;function Vx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Go(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?Vx(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Vx(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let jx=(Pt=class Md extends dP{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,n,i){super(t,n),C(this,"direction",void 0),C(this,"name",void 0),C(this,"store",void 0),C(this,"spec",void 0),C(this,"peerConnection",void 0),C(this,"initialOffer",void 0),C(this,"transport",void 0),C(this,"statsFilter",void 0),C(this,"localCandidateCount",0),C(this,"_isInRestartIce",!1),C(this,"mutex",void 0),C(this,"onLocalCandidate",void 0),C(this,"remoteSDP",void 0),C(this,"pendingCandidates",[]),C(this,"localCapabilities",void 0),C(this,"isReady",!1),C(this,"restartCnt",0),C(this,"curTurnServerIndex",0),this.store=n,this.spec=t,this.mutex=new Cn("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Md.resolvePCConfiguration(t,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=i??ai.SEND_ONLY,this.name=this.direction===ai.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=bp(this.peerConnection,I("STATS_UPDATE_INTERVAL"),void 0,Nt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{const n=await ry();if(this.localCapabilities=zl(n),t){const{sdp:i}=t,r=L9(t,k9),s=(function(){const p={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},m=Kl(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),_={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},g={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},b={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Or(m,p,"videoExtensions",_,g,b),Or(m,p,"videoCodecs",_,g,b),Or(m,p,"audioExtensions",_,g,b),Or(m,p,"audioCodecs",_,g,b),I("RAISE_H264_BASELINE_PRIORITY")){const v=b.videoCodecs.findIndex((R=>R.rtpMap&&R.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&R.fmtp&&R.fmtp.parameters["profile-level-id"]==="42001f"));if(v!==-1){const R=b.videoCodecs.findIndex((O=>O.rtpMap&&O.rtpMap.encodingName.toLocaleLowerCase()==="h264"));if(R<v){S.debug("raising H264 baseline profile priority");const O=b.videoCodecs[v];b.videoCodecs.splice(v,1),b.videoCodecs.splice(R,0,O)}R!==-1&&I("FILTER_SEND_H264_BASELINE")&&(_.videoCodecs=_.videoCodecs.filter((O=>!(O.rtpMap&&O.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&O.fmtp&&O.fmtp.parameters["profile-level-id"]!=="42001f"))))}}return{send:_,recv:g,sendrecv:b}})({},{},i);this.remoteSDP=new Ux({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const o=await this.peerConnection.createAnswer();if(!o.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=bs(o.sdp);await this.peerConnection.setLocalDescription(o);const c=await OP({},{},o.sdp);this.localCapabilities=zl(c);const u=this.peerConnection.getTransceivers()[0];return u!=null&&u.receiver&&u.receiver.transport&&this.tryBindTransportEvents(u.receiver.transport),Go(Go({},a),{},{sdp:o.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=bs(i.sdp);return this.initialOffer=i,Go(Go({},r),{},{sdp:i.sdp})}}catch(n){throw new J(N.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:n,iceParameters:i,dtlsParameters:r}=t,s=await OP({},{},n);this.remoteSDP=new Ux({remoteIceParameters:i,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:s,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const o=this.peerConnection.getTransceivers()[0];o!=null&&o.sender&&o.sender.transport&&this.tryBindTransportEvents(o.sender.transport)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach((n=>{this.peerConnection.addIceCandidate(n)})),this.pendingCandidates=[])}catch(n){throw new J(N.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(t,n,i){var r=this;return li((function*(){const s=yield He(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=[],a=r.remoteSDP.receive(t,n,i);t.forEach(((R,O)=>{if(a[O].needCreateTransceiver){const D=r.peerConnection.addTransceiver(R._mediaStreamTrack,{direction:"sendonly"});o.push(D),R._updateRtpTransceiver(D)}else{const D=r.peerConnection.getTransceivers().find((x=>x.mid===a[O].mid));if(!D)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[O].mid));o.push(D),R._updateRtpTransceiver(D)}})),Nt()&&I("SIMULCAST")===!0&&(yield He(r.applySimulcastForFirefox(o,t)));const c=a.map((R=>R.mid)),u=yield He(r.peerConnection.createOffer()),p=r.mungSendOfferSDP(u.sdp,t,c),m=ri(p),_=c.map((R=>{const O=m.mediaDescriptions.find((D=>D.attributes.mid===R));if(!O)throw new Error("Cannot extract ssrc from mediaDescription.");return ey(O,I("USE_PUB_RTX"))})),g=o.map(((R,O)=>{const D=c[O];return{localSSRC:_[O],id:D}}));yield He(r.peerConnection.setLocalDescription({type:"offer",sdp:p}));try{yield g}catch(R){const O=r.remoteSDP.toString();throw yield He(r.peerConnection.setLocalDescription({type:"offer",sdp:p})),yield He(r.peerConnection.setRemoteDescription({type:"answer",sdp:O})),yield He(r.stopSending(c,!0)),R}yield He(r.applySimulcastEncodings(o,t)),yield He(r.applySendEncodings(o,t));const b=r.remoteSDP.toString(),v=r.logSDPExchange(p,"offer","local","send");return v?.(b),yield He(r.setRemoteDescription({type:"answer",sdp:b})),o.map(((R,O)=>{const D=c[O];return{localSSRC:_[O],id:D}}))}catch(o){throw o instanceof J?o:new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{s()}}))()}async stopSending(t,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter((c=>t.indexOf(c.mid)!==-1));if(r.length!==t.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));r.map((c=>{var u;c.direction="inactive",(u=c.stop)===null||u===void 0||u.call(c)}));const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o?.(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,n,i,r);if(o){const c=this.remoteSDP.toString(),u=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const p=await this.peerConnection.createAnswer(),m=this.mungReceiveAnswerSDP(p.sdp,s,t);u?.(m||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:m}),S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find((c=>c.mid===s));if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(s){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async mockReceive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,n,i,r);if(o){const a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});const u=await this.peerConnection.createAnswer(),p=this.mungReceiveAnswerSDP(u.sdp,s,t);c?.(p||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:p}),S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(s){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===wa.Auto&&(this.store.p2pTransport=wa.SdRtn,Xe().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Md.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Xe().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Md.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:i}=bs(n.sdp);return this.store.descriptionStart(),this.direction===ai.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),i}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===ai.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:i}=bs(n.sdp);return await this.peerConnection.setLocalDescription(n),i}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new J(N.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getTransceivers().filter((r=>r.mid===t));i.length===1&&(this.isVP8Simulcast(n)?Nt()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getTransceivers().find((r=>r.mid===n));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:Go(Go({},Rr),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:Go(Go({},Rr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t,n;ie(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var n;t.candidate.candidate&&((n=this.onLocalCandidate)===null||n===void 0||n.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r={iceServers:[]};var s;return t.iceServers?r.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(ya(t.turnServer.servers)?r.iceServers=t.turnServer.servers:(r.iceServers&&r.iceServers.push(...Md.turnServerConfigToIceServers(t.turnServer.servers,n,i)),I("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&t.turnServer.serversFromGateway&&r.iceServers.push(...Md.turnServerConfigToIceServers(t.turnServer.serversFromGateway,n,i)),ie(s=[wa.Relay,wa.SdRtn]).call(s,n)&&(r.iceTransportPolicy="relay"),I("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((o=>{o.forceturn&&(r.iceTransportPolicy="relay")})))),I("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),S.debug("P2PConnection p2pTransport is ".concat(n)),r}static turnServerConfigToIceServers(t,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r=[],s=t.filter((a=>a.tcpport));S.debug("P2PConnection turnServers is ".concat(s,", current index is ").concat(i));const o=s.length>i?s[i]:s[0];switch(n){case wa.SdRtn:const a=t.filter((u=>{var p;return ie(p=u.username).call(p,"glb:")&&u.turnServerURL==u.turnServerURL})),c=a.length>i?a[i]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(Ir(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(Ir(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case wa.Relay:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(Ir(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}));break;default:o&&(r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turn:".concat(o.turnServerURL,":").concat(o.tcpport,"?transport=udp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"turns:".concat(Ir(o.turnServerURL),":").concat(o.tcpport,"?transport=tcp")}),r.push({username:o.username,credential:o.password,credentialType:"password",urls:"stun:".concat(o.turnServerURL,":").concat(o.tcpport)}))}return r}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var i;t!=null&&t.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,t.state))},t.onerror=i=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in i?i.error:i)};const n=t.iceTransport;n&&(n.onstatechange=()=>{const i=t?.iceTransport.state;var r;i&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,i))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:i,remote:r}=n.getSelectedCandidatePair()||{};if(i&&r){const s=i.address+":"+i.port,o=r.address+":"+r.port;S.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(Cs(s)),", remote ").concat(JSON.stringify(Cs(o))))}}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i;if(n||(n=this.peerConnection.getSenders().find((p=>p.track===t._mediaStreamTrack))),!n)return S.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return S.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Xe().supportSetRtpSenderParameters)return S.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},s={};switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(t._encoderConfig){var o;const{bitrateMax:p,frameRate:m,scaleResolutionDownBy:_}=t._encoderConfig;p&&(s.maxBitrate=1e3*p),ie(o=t._hints).call(o,ht.LOW_STREAM)&&(m&&(s.maxFramerate=fi(m)),_&&_>=1&&(s.scaleResolutionDownBy=_))}if(I("DSCP_TYPE")&&Ss()){var a;const p=I("DSCP_TYPE");ie(a=["very-low","low","medium","high"]).call(a,p)&&(s.networkPriority=p)}const c=n.getParameters(),u=(i=c.encodings)===null||i===void 0?void 0:i[0];Nt()&&!u&&(r.encodings=[s]),u&&Object.assign(u,s),Object.assign(c,r),S.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await n.setParameters(c)}async applySendEncodings(t,n){try{if(!Xe().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=n[i];s instanceof bt&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,i){const r=ri(t);return n.forEach(((s,o)=>{const a=i[o],c=r.mediaDescriptions.find((u=>u.attributes.mid===a));c&&(Va(c,s),iy(c,s,this.store.codec))})),Qs(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let c=0;c<t.length;c++){var i,r,s,o,a;const u=t[c],p=n[c];if(p instanceof bt&&!ie(i=p._hints).call(i,ht.LOW_STREAM)&&(r=p._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=p._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=p._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=p._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const m={},_={high:1e3*(p._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{rid:"m",active:!0,maxBitrate:_.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:_.high}];const g=u.sender.getParameters();await u.sender.setParameters(Object.assign(g,m))}}}async applySimulcastEncodings(t,n){if(!Nt()&&t.length===n.length)for(let i=0;i<t.length;i++){const r=n[i];if(r instanceof bt&&this.isVP8Simulcast(r)){const s=t[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var n,i,r,s,o;return!!(t instanceof bt&&I("SIMULCAST")&&this.store.codec==="vp8"&&!ie(n=t._hints).call(n,ht.LOW_STREAM)&&(i=t._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,r){if(I("SDP_LOGGING"))return S.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),t),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((o=>{o.direction="inactive"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();r?.(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((async o=>{o.direction="sendonly"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const s=this.remoteSDP.toString();r?.(s),await this.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(t,n){var i;if(n=n??((i=this.currentRemoteDescription)===null||i===void 0?void 0:i.sdp)){var r;const s=(r=ri(n).mediaDescriptions.find((o=>o.attributes.mid===t)))===null||r===void 0?void 0:r.attributes.ssrcs;return s?.[0].ssrcId}}async setRemoteDescription(t){var n;await this.peerConnection.setRemoteDescription(t),ie(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,n,i){const r=ri(t),s=r.mediaDescriptions.find((o=>o.attributes.mid===n));return s&&i===_e.AUDIO&&s.media.mediaType==="audio"&&Ed(s),Qs(r)}},le(Pt.prototype,"establish",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"establish"),Pt.prototype),le(Pt.prototype,"connect",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"connect"),Pt.prototype),le(Pt.prototype,"receive",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"receive"),Pt.prototype),le(Pt.prototype,"mockReceive",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"mockReceive"),Pt.prototype),le(Pt.prototype,"stopReceiving",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"stopReceiving"),Pt.prototype),le(Pt.prototype,"restartICE",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"restartICE"),Pt.prototype),le(Pt.prototype,"close",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"close"),Pt.prototype),le(Pt.prototype,"updateEncoderConfig",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"updateEncoderConfig"),Pt.prototype),le(Pt.prototype,"updateSendParameters",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"updateSendParameters"),Pt.prototype),le(Pt.prototype,"replaceTrack",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"replaceTrack"),Pt.prototype),le(Pt.prototype,"muteLocal",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"muteLocal"),Pt.prototype),le(Pt.prototype,"unmuteLocal",[kr],Object.getOwnPropertyDescriptor(Pt.prototype,"unmuteLocal"),Pt.prototype),Pt);function kr(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}let ns=(function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e})({});var Fx,Bx,Wx,Gx,Hx,Kx,Yx,zx,qx,Xx,Jx,jt;function Qx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function jm(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?Qx(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qx(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let x9=(Fx=is(ns.SEND_ONLY),Bx=is(ns.SEND_ONLY),Wx=is(),Gx=is(ns.RECEIVE_ONLY),Hx=is(ns.RECEIVE_ONLY),Kx=is(ns.RECEIVE_ONLY),Yx=is(ns.RECEIVE_ONLY),zx=is(ns.RECEIVE_ONLY),qx=is(ns.RECEIVE_ONLY),Xx=is(),Jx=is(ns.RECEIVE_ONLY),jt=class extends Vt{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(be.StateChange,t,this._state)}constructor(e,t){super(),C(this,"isPlanB",!1),C(this,"store",void 0),C(this,"statsUploader",void 0),C(this,"sendConnection",void 0),C(this,"recvConnection",void 0),C(this,"localTrackMap",new Map),C(this,"remoteUserMap",new Map),C(this,"localDataChannels",[]),C(this,"pendingLocalTracks",[]),C(this,"pendingRemoteTracks",[]),C(this,"statsCollector",void 0),C(this,"dtlsFailedCount",0),C(this,"sendMutex",void 0),C(this,"recvMutex",void 0),C(this,"_state",ut.Disconnected),C(this,"_restartStates",["disconnected","failed"]),C(this,"reconnectInterval",void 0),C(this,"uploadUnplinkStarted",!1),C(this,"uploadDownlinkStarted",!1),C(this,"uplinkStateUploadInterval",void 0),C(this,"downlinkStatsUploadInterval",void 0),C(this,"handleMuteLocalTrack",(async(n,i,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==ut.Connected)return void r(new J(N.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const c=this.filterTobeMutedTracks(n);if(c.length===0)return void i();const u=c.find((g=>g[0]==="videoLowTrack"));u&&u[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(c.map((g=>{let[,{id:b}]=g;return b})));let p=!1;var o,a;n.trackMediaType==="video"?p=!((o=this.localTrackMap.get(re.LocalAudioTrack))===null||o===void 0||!o.track._muted):p=((a=this.localTrackMap.get(re.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;const m=this.createMuteMessage(c);await wt(this,be.RequestMuteLocal,m);const _=n.trackMediaType==="video"?Do.MUTE_LOCAL_VIDEO:Do.MUTE_LOCAL_AUDIO;await wt(this,be.RequestP2PMuteLocal,{action:_,message:m,isMuteAll:p}),i()}catch(c){r(c)}finally{s()}})),C(this,"handleUnmuteLocalTrack",(async(n,i,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==ut.Connected)return void r(new J(N.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const o=this.filterTobeUnmutedTracks(n);if(o.length===0)return void i();await this.sendConnection.unmuteLocal(o.map((u=>{let[,{id:p}]=u;return p})));const a=this.createUnmuteMessage(o),c=n.trackMediaType==="video"?Do.UNMUTE_LOCAL_VIDEO:Do.UNMUTE_LOCAL_AUDIO;await wt(this,be.RequestP2PMuteLocal,{action:c,message:a}),i()}catch(o){r(o)}finally{s()}})),C(this,"handleUpdateVideoEncoder",(async(n,i,r,s)=>{let o;typeof s=="boolean"&&s||(o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{const c=this.localTrackMap.get(re.LocalVideoTrack);if(!this.sendConnection||!c||c.track!==n||this.state!==ut.Connected)return void i();const{id:u,track:p}=c;u&&(await this.sendConnection.updateSendParameters(u,p),await this.sendConnection.updateEncoderConfig(u,p),this.emit(be.UpdateVideoEncoder,p)),i()}catch(c){r(c)}finally{var a;(a=o)===null||a===void 0||a()}})),C(this,"handleUpdateVideoSendParameters",(async(n,i,r)=>{const s=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const o=this.localTrackMap.get(re.LocalVideoTrack);if(!this.sendConnection||!o||o.track!==n||this.state!==ut.Connected)return void i();const{id:a,track:c}=o;a&&await this.sendConnection.updateSendParameters(a,c),i()}catch(o){r(o)}finally{s()}})),C(this,"handleReplaceTrack",(async(n,i,r,s)=>{let o;S.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof s=="boolean"&&s||(o=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;const u=Array.from(this.localTrackMap.entries()).find((p=>{let[,{track:m}]=p;return n===m}));if(!this.sendConnection||!u||u[1].id===void 0||this.state!==ut.Connected)return void i();if(await((a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(n,u[1].id)),u[0]===re.LocalVideoTrack&&Xe().supportDualStreamEncoding){const p=this.localTrackMap.get(re.LocalVideoLowTrack);if(p){const m=n._mediaStreamTrack.clone();p.track._originMediaStreamTrack.stop(),p.track._mediaStreamTrack=m,p.track._originMediaStreamTrack=m,await new de(((_,g)=>{this.handleReplaceTrack(p.track,_,g,!0)}))}}i()}catch(u){r(u)}finally{var c;(c=o)===null||c===void 0||c()}})),C(this,"handleGetLocalVideoStats",(n=>{n(this.statsCollector.getLocalVideoTrackStats())})),C(this,"handleGetLocalAudioStats",(n=>{n(this.statsCollector.getLocalAudioTrackStats())})),C(this,"handleGetRemoteVideoStats",(n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid])),C(this,"handleGetRemoteAudioStats",(n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid])),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new uL(e),this.bindStatsUploaderEvents(),this.sendMutex=new Cn("P2PChannel2-send-mutex",e.clientId),this.recvMutex=new Cn("P2PChannel2-recv-mutex",e.clientId),this.reconnectInterval=window.setInterval((()=>{[this.sendConnection,this.recvConnection].forEach((n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))}))}),I("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new J(N.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e){throw new J(N.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let n;try{if(t){this.recvConnection&&(S.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new jx(e,this.store,ai.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const i=await this.recvConnection.establish(t);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=ut.New,this.sendConnection&&(S.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new jx(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n()}}async p2pConnect(e){if(!this.sendConnection)throw new J(N.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=ut.Connected}async addRemoteCandidate(e,t){if(t===ai.RECEIVE_ONLY){if(!this.sendConnection)throw new J(N.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new J(N.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,n){var i=this;return li((function*(){const r=yield He(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==ut.Connected){i.throwIfTrackTypeNotMatch(e);const u=e.filter((p=>i.pendingLocalTracks.indexOf(p)===-1));return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(u))}i.store.pubId=i.store.pubId+1,Fn.markPublishStart(i.store.clientId,i.store.pubId);const s=i.filterTobePublishedTracks(e,t,n);if(s.length===0)return void(yield He(i.tryToUnmuteAudio(e)));s.forEach((u=>{let{track:p,type:m}=u;const _=Date.now();i.store.publish(p.getTrackId(),m===re.LocalAudioTrack?"audio":"video",_)})),i.bindLocalTrackEvents(s);const o=yield He(i.sendConnection.send(s.map((u=>{let{track:p}=u;return p})),i.store.codec,i.store.audioCodec)),a=(yield He(o.next())).value,c=i.createGatewayPublishMessage(s,a);try{yield c}catch(u){throw o.throw(u),u?.code===N.WS_ABORT&&s.forEach((p=>{let{track:m}=p;i.pendingLocalTracks.indexOf(m)===-1&&i.pendingLocalTracks.push(m)})),i.unbindLocalTrackEvents(s),u}yield He(o.next()),s.forEach((u=>{let{type:p}=u;i.statsCollector.addLocalStats(p)})),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(s,a),s.forEach((u=>{let{track:p,type:m}=u;const _=Date.now();i.store.publish(p.getTrackId(),m===re.LocalAudioTrack?"audio":"video",void 0,_)})),i.startUploadUplinkState()}finally{r()}}))()}async unpublish(e){if(!this.sendConnection||this.state!==ut.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter((r=>!ie(e).call(e,r))));const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const n=t.find((r=>r[0]==="videoLowTrack"));n&&n[1].track.close();const i=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map((r=>{let[,{id:s}]=r;return s}))),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map((r=>{let[s,{track:o}]=r;return{type:s,track:o}}))),t.forEach((r=>{let[s]=r;this.statsCollector.removeLocalStats(s)})),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===ut.Connected)return n&&n[1].track.close(),i;e.forEach((r=>{const s=this.pendingLocalTracks.indexOf(r);s!==-1&&this.pendingLocalTracks.splice(s,1)}))}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const t=[],n=[];Array.from(this.localTrackMap.entries()).forEach((i=>{let[r,{track:s,ssrcs:o}]=i;const a={stream_type:Rq(s,r),ssrcs:o};s._muted||!s._enabled?t.push(a):n.push(a)})),t.length>0&&t.forEach((i=>{wt(this,be.RequestMuteLocal,[i])})),n.length>0&&n.forEach((i=>{wt(this,be.RequestUnmuteLocal,[i])}))};e(),this.uplinkStateUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return li((function*(){throw new J(N.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")}))()}async republish(){this.pendingLocalTracks.length>0&&(S.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await sn(this,be.RequestRePublish,this.pendingLocalTracks),this.emit(be.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new J(N.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,n,i){var r;if(!this.recvConnection)throw new J(N.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(e))!==null&&r!==void 0&&r.has(t))return;const{track:s,mid:o,transceiver:a}=await this.recvConnection.receive(t,[{ssrcId:n}],String(e.uid),i);t===_e.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(s):(e._audioTrack=new ld(s,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),a&&e._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(s):(e._videoTrack=new dd(s,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),a&&e._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._videoTrack));const c=this.remoteUserMap.get(e);c?c.set(t,o):this.remoteUserMap.set(e,new Map([[t,o]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const u=this.pendingRemoteTracks.findIndex((p=>{let{user:m,kind:_}=p;return m.uid===e.uid&&t===_}));u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(be.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,n,i){if(!this.recvConnection)throw new J(N.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:n}],String(e.uid),i)}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter((s=>{let{user:o,kind:a}=s;return t!==void 0?o.uid===e.uid&&t===a:o.uid===e.uid}));if(i.forEach((s=>{const o=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(o,1)})),this.recvConnection||n||i.forEach((s=>{let{kind:o}=s;var a;if(o===_e.AUDIO)(a=e._audioTrack)===null||a===void 0||a._destroy(),e._audioTrack=void 0;else if(o===_e.VIDEO){var c;(c=e._videoTrack)===null||c===void 0||c._destroy(),e._videoTrack=void 0}})),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(e,t);r.length!==0&&(await this.recvConnection.stopReceiving(r.map((s=>{let[,{id:o}]=s;return o}))),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach((s=>{let[o,{kind:a}]=s;var c,u;if(a===_e.VIDEO&&o._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),a===_e.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),n||((u=o._videoTrack)===null||u===void 0||u._destroy(),o._videoTrack=void 0);else if(a===_e.AUDIO){var p;this.unbindRemoteTrackEvents(o._audioTrack),!n&&((p=o._audioTrack)===null||p===void 0||p._destroy(),o._audioTrack=void 0)}})),r.forEach((s=>{let[,{kind:o}]=s;wt(this,be.RequestP2PMuteRemote,o)})))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach((t=>{let[,n]=t;[_e.VIDEO,_e.AUDIO].forEach((i=>{n.has(i)?wt(this,be.RequestP2PUnmuteRemote,i):wt(this,be.RequestP2PMuteRemote,i)}))}));e(),this.downlinkStatsUploadInterval=window.setInterval((()=>{e()}),3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new J(N.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new J(N.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new J(N.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new J(N.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void S.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void S.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===_e.VIDEO?e._videoSSRC:e._audioSSRC;i!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void S.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(t)||S.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){const t=this.localTrackMap.get(re.LocalAudioTrack);if(t?.track instanceof dn){const n=t.track;return Array.from(this.localTrackMap.entries()).filter((i=>{let[r]=i;return r!==re.LocalAudioTrack})).filter((i=>{let[r]=i;return!(e&&r===re.LocalVideoLowTrack)})).map((i=>{let[,{track:r}]=i;return r})).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter((n=>{let[i]=n;return!(e&&i===re.LocalVideoLowTrack)})).map((n=>{let[,{track:i}]=n;return i}))}reportPublishEvent(e,t,n,i,r){if(e){const o=this.localTrackMap.get(re.LocalAudioTrack),a=i?this.localTrackMap.get(re.LocalVideoLowTrack):this.localTrackMap.get(re.LocalVideoTrack);Se.publish(this.store.sessionId,{eventElapse:Fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(ht.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var s;n||(n=[]);const o=n.find((c=>c instanceof Yt)),a=i?(s=this.localTrackMap.get(re.LocalVideoTrack))===null||s===void 0?void 0:s.track:n.find((c=>c instanceof bt));Se.publish(this.store.sessionId,{eventElapse:Fn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:o?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(ht.SCREEN_TRACK)!==-1,audio:!!o,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===_e.VIDEO?n._videoSSRC:n._audioSSRC;r&&Se.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===_e.VIDEO,audio:i===_e.AUDIO,peerid:n.uid,subscribeRequestid:i===_e.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:Fn.measureFromSubscribeStart(this.store.clientId,r)})}reset(){S.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Cn("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new Cn("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(re.LocalAudioTrack);if(e?.track instanceof dn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach((n=>{t.removeAudioTrack(n)}))}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=ut.Disconnected}getStats(e){var t,n;return e?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(t=this.sendConnection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.recvConnection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(re.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(re.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof bt||t&&t.track instanceof Yt?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(zn(t=this.remoteUserMap).call(t)).find((i=>i.uid===e));return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map((n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}}));const t=this.localTrackMap.get(re.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=la(e).call(e,((n,i)=>n.level-i.level)),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(S.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=ut.Reconnecting,I("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&((n=t._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())})),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach((e=>{var t;let[n,{track:i}]=e;switch(n){case re.LocalVideoTrack:ie(t=i._hints).call(t,ht.LOW_STREAM)?i.close():this.pendingLocalTracks.push(i);break;case re.LocalAudioTrack:i instanceof dn?this.pendingLocalTracks=this.pendingLocalTracks.concat(i.trackList):this.pendingLocalTracks.push(i);case re.LocalVideoLowTrack:}})),this.emit(be.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;Array.from(zn(n).call(n)).forEach((i=>{this.setPendingRemoteMedia(t,i)})),this.emit(be.MediaReconnectStart,t.uid)})),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),S.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof ko?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let n,i;if(e===ai.SEND_ONLY){if(!this.sendConnection)throw new J(N.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection}else{if(!this.recvConnection)throw new J(N.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection}try{if(t){const r=await i.restartICE(t);return i.isInRestartIce=!1,r}{const r=await i.restartICE();if(r){const s=await sn(this,be.RequestP2PRestartICE,{direction:ai.RECEIVE_ONLY,iceParameter:r});await i.restartICE(s),i.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(re.LocalVideoTrack),n=this.localTrackMap.get(re.LocalAudioTrack),i=e.videoSend.find((g=>{var b;return g.ssrc===(t==null||(b=t.ssrcs)===null||b===void 0?void 0:b[0].ssrcId)})),r=e.audioSend.find((g=>{var b;return g.ssrc===(n==null||(b=n.ssrcs)===null||b===void 0?void 0:b[0].ssrcId)}));if(!i||!r)return 1;const s=Di(this,be.NeedSignalRTT),o=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=o&&a?(o+a)/2:o||a,u=(c&&s?(c+s)/2:c||s)||0,p=100*e.sendPacketLossRate*.7/50+.3*u/1500,m=p<.17?1:p<.36?2:p<.59?3:p<.1?4:5,_=t?.track;if(_&&_._encoderConfig&&_._hints.indexOf(ht.SCREEN_TRACK)===-1){const g=_._encoderConfig.bitrateMax,b=e.bitrate.actualEncoded;if(g&&b){const v=(1e3*g-b)/(1e3*g);return tP[v<.15?0:v<.3?1:v<.45?2:v<.6?3:4][m]}}return m}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach((n=>{let[i]=n;const r=i._audioSSRC,s=i._videoSSRC,o=e.audioRecv.find((b=>b.ssrc===r)),a=e.videoRecv.find((b=>b.ssrc===s));if(!o&&!a)return void(t+=1);const c=Di(this,be.NeedSignalRTT),u=e.rtt,p=(u&&c?(u+c)/2:u||c)||0,m=o?o.jitterMs:void 0,_=e.recvPacketLossRate;let g=.7*_*100/50+.3*p/1500;m&&(g=.6*_*100/50+.2*p/1500+.2*m/400),t+=g<.1?1:g<.17?2:g<.36?3:g<.59?4:5})),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new de(((t,n)=>{this.handleMuteLocalTrack(e,t,n)}))}filterTobePublishedTracks(e,t,n){const i=[],r=Xe(),s=this.getAllTracks();e=Jc(e=e.filter((c=>s.indexOf(c)===-1)));let o=!1,a=!1;for(const c of e){if(c instanceof bt&&(this.localTrackMap.has(re.LocalVideoTrack)||o?new J(N.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:re.LocalVideoTrack}),o=!0),t)){const u=this.getLowVideoTrack(c,n);i.push({track:u,type:re.LocalVideoLowTrack})}if(c instanceof Yt){const u=this.localTrackMap.get(re.LocalAudioTrack);if(u){if(!(u.track instanceof dn))throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const p=i.find((m=>{let{type:_}=m;return _===re.LocalAudioTrack}));if(!(p.track instanceof dn))throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");p.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof dn||c._bypassWebAudio)i.push({track:c,type:re.LocalAudioTrack});else{const p=new dn;p.addAudioTrack(c),i.push({track:p,type:re.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=Jc(e=e.filter((i=>n.indexOf(i)!==-1)));for(const i of e){if(i instanceof Yt){const r=this.localTrackMap.get(re.LocalAudioTrack);if(!r)continue;r.track instanceof dn?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(t.push([re.LocalAudioTrack,r]),r.track.close())):t.push([re.LocalAudioTrack,r])}if(i instanceof bt){const r=this.localTrackMap.get(re.LocalVideoTrack);if(!r)continue;t.push([re.LocalVideoTrack,r]);const s=this.localTrackMap.get(re.LocalVideoLowTrack);s&&t.push([re.LocalVideoLowTrack,s])}}return t}bindLocalTrackEvents(e){e.forEach((t=>{let{track:n,type:i}=t;switch(i){case re.LocalVideoTrack:n.addListener(ye.GET_STATS,this.handleGetLocalVideoStats),n.addListener(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(ye.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(ye.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(ye.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case re.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case re.LocalVideoLowTrack:}}))}bindLocalAudioTrackEvents(e,t){e instanceof dn?e.trackList.forEach((n=>{n.addListener(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(ye.GET_STATS,this.handleGetLocalAudioStats),n.addListener(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.addListener(ye.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(ye.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map((t=>{let[n,{track:i}]=t;return{track:i,type:n}}))),e.forEach((t=>{let{track:n,type:i}=t;switch(i){case re.LocalVideoTrack:n.off(ye.GET_STATS,this.handleGetLocalVideoStats),n.off(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(ye.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(ye.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(ye.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case re.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case re.LocalVideoLowTrack:}}))}unbindLocalAudioTrackEvents(e){e instanceof dn?e.trackList.forEach((t=>{t.off(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ye.GET_STATS,this.handleGetLocalAudioStats),t.off(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)})):(e.off(ye.GET_STATS,this.handleGetLocalAudioStats),e.off(ye.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ye.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ye.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ye.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ye.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof dd&&t.addListener(ye.GET_STATS,(n=>{n(this.handleGetRemoteVideoStats(e))})),t instanceof ld&&t.addListener(ye.GET_STATS,(n=>{n(this.handleGetRemoteAudioStats(e))}))}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ye.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach((e=>{let[t,n]=e;n.has(_e.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(_e.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)}))}createGatewayPublishMessage(e,t){return e.map(((n,i)=>{var r;let s,{track:o,type:a}=n;switch(a){case re.LocalAudioTrack:s=_t.Audio;break;case re.LocalVideoTrack:s=ie(r=o._hints).call(r,ht.SCREEN_TRACK)?_t.Screen:_t.High;break;case re.LocalVideoLowTrack:s=_t.Low}return{kind:a===re.LocalAudioTrack?_e.AUDIO:_e.VIDEO,stream_type:s,mid:t[i].id,ssrcs:t[i].localSSRC,isMuted:o.muted||!o.enabled}}))}createGatewayUnpublishMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case re.LocalVideoTrack:i=ie(n=s._hints).call(n,ht.SCREEN_TRACK)?_t.Screen:_t.High;break;case re.LocalAudioTrack:i=_t.Audio;break;case re.LocalVideoLowTrack:i=_t.Low}return{stream_type:i,ssrcs:o,mid:a}}))}assignLocalTracks(e,t){e.forEach(((n,i)=>{let{track:r,type:s}=n;this.localTrackMap.set(s,{track:r,id:t[i].id,ssrcs:t[i].localSSRC})}))}withdrawLocalTracks(e){e.forEach((t=>{let[n]=t;this.localTrackMap.delete(n)}))}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{var n;S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(be.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(e.isInRestartIce=!1),ie(n=this._restartStates).call(n,t)&&!e.isInRestartIce&&(t==="disconnected"&&await En(800),e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="failed"||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),Se.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:Ct.TRACER}).onSuccess(),this.emit(be.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var n;const i=Array.from(zn(n=this.remoteUserMap).call(n)).find((s=>s._audioSSRC===t));var r;i&&(this.store.subscribe(i.uid,"audio",void 0,void 0,void 0,Date.now()),(r=i.audioTrack)===null||r===void 0||r.emit(ir.FIRST_FRAME_DECODED),Se.firstRemoteFrame(this.store.sessionId,cn.FIRST_AUDIO_DECODE,Mt.FIRST_AUDIO_DECODE,{peer:i._uintid,subscribeElapse:Fn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var n;const i=Array.from(zn(n=this.remoteUserMap).call(n)).find((r=>r._audioSSRC===t));i&&Se.firstRemoteFrame(this.store.sessionId,cn.FIRST_AUDIO_RECEIVED,Mt.FIRST_AUDIO_RECEIVED,{peer:i._uintid,subscribeElapse:Fn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,n,i)=>{this.reportVideoFirstFrameDecoded(t,n,i)},e.onFirstVideoReceived=t=>{var n;const i=Array.from(zn(n=this.remoteUserMap).call(n)).find((r=>r._videoSSRC===t));i&&Se.firstRemoteFrame(this.store.sessionId,cn.FIRST_VIDEO_RECEIVED,Mt.FIRST_VIDEO_RECEIVED,{peer:i._uintid,subscribeElapse:Fn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,n)=>{const i=t.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(be.ConnectionTypeChange,i),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Po(n))," -> ").concat(JSON.stringify(Po(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,n)=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Po(n))," -> ").concat(JSON.stringify(Po(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(be.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===ai.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,S.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===ai.SEND_ONLY?this.restartICE(e):sn(this,be.RequestP2PRestartICE,{direction:ai.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const n=this.localTrackMap.get(re.LocalAudioTrack);if(e instanceof Yt&&n?.track instanceof dn)return n.track.isActive||t.push([re.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return e===s}));if(i&&(t.push(i),i[0]===re.LocalVideoTrack)){const r=this.localTrackMap.get(re.LocalVideoLowTrack);r&&t.push([re.LocalVideoLowTrack,r])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(re.LocalAudioTrack);if(e instanceof Yt&&n?.track instanceof dn)return n.track.isActive&&t.push([re.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find((r=>{let[,{track:s}]=r;return e===s}));if(i)if(i[0]===re.LocalVideoTrack){t.push(i);const r=this.localTrackMap.get(re.LocalVideoLowTrack);r&&t.push([re.LocalVideoLowTrack,r])}else t.push(i);return t}createMuteMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case re.LocalAudioTrack:i=_t.Audio;break;case re.LocalVideoTrack:i=ie(n=s._hints).call(n,ht.SCREEN_TRACK)?_t.Screen:_t.High;break;case re.LocalVideoLowTrack:i=_t.Low}return{stream_type:i,ssrcs:o,mid:a}}))}createUnmuteMessage(e){return e.map((t=>{var n;let i,[r,{track:s,ssrcs:o,id:a}]=t;switch(r){case re.LocalAudioTrack:i=_t.Audio;break;case re.LocalVideoTrack:i=ie(n=s._hints).call(n,ht.SCREEN_TRACK)?_t.Screen:_t.High;break;case re.LocalVideoLowTrack:i=_t.Low}return{stream_type:i,ssrcs:o,mid:a}}))}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach((r=>{let[s,o]=r;n.push([e,{kind:s,id:o}])}));return n}createUnsubscribeMessage(e){const t=[];return e.forEach((n=>{let[i,{kind:r,id:s}]=n;switch(r){case _e.VIDEO:return void(i._videoSSRC&&t.push({stream_type:_e.VIDEO,ssrcId:i._videoSSRC}));case _e.AUDIO:return void(i._audioSSRC&&t.push({stream_type:_e.AUDIO,ssrcId:i._audioSSRC}))}})),t}withdrawRemoteTracks(e){e.forEach((t=>{let[n,{kind:i}]=t;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))}))}async updateBitrateLimit(e){const t=this.localTrackMap.get(re.LocalVideoTrack),n=this.localTrackMap.get(re.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new de(((i,r)=>{this.handleUpdateVideoEncoder(t.track,i,r,!0)}))),n&&e.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new de(((i,r)=>{this.handleUpdateVideoEncoder(n.track,i,r,!0)})))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return e!=="connected"&&t!=="connected"}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof Yt){const n=this.filterTobeUnmutedTracks(e[t]);if(n.length===0)continue;const i=this.createUnmuteMessage(n);return void await wt(this,be.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter((e=>{let[,{ssrcs:t}]=e;return!!t})),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.recvConnection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(be.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(be.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await En(Tp(this.dtlsFailedCount,$t)),this.emit(be.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(re.LocalVideoTrack)||this.pendingLocalTracks.some((e=>e instanceof bt))}throwIfTrackTypeNotMatch(e){if(e.filter((t=>t instanceof bt)).length>1)throw new J(N.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter((t=>t instanceof Yt)).length>1&&(e.some((t=>t instanceof Yt&&t._bypassWebAudio))||!Xe().webAudioMediaStreamDest))throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof bt&&this.pendingLocalTracks.some((n=>n instanceof bt)))throw new J(N.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Yt&&this.pendingLocalTracks.some((n=>n instanceof Yt))&&(!Xe().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some((n=>n instanceof Yt&&n._bypassWebAudio))))throw new J(N.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const n=!I("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding,i=jm(jm({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=n?e._mediaStreamTrack.clone():Ry(e,i);const s=mt(8,"track-low-"),o=new bt(r,jm(jm({},n&&{scaleResolutionDownBy:$S(i,e)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,s);return o.on(Oa.TRANSCEIVER_UPDATED,(a=>{e._updateRtpTransceiver(a,id.LOW_STREAM)})),o._hints.push(ht.LOW_STREAM),e.addListener(ye.NEED_CLOSE,(()=>{o.close()})),o}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,n,i){var r;const s=Array.from(zn(r=this.remoteUserMap).call(r)).find((o=>o._videoSSRC===e));if(s){i||this.store.subscribe(s.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,a=o.subscribe.find((c=>c.userId===s.uid&&c.type==="video"));Se.firstRemoteVideoDecode(this.store.sessionId,cn.FIRST_VIDEO_DECODE,Mt.FIRST_VIDEO_DECODE,{peer:s._uintid,videowidth:t,videoheight:n,subscribeElapse:Fn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:i?1:0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.recvConnection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const s=await this.recvConnection.getRemoteSSRC(r);return s!==void 0&&s!==n}isPreSubScribe(e){return!1}async publishDataChannel(e){throw new J(N.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new J(N.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new J(N.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new J(N.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new J(N.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new J(N.NOT_SUPPORTED)}async preConnect(e){throw new J(N.NOT_SUPPORTED)}getEstablishParams(){throw new J(N.NOT_SUPPORTED)}async reSubscribe(e){throw new J(N.NOT_SUPPORTED)}reportVideoFirstFrameRender(e){}async updateVideoStreamParameter(e,t){throw new J(N.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach((e=>{let[t,{track:n}]=e;t===re.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,id.LOW_STREAM):n._updateRtpTransceiver(void 0)}))}},le(jt.prototype,"p2pConnect",[Fx],Object.getOwnPropertyDescriptor(jt.prototype,"p2pConnect"),jt.prototype),le(jt.prototype,"unpublish",[Bx],Object.getOwnPropertyDescriptor(jt.prototype,"unpublish"),jt.prototype),le(jt.prototype,"unpublishLowStream",[Wx],Object.getOwnPropertyDescriptor(jt.prototype,"unpublishLowStream"),jt.prototype),le(jt.prototype,"subscribe",[Gx],Object.getOwnPropertyDescriptor(jt.prototype,"subscribe"),jt.prototype),le(jt.prototype,"mockSubscribe",[Hx],Object.getOwnPropertyDescriptor(jt.prototype,"mockSubscribe"),jt.prototype),le(jt.prototype,"unsubscribe",[Kx],Object.getOwnPropertyDescriptor(jt.prototype,"unsubscribe"),jt.prototype),le(jt.prototype,"muteRemote",[Yx],Object.getOwnPropertyDescriptor(jt.prototype,"muteRemote"),jt.prototype),le(jt.prototype,"unmuteRemote",[zx],Object.getOwnPropertyDescriptor(jt.prototype,"unmuteRemote"),jt.prototype),le(jt.prototype,"hasRemoteMediaWithLock",[qx],Object.getOwnPropertyDescriptor(jt.prototype,"hasRemoteMediaWithLock"),jt.prototype),le(jt.prototype,"disconnectForReconnect",[Xx],Object.getOwnPropertyDescriptor(jt.prototype,"disconnectForReconnect"),jt.prototype),le(jt.prototype,"remoteMediaSsrcChanged",[Jx],Object.getOwnPropertyDescriptor(jt.prototype,"remoteMediaSsrcChanged"),jt.prototype),jt);function is(e){return function(t,n,i){const r=t[n];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var s=arguments.length,o=new Array(s),a=0;a<s;a++)o[a]=arguments[a];switch(e){case ns.SEND_ONLY:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,o)}finally{c()}}case ns.RECEIVE_ONLY:{const c=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,o)}finally{c()}}default:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n)),u=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,o)}finally{c(),u()}}}},i}}class Ja extends Vt{constructor(t,n){super(),C(this,"signal",void 0),C(this,"token",void 0),C(this,"tokenTimeout",void 0),C(this,"tokenInterval",void 0),C(this,"_sequence",0),C(this,"userMap",new Map),C(this,"encoder",new TextEncoder),this.signal=t,this.token=n;const i=()=>{this.signal.connectionState===$e.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*I("P2P_TOKEN_INTERVAL"))};i()}async send(t,n,i,r,s){var o;if(this.userMap.size===0)return;const a=Array.from(Ii(o=this.userMap).call(o))[0].token;typeof n!="string"&&(n=JSON.stringify(n)),r=r??mt(6,""),s=s??this._sequence++;const c={_id:r,_type:t,_seq:s,_message:n,token:"".concat(this.token,"_").concat(a)};I("SHOW_P2P_LOG")&&S.debug("send message",c,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(c)).forEach((p=>{this.signal.request(Ce.DATA_STREAM,{payload:Ao(this.encoder.encode(p))})}));const u=new de(((p,m)=>{const _=window.setTimeout((()=>{this.off("res-@".concat(r,"_ack"),g),this.off("res-@".concat(r),v),this.off(fd.ABORT,b),S.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(r)),this.userMap.size===0?m(new J(N.INVALID_REMOTE_USER)):m(new J(N.TIMEOUT))}),I("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),g=()=>{_&&window.clearTimeout(_),this.off(fd.ABORT,b),i&&p()},b=()=>{_&&window.clearTimeout(_),this.off("res-@".concat(r,"_ack"),g),this.off("res-@".concat(r),v),m(new J(N.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(r)))};this.once(fd.ABORT,b),this.once("res-@".concat(r,"_ack"),g);const v=(O,D)=>{R=!0,_&&window.clearTimeout(_),this.off("res-@".concat(r,"_ack"),g),this.off(fd.ABORT,b),O==="success"?p(D):m(new J(N.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(r)))};let R=!1;i||(this.once("res-@".concat(r),v),En(I("SIGNAL_REQUEST_TIMEOUT")).then((()=>{R||S.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(r,", ").concat(c))})))}));try{return await u}catch(p){if(p.code===N.TIMEOUT)return await this.send(t,n,i,r,s);throw p}}onMessage(t){var n;const{_uid:i}=t;let r,s=this.userMap.get(i);if(s)r=s.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==Jt.CHECK)return;const{token:u}=t;r=new Map,s={uid:i,isStart:!0,token:u,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(i,s),this.signal.emit(Le.ON_USER_ONLINE,{uid:i}),this.handleUserOnline()}if("id"in t&&"total"in t){var o;const{id:u,total:p}=t,m=(o=r.get(u))!==null&&o!==void 0?o:[];if(m.push(t),r.has(u)||r.set(u,m),m.length!==p)return;{const _=la(m).call(m,((g,b)=>g.index-b.index)).map((g=>g.payload)).join("");r.delete(u),(t=JSON.parse(_))._uid=i}}const{_type:a,token:c}=t;if(ie(n=[Jt.ACK,Jt.CHECK]).call(n,a))return a===Jt.CHECK&&this.handleCheckToken(s,c),void this.receiveMessage(t);c==="".concat(s.token,"_").concat(this.token)?this.handleReceivedMessage(t):S.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(s.token,"_").concat(this.token),t)}check(){const t={_id:mt(6,""),token:this.token,_type:Jt.CHECK};I("SHOW_P2P_LOG")&&S.debug("send message",t),this.signal.request(Ce.DATA_STREAM,{payload:Ao(this.encoder.encode(JSON.stringify(t)))})}ack(t){const n={_id:t,_type:Jt.ACK,token:this.token};I("SHOW_P2P_LOG")&&S.debug("send message",n),this.signal.request(Ce.DATA_STREAM,{payload:Ao(this.encoder.encode(JSON.stringify(n)))})}response(t,n,i){this.send(Jt.RESPONSE,JSON.stringify({success:!i,message:n}),!0,t)}handleReceivedMessage(t){const n=()=>{this.userMap.forEach((u=>{const{receivedMessagesMap:p,nextExpectedSequenceNumber:m}=u;for(;p.has(m);){const _=p.get(m);p.delete(m),this.receiveMessage(_),u.nextExpectedSequenceNumber++}}))};if(!t)return void n();const{_uid:i,_seq:r}=t,s=this.userMap.get(i),{receivedMessagesMap:o,isStart:a,nextExpectedSequenceNumber:c}=s;if(r<c)return this.ack(t._id),void S.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(t._message));o.set(r,t),a&&r===c&&(this.receiveMessage(t),o.delete(c),s.nextExpectedSequenceNumber++,n())}receiveMessage(t){const{_id:n,_type:i,_message:r,_uid:s}=t;if(I("SHOW_P2P_LOG")&&S.debug("receive message",t),n){let o;switch(t._type!==Jt.ACK&&(r&&(o=JSON.parse(r)),this.ack(t._id)),t._type){case Jt.CANDIDATE:case Jt.CONTROL:this.signal.emit(i,o,s);break;case Jt.PUBLISH:case Jt.UNPUBLISH:case Jt.RESTART_ICE:case Jt.CALL:o.uid=s,sn(this.signal,i,o).then((a=>{this.response(t._id,a)})).catch((()=>{this.response(t._id,void 0,!0)}));break;case Jt.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case Jt.RESPONSE:{const{success:a,message:c}=o;this.emit("res-@".concat(n),a?"success":"failed",c);break}}}}splitMessage(t){if(t.length<Ja.MAX_MESSAGE_SIZE)return[t];const n=[],{remoteToken:i}=JSON.parse(t),r=mt(6,"");let s=0,o=800;const a=Math.ceil(t.length/o);for(;t.length>0;){s++;const c={id:r,index:s,total:a,payload:t.slice(0,o),token:"".concat(this.token,"_").concat(i)};JSON.stringify(c).length>Ja.MAX_MESSAGE_SIZE?o-=50:(n.push(c),t=t.slice(o))}return n.map((c=>JSON.stringify(c)))}handleCheckToken(t,n){return t.token!==n?(S.debug("token changed, from ".concat(t.token," to ").concat(n)),this.reset(t.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout((()=>{S.debug("token timeout, ".concat(n)),this.reset(t.uid)}),I("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const t=await sn(this.signal,Jt.CALL,void 0),n=await this.send(Jt.CALL,t);this.signal.emit(Te.P2P_CONNECTION,n,!0)}async reset(t,n){const i=this.userMap.get(t);i&&(this.emit(fd.ABORT),this.signal.emit(Le.ON_USER_OFFLINE,{uid:i.uid,reason:Qz.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(S.debug("change local token from ".concat(n," to ").concat(n)),this.token=mt(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(fd.ABORT)}}C(Ja,"MAX_SIZE",1),C(Ja,"MAX_MESSAGE_SIZE",1024);class M9 extends Vt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===$e.CONNECTED?this.emit(Te.WS_CONNECTED):t===$e.RECONNECTING?this.emit(Te.WS_RECONNECTING,this._websocketReconnectReason):t===$e.CLOSED&&this.emit(Te.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,n){super(),C(this,"__name__","P2PSignal"),C(this,"_disconnectedReason",void 0),C(this,"_websocketReconnectReason",void 0),C(this,"_connectionState",$e.CLOSED),C(this,"reconnectToken",void 0),C(this,"p2pToken",void 0),C(this,"websocket",void 0),C(this,"openConnectionTime",void 0),C(this,"clientId",void 0),C(this,"lastMsgTime",Date.now()),C(this,"uploadCache",[]),C(this,"uploadCacheInterval",void 0),C(this,"rttRolling",new nS(5)),C(this,"pingpongTimer",void 0),C(this,"pingpongTimeoutCount",0),C(this,"joinResponse",void 0),C(this,"multiIpOption",void 0),C(this,"initError",void 0),C(this,"spec",void 0),C(this,"store",void 0),C(this,"_external_signal",void 0),C(this,"onWebsocketMessage",(i=>{if(i.data instanceof ArrayBuffer)return void this.emit(Te.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case Le.ON_DATA_STREAM:return void this.handleDataStream(r._message);case Le.MUTE_AUDIO:case Le.MUTE_VIDEO:case Le.ON_P2P_LOST:case Le.ON_USER_ONLINE:return;case Le.ON_USER_OFFLINE:const{uid:s}=r._message;return S.debug("[".concat(this.clientId,"] user-offline uid: ").concat(s)),void this._external_signal.reset(s)}if(this.emit(r._type,r._message),r._type===Le.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Le.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ze.UID_BANNED);break;case 15:this.close(Ze.IP_BANNED);break;case 16:this.close(Ze.CHANNEL_BANNED)}if(r._type===Le.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case we.ERR_LICENSE_MISSING:this.close(Ze.LICENSE_MISSING);break;case we.ERR_LICENSE_EXPIRED:this.close(Ze.LICENSE_EXPIRED);break;case we.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ze.LICENSE_MINUTES_EXCEEDED);break;case we.ERR_LICENSE_PERIOD_INVALID:this.close(Ze.LICENSE_PERIOD_INVALID);break;case we.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ze.LICENSE_MULTIPLE_SDK_SERVICE);break;case we.ERR_LICENSE_ILLEGAL:this.close(Ze.LICENSE_ILLEGAL);break;default:this.close()}}})),this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new JS("gateway-".concat(this.clientId),this.spec.retryConfig,!0,I("JOIN_GATEWAY_USE_DUAL_DOMAIN"),I("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===$e.CONNECTED&&this.reconnect("retry",kn.OFFLINE)})),this.p2pToken=mt(6,""),this._external_signal=new Ja(this,this.p2pToken)}async request(t,n,i,r){const s=mt(6,""),o={_id:s,_type:t,_message:n},a=this.websocket.connectionID,c=()=>new de(((b,v)=>{if(this.connectionState===$e.CONNECTED)return b();const R=()=>{this.off(Te.WS_CLOSED,O),b()},O=()=>{this.off(Te.WS_CONNECTED,R),v(new J(N.WS_ABORT))};this.once(Te.WS_CONNECTED,R),this.once(Te.WS_CLOSED,O)}));if(this.connectionState!==$e.CONNECTING&&this.connectionState!==$e.RECONNECTING||t===Ce.JOIN||t===Ce.REJOIN||await c(),this.websocket.sendMessage(o,!0),r)return;const u=new de(((b,v)=>{let R=!1;const O=(x,B)=>{R=!0,b({isSuccess:x==="success",message:B||{}}),this.off(Te.WS_CLOSED,D),this.off(Te.WS_RECONNECTING,D),this.emit(Te.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(s),O);const D=()=>{v(new J(N.WS_ABORT,"type: ".concat(t))),this.off(Te.WS_CLOSED,D),this.off(Te.WS_RECONNECTING,D),this.off("res-@".concat(s),O)};this.once(Te.WS_CLOSED,D),this.once(Te.WS_RECONNECTING,D),En(I("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||R||(S.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(Te.REQUEST_TIMEOUT,t,n))}))}));let p=null;try{p=await u}catch(b){if(this.connectionState===$e.CLOSED||t===Ce.LEAVE)throw new J(N.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?b.throw():t===Ce.JOIN||t===Ce.REJOIN?null:(await c(),await this.request(t,n))}if(p.isSuccess)return p.message;const m=Number(p.message.error_code||p.message.code),_=Ua(m),g=new J(N.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(p.message.error_str),{code:m,data:p.message,desc:_.desc});return _.action==="success"?p.message:(S.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(m,", message: ").concat(_.desc,", action: ").concat(_.action)),m===we.ERR_TOO_MANY_BROADCASTERS?((t===Ce.JOIN||t===Ce.REJOIN)&&(this.initError=g,this.close()),g.throw()):_.action==="failed"?g.throw():_.action==="quit"?(this.initError=g,this.close(),g.throw()):(m===we.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=p.message.option,S.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",kn.MULTI_IP)):this.reconnect(_.action,kn.SERVER_ERROR),t===Ce.JOIN||t===Ce.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new de((i=>{const r=s=>{(!n||n(s))&&(this.off(t,r),i(s))};this.on(t,r)}))}uploadWRTCStats(t){if(!this.store.sessionId)return void S.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Ma.WRTC_STATS,n)}upload(t,n){const i={_type:t,_message:n};try{this.websocket.sendMessage(i)}catch{const s=I("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==$e.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)}),I("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,n){const i={_type:t,_message:n};this.websocket.sendMessage(i)}async sendExtensionMessage(t,n,i){return await this._external_signal.send(t,n,i)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new de(((n,i)=>{this.once(Te.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(Te.WS_CLOSED,(()=>i(this.initError||new J(N.WS_ABORT)))),this.connectionState=$e.CONNECTING,this.websocket.init(t).catch(i)}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||Ze.LEAVE,this.connectionState=$e.CLOSED,S.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=mt(6,""),this._external_signal.clear(),this._external_signal=new Ja(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(Te.ABORT_P2P_EXECUTION);const t=await sn(this,Te.REQUEST_JOIN_INFO),n=await this.request(Ce.JOIN,t);if(!n)return this.emit(Te.REPORT_JOIN_GATEWAY,N.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(Te.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=$e.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}async downgradeCodec(t){return!1}handleDataStream(t){try{var n;const i=Ca(t.payload),r=new TextDecoder().decode(i),s=JSON.parse(r);"total"in s&&"id"in s||ie(n=Object.values(Jt)).call(n,s._type)?(s._uid=t.uid,this._external_signal.onMessage(s)):this.emit(Le.ON_DATA_STREAM,t)}catch{this.emit(Le.ON_DATA_STREAM,t)}}handleNotification(t){S.debug("[".concat(this.clientId,"] receive notification: "),t);const n=Ua(t.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?t.code===we.ERR_REPEAT_JOIN_CHANNEL&&I("IGNORE_UID_CHECK")?void this.close(Ze.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ze.UID_BANNED),void this.close()):void this.reconnect(n.action,kn.SERVER_ERROR);S.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=I("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(S.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>I("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",kn.TIMEOUT):this.request(Ce.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),I("REPORT_STATS")&&this.send(Ce.PING_BACK,{pingpongElapse:i})})).catch((i=>{}))}handleWebsocketEvents(){this.websocket.on(Ve.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(Te.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(Ve.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ve.CLOSED,(()=>{this.connectionState=$e.CLOSED})),this.websocket.on(Ve.FAILED,(()=>{this._disconnectedReason=Ze.NETWORK_ERROR,this.connectionState=$e.CLOSED})),this.websocket.on(Ve.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===$e.CONNECTED?this.connectionState=$e.RECONNECTING:this.connectionState=$e.CONNECTING})),this.websocket.on(Ve.WILL_RECONNECT,((t,n,i)=>{t!=="retry"?(S.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0):S.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(t)})),this.websocket.on(Ve.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.join().catch((t=>{if(this.emit(Te.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof J&&t.code===N.UNEXPECTED_RESPONSE&&t.data.code===we.ERR_NO_AUTHORIZED)return S.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",kn.SERVER_ERROR);S.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",kn.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(Ve.REQUEST_NEW_URLS,((t,n)=>{sn(this,Te.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)})),this.websocket.on(Ve.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Le.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}))}}const U9={name:"P2PChannel",create:function(e){let{store:t,statsCollector:n}=e;return new x9(t,n)},createSubmodule:function(e){let{store:t,spec:n}=e;return new M9(n,t)}};function Zx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function $x(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?Zx(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Zx(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}class V9{constructor(t){C(this,"sessionDesc",void 0),C(this,"localCapabilities",void 0),C(this,"rtpCapabilities",void 0),C(this,"candidates",void 0),C(this,"_originCandidates",void 0),C(this,"iceParameters",void 0),C(this,"dtlsParameters",void 0),C(this,"setup",void 0),C(this,"currentMidIndex",void 0),C(this,"cname",void 0),t=Dt(t);const{iceParameters:n,dtlsParameters:i,candidates:r,rtpCapabilities:s,setup:o,localCapabilities:a,sdkCodec:c,cname:u}=t,p=ri(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=s,this.candidates=r,this._originCandidates=Dt(r),this.iceParameters=n,this.dtlsParameters=i,this.setup=o,this.localCapabilities=a,this.cname=u;for(let m=0;m<p.mediaDescriptions.length;m++){const _=p.mediaDescriptions[m];if(_.attributes.iceUfrag=n.iceUfrag,_.attributes.icePwd=n.icePwd,_.attributes.fingerprints=i.fingerprints,_.attributes.candidates=r,_.attributes.setup=o,_.media.mediaType==="video"){_.media.fmts=s.videoCodecs.map((v=>v.payloadType.toString(10)));const g=s.videoCodecs.filter((v=>{var R,O;return(R=v.rtpMap)===null||R===void 0?void 0:ie(O=R.encodingName.toLowerCase()).call(O,c)})),b=s.videoCodecs.filter((v=>!ie(g).call(g,v)));_.attributes.payloads=[...g,...b],_.attributes.extmaps=s.videoExtensions}_.media.mediaType==="audio"&&(_.media.fmts=s.audioCodecs.map((g=>g.payloadType.toString(10))),_.attributes.payloads=s.audioCodecs,_.attributes.extmaps=s.audioExtensions),p.mediaDescriptions[m]=this.mungMediaDesc(_)}this.sessionDesc=p,this.currentMidIndex=p.mediaDescriptions.length-1}toString(){return Qs(this.sessionDesc)}send(t,n,i){const{ssrcs:r,ssrcGroups:s}=Yl(n,this.cname),o=this.sessionDesc.mediaDescriptions.find((u=>t===_e.VIDEO?u.media.mediaType==="video":u.media.mediaType==="audio")),a=r[0].attributes.label,c=r[0].attributes.mslabel;return o.attributes.ssrcs=o.attributes.ssrcs.concat(r),o.attributes.ssrcGroups=o.attributes.ssrcGroups.concat(s),{id:a,mslabel:c}}batchSend(t){return t.map((n=>{let{kind:i,ssrcMsg:r}=n;return this.send(i,r,void 0)}))}stopSending(t){this.sessionDesc.mediaDescriptions.forEach((n=>{const i=[],r=[],s=[];n.attributes.ssrcs.forEach((o=>{ie(t).call(t,o.attributes.label||"")?s.push(o):i.push(o)})),n.attributes.ssrcGroups.forEach((o=>{var a;ie(a=s.map((c=>c.ssrcId))).call(a,o.ssrcIds[0])||r.push(o)})),n.attributes.ssrcs=i,n.attributes.ssrcGroups=r}))}mute(t){const n=this.sessionDesc.mediaDescriptions.find((i=>i.attributes.mid===t));if(!n)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(t){const n=this.sessionDesc.mediaDescriptions.find((i=>i.attributes.mid===t));if(!n)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}receive(t,n,i){t.forEach(((r,s)=>{const o=r._mediaStreamTrack,a=this.sessionDesc.mediaDescriptions.findIndex((u=>u.attributes.mid===o.kind)),c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],r);this.sessionDesc.mediaDescriptions[a]=c}))}stopReceiving(t){}updateCandidates(t){const n=this._originCandidates.filter((r=>r.transport==="udp")),i=[];if(n.forEach((r=>{i.push($x($x({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))})),n.length!==0){switch(t){case bn.TCP_RELAY:this.candidates=i;break;case bn.UDP_TCP_RELAY:case bn.RELAY:this.candidates=[...n,...i];break;default:this.candidates=n}for(const r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(t){t=Dt(t),this.iceParameters=t,this.sessionDesc.mediaDescriptions.forEach((n=>{n.attributes.iceUfrag=t.iceUfrag,n.attributes.icePwd=t.icePwd}))}predictReceivingMids(t){const n=[];for(let i=0;i<t;i++)n.push((this.currentMidIndex+i+1).toString(10));return n}mungRecvMediaDsec(t,n){const i=Dt(t);return Va(i,n),ny(i,n),i}updateRecvMedia(t,n){const i=this.sessionDesc.mediaDescriptions.findIndex((r=>r.attributes.mid===t));if(i!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],n);this.sessionDesc.mediaDescriptions[i]=r}}bumpMid(t){this.currentMidIndex+=t}updateTrackLabel(t,n,i){const r=this.sessionDesc.mediaDescriptions.find((o=>t===_e.VIDEO?o.attributes.mid==="video":o.attributes.mid==="audio"));if(r){const o=r.attributes.ssrcs.find((a=>a.attributes.label===n));var s;o&&(o.attributes.label=i,(s=o.attributes.msid)===null||s===void 0||s.replace(n,i))}}mungMediaDesc(t){const n=Dt(t);return ty(n),(function(i){const r=i.attributes.extmaps.find((s=>nm(s.extensionName)));r&&i.attributes.extmaps.splice(i.attributes.extmaps.indexOf(r),1),i.attributes.payloads.forEach((s=>{const o=s.rtcpFeedbacks.findIndex((a=>a.type==="transport-cc"));o!==-1&&s.rtcpFeedbacks.splice(o,1)}))})(n),n}getSSRC(t){for(const n of this.sessionDesc.mediaDescriptions)for(const i of n.attributes.ssrcs)if(i.attributes.label===t)return[i]}}var At;function e1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function Fm(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?e1(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):e1(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let j9=(At=class Ou extends Qp{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var n;return ie(n=Object.keys(Aa)).call(n,t)})))]}constructor(t,n){super(t,n),C(this,"store",void 0),C(this,"peerConnection",void 0),C(this,"remoteSDP",void 0),C(this,"initialOffer",void 0),C(this,"statsFilter",void 0),C(this,"useRTX",!1),C(this,"localCapabilities",void 0),C(this,"localCandidateCount",0),C(this,"allCandidatesReceived",!1),C(this,"establishPromise",void 0),C(this,"mutex",void 0),this.store=n,this.mutex=new Cn("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(Ou.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=bp(this.peerConnection,I("STATS_UPDATE_INTERVAL"),void 0,Nt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=bs(t.sdp),i=Kl(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:I("FILTER_VIDEO_FEC"),filterAudioFec:I("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=t,Fm(Fm({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:t.sdp})}catch(t){throw new J(N.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async updateRemoteConnect(){}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new V9(Fm(Fm({},t),{},{rtpCapabilities:t.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async updateRemoteRTPCapabilities(t,n){throw new J(N.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(t){}send(t,n){var i=this;return li((function*(){const r=yield He(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=t.map((_=>i.peerConnection.addTrack(_._mediaStreamTrack))),o=yield He(i.peerConnection.createOffer()),a=ri(o.sdp),c=t.map((_=>{const g=_._mediaStreamTrack,b=a.mediaDescriptions.find((v=>v.attributes.mid===g.kind));if(!b)throw new Error("Cannot extract ssrc from mediaDescription.");return(function(v,R,O){const D=v.attributes.ssrcs.filter((B=>B.attributes.label===R)),x=v.attributes.ssrcGroups;if(D.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(x&&D.length>1){const B=x.find((G=>G.ssrcIds.indexOf(D[0].ssrcId)!==-1));return B?[{ssrcId:B.ssrcIds[0],rtx:O?B.ssrcIds[1]:void 0}]:[{ssrcId:D[0].ssrcId}]}return[{ssrcId:D[0].ssrcId}]})(b,g.id,i.useRTX)}));let u;try{u=yield c}catch(_){throw s.forEach((g=>{Rn()&&g.replaceTrack(null),i.peerConnection.removeTrack(g)})),_}const p=i.mungSendOfferSDP(o.sdp,t);i.remoteSDP.receive(t,n,u);const m=i.remoteSDP.toString();return yield He(i.peerConnection.setLocalDescription({type:"offer",sdp:p})),yield He(i.applySendEncodings(s,t)),yield He(i.peerConnection.setRemoteDescription({type:"answer",sdp:m})),t.map(((_,g)=>{const b=_._mediaStreamTrack.id;return{localSSRC:c[g],id:b}}))}catch(s){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{r()}}))()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const n=this.peerConnection.getSenders().filter((s=>{var o;return t.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1}));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map((s=>{Rn()&&s.replaceTrack(null),this.peerConnection.removeTrack(s)}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(t);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:s,mslabel:o}=this.remoteSDP.send(t,n,r),a=new de(((p,m)=>{const _=setTimeout((()=>{m(new Error("Cannot receive track, id: ".concat(s)))}),1e4),g=b=>{const v=st();if((v.name==="Safari"&&Number(v.version)===11||Yn())&&b.track.id!==s&&b.streams[0].id===o){var R;const O=b.streams[0].getTracks()[0];return(R=this.remoteSDP)===null||R===void 0||R.updateTrackLabel(t,s,b.track.id),this.peerConnection.removeEventListener("track",g),clearTimeout(_),void p(O)}if(b.track.id===s)return this.peerConnection.removeEventListener("track",g),clearTimeout(_),void p(b.track)};this.peerConnection.addEventListener("track",g)})),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(u),{track:await a,id:s}}catch(s){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(s.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter((i=>{var r;return t.indexOf(((r=i.track)===null||r===void 0?void 0:r.id)||"")!==-1}));if(n.length!==t.length)throw new Error("sender' length doesn't match mids' length.");n.map((i=>{if(Rn()&&i.track)i.track.enabled=!1;else{const r=i.getParameters();r.encodings.forEach((s=>s.active=!1)),i.setParameters(r)}}))}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter((s=>{var o;return t.indexOf(((o=s.track)===null||o===void 0?void 0:o.id)||"")!==-1}));if(n.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");n.map((async s=>{if(Rn()&&s.track)s.track.enabled=!0;else{const o=s.getParameters();o.encodings.forEach((a=>a.active=!0)),await s.setParameters(o)}}));const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return li((function*(){const i=yield He(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=Xe().supportPCSetConfiguration;if(t===bn.RELAY&&!r)return;if(r){const u=n.peerConnection.getConfiguration(),p=t===bn.RELAY?"relay":"all";u.iceTransportPolicy!==p&&(S.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(u.iceTransportPolicy,"] to [").concat(p,"]")),u.iceTransportPolicy=p,n.peerConnection.setConfiguration(u))}t!==bn.RELAY&&n.remoteSDP.updateCandidates(t);const s=yield He(n.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=bs(s.sdp),{remoteIceParameters:a}=yield o.iceParameters;n.remoteSDP.restartICE(a);const c=n.remoteSDP.toString();yield He(n.peerConnection.setLocalDescription(s)),yield He(n.peerConnection.setRemoteDescription({type:"answer",sdp:c}))}catch(r){S.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}}))()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);const s=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new J(N.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getSenders().filter((r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===t}));i.length===1&&await this.applySendEncodings(i,[n])}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getSenders().find((r=>{var s;return((s=r.track)===null||s===void 0?void 0:s.id)===n}));i&&await i.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,n){throw new J(N.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new J(N.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),I("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(ya(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...Ou.turnServerConfigToIceServers(t.turnServer.servers)),I("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...Ou.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((i=>{i.forceturn&&(n.iceTransportPolicy="relay")})))),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}async updateRtpSenderEncodings(t,n){var i;if(n||(n=this.peerConnection.getSenders().find((u=>{var p;return((p=u.track)===null||p===void 0?void 0:p.id)===t._mediaStreamTrack.id}))),!n)return S.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!Xe().supportSetRtpSenderParameters)return S.warn("Browser not support set rtp-sender parameters");const r={},s={};if(t instanceof bt)switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(I("DSCP_TYPE")&&Ss()){var o;const u=I("DSCP_TYPE");ie(o=["very-low","low","medium","high"]).call(o,u)&&(s.networkPriority=u)}const a=n.getParameters(),c=(i=a.encodings)===null||i===void 0?void 0:i[0];c&&Object.assign(c,s),Object.assign(a,r),S.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),await n.setParameters(a)}async applySendEncodings(t,n){try{if(!Xe().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=n[i];r&&s&&await this.updateRtpSenderEncodings(s,r)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n){const i=ri(t);return n.forEach(((r,s)=>{const o=r._mediaStreamTrack,a=i.mediaDescriptions.find((c=>c.attributes.mid===o.kind));a&&Va(a,r)})),Qs(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const n=this.remoteSDP.batchSend(t).map(((s,o)=>{let{id:a,mslabel:c}=s;const{kind:u}=t[o];return new de(((p,m)=>{const _=setTimeout((()=>{m(new Error("Cannot receive track, id: ".concat(a)))}),1e4),g=b=>{const v=st();if(v.name==="Safari"&&Number(v.version)===11&&b.track.id!==a&&b.streams[0].id===c){var R;const O=b.streams[0].getTracks()[0];return(R=this.remoteSDP)===null||R===void 0||R.updateTrackLabel(u,a,b.track.id),this.peerConnection.removeEventListener("track",g),clearTimeout(_),void p({track:O,id:a})}if(b.track.id===a)return this.peerConnection.removeEventListener("track",g),clearTimeout(_),void p({track:b.track,id:a})};this.peerConnection.addEventListener("track",g)}))})),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await de.all(n)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n?.[0].ssrcId}setConfiguration(t){if(Xe().supportPCSetConfiguration){const n=Ou.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}}},le(At.prototype,"connect",[dr],Object.getOwnPropertyDescriptor(At.prototype,"connect"),At.prototype),le(At.prototype,"stopSending",[dr],Object.getOwnPropertyDescriptor(At.prototype,"stopSending"),At.prototype),le(At.prototype,"receive",[dr],Object.getOwnPropertyDescriptor(At.prototype,"receive"),At.prototype),le(At.prototype,"stopReceiving",[dr],Object.getOwnPropertyDescriptor(At.prototype,"stopReceiving"),At.prototype),le(At.prototype,"muteRemote",[dr],Object.getOwnPropertyDescriptor(At.prototype,"muteRemote"),At.prototype),le(At.prototype,"unmuteRemote",[dr],Object.getOwnPropertyDescriptor(At.prototype,"unmuteRemote"),At.prototype),le(At.prototype,"muteLocal",[dr],Object.getOwnPropertyDescriptor(At.prototype,"muteLocal"),At.prototype),le(At.prototype,"unmuteLocal",[dr],Object.getOwnPropertyDescriptor(At.prototype,"unmuteLocal"),At.prototype),le(At.prototype,"close",[dr],Object.getOwnPropertyDescriptor(At.prototype,"close"),At.prototype),le(At.prototype,"updateEncoderConfig",[dr],Object.getOwnPropertyDescriptor(At.prototype,"updateEncoderConfig"),At.prototype),le(At.prototype,"updateSendParameters",[dr],Object.getOwnPropertyDescriptor(At.prototype,"updateSendParameters"),At.prototype),le(At.prototype,"replaceTrack",[dr],Object.getOwnPropertyDescriptor(At.prototype,"replaceTrack"),At.prototype),le(At.prototype,"getRemoteSSRC",[dr],Object.getOwnPropertyDescriptor(At.prototype,"getRemoteSSRC"),At.prototype),At);function dr(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("Locking from P2PConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}const F9={name:"PlanBConnection",create:function(e){let{store:t,spec:n}=e;return new j9(n,t)}},B9={interceptLocalAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Xe().supportWebRTCEncodedTransform)return void S.warning("browser not support audio encoded transform");if(Vp.has(e)||!e.track)return;const n={track:e.track};if(Xs()){if(!e.createEncodedStreams)return void S.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(o){return void S.error("create audio-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){n.controller||(n.controller=a),e.track&&e.track.id!==n.track.id&&(S.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const c=t.metadata&&t.metadata();c?(function(u,p){const{chunk:m,controller:_}=p,g=Io.METADATA;m.data=(function(b,v,R){const O=R.byteLength,D=O+LS+zD,x=DS+PS+D,B=new ArrayBuffer(b.byteLength+x),G=new DataView(B);G.setUint8(0,YD),G.setUint16(1,D),G.setUint8(3,v),G.setUint16(4,O);for(let H=0;H<O;H++)G.setUint8(6+H,R[H]);const j=new Uint8Array(G.buffer);return j.set(new Uint8Array(b),x),j.buffer})(m.data,g,u),_.enqueue(m)})(c,{chunk:o,controller:a}):a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else if(Rn()){if(typeof RTCRtpScriptTransform>"u")return void S.warning("browser not support RTCRtpScriptTransform");const r=Up(),s=new MessageChannel;await new de((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"audio-metadata-tx",port:s.port2},[s.port2]);e.transform=o,await new de((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),s.port1.onmessage=a=>{var c;if(a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id)S.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i);else if(a.data.getMetadata){const u=t.metadata&&t.metadata();u&&s.port1.postMessage({metadata:u})}},n.worker=r}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}const r=Vp.get(e);if(r){Vp.delete(e);try{var s,o;(s=r.controller)===null||s===void 0||s.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(a){S.warning(a&&a.message)}}}Vp.set(e,n),e.track.addEventListener("ended",i)},interceptRemoteAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Xe().supportWebRTCEncodedTransform)return void S.warning("browser not support audio encoded transform");if(Hp.has(e))return;const n={track:e.track,onMetadata:t.onMetadata,onPts:t.onPts};if(Xs()&&!Yn()){if(!e.createEncodedStreams)return void S.warning("browser not support createEncodedStreams() API");WE(at.CHROME,87,116)||(t.enableTopn=!1);let r=null;try{r=e.createEncodedStreams()}catch(o){return void S.error("create audio-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){n.controller||(n.controller=a),e.track&&e.track.id!==n.track.id&&(S.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i)),t.enableTopn?(function(c,u,p){var m;const _=kS(new DataView(u.data));if(!_)return p.enqueue(u);const g=c.track.id;Ez.set(g,c.track);const b=(m=_.tlv.find((B=>B.tag===Io.AUDIO_LEVEL)))===null||m===void 0?void 0:m.value;let v=0;typeof b=="number"&&(v=127-b);const R=Math.round(Math.pow(10,v/60)-1),{selected:O,speaker:D}=(function(B,G){let j=ud.get(B);if(j||(j=(function(H){const Z=new XD;return ud.set(H,Z),qr||(qr=new _z(I("TOPN_SILENCE_THRESHOLD")||500),qr.on("ActiveSpeakerChanged",(ne=>{ne!=null&&(Bp=ne)}))),qr.addSpeakers([Z]),Z})(B)),ud.size<=JD)return{selected:!0,speaker:j};if(!qr)throw new Error("no active speaker detector");return qr.levelChanged(j.id,G),La=qr.loudest.map((H=>H.id)),Bp&&!ie(La).call(La,Bp)&&La.length>=JD&&La.pop(),{selected:ie(La).call(La,j.id)||j.id===Bp,speaker:j}})(c,R),x=(function(B,G,j){const H=Xr.get(B)||new gz(B,G);return H.score=j,Xr.set(B,H),(function(Z){if(Wp.set(Z,!0),!Gp)return void(Gp=Date.now());const ne=Date.now();ne-Gp>1e3&&(Wp.get(Z)?Wp.set(Z,!1):(QD(Z),Wp.delete(Z)),Gp=ne)})(B),H})(g,c.track,D.energyScore);x.addSample(O),x.active&&(u.data=_.frame.buffer,p.enqueue(u))})(e,o,a):t.enableMetadata||t.enablePts?(function(c,u,p,m){const _=new DataView(c.data),g=_.getUint8(0);let b;if((128&g)!=0&&g!==71){const O=(function(D){if(D.byteLength<=0)return[];const x=[];let B=0;for(;B<D.byteLength;){const j=(128&D.getUint8(B))>>7,H=127&D.getUint8(B);if(!(j&&B+4<=D.byteLength)){B++;break}{const Z=D.getUint32(B,!1),ne=(16776192&Z)>>10,he=1023&Z;x.push({pt:H,ts_offset:ne,length:he,data:new Uint8Array}),B+=4}}let G=D.byteLength-B;for(const j of x){if(j.length>G)return console.warn("Broken red payload"),[];j.length>0&&(j.data=new Uint8Array(D.buffer,D.byteOffset+B,j.length),B+=j.length,G-=j.length)}if(G>0){const j={pt:x.length>0?x[x.length-1].pt:0,ts_offset:0,length:G,data:new Uint8Array(D.buffer,D.byteOffset+B,G)};x.push(j)}return x})(_);if(O.length>0){const D=(function(x){let B=0;for(let H=0;H<x.length;H++)B+=H<x.length-1?4:1,B+=x[H].length;const G=new Uint8Array(B);let j=0;for(let H=0;H<x.length;H++)if(H<x.length-1){const Z=(2147483648|(127&x[H].pt)<<24|(262143&x[H].ts_offset)<<10|1023&x[H].length)>>>0;G[j++]=Z>>24&255,G[j++]=Z>>16&255,G[j++]=Z>>8&255,G[j++]=255&Z}else G[j++]=127&x[H].pt;for(const H of x)G.set(H.data,j),j+=H.length;return G})(O.map((x=>{const B=new Uint8Array(x.length);B.set(x.data);const G=kS(new DataView(B.buffer));return G!=null&&G.frame&&(x.data=G?.frame),b=G,x})));c.data=D.buffer}}else b=kS(_),b&&(c.data=b.frame.buffer);if(u.enqueue(c),!b)return;const v=b.tlv.find((O=>O.tag===Io.METADATA));v&&p&&v.value instanceof Uint8Array&&p(v.value);const R=b.tlv.find((O=>O.tag===Io.AUDIO_64_BIT_PTS));R&&m&&R.value instanceof Uint8Array&&R.value.length==8&&m(new DataView(R.value.buffer).getBigUint64(0,!0))})(o,a,t.onMetadata,t.onPts):a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else{if(typeof RTCRtpScriptTransform>"u")return void S.warning("browser not support RTCRtpScriptTransform");const r=Up(),s=new MessageChannel;await new de((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"audio-metadata-rx",port:s.port2},[s.port2]);e.transform=o,await new de((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),s.port1.onmessage=a=>{var c;a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id?(S.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i)):a.data.metadata&&n.onMetadata?n.onMetadata(a.data.metadata):a.data.pts&&n.onPts&&n.onPts(a.data.pts)},n.worker=r}function i(){e.track.removeEventListener("ended",i),(function(r){const s=Hp.get(r);if(s){(function(c){const u=ud.get(c);u&&(ud.delete(c),qr&&(qr.removeSpeakers([u]),ud.size===0&&(qr.destroy(),qr=null)))})(r),QD(r.track.id),Hp.delete(r);try{var o,a;(o=s.controller)===null||o===void 0||o.terminate(),(a=s.worker)===null||a===void 0||a.terminate()}catch(c){S.warning(c&&c.message)}}})(e)}Hp.set(e,n),e.track.addEventListener("ended",i)},interceptLocalVideoFrame:async function(e,t){if(!Xe().supportWebRTCEncodedTransform)return void S.warning("browser not support video encoded transform");if(Kp.has(e)||!e.track)return;const n={track:e.track};if(Xs()){if(!e.createEncodedStreams)return void S.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(a){return void S.error("create video-encoded-streams error",a&&a.message)}const s=[];t.on("sei-to-send",(a=>{s.push(a)}));const o=new TransformStream({transform(a,c){n.controller||(n.controller=c),e.track&&e.track.id!==n.track.id&&(S.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const u=eP(new Uint8Array(a.data)),p=s.shift();if(p){const m=(function(_,g,b){switch(b){case VS:return(function(v,R){const O=$D(R),D=O.length,x=Math.floor(D/255),B=D%255,G=new Uint8Array(6+x+1+D+v.byteLength);G[0]=0,G[1]=0,G[2]=0,G[3]=1,G[4]=6,G[5]=101;let j=0;for(;j<x;)G[6+j]=255,j++;return G[6+j]=B,j++,G.set(O,6+j),G.set(new Uint8Array(v),6+j+D),G.buffer})(_,g);case jS:return(function(v,R){const O=$D(R),D=O.length,x=Math.floor(D/255),B=D%255,G=new Uint8Array(7+x+1+D+1+v.byteLength);G[0]=0,G[1]=0,G[2]=0,G[3]=1,G[4]=78,G[5]=1,G[6]=101;let j=0;for(;j<x;)G[7+j]=255,j++;return G[7+j]=B,j++,G.set(O,7+j),j+=D,G[7+j]=128,j++,G.set(new Uint8Array(v),7+j),G.buffer})(_,g);default:return null}})(a.data,p,u);m&&(a.data=m)}c.enqueue(a)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else{if(!Rn())return;{if(typeof RTCRtpScriptTransform>"u")return void S.warning("browser not support RTCRtpScriptTransform");const r=Up(),s=new MessageChannel;await new de((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"sei-tx",port:s.port2},[s.port2]);e.transform=o,await new de((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),t.on("sei-to-send",(a=>{s.port1.postMessage({sei:a})})),s.port1.onmessage=a=>{var c;a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id&&(S.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i))},n.worker=r}}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}const r=Kp.get(e);if(r){Kp.delete(e);try{var s,o;(s=r.controller)===null||s===void 0||s.terminate(),(o=r.worker)===null||o===void 0||o.terminate()}catch(a){S.warning(a&&a.message)}}}Kp.set(e,n),e.track.addEventListener("ended",i)},interceptRemoteVideoFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Xe().supportWebRTCEncodedTransform)return void S.warning("browser not support video encoded transform");if(!e.track)return;if(Bl.has(e)){const r=Bl.get(e);return void(r&&(r.onSei=t.onSei))}const n={track:e.track,onSei:t.onSei};if(Xs()){if(!e.createEncodedStreams)return void S.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(o){return void S.error("create video-encoded-streams error",o&&o.message)}const s=new TransformStream({transform(o,a){if(n.controller||(n.controller=a),!n.firstFrameInfo){var c;const p=o.getMetadata()||{};n.firstFrameInfo=Ot({type:o.type,rtpTimestamp:o.timestamp,payloadType:p.payloadType||0,ssrc:p.synchronizationSource||0,length:o.data.byteLength},"mimeType"in p?{mimeType:p.mimeType}:{}),(c=t.onFirstFrame)===null||c===void 0||c.call(t,n.firstFrameInfo)}e.track&&e.track.id!==n.track.id&&(S.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const u=(function(p,m){switch(m){case VS:return(function(_){const g=new DataView(_.data);let b=0;for(;b+4<_.data.byteLength;){if(g.getUint8(b+0)===0&&g.getUint8(b+1)===0&&g.getUint8(b+2)===0&&g.getUint8(b+3)===1&&g.getUint8(b+4)===6){let v=b+6,R=0,O=0;for(;(O=g.getUint8(v++))===255;)R+=255;R+=O;const D=ZD(_.data,v,R);return new Uint8Array(D)}b++}return null})(p);case jS:return(function(_){const g=new DataView(_.data);let b=0;for(;b+5<_.data.byteLength;){if(g.getUint8(b+0)===0&&g.getUint8(b+1)===0&&g.getUint8(b+2)===0&&g.getUint8(b+3)===1&&g.getUint8(b+4)===78&&g.getUint8(b+5)===1&&g.getUint8(b+6)===101){let v=b+7,R=0,O=0;for(;(O=g.getUint8(v++))===255;)R+=255;R+=O;const D=ZD(_.data,v,R);return new Uint8Array(D)}b++}return null})(p);default:return null}})(o,eP(new Uint8Array(o.data)));u&&n.onSei&&n.onSei(u),a.enqueue(o)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else if(Rn()){if(typeof RTCRtpScriptTransform>"u")return void S.warning("browser not support RTCRtpScriptTransform");const r=Up(),s=new MessageChannel;await new de((a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)}));const o=new RTCRtpScriptTransform(r,{name:"sei-rx",port:s.port2},[s.port2]);e.transform=o,await new de((a=>r.onmessage=c=>{c.data==="started"&&a(void 0)})),s.port1.onmessage=a=>{var c;if(a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id)S.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i);else if(a.data.sei&&n.onSei)n.onSei(a.data.sei);else if(a.data.firstFrameInfo&&t.onFirstFrame){var u;(u=t.onFirstFrame)===null||u===void 0||u.call(t,a.data.firstFrameInfo)}},n.worker=r}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}(function(r){const s=Bl.get(r);if(s){Bl.delete(r);try{var o,a;(o=s.controller)===null||o===void 0||o.terminate(),(a=s.worker)===null||a===void 0||a.terminate()}catch(c){S.warning(c&&c.message)}}})(e)}Bl.set(e,n),e.track.addEventListener("ended",i)}},W9={name:"InterceptFrame",create:()=>B9};var it;function t1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}function rs(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?t1(Object(n),!0).forEach((function(i){C(e,i,n[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):t1(Object(n)).forEach((function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))}))}return e}let G9=(it=class Ud extends Qp{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map((t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"")).filter((t=>{var n;return ie(n=Object.keys(Aa)).call(n,t)})))]}constructor(t,n,i){super(t,n),C(this,"id",mt(5,"connection-")),C(this,"store",void 0),C(this,"peerConnection",void 0),C(this,"forceTurn",!1),C(this,"remoteSDP",void 0),C(this,"initialOffer",void 0),C(this,"transportEventReceiver",void 0),C(this,"statsFilter",void 0),C(this,"extension",{useXR:I("USE_XR")}),C(this,"localCapabilities",void 0),C(this,"remoteCodecs",void 0),C(this,"localCandidateCount",0),C(this,"allCandidatesReceived",!1),C(this,"isPreallocation",!1),C(this,"preMediaMap",new Map),C(this,"dataStreamChannelMap",new Map),C(this,"establishPromise",void 0),C(this,"recoveredDataChannelIds",[]),C(this,"currentDataChannelId",1),C(this,"supportAV1RtpSpec",!1),C(this,"mutex",void 0),C(this,"qualityLimitationReason",$c.NONE),C(this,"isFirstConnected",!1),this.store=n,this.forceTurn=vy(t),this.mutex=new Cn("NVConnectionExtension-mutex",n.clientId),this.peerConnection=i,this.isFirstConnected=!1,this.statsFilter=bp(this.peerConnection,I("STATS_UPDATE_INTERVAL"),void 0,Nt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void S.debug("[NVConnectionExtension] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}else S.debug("[NVConnectionExtension] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=bs(n.sdp),r=await ry({filterRTX:!I("USE_PUB_RTX")&&!I("USE_SUB_RTX"),filterVideoFec:I("FILTER_VIDEO_FEC"),filterAudioFec:I("FILTER_AUDIO_FEC"),filterVideoCodec:I("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:I("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:I("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=zl(r),this.initialOffer=n,I("ENABLE_SVC")&&this.store.codec=="av1"){const o=await IP();var t;o&&(this.supportAV1RtpSpec=!0,(t=r.send)===null||t===void 0||t.videoExtensions.push(o))}let s;return n.sdp&&rm(n.sdp)&&(s=Dt(r),yP(s)),rs(rs({},i),{},{rtpCapabilities:s||r,offerSDP:n.sdp})}catch(n){throw new J(N.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnectionExtension without initial offer.");this.initialOffer.sdp&&rm(this.initialOffer.sdp)&&TP(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new $P(rs(rs({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!I("ENABLE_PRE_SUB_WITH_PRE_PC")||!I("PRE_USE_LOCAL_CODECS"))&&Vl(this.store),!0),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),i=sy(this.initialOffer.sdp,this.extension),r=this.logSDPExchange(i||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),r?.(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const s=this.peerConnection.getTransceivers()[0];if(s!=null&&s.receiver&&this.tryBindTransportEvents(s.receiver),Vl(this.store))if(t.preallocation&&I("ENABLE_PRE_SUB_WITH_PRE_PC")){const o=I("PRE_SUB_NUM"),{mids:a,preSSRCs:c}=this.remoteSDP.preloadRemoteMedia(o);await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] preload media, in pre pc,add preload ssrcs ").concat(c)),this.presetMedia(a,c)}else{const{preSSRCs:o=[]}=t,a=o.map((u=>u.ssrcMsg[0].ssrcId));if(o.length===0)return;const{mids:c}=this.remoteSDP.batchSend(o.map((u=>Object.assign({},u))));await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[NVConnectionExtension.connect] preload media, after join, add preload ssrcs ".concat(a)),this.presetMedia(c,a)}}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.connect failed; ".concat(n.toString()))}}presetMedia(t,n){t.forEach(((i,r)=>{this.peerConnection.getTransceivers().forEach((s=>{if(s.mid!=null&&i===s.mid&&s.receiver.track){const o=s.receiver.track;let a;o.kind==="video"&&I("ENABLE_PRE_RENDER")&&(a=new xp({trackId:"track-".concat(o.kind,"-unknown-").concat(this.store.clientId,"_").concat(mt(5,""))},!0),a.updateVideoTrack(o),a.onFirstVideoFrameRender=()=>{var c;const u=this.preMediaMap.get(n[r]);u&&(u.firstVideoRender=Date.now()),(c=this.onFirstVideoRender)===null||c===void 0||c.call(this,n[r])},a.onVideoBufferReady=()=>{var c;(c=this.onFirstVideoBufferReady)===null||c===void 0||c.call(this,n[r])},a.play(this.store.sessionId||void 0)),this.preMediaMap.set(n[r],{mid:i,track:o,player:a,transceiver:s})}})),this.store.peerReceiver()}))}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateRemoteConnect before remote SDP created");let n=!1;const{rtpCapabilities:i}=t;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const o=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||o}const{preSSRCs:r=[]}=t,s=r.map((o=>o.ssrcMsg[0].ssrcId));if(!this.remoteSDP.checkPreloadSsrcs(s)){const o=[],a=[];if(Array.from(this.preMediaMap.entries()).every((c=>{let[u,{mid:p,player:m,track:_}]=c;return o.push(p),a.push(u),this.preMediaMap.delete(u),m&&m.destroy(),!0})),o.length>0&&(this.remoteSDP.stopSending(o),await Ti(this.peerConnection,this.remoteSDP,this.extension),S.warn("[NVConnectionExtension.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(a)),Se.reportApiInvoke(this.store.sessionId,{name:xt.PRELOAD_MEDIA_FAILED,options:[r,a],tag:Ct.TRACER}).onSuccess()),r.length>0){const{mids:c}=this.remoteSDP.batchSend(r.map((u=>Object.assign({},u))));await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[NVConnectionExtension.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(s)),this.presetMedia(c,s)}}n?(await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[NVConnectionExtension] updateRemoteConnect by exchanging SDP.")):S.debug("[NVConnectionExtension] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.updateRemoteConnect failed; ".concat(n.toString()))}}send(t,n,i){var r=this;return li((function*(){const s=yield He(r.mutex.lock("From NVConnectionExtension.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVConnectionExtension.send before remote SDP created");const o=[],a=Hl();t.forEach((R=>{const O=r.peerConnection.addTransceiver(R._mediaStreamTrack,rs({direction:"sendonly"},R.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));o.push(O),R._updateRtpTransceiver(O)})),Nt()&&I("SIMULCAST")===!0&&(yield He(r.applySimulcastForFirefox(o,t)));const c=yield He(r.peerConnection.createOffer()),u=r.remoteSDP.predictReceivingMids(t.length),p=r.mungSendOfferSDP(c.sdp,t,u),m=ri(p),_=u.map((R=>{const O=m.mediaDescriptions.find((D=>D.attributes.mid===R));if(!O)throw new Error("Cannot extract ssrc from mediaDescription.");return ey(O,I("USE_PUB_RTX"))}));let g;try{g=yield _}catch(R){g=[],r.remoteSDP.receive(t,n,i,g);const O=r.remoteSDP.toString();throw yield He(r.peerConnection.setLocalDescription({type:"offer",sdp:p})),yield He(r.peerConnection.setRemoteDescription({type:"answer",sdp:O})),yield He(r.stopSending(u,!0)),R}r.remoteSDP.receive(t,n,i,g);const b=r.remoteSDP.toString(),v=r.logSDPExchange(p,"offer","local","send");return yield He(r.peerConnection.setLocalDescription({type:"offer",sdp:p})),yield He(r.applySimulcastEncodings(o,t)),yield He(r.applySendEncodings(o,t)),v?.(b),yield He(r.peerConnection.setRemoteDescription({type:"answer",sdp:b})),o.map(((R,O)=>{const D=u[O];return{localSSRC:_[O],id:D,transceiver:R}}))}catch(o){throw o instanceof J?o:new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.send failed; ".concat(o.toString()))}finally{s()}}))()}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);if(i&&i.readyState==="open")S.debug("[NVConnectionExtension] Channels are already available and can be reused directly.");else{const s=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof s!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:s,negotiated:!0,ordered:!1,maxRetransmits:I("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)}n.forEach((s=>{s._updateOriginDataChannel(i)}));const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const s=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const o=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(o),S.debug("[NVConnectionExtension] createDataChannels by exchanging SDP.")}else S.debug("[NVConnectionExtension] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof J?i:new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(t){try{const n=this.dataStreamChannelMap.get(t);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(t)}catch(n){throw n instanceof J?n:new J(N.DATACHANNEL_FAILED,"NVConnectionExtension.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(t,n){const i=n?void 0:await this.mutex.lock("From NVConnectionExtension.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter((c=>t.indexOf(c.mid)!==-1));if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVConnectionExtension.stopSending.");r.map((c=>{var u;vd(this.id+c.mid,this),c.direction="inactive",(u=c.stop)===null||u===void 0||u.call(c)}));const s=await this.peerConnection.createOffer(),o=this.logSDPExchange(s.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(s),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();o?.(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.receive ".concat(t," before remoteSDP created."));const{mid:s,needExchangeSDP:o}=this.remoteSDP.send(t,n,i,r);o&&(await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] receive ").concat(t," by exchanging SDP.")));const a=this.peerConnection.getTransceivers().find((c=>c.mid===s));if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:s,transceiver:a}}catch(s){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(s.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(t);return i&&(await Ti(this.peerConnection,this.remoteSDP,this.extension),S.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] batchReceive by exchanging SDP."))),n.map((r=>{const s=this.peerConnection.getTransceivers().find((o=>o.mid===r));if(!s)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:s.receiver.track,id:r,transceiver:s}}))}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(n.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopReceiving before remote SDP created.");t.forEach((s=>{Array.from(this.preMediaMap.entries()).some((o=>{let[a,{mid:c,player:u}]=o;if(c===s)return this.preMediaMap.delete(a),u&&u.destroy(),!0}))})),this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i?.(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((o=>{o.direction="inactive"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter((o=>o.mid&&t.indexOf(o.mid)!==-1));if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map((async(o,a)=>{o.direction="sendonly"}));const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const s=this.remoteSDP.toString();r?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(n){throw new J(N.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return li((function*(){const i=yield He(n.mutex.lock("From NVConnectionExtension.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const r=Xe().supportPCSetConfiguration,s=I("FORCE_TURN_TCP")||n.forceTurn;if(t===bn.RELAY&&!r)return;if(r&&!s){const m=t===bn.RELAY?"relay":"all",_=n.peerConnection.getConfiguration();_.iceTransportPolicy!==m&&(S.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(_.iceTransportPolicy,"] to [").concat(m,"]")),_.iceTransportPolicy=m,n.peerConnection.setConfiguration(_))}n.remoteSDP.updateCandidates(t);const o=yield He(n.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const a=bs(o.sdp),{remoteIceParameters:c}=yield a.iceParameters;n.remoteSDP.restartICE(c);const u=n.remoteSDP.toString(),p=n.logSDPExchange(o.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield He(n.peerConnection.setLocalDescription(o)),p?.(u),yield He(n.peerConnection.setRemoteDescription({type:"answer",sdp:u}))}catch(r){S.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}}))()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From NVConnectionExtension.extendCandidate");try{this.remoteSDP.updateCandidates(bn.TCP_RELAY),await Ti(this.peerConnection,this.remoteSDP,this.extension)}catch(n){S.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach((n=>{vd(this.id+n.mid,this)})),this.preMediaMap.forEach((n=>{let{player:i}=n;i&&i.destroy()})),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return rs(rs({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const s=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),o?.(s),await this.peerConnection.setRemoteDescription({type:"answer",sdp:s})}catch(i){throw new J(N.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getTransceivers().filter((r=>r.mid===t));i.length===1&&(this.isVP8Simulcast(n)?Nt()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getTransceivers().find((r=>r.mid===n));i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:rs(rs({},Rr),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:rs(rs({},Rr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var n;const i="code: ".concat(t.errorCode,", message: ").concat(t.errorText),r=t.port?"local: ".concat(t.port):"",s=Cs(t.url||"");S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: NVConnectionExtension.onICECandidateError(").concat(i,"), url: ").concat(s||"",", host_candidate:").concat(r)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,i)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout((()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))}),I("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]},i=t.cloudProxyServer||"disabled";return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&(ya(t.turnServer.servers)?n.iceServers=t.turnServer.servers:I("NEW_TURN_MODE")&&n.iceServers&&i==="disabled"?(I("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&n.iceServers.push(...Ud.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):n.iceServers.push(...Ud.newTurnServerConfigToIceServers(t.turnServer.servers)),I("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...Ud.turnServerConfigToIceServers(t.turnServer.servers)),I("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...Ud.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),I("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((r=>{r.forceturn&&(n.iceTransportPolicy="relay")})))),I("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Ir(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!I("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}static newTurnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{const r=I("NEW_TURN_MODE");r===1?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}):r===2?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}):r===3?n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Ir(i.turnServerURL),":443?transport=tcp")}):r===4&&(n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=udp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":3478?transport=tcp")}),n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Ir(i.turnServerURL),":443?transport=tcp")}))})),n}tryBindTransportEvents(t){const n=t.transport;if(n){this.transportEventReceiver=t,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var s;(s=this.onDTLSTransportError)===null||s===void 0||s.call(this,"error"in r?r.error:r)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const r=n?.iceTransport.state;var s;r&&((s=this.onICETransportStateChange)===null||s===void 0||s.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:s}=i.getSelectedCandidatePair()||{};if(r&&s){const o=r.address+":"+r.port,a=s.address+":"+s.port;S.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(Cs(o)),", remote ").concat(JSON.stringify(Cs(a))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i,r;if(n||(n=this.peerConnection.getSenders().find((R=>R.track===t._mediaStreamTrack))),!n)return S.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return S.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Xe().supportSetRtpSenderParameters)return S.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const s={},o={};switch(t._optimizationMode){case"motion":s.degradationPreference="maintain-framerate";break;case"detail":s.degradationPreference="maintain-resolution";break;case"balanced":s.degradationPreference="balanced"}const a=EP(this.peerConnection,t._mediaStreamTrack),c=aN(t);if(sL(t)&&a&&n&&c&&this.getLocalVideoStats&&ie(i=["vp8","vp9"]).call(i,this.store.codec)){var u;const v=s.degradationPreference||(ie(u=t._hints).call(u,ht.CUSTOM_TRACK)?I("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");oL(this.id+a.mid,c,this,v,(R=>{n&&this.updateAdaptation(n,R)}),this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var p;const{bitrateMax:v,frameRate:R,scaleResolutionDownBy:O}=t._encoderConfig;v&&(o.maxBitrate=1e3*v),(ie(p=t._hints).call(p,ht.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(R&&(o.maxFramerate=fi(R)),O&&O>=1&&(o.scaleResolutionDownBy=O))}const{maxFramerate:m}=I("ENCODER_CONFIG_LIMIT");if(m&&typeof m=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,m):m),I("DSCP_TYPE")&&Ss()){var _;const v=I("DSCP_TYPE");ie(_=["very-low","low","medium","high"]).call(_,v)&&(o.networkPriority=v)}const g=n.getParameters(),b=(r=g.encodings)===null||r===void 0?void 0:r[0];Nt()&&!b&&(s.encodings=[o]),b&&Object.assign(b,o),Object.assign(g,s),S.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(g.encodings))),await n.setParameters(g),await DP(this.store.codec,n,I("SVC_MODE"))}async updateAdaptation(t,n){var i,r;if(!t)return S.debug("[updateAdaptation] no rtpSender found");if(!Xe().supportSetRtpSenderParameters)return S.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const s={},{bitrateMax:o,frameRate:a,scaleResolutionDownBy:c}=n;o&&(s.maxBitrate=1e3*o),a&&(s.maxFramerate=fi(a)),c&&c>=1&&ie(i=["vp8","vp9"]).call(i,this.store.codec)&&(s.scaleResolutionDownBy=c);const u=t.getParameters(),p=(r=u.encodings)===null||r===void 0?void 0:r[0];p&&Object.assign(p,s),Object.assign(u,{});try{await t.setParameters(u),S.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(u.encodings)))}catch(m){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?S.debug("[updateAdaptation] peerConnection not connected}"):S.debug("[updateAdaptation] updateRtpSenderEncodings failed",m):S.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,n){try{if(!Xe().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],s=n[i];s instanceof bt&&!this.isVP8Simulcast(s)&&await this.updateRtpSenderEncodings(s,r.sender)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,i){const r=ri(t);return n.forEach(((s,o)=>{const a=i[o],c=r.mediaDescriptions.find((u=>u.attributes.mid===a));c&&(Va(c,s),iy(c,s,this.store.codec))})),Qs(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let c=0;c<t.length;c++){var i,r,s,o,a;const u=t[c],p=n[c];if(p instanceof bt&&!ie(i=p._hints).call(i,ht.LOW_STREAM)&&(r=p._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((s=p._encoderConfig)===null||s===void 0?void 0:s.bitrateMax)>200&&(o=p._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=p._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){const m={},_={high:1e3*(p._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{rid:"m",active:!0,maxBitrate:_.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:_.high}];const g=u.sender.getParameters();await u.sender.setParameters(Object.assign(g,m))}}}async applySimulcastEncodings(t,n){if(!Nt()&&t.length===n.length)for(let i=0;i<t.length;i++){const r=n[i];if(r instanceof bt&&this.isVP8Simulcast(r)){const s=t[i],o={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};o.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=s.sender.getParameters();await s.sender.setParameters(Object.assign(c,o))}}}isVP8Simulcast(t){var n,i,r,s,o;return!!(t instanceof bt&&I("SIMULCAST")&&this.store.codec==="vp8"&&!ie(n=t._hints).call(n,ht.LOW_STREAM)&&(i=t._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=t._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(s=t._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,r){if(I("SDP_LOGGING"))return S.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during NVConnectionExtension.").concat(r,`
`),t),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(t){if(Xe().supportPCSetConfiguration){const n=Ud.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}t.isPreallocation&&(this.isPreallocation=!0)}},le(it.prototype,"updateRemoteRTPCapabilities",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"updateRemoteRTPCapabilities"),it.prototype),le(it.prototype,"connect",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"connect"),it.prototype),le(it.prototype,"updateRemoteConnect",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"updateRemoteConnect"),it.prototype),le(it.prototype,"createDataChannels",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"createDataChannels"),it.prototype),le(it.prototype,"receive",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"receive"),it.prototype),le(it.prototype,"batchReceive",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"batchReceive"),it.prototype),le(it.prototype,"stopReceiving",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"stopReceiving"),it.prototype),le(it.prototype,"muteRemote",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"muteRemote"),it.prototype),le(it.prototype,"unmuteRemote",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"unmuteRemote"),it.prototype),le(it.prototype,"muteLocal",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"muteLocal"),it.prototype),le(it.prototype,"unmuteLocal",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"unmuteLocal"),it.prototype),le(it.prototype,"close",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"close"),it.prototype),le(it.prototype,"updateEncoderConfig",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"updateEncoderConfig"),it.prototype),le(it.prototype,"updateSendParameters",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"updateSendParameters"),it.prototype),le(it.prototype,"replaceTrack",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"replaceTrack"),it.prototype),le(it.prototype,"updateAdaptation",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"updateAdaptation"),it.prototype),le(it.prototype,"getRemoteSSRC",[Ei],Object.getOwnPropertyDescriptor(it.prototype,"getRemoteSSRC"),it.prototype),it);function Ei(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From NVConnectionExtension.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}var Et;function n1(e){var t,n,i,r=2;for(typeof Symbol<"u"&&(n=cp,i=Symbol.iterator);r--;){if(n&&(t=e[n])!=null)return t.call(e);if(i&&(t=e[i])!=null)return new Bm(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function Bm(e){function t(n){if(Object(n)!==n)return de.reject(new TypeError(n+" is not an object."));var i=n.done;return de.resolve(n.value).then((function(r){return{value:r,done:i}}))}return Bm=function(n){this.s=n,this.n=n.next},Bm.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?de.resolve({value:n,done:!0}):t(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?de.reject(n):t(i.apply(this.s,arguments))}},new Bm(e)}let H9=(Et=class uf extends Qp{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,n){super(t,n),C(this,"name","DataChannelConnection"),C(this,"store",void 0),C(this,"peerConnection",void 0),C(this,"cname",void 0),C(this,"mutex",new Cn("DataChannelConnection-mutex")),C(this,"dataChannel",void 0),C(this,"_p2pConnection",void 0),C(this,"establishPromise",void 0),C(this,"_nvMedia",void 0),this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(uf.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new G9(t,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}getPreMedia(t){var n;return(n=this._p2pConnection)===null||n===void 0?void 0:n.getPreMedia(t)}isPreSub(){var t,n;return(t=(n=this._p2pConnection)===null||n===void 0?void 0:n.isPreSub())!==null&&t!==void 0&&t}async establish(){return await this._p2pConnection.establish()}getP2PConnectionParams(){return this._p2pConnection.establishPromise}updateRtpSenderEncodings(t){return this._p2pConnection.updateRtpSenderEncodings(t)}async connect(t){return this.cname=t.cname,await this._p2pConnection.connect(t),await new de(((n,i)=>{const r=setTimeout((()=>{this.closeSignal(),i(new Y(N.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(t.candidates))))}),I("DC_CONNECTION_TIMEOUT"));this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(r),void n()},this.dataChannel.onerror=s=>{this.closeSignal(),i(s)},this.dataChannel.addEventListener("close",(()=>{i(new Y(N.DATACHANNEL_CONNECTION_TIMEOUT))}))})),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,n){return this._p2pConnection.updateRemoteRTPCapabilities(t,n)}send(t,n,i){var r=this;return li((function*(){const s=yield He(r.mutex.lock("From DataChannelConnection.send"));try{return yield*zc(n1(r._p2pConnection.send(t,n,i)))}finally{s()}}))()}async stopSending(t,n){return this._p2pConnection.stopSending(t,n)}async createDataChannels(t,n){return this._p2pConnection.createDataChannels(t,n)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,n,i,r){return this._nvMedia?(S.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,n,this.cname)):(S.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,n,i,r))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var n=this;return li((function*(){return yield*zc(n1(n._p2pConnection.restartICE(t)))}))()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var n;return(n=this._nvMedia)===null||n===void 0||n.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,n){return await this._p2pConnection.updateEncoderConfig(t,n)}async updateSendParameters(t,n){return await this._p2pConnection.updateSendParameters(t,n)}setStatsRemoteVideoIsReady(t,n){this._p2pConnection.setStatsRemoteVideoIsReady(t,n)}async replaceTrack(t,n){return await this._p2pConnection.replaceTrack(t,n)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,n,i,r){if(I("SDP_LOGGING"))return S.upload("exchanging ".concat(i," ").concat(n," SDP during DataChannelConnection.").concat(r,`
`),t),n==="offer"?s=>{this.logSDPExchange(s,"answer",i==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(t){const n={iceServers:[]};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(ya(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...uf.turnServerConfigToIceServers(t.turnServer.servers)),I("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...uf.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),I("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach((i=>{i.forceturn&&(n.iceTransportPolicy="relay")})))),I("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach((i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(Ir(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!I("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))})),n}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var n;return(n=this.onICEConnectionStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var n;return(n=this.onConnectionStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var n;return(n=this.onDTLSTransportStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var n;return(n=this.onDTLSTransportError)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var n;return(n=this.onICETransportStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var n;return(n=this.onFirstAudioReceived)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var n;return(n=this.onFirstVideoReceived)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var n;return(n=this.onFirstAudioDecoded)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoRender=t=>{var n;return(n=this.onFirstVideoRender)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoBufferReady=t=>{var n;return(n=this.onFirstVideoBufferReady)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,n,i)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,t,n,i)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var n;return(n=this.onFirstVideoDecodedTimeout)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,n)=>{var i;return(i=this.onSelectedLocalCandidateChanged)===null||i===void 0?void 0:i.call(this,t,n)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,n)=>{var i;return(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0?void 0:i.call(this,t,n)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}},le(Et.prototype,"connect",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"connect"),Et.prototype),le(Et.prototype,"updateRemoteRTPCapabilities",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"updateRemoteRTPCapabilities"),Et.prototype),le(Et.prototype,"createDataChannels",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"createDataChannels"),Et.prototype),le(Et.prototype,"receive",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"receive"),Et.prototype),le(Et.prototype,"stopReceiving",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"stopReceiving"),Et.prototype),le(Et.prototype,"muteRemote",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"muteRemote"),Et.prototype),le(Et.prototype,"unmuteRemote",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"unmuteRemote"),Et.prototype),le(Et.prototype,"muteLocal",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"muteLocal"),Et.prototype),le(Et.prototype,"unmuteLocal",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"unmuteLocal"),Et.prototype),le(Et.prototype,"close",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"close"),Et.prototype),le(Et.prototype,"updateEncoderConfig",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"updateEncoderConfig"),Et.prototype),le(Et.prototype,"updateSendParameters",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"updateSendParameters"),Et.prototype),le(Et.prototype,"replaceTrack",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"replaceTrack"),Et.prototype),le(Et.prototype,"getRemoteSSRC",[Ji],Object.getOwnPropertyDescriptor(Et.prototype,"getRemoteSSRC"),Et.prototype),Et);function Ji(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,s=await r.lock("From DataChannelConnection.".concat(t));try{for(var o=arguments.length,a=new Array(o),c=0;c<o;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{s()}},n}function i1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,i)}return n}class K9 extends Vt{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var n;ie(n=["tryNext","recover"]).call(n,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(un.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(un.CONNECTED):this._state==="closed"?this.emit(un.CLOSED):this._state==="failed"&&this.emit(un.FAILED))}constructor(t,n,i,r){super(),C(this,"connectionID",0),C(this,"currentURLIndex",0),C(this,"reconnectReason",void 0),C(this,"_reconnectMode","tryNext"),C(this,"_initMutex",void 0),C(this,"_name",void 0),C(this,"_state","closed"),C(this,"_reconnectInterrupter",void 0),C(this,"_url",void 0),C(this,"_retryConfig",void 0),C(this,"_reconnectCount",0),C(this,"_forceCloseTimeout",5e3),C(this,"_onlineReconnectListener",void 0),C(this,"_closeEstablishingTransmitter",(()=>{})),C(this,"_store",void 0),C(this,"_joinChannelServiceRecordIndex",void 0),C(this,"_transmitter",void 0),C(this,"_useCompress",void 0),C(this,"_inflateLength",0),C(this,"_deflateLength",0),this._store=r,this._name=t,this._retryConfig=(function(s){for(var o=1;o<arguments.length;o++){var a=arguments[o]!=null?arguments[o]:{};o%2?i1(Object(a),!0).forEach((function(c){C(s,c,a[c])})):Object.getOwnPropertyDescriptors?Object.defineProperties(s,Object.getOwnPropertyDescriptors(a)):i1(Object(a)).forEach((function(c){Object.defineProperty(s,c,Object.getOwnPropertyDescriptor(a,c))}))}return s})({},n),this._useCompress=i}resetReconnectCount(t){S.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const i=this._transmitter;n?setTimeout((()=>i.close()),500):i.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,n){if(!this._transmitter)return void S.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;t!==void 0&&(this.reconnectMode=t),S.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((i=this._store)===null||i===void 0||i.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));const r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:n})}getInflateData(){const t=this._inflateLength,n=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:n}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let ss=(function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e})({});class Y9{constructor(t,n,i){C(this,"version",1),C(this,"initialRTO",void 0),C(this,"maxBatchAckCount",void 0),C(this,"maxRTO",void 0),C(this,"initialRTT",void 0),C(this,"ID",void 0),C(this,"rtt",void 0),C(this,"packetNumber",1),C(this,"rtoRatioMap",new Map),C(this,"timeoutMap",new Map),C(this,"unorderedPacketQueue",[]),C(this,"batchAckPacketQueue",[]),C(this,"lastOrderedPacketNumber",0),C(this,"batchAckTimer",void 0),C(this,"sendImpl",void 0),C(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=n,this.ID=mt(7,"transmitter-"),this.initialRTO=i?.initialRTO!==void 0?i.initialRTO:I("TRANSMITTER_INITIAL_RTO"),this.initialRTT=i?.initialRTT!==void 0?i.initialRTT:I("TRANSMITTER_INITIAL_RTT"),this.rtt=i?.initialRTT!==void 0?i.initialRTT:I("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=i?.maxBatchAckCount!==void 0?i.maxBatchAckCount:I("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=i?.maxRTO!==void 0?i.maxRTO:I("TRANSMITTER_MAX_RTO")}packetize(t,n){return{type:ss.Default,version:this.version,packetNumber:n,payload:t}}serialize(t){switch(t.type){case ss.Default:{let n;typeof t.payload=="string"?n=new TextEncoder().encode(t.payload):n=t.payload;const i=new ArrayBuffer(n.length+15),r=new DataView(i);return r.setUint16(0,t.version),r.setUint8(2,t.type),r.setUint32(3,t.packetNumber),nO(r,7,BigInt(t.sendTs)),new Uint8Array(r.buffer).set(n,15),i}case ss.Ack:{const n=new ArrayBuffer(16),i=new DataView(n);return i.setUint16(0,t.version),i.setUint8(2,t.type),i.setUint32(3,t.maxAckPacketNumber),i.setUint8(7,t.shift),nO(i,8,BigInt(t.ackSendTs)),n}}}deserialize(t){const n=new DataView(t),i=n.getUint16(0),r=n.getUint8(2);switch(r){case ss.Default:{const s=n.getUint32(3),o=tO(n,7),a=t.slice(15),c=new Uint8Array(a);return{version:i,type:r,packetNumber:s,sendTs:Number(o),payload:c}}case ss.Ack:{const s=n.getUint32(3),o=n.getUint8(7),a=tO(n,8);return{version:i,type:r,maxAckPacketNumber:s,shift:o,ackSendTs:Number(a)}}default:throw S.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(t){I("DC_DEBUG_LOG")&&typeof t=="string"&&S.debug("[".concat(this.ID,"] sending message packet"),JSON.parse(t));const n=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const i=this.calculateRTO(n),r=window.setTimeout((()=>{this.resendMessage(n)}),i);this.timeoutMap.set(n.packetNumber,r),this.sendPacket(n)}onData(t){const n=this.deserialize(t);n.type===ss.Default?this.ack(n):n.type===ss.Ack&&(this.updateRTT(n,Math.round(performance.now())),this.clearRTO(n))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach((t=>{let[n,i]=t;window.clearTimeout(i)})),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const n=this.calculateRTO(t),i=window.setTimeout((()=>{I("DC_DEBUG_LOG")&&typeof t.payload=="string"&&S.debug("[".concat(this.ID,"] resending message packet"),JSON.parse(t.payload),"timeout: ".concat(n)),this.resendMessage(t)}),n);this.timeoutMap.set(t.packetNumber,i),this.sendPacket(t)}calculateRTO(t){const n=this.rtoRatioMap.get(t.packetNumber);if(n===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*n;return this.rtoRatioMap.set(t.packetNumber,n+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(t,n){const i=t.ackSendTs;this.rtt=this.rtt*(7/8)+(n-i-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout((()=>{this.batchAck()}),this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const n=this.unorderedPacketQueue[0];if(!n){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(n.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:ss.Ack,version:this.version};I("DC_DEBUG_LOG")&&S.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(n)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:ss.Ack,version:this.version};I("DC_DEBUG_LOG")&&S.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(n)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:ss.Ack,version:this.version};I("DC_DEBUG_LOG")&&S.debug("[".concat(this.ID,"] sending batch ack packet"),t,"shift: ".concat(this.batchAckPacketQueue.length-1)),this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===ss.Default&&(t.sendTs=Math.round(performance.now()));const n=this.serialize(t);this.sendImpl(n)}clearRTO(t){for(let n=t.maxAckPacketNumber-t.shift;n<=t.maxAckPacketNumber;n++){const i=this.timeoutMap.get(n);i!==void 0&&window.clearTimeout(i),this.timeoutMap.delete(n),this.rtoRatioMap.delete(n)}}}class r1 extends K9{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),C(this,"_initMutex",void 0),C(this,"_reconnectInterrupter",void 0),C(this,"_url",void 0),C(this,"_transmitter",void 0),C(this,"_addresses",void 0),C(this,"_reliableTransmission",void 0),C(this,"_textEncoder",void 0),C(this,"_textDecoder",void 0),this._textEncoder=new TextEncoder,this._textDecoder=new TextDecoder,this._initMutex=new Cn("datachannel");const{timeout:i,timeoutFactor:r}=n,s=Math.max(300,Math.floor(3*i/5)),o=Math.max(1.2,Math.floor(8*r)/10);ii.ONLINE&&(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o),Gt.on(Ta.NETWORK_STATE_CHANGE,((a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===ii.ONLINE?(this._retryConfig.timeout=s,this._retryConfig.timeoutFactor=o):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=r))}))}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=n;const i=(r,s)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex((a=>a.fingerprint||I("FINGERPRINT")));const o=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(o).then(r).catch(s),this.once(un.CLOSED,(()=>s(new Y(N.WS_DISCONNECT)))),this.once(un.CONNECTED,(()=>r()))};return this._initMutex.lock().then((r=>new de(((s,o)=>{i(s,o)})).then((()=>{r()})).catch((()=>{r()}))))}async sendMessage(t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new Y(N.WS_ABORT,"datachannel is not ready");try{n||(t=JSON.stringify(t));const i=this._textEncoder.encode(t),r=r9(i,{raw:!0});this._reliableTransmission.sendMessage(r)}catch(i){throw new Y(N.WS_ERR,"send datachannel signal message error"+i.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const n=JSON.stringify(t);return{compressed:n,compressedLength:n.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new de(((n,i)=>{var r;const s=()=>{S.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="recover",this.state="connected",this.resetReconnectCount("opened"),n()},o=async p=>{var m;if((m=this._closeEstablishingTransmitter)===null||m===void 0||m.call(this),S.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(p.code,", reason: ").concat(p.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=p.reason,this.state="reconnecting");const _=Di(this,un.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,g=await this.reconnectWithAction(_);if(this.state==="closed")return void S.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!g)return i(new Y(N.WS_DISCONNECT,"datachannel reconnect failed: ".concat(p.code))),void this.close(!0);n()}else i(new Y(N.WS_DISCONNECT,"datachannel close: ".concat(p.code))),this.close()},a=async p=>{try{var m;(m=this._reliableTransmission)===null||m===void 0||m.onData(p.data)}catch(_){console.log(_)}};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),S.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),u=Date.now();sn(this,un.TO_CONNECT_DATACHANNEL).then((p=>{var m,_;if(!p)throw new Error("transmissonInfo not exist yet");const{transmitter:g,close:b}=p;this._transmitter=g,(m=this._store)===null||m===void 0||m.signalChannelOpen();const v=Date.now()-u;S.debug("[choose dc] dc open cost ".concat(v,"ms")),this._reliableTransmission=new Y9((R=>{var O;this._transmitter&&this._transmitter.readyState==="open"&&((O=this._transmitter)===null||O===void 0||O.send(R))}),(R=>{if(typeof R=="string")this.emit(un.ON_MESSAGE,R);else{const O=o9(R,{raw:!0}).buffer,D=this._textDecoder.decode(O);this.emit(un.ON_MESSAGE,D)}})),this._closeEstablishingTransmitter=()=>{var R;(R=this._reliableTransmission)===null||R===void 0||R.close(),this._reliableTransmission=void 0,b()},s&&s(),g.onclose=o,g.onmessage=a,(_=this._store)===null||_===void 0||_.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c})).catch((p=>{var m;if((m=this._store)===null||m===void 0||m.recordJoinChannelService({endTs:Date.now(),status:p instanceof Y&&p.code===N.WS_ABORT?"aborted":"error",errors:[p]},c),this.state!=="closed"){if(p instanceof Y&&p.code===N.WS_ERR){const _=new Y(N.WS_ERR,"init datachannel failed! Error: ".concat(p.toString()));return S.error("[".concat(this._name,"]").concat(_)),void i(_)}o&&o(p)}else i(new Y(N.WS_DISCONNECT,"datachannel is closed: ".concat(p.toString())))}))}))}async reconnectWithAction(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||Gt.networkState!==ii.OFFLINE||(this._onlineReconnectListener=Gt.onlineWaiter&&Gt.onlineWaiter.then((()=>{this._onlineReconnectListener=void 0})));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},n){const a=Tp(this._reconnectCount,this._retryConfig);S.debug("[".concat(this._name,"] wait ").concat(a,"ms to reconnect datachannel, mode: ").concat(t)),await de.race([En(a),this._onlineReconnectListener||new de((()=>{}))])}if(this.state==="closed"||!i)return!1;this._reconnectCount+=1;const r=async(a,c)=>{this.emit(un.RECONNECT_CREATE_CONNECTION,c),await this.createTransmitterConnection(a)};try{if(t==="retry"){const a=this._addresses[this.currentURLIndex];await r(a,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let c=this.currentURLIndex;c<this._addresses.length;c++){if(this._addresses[c].fingerprint||I("FINGERPRINT")){this.currentURLIndex=c;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return S.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);S.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const a=this._addresses[this.currentURLIndex];await r(a,t)}else t==="recover"&&(S.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(un.FAILBACK));return!0}catch(a){var s,o;return S.error("[".concat(this._name,"] reconnect failed"),a.toString()),a!=null&&(s=a.data)!==null&&s!==void 0&&s.desc&&Array.isArray(a.data.desc)&&a.data.desc.length&&ie(o=a.data.desc).call(o,"dynamic key expired")?(this.emit(un.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,n)}}}class z9 extends Vt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===$e.CONNECTED?this.emit(Te.WS_CONNECTED):t===$e.RECONNECTING?this.emit(Te.WS_RECONNECTING,this._websocketReconnectReason):t===$e.CLOSED&&this.emit(Te.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}processPendingNotifications(){this.pendingNotifications.length!==0&&(S.debug("[".concat(this.clientId,"] processing ").concat(this.pendingNotifications.length," pending notifications")),this.pendingNotifications.forEach((t=>{let{type:n,message:i}=t;this.emit(n,i),n===Le.ON_NOTIFICATION&&this.handleNotification(i),n===Le.ON_USER_BANNED&&this.handleUserBanned(i)})),this.pendingNotifications=[])}handleUserBanned(t){switch(t.error_code){case 14:this.close(Ze.UID_BANNED);break;case 15:this.close(Ze.IP_BANNED);break;case 16:this.close(Ze.CHANNEL_BANNED)}}constructor(t,n){super(),C(this,"__name__","DataChannelSignal"),C(this,"_disconnectedReason",void 0),C(this,"_websocketReconnectReason",void 0),C(this,"_connectionState",$e.CLOSED),C(this,"reconnectToken",void 0),C(this,"websocket",void 0),C(this,"openConnectionTime",void 0),C(this,"clientId",void 0),C(this,"lastMsgTime",Date.now()),C(this,"uploadCache",[]),C(this,"uploadCacheInterval",void 0),C(this,"rttRolling",new nS(5)),C(this,"pingpongTimer",void 0),C(this,"inflateDataTimer",void 0),C(this,"pingpongTimeoutCount",0),C(this,"ortc",void 0),C(this,"joinResponse",void 0),C(this,"multiIpOption",void 0),C(this,"initError",void 0),C(this,"spec",void 0),C(this,"store",void 0),C(this,"isJoining",!1),C(this,"pendingNotifications",[]),C(this,"onWebsocketMessage",(i=>{if(i instanceof ArrayBuffer)return void this.emit(Te.ON_BINARY_DATA,i);const r=JSON.parse(i);if(I("DC_DEBUG_LOG")&&S.debug("[datachannel-signal] received packet",r),this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const s="res-@".concat(r._id);this.emit(s,r._result,r._message)}else Object.prototype.hasOwnProperty.call(r,"_type")&&(this.isJoining?r._type===Le.ON_NOTIFICATION||r._type===Le.ON_USER_BANNED?(this.emit(r._type,r._message),r._type===Le.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Le.ON_USER_BANNED&&this.handleUserBanned(r._message)):(this.pendingNotifications.push({type:r._type,message:r._message}),S.debug("[".concat(this.clientId,"] cached notification during join: ").concat(r._type))):(this.emit(r._type,r._message),r._type===Le.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===Le.ON_USER_BANNED&&this.handleUserBanned(r._message)))})),this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new r1("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",(()=>{this.connectionState===$e.CONNECTED&&this.reconnect("retry",No.OFFLINE)}))}async request(t,n,i,r){const s=mt(6,""),o={_id:s,_type:t,_message:n},a=this.websocket.connectionID,c=()=>new de(((b,v)=>{if(this.connectionState===$e.CONNECTED)return b();const R=()=>{this.off(Te.WS_CLOSED,O),b()},O=()=>{this.off(Te.WS_CONNECTED,R),v(new Y(N.WS_ABORT))};this.once(Te.WS_CONNECTED,R),this.once(Te.WS_CLOSED,O),t!==Ce.PUBLISH&&t!==Ce.SUBSCRIBE&&t!==Ce.UNSUBSCRIBE&&t!==Ce.UNPUBLISH&&t!==Ce.CONTROL&&t!==Ce.RESTART_ICE||this.once(Te.DISCONNECT_P2P,(()=>{v(new Y(N.DISCONNECT_P2P))})),t!==Ce.PUBLISH&&t!==Ce.RESTART_ICE||this.once(Te.ABORT_P2P_EXECUTION,(()=>{v(new Y(N.DISCONNECT_P2P))}))}));if(this.connectionState!==$e.CONNECTING&&this.connectionState!==$e.RECONNECTING||t===Ce.JOIN||t===Ce.REJOIN||await c(),t===Ce.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),I("DC_DEBUG_LOG")&&S.debug("[datachannel-signal] sendMessage",o),await this.websocket.sendMessage(o,!0,!1),r)return;const u=new de(((b,v)=>{let R=!1;const O=(x,B)=>{R=!0,b({isSuccess:x==="success",message:B||{}}),this.off(Te.WS_CLOSED,D),this.off(Te.WS_RECONNECTING,D),this.emit(Te.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(s),O);const D=()=>{v(new Y(N.WS_ABORT,"type: ".concat(t))),this.off(Te.WS_CLOSED,D),this.off(Te.WS_RECONNECTING,D),this.off("res-@".concat(s),O)};this.once(Te.WS_CLOSED,D),this.once(Te.WS_RECONNECTING,D),En(I("SIGNAL_REQUEST_TIMEOUT")).then((()=>{this.websocket.connectionID!==a||R||(S.warning("dc request timeout, type: ".concat(t)),this.emit(Te.REQUEST_TIMEOUT,t,n))}))}));let p=null;try{p=await u}catch(b){if(this.connectionState===$e.CLOSED||t===Ce.LEAVE)throw new Y(N.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?b.throw():t===Ce.JOIN||t===Ce.REJOIN?null:(await c(),await this.request(t,n))}if(p.isSuccess)return p.message;const m=Number(p.message.error_code||p.message.code),_=Ua(m),g=new Y(N.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(p.message.error_str),{code:m,data:p.message});return _.action==="success"?p.message:(S.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(m,", message: ").concat(_.desc,", action: ").concat(_.action)),m===we.ERR_TOO_MANY_BROADCASTERS?((t===Ce.JOIN||t===Ce.REJOIN)&&(this.initError=g,this.close()),g.throw()):_.action==="failed"?g.throw():_.action==="quit"?(this.initError=g,this.close(),g.throw()):(m===we.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=p.message.option,S.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",No.MULTI_IP)):this.reconnect(_.action,No.SERVER_ERROR),t===Ce.JOIN||t===Ce.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new de((i=>{const r=s=>{(!n||n(s))&&(this.off(t,r),i(s))};this.on(t,r)}))}uploadWRTCStats(t){if(!this.store.sessionId)return void S.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Ma.WRTC_STATS,n)}upload(t,n){const i={_type:t,_message:n};try{this.websocket.sendMessage(i)}catch{const s=I("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>s&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval((()=>{if(this.connectionState!==$e.CONNECTED)return;const o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)}),I("UPLOAD_CACHE_INTERVAL")||2e3))}}async send(t,n){const i={_type:t,_message:n};await this.websocket.sendMessage(i)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new de(((n,i)=>{this.once(Te.WS_CONNECTED,(()=>n(this.joinResponse))),this.once(Te.WS_CLOSED,(()=>i(this.initError||new Y(N.WS_ABORT)))),this.connectionState=$e.CONNECTING,this.websocket.init(t).catch(i),this.websocket.once(un.FAILBACK,(()=>{i(new Y(N.INIT_DATACHANNEL_TIMEOUT))})),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval((()=>{this.handleInflateData()}),2e4),setTimeout((()=>{this.openConnectionTime===void 0&&(S.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),i(new Y(N.INIT_DATACHANNEL_TIMEOUT)))}),I("DC_JOIN_WITH_FAILBACK"))}))}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this.isJoining=!1,this.pendingNotifications=[],this._disconnectedReason=t||Ze.LEAVE,this.connectionState=$e.CLOSED,S.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===Ze.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new r1("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),I("DC_PINGPONG_INTERVAL")),!this.joinResponse){this.emit(Te.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await sn(this,Te.REQUEST_JOIN_INFO);this.store.joinReq(),this.isJoining=!0,this.pendingNotifications=[];const n=await this.request(Ce.JOIN,t);if(this.store.joinRep(),this.ortc=t?.ortc,!n)return this.emit(Te.REPORT_JOIN_GATEWAY,N.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(Te.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=$e.CONNECTED,this.isJoining=!1,this.processPendingNotifications(),!0}async rejoin(){if(!this.reconnectToken)throw new Y(N.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=va(this,Te.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const n=await this.request(Ce.REJOIN,t);return!!n&&(this.connectionState=$e.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),I("DC_PINGPONG_INTERVAL")),n.peers&&n.peers.forEach((i=>{this.emit(Le.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(Le.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(Le.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(Le.MUTE_AUDIO,{uid:i.uid}):this.emit(Le.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(Le.MUTE_VIDEO,{uid:i.uid}):this.emit(Le.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(Le.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(Le.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(Le.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(Le.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(Le.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})})),!0)}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}async downgradeCodec(t){if(!this.ortc)return!1;const n={downgrade_codec:t,ortc:this.ortc};return!!await this.request(Ce.DOWNGRADE_CODEC,n)}handleNotification(t){S.debug("[".concat(this.clientId,"] receive notification: "),t);const n=Ua(t.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ze.UID_BANNED),void this.close()):void this.reconnect(n.action,No.SERVER_ERROR);S.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1,I("DC_DEBUG_LOG")&&console.debug("[datachannel-signal] pingpongTimeoutCount: ".concat(this.pingpongTimeoutCount));const t=I("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(S.warning("[datachannel-signal] PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>I("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("recover",No.FALLBACK):this.request(Ce.PING,void 0,!0).then((()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),I("REPORT_STATS")&&this.send(Ce.PING_BACK,{pingpongElapse:i})})).catch((i=>{}))}handleInflateData(){const{inflateLength:t,deflateLength:n}=this.websocket.getInflateData();t!==0&&n!==0&&this.upload(Ma.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(un.RECONNECT_CREATE_CONNECTION,(t=>{this.emit(Te.WS_RECONNECT_CREATE_CONNECTION,t)})),this.websocket.on(un.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(un.CLOSED,(()=>{this.connectionState=$e.CLOSED})),this.websocket.on(un.FAILED,(()=>{this._disconnectedReason=Ze.NETWORK_ERROR,this.connectionState=$e.CLOSED})),this.websocket.on(un.RECONNECTING,(t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===$e.CONNECTED?this.connectionState=$e.RECONNECTING:this.connectionState=$e.CONNECTING})),this.websocket.on(un.WILL_RECONNECT,((t,n)=>{if(va(this,Te.IS_P2P_DISCONNECTED)&&t==="retry")return S.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Te.NEED_RENEW_SESSION),this.emit(Te.DISCONNECT_P2P),n("tryNext");t!=="retry"&&(S.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(Te.NEED_RENEW_SESSION),this.emit(Te.DISCONNECT_P2P)),n(t)})),this.websocket.on(un.CONNECTED,(()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch((t=>{S.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",No.SERVER_ERROR)})):this.join().catch((t=>{if(this.emit(Te.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof Y&&t.code===N.UNEXPECTED_RESPONSE&&t.data.code===we.ERR_NO_AUTHORIZED)return S.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",No.SERVER_ERROR);S.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",No.SERVER_ERROR):(this.initError=t,this.close())}))})),this.websocket.on(un.REQUEST_NEW_URLS,((t,n)=>{sn(this,Te.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)})),this.websocket.on(un.ON_TOKEN_PRIVILEGE_DID_EXPIRE,(()=>{this.emit(Le.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})),this.websocket.on(un.TO_CONNECT_DATACHANNEL,((t,n)=>{sn(this,Te.PRE_CONNECT_PC).then(t).catch(n)})),this.websocket.on(un.FAILBACK,(()=>{this.openConnectionTime!==void 0&&this.emit(Te.DATACHANNEL_FAILBACK)}))}}const q9={name:"DataChannelConnection",create:function(e){let{store:t,spec:n}=e;return new H9(n,t)}},X9={name:"DataChannelSignal",create:function(e){let{store:t,spec:n}=e;return new z9(n,t)}};cS(),St("PROCESS_ID","process-".concat(mt(8,""),"-").concat(mt(4,""),"-").concat(mt(4,""),"-").concat(mt(4,""),"-").concat(mt(12,""))),(function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void S.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),n=Date.now();S.debug("Loading global parameters from cache",t),Object.keys(t).forEach((i=>{if(Object.prototype.hasOwnProperty.call(ft,i)){const{value:r,expires:s}=t[i];if(s&&s<=n)return;Bi[i]=r,ft[i]=r}}))}catch(t){S.error("Error loading mutableParamsCache: ".concat(e),t.message)}})(),Array.isArray(Bi.AREAS)&&Bi.AREAS.length>0&&dy(Bi.AREAS,!0);const s1=(e,t,n)=>{S.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(t))),St(e,t,n)};ws(u9,!1),ws(m9,!1),ws(Hq,!1),ws(b9,!1),ws(c9,!1),ws(U9,!1),ws(F9,!1),ws(W9,!1),ws(q9,!1),ws(X9,!1);const on=(function(e){const t=new Vt,n=e,i={getListeners:t.getListeners.bind(t),on:(r,s)=>((function(o,a){o===Rs.SECURITY_POLICY_VIOLATION&&Lk(a,!0)})(r,s),t.on.bind(t)(r,s)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return Pk(Pk({},n),i)})({__TRACK_LIST__:Ia,VERSION:tr,BUILD:uS,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:s1,getParameter:I,getSupportedCodec:async function(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;const n=await(async function(i){let r;return Xe().supportUnifiedPlan?(i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"}),r=(await i.createOffer()).sdp):r=(await i.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r})(t);if(!n)return e;t.close(),t=null,e=(function(i){const r={video:[],audio:[]};return i.match(/ VP8/i)&&r.video.push("VP8"),i.match(/ VP9/i)&&r.video.push("VP9"),i.match(/ AV1/i)&&r.video.push("AV1"),i.match(/ H264/i)&&r.video.push("H264"),i.match(/ H265/i)&&r.video.push("H265"),i.match(/ opus/i)&&r.audio.push("OPUS"),i.match(/ PCMU/i)&&r.audio.push("PCMU"),i.match(/ PCMA/i)&&r.audio.push("PCMA"),i.match(/ G722/i)&&r.audio.push("G722"),r})(n)}catch(t){throw new Y(N.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return e},checkSystemRequirements:function(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];const t=Se.reportApiInvoke(null,{name:xt.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Ct.TRACER}),n=(function(){let s=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],o=!1;try{const a=window.RTCPeerConnection,c=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,u=window.WebSocket;o=!(!a||!u),s&&!c&&(o=!1),o&&Nl()&&H0(75)&&new a().close()}catch(a){S.error("check system requirement failed: ",a),o=!1}return o})(e),i=Yq();S.debug("checkSystemRequirements, api:",n,"browser",i);const r=n&&i;return t.onSuccess(r),I("IGNORE_RTC_DEVICE_CHECK")?n:r},getDevices:function(e){return Yi.enumerateDevices(!0,!0,e)},getMicrophones:function(e){return Yi.getRecordingDevices(e)},getCameras:function(e){return Yi.getCamerasDevices(e)},getElectronScreenSources:XO,getPlaybackDevices:function(e){return Yi.getSpeakers(e)},createClient:Ok,createCameraVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=I("CAMERA_CAPTURE_CONFIG"),n=mt(8,"track-cam-"),i=Se.reportApiInvoke(null,{id:n,tag:Ct.TRACER,name:xt.CREATE_CAM_VIDEO_TRACK,options:[Ot({},e),t]});t&&(e.encoderConfig=t);const r=kp(e);let s=null;S.info("start create camera video track with config",JSON.stringify(e),"trackId",n);try{s=(await Ki({video:r},n)).getVideoTracks()[0]||null}catch(a){throw i.onError(a),a}if(!s){const a=new J(N.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(a),a.throw(S)}if(e.optimizationMode&&NS(n,s,e,br(e.encoderConfig)),I("USE_STANDARD_BITRATE_DEFAULT")){const a=br(e.encoderConfig);e.encoderConfig=a,delete a.bitrateMax,delete a.bitrateMin}const o=new Mp(s,e,r,e.scalabiltyMode?Np(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,n);return i.onSuccess(o.getTrackId()),S.info("create camera video success, trackId:",n),o},createCustomVideoTrack:function(e){const t=mt(8,"track-cus-"),n=Se.reportApiInvoke(null,{id:t,tag:Ct.TRACER,name:xt.CREATE_CUSTOM_VIDEO_TRACK,options:[e]});I("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin);const i=new bt(e.mediaStreamTrack,{width:e.width,height:e.height,frameRate:e.frameRate,bitrateMax:e.bitrateMax,bitrateMin:e.bitrateMin},e.scalabiltyMode?Np(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,t,[ht.CUSTOM_TRACK]);return n.onSuccess(i.getTrackId()),S.info("create custom video track success with config",e,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const n=typeof t=="object"?(function(_){const g=sN(_);return VO()&&_.suppressLocalAudioPlayback&&(g.suppressLocalAudioPlayback=_.suppressLocalAudioPlayback),jO()&&_.restrictOwnAudio&&(g.restrictOwnAudio=!0),g})(t):void 0;n&&(t="auto");const i=mt(8,"track-scr-v-"),r=Se.reportApiInvoke(null,{id:i,tag:Ct.TRACER,name:xt.CREATE_SCREEN_VIDEO_TRACK,options:[Ot({},e),t]});e.encoderConfig?typeof e.encoderConfig=="string"||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";const s=(function(_){const g={};_.screenSourceType&&(g.mediaSource=_.screenSourceType),_.extensionId&&Xs()&&(g.extensionId=_.extensionId);const{displaySurface:b,selfBrowserSurface:v,surfaceSwitching:R,systemAudio:O,preferCurrentTab:D,windowAudio:x,monitorTypeSurfaces:B}=_;(Yr(107)||bo(107)||Sa(93))&&(b&&(Zt(b,"displaySurface",["browser","window","monitor"]),g.displaySurface=b),v?(Zt(v,"selfBrowserSurface",["exclude","include"]),g.selfBrowserSurface=v):g.selfBrowserSurface="include",R&&(Zt(R,"surfaceSwitching",["exclude","include"]),g.surfaceSwitching=R)),(Yr(105)||bo(105)||Sa(91))&&O&&(Zt(O,"systemAudio",["exclude","include"]),g.systemAudio=O),(Yr(94)||bo(94)||Sa(80))&&D&&(g.preferCurrentTab=!0),(Yr(141)||bo(141)||Sa(125))&&x&&(Zt(x,"windowAudio",["exclude","system"]),g.windowAudio=x),(Yr(119)||bo(119)||Sa(105))&&B&&(Zt(B,"monitorTypeSurfaces",["exclude","include"]),g.monitorTypeSurfaces=B),_.electronScreenSourceId&&(g.sourceId=_.electronScreenSourceId);const G=_.encoderConfig?gS(_.encoderConfig):null;return g.mandatory={chromeMediaSource:"desktop",maxWidth:G?G.width:void 0,maxHeight:G?G.height:void 0},G&&(G.frameRate&&(typeof G.frameRate=="number"?(g.mandatory.maxFrameRate=G.frameRate,g.mandatory.minFrameRate=G.frameRate):(g.mandatory.maxFrameRate=G.frameRate.max||G.frameRate.ideal||G.frameRate.exact||void 0,g.mandatory.minFrameRate=G.frameRate.min||G.frameRate.ideal||G.frameRate.exact||void 0),g.frameRate=G.frameRate),G.width&&(g.width=G.width),G.height&&(g.height=G.height)),g})(e);let o=null,a=null;const c=Xe();if(!c.supportShareAudio&&t==="enable"){const _=new J(N.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return r.onError(_),_.throw(S)}S.info("start create screen video track with config",e,"withAudio",t,"trackId",i);const u=c.supportShareAudio&&t!=="disable";try{const _=await Ki({screen:s,screenAudio:u?n||!0:void 0},i);o=_.getVideoTracks()[0]||null,a=_.getAudioTracks()[0]||null}catch(_){throw r.onError(_),_}if(!o){const _=new J(N.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(_),_.throw(S)}if(!a&&t==="enable"){o&&o.stop();const _=new J(N.SHARE_AUDIO_NOT_ALLOWED);return r.onError(_),_.throw(S)}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(NS(i,o,e,e.encoderConfig&&gS(e.encoderConfig)||void 0),e.encoderConfig&&typeof e.encoderConfig!="string"&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));const p=new bt(o,e.encoderConfig?gS(e.encoderConfig):{},e.scalabiltyMode?Np(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,i,[ht.SCREEN_TRACK]);if(!a)return r.onSuccess(p.getTrackId()),S.info("create screen video track success","video:",p.getTrackId()),p;const m=new Yt(a,void 0,mt(8,"track-scr-a-"),!1);return r.onSuccess([p.getTrackId(),m.getTrackId()]),S.info("create screen video track success","video:",p.getTrackId(),"audio:",m.getTrackId()),[p,m]},createMicrophoneAndCameraTracks:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=I("CAMERA_CAPTURE_CONFIG"),i=mt(8,"track-mic-"),r=mt(8,"track-cam-"),s=Se.reportApiInvoke(null,{id:"".concat(i,"-").concat(r),tag:Ct.TRACER,name:xt.CREATE_MIC_AND_CAM_TRACKS,options:[e,t,n]});n&&(t.encoderConfig=n);const o=kp(t),a=oN(e);let c=null,u=null;S.info("start create camera video track(".concat(r,") and microphone audio track(").concat(i,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(t)));try{const _=await Ki({audio:a,video:o},"".concat(i,"-").concat(r));c=_.getAudioTracks()[0],u=_.getVideoTracks()[0]}catch(_){throw s.onError(_),_}if(!c||!u){const _=new J(N.UNEXPECTED_ERROR,"can not find tracks in media stream");return s.onError(_),_.throw(S)}if(t.optimizationMode&&NS(r,u,t,br(t.encoderConfig)),I("USE_STANDARD_BITRATE_DEFAULT")){const _=br(t.encoderConfig);t.encoderConfig=_,delete _.bitrateMax,delete _.bitrateMin}const p=new Fl(c,e,a,i),m=new Mp(u,t,o,t.scalabiltyMode?Np(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,r);return s.onSuccess([p.getTrackId(),m.getTrackId()]),S.info("create camera video track(".concat(r,") and microphone audio track(").concat(i,") success")),[p,m]},createMicrophoneAudioTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=mt(8,"track-mic-"),n=Se.reportApiInvoke(null,{id:t,tag:Ct.TRACER,name:xt.CREATE_MIC_AUDIO_TRACK,options:[e]}),i=oN(e);let r=null;S.info("start create microphone audio track with config",JSON.stringify(e),"trackId",t);try{r=(await Ki({audio:i},t)).getAudioTracks()[0]||null}catch(o){throw n.onError(o),o}if(!r){const o=new J(N.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(o),o.throw(S)}const s=new Fl(r,e,i,t);return n.onSuccess(s.getTrackId()),S.info("create microphone audio track success, trackId:",t),s},createCustomAudioTrack:PD,createBufferSourceAudioTrack:async function(e){var t;const{cacheOnlineFile:n,encoderConfig:i}=e;let{source:r}=e;const s={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(t=File.name)!==null&&t!==void 0?t:"File":r,cacheOnlineFile:n,encoderConfig:i},o=mt(8,"track-buf-"),a=Se.reportApiInvoke(null,{id:o,tag:Ct.TRACER,name:xt.CREATE_BUFFER_AUDIO_TRACK,options:[s]});if(I("DISABLE_WEBAUDIO"))throw new J(N.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");S.info("start create buffer source audio track with config",JSON.stringify(s),"trackId",o);const c=r;if(!(r instanceof AudioBuffer))try{r=await(async function(m,_){let g=null;if(typeof m=="string"){const v=zN.get(m);if(v)return S.debug("use cached audio resource: ",m),v;try{g=(await zr((()=>ui.get(m,{responseType:"arraybuffer"})),void 0,void 0,{maxRetryCount:3})).data}catch(R){throw new J(N.FETCH_AUDIO_FILE_FAILED,R.toString())}}else g=await new de(((R,O)=>{const D=new FileReader;D.onload=x=>{x.target?R(x.target.result):O(new J(N.READ_LOCAL_AUDIO_FILE_ERROR))},D.onerror=()=>{O(new J(N.READ_LOCAL_AUDIO_FILE_ERROR))},D.readAsArrayBuffer(m)}));const b=await(function(v){const R=ad();return new de(((O,D)=>{R.decodeAudioData(v,(x=>{O(x)}),(x=>{D(new J(N.DECODE_AUDIO_FILE_FAILED,x.toString()))}))}))})(g);return typeof m=="string"&&_&&zN.set(m,b),b})(r,n)}catch(m){return a.onError(m),m.throw(S)}const u=new uz(r),p=new lz(c,u,i?Dp(i):{},o);return S.info("create buffer source audio track success, trackId:",o),a.onSuccess(p.getTrackId()),p},setAppType:function(e){if(S.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw S.debug("Invalid appType"),new Y(N.INVALID_PARAMS,"invalid app type",e);St("APP_TYPE",Math.floor(e))},setLogLevel:function(e){S.setLogLevel(e)},enableLogUpload:function(){I("USE_NEW_LOG")?St("UPLOAD_LOG",!0):S.enableLogUpload()},disableLogUpload:function(){I("USE_NEW_LOG")?St("UPLOAD_LOG",!1):S.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new JP},checkAudioTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=Se.reportApiInvoke(null,{tag:Ct.TRACER,name:xt.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof Yt||e instanceof ld)){const c=new Y(N.INVALID_TRACK,"the parameter is not a audio track");return n.onError(c),c.throw()}t&&t<1e3&&(t=1e3);const i=e instanceof Yt?e.getTrackLabel():"remote_track",r=e.getVolumeLevel();let s=r,o=r;const a=Date.now();return new de((c=>{const u=setInterval((()=>{const p=e.getVolumeLevel();s=p>s?p:s,o=p<o?p:o;const m=s-o>1e-4,_=Date.now()-a;if(m||_>t){clearInterval(u);const g=m,b={duration:_,deviceLabel:i,maxVolumeLevel:s,result:g};S.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(b))),n.onSuccess(b),c(g)}}),200)}))},checkVideoTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=Se.reportApiInvoke(null,{tag:Ct.TRACER,name:xt.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof bt||e instanceof dd)){const m=new Y(N.INVALID_TRACK,"the parameter is not a video track");return n.onError(m),m.throw()}t&&t<1e3&&(t=1e3);const i=e instanceof bt?e.getTrackLabel():"remote_track",r=e.getMediaStreamTrack(!0),s=document.createElement("video");s.style.width="1px",s.style.height="1px",s.setAttribute("muted",""),s.muted=!0,s.setAttribute("playsinline",""),s.controls=!1,(Rn()||Ep())&&(s.style.opacity="0.01",s.style.position="fixed",s.style.left="0",s.style.top="0",document.body.appendChild(s)),s.srcObject=new MediaStream([r]),s.play();const o=document.createElement("canvas");o.width=160,o.height=120;let a=0,c=0;try{const m=Date.now();a=await(function(_,g,b,v){let R,O=0,D=null;return new de(((x,B)=>{function G(){O>v&&R&&(R(),x(O));const j=b.getContext("2d");if(!j){const ne=new Y(N.UNEXPECTED_ERROR,"can not get canvas 2d context.");return S.error(ne.toString()),void B(ne)}j.drawImage(_,0,0,160,120);const H=j.getImageData(0,0,b.width,b.height),Z=Math.floor(H.data.length/3);if(D){for(let ne=0;ne<Z;ne+=3)if(H.data[ne]!==D[ne])return O+=1,void(D=H.data);D=H.data}else D=H.data}setTimeout((()=>{R&&(R(),x(O))}),g),R=RS((()=>{G()}),30)}))})(s,t,o,4),c=Date.now()-m}catch(m){throw n.onError(m),m}Nq===at.SAFARI&&(s.pause(),s.remove()),s.srcObject=null;const u=a>4,p={duration:c,changedPicNum:a,deviceLabel:i,result:u};return S.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(p))),n.onSuccess(p),u},setArea:dy,audioElementPlayCenter:Jn,resumeAudioContext:function(){return Jn.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(e){qq.processExternalMediaAEC(e)},registerExtensions:function(e){const t=I("PLUGIN_INFO")||[];e.forEach((n=>{"name"in n&&!ie(t).call(t,n.name)&&t.push(n.name);const i=n;i.__registered__=!0,i.logger.hookLog=S.extLog,i.reporter.hookApiInvoke=Se.extApiInvoke,i.parameters&&Object.keys(i.parameters).forEach((r=>{i.parameters[r]=I(r)}))})),s1("PLUGIN_INFO",t)},ChannelMediaRelayError:pd,ChannelMediaRelayEvent:$s,ChannelMediaRelayState:yi,RemoteStreamFallbackType:rz,RemoteStreamType:iz,ConnectionDisconnectedReason:Ze,AudienceLatencyLevelType:PY,AREAS:lt,preload:async function(e,t,n,i){return Dy(e,t,n,i)},startLastmileProbeTest:async function(e,t,n,i){let r={state:"unavailable"};await Dy(e,t,n,i);const s=await Py({appId:e,cname:t,token:n||e,uid:i,cloudProxyServer:"disabled"});if(!s)return r;await Ly(s);let o,a=Ok({mode:"rtc",codec:"vp8"});try{o=await a.join(e,t,n,i,{networkQualityProbe:!0})}catch{return r}const c=new kq,u=c.createMuteAudioTrack();let p=await PD({mediaStreamTrack:u});await a.publish([p]);let[m,_,g]=await new de(((x,B)=>{const G=setTimeout((()=>{clearTimeout(G),x([!0,null,"audio"])}),5e3);a.on("user-published",(async(j,H)=>{j.uid===o&&(clearTimeout(G),x([!1,j,H]))}))}));if(m||!_)return await a.unpublish([p]),await a.leave(),p.close(),c.close(),r;await a.subscribe(_,g),await new de(((x,B)=>{const G=setTimeout((()=>{clearTimeout(G),x(null)}),5e3)}));let b=a.getRTCStats(),v=a.getLocalAudioStats();const R=b.RTT,O=v.sendJitterMs,D=v.currentPacketLossRate;return r={state:"complete",rtt:R,packetLossRate:D,jitter:O,networkQuality:((x,B,G)=>{let j=1;if(G>0){let De=Math.log(100*G)/Math.log(2)+1;De=Math.min(5,Math.max(0,De)),j=1-De/5}let H=1;if(x>0){let De=Math.log(x/40)/Math.log(2)+1;De=Math.min(5,Math.max(0,De)),H=1-De/5}let Z=1;if(B>0){let De=Math.log(B/10)/Math.log(2.5)+1;De=Math.min(5,Math.max(0,De)),Z=1-De/5}const ne=.5*j+.3*H+.2*Z;let he=0;return he=ne>=.8?1:ne>=.6?2:ne>=.4?3:ne>=.2?4:5,he})(R,O,D)},await a.unsubscribe(_),await a.unpublish([p]),await a.leave(),p.close(),c.close(),await Ly(s),r}});return Object.defineProperties(on,{onAudioAutoplayFailed:{get:()=>pi.onAudioAutoplayFailed,set:e=>{pi.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>pi.onAutoplayFailed,set:e=>{pi.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>on._onSecurityPolicyViolation,set(e){on._onSecurityPolicyViolation=e,Lk(e)}},__CLIENT_LIST__:{get:()=>I("SHOW_GLOBAL_CLIENT_LIST")?ka:[]}}),Yi.on(Na.CAMERA_DEVICE_CHANGED,(e=>{S.info("camera device changed",JSON.stringify(e)),on.onCameraChanged&&on.onCameraChanged(e),on.safeEmit(Rs.CAMERA_CHANGED,e)})),Yi.on(Na.RECORDING_DEVICE_CHANGED,(e=>{S.info("microphone device changed",JSON.stringify(e)),on.onMicrophoneChanged&&on.onMicrophoneChanged(e),on.safeEmit(Rs.MICROPHONE_CHANGED,e)})),Yi.on(Na.PLAYOUT_DEVICE_CHANGED,(e=>{S.debug("playout device changed",JSON.stringify(e)),on.onPlaybackDeviceChanged&&on.onPlaybackDeviceChanged(e),on.safeEmit(Rs.PLAYBACK_DEVICE_CHANGED,e)})),Jn.onAutoplayFailed=()=>{S.info("detect audio element autoplay failed"),pi.onAudioAutoplayFailed&&pi.onAudioAutoplayFailed()},yt.on("autoplay-failed",(()=>{S.info("detect webaudio autoplay failed"),pi.onAudioAutoplayFailed&&pi.onAudioAutoplayFailed(),on.safeEmit(Rs.AUTOPLAY_FAILED)})),yt.on(Dn.STATE_CHANGE,((e,t)=>{S.info("audio context state changed: ".concat(t," => ").concat(e)),on.onAudioContextStateChanged&&on.onAudioContextStateChanged(e,t),on.safeEmit(Rs.AUDIO_CONTEXT_STATE_CHANGED,e,t)})),Gt.on(Ta.NETWORK_STATE_CHANGE,((e,t)=>{S.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))})),window&&(window.__ARTC__=on),on}))})(lf)),lf.exports}var hte=ute();const XT=NM(hte);XT.setLogLevel(4);function pte(d){if(!d)return"";const l=Date.now()-new Date(d).getTime(),h=Math.floor(l/6e4);return h<1?"just now":h<60?`${h}m ago`:`${Math.floor(h/60)}h ago`}function mte({session:d,userName:l,isHost:h,onLeave:f,onEnd:y}){const w=K.useRef(null),A=K.useRef(null),P=K.useRef({audio:null,video:null}),[L,U]=K.useState(!1),[M,V]=K.useState(!0),[W,z]=K.useState(!0),[X,$]=K.useState(d.currentViewers??0),[oe,ve]=K.useState("");K.useEffect(()=>{let fe=!1;return(async()=>{try{const Ne=XT.createClient({mode:"live",codec:"vp8"});if(A.current=Ne,await Ne.setClientRole(h?"host":"audience"),await Ne.join(d.appId,d.channelName,h?d.hostToken:d.viewerToken,null),h){const[Ee,Q]=await XT.createMicrophoneAndCameraTracks();if(fe){Ee.close(),Q.close();return}P.current={audio:Ee,video:Q},await Ne.publish([Ee,Q]),w.current&&Q.play(w.current),U(!0)}else Ne.on("user-published",async(Ee,Q)=>{await Ne.subscribe(Ee,Q),Q==="video"&&w.current&&(Ee.videoTrack.play(w.current),U(!0)),Q==="audio"&&Ee.audioTrack.play()}),Ne.on("user-unpublished",()=>U(!1));Ne.on("user-joined",()=>$(Ee=>Ee+1)),Ne.on("user-left",()=>$(Ee=>Math.max(0,Ee-1)))}catch(Ne){fe||ve(Ne.message||"Failed to connect to stream")}})(),()=>{fe=!0;const Ne=P.current;if(Ne.audio)try{Ne.audio.stop(),Ne.audio.close()}catch{}if(Ne.video)try{Ne.video.stop(),Ne.video.close()}catch{}if(A.current){try{A.current.leave()}catch{}A.current=null}}},[]);const Re=async()=>{const fe=P.current.audio;fe&&(await fe.setEnabled(!M),V(Be=>!Be))},pe=async()=>{const fe=P.current.video;fe&&(await fe.setEnabled(!W),z(Be=>!Be))};return E.jsxs("div",{style:{position:"fixed",inset:0,zIndex:1e3,background:"#000",display:"flex",flexDirection:"column"},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"8px 16px",background:"rgba(0,0,0,0.85)",borderBottom:"1px solid rgba(255,255,255,0.1)",flexShrink:0},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:10,color:"#fff",fontSize:14},children:[L?E.jsx("span",{style:{background:"#ff3b30",color:"#fff",fontSize:11,fontWeight:700,padding:"2px 7px",borderRadius:4},children:"LIVE"}):E.jsx("span",{style:{color:"rgba(255,255,255,0.5)",fontSize:11},children:"Connecting"}),E.jsx("span",{style:{fontWeight:600},children:d.title||(h?"Your Stream":`${d.hostName||"Host"}'s Stream`)}),E.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4,color:"rgba(255,255,255,0.6)",fontSize:12},children:[E.jsx(OT,{size:13})," ",X]})]}),E.jsxs("div",{style:{display:"flex",gap:8},children:[h&&E.jsxs(E.Fragment,{children:[E.jsx("button",{onClick:Re,style:$m(M),children:M?E.jsx(hJ,{size:16}):E.jsx(pJ,{size:16})}),E.jsx("button",{onClick:pe,style:$m(W),children:W?E.jsx(Nu,{size:16}):E.jsx(mJ,{size:16})}),E.jsxs("button",{onClick:y,style:$m(!1,"#ff3b30"),children:[E.jsx(LM,{size:16})," End"]})]}),!h&&E.jsxs("button",{onClick:f,style:$m(!1),children:[E.jsx(tv,{size:16})," Leave"]})]})]}),E.jsxs("div",{ref:w,style:{flex:1,width:"100%",overflow:"hidden",background:"#111",display:"flex",alignItems:"center",justifyContent:"center"},children:[oe&&E.jsx("div",{style:{color:"#ff453a",textAlign:"center",padding:40},children:oe}),!L&&!oe&&E.jsxs("div",{style:{color:"rgba(255,255,255,0.5)",textAlign:"center"},children:[E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto 12px",borderColor:"rgba(255,255,255,0.2)",borderTopColor:"#fff"}}),E.jsx("p",{children:h?"Starting your broadcast":"Waiting for host"})]})]})]})}function $m(d,l){return{display:"flex",alignItems:"center",gap:5,padding:"6px 12px",borderRadius:8,border:"none",cursor:"pointer",fontSize:13,fontWeight:600,background:l||(d?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.1)"),color:l||d?"#fff":"rgba(255,255,255,0.8)"}}function fte({onStart:d,onCancel:l}){const[h,f]=K.useState(""),[y,w]=K.useState(!1),[A,P]=K.useState(""),L=async()=>{P(""),w(!0);try{const U=await We.startLiveStream({title:h.trim()||null});d(U)}catch(U){P(U.message||"Failed to start stream"),w(!1)}};return E.jsx("div",{style:{position:"fixed",inset:0,zIndex:900,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",padding:20},children:E.jsxs("div",{className:"card",style:{width:"100%",maxWidth:400,padding:24},children:[E.jsx("div",{style:{fontWeight:700,fontSize:18,marginBottom:16,color:"var(--text)"},children:"Go Live"}),E.jsx("input",{type:"text",value:h,onChange:U=>f(U.target.value),placeholder:"Stream title (optional)",maxLength:100,className:"chat-input",style:{width:"100%",marginBottom:12},onKeyDown:U=>U.key==="Enter"&&L(),autoFocus:!0}),A&&E.jsx("div",{className:"login-error",style:{marginBottom:12},children:A}),E.jsxs("div",{style:{display:"flex",gap:8},children:[E.jsxs("button",{onClick:L,disabled:y,className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6},children:[E.jsx(Rf,{size:15})," ",y?"Starting":"Start Stream"]}),E.jsx("button",{onClick:l,className:"btn-secondary",children:"Cancel"})]})]})})}function _te(){const{user:d}=hr(),[l,h]=K.useState([]),[f,y]=K.useState(!0),[w,A]=K.useState(!1),[P,L]=K.useState(null),[U,M]=K.useState(!1),[V,W]=K.useState(null),[z,X]=K.useState(""),$=K.useCallback(async()=>{try{const fe=await We.getLiveStreams();h(fe.streams||[])}catch{h([])}finally{y(!1)}},[]);K.useEffect(()=>{$();const fe=setInterval($,3e4);return()=>clearInterval(fe)},[$]);const oe=fe=>{A(!1),M(!0),L({...fe,isHost:!0})},ve=async fe=>{W(fe.streamId),X("");try{const Be=await We.joinLiveStream(fe.streamId);M(!1),L({...Be,isHost:!1})}catch(Be){X(Be.message||"Failed to join stream")}finally{W(null)}},Re=K.useCallback(async()=>{P&&We.leaveLiveStream(P.streamId).catch(()=>{}),L(null),$()},[P,$]),pe=K.useCallback(async()=>{P&&We.endLiveStream(P.streamId).catch(()=>{}),L(null),$()},[P,$]);return P?E.jsx(mte,{session:P,userName:d?.firstName||d?.username||"Guest",isHost:U,onLeave:Re,onEnd:pe}):E.jsxs(Gn,{children:[w&&E.jsx(fte,{onStart:oe,onCancel:()=>A(!1)}),E.jsxs("div",{className:"page-header",children:[E.jsx("h2",{className:"page-title",children:"Live"}),E.jsxs("div",{style:{display:"flex",gap:8},children:[E.jsx("button",{onClick:$,className:"btn-secondary",style:{padding:"6px 10px"},title:"Refresh",children:E.jsx(wf,{size:15})}),E.jsxs("button",{onClick:()=>{A(!0),X("")},className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6},children:[E.jsx(xu,{size:16})," Go Live"]})]})]}),z&&E.jsx("div",{className:"login-error",style:{marginBottom:12},children:z}),f?E.jsx("div",{style:{textAlign:"center",padding:40},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):l.length===0?E.jsxs("div",{className:"card",style:{textAlign:"center",padding:40},children:[E.jsx(Rf,{size:36,style:{margin:"0 auto 12px",display:"block",opacity:.3}}),E.jsx("div",{style:{color:"var(--text-muted)",marginBottom:16},children:"No live streams right now."}),E.jsxs("button",{onClick:()=>A(!0),className:"btn-primary",style:{display:"inline-flex",alignItems:"center",gap:6},children:[E.jsx(xu,{size:16})," Be the first to go live"]})]}):E.jsx("div",{style:{display:"flex",flexDirection:"column",gap:10},children:l.map(fe=>E.jsx("div",{className:"card",style:{padding:16},children:E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[E.jsxs("div",{style:{flex:1,minWidth:0},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:8,marginBottom:4},children:[E.jsx("span",{style:{background:"#ff3b30",color:"#fff",fontSize:10,fontWeight:700,padding:"2px 6px",borderRadius:4,flexShrink:0},children:"LIVE"}),E.jsx("span",{style:{fontWeight:600,color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:fe.title||`${fe.hostName}'s Stream`})]}),E.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,fontSize:13,color:"var(--text-muted)"},children:[E.jsxs("span",{style:{display:"flex",alignItems:"center",gap:4},children:[E.jsx(OT,{size:13})," ",fe.currentViewers??0]}),E.jsxs("span",{children:["by ",fe.hostName]}),E.jsxs("span",{style:{display:"flex",alignItems:"center",gap:3},children:[E.jsx(uJ,{size:12})," ",pte(fe.startedAt||fe.createdAt)]})]})]}),E.jsxs("button",{onClick:()=>ve(fe),disabled:V===fe.streamId,className:"btn-primary",style:{display:"flex",alignItems:"center",gap:6,flexShrink:0},children:[E.jsx(OT,{size:14}),V===fe.streamId?"Joining":"Watch"]})]})},fe.streamId))})]})}function gte(){return E.jsxs(Gn,{children:[E.jsx("div",{className:"section-label",children:"Videorama"}),E.jsx("div",{className:"feature-page",children:E.jsx("iframe",{className:"feature-iframe",src:"/videorama",title:"Videorama",allow:"autoplay; fullscreen",sandbox:"allow-scripts allow-same-origin allow-forms allow-popups"})})]})}function Ete(){const[d,l]=K.useState([]),[h,f]=K.useState(!0),[y,w]=K.useState("all"),[A,P]=K.useState(""),[L,U]=K.useState(""),[M,V]=K.useState(null),W=K.useCallback(async()=>{f(!0),U("");try{const oe=await fetch(`/api/media/library?type=${y}&limit=100${A?`&search=${encodeURIComponent(A)}`:""}`,{credentials:"include"});if(!oe.ok)throw new Error("Failed to load media");const ve=await oe.json();l(ve.media||[])}catch(oe){U(oe.message||"Failed to load media library"),l([])}finally{f(!1)}},[y,A]);K.useEffect(()=>{W()},[W]);const z=oe=>{V(oe)},X=()=>{V(null)},$=oe=>oe.type==="video";return M?E.jsx(Gn,{children:E.jsxs("div",{style:{padding:"16px"},children:[E.jsx("button",{onClick:X,style:{marginBottom:"16px",padding:"8px 12px",background:"rgba(255,255,255,0.1)",border:"none",borderRadius:"6px",color:"#fff",cursor:"pointer"},children:" Back"}),$(M)?E.jsx("video",{src:M.file_path||M.url,controls:!0,autoPlay:!0,style:{width:"100%",maxHeight:"70vh",borderRadius:"8px",background:"#000"}}):E.jsx("audio",{src:M.file_path||M.url,controls:!0,autoPlay:!0,style:{width:"100%",marginBottom:"16px"}}),E.jsxs("div",{style:{marginTop:"16px",padding:"16px",background:"rgba(255,255,255,0.05)",borderRadius:"8px"},children:[E.jsx("h3",{style:{margin:"0 0 8px",color:"#fff"},children:M.title||"Untitled"}),M.artist&&E.jsxs("p",{style:{margin:"0 0 4px",color:"rgba(255,255,255,0.7)",fontSize:"14px"},children:["by ",M.artist]}),M.description&&E.jsx("p",{style:{margin:"8px 0 0",color:"rgba(255,255,255,0.6)",fontSize:"13px"},children:M.description})]})]})}):E.jsxs(Gn,{children:[E.jsxs("div",{className:"page-header",children:[E.jsx("h2",{className:"page-title",children:"Media Library"}),E.jsx("button",{onClick:()=>W(),className:"btn-secondary",style:{padding:"6px 10px"},title:"Refresh",children:E.jsx(wf,{size:15})})]}),E.jsxs("div",{style:{padding:"16px",display:"flex",gap:"8px",marginBottom:"12px"},children:[E.jsxs("div",{style:{flex:1,position:"relative"},children:[E.jsx(Af,{size:16,style:{position:"absolute",left:"8px",top:"50%",transform:"translateY(-50%)",color:"rgba(255,255,255,0.5)"}}),E.jsx("input",{type:"text",value:A,onChange:oe=>P(oe.target.value),onKeyDown:oe=>oe.key==="Enter"&&W(),placeholder:"Search media...",className:"chat-input",style:{width:"100%",paddingLeft:"32px"}})]}),E.jsxs("select",{value:y,onChange:oe=>w(oe.target.value),style:{padding:"8px 12px",background:"rgba(255,255,255,0.1)",border:"1px solid rgba(255,255,255,0.2)",borderRadius:"6px",color:"#fff"},children:[E.jsx("option",{value:"all",children:"All"}),E.jsx("option",{value:"audio",children:"Audio"}),E.jsx("option",{value:"video",children:"Video"})]})]}),L&&E.jsx("div",{className:"login-error",style:{marginBottom:"12px"},children:L}),h?E.jsx("div",{style:{textAlign:"center",padding:"40px"},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):d.length===0?E.jsxs("div",{className:"card",style:{textAlign:"center",padding:"40px"},children:[E.jsx(IT,{size:36,style:{margin:"0 auto 12px",display:"block",opacity:.3}}),E.jsx("div",{style:{color:"var(--text-muted)"},children:"No media found"})]}):E.jsx("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(150px, 1fr))",gap:"12px",padding:"12px"},children:d.map(oe=>E.jsxs("div",{onClick:()=>z(oe),style:{cursor:"pointer",borderRadius:"8px",overflow:"hidden",background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.1)",transition:"all 0.2s"},onMouseEnter:ve=>{ve.currentTarget.style.background="rgba(255,255,255,0.1)",ve.currentTarget.style.borderColor="rgba(255,255,255,0.3)"},onMouseLeave:ve=>{ve.currentTarget.style.background="rgba(255,255,255,0.05)",ve.currentTarget.style.borderColor="rgba(255,255,255,0.1)"},children:[E.jsxs("div",{style:{width:"100%",aspectRatio:"1",background:"linear-gradient(135deg, rgba(59,130,246,0.3), rgba(139,92,246,0.3))",display:"flex",alignItems:"center",justifyContent:"center",position:"relative"},children:[$(oe)?E.jsx(IT,{size:32,style:{opacity:.5}}):E.jsx($T,{size:32,style:{opacity:.5}}),E.jsx("div",{style:{position:"absolute",width:"40px",height:"40px",background:"rgba(59,130,246,0.8)",borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center"},children:E.jsx(kM,{size:18,fill:"#fff",style:{marginLeft:"2px"}})})]}),E.jsxs("div",{style:{padding:"8px"},children:[E.jsx("div",{style:{fontWeight:600,fontSize:"12px",color:"#fff",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",marginBottom:"4px"},children:oe.title||"Untitled"}),oe.artist&&E.jsx("div",{style:{fontSize:"11px",color:"rgba(255,255,255,0.6)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:oe.artist})]})]},oe.id))})]})}function Ste(){const[d,l]=K.useState([]),[h,f]=K.useState([]),[y,w]=K.useState(!0),[A,P]=K.useState(""),[L,U]=K.useState("all");K.useEffect(()=>{M()},[]),K.useEffect(()=>{V()},[d,A,L]);async function M(){w(!0);try{const z=await fetch("/api/media/library?type=all&limit=100",{credentials:"include"});if(!z.ok)throw new Error("Failed to load content");const X=await z.json(),oe=(Array.isArray(X)?X:X.data||[]).filter(ve=>ve.is_prime===!0);l(oe)}catch(z){console.error("Error loading prime content:",z),l([])}finally{w(!1)}}function V(){let z=d;if(L!=="all"&&(z=z.filter(X=>X.category===L)),A){const X=A.toLowerCase();z=z.filter($=>$.title&&$.title.toLowerCase().includes(X)||$.artist&&$.artist.toLowerCase().includes(X))}f(z)}const W=["all",...new Set(d.map(z=>z.category).filter(Boolean))];return E.jsxs(Gn,{children:[E.jsx("div",{className:"prime-header",children:E.jsxs("div",{className:"prime-title-section",children:[E.jsx(hf,{size:32,className:"prime-icon"}),E.jsxs("div",{children:[E.jsx("h1",{className:"prime-title",children:"PRIME Content"}),E.jsx("p",{className:"prime-subtitle",children:"Exclusive curated content for premium members"})]})]})}),E.jsxs("div",{className:"prime-controls",children:[E.jsxs("div",{className:"prime-search",children:[E.jsx(Af,{size:18}),E.jsx("input",{type:"text",placeholder:"Search prime content...",value:A,onChange:z=>P(z.target.value),className:"search-input"})]}),E.jsxs("div",{className:"prime-filters",children:[E.jsx(fJ,{size:18}),E.jsx("select",{value:L,onChange:z=>U(z.target.value),className:"filter-select",children:W.map(z=>E.jsx("option",{value:z,children:z==="all"?"All Categories":z.charAt(0).toUpperCase()+z.slice(1)},z))})]})]}),E.jsx("div",{className:"prime-content-section",children:y?E.jsxs("div",{className:"loading-container",children:[E.jsx("div",{className:"loading-spinner"}),E.jsx("p",{children:"Loading premium content..."})]}):h.length>0?E.jsx("div",{className:"prime-grid",children:h.map(z=>E.jsxs("div",{className:"prime-card",children:[E.jsxs("div",{className:"prime-card-image",children:[z.cover_url?E.jsx("img",{src:z.cover_url,alt:z.title}):E.jsx("div",{className:"prime-placeholder",children:E.jsx(d1,{size:48})}),E.jsx("div",{className:"prime-card-overlay",children:E.jsx("button",{className:"play-button",children:E.jsx(kM,{size:24,fill:"white"})})}),E.jsxs("div",{className:"prime-badge",children:[E.jsx(hf,{size:14}),"PRIME"]})]}),E.jsxs("div",{className:"prime-card-info",children:[E.jsx("h3",{className:"prime-card-title",children:z.title||"Untitled"}),E.jsx("p",{className:"prime-card-artist",children:z.artist||"Unknown"}),E.jsx("p",{className:"prime-card-category",children:z.category})]})]},z.id))}):E.jsxs("div",{className:"empty-state",children:[E.jsx(d1,{size:48}),E.jsx("p",{children:"No prime content found"}),E.jsx("span",{className:"empty-subtitle",children:"Check back soon for exclusive content"})]})})]})}function v2({onPosted:d,onError:l}){const{showToast:h}=Ov(),{user:f}=hr(),[y,w]=K.useState(""),[A,P]=K.useState(!1),[L,U]=K.useState(""),[M,V]=K.useState(null),[W,z]=K.useState(null),X=K.useRef(null),$=5e3,oe=pe=>{const fe=pe.target.files?.[0];if(!fe)return;if(!/^image\/(jpeg|jpg|png|webp|gif)$/i.test(fe.type)){const Ee="Los videos estn deshabilitados. Por favor usa YouTube o Vimeo y comparte el enlace.";U(Ee),h(Ee,"warning");return}if(fe.size>10*1024*1024){const Ee="El archivo es demasiado grande (mximo 10MB). Por favor comprime la imagen.";U(Ee),h(Ee,"warning");return}U(""),V(fe);const Ne=new FileReader;Ne.onload=Ee=>z(Ee.target.result),Ne.readAsDataURL(fe)},ve=()=>{V(null),z(null),X.current&&(X.current.value="")},Re=async()=>{if(!(!y.trim()||A)){P(!0),U("");try{if(M){const pe=await We.createPostWithMedia(y.trim(),M);w(""),ve(),d&&d(pe.post),h("Post publicado exitosamente","success")}else{const pe=await We.createPost({content:y.trim()});w(""),d&&d(pe.post),h("Post publicado exitosamente","success")}}catch(pe){const fe=pe.message||"Error al publicar. Por favor intenta de nuevo.";U(fe),h(fe,"error"),console.error("Post creation error:",pe),l?.()}finally{P(!1)}}};return E.jsx("div",{className:"post-composer card",children:E.jsxs("div",{style:{display:"flex",gap:12},children:[E.jsx("div",{className:"post-avatar-placeholder",style:{width:40,height:40,fontSize:16,flexShrink:0},children:(f?.firstName||f?.username||"?")[0].toUpperCase()}),E.jsxs("div",{style:{flex:1},children:[E.jsx("textarea",{value:y,onChange:pe=>w(pe.target.value),placeholder:"Qu est pasando?",maxLength:$,rows:3,className:"composer-textarea"}),L&&E.jsx("div",{style:{color:"#ff453a",fontSize:13,marginBottom:6},children:L}),W&&E.jsx("div",{className:"composer-media-preview",children:E.jsxs("div",{style:{position:"relative",display:"inline-block"},children:[E.jsx("img",{src:W,alt:"Preview",style:{maxHeight:150,maxWidth:"100%",borderRadius:8}}),E.jsx("button",{onClick:ve,style:{position:"absolute",top:4,right:4,background:"rgba(0,0,0,0.7)",border:"none",borderRadius:"50%",padding:4,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},title:"Remove media",children:E.jsx(Cf,{size:14,color:"white"})})]})}),E.jsxs("div",{className:"composer-footer",children:[E.jsxs("div",{style:{display:"flex",gap:8,alignItems:"center"},children:[E.jsx("button",{onClick:()=>X.current?.click(),disabled:A,style:{background:"none",border:"none",color:"var(--accent-pink)",cursor:"pointer",padding:6,display:"flex",alignItems:"center",justifyContent:"center",fontSize:12},title:"Adjuntar imagen",children:E.jsx(_J,{size:16})}),E.jsxs("span",{className:"composer-char-count",style:{color:y.length>$*.9?"#ff453a":"var(--text-muted)"},children:[y.length,"/",$]})]}),E.jsxs("button",{onClick:Re,disabled:!y.trim()||A,className:"btn-primary composer-post-btn",children:[E.jsx(ZT,{size:14}),A?"Publicando...":"Publicar"]})]}),E.jsx("input",{ref:X,type:"file",accept:"image/*,video/*",onChange:oe,style:{display:"none"}})]})]})})}function yte({id:d,type:l="info",message:h,duration:f=5e3,onClose:y}){K.useEffect(()=>{if(f>0){const A=setTimeout(()=>{y?.(d)},f);return()=>clearTimeout(A)}},[d,f,y]);const w={success:E.jsx(EJ,{size:20}),error:E.jsx(cc,{size:20}),warning:E.jsx(xM,{size:20}),info:E.jsx(gJ,{size:20})};return E.jsxs("div",{className:`toast toast-${l}`,role:"alert","aria-live":"assertive",children:[E.jsx("div",{className:"toast-icon",children:w[l]}),E.jsx("div",{className:"toast-content",children:h}),E.jsx("button",{className:"toast-close",onClick:()=>y?.(d),"aria-label":"Cerrar notificacin",children:E.jsx(Cf,{size:16})})]})}function Tte({toasts:d,onClose:l}){return E.jsx("div",{className:"toast-container",role:"region","aria-label":"Notificaciones",children:d.map(h=>E.jsx(yte,{...h,onClose:l},h.id))})}function vte(){const[d,l]=K.useState([]),[h,f]=K.useState(!0),[y,w]=K.useState(null),[A,P]=K.useState(!1),{toasts:L,showToast:U,closeToast:M}=Ov(),V=K.useCallback(async($=null)=>{try{const oe=await We.getFeed($);l($?ve=>[...ve,...oe.posts||[]]:oe.posts||[]),w(oe.nextCursor||null)}catch(oe){console.error("Feed error",oe),U("Error al cargar el feed","error")}},[U]);K.useEffect(()=>{f(!0),V().finally(()=>f(!1))},[V]);const W=$=>{l(oe=>[{...$,liked_by_me:!1,likes_count:0,replies_count:0,reposts_count:0},...oe])},z=$=>{l(oe=>oe.filter(ve=>ve.id!==$))},X=async()=>{!y||A||(P(!0),await V(y),P(!1))};return E.jsxs(Gn,{children:[E.jsx("div",{className:"page-header",children:E.jsx("h2",{className:"page-title",children:"Feed"})}),E.jsx(v2,{onPosted:W,onError:()=>U("Error al publicar","error")}),h?E.jsx("div",{style:{textAlign:"center",padding:32},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):d.length===0?E.jsx("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:"No hay posts an. S el primero en publicar!"}):E.jsxs(E.Fragment,{children:[d.map($=>E.jsx(Nv,{post:$,onDeleted:z,onError:()=>U("Error al procesar la accin","error")},$.id)),y&&E.jsx("button",{onClick:X,disabled:A,className:"btn-secondary",style:{width:"100%",marginTop:12},children:A?"Cargando...":"Cargar ms"})]}),E.jsx(Tte,{toasts:L,onClose:M})]})}function Rte(){const{userId:d}=DM(),{user:l}=hr(),[h,f]=K.useState(null),[y,w]=K.useState([]),[A,P]=K.useState(!0),[L,U]=K.useState(null),[M,V]=K.useState(!1);K.useEffect(()=>{const oe=async()=>{try{const ve=await We.getWall(d);f(ve.profile),w(ve.posts||[]),U(ve.nextCursor||null)}catch{}};P(!0),oe().finally(()=>P(!1))},[d]);const W=oe=>w(ve=>[oe,...ve]),z=oe=>w(ve=>ve.filter(Re=>Re.id!==oe)),X=async()=>{if(!(!L||M)){V(!0);try{const oe=await We.getWall(d,L);w(ve=>[...ve,...oe.posts||[]]),U(oe.nextCursor||null)}catch{}V(!1)}};if(A)return E.jsx(Gn,{children:E.jsx("div",{style:{textAlign:"center",padding:32},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})})});if(!h)return E.jsx(Gn,{children:E.jsx("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:"User not found."})});const $=l?.id===d;return E.jsxs(Gn,{children:[E.jsxs("div",{className:"card wall-profile-card",children:[E.jsx("div",{className:"wall-profile-avatar",children:E.jsx("div",{className:"post-avatar-placeholder wall-avatar-big",children:(h.first_name||h.username||"?")[0].toUpperCase()})}),E.jsxs("div",{className:"wall-profile-info",children:[E.jsxs("div",{className:"wall-profile-name",children:[h.first_name," ",h.last_name||""]}),h.username&&E.jsxs("div",{className:"wall-profile-handle",children:["@",h.username]}),h.pnptv_id&&E.jsxs("div",{className:"wall-profile-id",children:["ID: ",h.pnptv_id]}),h.bio&&E.jsx("div",{className:"wall-profile-bio",children:h.bio})]}),!$&&E.jsxs(pn,{to:`/messages/${d}`,className:"btn-secondary wall-dm-btn",children:[E.jsx(vf,{size:16})," DM"]})]}),$&&E.jsx(v2,{onPosted:W}),y.length===0?E.jsx("div",{className:"card",style:{textAlign:"center",padding:24,color:"var(--text-muted)"},children:"No posts yet."}):y.map(oe=>E.jsx(Nv,{post:oe,onDeleted:z},oe.id)),L&&E.jsx("div",{style:{textAlign:"center",padding:"12px 0"},children:E.jsx("button",{className:"btn-secondary",onClick:X,disabled:M,children:M?"Loading":"Load more"})})]})}function Cte(d){if(!d)return"";const l=Date.now()-new Date(d).getTime(),h=Math.floor(l/6e4);if(h<1)return"now";if(h<60)return`${h}m`;const f=Math.floor(h/60);return f<24?`${f}h`:`${Math.floor(f/24)}d`}function bte(){const[d,l]=K.useState([]),[h,f]=K.useState(!0),[y,w]=K.useState(""),[A,P]=K.useState([]),[L,U]=K.useState(!1);K.useEffect(()=>{We.getDMThreads().then(V=>l(V.threads||[])).catch(()=>{}).finally(()=>f(!1))},[]);const M=async V=>{if(w(V),!V.trim()){P([]);return}U(!0);try{const W=await We.searchUsers(V);P(W.users||[])}catch{}finally{U(!1)}};return E.jsxs(Gn,{children:[E.jsx("div",{className:"page-header",children:E.jsx("h2",{className:"page-title",children:"Messages"})}),E.jsx("div",{className:"card",style:{padding:"12px 16px",marginBottom:12},children:E.jsx("input",{type:"text",value:y,onChange:V=>M(V.target.value),placeholder:"Search users to message...",className:"chat-input",style:{width:"100%"}})}),y.trim()?E.jsx("div",{className:"card",children:L?E.jsx("div",{style:{padding:16,textAlign:"center",color:"var(--text-muted)"},children:"Searching..."}):A.length===0?E.jsx("div",{style:{padding:16,textAlign:"center",color:"var(--text-muted)"},children:"No users found"}):A.map(V=>E.jsxs(pn,{to:`/messages/${V.id}`,className:"thread-item",style:{textDecoration:"none"},children:[E.jsx("div",{className:"thread-avatar",children:E.jsx("div",{className:"post-avatar-placeholder",children:(V.first_name||V.username||"?")[0].toUpperCase()})}),E.jsxs("div",{className:"thread-info",children:[E.jsxs("div",{className:"thread-name",children:[V.first_name," ",V.last_name||""]}),E.jsxs("div",{className:"thread-preview",children:["@",V.username||V.pnptv_id]})]})]},V.id))}):h?E.jsx("div",{style:{textAlign:"center",padding:32},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):d.length===0?E.jsx("div",{className:"card",style:{textAlign:"center",padding:32,color:"var(--text-muted)"},children:"No conversations yet. Search for users to start chatting."}):E.jsx("div",{className:"card",children:d.map(V=>E.jsxs(pn,{to:`/messages/${V.partner_id}`,className:"thread-item",style:{textDecoration:"none"},children:[E.jsx("div",{className:"thread-avatar",children:E.jsx("div",{className:"post-avatar-placeholder",children:(V.partner_first_name||V.partner_username||"?")[0].toUpperCase()})}),E.jsxs("div",{className:"thread-info",children:[E.jsxs("div",{className:"thread-name",children:[V.partner_first_name," ",E.jsxs("span",{className:"post-author-handle",children:["@",V.partner_username]})]}),E.jsx("div",{className:"thread-preview",children:V.last_message||""})]}),E.jsxs("div",{className:"thread-meta",children:[E.jsx("div",{className:"thread-time",children:Cte(V.last_message_at)}),V.unread>0&&E.jsx("div",{className:"thread-unread",children:V.unread})]})]},V.partner_id))})]})}function wte(d){const l=Date.now()-new Date(d).getTime(),h=Math.floor(l/6e4);if(h<1)return"now";if(h<60)return`${h}m`;const f=Math.floor(h/60);return f<24?`${f}h`:`${Math.floor(f/24)}d`}function Ate(){const{partnerId:d}=DM(),{user:l}=hr(),[h,f]=K.useState(null),[y,w]=K.useState([]),[A,P]=K.useState(""),L=K.useRef(null),U=K.useCallback($=>{($.sender_id===d||$.sender?.id===d)&&w(oe=>[...oe,$])},[d]),{sendDM:M,sendTyping:V,connected:W}=zee(U);K.useEffect(()=>{Promise.all([We.getDMPartnerInfo(d),We.getConversation(d)]).then(([$,oe])=>{f($.user),w(oe.messages||[])}).catch(()=>{})},[d]),K.useEffect(()=>{L.current?.scrollIntoView({behavior:"smooth"})},[y]);const z=async()=>{const $=A.trim();if($)if(w(oe=>[...oe,{id:`tmp-${Date.now()}`,sender_id:l.id,recipient_id:d,content:$,created_at:new Date().toISOString()}]),P(""),W)M(d,$);else try{await We.sendDMRest(d,$)}catch{}},X=$=>{$.key==="Enter"&&!$.shiftKey?($.preventDefault(),z()):V(d)};return E.jsxs(Gn,{children:[E.jsxs("div",{className:"conv-header",children:[E.jsx(pn,{to:"/messages",className:"conv-back-btn",children:E.jsx(SJ,{size:20})}),E.jsxs("div",{className:"conv-partner-name",children:[h?h.first_name||h.username:"Loading...",h?.username&&E.jsxs("span",{className:"post-author-handle",children:[" @",h.username]})]})]}),E.jsxs("div",{className:"conv-messages",children:[y.map(($,oe)=>E.jsxs("div",{className:`dm-message ${$.sender_id===l?.id?"own":"other"}`,children:[E.jsx("div",{className:"dm-bubble",children:$.content}),E.jsx("div",{className:"dm-time",children:wte($.created_at)})]},$.id||oe)),E.jsx("div",{ref:L})]}),E.jsxs("div",{className:"conv-input-row",children:[E.jsx("input",{type:"text",value:A,onChange:$=>P($.target.value),onKeyDown:X,placeholder:"Message...",maxLength:2e3,className:"chat-input",style:{flex:1}}),E.jsx("button",{onClick:z,disabled:!A.trim(),className:"chat-send-btn",children:E.jsx(ZT,{size:16})})]})]})}function Ite(){const[d,l]=K.useState(null),[h,f]=K.useState(!0),[y,w]=K.useState("");if(K.useEffect(()=>{let U=!1;return We.getAdminStats().then(M=>{U||l(M.stats)}).catch(M=>{U||w(M.message||"Failed to load stats")}).finally(()=>{U||f(!1)}),()=>{U=!0}},[]),h)return E.jsx(Gn,{children:E.jsxs("div",{style:{textAlign:"center",padding:48},children:[E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}}),E.jsx("p",{style:{marginTop:12,color:"var(--text-muted)"},children:"Loading admin dashboard..."})]})});if(y)return E.jsx(Gn,{children:E.jsxs("div",{className:"card",style:{padding:24,color:"#ff453a"},children:[E.jsx(cc,{size:24,style:{display:"inline",marginRight:8}}),y]})});const A=d?.payments||{},P=d?.revenue?.monthly||{},L=d?.membership?.totals||{};return E.jsx(Gn,{children:E.jsxs("div",{style:{marginBottom:32},children:[E.jsx("h1",{style:{fontSize:24,marginBottom:24},children:"Admin Dashboard"}),E.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:16,marginBottom:32},children:[E.jsx("div",{className:"card",style:{padding:16},children:E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[E.jsxs("div",{children:[E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:4},children:"Total Users"}),E.jsx("div",{style:{fontSize:20,fontWeight:"700"},children:L.total_active_users||0})]}),E.jsx(ac,{size:32,style:{color:"var(--accent)",opacity:.5}})]})}),E.jsx("div",{className:"card",style:{padding:16},children:E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[E.jsxs("div",{children:[E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:4},children:"Active Subscribers"}),E.jsx("div",{style:{fontSize:20,fontWeight:"700"},children:L.active_subscribers||0})]}),E.jsx(yJ,{size:32,style:{color:"#34C759",opacity:.5}})]})}),E.jsx("div",{className:"card",style:{padding:16},children:E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[E.jsxs("div",{children:[E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:4},children:"Monthly Revenue"}),E.jsxs("div",{style:{fontSize:20,fontWeight:"700"},children:["$",(P.monthly_revenue||0).toFixed(0)]})]}),E.jsx(TJ,{size:32,style:{color:"#FF9500",opacity:.5}})]})}),E.jsx("div",{className:"card",style:{padding:16},children:E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[E.jsxs("div",{children:[E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:4},children:"Churned"}),E.jsx("div",{style:{fontSize:20,fontWeight:"700"},children:L.churned_users||0})]}),E.jsx(cc,{size:32,style:{color:"#FF453A",opacity:.5}})]})})]}),E.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:12,marginBottom:32},children:[E.jsxs(pn,{to:"/admin/users",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[E.jsx("span",{style:{fontWeight:"600"},children:"Manage Users"}),E.jsx(ac,{size:20,style:{color:"var(--accent)"}})]}),E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"Search, ban, edit users"})]}),E.jsxs(pn,{to:"/admin/posts",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[E.jsx("span",{style:{fontWeight:"600"},children:"Moderate Posts"}),E.jsx(cc,{size:20,style:{color:"#FF9500"}})]}),E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"Delete inappropriate content"})]}),E.jsxs(pn,{to:"/admin/hangouts",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[E.jsx("span",{style:{fontWeight:"600"},children:"Manage Hangouts"}),E.jsx(ac,{size:20,style:{color:"#34C759"}})]}),E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"View and end rooms"})]}),E.jsxs(pn,{to:"/admin/media",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[E.jsx("span",{style:{fontWeight:"600"},children:"Manage Media"}),E.jsx($T,{size:20,style:{color:"#5E6BFF"}})]}),E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"Upload, edit, delete media"})]}),E.jsxs(pn,{to:"/admin/radio",className:"card",style:{padding:16,textDecoration:"none",color:"inherit"},children:[E.jsxs("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[E.jsx("span",{style:{fontWeight:"600"},children:"Radio Control"}),E.jsx(Rf,{size:20,style:{color:"#FF6B9D"}})]}),E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:"Now playing, queue, requests"})]})]}),d?.payments&&E.jsxs("div",{className:"card",style:{padding:16},children:[E.jsx("h3",{style:{fontSize:14,fontWeight:"600",marginBottom:12},children:"Payment Stats"}),E.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(140px, 1fr))",gap:12},children:[E.jsxs("div",{children:[E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Total Payments"}),E.jsx("div",{style:{fontSize:18,fontWeight:"700"},children:A.total_payments||0})]}),E.jsxs("div",{children:[E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Completed"}),E.jsx("div",{style:{fontSize:18,fontWeight:"700",color:"#34C759"},children:A.completed||0})]}),E.jsxs("div",{children:[E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Failed"}),E.jsx("div",{style:{fontSize:18,fontWeight:"700",color:"#FF453A"},children:A.failed||0})]}),E.jsxs("div",{children:[E.jsx("div",{style:{fontSize:12,color:"var(--text-muted)"},children:"Avg Transaction"}),E.jsxs("div",{style:{fontSize:18,fontWeight:"700"},children:["$",(A.avg_transaction||0).toFixed(2)]})]})]})]})]})})}function Ote(){const[d,l]=K.useState([]),[h,f]=K.useState(!0),[y,w]=K.useState(""),[A,P]=K.useState(""),[L,U]=K.useState(1),[M,V]=K.useState({total:0,totalPages:0}),[W,z]=K.useState(null),[X,$]=K.useState(!1),[oe,ve]=K.useState({}),[Re,pe]=K.useState(!1),fe=(Q=1)=>{f(!0),w(""),We.listAdminUsers(Q,A).then(je=>{l(je.users||[]),V(je.pagination||{}),U(Q)}).catch(je=>w(je.message||"Failed to load users")).finally(()=>f(!1))};K.useEffect(()=>{fe(1)},[A]);const Be=Q=>{z(Q),ve({username:Q.username,email:Q.email,subscriptionStatus:Q.subscription_status}),$(!0)},Ne=async()=>{pe(!0);try{await We.updateAdminUser(W.id,oe),$(!1),fe(L)}catch(Q){w(Q.message||"Failed to save user")}finally{pe(!1)}},Ee=async(Q,je)=>{if(confirm(`Are you sure you want to ${je?"ban":"unban"} this user?`))try{await We.banAdminUser(Q,je,"Admin action"),fe(L)}catch(Tt){w(Tt.message||"Failed to ban user")}};return E.jsxs(Gn,{children:[E.jsxs("div",{style:{marginBottom:32},children:[E.jsx("h1",{style:{fontSize:24,marginBottom:24},children:"User Management"}),E.jsx("div",{style:{marginBottom:24},children:E.jsxs("div",{style:{position:"relative",marginBottom:16},children:[E.jsx(Af,{size:18,style:{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",color:"var(--text-muted)"}}),E.jsx("input",{type:"text",placeholder:"Search users by username, email...",value:A,onChange:Q=>P(Q.target.value),style:{width:"100%",paddingLeft:40,paddingRight:16,paddingTop:12,paddingBottom:12,border:"1px solid var(--border-subtle)",borderRadius:"var(--radius-md)",backgroundColor:"var(--surface-2)",color:"var(--text-primary)",fontSize:14}})]})}),y&&E.jsxs("div",{className:"card",style:{padding:16,marginBottom:24,color:"#ff453a"},children:[E.jsx(cc,{size:18,style:{display:"inline",marginRight:8}}),y]}),h?E.jsx("div",{style:{textAlign:"center",padding:48},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):d.length===0?E.jsx("div",{className:"card",style:{padding:24,textAlign:"center",color:"var(--text-muted)"},children:"No users found"}):E.jsxs(E.Fragment,{children:[E.jsx("div",{className:"card",style:{overflow:"x-auto"},children:E.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",fontSize:13},children:[E.jsx("thead",{children:E.jsxs("tr",{style:{borderBottom:"1px solid var(--border-subtle)"},children:[E.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Username"}),E.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Email"}),E.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Role"}),E.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Status"}),E.jsx("th",{style:{padding:12,textAlign:"left",color:"var(--text-muted)",fontWeight:"600"},children:"Sub Status"}),E.jsx("th",{style:{padding:12,textAlign:"center",color:"var(--text-muted)",fontWeight:"600"},children:"Actions"})]})}),E.jsx("tbody",{children:d.map(Q=>E.jsxs("tr",{style:{borderBottom:"1px solid var(--border-subtle)"},children:[E.jsx("td",{style:{padding:12},children:Q.username}),E.jsx("td",{style:{padding:12,fontSize:12,color:"var(--text-muted)"},children:Q.email}),E.jsx("td",{style:{padding:12},children:E.jsx("span",{style:{fontSize:11,backgroundColor:"var(--surface-2)",padding:"4px 8px",borderRadius:4},children:Q.role||"user"})}),E.jsx("td",{style:{padding:12},children:Q.status||"active"}),E.jsx("td",{style:{padding:12},children:Q.subscription_status||"free"}),E.jsxs("td",{style:{padding:12,display:"flex",gap:8,justifyContent:"center"},children:[E.jsx("button",{onClick:()=>Be(Q),style:{background:"none",border:"none",color:"var(--accent)",cursor:"pointer",padding:4,display:"flex",alignItems:"center",gap:4},title:"Edit user",children:E.jsx(ev,{size:14})}),E.jsx("button",{onClick:()=>Ee(Q.id,Q.status!=="banned"),style:{background:"none",border:"none",color:Q.status==="banned"?"#34C759":"#FF453A",cursor:"pointer",padding:4,display:"flex",alignItems:"center",gap:4},title:Q.status==="banned"?"Unban user":"Ban user",children:E.jsx(vJ,{size:14})})]})]},Q.id))})]})}),M.totalPages>1&&E.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginTop:24},children:Array.from({length:M.totalPages},(Q,je)=>je+1).map(Q=>E.jsx("button",{onClick:()=>fe(Q),style:{padding:"8px 12px",border:L===Q?"1px solid var(--accent)":"1px solid var(--border-subtle)",backgroundColor:L===Q?"var(--accent)":"transparent",color:L===Q?"#fff":"var(--text-primary)",borderRadius:4,cursor:"pointer",fontSize:12},children:Q},Q))})]})]}),X&&W&&E.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},children:E.jsxs("div",{className:"card",style:{padding:24,maxWidth:400,width:"90%"},children:[E.jsx("h2",{style:{fontSize:18,marginBottom:16},children:"Edit User"}),E.jsxs("div",{style:{marginBottom:12},children:[E.jsx("label",{style:{fontSize:12,color:"var(--text-muted)",display:"block",marginBottom:4},children:"Username"}),E.jsx("input",{type:"text",value:oe.username,onChange:Q=>ve({...oe,username:Q.target.value}),className:"profile-edit-input"})]}),E.jsxs("div",{style:{marginBottom:12},children:[E.jsx("label",{style:{fontSize:12,color:"var(--text-muted)",display:"block",marginBottom:4},children:"Email"}),E.jsx("input",{type:"email",value:oe.email,onChange:Q=>ve({...oe,email:Q.target.value}),className:"profile-edit-input"})]}),E.jsxs("div",{style:{marginBottom:16},children:[E.jsx("label",{style:{fontSize:12,color:"var(--text-muted)",display:"block",marginBottom:4},children:"Subscription Status"}),E.jsxs("select",{value:oe.subscriptionStatus||"",onChange:Q=>ve({...oe,subscriptionStatus:Q.target.value}),className:"profile-edit-input",children:[E.jsx("option",{value:"free",children:"Free"}),E.jsx("option",{value:"active",children:"Active"}),E.jsx("option",{value:"expired",children:"Expired"}),E.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),E.jsxs("div",{style:{display:"flex",gap:8},children:[E.jsx("button",{onClick:()=>$(!1),className:"btn-secondary",style:{flex:1},disabled:Re,children:"Cancel"}),E.jsx("button",{onClick:Ne,className:"btn-primary",style:{flex:1},disabled:Re,children:Re?"Saving...":"Save"})]})]})})]})}function Nte(){const[d,l]=K.useState([]),[h,f]=K.useState(!0),[y,w]=K.useState(""),[A,P]=K.useState(1),[L,U]=K.useState({total:0,totalPages:0}),M=(W=1)=>{f(!0),We.listAdminPosts(W).then(z=>{l(z.posts||[]),U(z.pagination||{}),P(W)}).catch(z=>w(z.message||"Failed to load posts")).finally(()=>f(!1))};K.useEffect(()=>{M(1)},[]);const V=async W=>{if(confirm("Delete this post?"))try{await We.deleteAdminPost(W),M(A)}catch(z){w(z.message||"Failed to delete post")}};return E.jsx(Gn,{children:E.jsxs("div",{style:{marginBottom:32},children:[E.jsx("h1",{style:{fontSize:24,marginBottom:24},children:"Moderate Posts"}),y&&E.jsxs("div",{className:"card",style:{padding:16,marginBottom:24,color:"#ff453a"},children:[E.jsx(cc,{size:18,style:{display:"inline",marginRight:8}}),y]}),h?E.jsx("div",{style:{textAlign:"center",padding:48},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):d.length===0?E.jsx("div",{className:"card",style:{padding:24,textAlign:"center",color:"var(--text-muted)"},children:"No posts to moderate"}):E.jsxs(E.Fragment,{children:[d.map(W=>E.jsxs("div",{className:"card",style:{padding:16,marginBottom:12},children:[E.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"start",marginBottom:8},children:[E.jsxs("div",{children:[E.jsx("div",{style:{fontWeight:"600",marginBottom:4},children:W.username}),E.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)"},children:[new Date(W.created_at).toLocaleDateString()," ",new Date(W.created_at).toLocaleTimeString()]})]}),E.jsx("button",{onClick:()=>V(W.id),style:{background:"none",border:"none",color:"#FF453A",cursor:"pointer",padding:8},title:"Delete post",children:E.jsx(bf,{size:18})})]}),E.jsxs("div",{style:{color:"var(--text-primary)",lineHeight:1.5,wordBreak:"break-word"},children:[W.content.substring(0,300),W.content.length>300?"...":""]}),E.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",marginTop:8},children:[" ",W.likes||0,"   ",W.replies||0]})]},W.id)),L.totalPages>1&&E.jsx("div",{style:{display:"flex",gap:8,justifyContent:"center",marginTop:24},children:Array.from({length:L.totalPages},(W,z)=>z+1).map(W=>E.jsx("button",{onClick:()=>M(W),style:{padding:"8px 12px",border:A===W?"1px solid var(--accent)":"1px solid var(--border-subtle)",backgroundColor:A===W?"var(--accent)":"transparent",color:A===W?"#fff":"var(--text-primary)",borderRadius:4,cursor:"pointer",fontSize:12},children:W},W))})]})]})})}function Dte(){const[d,l]=K.useState([]),[h,f]=K.useState(!0),[y,w]=K.useState(""),A=()=>{f(!0),We.listAdminHangouts().then(L=>l(L.hangouts||[])).catch(L=>w(L.message||"Failed to load hangouts")).finally(()=>f(!1))};K.useEffect(()=>{A();const L=setInterval(A,1e4);return()=>clearInterval(L)},[]);const P=async L=>{if(confirm("End this hangout room?"))try{await We.endAdminHangout(L),A()}catch(U){w(U.message||"Failed to end hangout")}};return E.jsx(Gn,{children:E.jsxs("div",{style:{marginBottom:32},children:[E.jsx("h1",{style:{fontSize:24,marginBottom:24},children:"Manage Hangouts"}),y&&E.jsxs("div",{className:"card",style:{padding:16,marginBottom:24,color:"#ff453a"},children:[E.jsx(cc,{size:18,style:{display:"inline",marginRight:8}}),y]}),h?E.jsx("div",{style:{textAlign:"center",padding:48},children:E.jsx("div",{className:"loading-spinner",style:{margin:"0 auto"}})}):d.length===0?E.jsx("div",{className:"card",style:{padding:24,textAlign:"center",color:"var(--text-muted)"},children:"No active hangout rooms"}):E.jsx(E.Fragment,{children:d.map(L=>E.jsx("div",{className:"card",style:{padding:16,marginBottom:12},children:E.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"start",marginBottom:8},children:[E.jsxs("div",{style:{flex:1},children:[E.jsx("div",{style:{fontWeight:"600",fontSize:14,marginBottom:4},children:L.title||"Untitled Room"}),E.jsxs("div",{style:{fontSize:12,color:"var(--text-muted)",marginBottom:8},children:["Created by: ",L.creatorName]}),E.jsxs("div",{style:{display:"flex",gap:16,fontSize:12},children:[E.jsxs("div",{children:[E.jsx(ac,{size:14,style:{display:"inline",marginRight:4}}),L.currentParticipants," / ",L.maxParticipants," participants"]}),E.jsx("div",{children:L.isPublic?" Public":" Private"}),E.jsxs("div",{style:{color:"var(--text-muted)"},children:["Created: ",new Date(L.createdAt).toLocaleDateString()]})]})]}),E.jsxs("button",{onClick:()=>P(L.id),style:{background:"none",border:"none",color:"#FF453A",cursor:"pointer",padding:8,display:"flex",alignItems:"center",gap:6,fontSize:12},title:"End hangout",children:[E.jsx(RJ,{size:18}),"End Room"]})]})},L.id))})]})})}function R2({children:d}){const{user:l,loading:h}=hr();return h?E.jsxs("div",{className:"loading-screen",children:[E.jsx("div",{className:"loading-spinner"}),E.jsx("p",{children:"Loading..."})]}):l?["admin","superadmin"].includes(l.role)?d:E.jsx(QT,{to:"/",replace:!0}):(window.location.replace("/"),null)}function Pte(){const[d,l]=K.useState([]),[h,f]=K.useState([]),[y,w]=K.useState(!1),[A,P]=K.useState(1),[L,U]=K.useState(0),[M,V]=K.useState("all"),[W,z]=K.useState(""),[X,$]=K.useState(""),[oe,ve]=K.useState(!1),[Re,pe]=K.useState(null),[fe,Be]=K.useState({}),Ne=20;K.useEffect(()=>{Ee(),Q()},[A,M,W,X]);const Ee=async()=>{w(!0);try{const ze=new URLSearchParams({page:A.toString(),limit:Ne.toString(),type:M,...W&&{category:W},...X&&{search:X}}),qe=await We.getAdminMedia(`?${ze}`);l(qe.media||[]),U(qe.pagination?.total||0)}catch(ze){console.error("Failed to load media:",ze),alert("Failed to load media library")}finally{w(!1)}},Q=async()=>{try{const ze=await We.getAdminMediaCategories();f(ze.categories||[])}catch(ze){console.error("Failed to load categories:",ze)}},je=async ze=>{if(confirm("Are you sure you want to delete this media?"))try{await We.deleteAdminMedia(ze),l(d.filter(qe=>qe.id!==ze))}catch(qe){console.error("Failed to delete media:",qe),alert("Failed to delete media")}},Tt=ze=>{pe(ze.id),Be({title:ze.title,artist:ze.artist,description:ze.description,category:ze.category,isExplicit:ze.is_explicit})},et=async ze=>{try{const qe=await We.updateAdminMedia(ze,fe);l(d.map($n=>$n.id===ze?qe.media:$n)),pe(null)}catch(qe){console.error("Failed to update media:",qe),alert("Failed to update media")}},kt=async ze=>{const qe=ze.target.files?.[0];if(!qe)return;const $n=new FormData;$n.append("file",qe),$n.append("title",prompt("Enter media title:")||qe.name),$n.append("artist",prompt("Enter artist/uploader:")||"Unknown"),$n.append("category",W||"general"),$n.append("type",qe.type.startsWith("video/")?"video":"audio");try{w(!0);const mn=await We.uploadAdminMedia($n);l([mn.media,...d]),ve(!1)}catch(mn){console.error("Failed to upload media:",mn),alert("Failed to upload media")}finally{w(!1)}};return E.jsx(R2,{children:E.jsxs("div",{className:"admin-page",children:[E.jsxs("div",{className:"admin-header",children:[E.jsx("h1",{children:"Media Management"}),E.jsxs("button",{className:"btn btn-primary",onClick:()=>ve(!oe),disabled:y,children:[E.jsx(CJ,{size:16}),"Upload Media"]})]}),oe&&E.jsxs("div",{className:"card",style:{marginBottom:"20px"},children:[E.jsx("h3",{children:"Upload Media"}),E.jsx("input",{type:"file",accept:"audio/*,video/*",onChange:kt,disabled:y,style:{marginBottom:"10px"}})]}),E.jsxs("div",{className:"filters",children:[E.jsxs("select",{value:M,onChange:ze=>{V(ze.target.value),P(1)},children:[E.jsx("option",{value:"all",children:"All Types"}),E.jsx("option",{value:"audio",children:"Audio"}),E.jsx("option",{value:"video",children:"Video"})]}),E.jsxs("select",{value:W,onChange:ze=>{z(ze.target.value),P(1)},children:[E.jsx("option",{value:"",children:"All Categories"}),h.map(ze=>E.jsx("option",{value:ze,children:ze},ze))]}),E.jsx("input",{type:"text",placeholder:"Search media...",value:X,onChange:ze=>{$(ze.target.value),P(1)}})]}),E.jsx("div",{className:"media-grid",children:y?E.jsx("p",{children:"Loading..."}):d.length===0?E.jsx("p",{children:"No media found"}):d.map(ze=>E.jsx("div",{className:"media-card",children:Re===ze.id?E.jsxs("div",{className:"edit-form",children:[E.jsx("input",{type:"text",value:fe.title,onChange:qe=>Be({...fe,title:qe.target.value}),placeholder:"Title"}),E.jsx("input",{type:"text",value:fe.artist,onChange:qe=>Be({...fe,artist:qe.target.value}),placeholder:"Artist"}),E.jsx("textarea",{value:fe.description||"",onChange:qe=>Be({...fe,description:qe.target.value}),placeholder:"Description"}),E.jsx("select",{value:fe.category,onChange:qe=>Be({...fe,category:qe.target.value}),children:h.map(qe=>E.jsx("option",{value:qe,children:qe},qe))}),E.jsxs("label",{children:[E.jsx("input",{type:"checkbox",checked:fe.isExplicit,onChange:qe=>Be({...fe,isExplicit:qe.target.checked})}),"Explicit Content"]}),E.jsxs("div",{className:"button-group",children:[E.jsx("button",{onClick:()=>et(ze.id),className:"btn btn-success",children:"Save"}),E.jsx("button",{onClick:()=>pe(null),className:"btn btn-secondary",children:"Cancel"})]})]}):E.jsxs(E.Fragment,{children:[ze.cover_url&&E.jsx("img",{src:ze.cover_url,alt:ze.title,className:"media-cover"}),E.jsxs("div",{className:"media-info",children:[E.jsx("h4",{children:ze.title}),E.jsx("p",{className:"artist",children:ze.artist}),E.jsxs("p",{className:"meta",children:[ze.type.toUpperCase(),"  ",ze.category,"  ",ze.duration||0,"s"]}),ze.is_explicit&&E.jsx("span",{className:"badge-explicit",children:"Explicit"})]}),E.jsxs("div",{className:"media-actions",children:[E.jsx("button",{onClick:()=>Tt(ze),className:"btn btn-small",title:"Edit",children:E.jsx(ev,{size:16})}),E.jsx("button",{onClick:()=>je(ze.id),className:"btn btn-small btn-danger",title:"Delete",children:E.jsx(bf,{size:16})})]})]})},ze.id))}),E.jsxs("div",{className:"pagination",children:[E.jsx("button",{onClick:()=>P(Math.max(1,A-1)),disabled:A===1,children:"Previous"}),E.jsxs("span",{children:["Page ",A," of ",Math.ceil(L/Ne)]}),E.jsx("button",{onClick:()=>P(A+1),disabled:A>=Math.ceil(L/Ne),children:"Next"})]}),E.jsx("style",{jsx:!0,children:`
          .admin-page {
            padding: 20px;
          }
          .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          }
          .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
          }
          .filters select,
          .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
          }
          .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
          }
          .media-card {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
            background: white;
          }
          .media-cover {
            width: 100%;
            height: 150px;
            object-fit: cover;
          }
          .media-info {
            padding: 12px;
          }
          .media-info h4 {
            margin: 0 0 4px;
            font-size: 14px;
            font-weight: 600;
          }
          .artist {
            margin: 0 0 8px;
            font-size: 12px;
            color: #666;
          }
          .meta {
            margin: 0;
            font-size: 11px;
            color: #999;
          }
          .badge-explicit {
            display: inline-block;
            background: #ff6b6b;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 4px;
          }
          .media-actions {
            display: flex;
            gap: 5px;
            padding: 8px;
            border-top: 1px solid #eee;
          }
          .edit-form {
            padding: 12px;
          }
          .edit-form input,
          .edit-form textarea,
          .edit-form select {
            width: 100%;
            padding: 8px;
            margin-bottom: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
          }
          .button-group {
            display: flex;
            gap: 8px;
            margin-top: 8px;
          }
          .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
          }
          .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
          }
          .btn-primary {
            background: #0070f3;
            color: white;
          }
          .btn-small {
            padding: 6px 8px;
            font-size: 11px;
          }
          .btn-danger {
            background: #ff6b6b;
            color: white;
          }
          .card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            background: white;
          }
        `})]})})}function Lte(){const[d,l]=K.useState(null),[h,f]=K.useState([]),[y,w]=K.useState([]),[A,P]=K.useState([]),[L,U]=K.useState("now-playing"),[M,V]=K.useState(!1),[W,z]=K.useState(!1),[X,$]=K.useState("");K.useEffect(()=>{oe()},[]);const oe=async()=>{V(!0);try{const[Q,je,Tt]=await Promise.all([We.getAdminRadioNowPlaying(),We.getAdminRadioQueue(),We.getAdminRadioRequests()]);l(Q.nowPlaying),f(je.queue||[]),w(Tt.requests||[])}catch(Q){console.error("Failed to load radio data:",Q),alert("Failed to load radio data")}finally{V(!1)}},ve=async()=>{try{const Q=await We.getAdminMedia("?limit=50&type=audio");P(Q.media||[])}catch(Q){console.error("Failed to load media:",Q)}},Re=async Q=>{try{const je=await We.setAdminRadioNowPlaying({mediaId:Q});l(je.nowPlaying),z(!1)}catch(je){console.error("Failed to set now playing:",je),alert("Failed to set now playing")}},pe=async Q=>{try{const je=await We.addAdminRadioQueue({mediaId:Q});f([...h,je.queueItem])}catch(je){console.error("Failed to add to queue:",je),alert("Failed to add to queue")}},fe=async Q=>{try{await We.removeAdminRadioQueue(Q),f(h.filter(je=>je.id!==Q))}catch(je){console.error("Failed to remove from queue:",je),alert("Failed to remove from queue")}},Be=async()=>{if(confirm("Clear entire queue?"))try{await We.clearAdminRadioQueue(),f([])}catch(Q){console.error("Failed to clear queue:",Q),alert("Failed to clear queue")}},Ne=async(Q,je)=>{try{await We.updateAdminRadioRequest(Q,{status:je}),w(y.map(Tt=>Tt.id===Q?{...Tt,status:je}:Tt))}catch(Tt){console.error("Failed to update request:",Tt),alert("Failed to update request")}},Ee=A.filter(Q=>Q.title.toLowerCase().includes(X.toLowerCase())||Q.artist.toLowerCase().includes(X.toLowerCase()));return E.jsx(R2,{children:E.jsxs("div",{className:"admin-page",children:[E.jsxs("div",{className:"admin-header",children:[E.jsx("h1",{children:"Radio Management"}),E.jsx("button",{onClick:oe,disabled:M,className:"btn btn-secondary",children:"Refresh"})]}),E.jsx("div",{className:"tabs",children:["now-playing","queue","requests"].map(Q=>E.jsxs("button",{className:`tab-button ${L===Q?"active":""}`,onClick:()=>U(Q),children:[Q==="now-playing"&&"Now Playing",Q==="queue"&&"Queue",Q==="requests"&&"Requests"]},Q))}),L==="now-playing"&&E.jsxs("div",{className:"card",children:[E.jsx("h2",{children:"Currently Playing"}),d?E.jsxs("div",{className:"now-playing-display",children:[d.cover_url&&E.jsx("img",{src:d.cover_url,alt:d.title,className:"cover"}),E.jsxs("div",{className:"info",children:[E.jsx("h3",{children:d.title}),E.jsx("p",{className:"artist",children:d.artist}),E.jsxs("p",{className:"duration",children:["Duration: ",d.duration||"N/A","s"]}),E.jsxs("p",{className:"started",children:["Started: ",new Date(d.started_at).toLocaleString()]})]})]}):E.jsx("p",{children:"No track currently playing"}),E.jsxs("button",{onClick:()=>{z(!W),W||ve()},className:"btn btn-primary",style:{marginTop:"15px"},children:[E.jsx(bJ,{size:16}),"Change Now Playing"]}),W&&E.jsxs("div",{className:"media-selection",style:{marginTop:"15px"},children:[E.jsx("input",{type:"text",placeholder:"Search media...",value:X,onChange:Q=>$(Q.target.value),className:"search-input"}),E.jsx("div",{className:"media-list",children:Ee.length===0?E.jsx("p",{children:"No media found"}):Ee.map(Q=>E.jsxs("div",{className:"media-item",children:[Q.cover_url&&E.jsx("img",{src:Q.cover_url,alt:Q.title}),E.jsxs("div",{className:"details",children:[E.jsx("h4",{children:Q.title}),E.jsx("p",{children:Q.artist})]}),E.jsx("button",{onClick:()=>Re(Q.id),className:"btn btn-small btn-primary",children:"Play"})]},Q.id))})]})]}),L==="queue"&&E.jsxs("div",{className:"card",children:[E.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"15px"},children:[E.jsxs("h2",{children:["Radio Queue (",h.length,")"]}),E.jsx("button",{onClick:Be,className:"btn btn-danger",children:"Clear Queue"})]}),h.length===0?E.jsx("p",{children:"Queue is empty"}):E.jsx("div",{className:"queue-list",children:h.map((Q,je)=>E.jsxs("div",{className:"queue-item",children:[E.jsx("span",{className:"position",children:je+1}),Q.cover_url&&E.jsx("img",{src:Q.cover_url,alt:Q.title}),E.jsxs("div",{className:"queue-info",children:[E.jsx("h4",{children:Q.title}),E.jsx("p",{children:Q.artist})]}),E.jsx("button",{onClick:()=>fe(Q.id),className:"btn btn-small btn-danger",children:E.jsx(bf,{size:14})})]},Q.id))}),E.jsxs("button",{onClick:()=>{z(!W),W||ve()},className:"btn btn-primary",style:{marginTop:"15px"},children:[E.jsx(xu,{size:16}),"Add to Queue"]}),W&&E.jsxs("div",{className:"media-selection",style:{marginTop:"15px"},children:[E.jsx("input",{type:"text",placeholder:"Search media...",value:X,onChange:Q=>$(Q.target.value),className:"search-input"}),E.jsx("div",{className:"media-list",children:Ee.length===0?E.jsx("p",{children:"No media found"}):Ee.map(Q=>E.jsxs("div",{className:"media-item",children:[Q.cover_url&&E.jsx("img",{src:Q.cover_url,alt:Q.title}),E.jsxs("div",{className:"details",children:[E.jsx("h4",{children:Q.title}),E.jsx("p",{children:Q.artist})]}),E.jsx("button",{onClick:()=>pe(Q.id),className:"btn btn-small btn-primary",children:"Add"})]},Q.id))})]})]}),L==="requests"&&E.jsxs("div",{className:"card",children:[E.jsx("h2",{children:"Song Requests"}),y.length===0?E.jsx("p",{children:"No pending requests"}):E.jsxs("div",{className:"requests-list",children:[y.filter(Q=>Q.status==="pending").map(Q=>E.jsxs("div",{className:"request-item",children:[E.jsxs("div",{children:[E.jsx("h4",{children:Q.song_name}),E.jsx("p",{className:"artist",children:Q.artist||"Unknown Artist"}),E.jsxs("p",{className:"requester",children:["Requested by User ",Q.user_id.substring(0,8)]})]}),E.jsxs("div",{className:"request-actions",children:[E.jsx("button",{onClick:()=>Ne(Q.id,"approved"),className:"btn btn-small btn-success",children:"Approve"}),E.jsx("button",{onClick:()=>Ne(Q.id,"rejected"),className:"btn btn-small btn-danger",children:"Reject"})]})]},Q.id)),y.filter(Q=>Q.status!=="pending").length>0&&E.jsxs("div",{style:{marginTop:"20px",paddingTop:"20px",borderTop:"1px solid #eee"},children:[E.jsx("h3",{children:"History"}),y.filter(Q=>Q.status!=="pending").map(Q=>E.jsxs("div",{className:"request-item-history",children:[E.jsx("h4",{children:Q.song_name}),E.jsx("span",{className:`status-badge ${Q.status}`,children:Q.status})]},Q.id))]})]})]}),E.jsx("style",{jsx:!0,children:`
          .admin-page {
            padding: 20px;
          }
          .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
          }
          .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
          }
          .tab-button {
            padding: 12px 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
          }
          .tab-button.active {
            color: #0070f3;
            border-bottom-color: #0070f3;
          }
          .card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            background: white;
            margin-bottom: 20px;
          }
          .card h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 18px;
          }
          .now-playing-display {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 15px;
          }
          .now-playing-display .cover {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
          }
          .now-playing-display .info {
            flex: 1;
          }
          .now-playing-display h3 {
            margin: 0 0 10px;
            font-size: 20px;
          }
          .now-playing-display .artist {
            margin: 0 0 10px;
            color: #666;
          }
          .now-playing-display .duration,
          .now-playing-display .started {
            margin: 0;
            font-size: 12px;
            color: #999;
          }
          .media-selection {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
          }
          .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
          }
          .media-list {
            max-height: 400px;
            overflow-y: auto;
          }
          .media-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
            margin-bottom: 8px;
            background: white;
          }
          .media-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
          }
          .media-item .details {
            flex: 1;
          }
          .media-item h4 {
            margin: 0 0 4px;
            font-size: 14px;
          }
          .media-item p {
            margin: 0;
            font-size: 12px;
            color: #666;
          }
          .queue-list {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
          }
          .queue-item {
            display: flex;
            gap: 12px;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            background: white;
          }
          .queue-item:last-child {
            border-bottom: none;
          }
          .queue-item .position {
            width: 30px;
            text-align: center;
            font-weight: 600;
            color: #0070f3;
          }
          .queue-item img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
          }
          .queue-item .queue-info {
            flex: 1;
          }
          .queue-item h4 {
            margin: 0 0 4px;
            font-size: 14px;
          }
          .queue-item p {
            margin: 0;
            font-size: 12px;
            color: #666;
          }
          .requests-list {
            border: 1px solid #eee;
            border-radius: 8px;
            overflow: hidden;
          }
          .request-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            background: white;
          }
          .request-item:last-child {
            border-bottom: none;
          }
          .request-item h4 {
            margin: 0 0 4px;
            font-size: 14px;
          }
          .request-item .artist,
          .request-item .requester {
            margin: 0;
            font-size: 12px;
            color: #666;
          }
          .request-actions {
            display: flex;
            gap: 8px;
          }
          .request-item-history {
            padding: 10px;
            border-bottom: 1px solid #eee;
          }
          .request-item-history h4 {
            margin: 0 0 8px;
            font-size: 14px;
          }
          .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
          }
          .status-badge.approved {
            background: #d4edda;
            color: #155724;
          }
          .status-badge.rejected {
            background: #f8d7da;
            color: #721c24;
          }
          .btn {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
          }
          .btn-primary {
            background: #0070f3;
            color: white;
          }
          .btn-secondary {
            background: #e0e0e0;
            color: #333;
          }
          .btn-danger {
            background: #ff6b6b;
            color: white;
          }
          .btn-success {
            background: #51cf66;
            color: white;
          }
          .btn-small {
            padding: 6px 8px;
            font-size: 11px;
          }
        `})]})})}function kte(){const[d,l]=K.useState([]),[h,f]=K.useState([]),[y,w]=K.useState(!0),[A,P]=K.useState(""),[L,U]=K.useState(1),[M,V]=K.useState(null),[W,z]=K.useState(!1),[X,$]=K.useState(""),[oe,ve]=K.useState(""),[Re,pe]=K.useState(!1),[fe,Be]=K.useState(0);K.useEffect(()=>{Ne()},[]),K.useEffect(()=>{A&&Ee()},[A,L]);const Ne=async()=>{try{const et=await rf.getAdminRoles();f(et.data),et.data.length>0&&P(et.data[0].name)}catch(et){console.error("Error loading roles:",et),alert("Error al cargar roles: "+et.message)}},Ee=async()=>{w(!0);try{const et=await rf.getAdminUsersByRole(A,L,20);l(et.data.users),Be(et.data.total)}catch(et){console.error("Error loading users:",et),alert("Error al cargar usuarios: "+et.message)}finally{w(!1)}},Q=et=>{V(et),$(et.role||"user"),ve(""),z(!0)},je=async()=>{if(!(!M||!X)){pe(!0);try{await rf.assignAdminUserRole(M.id,X,oe),alert(" Rol asignado exitosamente"),z(!1),Ee(),Ne()}catch(et){alert(" Error al asignar rol: "+et.message)}finally{pe(!1)}}},Tt=Math.ceil(fe/20);return E.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[E.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Gestin de Roles"}),E.jsx("p",{className:"text-gray-600 mb-6",children:"Asigna y gestiona roles de usuarios en la plataforma"}),E.jsx("div",{className:"mb-6 flex gap-4",children:E.jsxs("select",{value:A,onChange:et=>{P(et.target.value),U(1)},className:"px-4 py-2 border border-gray-300 rounded-lg bg-white font-medium",children:[E.jsx("option",{value:"",children:"Selecciona un rol"}),h.map(et=>E.jsxs("option",{value:et.name,children:[et.display_name," (",et.user_count," usuarios)"]},et.name))]})}),y?E.jsxs("div",{className:"text-center py-12 bg-white rounded-lg",children:[E.jsx("div",{className:"spinner-lg"}),E.jsx("p",{className:"text-gray-600 mt-4",children:"Cargando usuarios..."})]}):E.jsxs(E.Fragment,{children:[E.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:E.jsxs("table",{className:"w-full",children:[E.jsx("thead",{className:"bg-gray-100 border-b",children:E.jsxs("tr",{children:[E.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Email"}),E.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Username"}),E.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Rol Actual"}),E.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Status"}),E.jsx("th",{className:"px-6 py-3 text-right text-sm font-semibold",children:"Acciones"})]})}),E.jsx("tbody",{children:d.length===0?E.jsx("tr",{children:E.jsx("td",{colSpan:"5",className:"px-6 py-8 text-center text-gray-500",children:"No hay usuarios con este rol"})}):d.map(et=>E.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[E.jsx("td",{className:"px-6 py-4 text-sm font-medium",children:et.email}),E.jsx("td",{className:"px-6 py-4 text-sm",children:et.username||"-"}),E.jsx("td",{className:"px-6 py-4 text-sm",children:E.jsx("span",{className:"inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium",children:et.display_name})}),E.jsx("td",{className:"px-6 py-4 text-sm",children:E.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${et.status==="active"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:et.status})}),E.jsx("td",{className:"px-6 py-4 text-right",children:E.jsx("button",{onClick:()=>Q(et),className:"text-blue-600 hover:text-blue-900 font-medium text-sm",children:"Cambiar Rol"})})]},et.id))})]})}),d.length>0&&E.jsxs("div",{className:"mt-6 flex justify-between items-center",children:[E.jsxs("p",{className:"text-sm text-gray-600",children:["Mostrando ",(L-1)*20+1," a ",Math.min(L*20,fe)," de ",fe," usuarios"]}),E.jsxs("div",{className:"flex gap-2",children:[E.jsx("button",{onClick:()=>U(Math.max(1,L-1)),disabled:L===1,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:" Anterior"}),E.jsxs("span",{className:"px-4 py-2 font-medium",children:[L," de ",Tt]}),E.jsx("button",{onClick:()=>U(Math.min(Tt,L+1)),disabled:L===Tt,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:"Siguiente "})]})]})]}),W&&M&&E.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:E.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full",children:[E.jsxs("h2",{className:"text-xl font-bold mb-4",children:["Cambiar rol de ",E.jsx("span",{className:"text-blue-600",children:M.email})]}),E.jsxs("div",{className:"mb-4",children:[E.jsx("label",{className:"block text-sm font-medium mb-2",children:"Nuevo Rol"}),E.jsx("select",{value:X,onChange:et=>$(et.target.value),className:"w-full px-4 py-2 border border-gray-300 rounded-lg font-medium",children:h.map(et=>E.jsx("option",{value:et.name,children:et.display_name},et.name))})]}),E.jsxs("div",{className:"mb-4",children:[E.jsx("label",{className:"block text-sm font-medium mb-2",children:"Razn (Opcional)"}),E.jsx("textarea",{value:oe,onChange:et=>ve(et.target.value),placeholder:"Ej: Promocin a moderador por buen comportamiento",className:"w-full px-4 py-2 border border-gray-300 rounded-lg text-sm",rows:"3"})]}),E.jsxs("div",{className:"flex gap-3",children:[E.jsx("button",{onClick:()=>z(!1),className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium",children:"Cancelar"}),E.jsx("button",{onClick:je,disabled:Re,className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 font-medium",children:Re?"Guardando...":"Guardar"})]})]})})]})}const C2=6048e5,xte=864e5,RM=Symbol.for("constructDateFrom");function ea(d,l){return typeof d=="function"?d(l):d&&typeof d=="object"&&RM in d?d[RM](l):d instanceof Date?new d.constructor(l):new Date(l)}function us(d,l){return ea(l||d,d)}let Mte={};function Vf(){return Mte}function ju(d,l){const h=Vf(),f=l?.weekStartsOn??l?.locale?.options?.weekStartsOn??h.weekStartsOn??h.locale?.options?.weekStartsOn??0,y=us(d,l?.in),w=y.getDay(),A=(w<f?7:0)+w-f;return y.setDate(y.getDate()-A),y.setHours(0,0,0,0),y}function Tf(d,l){return ju(d,{...l,weekStartsOn:1})}function b2(d,l){const h=us(d,l?.in),f=h.getFullYear(),y=ea(h,0);y.setFullYear(f+1,0,4),y.setHours(0,0,0,0);const w=Tf(y),A=ea(h,0);A.setFullYear(f,0,4),A.setHours(0,0,0,0);const P=Tf(A);return h.getTime()>=w.getTime()?f+1:h.getTime()>=P.getTime()?f:f-1}function CM(d){const l=us(d),h=new Date(Date.UTC(l.getFullYear(),l.getMonth(),l.getDate(),l.getHours(),l.getMinutes(),l.getSeconds(),l.getMilliseconds()));return h.setUTCFullYear(l.getFullYear()),+d-+h}function Ute(d,...l){const h=ea.bind(null,l.find(f=>typeof f=="object"));return l.map(h)}function bM(d,l){const h=us(d,l?.in);return h.setHours(0,0,0,0),h}function Vte(d,l,h){const[f,y]=Ute(h?.in,d,l),w=bM(f),A=bM(y),P=+w-CM(w),L=+A-CM(A);return Math.round((P-L)/xte)}function jte(d,l){const h=b2(d,l),f=ea(d,0);return f.setFullYear(h,0,4),f.setHours(0,0,0,0),Tf(f)}function Fte(d){return d instanceof Date||typeof d=="object"&&Object.prototype.toString.call(d)==="[object Date]"}function Bte(d){return!(!Fte(d)&&typeof d!="number"||isNaN(+us(d)))}function Wte(d,l){const h=us(d,l?.in);return h.setFullYear(h.getFullYear(),0,1),h.setHours(0,0,0,0),h}const Gte={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},Hte=(d,l,h)=>{let f;const y=Gte[d];return typeof y=="string"?f=y:l===1?f=y.one:f=y.other.replace("{{count}}",l.toString()),h?.addSuffix?h.comparison&&h.comparison>0?"in "+f:f+" ago":f};function Gd(d){return(l={})=>{const h=l.width?String(l.width):d.defaultWidth;return d.formats[h]||d.formats[d.defaultWidth]}}const Kte={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},Yte={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},zte={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},qte={date:Gd({formats:Kte,defaultWidth:"full"}),time:Gd({formats:Yte,defaultWidth:"full"}),dateTime:Gd({formats:zte,defaultWidth:"full"})},Xte={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},Jte=(d,l,h,f)=>Xte[d];function Ms(d){return(l,h)=>{const f=h?.context?String(h.context):"standalone";let y;if(f==="formatting"&&d.formattingValues){const A=d.defaultFormattingWidth||d.defaultWidth,P=h?.width?String(h.width):A;y=d.formattingValues[P]||d.formattingValues[A]}else{const A=d.defaultWidth,P=h?.width?String(h.width):d.defaultWidth;y=d.values[P]||d.values[A]}const w=d.argumentCallback?d.argumentCallback(l):l;return y[w]}}const Qte={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},Zte={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},$te={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},ene={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},tne={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},nne={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},ine=(d,l)=>{const h=Number(d),f=h%100;if(f>20||f<10)switch(f%10){case 1:return h+"st";case 2:return h+"nd";case 3:return h+"rd"}return h+"th"},rne={ordinalNumber:ine,era:Ms({values:Qte,defaultWidth:"wide"}),quarter:Ms({values:Zte,defaultWidth:"wide",argumentCallback:d=>d-1}),month:Ms({values:$te,defaultWidth:"wide"}),day:Ms({values:ene,defaultWidth:"wide"}),dayPeriod:Ms({values:tne,defaultWidth:"wide",formattingValues:nne,defaultFormattingWidth:"wide"})};function Us(d){return(l,h={})=>{const f=h.width,y=f&&d.matchPatterns[f]||d.matchPatterns[d.defaultMatchWidth],w=l.match(y);if(!w)return null;const A=w[0],P=f&&d.parsePatterns[f]||d.parsePatterns[d.defaultParseWidth],L=Array.isArray(P)?one(P,V=>V.test(A)):sne(P,V=>V.test(A));let U;U=d.valueCallback?d.valueCallback(L):L,U=h.valueCallback?h.valueCallback(U):U;const M=l.slice(A.length);return{value:U,rest:M}}}function sne(d,l){for(const h in d)if(Object.prototype.hasOwnProperty.call(d,h)&&l(d[h]))return h}function one(d,l){for(let h=0;h<d.length;h++)if(l(d[h]))return h}function w2(d){return(l,h={})=>{const f=l.match(d.matchPattern);if(!f)return null;const y=f[0],w=l.match(d.parsePattern);if(!w)return null;let A=d.valueCallback?d.valueCallback(w[0]):w[0];A=h.valueCallback?h.valueCallback(A):A;const P=l.slice(y.length);return{value:A,rest:P}}}const ane=/^(\d+)(th|st|nd|rd)?/i,cne=/\d+/i,dne={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},lne={any:[/^b/i,/^(a|c)/i]},une={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},hne={any:[/1/i,/2/i,/3/i,/4/i]},pne={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},mne={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},fne={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},_ne={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},gne={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},Ene={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},Sne={ordinalNumber:w2({matchPattern:ane,parsePattern:cne,valueCallback:d=>parseInt(d,10)}),era:Us({matchPatterns:dne,defaultMatchWidth:"wide",parsePatterns:lne,defaultParseWidth:"any"}),quarter:Us({matchPatterns:une,defaultMatchWidth:"wide",parsePatterns:hne,defaultParseWidth:"any",valueCallback:d=>d+1}),month:Us({matchPatterns:pne,defaultMatchWidth:"wide",parsePatterns:mne,defaultParseWidth:"any"}),day:Us({matchPatterns:fne,defaultMatchWidth:"wide",parsePatterns:_ne,defaultParseWidth:"any"}),dayPeriod:Us({matchPatterns:gne,defaultMatchWidth:"any",parsePatterns:Ene,defaultParseWidth:"any"})},yne={code:"en-US",formatDistance:Hte,formatLong:qte,formatRelative:Jte,localize:rne,match:Sne,options:{weekStartsOn:0,firstWeekContainsDate:1}};function Tne(d,l){const h=us(d,l?.in);return Vte(h,Wte(h))+1}function vne(d,l){const h=us(d,l?.in),f=+Tf(h)-+jte(h);return Math.round(f/C2)+1}function A2(d,l){const h=us(d,l?.in),f=h.getFullYear(),y=Vf(),w=l?.firstWeekContainsDate??l?.locale?.options?.firstWeekContainsDate??y.firstWeekContainsDate??y.locale?.options?.firstWeekContainsDate??1,A=ea(l?.in||d,0);A.setFullYear(f+1,0,w),A.setHours(0,0,0,0);const P=ju(A,l),L=ea(l?.in||d,0);L.setFullYear(f,0,w),L.setHours(0,0,0,0);const U=ju(L,l);return+h>=+P?f+1:+h>=+U?f:f-1}function Rne(d,l){const h=Vf(),f=l?.firstWeekContainsDate??l?.locale?.options?.firstWeekContainsDate??h.firstWeekContainsDate??h.locale?.options?.firstWeekContainsDate??1,y=A2(d,l),w=ea(l?.in||d,0);return w.setFullYear(y,0,f),w.setHours(0,0,0,0),ju(w,l)}function Cne(d,l){const h=us(d,l?.in),f=+ju(h,l)-+Rne(h,l);return Math.round(f/C2)+1}function nn(d,l){const h=d<0?"-":"",f=Math.abs(d).toString().padStart(l,"0");return h+f}const Yo={y(d,l){const h=d.getFullYear(),f=h>0?h:1-h;return nn(l==="yy"?f%100:f,l.length)},M(d,l){const h=d.getMonth();return l==="M"?String(h+1):nn(h+1,2)},d(d,l){return nn(d.getDate(),l.length)},a(d,l){const h=d.getHours()/12>=1?"pm":"am";switch(l){case"a":case"aa":return h.toUpperCase();case"aaa":return h;case"aaaaa":return h[0];default:return h==="am"?"a.m.":"p.m."}},h(d,l){return nn(d.getHours()%12||12,l.length)},H(d,l){return nn(d.getHours(),l.length)},m(d,l){return nn(d.getMinutes(),l.length)},s(d,l){return nn(d.getSeconds(),l.length)},S(d,l){const h=l.length,f=d.getMilliseconds(),y=Math.trunc(f*Math.pow(10,h-3));return nn(y,l.length)}},xd={midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wM={G:function(d,l,h){const f=d.getFullYear()>0?1:0;switch(l){case"G":case"GG":case"GGG":return h.era(f,{width:"abbreviated"});case"GGGGG":return h.era(f,{width:"narrow"});default:return h.era(f,{width:"wide"})}},y:function(d,l,h){if(l==="yo"){const f=d.getFullYear(),y=f>0?f:1-f;return h.ordinalNumber(y,{unit:"year"})}return Yo.y(d,l)},Y:function(d,l,h,f){const y=A2(d,f),w=y>0?y:1-y;if(l==="YY"){const A=w%100;return nn(A,2)}return l==="Yo"?h.ordinalNumber(w,{unit:"year"}):nn(w,l.length)},R:function(d,l){const h=b2(d);return nn(h,l.length)},u:function(d,l){const h=d.getFullYear();return nn(h,l.length)},Q:function(d,l,h){const f=Math.ceil((d.getMonth()+1)/3);switch(l){case"Q":return String(f);case"QQ":return nn(f,2);case"Qo":return h.ordinalNumber(f,{unit:"quarter"});case"QQQ":return h.quarter(f,{width:"abbreviated",context:"formatting"});case"QQQQQ":return h.quarter(f,{width:"narrow",context:"formatting"});default:return h.quarter(f,{width:"wide",context:"formatting"})}},q:function(d,l,h){const f=Math.ceil((d.getMonth()+1)/3);switch(l){case"q":return String(f);case"qq":return nn(f,2);case"qo":return h.ordinalNumber(f,{unit:"quarter"});case"qqq":return h.quarter(f,{width:"abbreviated",context:"standalone"});case"qqqqq":return h.quarter(f,{width:"narrow",context:"standalone"});default:return h.quarter(f,{width:"wide",context:"standalone"})}},M:function(d,l,h){const f=d.getMonth();switch(l){case"M":case"MM":return Yo.M(d,l);case"Mo":return h.ordinalNumber(f+1,{unit:"month"});case"MMM":return h.month(f,{width:"abbreviated",context:"formatting"});case"MMMMM":return h.month(f,{width:"narrow",context:"formatting"});default:return h.month(f,{width:"wide",context:"formatting"})}},L:function(d,l,h){const f=d.getMonth();switch(l){case"L":return String(f+1);case"LL":return nn(f+1,2);case"Lo":return h.ordinalNumber(f+1,{unit:"month"});case"LLL":return h.month(f,{width:"abbreviated",context:"standalone"});case"LLLLL":return h.month(f,{width:"narrow",context:"standalone"});default:return h.month(f,{width:"wide",context:"standalone"})}},w:function(d,l,h,f){const y=Cne(d,f);return l==="wo"?h.ordinalNumber(y,{unit:"week"}):nn(y,l.length)},I:function(d,l,h){const f=vne(d);return l==="Io"?h.ordinalNumber(f,{unit:"week"}):nn(f,l.length)},d:function(d,l,h){return l==="do"?h.ordinalNumber(d.getDate(),{unit:"date"}):Yo.d(d,l)},D:function(d,l,h){const f=Tne(d);return l==="Do"?h.ordinalNumber(f,{unit:"dayOfYear"}):nn(f,l.length)},E:function(d,l,h){const f=d.getDay();switch(l){case"E":case"EE":case"EEE":return h.day(f,{width:"abbreviated",context:"formatting"});case"EEEEE":return h.day(f,{width:"narrow",context:"formatting"});case"EEEEEE":return h.day(f,{width:"short",context:"formatting"});default:return h.day(f,{width:"wide",context:"formatting"})}},e:function(d,l,h,f){const y=d.getDay(),w=(y-f.weekStartsOn+8)%7||7;switch(l){case"e":return String(w);case"ee":return nn(w,2);case"eo":return h.ordinalNumber(w,{unit:"day"});case"eee":return h.day(y,{width:"abbreviated",context:"formatting"});case"eeeee":return h.day(y,{width:"narrow",context:"formatting"});case"eeeeee":return h.day(y,{width:"short",context:"formatting"});default:return h.day(y,{width:"wide",context:"formatting"})}},c:function(d,l,h,f){const y=d.getDay(),w=(y-f.weekStartsOn+8)%7||7;switch(l){case"c":return String(w);case"cc":return nn(w,l.length);case"co":return h.ordinalNumber(w,{unit:"day"});case"ccc":return h.day(y,{width:"abbreviated",context:"standalone"});case"ccccc":return h.day(y,{width:"narrow",context:"standalone"});case"cccccc":return h.day(y,{width:"short",context:"standalone"});default:return h.day(y,{width:"wide",context:"standalone"})}},i:function(d,l,h){const f=d.getDay(),y=f===0?7:f;switch(l){case"i":return String(y);case"ii":return nn(y,l.length);case"io":return h.ordinalNumber(y,{unit:"day"});case"iii":return h.day(f,{width:"abbreviated",context:"formatting"});case"iiiii":return h.day(f,{width:"narrow",context:"formatting"});case"iiiiii":return h.day(f,{width:"short",context:"formatting"});default:return h.day(f,{width:"wide",context:"formatting"})}},a:function(d,l,h){const y=d.getHours()/12>=1?"pm":"am";switch(l){case"a":case"aa":return h.dayPeriod(y,{width:"abbreviated",context:"formatting"});case"aaa":return h.dayPeriod(y,{width:"abbreviated",context:"formatting"}).toLowerCase();case"aaaaa":return h.dayPeriod(y,{width:"narrow",context:"formatting"});default:return h.dayPeriod(y,{width:"wide",context:"formatting"})}},b:function(d,l,h){const f=d.getHours();let y;switch(f===12?y=xd.noon:f===0?y=xd.midnight:y=f/12>=1?"pm":"am",l){case"b":case"bb":return h.dayPeriod(y,{width:"abbreviated",context:"formatting"});case"bbb":return h.dayPeriod(y,{width:"abbreviated",context:"formatting"}).toLowerCase();case"bbbbb":return h.dayPeriod(y,{width:"narrow",context:"formatting"});default:return h.dayPeriod(y,{width:"wide",context:"formatting"})}},B:function(d,l,h){const f=d.getHours();let y;switch(f>=17?y=xd.evening:f>=12?y=xd.afternoon:f>=4?y=xd.morning:y=xd.night,l){case"B":case"BB":case"BBB":return h.dayPeriod(y,{width:"abbreviated",context:"formatting"});case"BBBBB":return h.dayPeriod(y,{width:"narrow",context:"formatting"});default:return h.dayPeriod(y,{width:"wide",context:"formatting"})}},h:function(d,l,h){if(l==="ho"){let f=d.getHours()%12;return f===0&&(f=12),h.ordinalNumber(f,{unit:"hour"})}return Yo.h(d,l)},H:function(d,l,h){return l==="Ho"?h.ordinalNumber(d.getHours(),{unit:"hour"}):Yo.H(d,l)},K:function(d,l,h){const f=d.getHours()%12;return l==="Ko"?h.ordinalNumber(f,{unit:"hour"}):nn(f,l.length)},k:function(d,l,h){let f=d.getHours();return f===0&&(f=24),l==="ko"?h.ordinalNumber(f,{unit:"hour"}):nn(f,l.length)},m:function(d,l,h){return l==="mo"?h.ordinalNumber(d.getMinutes(),{unit:"minute"}):Yo.m(d,l)},s:function(d,l,h){return l==="so"?h.ordinalNumber(d.getSeconds(),{unit:"second"}):Yo.s(d,l)},S:function(d,l){return Yo.S(d,l)},X:function(d,l,h){const f=d.getTimezoneOffset();if(f===0)return"Z";switch(l){case"X":return IM(f);case"XXXX":case"XX":return sc(f);default:return sc(f,":")}},x:function(d,l,h){const f=d.getTimezoneOffset();switch(l){case"x":return IM(f);case"xxxx":case"xx":return sc(f);default:return sc(f,":")}},O:function(d,l,h){const f=d.getTimezoneOffset();switch(l){case"O":case"OO":case"OOO":return"GMT"+AM(f,":");default:return"GMT"+sc(f,":")}},z:function(d,l,h){const f=d.getTimezoneOffset();switch(l){case"z":case"zz":case"zzz":return"GMT"+AM(f,":");default:return"GMT"+sc(f,":")}},t:function(d,l,h){const f=Math.trunc(+d/1e3);return nn(f,l.length)},T:function(d,l,h){return nn(+d,l.length)}};function AM(d,l=""){const h=d>0?"-":"+",f=Math.abs(d),y=Math.trunc(f/60),w=f%60;return w===0?h+String(y):h+String(y)+l+nn(w,2)}function IM(d,l){return d%60===0?(d>0?"-":"+")+nn(Math.abs(d)/60,2):sc(d,l)}function sc(d,l=""){const h=d>0?"-":"+",f=Math.abs(d),y=nn(Math.trunc(f/60),2),w=nn(f%60,2);return h+y+l+w}const OM=(d,l)=>{switch(d){case"P":return l.date({width:"short"});case"PP":return l.date({width:"medium"});case"PPP":return l.date({width:"long"});default:return l.date({width:"full"})}},I2=(d,l)=>{switch(d){case"p":return l.time({width:"short"});case"pp":return l.time({width:"medium"});case"ppp":return l.time({width:"long"});default:return l.time({width:"full"})}},bne=(d,l)=>{const h=d.match(/(P+)(p+)?/)||[],f=h[1],y=h[2];if(!y)return OM(d,l);let w;switch(f){case"P":w=l.dateTime({width:"short"});break;case"PP":w=l.dateTime({width:"medium"});break;case"PPP":w=l.dateTime({width:"long"});break;default:w=l.dateTime({width:"full"});break}return w.replace("{{date}}",OM(f,l)).replace("{{time}}",I2(y,l))},wne={p:I2,P:bne},Ane=/^D+$/,Ine=/^Y+$/,One=["D","DD","YY","YYYY"];function Nne(d){return Ane.test(d)}function Dne(d){return Ine.test(d)}function Pne(d,l,h){const f=Lne(d,l,h);if(console.warn(f),One.includes(d))throw new RangeError(f)}function Lne(d,l,h){const f=d[0]==="Y"?"years":"days of the month";return`Use \`${d.toLowerCase()}\` instead of \`${d}\` (in \`${l}\`) for formatting ${f} to the input \`${h}\`; see: https://github.com/date-fns/date-fns/blob/master/docs/unicodeTokens.md`}const kne=/[yYQqMLwIdDecihHKkms]o|(\w)\1*|''|'(''|[^'])+('|$)|./g,xne=/P+p+|P+|p+|''|'(''|[^'])+('|$)|./g,Mne=/^'([^]*?)'?$/,Une=/''/g,Vne=/[a-zA-Z]/;function jne(d,l,h){const f=Vf(),y=h?.locale??f.locale??yne,w=h?.firstWeekContainsDate??h?.locale?.options?.firstWeekContainsDate??f.firstWeekContainsDate??f.locale?.options?.firstWeekContainsDate??1,A=h?.weekStartsOn??h?.locale?.options?.weekStartsOn??f.weekStartsOn??f.locale?.options?.weekStartsOn??0,P=us(d,h?.in);if(!Bte(P))throw new RangeError("Invalid time value");let L=l.match(xne).map(M=>{const V=M[0];if(V==="p"||V==="P"){const W=wne[V];return W(M,y.formatLong)}return M}).join("").match(kne).map(M=>{if(M==="''")return{isToken:!1,value:"'"};const V=M[0];if(V==="'")return{isToken:!1,value:Fne(M)};if(wM[V])return{isToken:!0,value:M};if(V.match(Vne))throw new RangeError("Format string contains an unescaped latin alphabet character `"+V+"`");return{isToken:!1,value:M}});y.localize.preprocessor&&(L=y.localize.preprocessor(P,L));const U={firstWeekContainsDate:w,weekStartsOn:A,locale:y};return L.map(M=>{if(!M.isToken)return M.value;const V=M.value;(!h?.useAdditionalWeekYearTokens&&Dne(V)||!h?.useAdditionalDayOfYearTokens&&Nne(V))&&Pne(V,l,String(d));const W=wM[V[0]];return W(P,V,y.localize,U)}).join("")}function Fne(d){const l=d.match(Mne);return l?l[1].replace(Une,"'"):d}const Bne={lessThanXSeconds:{one:"menos de un segundo",other:"menos de {{count}} segundos"},xSeconds:{one:"1 segundo",other:"{{count}} segundos"},halfAMinute:"medio minuto",lessThanXMinutes:{one:"menos de un minuto",other:"menos de {{count}} minutos"},xMinutes:{one:"1 minuto",other:"{{count}} minutos"},aboutXHours:{one:"alrededor de 1 hora",other:"alrededor de {{count}} horas"},xHours:{one:"1 hora",other:"{{count}} horas"},xDays:{one:"1 da",other:"{{count}} das"},aboutXWeeks:{one:"alrededor de 1 semana",other:"alrededor de {{count}} semanas"},xWeeks:{one:"1 semana",other:"{{count}} semanas"},aboutXMonths:{one:"alrededor de 1 mes",other:"alrededor de {{count}} meses"},xMonths:{one:"1 mes",other:"{{count}} meses"},aboutXYears:{one:"alrededor de 1 ao",other:"alrededor de {{count}} aos"},xYears:{one:"1 ao",other:"{{count}} aos"},overXYears:{one:"ms de 1 ao",other:"ms de {{count}} aos"},almostXYears:{one:"casi 1 ao",other:"casi {{count}} aos"}},Wne=(d,l,h)=>{let f;const y=Bne[d];return typeof y=="string"?f=y:l===1?f=y.one:f=y.other.replace("{{count}}",l.toString()),h?.addSuffix?h.comparison&&h.comparison>0?"en "+f:"hace "+f:f},Gne={full:"EEEE, d 'de' MMMM 'de' y",long:"d 'de' MMMM 'de' y",medium:"d MMM y",short:"dd/MM/y"},Hne={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},Kne={full:"{{date}} 'a las' {{time}}",long:"{{date}} 'a las' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},Yne={date:Gd({formats:Gne,defaultWidth:"full"}),time:Gd({formats:Hne,defaultWidth:"full"}),dateTime:Gd({formats:Kne,defaultWidth:"full"})},zne={lastWeek:"'el' eeee 'pasado a la' p",yesterday:"'ayer a la' p",today:"'hoy a la' p",tomorrow:"'maana a la' p",nextWeek:"eeee 'a la' p",other:"P"},qne={lastWeek:"'el' eeee 'pasado a las' p",yesterday:"'ayer a las' p",today:"'hoy a las' p",tomorrow:"'maana a las' p",nextWeek:"eeee 'a las' p",other:"P"},Xne=(d,l,h,f)=>l.getHours()!==1?qne[d]:zne[d],Jne={narrow:["AC","DC"],abbreviated:["AC","DC"],wide:["antes de cristo","despus de cristo"]},Qne={narrow:["1","2","3","4"],abbreviated:["T1","T2","T3","T4"],wide:["1 trimestre","2 trimestre","3 trimestre","4 trimestre"]},Zne={narrow:["e","f","m","a","m","j","j","a","s","o","n","d"],abbreviated:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],wide:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"]},$ne={narrow:["d","l","m","m","j","v","s"],short:["do","lu","ma","mi","ju","vi","s"],abbreviated:["dom","lun","mar","mi","jue","vie","sb"],wide:["domingo","lunes","martes","mircoles","jueves","viernes","sbado"]},eie={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"maana",afternoon:"tarde",evening:"tarde",night:"noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"maana",afternoon:"tarde",evening:"tarde",night:"noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"maana",afternoon:"tarde",evening:"tarde",night:"noche"}},tie={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"de la maana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"de la maana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"de la maana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"}},nie=(d,l)=>Number(d)+"",iie={ordinalNumber:nie,era:Ms({values:Jne,defaultWidth:"wide"}),quarter:Ms({values:Qne,defaultWidth:"wide",argumentCallback:d=>Number(d)-1}),month:Ms({values:Zne,defaultWidth:"wide"}),day:Ms({values:$ne,defaultWidth:"wide"}),dayPeriod:Ms({values:eie,defaultWidth:"wide",formattingValues:tie,defaultFormattingWidth:"wide"})},rie=/^(\d+)()?/i,sie=/\d+/i,oie={narrow:/^(ac|dc|a|d)/i,abbreviated:/^(a\.?\s?c\.?|a\.?\s?e\.?\s?c\.?|d\.?\s?c\.?|e\.?\s?c\.?)/i,wide:/^(antes de cristo|antes de la era com[u]n|despu[e]s de cristo|era com[u]n)/i},aie={any:[/^ac/i,/^dc/i],wide:[/^(antes de cristo|antes de la era com[u]n)/i,/^(despu[e]s de cristo|era com[u]n)/i]},cie={narrow:/^[1234]/i,abbreviated:/^T[1234]/i,wide:/^[1234]()? trimestre/i},die={any:[/1/i,/2/i,/3/i,/4/i]},lie={narrow:/^[efmajsond]/i,abbreviated:/^(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)/i,wide:/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i},uie={narrow:[/^e/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^en/i,/^feb/i,/^mar/i,/^abr/i,/^may/i,/^jun/i,/^jul/i,/^ago/i,/^sep/i,/^oct/i,/^nov/i,/^dic/i]},hie={narrow:/^[dlmjvs]/i,short:/^(do|lu|ma|mi|ju|vi|s[a])/i,abbreviated:/^(dom|lun|mar|mi[e]|jue|vie|s[a]b)/i,wide:/^(domingo|lunes|martes|mi[e]rcoles|jueves|viernes|s[a]bado)/i},pie={narrow:[/^d/i,/^l/i,/^m/i,/^m/i,/^j/i,/^v/i,/^s/i],any:[/^do/i,/^lu/i,/^ma/i,/^mi/i,/^ju/i,/^vi/i,/^sa/i]},mie={narrow:/^(a|p|mn|md|(de la|a las) (maana|tarde|noche))/i,any:/^([ap]\.?\s?m\.?|medianoche|mediodia|(de la|a las) (maana|tarde|noche))/i},fie={any:{am:/^a/i,pm:/^p/i,midnight:/^mn/i,noon:/^md/i,morning:/maana/i,afternoon:/tarde/i,evening:/tarde/i,night:/noche/i}},_ie={ordinalNumber:w2({matchPattern:rie,parsePattern:sie,valueCallback:function(d){return parseInt(d,10)}}),era:Us({matchPatterns:oie,defaultMatchWidth:"wide",parsePatterns:aie,defaultParseWidth:"any"}),quarter:Us({matchPatterns:cie,defaultMatchWidth:"wide",parsePatterns:die,defaultParseWidth:"any",valueCallback:d=>d+1}),month:Us({matchPatterns:lie,defaultMatchWidth:"wide",parsePatterns:uie,defaultParseWidth:"any"}),day:Us({matchPatterns:hie,defaultMatchWidth:"wide",parsePatterns:pie,defaultParseWidth:"any"}),dayPeriod:Us({matchPatterns:mie,defaultMatchWidth:"any",parsePatterns:fie,defaultParseWidth:"any"})},gie={code:"es",formatDistance:Wne,formatLong:Yne,formatRelative:Xne,localize:iie,match:_ie,options:{weekStartsOn:1,firstWeekContainsDate:1}};function Eie(){const[d,l]=K.useState([]),[h,f]=K.useState(!0),[y,w]=K.useState(1),[A,P]=K.useState({action:"",resourceType:""}),[L,U]=K.useState(0);K.useEffect(()=>{M()},[y,A]);const M=async()=>{f(!0);try{const z={page:y,limit:20,...A},X=await rf.getAdminAuditLogs(z);l(X.data.logs),U(X.data.total)}catch(z){console.error("Error loading logs:",z),alert("Error al cargar logs: "+z.message)}finally{f(!1)}},V=(z,X)=>{P({...A,[z]:X}),w(1)},W=Math.ceil(L/20);return E.jsxs("div",{className:"p-6 bg-gray-50 min-h-screen",children:[E.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Logs de Auditora"}),E.jsx("p",{className:"text-gray-600 mb-6",children:"Historial completo de cambios en la plataforma"}),E.jsxs("div",{className:"mb-6 flex gap-4 bg-white p-4 rounded-lg shadow",children:[E.jsx("input",{type:"text",placeholder:"Filtrar por accin...",value:A.action,onChange:z=>V("action",z.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg flex-1"}),E.jsxs("select",{value:A.resourceType,onChange:z=>V("resourceType",z.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg",children:[E.jsx("option",{value:"",children:"Todos los tipos"}),E.jsx("option",{value:"user",children:"Usuario"}),E.jsx("option",{value:"content",children:"Contenido"}),E.jsx("option",{value:"role",children:"Rol"})]})]}),h?E.jsxs("div",{className:"text-center py-12 bg-white rounded-lg",children:[E.jsx("div",{className:"spinner-lg"}),E.jsx("p",{className:"text-gray-600 mt-4",children:"Cargando logs..."})]}):E.jsxs(E.Fragment,{children:[E.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:E.jsxs("table",{className:"w-full",children:[E.jsx("thead",{className:"bg-gray-100 border-b",children:E.jsxs("tr",{children:[E.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Fecha"}),E.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Actor"}),E.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Accin"}),E.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Recurso"}),E.jsx("th",{className:"px-6 py-3 text-left text-sm font-semibold",children:"Detalles"})]})}),E.jsx("tbody",{children:d.length===0?E.jsx("tr",{children:E.jsx("td",{colSpan:"5",className:"px-6 py-8 text-center text-gray-500",children:"No hay logs de auditora"})}):d.map(z=>E.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[E.jsx("td",{className:"px-6 py-4 text-sm",children:jne(new Date(z.created_at),"dd/MM/yyyy HH:mm:ss",{locale:gie})}),E.jsx("td",{className:"px-6 py-4 text-sm font-medium",children:z.actor_email}),E.jsx("td",{className:"px-6 py-4 text-sm",children:E.jsx("span",{className:"inline-block bg-amber-100 text-amber-800 px-3 py-1 rounded text-xs font-medium",children:z.action})}),E.jsxs("td",{className:"px-6 py-4 text-sm",children:[z.resource_type," #",z.resource_id]}),E.jsx("td",{className:"px-6 py-4 text-sm text-gray-600",children:z.metadata&&E.jsxs("span",{title:JSON.stringify(z.metadata,null,2),children:[JSON.stringify(z.metadata).substring(0,40),"..."]})})]},z.id))})]})}),d.length>0&&E.jsxs("div",{className:"mt-6 flex justify-between items-center",children:[E.jsxs("p",{className:"text-sm text-gray-600",children:["Mostrando ",(y-1)*20+1," a ",Math.min(y*20,L)," de ",L," logs"]}),E.jsxs("div",{className:"flex gap-2",children:[E.jsx("button",{onClick:()=>w(Math.max(1,y-1)),disabled:y===1,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:" Anterior"}),E.jsxs("span",{className:"px-4 py-2 font-medium",children:[y," de ",W]}),E.jsx("button",{onClick:()=>w(Math.min(W,y+1)),disabled:y===W,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50",children:"Siguiente "})]})]})]})]})}function ds({children:d}){const{user:l,loading:h}=hr();return h?E.jsxs("div",{className:"loading-screen",children:[E.jsx("div",{className:"loading-spinner"}),E.jsx("p",{children:"Loading..."})]}):l?d:(window.location.replace("/"),null)}function zo({children:d}){const{user:l,loading:h}=hr();return h?E.jsxs("div",{className:"loading-screen",children:[E.jsx("div",{className:"loading-spinner"}),E.jsx("p",{children:"Loading..."})]}):l?["admin","superadmin"].includes(l.role)?d:E.jsx(QT,{to:"/",replace:!0}):(window.location.replace("/"),null)}function Sie(){const d=JT();return E.jsx(X$,{mode:"wait",children:E.jsx(B$.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0},transition:{duration:.25,ease:"easeOut"},children:E.jsxs($9,{location:d,children:[E.jsx(Bn,{path:"/",element:E.jsx(ds,{children:E.jsx($ee,{})})}),E.jsx(Bn,{path:"/profile",element:E.jsx(ds,{children:E.jsx(nte,{})})}),E.jsx(Bn,{path:"/nearby",element:E.jsx(ds,{children:E.jsx(ste,{})})}),E.jsx(Bn,{path:"/hangouts",element:E.jsx(ds,{children:E.jsx(dte,{})})}),E.jsx(Bn,{path:"/live",element:E.jsx(ds,{children:E.jsx(_te,{})})}),E.jsx(Bn,{path:"/prime",element:E.jsx(ds,{children:E.jsx(Ste,{})})}),E.jsx(Bn,{path:"/videorama",element:E.jsx(gte,{})}),E.jsx(Bn,{path:"/media",element:E.jsx(ds,{children:E.jsx(Ete,{})})}),E.jsx(Bn,{path:"/feed",element:E.jsx(ds,{children:E.jsx(vte,{})})}),E.jsx(Bn,{path:"/wall/:userId",element:E.jsx(ds,{children:E.jsx(Rte,{})})}),E.jsx(Bn,{path:"/messages",element:E.jsx(ds,{children:E.jsx(bte,{})})}),E.jsx(Bn,{path:"/messages/:partnerId",element:E.jsx(ds,{children:E.jsx(Ate,{})})}),E.jsx(Bn,{path:"/admin",element:E.jsx(zo,{children:E.jsx(Ite,{})})}),E.jsx(Bn,{path:"/admin/users",element:E.jsx(zo,{children:E.jsx(Ote,{})})}),E.jsx(Bn,{path:"/admin/posts",element:E.jsx(zo,{children:E.jsx(Nte,{})})}),E.jsx(Bn,{path:"/admin/hangouts",element:E.jsx(zo,{children:E.jsx(Dte,{})})}),E.jsx(Bn,{path:"/admin/media",element:E.jsx(zo,{children:E.jsx(Pte,{})})}),E.jsx(Bn,{path:"/admin/radio",element:E.jsx(zo,{children:E.jsx(Lte,{})})}),E.jsx(Bn,{path:"/admin/roles",element:E.jsx(zo,{children:E.jsx(kte,{})})}),E.jsx(Bn,{path:"/admin/audit-logs",element:E.jsx(zo,{children:E.jsx(Eie,{})})}),E.jsx(Bn,{path:"*",element:E.jsx(QT,{to:"/",replace:!0})})]})},d.pathname)})}function yie(){return E.jsx(J$,{children:E.jsx(Sie,{})})}class Tie extends Fu.Component{constructor(l){super(l),this.state={hasError:!1,error:null,errorInfo:null}}static getDerivedStateFromError(l){return{hasError:!0}}componentDidCatch(l,h){console.error("ErrorBoundary caught an error:",l),console.error("Error Info:",h),this.setState({error:l,errorInfo:h})}handleReload=()=>{this.setState({hasError:!1,error:null,errorInfo:null}),window.location.reload()};render(){return this.state.hasError?E.jsx("div",{className:"error-boundary-container",children:E.jsxs("div",{className:"error-boundary-content",children:[E.jsx("div",{className:"error-icon-wrapper",children:E.jsx(xM,{size:48,className:"error-icon"})}),E.jsx("h1",{className:"error-title",children:"Algo sali mal"}),E.jsx("p",{className:"error-message",children:"Encontramos un problema inesperado. Por favor intenta recargar la pgina."}),!1,E.jsxs("button",{onClick:this.handleReload,className:"error-reload-btn",children:[E.jsx(wJ,{size:20}),E.jsx("span",{children:"Recargar"})]}),E.jsx("p",{className:"error-help-text",children:"Si el problema persiste, por favor contacta con soporte."})]})}):this.props.children}}DJ.createRoot(document.getElementById("root")).render(E.jsx(Fu.StrictMode,{children:E.jsx(Tie,{children:E.jsx(eJ,{basename:"/app",children:E.jsx(yie,{})})})}));
