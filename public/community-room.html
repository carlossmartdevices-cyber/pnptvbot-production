<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNPtv Community Room - 24/7 Live</title>
    <meta name="description" content="Join PNPtv's 24/7 Community Room for live video chat with the entire community.">
    <link rel="stylesheet" href="/unified-design.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--gradient-primary);
            color: var(--text-light);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title {
            font-family: var(--font-title);
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Apply BBH Bartle font to all headings */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-title);
        }

        .live-badge {
            background: var(--accent-red);
            color: var(--text-light);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .occupancy {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .occupancy-count {
            font-weight: bold;
            color: #4ade80;
        }

        .container {
            display: flex;
            flex: 1;
            gap: 0;
        }

        .video-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: #000;
        }

        #jitsi-meet {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 320px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .sidebar-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.1);
            border-bottom-color: var(--primary-color);
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .active-users {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .user-badge {
            background: var(--primary-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .user-badge.moderator {
            background: #ff6b6b;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .message-author {
            font-weight: bold;
            color: #4ade80;
            margin-bottom: 4px;
        }

        .message-text {
            word-wrap: break-word;
        }

        .message-time {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        .chat-input-group {
            display: flex;
            gap: 8px;
            margin-top: auto;
        }

        .chat-input-group input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 10px;
            color: #fff;
            font-size: 0.9em;
        }

        .chat-input-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-input-group button {
            background: var(--primary-color);
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .chat-input-group button:hover {
            background: #5568d3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            pointer-events: none;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            border-left: 3px solid var(--primary-color);
        }

        .leaderboard-rank {
            background: var(--primary-color);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8em;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
            }

            .container {
                flex-direction: column;
            }
        }
        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-modal.hidden {
            display: none;
        }

        .login-modal.show {
            display: flex;
        }

        .login-form {
            background: var(--gradient-primary);
            padding: 40px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .login-form h2 {
            margin-bottom: 10px;
            font-size: 1.8em;
            text-align: center;
        }

        .login-form p {
            text-align: center;
            margin-bottom: 25px;
            opacity: 0.9;
            font-size: 0.95em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95em;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-group input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-join {
            background: #fff;
            color: var(--primary-color);
        }

        .btn-join:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-guest {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-guest:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .telegram-btn {
            background: #0088cc;
            color: #fff;
            padding: 12px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .telegram-btn:hover {
            background: #0077b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .telegram-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .form-error {
            color: #ff6b6b;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 107, 107, 0.2);
            border-radius: 6px;
            display: none;
        }

        .form-error.show {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2>üëã Welcome</h2>
            <p>Join the PNPtv Community Room</p>

            <div id="loginContent">
                <div class="form-group">
                    <label for="displayNameInput">Display Name</label>
                    <input type="text" id="displayNameInput" placeholder="Enter your name">
                </div>

                <div class="form-group">
                    <label for="emailInput">Email (optional)</label>
                    <input type="email" id="emailInput" placeholder="your@email.com">
                </div>

                <button class="telegram-btn" id="telegramLoginBtn">
                    üîó Login with Telegram
                </button>

                <div class="form-error" id="formError"></div>

                <div class="form-buttons">
                    <button class="btn-join" id="joinBtn">Join</button>
                    <button class="btn-guest" id="guestBtn">Join as Guest</button>
                </div>
            </div>
        </div>
    </div>

    <div class="header">
        <div class="header-left">
            <h1 class="header-title">üé• PNPtv Community Room</h1>
            <span class="live-badge">üî¥ LIVE 24/7</span>
        </div>
        <div class="occupancy">
            <span>üë• Occupancy: </span>
            <span class="occupancy-count" id="occupancy">0/1000</span>
        </div>
    </div>

    <div class="container">
        <div class="video-container">
            <div id="jitsi-meet"></div>
            <div id="loadingMessage" class="loading-message">
                <h2>Loading Community Room...</h2>
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="chat">üí¨ Chat</button>
                <button class="tab-btn" data-tab="users">üë• Members</button>
                <button class="tab-btn" data-tab="stats">üìä Stats</button>
                <button class="tab-btn" data-tab="leaderboard">‚≠ê Top</button>
            </div>

            <!-- Chat Tab -->
            <div id="chat-tab" class="tab-content active">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-group">
                    <input type="text" id="messageInput" placeholder="Send a message...">
                    <button id="sendBtn">Send</button>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content">
                <div class="active-users" id="activeUsers"></div>
            </div>

            <!-- Stats Tab -->
            <div id="stats-tab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statActiveUsers">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statMessages">0</div>
                        <div class="stat-label">Messages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statModerators">0</div>
                        <div class="stat-label">Moderators</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statMembers">0</div>
                        <div class="stat-label">Members</div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboard-tab" class="tab-content">
                <div id="leaderboardList"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const jitsiDomain = '8x8.vc';
        const communityRoomName = 'pnptv-community';
        const apiBaseUrl = '/api';
        let displayName = '';
        let userId = '';
        let userEmail = '';

        // Check if Telegram Web App is available
        const tg = window.Telegram?.WebApp;
        const isTelegramWebApp = !!tg;

        // Initialize Telegram Web App if available
        if (tg) {
            tg.ready();
        }

        // Get user info from URL or session
        function getDisplayName() {
            return sessionStorage.getItem('jitsiDisplayName') || '';
        }

        function getUserId() {
            return sessionStorage.getItem('userId') || '';
        }

        // Handle Telegram Login Button
        document.getElementById('telegramLoginBtn').addEventListener('click', async () => {
            if (!isTelegramWebApp) {
                showError('Telegram Web App not available. Please use the Telegram app to access this feature.');
                return;
            }

            const user = tg.initDataUnsafe.user;
            if (!user) {
                showError('Could not get user data from Telegram.');
                return;
            }

            // Set user info from Telegram
            userId = user.id.toString();
            displayName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            userEmail = user.username ? `@${user.username}` : '';

            // Store in session
            sessionStorage.setItem('userId', userId);
            sessionStorage.setItem('jitsiDisplayName', displayName);
            sessionStorage.setItem('userEmail', userEmail);

            // Hide modal and initialize
            document.getElementById('loginModal').classList.add('hidden');
            await startCommunityRoom();
        });

        // Handle Join Button
        document.getElementById('joinBtn').addEventListener('click', async () => {
            const displayNameInput = document.getElementById('displayNameInput').value.trim();
            const emailInput = document.getElementById('emailInput').value.trim();

            if (!displayNameInput) {
                showError('Please enter a display name.');
                return;
            }

            displayName = displayNameInput;
            userId = 'user_' + Date.now();
            userEmail = emailInput || '';

            // Store in session
            sessionStorage.setItem('userId', userId);
            sessionStorage.setItem('jitsiDisplayName', displayName);
            sessionStorage.setItem('userEmail', userEmail);

            // Hide modal and initialize
            document.getElementById('loginModal').classList.add('hidden');
            await startCommunityRoom();
        });

        // Handle Guest Button
        document.getElementById('guestBtn').addEventListener('click', async () => {
            displayName = 'Guest ' + Math.floor(Math.random() * 10000);
            userId = 'guest_' + Date.now();
            userEmail = '';

            // Store in session
            sessionStorage.setItem('userId', userId);
            sessionStorage.setItem('jitsiDisplayName', displayName);
            sessionStorage.setItem('userEmail', userEmail);

            // Hide modal and initialize
            document.getElementById('loginModal').classList.add('hidden');
            await startCommunityRoom();
        });

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('formError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        // Check for existing session
        function checkExistingSession() {
            const savedDisplayName = getDisplayName();
            const savedUserId = getUserId();

            if (savedDisplayName && savedUserId) {
                displayName = savedDisplayName;
                userId = savedUserId;
                userEmail = sessionStorage.getItem('userEmail') || '';
                return true;
            }

            // Auto-start as guest if no session exists
            displayName = 'Guest ' + Math.floor(Math.random() * 10000);
            userId = 'guest_' + Date.now();
            userEmail = '';

            // Store in session
            sessionStorage.setItem('userId', userId);
            sessionStorage.setItem('jitsiDisplayName', displayName);
            sessionStorage.setItem('userEmail', userEmail);

            return true;
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });

        // Chat functionality
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            try {
                await fetch(`${apiBaseUrl}/community-room/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, displayName, message })
                });
                input.value = '';
                loadChatHistory();
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Load chat history
        async function loadChatHistory() {
            try {
                const response = await fetch(`${apiBaseUrl}/community-room/chat-history?limit=50`);
                const data = await response.json();
                if (data.success) {
                    const messagesDiv = document.getElementById('chatMessages');
                    messagesDiv.innerHTML = data.messages.map(msg => `
                        <div class="message">
                            <div class="message-author">${msg.displayName}</div>
                            <div class="message-text">${msg.message}</div>
                            <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                        </div>
                    `).join('');
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        // Update occupancy and stats
        async function updateRoomInfo() {
            try {
                const occupancyRes = await fetch(`${apiBaseUrl}/community-room/occupancy`);
                const occupancyData = await occupancyRes.json();
                if (occupancyData.success) {
                    document.getElementById('occupancy').textContent =
                        `${occupancyData.occupancy.activeUsers}/${occupancyData.occupancy.maxCapacity}`;
                }

                const statsRes = await fetch(`${apiBaseUrl}/community-room/stats`);
                const statsData = await statsRes.json();
                if (statsData.success) {
                    const stats = statsData.stats;
                    document.getElementById('statActiveUsers').textContent = stats.totalActiveUsers;
                    document.getElementById('statMessages').textContent = stats.messageCount;
                    document.getElementById('statModerators').textContent = stats.stats.moderators;
                    document.getElementById('statMembers').textContent = stats.stats.members;
                }

                const usersRes = await fetch(`${apiBaseUrl}/community-room/occupancy`);
                const usersData = await usersRes.json();
                if (usersData.success) {
                    const usersDiv = document.getElementById('activeUsers');
                    usersDiv.innerHTML = usersData.occupancy.users.map(user => `
                        <div class="user-item">
                            <span>${user.displayName}</span>
                            <span class="user-badge ${user.role === 'moderator' ? 'moderator' : ''}">${user.role}</span>
                        </div>
                    `).join('');
                }

                const leaderboardRes = await fetch(`${apiBaseUrl}/community-room/leaderboard?limit=10`);
                const leaderboardData = await leaderboardRes.json();
                if (leaderboardData.success) {
                    const leaderboardDiv = document.getElementById('leaderboardList');
                    leaderboardDiv.innerHTML = leaderboardData.leaderboard.map((user, idx) => `
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">#${idx + 1}</span>
                            <span>${user.displayName}</span>
                            <span>${Math.round((new Date() - new Date(user.joinedAt)) / 60000)} min</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error updating room info:', error);
            }
        }

        // Load Jitsi API
        function loadJitsiAPI() {
            return new Promise((resolve, reject) => {
                if (window.JitsiMeetExternalAPI) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://8x8.vc/vpaas-magic-cookie-6382ae83d7174b698c05093456a9e209/external_api.js';
                script.async = true;
                script.type = 'text/javascript';

                const scriptTimeout = setTimeout(() => {
                    script.onerror = null;
                    reject(new Error('Script load timeout'));
                }, 10000);

                script.onload = function() {
                    clearTimeout(scriptTimeout);
                    resolve();
                };

                script.onerror = function(error) {
                    clearTimeout(scriptTimeout);
                    reject(error);
                };

                document.head.appendChild(script);
            });
        }

        // Fetch JWT token
        async function fetchJwtToken() {
            try {
                const response = await fetch(`${apiBaseUrl}/community-room/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        roomName: communityRoomName,
                        userId,
                        displayName,
                        email: userEmail
                    })
                });

                if (!response.ok) {
                    console.warn(`Token fetch failed: ${response.status}, using guest token`);
                    // Return a minimal guest token if API fails
                    return null;
                }

                const data = await response.json();
                if (!data.success || !data.token) {
                    console.warn('Invalid token response, using guest token');
                    return null;
                }

                return data.token;
            } catch (error) {
                console.warn('Token fetch error, using guest token:', error);
                return null;
            }
        }

        // Initialize Jitsi
        function initializeJitsi(jwt) {
            if (!window.JitsiMeetExternalAPI) {
                throw new Error('JitsiMeetExternalAPI not available');
            }

            const options = {
                roomName: communityRoomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#jitsi-meet'),
                userInfo: { displayName, email: userEmail },
                interfaceConfigOverwrite: {
                    DEFAULT_LANGUAGE: 'en',
                    SHOW_JITSI_WATERMARK: false,
                    MOBILE_APP_PROMO: false,
                    DISABLE_FOCUS_INDICATOR: false
                },
                configOverwrite: {
                    startWithAudioMuted: false,
                    startWithVideoMuted: false,
                    prejoinPageEnabled: false,
                    enableWelcomePage: false,
                    chatEnabled: false,
                    requireDisplayName: false,
                    disableSimulcast: true,
                    enableP2P: false,
                    p2p: {
                        enabled: false
                    },
                    constraints: {
                        video: {
                            height: {
                                ideal: 720,
                                max: 720,
                                min: 240
                            }
                        }
                    },
                    // Allow participants to start meeting without moderator
                    conference: {
                        autoJoinAfterNextTopicChange: true
                    },
                    // Disable moderator-only restrictions - 24/7 open room
                    moderatedRoomServiceUrl: null,
                    jibriEnabled: false,
                    // Ensure no lobby/approval needed
                    lobbyEnabled: false,
                    restrictedRoomPrefix: null,
                    // Allow participant joining without moderator
                    policies: {
                        lockRoomGuestAccessOnStart: false
                    },
                    // Restrict moderator actions - even token moderators can't control others
                    toolbarButtons: [
                        'camera',
                        'microphone',
                        'desktop',
                        'fullscreen',
                        'settings'
                        // Explicitly exclude: 'hangup', 'raisehand', 'fodeviceselection'
                    ],
                    // Disable participant management features
                    disableAudioLevels: true,
                    enableLobbyMode: false,
                    enableRemoteControl: false,
                    enableFeaturedSpeaker: true,
                    enableSubtitles: false,
                    // Prevent muting/kicking of other participants
                    disallowModerator: false
                }
            };

            // Only add JWT if successfully obtained
            if (jwt) {
                options.jwt = jwt;
            }

            const api = new JitsiMeetExternalAPI(jitsiDomain, options);

            api.addEventListener('videoConferenceJoined', function() {
                console.log('Joined community room');
                document.getElementById('loadingMessage').style.display = 'none';
            });

            api.addEventListener('videoConferenceFailed', function(error) {
                console.error('Video conference failed:', error);
                document.getElementById('loadingMessage').innerHTML = `
                    <h2 style="color: var(--accent-red);">Connection Failed</h2>
                    <p>Unable to connect to the community room</p>
                    <p style="font-size: 0.9em; margin-top: 10px;"><a href="#" onclick="location.reload(); return false;" style="color: var(--primary-color);">Click here to retry</a></p>
                `;
            });

            return api;
        }

        // Start the community room after authentication
        async function startCommunityRoom() {
            try {
                console.log('Starting community room...');
                await loadJitsiAPI();

                // Start Jitsi without JWT - use guest access
                // The room is configured on 8x8 to allow guest access
                console.log('Starting Jitsi Meet in guest mode...');
                initializeJitsi(null);

                // Load initial data
                loadChatHistory();
                updateRoomInfo();

                // Update every 5 seconds
                setInterval(updateRoomInfo, 5000);
                setInterval(loadChatHistory, 3000);

            } catch (error) {
                console.error('Initialization failed:', error);
                document.error('Stack:', error.stack);
                document.getElementById('loadingMessage').innerHTML = `
                    <h2 style="color: var(--accent-red);">Connection Error</h2>
                    <p style="font-size: 0.95em; margin-top: 10px;">${error.message}</p>
                    <p style="font-size: 0.9em; margin-top: 10px;"><a href="javascript:location.reload()" style="color: var(--primary-color); text-decoration: underline;">Reload Page</a></p>
                    <p style="font-size: 0.85em; margin-top: 15px; opacity: 0.7;">If this error persists, please check your browser console (F12) for more details.</p>
                `;
            }
        }

        // Main initialization - auto-start as guest
        async function initialize() {
            try {
                console.log('Initializing community room...');

                // Always auto-start - check session first, then create guest session
                checkExistingSession();
                console.log('Starting community room with user:', displayName);
                document.getElementById('loginModal').classList.add('hidden');
                await startCommunityRoom();
            } catch (error) {
                console.error('Initialization failed:', error);
                showError('An error occurred. Please refresh the page.');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
