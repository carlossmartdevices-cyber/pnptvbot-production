<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PNPtv Haus - 24/7 Live</title>
    <meta name="description" content="Join PNPtv Haus for live video chat with the entire community.">
    <link rel="stylesheet" href="/unified-design.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            background: var(--gradient-primary);
            color: var(--text-light);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title {
            font-family: var(--font-title);
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* Apply BBH Bartle font to all headings */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-title);
        }

        .live-badge {
            background: var(--accent-red);
            color: var(--text-light);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .occupancy {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .occupancy-count {
            font-weight: bold;
            color: #4ade80;
        }

        .container {
            display: flex;
            flex: 1;
            gap: 0;
        }

        .video-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: #000;
        }

        #jitsi-meet {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 320px;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .sidebar-tabs {
            display: flex;
            gap: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            background: rgba(255, 255, 255, 0.1);
            border-bottom-color: var(--primary-color);
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .active-users {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .user-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .user-badge {
            background: var(--primary-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8em;
        }

        .user-badge.moderator {
            background: #ff6b6b;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            font-size: 0.85em;
        }

        .message-author {
            font-weight: bold;
            color: #4ade80;
            margin-bottom: 4px;
        }

        .message-text {
            word-wrap: break-word;
        }

        .message-time {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }

        .chat-input-group {
            display: flex;
            gap: 8px;
            margin-top: auto;
        }

        .chat-input-group input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 10px;
            color: #fff;
            font-size: 0.9em;
        }

        .chat-input-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-input-group button {
            background: var(--primary-color);
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }

        .chat-input-group button:hover {
            background: #5568d3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ade80;
        }

        .stat-label {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }

        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            pointer-events: none;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            border-left: 3px solid var(--primary-color);
        }

        .leaderboard-rank {
            background: var(--primary-color);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8em;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 200px;
            }

            .container {
                flex-direction: column;
            }
        }
        /* Login Modal Styles */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .login-modal.hidden {
            display: none;
        }

        .login-modal.show {
            display: flex;
        }

        .login-form {
            background: var(--gradient-primary);
            padding: 40px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .login-form h2 {
            margin-bottom: 10px;
            font-size: 1.8em;
            text-align: center;
        }

        .login-form p {
            text-align: center;
            margin-bottom: 25px;
            opacity: 0.9;
            font-size: 0.95em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95em;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .form-group input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .form-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
        }

        .btn-join {
            background: #fff;
            color: var(--primary-color);
        }

        .btn-join:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-guest {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-guest:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .telegram-btn {
            background: #0088cc;
            color: #fff;
            padding: 12px;
            border: none;
            border-radius: 8px;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .telegram-btn:hover {
            background: #0077b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .telegram-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .form-error {
            color: #ff6b6b;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 107, 107, 0.2);
            border-radius: 6px;
            display: none;
        }

        .form-error.show {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }

        /* Adult Content Warning Modal Styles */
        .adult-warning-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            overflow-y: auto;
        }

        .adult-warning-modal.active {
            display: flex;
        }

        .adult-warning-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(118, 75, 162, 0.15));
            border: 2px solid rgba(102, 126, 234, 0.5);
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            color: #fff;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
        }

        .warning-header {
            text-align: center;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 20px;
        }

        .warning-header h2 {
            margin-bottom: 15px;
            font-size: 1.8em;
        }

        .age-badge {
            display: inline-block;
            background: #ff0000;
            color: #fff;
            font-size: 1.5em;
            font-weight: bold;
            padding: 8px 20px;
            border-radius: 25px;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
        }

        .warning-body {
            margin-bottom: 20px;
        }

        .warning-section {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .warning-section h3 {
            margin-bottom: 12px;
            color: #ffd700;
            font-size: 1.15em;
        }

        .warning-section p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .warning-section ul {
            list-style: none;
            padding-left: 0;
            margin: 10px 0;
        }

        .warning-section ul li {
            padding: 6px 0;
            padding-left: 25px;
            position: relative;
            line-height: 1.5;
        }

        .warning-section ul li:before {
            content: "‚Ä¢";
            position: absolute;
            left: 8px;
            color: #667eea;
            font-weight: bold;
        }

        .legal-notice {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .legal-notice strong {
            color: #ffd700;
        }

        .legal-notice ul {
            list-style: none;
            padding-left: 0;
            margin-top: 12px;
        }

        .legal-notice ul li {
            padding: 8px 0;
            padding-left: 30px;
            position: relative;
            line-height: 1.6;
        }

        .legal-notice ul li:before {
            content: "‚úì";
            position: absolute;
            left: 8px;
            color: #00ff00;
            font-weight: bold;
            font-size: 1.1em;
        }

        .legal-notice a {
            color: #667eea;
            text-decoration: underline;
            transition: color 0.3s;
        }

        .legal-notice a:hover {
            color: #ffd700;
        }

        .warning-footer {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-decline,
        .btn-accept {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.05em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-decline {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-decline:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .btn-accept {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-accept:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn-accept:active {
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .adult-warning-content {
                padding: 20px;
                max-width: 95%;
                max-height: 95vh;
            }

            .warning-header h2 {
                font-size: 1.5em;
            }

            .warning-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .warning-section h3 {
                font-size: 1em;
            }

            .warning-footer {
                flex-direction: column;
                gap: 10px;
            }

            .btn-decline,
            .btn-accept {
                width: 100%;
                padding: 12px 20px;
                font-size: 1em;
            }

            .legal-notice {
                padding: 15px;
            }

            .age-badge {
                font-size: 1.3em;
                padding: 6px 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Adult Content Warning Modal (Popup) -->
    <div class="adult-warning-modal active" id="adultWarningModal">
        <div class="adult-warning-content">
            <div class="warning-header">
                <h2>‚ö†Ô∏è 18+ Content Warning</h2>
            </div>

            <div class="warning-body">
                <p style="margin-bottom: 15px; font-size: 1.05em; line-height: 1.6;">
                    This is an adult content room. By continuing, you confirm:
                </p>
                <ul style="list-style: none; padding: 0; margin: 15px 0;">
                    <li style="padding: 6px 0; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #00ff00;">‚úì</span>
                        You are 18 years or older
                    </li>
                    <li style="padding: 6px 0; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #00ff00;">‚úì</span>
                        You understand this room contains adult content
                    </li>
                    <li style="padding: 6px 0; padding-left: 25px; position: relative;">
                        <span style="position: absolute; left: 0; color: #00ff00;">üîí</span>
                        NO RECORDING - This is a private, safe space
                    </li>
                </ul>
            </div>

            <div class="warning-footer">
                <button class="btn-accept" id="acceptWarningBtn" style="width: 100%; margin-bottom: 10px;">I Agree - Enter</button>
                <button class="btn-decline" id="declineWarningBtn" style="width: 100%; font-size: 0.9em;">Decline</button>
            </div>
        </div>
    </div>
    <div class="login-modal" id="loginModal">
        <div class="login-form">
            <h2>üëã Welcome</h2>
            <p>Join PNPtv Haus</p>

            <div id="loginContent">
                <div class="form-group">
                    <label for="displayNameInput">Display Name</label>
                    <input type="text" id="displayNameInput" placeholder="Enter your name">
                </div>

                <div class="form-group">
                    <label for="emailInput">Email (optional)</label>
                    <input type="email" id="emailInput" placeholder="your@email.com">
                </div>

                <button class="telegram-btn" id="telegramLoginBtn">
                    üîó Login with Telegram
                </button>

                <div class="form-error" id="formError"></div>

                <div class="form-buttons">
                    <button class="btn-join" id="joinBtn">Join</button>
                    <button class="btn-guest" id="guestBtn">Join as Guest</button>
                </div>
            </div>
        </div>
    </div>

    <div class="privacy-banner" style="background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; padding: 12px 20px; text-align: center; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 10px;">
        <span style="font-size: 1.2em;">üîí</span>
        <span>Private & Secure: NO RECORDING ‚Ä¢ End-to-End Encrypted ‚Ä¢ Your Safety First</span>
    </div>

    <div class="header">
        <div class="header-left">
            <h1 class="header-title">üé• PNPtv Haus</h1>
            <span class="live-badge">üî¥ LIVE 24/7</span>
        </div>
        <div class="occupancy">
            <span>üë• Occupancy: </span>
            <span class="occupancy-count" id="occupancy">0/1000</span>
        </div>
    </div>

    <div class="container">
        <div class="video-container">
            <div id="jitsi-meet"></div>
            <div id="loadingMessage" class="loading-message">
                <h2>Loading PNPtv Haus...</h2>
                <div class="loading-spinner"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="chat">üí¨ Chat</button>
                <button class="tab-btn" data-tab="users">üë• Members</button>
                <button class="tab-btn" data-tab="stats">üìä Stats</button>
                <button class="tab-btn" data-tab="leaderboard">‚≠ê Top</button>
            </div>

            <!-- Chat Tab -->
            <div id="chat-tab" class="tab-content active">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input-group">
                    <input type="text" id="messageInput" placeholder="Send a message...">
                    <button id="sendBtn">Send</button>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users-tab" class="tab-content">
                <div class="active-users" id="activeUsers"></div>
            </div>

            <!-- Stats Tab -->
            <div id="stats-tab" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statActiveUsers">0</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statMessages">0</div>
                        <div class="stat-label">Messages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statModerators">0</div>
                        <div class="stat-label">Moderators</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statMembers">0</div>
                        <div class="stat-label">Members</div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard Tab -->
            <div id="leaderboard-tab" class="tab-content">
                <div id="leaderboardList"></div>
            </div>
        </div>
    </div>


        // Adult Content Warning Modal Handler
        (function() {
            const warningModal = document.getElementById('adultWarningModal');
            const acceptBtn = document.getElementById('acceptWarningBtn');
            const declineBtn = document.getElementById('declineWarningBtn');
            const CONSENT_KEY = 'pnptv_community_adult_consent';
            const CONSENT_TIMESTAMP_KEY = 'pnptv_community_consent_time';

            // Check if user has already consented in this session
            function checkExistingConsent() {
                const consent = sessionStorage.getItem(CONSENT_KEY);
                const timestamp = sessionStorage.getItem(CONSENT_TIMESTAMP_KEY);

                // Consent valid for current session only
                if (consent === 'true' && timestamp) {
                    const consentTime = new Date(timestamp);
                    const now = new Date();
                    // Consent valid for 4 hours per session
                    const hoursSinceConsent = (now - consentTime) / (1000 * 60 * 60);

                    if (hoursSinceConsent < 4) {
                        return true;
                    }
                }

                return false;
            }

            // Handle accept button
            acceptBtn.addEventListener('click', function() {
                // Store consent
                sessionStorage.setItem(CONSENT_KEY, 'true');
                sessionStorage.setItem(CONSENT_TIMESTAMP_KEY, new Date().toISOString());

                // Optional: Track consent in analytics (if implemented)
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'adult_content_consent', {
                        'event_category': 'compliance',
                        'event_label': 'community_room'
                    });
                }

                // Redirect directly to Jitsi room
                window.location.href = 'https://meet.jit.si/pnptv-main-room-1#config.prejoinPageEnabled=false&config.startWithAudioMuted=true&config.startWithVideoMuted=false&userInfo.displayName=User' + Date.now();
            });

            // Handle decline button
            declineBtn.addEventListener('click', function() {
                // Track decline in analytics (if implemented)
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'adult_content_decline', {
                        'event_category': 'compliance',
                        'event_label': 'community_room'
                    });
                }

                // Redirect to main site
                window.location.href = 'https://pnptv.app';
            });

            // Initialize on page load
            if (checkExistingConsent()) {
                // User already consented, hide warning modal
                warningModal.classList.remove('active');
            } else {
                // Show warning modal
                warningModal.classList.add('active');
                // Hide login modal until consent given
                document.getElementById('loginModal').classList.remove('show');
            }
        })();

    <script>
        // Configuration
        const jitsiDomain = '8x8.vc';
        const communityRoomName = 'pnptv-community';
        const apiBaseUrl = '/api';
        let displayName = '';
        let userId = '';
        let userEmail = '';

        // Check if Telegram Web App is available
        const tg = window.Telegram?.WebApp;
        const isTelegramWebApp = !!tg;

        // Initialize Telegram Web App if available
        if (tg) {
            tg.ready();

            // Auto-populate Telegram user info in form
            const user = tg.initDataUnsafe?.user;
            if (user) {
                const displayNameField = document.getElementById('displayNameInput');
                if (displayNameField && !displayNameField.value) {
                    const fullName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
                    displayNameField.value = fullName;
                }

                const emailField = document.getElementById('emailInput');
                if (emailField && !emailField.value && user.username) {
                    emailField.value = `@${user.username}`;
                }
            }
        }

        // Get user info from URL or session
        function getDisplayName() {
            return sessionStorage.getItem('jitsiDisplayName') || '';
        }

        function getUserId() {
            return sessionStorage.getItem('userId') || '';
        }

        // Handle Telegram Login Button
        document.getElementById('telegramLoginBtn').addEventListener('click', async () => {
            if (!isTelegramWebApp) {
                showError('Telegram Web App not available. Please use the Telegram app to access this feature.');
                return;
            }

            const user = tg.initDataUnsafe.user;
            if (!user) {
                showError('Could not get user data from Telegram.');
                return;
            }

            // Set user info from Telegram
            userId = user.id.toString();
            displayName = user.first_name + (user.last_name ? ' ' + user.last_name : '');
            userEmail = user.username ? `@${user.username}` : '';

            // Store in session
            sessionStorage.setItem('userId', userId);
            sessionStorage.setItem('jitsiDisplayName', displayName);
            sessionStorage.setItem('userEmail', userEmail);

            // Hide modal and initialize
            document.getElementById('loginModal').classList.add('hidden');
            await startCommunityRoom();
        });

        // Handle Join Button
        document.getElementById('joinBtn').addEventListener('click', async () => {
            const displayNameInput = document.getElementById('displayNameInput').value.trim();
            const emailInput = document.getElementById('emailInput').value.trim();

            if (!displayNameInput) {
                showError('Please enter a display name.');
                return;
            }

            displayName = displayNameInput;
            userId = 'user_' + Date.now();
            userEmail = emailInput || '';

            // Store in session
            sessionStorage.setItem('userId', userId);
            sessionStorage.setItem('jitsiDisplayName', displayName);
            sessionStorage.setItem('userEmail', userEmail);

            // Hide modal and initialize
            document.getElementById('loginModal').classList.add('hidden');
            await startCommunityRoom();
        });

        // Handle Guest Button
        document.getElementById('guestBtn').addEventListener('click', async () => {
            displayName = 'Guest ' + Math.floor(Math.random() * 10000);
            userId = 'guest_' + Date.now();
            userEmail = '';

            // Store in session
            sessionStorage.setItem('userId', userId);
            sessionStorage.setItem('jitsiDisplayName', displayName);
            sessionStorage.setItem('userEmail', userEmail);

            // Hide modal and initialize
            document.getElementById('loginModal').classList.add('hidden');
            await startCommunityRoom();
        });

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('formError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        // Check for existing session
        function checkExistingSession() {
            // First check if adult content consent was given
            const adultConsent = sessionStorage.getItem('pnptv_community_adult_consent');
            if (adultConsent !== 'true') {
                return false; // Don't auto-start if no consent
            }

            const savedDisplayName = getDisplayName();
            const savedUserId = getUserId();

            if (savedDisplayName && savedUserId) {
                displayName = savedDisplayName;
                userId = savedUserId;
                userEmail = sessionStorage.getItem('userEmail') || '';
                return true;
            }

            // Auto-start as guest if consent given but no session
            displayName = 'Guest ' + Math.floor(Math.random() * 10000);
            userId = 'guest_' + Date.now();
            userEmail = '';

            // Store in session
            sessionStorage.setItem('userId', userId);
            sessionStorage.setItem('jitsiDisplayName', displayName);
            sessionStorage.setItem('userEmail', userEmail);

            return true;
        }

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });

        // Chat functionality
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            try {
                await fetch(`${apiBaseUrl}/community-room/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, displayName, message })
                });
                input.value = '';
                loadChatHistory();
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Load chat history
        async function loadChatHistory() {
            try {
                const response = await fetch(`${apiBaseUrl}/community-room/chat-history?limit=50`);
                const data = await response.json();
                if (data.success) {
                    const messagesDiv = document.getElementById('chatMessages');
                    messagesDiv.innerHTML = data.messages.map(msg => `
                        <div class="message">
                            <div class="message-author">${msg.displayName}</div>
                            <div class="message-text">${msg.message}</div>
                            <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
                        </div>
                    `).join('');
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        // Update occupancy and stats
        async function updateRoomInfo() {
            try {
                const occupancyRes = await fetch(`${apiBaseUrl}/community-room/occupancy`);
                const occupancyData = await occupancyRes.json();
                if (occupancyData.success) {
                    document.getElementById('occupancy').textContent =
                        `${occupancyData.occupancy.activeUsers}/${occupancyData.occupancy.maxCapacity}`;
                }

                const statsRes = await fetch(`${apiBaseUrl}/community-room/stats`);
                const statsData = await statsRes.json();
                if (statsData.success) {
                    const stats = statsData.stats;
                    document.getElementById('statActiveUsers').textContent = stats.totalActiveUsers;
                    document.getElementById('statMessages').textContent = stats.messageCount;
                    document.getElementById('statModerators').textContent = stats.stats.moderators;
                    document.getElementById('statMembers').textContent = stats.stats.members;
                }

                const usersRes = await fetch(`${apiBaseUrl}/community-room/occupancy`);
                const usersData = await usersRes.json();
                if (usersData.success) {
                    const usersDiv = document.getElementById('activeUsers');
                    usersDiv.innerHTML = usersData.occupancy.users.map(user => `
                        <div class="user-item">
                            <span>${user.displayName}</span>
                            <span class="user-badge ${user.role === 'moderator' ? 'moderator' : ''}">${user.role}</span>
                        </div>
                    `).join('');
                }

                const leaderboardRes = await fetch(`${apiBaseUrl}/community-room/leaderboard?limit=10`);
                const leaderboardData = await leaderboardRes.json();
                if (leaderboardData.success) {
                    const leaderboardDiv = document.getElementById('leaderboardList');
                    leaderboardDiv.innerHTML = leaderboardData.leaderboard.map((user, idx) => `
                        <div class="leaderboard-item">
                            <span class="leaderboard-rank">#${idx + 1}</span>
                            <span>${user.displayName}</span>
                            <span>${Math.round((new Date() - new Date(user.joinedAt)) / 60000)} min</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error updating room info:', error);
            }
        }

        // Load Jitsi API
        function loadJitsiAPI() {
            return new Promise((resolve, reject) => {
                if (window.JitsiMeetExternalAPI) {
                    resolve();
                    return;
                }

                const script = document.createElement('script');
                script.src = 'https://8x8.vc/vpaas-magic-cookie-6382ae83d7174b698c05093456a9e209/external_api.js';
                script.async = true;
                script.type = 'text/javascript';

                const scriptTimeout = setTimeout(() => {
                    script.onerror = null;
                    reject(new Error('Script load timeout'));
                }, 10000);

                script.onload = function() {
                    clearTimeout(scriptTimeout);
                    resolve();
                };

                script.onerror = function(error) {
                    clearTimeout(scriptTimeout);
                    reject(error);
                };

                document.head.appendChild(script);
            });
        }

        // Fetch JWT token
        async function fetchJwtToken() {
            try {
                const response = await fetch(`${apiBaseUrl}/community-room/join`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        roomName: communityRoomName,
                        userId,
                        displayName,
                        email: userEmail
                    })
                });

                if (!response.ok) {
                    console.warn(`Token fetch failed: ${response.status}, using guest token`);
                    // Return a minimal guest token if API fails
                    return null;
                }

                const data = await response.json();
                if (!data.success || !data.token) {
                    console.warn('Invalid token response, using guest token');
                    return null;
                }

                return data.token;
            } catch (error) {
                console.warn('Token fetch error, using guest token:', error);
                return null;
            }
        }

        // Initialize Jitsi
        function initializeJitsi(jwt) {
            if (!window.JitsiMeetExternalAPI) {
                throw new Error('JitsiMeetExternalAPI not available');
            }

            const options = {
                roomName: communityRoomName,
                width: '100%',
                height: '100%',
                parentNode: document.querySelector('#jitsi-meet'),
                userInfo: { displayName, email: userEmail },
                interfaceConfigOverwrite: {
                    DEFAULT_LANGUAGE: 'en',
                    SHOW_JITSI_WATERMARK: false,
                    MOBILE_APP_PROMO: false,
                    DISABLE_FOCUS_INDICATOR: false
                },
                configOverwrite: {
                    startWithAudioMuted: true,
                    startWithVideoMuted: false,
                    prejoinPageEnabled: false,
                    enableWelcomePage: false,
                    chatEnabled: false,
                    requireDisplayName: false,
                    disableSimulcast: true,
                    enableP2P: false,
                    p2p: {
                        enabled: false
                    },
                    constraints: {
                        video: {
                            height: {
                                ideal: 720,
                                max: 720,
                                min: 240
                            }
                        }
                    },
                    // Allow participants to start meeting without moderator
                    conference: {
                        autoJoinAfterNextTopicChange: true
                    },
                    // Disable moderator-only restrictions - 24/7 open room
                    moderatedRoomServiceUrl: null,
                    jibriEnabled: false,
                    // Ensure no lobby/approval needed
                    lobbyEnabled: false,
                    restrictedRoomPrefix: null,
                    // Allow participant joining without moderator
                    policies: {
                        lockRoomGuestAccessOnStart: false
                    },
                    // Restrict moderator actions - even token moderators can't control others
                    toolbarButtons: [
                        'camera',
                        'microphone',
                        'desktop',
                        'fullscreen',
                        'settings'
                        // Explicitly exclude: 'hangup', 'raisehand', 'fodeviceselection'
                    ],
                    // Disable participant management features
                    disableAudioLevels: true,
                    enableLobbyMode: false,
                    enableRemoteControl: false,
                    enableFeaturedSpeaker: true,
                    enableSubtitles: false,
                    // Prevent muting/kicking of other participants
                    disallowModerator: false
                }
            };

            // Only add JWT if successfully obtained
            if (jwt) {
                options.jwt = jwt;
            }

            const api = new JitsiMeetExternalAPI(jitsiDomain, options);

            api.addEventListener('videoConferenceJoined', function() {
                console.log('Joined community room');
                document.getElementById('loadingMessage').style.display = 'none';
            });

            api.addEventListener('videoConferenceFailed', function(error) {
                console.error('Video conference failed:', error);
                document.getElementById('loadingMessage').innerHTML = `
                    <h2 style="color: var(--accent-red);">Connection Failed</h2>
                    <p>Unable to connect to the community room</p>
                    <p style="font-size: 0.9em; margin-top: 10px;"><a href="#" onclick="location.reload(); return false;" style="color: var(--primary-color);">Click here to retry</a></p>
                `;
            });

            return api;
        }

        // Start the community room after authentication
        async function startCommunityRoom() {
            try {
                console.log('Starting community room...');
                await loadJitsiAPI();

                // Start Jitsi without JWT - use guest access
                // The room is configured on 8x8 to allow guest access
                console.log('Starting Jitsi Meet in guest mode...');
                initializeJitsi(null);

                // Load initial data
                loadChatHistory();
                updateRoomInfo();

                // Update every 5 seconds
                setInterval(updateRoomInfo, 5000);
                setInterval(loadChatHistory, 3000);

            } catch (error) {
                console.error('Initialization failed:', error);
                document.error('Stack:', error.stack);
                document.getElementById('loadingMessage').innerHTML = `
                    <h2 style="color: var(--accent-red);">Connection Error</h2>
                    <p style="font-size: 0.95em; margin-top: 10px;">${error.message}</p>
                    <p style="font-size: 0.9em; margin-top: 10px;"><a href="javascript:location.reload()" style="color: var(--primary-color); text-decoration: underline;">Reload Page</a></p>
                    <p style="font-size: 0.85em; margin-top: 15px; opacity: 0.7;">If this error persists, please check your browser console (F12) for more details.</p>
                `;
            }
        }

        // Adult Content Warning Modal Handler
        (function() {
            const warningModal = document.getElementById('adultWarningModal');
            const acceptBtn = document.getElementById('acceptWarningBtn');
            const declineBtn = document.getElementById('declineWarningBtn');
            const CONSENT_KEY = 'pnptv_community_adult_consent';
            const CONSENT_TIMESTAMP_KEY = 'pnptv_community_consent_time';

            // Check if user has already consented in this session
            function checkExistingConsent() {
                const consent = sessionStorage.getItem(CONSENT_KEY);
                const timestamp = sessionStorage.getItem(CONSENT_TIMESTAMP_KEY);

                // Consent valid for current session only
                if (consent === 'true' && timestamp) {
                    const consentTime = new Date(timestamp);
                    const now = new Date();
                    // Consent valid for 4 hours per session
                    const hoursSinceConsent = (now - consentTime) / (1000 * 60 * 60);

                    if (hoursSinceConsent < 4) {
                        return true;
                    }
                }

                return false;
            }

            // Handle accept button
            acceptBtn.addEventListener('click', function() {
                // Store consent
                sessionStorage.setItem(CONSENT_KEY, 'true');
                sessionStorage.setItem(CONSENT_TIMESTAMP_KEY, new Date().toISOString());

                // Optional: Track consent in analytics (if implemented)
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'adult_content_consent', {
                        'event_category': 'compliance',
                        'event_label': 'community_room'
                    });
                }

                // Hide warning modal
                warningModal.classList.remove('active');
                // Show login modal (if user not already logged in)
                const existingSession = checkExistingSession();
                if (!existingSession) {
                    document.getElementById('loginModal').classList.remove('hidden');
                } else {
                    document.getElementById('loginModal').classList.add('hidden');
                }
            });

            // Handle decline button
            declineBtn.addEventListener('click', function() {
                // Track decline in analytics (if implemented)
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'adult_content_decline', {
                        'event_category': 'compliance',
                        'event_label': 'community_room'
                    });
                }

                // Redirect to main site
                window.location.href = 'https://pnptv.app';
            });

            // Initialize on page load
            if (checkExistingConsent()) {
                // User already consented, hide warning modal
                warningModal.classList.remove('active');
            } else {
                // Show warning modal
                warningModal.classList.add('active');
                // Hide login modal until consent given
                document.getElementById('loginModal').classList.add('hidden');
            }
        })();

        // Main initialization - auto-start as guest
        async function initialize() {
            try {
                console.log('Initializing community room...');

                // Always auto-start - check session first, then create guest session
                checkExistingSession();
                console.log('Starting community room with user:', displayName);
                document.getElementById('loginModal').classList.add('hidden');
                await startCommunityRoom();
            } catch (error) {
                console.error('Initialization failed:', error);
                showError('An error occurred. Please refresh the page.');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
