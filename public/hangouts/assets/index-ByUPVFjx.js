(function(){const d=document.createElement("link").relList;if(d&&d.supports&&d.supports("modulepreload"))return;for(const S of document.querySelectorAll('link[rel="modulepreload"]'))m(S);new MutationObserver(S=>{for(const C of S)if(C.type==="childList")for(const N of C.addedNodes)N.tagName==="LINK"&&N.rel==="modulepreload"&&m(N)}).observe(document,{childList:!0,subtree:!0});function p(S){const C={};return S.integrity&&(C.integrity=S.integrity),S.referrerPolicy&&(C.referrerPolicy=S.referrerPolicy),S.crossOrigin==="use-credentials"?C.credentials="include":S.crossOrigin==="anonymous"?C.credentials="omit":C.credentials="same-origin",C}function m(S){if(S.ep)return;S.ep=!0;const C=p(S);fetch(S.href,C)}})();var $m=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function VV(a){return a&&a.__esModule&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a}var FV={exports:{}},tg={},BV={exports:{}},Gt={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Gp=Symbol.for("react.element"),dZ=Symbol.for("react.portal"),lZ=Symbol.for("react.fragment"),uZ=Symbol.for("react.strict_mode"),hZ=Symbol.for("react.profiler"),pZ=Symbol.for("react.provider"),fZ=Symbol.for("react.context"),_Z=Symbol.for("react.forward_ref"),mZ=Symbol.for("react.suspense"),EZ=Symbol.for("react.memo"),gZ=Symbol.for("react.lazy"),Rx=Symbol.iterator;function SZ(a){return a===null||typeof a!="object"?null:(a=Rx&&a[Rx]||a["@@iterator"],typeof a=="function"?a:null)}var jV={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},GV=Object.assign,WV={};function vu(a,d,p){this.props=a,this.context=d,this.refs=WV,this.updater=p||jV}vu.prototype.isReactComponent={};vu.prototype.setState=function(a,d){if(typeof a!="object"&&typeof a!="function"&&a!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,a,d,"setState")};vu.prototype.forceUpdate=function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};function HV(){}HV.prototype=vu.prototype;function cI(a,d,p){this.props=a,this.context=d,this.refs=WV,this.updater=p||jV}var dI=cI.prototype=new HV;dI.constructor=cI;GV(dI,vu.prototype);dI.isPureReactComponent=!0;var yx=Array.isArray,KV=Object.prototype.hasOwnProperty,lI={current:null},YV={key:!0,ref:!0,__self:!0,__source:!0};function zV(a,d,p){var m,S={},C=null,N=null;if(d!=null)for(m in d.ref!==void 0&&(N=d.ref),d.key!==void 0&&(C=""+d.key),d)KV.call(d,m)&&!YV.hasOwnProperty(m)&&(S[m]=d[m]);var F=arguments.length-2;if(F===1)S.children=p;else if(1<F){for(var x=Array(F),X=0;X<F;X++)x[X]=arguments[X+2];S.children=x}if(a&&a.defaultProps)for(m in F=a.defaultProps,F)S[m]===void 0&&(S[m]=F[m]);return{$$typeof:Gp,type:a,key:C,ref:N,props:S,_owner:lI.current}}function TZ(a,d){return{$$typeof:Gp,type:a.type,key:d,ref:a.ref,props:a.props,_owner:a._owner}}function uI(a){return typeof a=="object"&&a!==null&&a.$$typeof===Gp}function vZ(a){var d={"=":"=0",":":"=2"};return"$"+a.replace(/[=:]/g,function(p){return d[p]})}var Cx=/\/+/g;function Gy(a,d){return typeof a=="object"&&a!==null&&a.key!=null?vZ(""+a.key):d.toString(36)}function EE(a,d,p,m,S){var C=typeof a;(C==="undefined"||C==="boolean")&&(a=null);var N=!1;if(a===null)N=!0;else switch(C){case"string":case"number":N=!0;break;case"object":switch(a.$$typeof){case Gp:case dZ:N=!0}}if(N)return N=a,S=S(N),a=m===""?"."+Gy(N,0):m,yx(S)?(p="",a!=null&&(p=a.replace(Cx,"$&/")+"/"),EE(S,d,p,"",function(X){return X})):S!=null&&(uI(S)&&(S=TZ(S,p+(!S.key||N&&N.key===S.key?"":(""+S.key).replace(Cx,"$&/")+"/")+a)),d.push(S)),1;if(N=0,m=m===""?".":m+":",yx(a))for(var F=0;F<a.length;F++){C=a[F];var x=m+Gy(C,F);N+=EE(C,d,p,x,S)}else if(x=SZ(a),typeof x=="function")for(a=x.call(a),F=0;!(C=a.next()).done;)C=C.value,x=m+Gy(C,F++),N+=EE(C,d,p,x,S);else if(C==="object")throw d=String(a),Error("Objects are not valid as a React child (found: "+(d==="[object Object]"?"object with keys {"+Object.keys(a).join(", ")+"}":d)+"). If you meant to render a collection of children, use an array instead.");return N}function eE(a,d,p){if(a==null)return a;var m=[],S=0;return EE(a,m,"","",function(C){return d.call(p,C,S++)}),m}function RZ(a){if(a._status===-1){var d=a._result;d=d(),d.then(function(p){(a._status===0||a._status===-1)&&(a._status=1,a._result=p)},function(p){(a._status===0||a._status===-1)&&(a._status=2,a._result=p)}),a._status===-1&&(a._status=0,a._result=d)}if(a._status===1)return a._result.default;throw a._result}var ai={current:null},gE={transition:null},yZ={ReactCurrentDispatcher:ai,ReactCurrentBatchConfig:gE,ReactCurrentOwner:lI};function qV(){throw Error("act(...) is not supported in production builds of React.")}Gt.Children={map:eE,forEach:function(a,d,p){eE(a,function(){d.apply(this,arguments)},p)},count:function(a){var d=0;return eE(a,function(){d++}),d},toArray:function(a){return eE(a,function(d){return d})||[]},only:function(a){if(!uI(a))throw Error("React.Children.only expected to receive a single React element child.");return a}};Gt.Component=vu;Gt.Fragment=lZ;Gt.Profiler=hZ;Gt.PureComponent=cI;Gt.StrictMode=uZ;Gt.Suspense=mZ;Gt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=yZ;Gt.act=qV;Gt.cloneElement=function(a,d,p){if(a==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+a+".");var m=GV({},a.props),S=a.key,C=a.ref,N=a._owner;if(d!=null){if(d.ref!==void 0&&(C=d.ref,N=lI.current),d.key!==void 0&&(S=""+d.key),a.type&&a.type.defaultProps)var F=a.type.defaultProps;for(x in d)KV.call(d,x)&&!YV.hasOwnProperty(x)&&(m[x]=d[x]===void 0&&F!==void 0?F[x]:d[x])}var x=arguments.length-2;if(x===1)m.children=p;else if(1<x){F=Array(x);for(var X=0;X<x;X++)F[X]=arguments[X+2];m.children=F}return{$$typeof:Gp,type:a.type,key:S,ref:C,props:m,_owner:N}};Gt.createContext=function(a){return a={$$typeof:fZ,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},a.Provider={$$typeof:pZ,_context:a},a.Consumer=a};Gt.createElement=zV;Gt.createFactory=function(a){var d=zV.bind(null,a);return d.type=a,d};Gt.createRef=function(){return{current:null}};Gt.forwardRef=function(a){return{$$typeof:_Z,render:a}};Gt.isValidElement=uI;Gt.lazy=function(a){return{$$typeof:gZ,_payload:{_status:-1,_result:a},_init:RZ}};Gt.memo=function(a,d){return{$$typeof:EZ,type:a,compare:d===void 0?null:d}};Gt.startTransition=function(a){var d=gE.transition;gE.transition={};try{a()}finally{gE.transition=d}};Gt.unstable_act=qV;Gt.useCallback=function(a,d){return ai.current.useCallback(a,d)};Gt.useContext=function(a){return ai.current.useContext(a)};Gt.useDebugValue=function(){};Gt.useDeferredValue=function(a){return ai.current.useDeferredValue(a)};Gt.useEffect=function(a,d){return ai.current.useEffect(a,d)};Gt.useId=function(){return ai.current.useId()};Gt.useImperativeHandle=function(a,d,p){return ai.current.useImperativeHandle(a,d,p)};Gt.useInsertionEffect=function(a,d){return ai.current.useInsertionEffect(a,d)};Gt.useLayoutEffect=function(a,d){return ai.current.useLayoutEffect(a,d)};Gt.useMemo=function(a,d){return ai.current.useMemo(a,d)};Gt.useReducer=function(a,d,p){return ai.current.useReducer(a,d,p)};Gt.useRef=function(a){return ai.current.useRef(a)};Gt.useState=function(a){return ai.current.useState(a)};Gt.useSyncExternalStore=function(a,d,p){return ai.current.useSyncExternalStore(a,d,p)};Gt.useTransition=function(){return ai.current.useTransition()};Gt.version="18.3.1";BV.exports=Gt;var et=BV.exports;const CZ=VV(et);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var IZ=et,wZ=Symbol.for("react.element"),AZ=Symbol.for("react.fragment"),bZ=Object.prototype.hasOwnProperty,OZ=IZ.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,NZ={key:!0,ref:!0,__self:!0,__source:!0};function XV(a,d,p){var m,S={},C=null,N=null;p!==void 0&&(C=""+p),d.key!==void 0&&(C=""+d.key),d.ref!==void 0&&(N=d.ref);for(m in d)bZ.call(d,m)&&!NZ.hasOwnProperty(m)&&(S[m]=d[m]);if(a&&a.defaultProps)for(m in d=a.defaultProps,d)S[m]===void 0&&(S[m]=d[m]);return{$$typeof:wZ,type:a,key:C,ref:N,props:S,_owner:OZ.current}}tg.Fragment=AZ;tg.jsx=XV;tg.jsxs=XV;FV.exports=tg;var G=FV.exports,_C={},JV={exports:{}},zi={},QV={exports:{}},ZV={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(a){function d(be,lt){var gt=be.length;be.push(lt);e:for(;0<gt;){var Rn=gt-1>>>1,tn=be[Rn];if(0<S(tn,lt))be[Rn]=lt,be[gt]=tn,gt=Rn;else break e}}function p(be){return be.length===0?null:be[0]}function m(be){if(be.length===0)return null;var lt=be[0],gt=be.pop();if(gt!==lt){be[0]=gt;e:for(var Rn=0,tn=be.length,Io=tn>>>1;Rn<Io;){var Fn=2*(Rn+1)-1,Ls=be[Fn],Br=Fn+1,Xi=be[Br];if(0>S(Ls,gt))Br<tn&&0>S(Xi,Ls)?(be[Rn]=Xi,be[Br]=gt,Rn=Br):(be[Rn]=Ls,be[Fn]=gt,Rn=Fn);else if(Br<tn&&0>S(Xi,gt))be[Rn]=Xi,be[Br]=gt,Rn=Br;else break e}}return lt}function S(be,lt){var gt=be.sortIndex-lt.sortIndex;return gt!==0?gt:be.id-lt.id}if(typeof performance=="object"&&typeof performance.now=="function"){var C=performance;a.unstable_now=function(){return C.now()}}else{var N=Date,F=N.now();a.unstable_now=function(){return N.now()-F}}var x=[],X=[],_e=1,oe=null,re=3,Ce=!1,fe=!1,Oe=!1,Vt=typeof setTimeout=="function"?setTimeout:null,J=typeof clearTimeout=="function"?clearTimeout:null,K=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function Q(be){for(var lt=p(X);lt!==null;){if(lt.callback===null)m(X);else if(lt.startTime<=be)m(X),lt.sortIndex=lt.expirationTime,d(x,lt);else break;lt=p(X)}}function Te(be){if(Oe=!1,Q(be),!fe)if(p(x)!==null)fe=!0,Fr(Ve);else{var lt=p(X);lt!==null&&$t(Te,lt.startTime-be)}}function Ve(be,lt){fe=!1,Oe&&(Oe=!1,J(ze),ze=-1),Ce=!0;var gt=re;try{for(Q(lt),oe=p(x);oe!==null&&(!(oe.expirationTime>lt)||be&&!Ye());){var Rn=oe.callback;if(typeof Rn=="function"){oe.callback=null,re=oe.priorityLevel;var tn=Rn(oe.expirationTime<=lt);lt=a.unstable_now(),typeof tn=="function"?oe.callback=tn:oe===p(x)&&m(x),Q(lt)}else m(x);oe=p(x)}if(oe!==null)var Io=!0;else{var Fn=p(X);Fn!==null&&$t(Te,Fn.startTime-lt),Io=!1}return Io}finally{oe=null,re=gt,Ce=!1}}var Be=!1,Me=null,ze=-1,Kt=5,ht=-1;function Ye(){return!(a.unstable_now()-ht<Kt)}function qe(){if(Me!==null){var be=a.unstable_now();ht=be;var lt=!0;try{lt=Me(!0,be)}finally{lt?Tn():(Be=!1,Me=null)}}else Be=!1}var Tn;if(typeof K=="function")Tn=function(){K(qe)};else if(typeof MessageChannel<"u"){var At=new MessageChannel,rr=At.port2;At.port1.onmessage=qe,Tn=function(){rr.postMessage(null)}}else Tn=function(){Vt(qe,0)};function Fr(be){Me=be,Be||(Be=!0,Tn())}function $t(be,lt){ze=Vt(function(){be(a.unstable_now())},lt)}a.unstable_IdlePriority=5,a.unstable_ImmediatePriority=1,a.unstable_LowPriority=4,a.unstable_NormalPriority=3,a.unstable_Profiling=null,a.unstable_UserBlockingPriority=2,a.unstable_cancelCallback=function(be){be.callback=null},a.unstable_continueExecution=function(){fe||Ce||(fe=!0,Fr(Ve))},a.unstable_forceFrameRate=function(be){0>be||125<be?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):Kt=0<be?Math.floor(1e3/be):5},a.unstable_getCurrentPriorityLevel=function(){return re},a.unstable_getFirstCallbackNode=function(){return p(x)},a.unstable_next=function(be){switch(re){case 1:case 2:case 3:var lt=3;break;default:lt=re}var gt=re;re=lt;try{return be()}finally{re=gt}},a.unstable_pauseExecution=function(){},a.unstable_requestPaint=function(){},a.unstable_runWithPriority=function(be,lt){switch(be){case 1:case 2:case 3:case 4:case 5:break;default:be=3}var gt=re;re=be;try{return lt()}finally{re=gt}},a.unstable_scheduleCallback=function(be,lt,gt){var Rn=a.unstable_now();switch(typeof gt=="object"&&gt!==null?(gt=gt.delay,gt=typeof gt=="number"&&0<gt?Rn+gt:Rn):gt=Rn,be){case 1:var tn=-1;break;case 2:tn=250;break;case 5:tn=1073741823;break;case 4:tn=1e4;break;default:tn=5e3}return tn=gt+tn,be={id:_e++,callback:lt,priorityLevel:be,startTime:gt,expirationTime:tn,sortIndex:-1},gt>Rn?(be.sortIndex=gt,d(X,be),p(x)===null&&be===p(X)&&(Oe?(J(ze),ze=-1):Oe=!0,$t(Te,gt-Rn))):(be.sortIndex=tn,d(x,be),fe||Ce||(fe=!0,Fr(Ve))),be},a.unstable_shouldYield=Ye,a.unstable_wrapCallback=function(be){var lt=re;return function(){var gt=re;re=lt;try{return be.apply(this,arguments)}finally{re=gt}}}})(ZV);QV.exports=ZV;var DZ=QV.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var PZ=et,Yi=DZ;function ye(a){for(var d="https://reactjs.org/docs/error-decoder.html?invariant="+a,p=1;p<arguments.length;p++)d+="&args[]="+encodeURIComponent(arguments[p]);return"Minified React error #"+a+"; visit "+d+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var $V=new Set,Ip={};function vd(a,d){fu(a,d),fu(a+"Capture",d)}function fu(a,d){for(Ip[a]=d,a=0;a<d.length;a++)$V.add(d[a])}var ta=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),mC=Object.prototype.hasOwnProperty,LZ=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,Ix={},wx={};function kZ(a){return mC.call(wx,a)?!0:mC.call(Ix,a)?!1:LZ.test(a)?wx[a]=!0:(Ix[a]=!0,!1)}function MZ(a,d,p,m){if(p!==null&&p.type===0)return!1;switch(typeof d){case"function":case"symbol":return!0;case"boolean":return m?!1:p!==null?!p.acceptsBooleans:(a=a.toLowerCase().slice(0,5),a!=="data-"&&a!=="aria-");default:return!1}}function UZ(a,d,p,m){if(d===null||typeof d>"u"||MZ(a,d,p,m))return!0;if(m)return!1;if(p!==null)switch(p.type){case 3:return!d;case 4:return d===!1;case 5:return isNaN(d);case 6:return isNaN(d)||1>d}return!1}function ci(a,d,p,m,S,C,N){this.acceptsBooleans=d===2||d===3||d===4,this.attributeName=m,this.attributeNamespace=S,this.mustUseProperty=p,this.propertyName=a,this.type=d,this.sanitizeURL=C,this.removeEmptyString=N}var Vr={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){Vr[a]=new ci(a,0,!1,a,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var d=a[0];Vr[d]=new ci(d,1,!1,a[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){Vr[a]=new ci(a,2,!1,a.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){Vr[a]=new ci(a,2,!1,a,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){Vr[a]=new ci(a,3,!1,a.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(a){Vr[a]=new ci(a,3,!0,a,null,!1,!1)});["capture","download"].forEach(function(a){Vr[a]=new ci(a,4,!1,a,null,!1,!1)});["cols","rows","size","span"].forEach(function(a){Vr[a]=new ci(a,6,!1,a,null,!1,!1)});["rowSpan","start"].forEach(function(a){Vr[a]=new ci(a,5,!1,a.toLowerCase(),null,!1,!1)});var hI=/[\-:]([a-z])/g;function pI(a){return a[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var d=a.replace(hI,pI);Vr[d]=new ci(d,1,!1,a,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var d=a.replace(hI,pI);Vr[d]=new ci(d,1,!1,a,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var d=a.replace(hI,pI);Vr[d]=new ci(d,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(a){Vr[a]=new ci(a,1,!1,a.toLowerCase(),null,!1,!1)});Vr.xlinkHref=new ci("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(a){Vr[a]=new ci(a,1,!1,a.toLowerCase(),null,!0,!0)});function fI(a,d,p,m){var S=Vr.hasOwnProperty(d)?Vr[d]:null;(S!==null?S.type!==0:m||!(2<d.length)||d[0]!=="o"&&d[0]!=="O"||d[1]!=="n"&&d[1]!=="N")&&(UZ(d,p,S,m)&&(p=null),m||S===null?kZ(d)&&(p===null?a.removeAttribute(d):a.setAttribute(d,""+p)):S.mustUseProperty?a[S.propertyName]=p===null?S.type===3?!1:"":p:(d=S.attributeName,m=S.attributeNamespace,p===null?a.removeAttribute(d):(S=S.type,p=S===3||S===4&&p===!0?"":""+p,m?a.setAttributeNS(m,d,p):a.setAttribute(d,p))))}var oa=PZ.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,tE=Symbol.for("react.element"),Jl=Symbol.for("react.portal"),Ql=Symbol.for("react.fragment"),_I=Symbol.for("react.strict_mode"),EC=Symbol.for("react.profiler"),eF=Symbol.for("react.provider"),tF=Symbol.for("react.context"),mI=Symbol.for("react.forward_ref"),gC=Symbol.for("react.suspense"),SC=Symbol.for("react.suspense_list"),EI=Symbol.for("react.memo"),Wa=Symbol.for("react.lazy"),nF=Symbol.for("react.offscreen"),Ax=Symbol.iterator;function rp(a){return a===null||typeof a!="object"?null:(a=Ax&&a[Ax]||a["@@iterator"],typeof a=="function"?a:null)}var Yn=Object.assign,Wy;function up(a){if(Wy===void 0)try{throw Error()}catch(p){var d=p.stack.trim().match(/\n( *(at )?)/);Wy=d&&d[1]||""}return`
`+Wy+a}var Hy=!1;function Ky(a,d){if(!a||Hy)return"";Hy=!0;var p=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(d)if(d=function(){throw Error()},Object.defineProperty(d.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(d,[])}catch(X){var m=X}Reflect.construct(a,[],d)}else{try{d.call()}catch(X){m=X}a.call(d.prototype)}else{try{throw Error()}catch(X){m=X}a()}}catch(X){if(X&&m&&typeof X.stack=="string"){for(var S=X.stack.split(`
`),C=m.stack.split(`
`),N=S.length-1,F=C.length-1;1<=N&&0<=F&&S[N]!==C[F];)F--;for(;1<=N&&0<=F;N--,F--)if(S[N]!==C[F]){if(N!==1||F!==1)do if(N--,F--,0>F||S[N]!==C[F]){var x=`
`+S[N].replace(" at new "," at ");return a.displayName&&x.includes("<anonymous>")&&(x=x.replace("<anonymous>",a.displayName)),x}while(1<=N&&0<=F);break}}}finally{Hy=!1,Error.prepareStackTrace=p}return(a=a?a.displayName||a.name:"")?up(a):""}function xZ(a){switch(a.tag){case 5:return up(a.type);case 16:return up("Lazy");case 13:return up("Suspense");case 19:return up("SuspenseList");case 0:case 2:case 15:return a=Ky(a.type,!1),a;case 11:return a=Ky(a.type.render,!1),a;case 1:return a=Ky(a.type,!0),a;default:return""}}function TC(a){if(a==null)return null;if(typeof a=="function")return a.displayName||a.name||null;if(typeof a=="string")return a;switch(a){case Ql:return"Fragment";case Jl:return"Portal";case EC:return"Profiler";case _I:return"StrictMode";case gC:return"Suspense";case SC:return"SuspenseList"}if(typeof a=="object")switch(a.$$typeof){case tF:return(a.displayName||"Context")+".Consumer";case eF:return(a._context.displayName||"Context")+".Provider";case mI:var d=a.render;return a=a.displayName,a||(a=d.displayName||d.name||"",a=a!==""?"ForwardRef("+a+")":"ForwardRef"),a;case EI:return d=a.displayName||null,d!==null?d:TC(a.type)||"Memo";case Wa:d=a._payload,a=a._init;try{return TC(a(d))}catch{}}return null}function VZ(a){var d=a.type;switch(a.tag){case 24:return"Cache";case 9:return(d.displayName||"Context")+".Consumer";case 10:return(d._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return a=d.render,a=a.displayName||a.name||"",d.displayName||(a!==""?"ForwardRef("+a+")":"ForwardRef");case 7:return"Fragment";case 5:return d;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return TC(d);case 8:return d===_I?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof d=="function")return d.displayName||d.name||null;if(typeof d=="string")return d}return null}function rc(a){switch(typeof a){case"boolean":case"number":case"string":case"undefined":return a;case"object":return a;default:return""}}function rF(a){var d=a.type;return(a=a.nodeName)&&a.toLowerCase()==="input"&&(d==="checkbox"||d==="radio")}function FZ(a){var d=rF(a)?"checked":"value",p=Object.getOwnPropertyDescriptor(a.constructor.prototype,d),m=""+a[d];if(!a.hasOwnProperty(d)&&typeof p<"u"&&typeof p.get=="function"&&typeof p.set=="function"){var S=p.get,C=p.set;return Object.defineProperty(a,d,{configurable:!0,get:function(){return S.call(this)},set:function(N){m=""+N,C.call(this,N)}}),Object.defineProperty(a,d,{enumerable:p.enumerable}),{getValue:function(){return m},setValue:function(N){m=""+N},stopTracking:function(){a._valueTracker=null,delete a[d]}}}}function nE(a){a._valueTracker||(a._valueTracker=FZ(a))}function iF(a){if(!a)return!1;var d=a._valueTracker;if(!d)return!0;var p=d.getValue(),m="";return a&&(m=rF(a)?a.checked?"true":"false":a.value),a=m,a!==p?(d.setValue(a),!0):!1}function DE(a){if(a=a||(typeof document<"u"?document:void 0),typeof a>"u")return null;try{return a.activeElement||a.body}catch{return a.body}}function vC(a,d){var p=d.checked;return Yn({},d,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:p??a._wrapperState.initialChecked})}function bx(a,d){var p=d.defaultValue==null?"":d.defaultValue,m=d.checked!=null?d.checked:d.defaultChecked;p=rc(d.value!=null?d.value:p),a._wrapperState={initialChecked:m,initialValue:p,controlled:d.type==="checkbox"||d.type==="radio"?d.checked!=null:d.value!=null}}function oF(a,d){d=d.checked,d!=null&&fI(a,"checked",d,!1)}function RC(a,d){oF(a,d);var p=rc(d.value),m=d.type;if(p!=null)m==="number"?(p===0&&a.value===""||a.value!=p)&&(a.value=""+p):a.value!==""+p&&(a.value=""+p);else if(m==="submit"||m==="reset"){a.removeAttribute("value");return}d.hasOwnProperty("value")?yC(a,d.type,p):d.hasOwnProperty("defaultValue")&&yC(a,d.type,rc(d.defaultValue)),d.checked==null&&d.defaultChecked!=null&&(a.defaultChecked=!!d.defaultChecked)}function Ox(a,d,p){if(d.hasOwnProperty("value")||d.hasOwnProperty("defaultValue")){var m=d.type;if(!(m!=="submit"&&m!=="reset"||d.value!==void 0&&d.value!==null))return;d=""+a._wrapperState.initialValue,p||d===a.value||(a.value=d),a.defaultValue=d}p=a.name,p!==""&&(a.name=""),a.defaultChecked=!!a._wrapperState.initialChecked,p!==""&&(a.name=p)}function yC(a,d,p){(d!=="number"||DE(a.ownerDocument)!==a)&&(p==null?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+p&&(a.defaultValue=""+p))}var hp=Array.isArray;function cu(a,d,p,m){if(a=a.options,d){d={};for(var S=0;S<p.length;S++)d["$"+p[S]]=!0;for(p=0;p<a.length;p++)S=d.hasOwnProperty("$"+a[p].value),a[p].selected!==S&&(a[p].selected=S),S&&m&&(a[p].defaultSelected=!0)}else{for(p=""+rc(p),d=null,S=0;S<a.length;S++){if(a[S].value===p){a[S].selected=!0,m&&(a[S].defaultSelected=!0);return}d!==null||a[S].disabled||(d=a[S])}d!==null&&(d.selected=!0)}}function CC(a,d){if(d.dangerouslySetInnerHTML!=null)throw Error(ye(91));return Yn({},d,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}function Nx(a,d){var p=d.value;if(p==null){if(p=d.children,d=d.defaultValue,p!=null){if(d!=null)throw Error(ye(92));if(hp(p)){if(1<p.length)throw Error(ye(93));p=p[0]}d=p}d==null&&(d=""),p=d}a._wrapperState={initialValue:rc(p)}}function sF(a,d){var p=rc(d.value),m=rc(d.defaultValue);p!=null&&(p=""+p,p!==a.value&&(a.value=p),d.defaultValue==null&&a.defaultValue!==p&&(a.defaultValue=p)),m!=null&&(a.defaultValue=""+m)}function Dx(a){var d=a.textContent;d===a._wrapperState.initialValue&&d!==""&&d!==null&&(a.value=d)}function aF(a){switch(a){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function IC(a,d){return a==null||a==="http://www.w3.org/1999/xhtml"?aF(d):a==="http://www.w3.org/2000/svg"&&d==="foreignObject"?"http://www.w3.org/1999/xhtml":a}var rE,cF=function(a){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(d,p,m,S){MSApp.execUnsafeLocalFunction(function(){return a(d,p,m,S)})}:a}(function(a,d){if(a.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in a)a.innerHTML=d;else{for(rE=rE||document.createElement("div"),rE.innerHTML="<svg>"+d.valueOf().toString()+"</svg>",d=rE.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;d.firstChild;)a.appendChild(d.firstChild)}});function wp(a,d){if(d){var p=a.firstChild;if(p&&p===a.lastChild&&p.nodeType===3){p.nodeValue=d;return}}a.textContent=d}var mp={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},BZ=["Webkit","ms","Moz","O"];Object.keys(mp).forEach(function(a){BZ.forEach(function(d){d=d+a.charAt(0).toUpperCase()+a.substring(1),mp[d]=mp[a]})});function dF(a,d,p){return d==null||typeof d=="boolean"||d===""?"":p||typeof d!="number"||d===0||mp.hasOwnProperty(a)&&mp[a]?(""+d).trim():d+"px"}function lF(a,d){a=a.style;for(var p in d)if(d.hasOwnProperty(p)){var m=p.indexOf("--")===0,S=dF(p,d[p],m);p==="float"&&(p="cssFloat"),m?a.setProperty(p,S):a[p]=S}}var jZ=Yn({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function wC(a,d){if(d){if(jZ[a]&&(d.children!=null||d.dangerouslySetInnerHTML!=null))throw Error(ye(137,a));if(d.dangerouslySetInnerHTML!=null){if(d.children!=null)throw Error(ye(60));if(typeof d.dangerouslySetInnerHTML!="object"||!("__html"in d.dangerouslySetInnerHTML))throw Error(ye(61))}if(d.style!=null&&typeof d.style!="object")throw Error(ye(62))}}function AC(a,d){if(a.indexOf("-")===-1)return typeof d.is=="string";switch(a){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var bC=null;function gI(a){return a=a.target||a.srcElement||window,a.correspondingUseElement&&(a=a.correspondingUseElement),a.nodeType===3?a.parentNode:a}var OC=null,du=null,lu=null;function Px(a){if(a=Kp(a)){if(typeof OC!="function")throw Error(ye(280));var d=a.stateNode;d&&(d=sg(d),OC(a.stateNode,a.type,d))}}function uF(a){du?lu?lu.push(a):lu=[a]:du=a}function hF(){if(du){var a=du,d=lu;if(lu=du=null,Px(a),d)for(a=0;a<d.length;a++)Px(d[a])}}function pF(a,d){return a(d)}function fF(){}var Yy=!1;function _F(a,d,p){if(Yy)return a(d,p);Yy=!0;try{return pF(a,d,p)}finally{Yy=!1,(du!==null||lu!==null)&&(fF(),hF())}}function Ap(a,d){var p=a.stateNode;if(p===null)return null;var m=sg(p);if(m===null)return null;p=m[d];e:switch(d){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(m=!m.disabled)||(a=a.type,m=!(a==="button"||a==="input"||a==="select"||a==="textarea")),a=!m;break e;default:a=!1}if(a)return null;if(p&&typeof p!="function")throw Error(ye(231,d,typeof p));return p}var NC=!1;if(ta)try{var ip={};Object.defineProperty(ip,"passive",{get:function(){NC=!0}}),window.addEventListener("test",ip,ip),window.removeEventListener("test",ip,ip)}catch{NC=!1}function GZ(a,d,p,m,S,C,N,F,x){var X=Array.prototype.slice.call(arguments,3);try{d.apply(p,X)}catch(_e){this.onError(_e)}}var Ep=!1,PE=null,LE=!1,DC=null,WZ={onError:function(a){Ep=!0,PE=a}};function HZ(a,d,p,m,S,C,N,F,x){Ep=!1,PE=null,GZ.apply(WZ,arguments)}function KZ(a,d,p,m,S,C,N,F,x){if(HZ.apply(this,arguments),Ep){if(Ep){var X=PE;Ep=!1,PE=null}else throw Error(ye(198));LE||(LE=!0,DC=X)}}function Rd(a){var d=a,p=a;if(a.alternate)for(;d.return;)d=d.return;else{a=d;do d=a,d.flags&4098&&(p=d.return),a=d.return;while(a)}return d.tag===3?p:null}function mF(a){if(a.tag===13){var d=a.memoizedState;if(d===null&&(a=a.alternate,a!==null&&(d=a.memoizedState)),d!==null)return d.dehydrated}return null}function Lx(a){if(Rd(a)!==a)throw Error(ye(188))}function YZ(a){var d=a.alternate;if(!d){if(d=Rd(a),d===null)throw Error(ye(188));return d!==a?null:a}for(var p=a,m=d;;){var S=p.return;if(S===null)break;var C=S.alternate;if(C===null){if(m=S.return,m!==null){p=m;continue}break}if(S.child===C.child){for(C=S.child;C;){if(C===p)return Lx(S),a;if(C===m)return Lx(S),d;C=C.sibling}throw Error(ye(188))}if(p.return!==m.return)p=S,m=C;else{for(var N=!1,F=S.child;F;){if(F===p){N=!0,p=S,m=C;break}if(F===m){N=!0,m=S,p=C;break}F=F.sibling}if(!N){for(F=C.child;F;){if(F===p){N=!0,p=C,m=S;break}if(F===m){N=!0,m=C,p=S;break}F=F.sibling}if(!N)throw Error(ye(189))}}if(p.alternate!==m)throw Error(ye(190))}if(p.tag!==3)throw Error(ye(188));return p.stateNode.current===p?a:d}function EF(a){return a=YZ(a),a!==null?gF(a):null}function gF(a){if(a.tag===5||a.tag===6)return a;for(a=a.child;a!==null;){var d=gF(a);if(d!==null)return d;a=a.sibling}return null}var SF=Yi.unstable_scheduleCallback,kx=Yi.unstable_cancelCallback,zZ=Yi.unstable_shouldYield,qZ=Yi.unstable_requestPaint,nr=Yi.unstable_now,XZ=Yi.unstable_getCurrentPriorityLevel,SI=Yi.unstable_ImmediatePriority,TF=Yi.unstable_UserBlockingPriority,kE=Yi.unstable_NormalPriority,JZ=Yi.unstable_LowPriority,vF=Yi.unstable_IdlePriority,ng=null,Ds=null;function QZ(a){if(Ds&&typeof Ds.onCommitFiberRoot=="function")try{Ds.onCommitFiberRoot(ng,a,void 0,(a.current.flags&128)===128)}catch{}}var ts=Math.clz32?Math.clz32:e$,ZZ=Math.log,$Z=Math.LN2;function e$(a){return a>>>=0,a===0?32:31-(ZZ(a)/$Z|0)|0}var iE=64,oE=4194304;function pp(a){switch(a&-a){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return a&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return a&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return a}}function ME(a,d){var p=a.pendingLanes;if(p===0)return 0;var m=0,S=a.suspendedLanes,C=a.pingedLanes,N=p&268435455;if(N!==0){var F=N&~S;F!==0?m=pp(F):(C&=N,C!==0&&(m=pp(C)))}else N=p&~S,N!==0?m=pp(N):C!==0&&(m=pp(C));if(m===0)return 0;if(d!==0&&d!==m&&!(d&S)&&(S=m&-m,C=d&-d,S>=C||S===16&&(C&4194240)!==0))return d;if(m&4&&(m|=p&16),d=a.entangledLanes,d!==0)for(a=a.entanglements,d&=m;0<d;)p=31-ts(d),S=1<<p,m|=a[p],d&=~S;return m}function t$(a,d){switch(a){case 1:case 2:case 4:return d+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return d+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function n$(a,d){for(var p=a.suspendedLanes,m=a.pingedLanes,S=a.expirationTimes,C=a.pendingLanes;0<C;){var N=31-ts(C),F=1<<N,x=S[N];x===-1?(!(F&p)||F&m)&&(S[N]=t$(F,d)):x<=d&&(a.expiredLanes|=F),C&=~F}}function PC(a){return a=a.pendingLanes&-1073741825,a!==0?a:a&1073741824?1073741824:0}function RF(){var a=iE;return iE<<=1,!(iE&4194240)&&(iE=64),a}function zy(a){for(var d=[],p=0;31>p;p++)d.push(a);return d}function Wp(a,d,p){a.pendingLanes|=d,d!==536870912&&(a.suspendedLanes=0,a.pingedLanes=0),a=a.eventTimes,d=31-ts(d),a[d]=p}function r$(a,d){var p=a.pendingLanes&~d;a.pendingLanes=d,a.suspendedLanes=0,a.pingedLanes=0,a.expiredLanes&=d,a.mutableReadLanes&=d,a.entangledLanes&=d,d=a.entanglements;var m=a.eventTimes;for(a=a.expirationTimes;0<p;){var S=31-ts(p),C=1<<S;d[S]=0,m[S]=-1,a[S]=-1,p&=~C}}function TI(a,d){var p=a.entangledLanes|=d;for(a=a.entanglements;p;){var m=31-ts(p),S=1<<m;S&d|a[m]&d&&(a[m]|=d),p&=~S}}var ln=0;function yF(a){return a&=-a,1<a?4<a?a&268435455?16:536870912:4:1}var CF,vI,IF,wF,AF,LC=!1,sE=[],Xa=null,Ja=null,Qa=null,bp=new Map,Op=new Map,Ka=[],i$="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Mx(a,d){switch(a){case"focusin":case"focusout":Xa=null;break;case"dragenter":case"dragleave":Ja=null;break;case"mouseover":case"mouseout":Qa=null;break;case"pointerover":case"pointerout":bp.delete(d.pointerId);break;case"gotpointercapture":case"lostpointercapture":Op.delete(d.pointerId)}}function op(a,d,p,m,S,C){return a===null||a.nativeEvent!==C?(a={blockedOn:d,domEventName:p,eventSystemFlags:m,nativeEvent:C,targetContainers:[S]},d!==null&&(d=Kp(d),d!==null&&vI(d)),a):(a.eventSystemFlags|=m,d=a.targetContainers,S!==null&&d.indexOf(S)===-1&&d.push(S),a)}function o$(a,d,p,m,S){switch(d){case"focusin":return Xa=op(Xa,a,d,p,m,S),!0;case"dragenter":return Ja=op(Ja,a,d,p,m,S),!0;case"mouseover":return Qa=op(Qa,a,d,p,m,S),!0;case"pointerover":var C=S.pointerId;return bp.set(C,op(bp.get(C)||null,a,d,p,m,S)),!0;case"gotpointercapture":return C=S.pointerId,Op.set(C,op(Op.get(C)||null,a,d,p,m,S)),!0}return!1}function bF(a){var d=ud(a.target);if(d!==null){var p=Rd(d);if(p!==null){if(d=p.tag,d===13){if(d=mF(p),d!==null){a.blockedOn=d,AF(a.priority,function(){IF(p)});return}}else if(d===3&&p.stateNode.current.memoizedState.isDehydrated){a.blockedOn=p.tag===3?p.stateNode.containerInfo:null;return}}}a.blockedOn=null}function SE(a){if(a.blockedOn!==null)return!1;for(var d=a.targetContainers;0<d.length;){var p=kC(a.domEventName,a.eventSystemFlags,d[0],a.nativeEvent);if(p===null){p=a.nativeEvent;var m=new p.constructor(p.type,p);bC=m,p.target.dispatchEvent(m),bC=null}else return d=Kp(p),d!==null&&vI(d),a.blockedOn=p,!1;d.shift()}return!0}function Ux(a,d,p){SE(a)&&p.delete(d)}function s$(){LC=!1,Xa!==null&&SE(Xa)&&(Xa=null),Ja!==null&&SE(Ja)&&(Ja=null),Qa!==null&&SE(Qa)&&(Qa=null),bp.forEach(Ux),Op.forEach(Ux)}function sp(a,d){a.blockedOn===d&&(a.blockedOn=null,LC||(LC=!0,Yi.unstable_scheduleCallback(Yi.unstable_NormalPriority,s$)))}function Np(a){function d(S){return sp(S,a)}if(0<sE.length){sp(sE[0],a);for(var p=1;p<sE.length;p++){var m=sE[p];m.blockedOn===a&&(m.blockedOn=null)}}for(Xa!==null&&sp(Xa,a),Ja!==null&&sp(Ja,a),Qa!==null&&sp(Qa,a),bp.forEach(d),Op.forEach(d),p=0;p<Ka.length;p++)m=Ka[p],m.blockedOn===a&&(m.blockedOn=null);for(;0<Ka.length&&(p=Ka[0],p.blockedOn===null);)bF(p),p.blockedOn===null&&Ka.shift()}var uu=oa.ReactCurrentBatchConfig,UE=!0;function a$(a,d,p,m){var S=ln,C=uu.transition;uu.transition=null;try{ln=1,RI(a,d,p,m)}finally{ln=S,uu.transition=C}}function c$(a,d,p,m){var S=ln,C=uu.transition;uu.transition=null;try{ln=4,RI(a,d,p,m)}finally{ln=S,uu.transition=C}}function RI(a,d,p,m){if(UE){var S=kC(a,d,p,m);if(S===null)rC(a,d,m,xE,p),Mx(a,m);else if(o$(S,a,d,p,m))m.stopPropagation();else if(Mx(a,m),d&4&&-1<i$.indexOf(a)){for(;S!==null;){var C=Kp(S);if(C!==null&&CF(C),C=kC(a,d,p,m),C===null&&rC(a,d,m,xE,p),C===S)break;S=C}S!==null&&m.stopPropagation()}else rC(a,d,m,null,p)}}var xE=null;function kC(a,d,p,m){if(xE=null,a=gI(m),a=ud(a),a!==null)if(d=Rd(a),d===null)a=null;else if(p=d.tag,p===13){if(a=mF(d),a!==null)return a;a=null}else if(p===3){if(d.stateNode.current.memoizedState.isDehydrated)return d.tag===3?d.stateNode.containerInfo:null;a=null}else d!==a&&(a=null);return xE=a,null}function OF(a){switch(a){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(XZ()){case SI:return 1;case TF:return 4;case kE:case JZ:return 16;case vF:return 536870912;default:return 16}default:return 16}}var za=null,yI=null,TE=null;function NF(){if(TE)return TE;var a,d=yI,p=d.length,m,S="value"in za?za.value:za.textContent,C=S.length;for(a=0;a<p&&d[a]===S[a];a++);var N=p-a;for(m=1;m<=N&&d[p-m]===S[C-m];m++);return TE=S.slice(a,1<m?1-m:void 0)}function vE(a){var d=a.keyCode;return"charCode"in a?(a=a.charCode,a===0&&d===13&&(a=13)):a=d,a===10&&(a=13),32<=a||a===13?a:0}function aE(){return!0}function xx(){return!1}function qi(a){function d(p,m,S,C,N){this._reactName=p,this._targetInst=S,this.type=m,this.nativeEvent=C,this.target=N,this.currentTarget=null;for(var F in a)a.hasOwnProperty(F)&&(p=a[F],this[F]=p?p(C):C[F]);return this.isDefaultPrevented=(C.defaultPrevented!=null?C.defaultPrevented:C.returnValue===!1)?aE:xx,this.isPropagationStopped=xx,this}return Yn(d.prototype,{preventDefault:function(){this.defaultPrevented=!0;var p=this.nativeEvent;p&&(p.preventDefault?p.preventDefault():typeof p.returnValue!="unknown"&&(p.returnValue=!1),this.isDefaultPrevented=aE)},stopPropagation:function(){var p=this.nativeEvent;p&&(p.stopPropagation?p.stopPropagation():typeof p.cancelBubble!="unknown"&&(p.cancelBubble=!0),this.isPropagationStopped=aE)},persist:function(){},isPersistent:aE}),d}var Ru={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(a){return a.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},CI=qi(Ru),Hp=Yn({},Ru,{view:0,detail:0}),d$=qi(Hp),qy,Xy,ap,rg=Yn({},Hp,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:II,button:0,buttons:0,relatedTarget:function(a){return a.relatedTarget===void 0?a.fromElement===a.srcElement?a.toElement:a.fromElement:a.relatedTarget},movementX:function(a){return"movementX"in a?a.movementX:(a!==ap&&(ap&&a.type==="mousemove"?(qy=a.screenX-ap.screenX,Xy=a.screenY-ap.screenY):Xy=qy=0,ap=a),qy)},movementY:function(a){return"movementY"in a?a.movementY:Xy}}),Vx=qi(rg),l$=Yn({},rg,{dataTransfer:0}),u$=qi(l$),h$=Yn({},Hp,{relatedTarget:0}),Jy=qi(h$),p$=Yn({},Ru,{animationName:0,elapsedTime:0,pseudoElement:0}),f$=qi(p$),_$=Yn({},Ru,{clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),m$=qi(_$),E$=Yn({},Ru,{data:0}),Fx=qi(E$),g$={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},S$={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},T$={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function v$(a){var d=this.nativeEvent;return d.getModifierState?d.getModifierState(a):(a=T$[a])?!!d[a]:!1}function II(){return v$}var R$=Yn({},Hp,{key:function(a){if(a.key){var d=g$[a.key]||a.key;if(d!=="Unidentified")return d}return a.type==="keypress"?(a=vE(a),a===13?"Enter":String.fromCharCode(a)):a.type==="keydown"||a.type==="keyup"?S$[a.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:II,charCode:function(a){return a.type==="keypress"?vE(a):0},keyCode:function(a){return a.type==="keydown"||a.type==="keyup"?a.keyCode:0},which:function(a){return a.type==="keypress"?vE(a):a.type==="keydown"||a.type==="keyup"?a.keyCode:0}}),y$=qi(R$),C$=Yn({},rg,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Bx=qi(C$),I$=Yn({},Hp,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:II}),w$=qi(I$),A$=Yn({},Ru,{propertyName:0,elapsedTime:0,pseudoElement:0}),b$=qi(A$),O$=Yn({},rg,{deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?-a.wheelDelta:0},deltaZ:0,deltaMode:0}),N$=qi(O$),D$=[9,13,27,32],wI=ta&&"CompositionEvent"in window,gp=null;ta&&"documentMode"in document&&(gp=document.documentMode);var P$=ta&&"TextEvent"in window&&!gp,DF=ta&&(!wI||gp&&8<gp&&11>=gp),jx=" ",Gx=!1;function PF(a,d){switch(a){case"keyup":return D$.indexOf(d.keyCode)!==-1;case"keydown":return d.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function LF(a){return a=a.detail,typeof a=="object"&&"data"in a?a.data:null}var Zl=!1;function L$(a,d){switch(a){case"compositionend":return LF(d);case"keypress":return d.which!==32?null:(Gx=!0,jx);case"textInput":return a=d.data,a===jx&&Gx?null:a;default:return null}}function k$(a,d){if(Zl)return a==="compositionend"||!wI&&PF(a,d)?(a=NF(),TE=yI=za=null,Zl=!1,a):null;switch(a){case"paste":return null;case"keypress":if(!(d.ctrlKey||d.altKey||d.metaKey)||d.ctrlKey&&d.altKey){if(d.char&&1<d.char.length)return d.char;if(d.which)return String.fromCharCode(d.which)}return null;case"compositionend":return DF&&d.locale!=="ko"?null:d.data;default:return null}}var M$={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Wx(a){var d=a&&a.nodeName&&a.nodeName.toLowerCase();return d==="input"?!!M$[a.type]:d==="textarea"}function kF(a,d,p,m){uF(m),d=VE(d,"onChange"),0<d.length&&(p=new CI("onChange","change",null,p,m),a.push({event:p,listeners:d}))}var Sp=null,Dp=null;function U$(a){KF(a,0)}function ig(a){var d=tu(a);if(iF(d))return a}function x$(a,d){if(a==="change")return d}var MF=!1;if(ta){var Qy;if(ta){var Zy="oninput"in document;if(!Zy){var Hx=document.createElement("div");Hx.setAttribute("oninput","return;"),Zy=typeof Hx.oninput=="function"}Qy=Zy}else Qy=!1;MF=Qy&&(!document.documentMode||9<document.documentMode)}function Kx(){Sp&&(Sp.detachEvent("onpropertychange",UF),Dp=Sp=null)}function UF(a){if(a.propertyName==="value"&&ig(Dp)){var d=[];kF(d,Dp,a,gI(a)),_F(U$,d)}}function V$(a,d,p){a==="focusin"?(Kx(),Sp=d,Dp=p,Sp.attachEvent("onpropertychange",UF)):a==="focusout"&&Kx()}function F$(a){if(a==="selectionchange"||a==="keyup"||a==="keydown")return ig(Dp)}function B$(a,d){if(a==="click")return ig(d)}function j$(a,d){if(a==="input"||a==="change")return ig(d)}function G$(a,d){return a===d&&(a!==0||1/a===1/d)||a!==a&&d!==d}var rs=typeof Object.is=="function"?Object.is:G$;function Pp(a,d){if(rs(a,d))return!0;if(typeof a!="object"||a===null||typeof d!="object"||d===null)return!1;var p=Object.keys(a),m=Object.keys(d);if(p.length!==m.length)return!1;for(m=0;m<p.length;m++){var S=p[m];if(!mC.call(d,S)||!rs(a[S],d[S]))return!1}return!0}function Yx(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function zx(a,d){var p=Yx(a);a=0;for(var m;p;){if(p.nodeType===3){if(m=a+p.textContent.length,a<=d&&m>=d)return{node:p,offset:d-a};a=m}e:{for(;p;){if(p.nextSibling){p=p.nextSibling;break e}p=p.parentNode}p=void 0}p=Yx(p)}}function xF(a,d){return a&&d?a===d?!0:a&&a.nodeType===3?!1:d&&d.nodeType===3?xF(a,d.parentNode):"contains"in a?a.contains(d):a.compareDocumentPosition?!!(a.compareDocumentPosition(d)&16):!1:!1}function VF(){for(var a=window,d=DE();d instanceof a.HTMLIFrameElement;){try{var p=typeof d.contentWindow.location.href=="string"}catch{p=!1}if(p)a=d.contentWindow;else break;d=DE(a.document)}return d}function AI(a){var d=a&&a.nodeName&&a.nodeName.toLowerCase();return d&&(d==="input"&&(a.type==="text"||a.type==="search"||a.type==="tel"||a.type==="url"||a.type==="password")||d==="textarea"||a.contentEditable==="true")}function W$(a){var d=VF(),p=a.focusedElem,m=a.selectionRange;if(d!==p&&p&&p.ownerDocument&&xF(p.ownerDocument.documentElement,p)){if(m!==null&&AI(p)){if(d=m.start,a=m.end,a===void 0&&(a=d),"selectionStart"in p)p.selectionStart=d,p.selectionEnd=Math.min(a,p.value.length);else if(a=(d=p.ownerDocument||document)&&d.defaultView||window,a.getSelection){a=a.getSelection();var S=p.textContent.length,C=Math.min(m.start,S);m=m.end===void 0?C:Math.min(m.end,S),!a.extend&&C>m&&(S=m,m=C,C=S),S=zx(p,C);var N=zx(p,m);S&&N&&(a.rangeCount!==1||a.anchorNode!==S.node||a.anchorOffset!==S.offset||a.focusNode!==N.node||a.focusOffset!==N.offset)&&(d=d.createRange(),d.setStart(S.node,S.offset),a.removeAllRanges(),C>m?(a.addRange(d),a.extend(N.node,N.offset)):(d.setEnd(N.node,N.offset),a.addRange(d)))}}for(d=[],a=p;a=a.parentNode;)a.nodeType===1&&d.push({element:a,left:a.scrollLeft,top:a.scrollTop});for(typeof p.focus=="function"&&p.focus(),p=0;p<d.length;p++)a=d[p],a.element.scrollLeft=a.left,a.element.scrollTop=a.top}}var H$=ta&&"documentMode"in document&&11>=document.documentMode,$l=null,MC=null,Tp=null,UC=!1;function qx(a,d,p){var m=p.window===p?p.document:p.nodeType===9?p:p.ownerDocument;UC||$l==null||$l!==DE(m)||(m=$l,"selectionStart"in m&&AI(m)?m={start:m.selectionStart,end:m.selectionEnd}:(m=(m.ownerDocument&&m.ownerDocument.defaultView||window).getSelection(),m={anchorNode:m.anchorNode,anchorOffset:m.anchorOffset,focusNode:m.focusNode,focusOffset:m.focusOffset}),Tp&&Pp(Tp,m)||(Tp=m,m=VE(MC,"onSelect"),0<m.length&&(d=new CI("onSelect","select",null,d,p),a.push({event:d,listeners:m}),d.target=$l)))}function cE(a,d){var p={};return p[a.toLowerCase()]=d.toLowerCase(),p["Webkit"+a]="webkit"+d,p["Moz"+a]="moz"+d,p}var eu={animationend:cE("Animation","AnimationEnd"),animationiteration:cE("Animation","AnimationIteration"),animationstart:cE("Animation","AnimationStart"),transitionend:cE("Transition","TransitionEnd")},$y={},FF={};ta&&(FF=document.createElement("div").style,"AnimationEvent"in window||(delete eu.animationend.animation,delete eu.animationiteration.animation,delete eu.animationstart.animation),"TransitionEvent"in window||delete eu.transitionend.transition);function og(a){if($y[a])return $y[a];if(!eu[a])return a;var d=eu[a],p;for(p in d)if(d.hasOwnProperty(p)&&p in FF)return $y[a]=d[p];return a}var BF=og("animationend"),jF=og("animationiteration"),GF=og("animationstart"),WF=og("transitionend"),HF=new Map,Xx="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function oc(a,d){HF.set(a,d),vd(d,[a])}for(var eC=0;eC<Xx.length;eC++){var tC=Xx[eC],K$=tC.toLowerCase(),Y$=tC[0].toUpperCase()+tC.slice(1);oc(K$,"on"+Y$)}oc(BF,"onAnimationEnd");oc(jF,"onAnimationIteration");oc(GF,"onAnimationStart");oc("dblclick","onDoubleClick");oc("focusin","onFocus");oc("focusout","onBlur");oc(WF,"onTransitionEnd");fu("onMouseEnter",["mouseout","mouseover"]);fu("onMouseLeave",["mouseout","mouseover"]);fu("onPointerEnter",["pointerout","pointerover"]);fu("onPointerLeave",["pointerout","pointerover"]);vd("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));vd("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));vd("onBeforeInput",["compositionend","keypress","textInput","paste"]);vd("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));vd("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));vd("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var fp="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),z$=new Set("cancel close invalid load scroll toggle".split(" ").concat(fp));function Jx(a,d,p){var m=a.type||"unknown-event";a.currentTarget=p,KZ(m,d,void 0,a),a.currentTarget=null}function KF(a,d){d=(d&4)!==0;for(var p=0;p<a.length;p++){var m=a[p],S=m.event;m=m.listeners;e:{var C=void 0;if(d)for(var N=m.length-1;0<=N;N--){var F=m[N],x=F.instance,X=F.currentTarget;if(F=F.listener,x!==C&&S.isPropagationStopped())break e;Jx(S,F,X),C=x}else for(N=0;N<m.length;N++){if(F=m[N],x=F.instance,X=F.currentTarget,F=F.listener,x!==C&&S.isPropagationStopped())break e;Jx(S,F,X),C=x}}}if(LE)throw a=DC,LE=!1,DC=null,a}function Nn(a,d){var p=d[jC];p===void 0&&(p=d[jC]=new Set);var m=a+"__bubble";p.has(m)||(YF(d,a,2,!1),p.add(m))}function nC(a,d,p){var m=0;d&&(m|=4),YF(p,a,m,d)}var dE="_reactListening"+Math.random().toString(36).slice(2);function Lp(a){if(!a[dE]){a[dE]=!0,$V.forEach(function(p){p!=="selectionchange"&&(z$.has(p)||nC(p,!1,a),nC(p,!0,a))});var d=a.nodeType===9?a:a.ownerDocument;d===null||d[dE]||(d[dE]=!0,nC("selectionchange",!1,d))}}function YF(a,d,p,m){switch(OF(d)){case 1:var S=a$;break;case 4:S=c$;break;default:S=RI}p=S.bind(null,d,p,a),S=void 0,!NC||d!=="touchstart"&&d!=="touchmove"&&d!=="wheel"||(S=!0),m?S!==void 0?a.addEventListener(d,p,{capture:!0,passive:S}):a.addEventListener(d,p,!0):S!==void 0?a.addEventListener(d,p,{passive:S}):a.addEventListener(d,p,!1)}function rC(a,d,p,m,S){var C=m;if(!(d&1)&&!(d&2)&&m!==null)e:for(;;){if(m===null)return;var N=m.tag;if(N===3||N===4){var F=m.stateNode.containerInfo;if(F===S||F.nodeType===8&&F.parentNode===S)break;if(N===4)for(N=m.return;N!==null;){var x=N.tag;if((x===3||x===4)&&(x=N.stateNode.containerInfo,x===S||x.nodeType===8&&x.parentNode===S))return;N=N.return}for(;F!==null;){if(N=ud(F),N===null)return;if(x=N.tag,x===5||x===6){m=C=N;continue e}F=F.parentNode}}m=m.return}_F(function(){var X=C,_e=gI(p),oe=[];e:{var re=HF.get(a);if(re!==void 0){var Ce=CI,fe=a;switch(a){case"keypress":if(vE(p)===0)break e;case"keydown":case"keyup":Ce=y$;break;case"focusin":fe="focus",Ce=Jy;break;case"focusout":fe="blur",Ce=Jy;break;case"beforeblur":case"afterblur":Ce=Jy;break;case"click":if(p.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":Ce=Vx;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":Ce=u$;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":Ce=w$;break;case BF:case jF:case GF:Ce=f$;break;case WF:Ce=b$;break;case"scroll":Ce=d$;break;case"wheel":Ce=N$;break;case"copy":case"cut":case"paste":Ce=m$;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":Ce=Bx}var Oe=(d&4)!==0,Vt=!Oe&&a==="scroll",J=Oe?re!==null?re+"Capture":null:re;Oe=[];for(var K=X,Q;K!==null;){Q=K;var Te=Q.stateNode;if(Q.tag===5&&Te!==null&&(Q=Te,J!==null&&(Te=Ap(K,J),Te!=null&&Oe.push(kp(K,Te,Q)))),Vt)break;K=K.return}0<Oe.length&&(re=new Ce(re,fe,null,p,_e),oe.push({event:re,listeners:Oe}))}}if(!(d&7)){e:{if(re=a==="mouseover"||a==="pointerover",Ce=a==="mouseout"||a==="pointerout",re&&p!==bC&&(fe=p.relatedTarget||p.fromElement)&&(ud(fe)||fe[na]))break e;if((Ce||re)&&(re=_e.window===_e?_e:(re=_e.ownerDocument)?re.defaultView||re.parentWindow:window,Ce?(fe=p.relatedTarget||p.toElement,Ce=X,fe=fe?ud(fe):null,fe!==null&&(Vt=Rd(fe),fe!==Vt||fe.tag!==5&&fe.tag!==6)&&(fe=null)):(Ce=null,fe=X),Ce!==fe)){if(Oe=Vx,Te="onMouseLeave",J="onMouseEnter",K="mouse",(a==="pointerout"||a==="pointerover")&&(Oe=Bx,Te="onPointerLeave",J="onPointerEnter",K="pointer"),Vt=Ce==null?re:tu(Ce),Q=fe==null?re:tu(fe),re=new Oe(Te,K+"leave",Ce,p,_e),re.target=Vt,re.relatedTarget=Q,Te=null,ud(_e)===X&&(Oe=new Oe(J,K+"enter",fe,p,_e),Oe.target=Q,Oe.relatedTarget=Vt,Te=Oe),Vt=Te,Ce&&fe)t:{for(Oe=Ce,J=fe,K=0,Q=Oe;Q;Q=Kl(Q))K++;for(Q=0,Te=J;Te;Te=Kl(Te))Q++;for(;0<K-Q;)Oe=Kl(Oe),K--;for(;0<Q-K;)J=Kl(J),Q--;for(;K--;){if(Oe===J||J!==null&&Oe===J.alternate)break t;Oe=Kl(Oe),J=Kl(J)}Oe=null}else Oe=null;Ce!==null&&Qx(oe,re,Ce,Oe,!1),fe!==null&&Vt!==null&&Qx(oe,Vt,fe,Oe,!0)}}e:{if(re=X?tu(X):window,Ce=re.nodeName&&re.nodeName.toLowerCase(),Ce==="select"||Ce==="input"&&re.type==="file")var Ve=x$;else if(Wx(re))if(MF)Ve=j$;else{Ve=F$;var Be=V$}else(Ce=re.nodeName)&&Ce.toLowerCase()==="input"&&(re.type==="checkbox"||re.type==="radio")&&(Ve=B$);if(Ve&&(Ve=Ve(a,X))){kF(oe,Ve,p,_e);break e}Be&&Be(a,re,X),a==="focusout"&&(Be=re._wrapperState)&&Be.controlled&&re.type==="number"&&yC(re,"number",re.value)}switch(Be=X?tu(X):window,a){case"focusin":(Wx(Be)||Be.contentEditable==="true")&&($l=Be,MC=X,Tp=null);break;case"focusout":Tp=MC=$l=null;break;case"mousedown":UC=!0;break;case"contextmenu":case"mouseup":case"dragend":UC=!1,qx(oe,p,_e);break;case"selectionchange":if(H$)break;case"keydown":case"keyup":qx(oe,p,_e)}var Me;if(wI)e:{switch(a){case"compositionstart":var ze="onCompositionStart";break e;case"compositionend":ze="onCompositionEnd";break e;case"compositionupdate":ze="onCompositionUpdate";break e}ze=void 0}else Zl?PF(a,p)&&(ze="onCompositionEnd"):a==="keydown"&&p.keyCode===229&&(ze="onCompositionStart");ze&&(DF&&p.locale!=="ko"&&(Zl||ze!=="onCompositionStart"?ze==="onCompositionEnd"&&Zl&&(Me=NF()):(za=_e,yI="value"in za?za.value:za.textContent,Zl=!0)),Be=VE(X,ze),0<Be.length&&(ze=new Fx(ze,a,null,p,_e),oe.push({event:ze,listeners:Be}),Me?ze.data=Me:(Me=LF(p),Me!==null&&(ze.data=Me)))),(Me=P$?L$(a,p):k$(a,p))&&(X=VE(X,"onBeforeInput"),0<X.length&&(_e=new Fx("onBeforeInput","beforeinput",null,p,_e),oe.push({event:_e,listeners:X}),_e.data=Me))}KF(oe,d)})}function kp(a,d,p){return{instance:a,listener:d,currentTarget:p}}function VE(a,d){for(var p=d+"Capture",m=[];a!==null;){var S=a,C=S.stateNode;S.tag===5&&C!==null&&(S=C,C=Ap(a,p),C!=null&&m.unshift(kp(a,C,S)),C=Ap(a,d),C!=null&&m.push(kp(a,C,S))),a=a.return}return m}function Kl(a){if(a===null)return null;do a=a.return;while(a&&a.tag!==5);return a||null}function Qx(a,d,p,m,S){for(var C=d._reactName,N=[];p!==null&&p!==m;){var F=p,x=F.alternate,X=F.stateNode;if(x!==null&&x===m)break;F.tag===5&&X!==null&&(F=X,S?(x=Ap(p,C),x!=null&&N.unshift(kp(p,x,F))):S||(x=Ap(p,C),x!=null&&N.push(kp(p,x,F)))),p=p.return}N.length!==0&&a.push({event:d,listeners:N})}var q$=/\r\n?/g,X$=/\u0000|\uFFFD/g;function Zx(a){return(typeof a=="string"?a:""+a).replace(q$,`
`).replace(X$,"")}function lE(a,d,p){if(d=Zx(d),Zx(a)!==d&&p)throw Error(ye(425))}function FE(){}var xC=null,VC=null;function FC(a,d){return a==="textarea"||a==="noscript"||typeof d.children=="string"||typeof d.children=="number"||typeof d.dangerouslySetInnerHTML=="object"&&d.dangerouslySetInnerHTML!==null&&d.dangerouslySetInnerHTML.__html!=null}var BC=typeof setTimeout=="function"?setTimeout:void 0,J$=typeof clearTimeout=="function"?clearTimeout:void 0,$x=typeof Promise=="function"?Promise:void 0,Q$=typeof queueMicrotask=="function"?queueMicrotask:typeof $x<"u"?function(a){return $x.resolve(null).then(a).catch(Z$)}:BC;function Z$(a){setTimeout(function(){throw a})}function iC(a,d){var p=d,m=0;do{var S=p.nextSibling;if(a.removeChild(p),S&&S.nodeType===8)if(p=S.data,p==="/$"){if(m===0){a.removeChild(S),Np(d);return}m--}else p!=="$"&&p!=="$?"&&p!=="$!"||m++;p=S}while(p);Np(d)}function Za(a){for(;a!=null;a=a.nextSibling){var d=a.nodeType;if(d===1||d===3)break;if(d===8){if(d=a.data,d==="$"||d==="$!"||d==="$?")break;if(d==="/$")return null}}return a}function eV(a){a=a.previousSibling;for(var d=0;a;){if(a.nodeType===8){var p=a.data;if(p==="$"||p==="$!"||p==="$?"){if(d===0)return a;d--}else p==="/$"&&d++}a=a.previousSibling}return null}var yu=Math.random().toString(36).slice(2),Ns="__reactFiber$"+yu,Mp="__reactProps$"+yu,na="__reactContainer$"+yu,jC="__reactEvents$"+yu,$$="__reactListeners$"+yu,eee="__reactHandles$"+yu;function ud(a){var d=a[Ns];if(d)return d;for(var p=a.parentNode;p;){if(d=p[na]||p[Ns]){if(p=d.alternate,d.child!==null||p!==null&&p.child!==null)for(a=eV(a);a!==null;){if(p=a[Ns])return p;a=eV(a)}return d}a=p,p=a.parentNode}return null}function Kp(a){return a=a[Ns]||a[na],!a||a.tag!==5&&a.tag!==6&&a.tag!==13&&a.tag!==3?null:a}function tu(a){if(a.tag===5||a.tag===6)return a.stateNode;throw Error(ye(33))}function sg(a){return a[Mp]||null}var GC=[],nu=-1;function sc(a){return{current:a}}function Dn(a){0>nu||(a.current=GC[nu],GC[nu]=null,nu--)}function vn(a,d){nu++,GC[nu]=a.current,a.current=d}var ic={},Jr=sc(ic),wi=sc(!1),md=ic;function _u(a,d){var p=a.type.contextTypes;if(!p)return ic;var m=a.stateNode;if(m&&m.__reactInternalMemoizedUnmaskedChildContext===d)return m.__reactInternalMemoizedMaskedChildContext;var S={},C;for(C in p)S[C]=d[C];return m&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=d,a.__reactInternalMemoizedMaskedChildContext=S),S}function Ai(a){return a=a.childContextTypes,a!=null}function BE(){Dn(wi),Dn(Jr)}function tV(a,d,p){if(Jr.current!==ic)throw Error(ye(168));vn(Jr,d),vn(wi,p)}function zF(a,d,p){var m=a.stateNode;if(d=d.childContextTypes,typeof m.getChildContext!="function")return p;m=m.getChildContext();for(var S in m)if(!(S in d))throw Error(ye(108,VZ(a)||"Unknown",S));return Yn({},p,m)}function jE(a){return a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||ic,md=Jr.current,vn(Jr,a),vn(wi,wi.current),!0}function nV(a,d,p){var m=a.stateNode;if(!m)throw Error(ye(169));p?(a=zF(a,d,md),m.__reactInternalMemoizedMergedChildContext=a,Dn(wi),Dn(Jr),vn(Jr,a)):Dn(wi),vn(wi,p)}var Qs=null,ag=!1,oC=!1;function qF(a){Qs===null?Qs=[a]:Qs.push(a)}function tee(a){ag=!0,qF(a)}function ac(){if(!oC&&Qs!==null){oC=!0;var a=0,d=ln;try{var p=Qs;for(ln=1;a<p.length;a++){var m=p[a];do m=m(!0);while(m!==null)}Qs=null,ag=!1}catch(S){throw Qs!==null&&(Qs=Qs.slice(a+1)),SF(SI,ac),S}finally{ln=d,oC=!1}}return null}var ru=[],iu=0,GE=null,WE=0,So=[],To=0,Ed=null,Zs=1,$s="";function cd(a,d){ru[iu++]=WE,ru[iu++]=GE,GE=a,WE=d}function XF(a,d,p){So[To++]=Zs,So[To++]=$s,So[To++]=Ed,Ed=a;var m=Zs;a=$s;var S=32-ts(m)-1;m&=~(1<<S),p+=1;var C=32-ts(d)+S;if(30<C){var N=S-S%5;C=(m&(1<<N)-1).toString(32),m>>=N,S-=N,Zs=1<<32-ts(d)+S|p<<S|m,$s=C+a}else Zs=1<<C|p<<S|m,$s=a}function bI(a){a.return!==null&&(cd(a,1),XF(a,1,0))}function OI(a){for(;a===GE;)GE=ru[--iu],ru[iu]=null,WE=ru[--iu],ru[iu]=null;for(;a===Ed;)Ed=So[--To],So[To]=null,$s=So[--To],So[To]=null,Zs=So[--To],So[To]=null}var Ki=null,Hi=null,Vn=!1,es=null;function JF(a,d){var p=vo(5,null,null,0);p.elementType="DELETED",p.stateNode=d,p.return=a,d=a.deletions,d===null?(a.deletions=[p],a.flags|=16):d.push(p)}function rV(a,d){switch(a.tag){case 5:var p=a.type;return d=d.nodeType!==1||p.toLowerCase()!==d.nodeName.toLowerCase()?null:d,d!==null?(a.stateNode=d,Ki=a,Hi=Za(d.firstChild),!0):!1;case 6:return d=a.pendingProps===""||d.nodeType!==3?null:d,d!==null?(a.stateNode=d,Ki=a,Hi=null,!0):!1;case 13:return d=d.nodeType!==8?null:d,d!==null?(p=Ed!==null?{id:Zs,overflow:$s}:null,a.memoizedState={dehydrated:d,treeContext:p,retryLane:1073741824},p=vo(18,null,null,0),p.stateNode=d,p.return=a,a.child=p,Ki=a,Hi=null,!0):!1;default:return!1}}function WC(a){return(a.mode&1)!==0&&(a.flags&128)===0}function HC(a){if(Vn){var d=Hi;if(d){var p=d;if(!rV(a,d)){if(WC(a))throw Error(ye(418));d=Za(p.nextSibling);var m=Ki;d&&rV(a,d)?JF(m,p):(a.flags=a.flags&-4097|2,Vn=!1,Ki=a)}}else{if(WC(a))throw Error(ye(418));a.flags=a.flags&-4097|2,Vn=!1,Ki=a}}}function iV(a){for(a=a.return;a!==null&&a.tag!==5&&a.tag!==3&&a.tag!==13;)a=a.return;Ki=a}function uE(a){if(a!==Ki)return!1;if(!Vn)return iV(a),Vn=!0,!1;var d;if((d=a.tag!==3)&&!(d=a.tag!==5)&&(d=a.type,d=d!=="head"&&d!=="body"&&!FC(a.type,a.memoizedProps)),d&&(d=Hi)){if(WC(a))throw QF(),Error(ye(418));for(;d;)JF(a,d),d=Za(d.nextSibling)}if(iV(a),a.tag===13){if(a=a.memoizedState,a=a!==null?a.dehydrated:null,!a)throw Error(ye(317));e:{for(a=a.nextSibling,d=0;a;){if(a.nodeType===8){var p=a.data;if(p==="/$"){if(d===0){Hi=Za(a.nextSibling);break e}d--}else p!=="$"&&p!=="$!"&&p!=="$?"||d++}a=a.nextSibling}Hi=null}}else Hi=Ki?Za(a.stateNode.nextSibling):null;return!0}function QF(){for(var a=Hi;a;)a=Za(a.nextSibling)}function mu(){Hi=Ki=null,Vn=!1}function NI(a){es===null?es=[a]:es.push(a)}var nee=oa.ReactCurrentBatchConfig;function cp(a,d,p){if(a=p.ref,a!==null&&typeof a!="function"&&typeof a!="object"){if(p._owner){if(p=p._owner,p){if(p.tag!==1)throw Error(ye(309));var m=p.stateNode}if(!m)throw Error(ye(147,a));var S=m,C=""+a;return d!==null&&d.ref!==null&&typeof d.ref=="function"&&d.ref._stringRef===C?d.ref:(d=function(N){var F=S.refs;N===null?delete F[C]:F[C]=N},d._stringRef=C,d)}if(typeof a!="string")throw Error(ye(284));if(!p._owner)throw Error(ye(290,a))}return a}function hE(a,d){throw a=Object.prototype.toString.call(d),Error(ye(31,a==="[object Object]"?"object with keys {"+Object.keys(d).join(", ")+"}":a))}function oV(a){var d=a._init;return d(a._payload)}function ZF(a){function d(J,K){if(a){var Q=J.deletions;Q===null?(J.deletions=[K],J.flags|=16):Q.push(K)}}function p(J,K){if(!a)return null;for(;K!==null;)d(J,K),K=K.sibling;return null}function m(J,K){for(J=new Map;K!==null;)K.key!==null?J.set(K.key,K):J.set(K.index,K),K=K.sibling;return J}function S(J,K){return J=nc(J,K),J.index=0,J.sibling=null,J}function C(J,K,Q){return J.index=Q,a?(Q=J.alternate,Q!==null?(Q=Q.index,Q<K?(J.flags|=2,K):Q):(J.flags|=2,K)):(J.flags|=1048576,K)}function N(J){return a&&J.alternate===null&&(J.flags|=2),J}function F(J,K,Q,Te){return K===null||K.tag!==6?(K=hC(Q,J.mode,Te),K.return=J,K):(K=S(K,Q),K.return=J,K)}function x(J,K,Q,Te){var Ve=Q.type;return Ve===Ql?_e(J,K,Q.props.children,Te,Q.key):K!==null&&(K.elementType===Ve||typeof Ve=="object"&&Ve!==null&&Ve.$$typeof===Wa&&oV(Ve)===K.type)?(Te=S(K,Q.props),Te.ref=cp(J,K,Q),Te.return=J,Te):(Te=bE(Q.type,Q.key,Q.props,null,J.mode,Te),Te.ref=cp(J,K,Q),Te.return=J,Te)}function X(J,K,Q,Te){return K===null||K.tag!==4||K.stateNode.containerInfo!==Q.containerInfo||K.stateNode.implementation!==Q.implementation?(K=pC(Q,J.mode,Te),K.return=J,K):(K=S(K,Q.children||[]),K.return=J,K)}function _e(J,K,Q,Te,Ve){return K===null||K.tag!==7?(K=_d(Q,J.mode,Te,Ve),K.return=J,K):(K=S(K,Q),K.return=J,K)}function oe(J,K,Q){if(typeof K=="string"&&K!==""||typeof K=="number")return K=hC(""+K,J.mode,Q),K.return=J,K;if(typeof K=="object"&&K!==null){switch(K.$$typeof){case tE:return Q=bE(K.type,K.key,K.props,null,J.mode,Q),Q.ref=cp(J,null,K),Q.return=J,Q;case Jl:return K=pC(K,J.mode,Q),K.return=J,K;case Wa:var Te=K._init;return oe(J,Te(K._payload),Q)}if(hp(K)||rp(K))return K=_d(K,J.mode,Q,null),K.return=J,K;hE(J,K)}return null}function re(J,K,Q,Te){var Ve=K!==null?K.key:null;if(typeof Q=="string"&&Q!==""||typeof Q=="number")return Ve!==null?null:F(J,K,""+Q,Te);if(typeof Q=="object"&&Q!==null){switch(Q.$$typeof){case tE:return Q.key===Ve?x(J,K,Q,Te):null;case Jl:return Q.key===Ve?X(J,K,Q,Te):null;case Wa:return Ve=Q._init,re(J,K,Ve(Q._payload),Te)}if(hp(Q)||rp(Q))return Ve!==null?null:_e(J,K,Q,Te,null);hE(J,Q)}return null}function Ce(J,K,Q,Te,Ve){if(typeof Te=="string"&&Te!==""||typeof Te=="number")return J=J.get(Q)||null,F(K,J,""+Te,Ve);if(typeof Te=="object"&&Te!==null){switch(Te.$$typeof){case tE:return J=J.get(Te.key===null?Q:Te.key)||null,x(K,J,Te,Ve);case Jl:return J=J.get(Te.key===null?Q:Te.key)||null,X(K,J,Te,Ve);case Wa:var Be=Te._init;return Ce(J,K,Q,Be(Te._payload),Ve)}if(hp(Te)||rp(Te))return J=J.get(Q)||null,_e(K,J,Te,Ve,null);hE(K,Te)}return null}function fe(J,K,Q,Te){for(var Ve=null,Be=null,Me=K,ze=K=0,Kt=null;Me!==null&&ze<Q.length;ze++){Me.index>ze?(Kt=Me,Me=null):Kt=Me.sibling;var ht=re(J,Me,Q[ze],Te);if(ht===null){Me===null&&(Me=Kt);break}a&&Me&&ht.alternate===null&&d(J,Me),K=C(ht,K,ze),Be===null?Ve=ht:Be.sibling=ht,Be=ht,Me=Kt}if(ze===Q.length)return p(J,Me),Vn&&cd(J,ze),Ve;if(Me===null){for(;ze<Q.length;ze++)Me=oe(J,Q[ze],Te),Me!==null&&(K=C(Me,K,ze),Be===null?Ve=Me:Be.sibling=Me,Be=Me);return Vn&&cd(J,ze),Ve}for(Me=m(J,Me);ze<Q.length;ze++)Kt=Ce(Me,J,ze,Q[ze],Te),Kt!==null&&(a&&Kt.alternate!==null&&Me.delete(Kt.key===null?ze:Kt.key),K=C(Kt,K,ze),Be===null?Ve=Kt:Be.sibling=Kt,Be=Kt);return a&&Me.forEach(function(Ye){return d(J,Ye)}),Vn&&cd(J,ze),Ve}function Oe(J,K,Q,Te){var Ve=rp(Q);if(typeof Ve!="function")throw Error(ye(150));if(Q=Ve.call(Q),Q==null)throw Error(ye(151));for(var Be=Ve=null,Me=K,ze=K=0,Kt=null,ht=Q.next();Me!==null&&!ht.done;ze++,ht=Q.next()){Me.index>ze?(Kt=Me,Me=null):Kt=Me.sibling;var Ye=re(J,Me,ht.value,Te);if(Ye===null){Me===null&&(Me=Kt);break}a&&Me&&Ye.alternate===null&&d(J,Me),K=C(Ye,K,ze),Be===null?Ve=Ye:Be.sibling=Ye,Be=Ye,Me=Kt}if(ht.done)return p(J,Me),Vn&&cd(J,ze),Ve;if(Me===null){for(;!ht.done;ze++,ht=Q.next())ht=oe(J,ht.value,Te),ht!==null&&(K=C(ht,K,ze),Be===null?Ve=ht:Be.sibling=ht,Be=ht);return Vn&&cd(J,ze),Ve}for(Me=m(J,Me);!ht.done;ze++,ht=Q.next())ht=Ce(Me,J,ze,ht.value,Te),ht!==null&&(a&&ht.alternate!==null&&Me.delete(ht.key===null?ze:ht.key),K=C(ht,K,ze),Be===null?Ve=ht:Be.sibling=ht,Be=ht);return a&&Me.forEach(function(qe){return d(J,qe)}),Vn&&cd(J,ze),Ve}function Vt(J,K,Q,Te){if(typeof Q=="object"&&Q!==null&&Q.type===Ql&&Q.key===null&&(Q=Q.props.children),typeof Q=="object"&&Q!==null){switch(Q.$$typeof){case tE:e:{for(var Ve=Q.key,Be=K;Be!==null;){if(Be.key===Ve){if(Ve=Q.type,Ve===Ql){if(Be.tag===7){p(J,Be.sibling),K=S(Be,Q.props.children),K.return=J,J=K;break e}}else if(Be.elementType===Ve||typeof Ve=="object"&&Ve!==null&&Ve.$$typeof===Wa&&oV(Ve)===Be.type){p(J,Be.sibling),K=S(Be,Q.props),K.ref=cp(J,Be,Q),K.return=J,J=K;break e}p(J,Be);break}else d(J,Be);Be=Be.sibling}Q.type===Ql?(K=_d(Q.props.children,J.mode,Te,Q.key),K.return=J,J=K):(Te=bE(Q.type,Q.key,Q.props,null,J.mode,Te),Te.ref=cp(J,K,Q),Te.return=J,J=Te)}return N(J);case Jl:e:{for(Be=Q.key;K!==null;){if(K.key===Be)if(K.tag===4&&K.stateNode.containerInfo===Q.containerInfo&&K.stateNode.implementation===Q.implementation){p(J,K.sibling),K=S(K,Q.children||[]),K.return=J,J=K;break e}else{p(J,K);break}else d(J,K);K=K.sibling}K=pC(Q,J.mode,Te),K.return=J,J=K}return N(J);case Wa:return Be=Q._init,Vt(J,K,Be(Q._payload),Te)}if(hp(Q))return fe(J,K,Q,Te);if(rp(Q))return Oe(J,K,Q,Te);hE(J,Q)}return typeof Q=="string"&&Q!==""||typeof Q=="number"?(Q=""+Q,K!==null&&K.tag===6?(p(J,K.sibling),K=S(K,Q),K.return=J,J=K):(p(J,K),K=hC(Q,J.mode,Te),K.return=J,J=K),N(J)):p(J,K)}return Vt}var Eu=ZF(!0),$F=ZF(!1),HE=sc(null),KE=null,ou=null,DI=null;function PI(){DI=ou=KE=null}function LI(a){var d=HE.current;Dn(HE),a._currentValue=d}function KC(a,d,p){for(;a!==null;){var m=a.alternate;if((a.childLanes&d)!==d?(a.childLanes|=d,m!==null&&(m.childLanes|=d)):m!==null&&(m.childLanes&d)!==d&&(m.childLanes|=d),a===p)break;a=a.return}}function hu(a,d){KE=a,DI=ou=null,a=a.dependencies,a!==null&&a.firstContext!==null&&(a.lanes&d&&(Ii=!0),a.firstContext=null)}function yo(a){var d=a._currentValue;if(DI!==a)if(a={context:a,memoizedValue:d,next:null},ou===null){if(KE===null)throw Error(ye(308));ou=a,KE.dependencies={lanes:0,firstContext:a}}else ou=ou.next=a;return d}var hd=null;function kI(a){hd===null?hd=[a]:hd.push(a)}function eB(a,d,p,m){var S=d.interleaved;return S===null?(p.next=p,kI(d)):(p.next=S.next,S.next=p),d.interleaved=p,ra(a,m)}function ra(a,d){a.lanes|=d;var p=a.alternate;for(p!==null&&(p.lanes|=d),p=a,a=a.return;a!==null;)a.childLanes|=d,p=a.alternate,p!==null&&(p.childLanes|=d),p=a,a=a.return;return p.tag===3?p.stateNode:null}var Ha=!1;function MI(a){a.updateQueue={baseState:a.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function tB(a,d){a=a.updateQueue,d.updateQueue===a&&(d.updateQueue={baseState:a.baseState,firstBaseUpdate:a.firstBaseUpdate,lastBaseUpdate:a.lastBaseUpdate,shared:a.shared,effects:a.effects})}function ea(a,d){return{eventTime:a,lane:d,tag:0,payload:null,callback:null,next:null}}function $a(a,d,p){var m=a.updateQueue;if(m===null)return null;if(m=m.shared,Jt&2){var S=m.pending;return S===null?d.next=d:(d.next=S.next,S.next=d),m.pending=d,ra(a,p)}return S=m.interleaved,S===null?(d.next=d,kI(m)):(d.next=S.next,S.next=d),m.interleaved=d,ra(a,p)}function RE(a,d,p){if(d=d.updateQueue,d!==null&&(d=d.shared,(p&4194240)!==0)){var m=d.lanes;m&=a.pendingLanes,p|=m,d.lanes=p,TI(a,p)}}function sV(a,d){var p=a.updateQueue,m=a.alternate;if(m!==null&&(m=m.updateQueue,p===m)){var S=null,C=null;if(p=p.firstBaseUpdate,p!==null){do{var N={eventTime:p.eventTime,lane:p.lane,tag:p.tag,payload:p.payload,callback:p.callback,next:null};C===null?S=C=N:C=C.next=N,p=p.next}while(p!==null);C===null?S=C=d:C=C.next=d}else S=C=d;p={baseState:m.baseState,firstBaseUpdate:S,lastBaseUpdate:C,shared:m.shared,effects:m.effects},a.updateQueue=p;return}a=p.lastBaseUpdate,a===null?p.firstBaseUpdate=d:a.next=d,p.lastBaseUpdate=d}function YE(a,d,p,m){var S=a.updateQueue;Ha=!1;var C=S.firstBaseUpdate,N=S.lastBaseUpdate,F=S.shared.pending;if(F!==null){S.shared.pending=null;var x=F,X=x.next;x.next=null,N===null?C=X:N.next=X,N=x;var _e=a.alternate;_e!==null&&(_e=_e.updateQueue,F=_e.lastBaseUpdate,F!==N&&(F===null?_e.firstBaseUpdate=X:F.next=X,_e.lastBaseUpdate=x))}if(C!==null){var oe=S.baseState;N=0,_e=X=x=null,F=C;do{var re=F.lane,Ce=F.eventTime;if((m&re)===re){_e!==null&&(_e=_e.next={eventTime:Ce,lane:0,tag:F.tag,payload:F.payload,callback:F.callback,next:null});e:{var fe=a,Oe=F;switch(re=d,Ce=p,Oe.tag){case 1:if(fe=Oe.payload,typeof fe=="function"){oe=fe.call(Ce,oe,re);break e}oe=fe;break e;case 3:fe.flags=fe.flags&-65537|128;case 0:if(fe=Oe.payload,re=typeof fe=="function"?fe.call(Ce,oe,re):fe,re==null)break e;oe=Yn({},oe,re);break e;case 2:Ha=!0}}F.callback!==null&&F.lane!==0&&(a.flags|=64,re=S.effects,re===null?S.effects=[F]:re.push(F))}else Ce={eventTime:Ce,lane:re,tag:F.tag,payload:F.payload,callback:F.callback,next:null},_e===null?(X=_e=Ce,x=oe):_e=_e.next=Ce,N|=re;if(F=F.next,F===null){if(F=S.shared.pending,F===null)break;re=F,F=re.next,re.next=null,S.lastBaseUpdate=re,S.shared.pending=null}}while(!0);if(_e===null&&(x=oe),S.baseState=x,S.firstBaseUpdate=X,S.lastBaseUpdate=_e,d=S.shared.interleaved,d!==null){S=d;do N|=S.lane,S=S.next;while(S!==d)}else C===null&&(S.shared.lanes=0);Sd|=N,a.lanes=N,a.memoizedState=oe}}function aV(a,d,p){if(a=d.effects,d.effects=null,a!==null)for(d=0;d<a.length;d++){var m=a[d],S=m.callback;if(S!==null){if(m.callback=null,m=p,typeof S!="function")throw Error(ye(191,S));S.call(m)}}}var Yp={},Ps=sc(Yp),Up=sc(Yp),xp=sc(Yp);function pd(a){if(a===Yp)throw Error(ye(174));return a}function UI(a,d){switch(vn(xp,d),vn(Up,a),vn(Ps,Yp),a=d.nodeType,a){case 9:case 11:d=(d=d.documentElement)?d.namespaceURI:IC(null,"");break;default:a=a===8?d.parentNode:d,d=a.namespaceURI||null,a=a.tagName,d=IC(d,a)}Dn(Ps),vn(Ps,d)}function gu(){Dn(Ps),Dn(Up),Dn(xp)}function nB(a){pd(xp.current);var d=pd(Ps.current),p=IC(d,a.type);d!==p&&(vn(Up,a),vn(Ps,p))}function xI(a){Up.current===a&&(Dn(Ps),Dn(Up))}var Hn=sc(0);function zE(a){for(var d=a;d!==null;){if(d.tag===13){var p=d.memoizedState;if(p!==null&&(p=p.dehydrated,p===null||p.data==="$?"||p.data==="$!"))return d}else if(d.tag===19&&d.memoizedProps.revealOrder!==void 0){if(d.flags&128)return d}else if(d.child!==null){d.child.return=d,d=d.child;continue}if(d===a)break;for(;d.sibling===null;){if(d.return===null||d.return===a)return null;d=d.return}d.sibling.return=d.return,d=d.sibling}return null}var sC=[];function VI(){for(var a=0;a<sC.length;a++)sC[a]._workInProgressVersionPrimary=null;sC.length=0}var yE=oa.ReactCurrentDispatcher,aC=oa.ReactCurrentBatchConfig,gd=0,Kn=null,hr=null,yr=null,qE=!1,vp=!1,Vp=0,ree=0;function zr(){throw Error(ye(321))}function FI(a,d){if(d===null)return!1;for(var p=0;p<d.length&&p<a.length;p++)if(!rs(a[p],d[p]))return!1;return!0}function BI(a,d,p,m,S,C){if(gd=C,Kn=d,d.memoizedState=null,d.updateQueue=null,d.lanes=0,yE.current=a===null||a.memoizedState===null?aee:cee,a=p(m,S),vp){C=0;do{if(vp=!1,Vp=0,25<=C)throw Error(ye(301));C+=1,yr=hr=null,d.updateQueue=null,yE.current=dee,a=p(m,S)}while(vp)}if(yE.current=XE,d=hr!==null&&hr.next!==null,gd=0,yr=hr=Kn=null,qE=!1,d)throw Error(ye(300));return a}function jI(){var a=Vp!==0;return Vp=0,a}function Os(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return yr===null?Kn.memoizedState=yr=a:yr=yr.next=a,yr}function Co(){if(hr===null){var a=Kn.alternate;a=a!==null?a.memoizedState:null}else a=hr.next;var d=yr===null?Kn.memoizedState:yr.next;if(d!==null)yr=d,hr=a;else{if(a===null)throw Error(ye(310));hr=a,a={memoizedState:hr.memoizedState,baseState:hr.baseState,baseQueue:hr.baseQueue,queue:hr.queue,next:null},yr===null?Kn.memoizedState=yr=a:yr=yr.next=a}return yr}function Fp(a,d){return typeof d=="function"?d(a):d}function cC(a){var d=Co(),p=d.queue;if(p===null)throw Error(ye(311));p.lastRenderedReducer=a;var m=hr,S=m.baseQueue,C=p.pending;if(C!==null){if(S!==null){var N=S.next;S.next=C.next,C.next=N}m.baseQueue=S=C,p.pending=null}if(S!==null){C=S.next,m=m.baseState;var F=N=null,x=null,X=C;do{var _e=X.lane;if((gd&_e)===_e)x!==null&&(x=x.next={lane:0,action:X.action,hasEagerState:X.hasEagerState,eagerState:X.eagerState,next:null}),m=X.hasEagerState?X.eagerState:a(m,X.action);else{var oe={lane:_e,action:X.action,hasEagerState:X.hasEagerState,eagerState:X.eagerState,next:null};x===null?(F=x=oe,N=m):x=x.next=oe,Kn.lanes|=_e,Sd|=_e}X=X.next}while(X!==null&&X!==C);x===null?N=m:x.next=F,rs(m,d.memoizedState)||(Ii=!0),d.memoizedState=m,d.baseState=N,d.baseQueue=x,p.lastRenderedState=m}if(a=p.interleaved,a!==null){S=a;do C=S.lane,Kn.lanes|=C,Sd|=C,S=S.next;while(S!==a)}else S===null&&(p.lanes=0);return[d.memoizedState,p.dispatch]}function dC(a){var d=Co(),p=d.queue;if(p===null)throw Error(ye(311));p.lastRenderedReducer=a;var m=p.dispatch,S=p.pending,C=d.memoizedState;if(S!==null){p.pending=null;var N=S=S.next;do C=a(C,N.action),N=N.next;while(N!==S);rs(C,d.memoizedState)||(Ii=!0),d.memoizedState=C,d.baseQueue===null&&(d.baseState=C),p.lastRenderedState=C}return[C,m]}function rB(){}function iB(a,d){var p=Kn,m=Co(),S=d(),C=!rs(m.memoizedState,S);if(C&&(m.memoizedState=S,Ii=!0),m=m.queue,GI(aB.bind(null,p,m,a),[a]),m.getSnapshot!==d||C||yr!==null&&yr.memoizedState.tag&1){if(p.flags|=2048,Bp(9,sB.bind(null,p,m,S,d),void 0,null),Cr===null)throw Error(ye(349));gd&30||oB(p,d,S)}return S}function oB(a,d,p){a.flags|=16384,a={getSnapshot:d,value:p},d=Kn.updateQueue,d===null?(d={lastEffect:null,stores:null},Kn.updateQueue=d,d.stores=[a]):(p=d.stores,p===null?d.stores=[a]:p.push(a))}function sB(a,d,p,m){d.value=p,d.getSnapshot=m,cB(d)&&dB(a)}function aB(a,d,p){return p(function(){cB(d)&&dB(a)})}function cB(a){var d=a.getSnapshot;a=a.value;try{var p=d();return!rs(a,p)}catch{return!0}}function dB(a){var d=ra(a,1);d!==null&&ns(d,a,1,-1)}function cV(a){var d=Os();return typeof a=="function"&&(a=a()),d.memoizedState=d.baseState=a,a={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Fp,lastRenderedState:a},d.queue=a,a=a.dispatch=see.bind(null,Kn,a),[d.memoizedState,a]}function Bp(a,d,p,m){return a={tag:a,create:d,destroy:p,deps:m,next:null},d=Kn.updateQueue,d===null?(d={lastEffect:null,stores:null},Kn.updateQueue=d,d.lastEffect=a.next=a):(p=d.lastEffect,p===null?d.lastEffect=a.next=a:(m=p.next,p.next=a,a.next=m,d.lastEffect=a)),a}function lB(){return Co().memoizedState}function CE(a,d,p,m){var S=Os();Kn.flags|=a,S.memoizedState=Bp(1|d,p,void 0,m===void 0?null:m)}function cg(a,d,p,m){var S=Co();m=m===void 0?null:m;var C=void 0;if(hr!==null){var N=hr.memoizedState;if(C=N.destroy,m!==null&&FI(m,N.deps)){S.memoizedState=Bp(d,p,C,m);return}}Kn.flags|=a,S.memoizedState=Bp(1|d,p,C,m)}function dV(a,d){return CE(8390656,8,a,d)}function GI(a,d){return cg(2048,8,a,d)}function uB(a,d){return cg(4,2,a,d)}function hB(a,d){return cg(4,4,a,d)}function pB(a,d){if(typeof d=="function")return a=a(),d(a),function(){d(null)};if(d!=null)return a=a(),d.current=a,function(){d.current=null}}function fB(a,d,p){return p=p!=null?p.concat([a]):null,cg(4,4,pB.bind(null,d,a),p)}function WI(){}function _B(a,d){var p=Co();d=d===void 0?null:d;var m=p.memoizedState;return m!==null&&d!==null&&FI(d,m[1])?m[0]:(p.memoizedState=[a,d],a)}function mB(a,d){var p=Co();d=d===void 0?null:d;var m=p.memoizedState;return m!==null&&d!==null&&FI(d,m[1])?m[0]:(a=a(),p.memoizedState=[a,d],a)}function EB(a,d,p){return gd&21?(rs(p,d)||(p=RF(),Kn.lanes|=p,Sd|=p,a.baseState=!0),d):(a.baseState&&(a.baseState=!1,Ii=!0),a.memoizedState=p)}function iee(a,d){var p=ln;ln=p!==0&&4>p?p:4,a(!0);var m=aC.transition;aC.transition={};try{a(!1),d()}finally{ln=p,aC.transition=m}}function gB(){return Co().memoizedState}function oee(a,d,p){var m=tc(a);if(p={lane:m,action:p,hasEagerState:!1,eagerState:null,next:null},SB(a))TB(d,p);else if(p=eB(a,d,p,m),p!==null){var S=si();ns(p,a,m,S),vB(p,d,m)}}function see(a,d,p){var m=tc(a),S={lane:m,action:p,hasEagerState:!1,eagerState:null,next:null};if(SB(a))TB(d,S);else{var C=a.alternate;if(a.lanes===0&&(C===null||C.lanes===0)&&(C=d.lastRenderedReducer,C!==null))try{var N=d.lastRenderedState,F=C(N,p);if(S.hasEagerState=!0,S.eagerState=F,rs(F,N)){var x=d.interleaved;x===null?(S.next=S,kI(d)):(S.next=x.next,x.next=S),d.interleaved=S;return}}catch{}finally{}p=eB(a,d,S,m),p!==null&&(S=si(),ns(p,a,m,S),vB(p,d,m))}}function SB(a){var d=a.alternate;return a===Kn||d!==null&&d===Kn}function TB(a,d){vp=qE=!0;var p=a.pending;p===null?d.next=d:(d.next=p.next,p.next=d),a.pending=d}function vB(a,d,p){if(p&4194240){var m=d.lanes;m&=a.pendingLanes,p|=m,d.lanes=p,TI(a,p)}}var XE={readContext:yo,useCallback:zr,useContext:zr,useEffect:zr,useImperativeHandle:zr,useInsertionEffect:zr,useLayoutEffect:zr,useMemo:zr,useReducer:zr,useRef:zr,useState:zr,useDebugValue:zr,useDeferredValue:zr,useTransition:zr,useMutableSource:zr,useSyncExternalStore:zr,useId:zr,unstable_isNewReconciler:!1},aee={readContext:yo,useCallback:function(a,d){return Os().memoizedState=[a,d===void 0?null:d],a},useContext:yo,useEffect:dV,useImperativeHandle:function(a,d,p){return p=p!=null?p.concat([a]):null,CE(4194308,4,pB.bind(null,d,a),p)},useLayoutEffect:function(a,d){return CE(4194308,4,a,d)},useInsertionEffect:function(a,d){return CE(4,2,a,d)},useMemo:function(a,d){var p=Os();return d=d===void 0?null:d,a=a(),p.memoizedState=[a,d],a},useReducer:function(a,d,p){var m=Os();return d=p!==void 0?p(d):d,m.memoizedState=m.baseState=d,a={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:a,lastRenderedState:d},m.queue=a,a=a.dispatch=oee.bind(null,Kn,a),[m.memoizedState,a]},useRef:function(a){var d=Os();return a={current:a},d.memoizedState=a},useState:cV,useDebugValue:WI,useDeferredValue:function(a){return Os().memoizedState=a},useTransition:function(){var a=cV(!1),d=a[0];return a=iee.bind(null,a[1]),Os().memoizedState=a,[d,a]},useMutableSource:function(){},useSyncExternalStore:function(a,d,p){var m=Kn,S=Os();if(Vn){if(p===void 0)throw Error(ye(407));p=p()}else{if(p=d(),Cr===null)throw Error(ye(349));gd&30||oB(m,d,p)}S.memoizedState=p;var C={value:p,getSnapshot:d};return S.queue=C,dV(aB.bind(null,m,C,a),[a]),m.flags|=2048,Bp(9,sB.bind(null,m,C,p,d),void 0,null),p},useId:function(){var a=Os(),d=Cr.identifierPrefix;if(Vn){var p=$s,m=Zs;p=(m&~(1<<32-ts(m)-1)).toString(32)+p,d=":"+d+"R"+p,p=Vp++,0<p&&(d+="H"+p.toString(32)),d+=":"}else p=ree++,d=":"+d+"r"+p.toString(32)+":";return a.memoizedState=d},unstable_isNewReconciler:!1},cee={readContext:yo,useCallback:_B,useContext:yo,useEffect:GI,useImperativeHandle:fB,useInsertionEffect:uB,useLayoutEffect:hB,useMemo:mB,useReducer:cC,useRef:lB,useState:function(){return cC(Fp)},useDebugValue:WI,useDeferredValue:function(a){var d=Co();return EB(d,hr.memoizedState,a)},useTransition:function(){var a=cC(Fp)[0],d=Co().memoizedState;return[a,d]},useMutableSource:rB,useSyncExternalStore:iB,useId:gB,unstable_isNewReconciler:!1},dee={readContext:yo,useCallback:_B,useContext:yo,useEffect:GI,useImperativeHandle:fB,useInsertionEffect:uB,useLayoutEffect:hB,useMemo:mB,useReducer:dC,useRef:lB,useState:function(){return dC(Fp)},useDebugValue:WI,useDeferredValue:function(a){var d=Co();return hr===null?d.memoizedState=a:EB(d,hr.memoizedState,a)},useTransition:function(){var a=dC(Fp)[0],d=Co().memoizedState;return[a,d]},useMutableSource:rB,useSyncExternalStore:iB,useId:gB,unstable_isNewReconciler:!1};function Zo(a,d){if(a&&a.defaultProps){d=Yn({},d),a=a.defaultProps;for(var p in a)d[p]===void 0&&(d[p]=a[p]);return d}return d}function YC(a,d,p,m){d=a.memoizedState,p=p(m,d),p=p==null?d:Yn({},d,p),a.memoizedState=p,a.lanes===0&&(a.updateQueue.baseState=p)}var dg={isMounted:function(a){return(a=a._reactInternals)?Rd(a)===a:!1},enqueueSetState:function(a,d,p){a=a._reactInternals;var m=si(),S=tc(a),C=ea(m,S);C.payload=d,p!=null&&(C.callback=p),d=$a(a,C,S),d!==null&&(ns(d,a,S,m),RE(d,a,S))},enqueueReplaceState:function(a,d,p){a=a._reactInternals;var m=si(),S=tc(a),C=ea(m,S);C.tag=1,C.payload=d,p!=null&&(C.callback=p),d=$a(a,C,S),d!==null&&(ns(d,a,S,m),RE(d,a,S))},enqueueForceUpdate:function(a,d){a=a._reactInternals;var p=si(),m=tc(a),S=ea(p,m);S.tag=2,d!=null&&(S.callback=d),d=$a(a,S,m),d!==null&&(ns(d,a,m,p),RE(d,a,m))}};function lV(a,d,p,m,S,C,N){return a=a.stateNode,typeof a.shouldComponentUpdate=="function"?a.shouldComponentUpdate(m,C,N):d.prototype&&d.prototype.isPureReactComponent?!Pp(p,m)||!Pp(S,C):!0}function RB(a,d,p){var m=!1,S=ic,C=d.contextType;return typeof C=="object"&&C!==null?C=yo(C):(S=Ai(d)?md:Jr.current,m=d.contextTypes,C=(m=m!=null)?_u(a,S):ic),d=new d(p,C),a.memoizedState=d.state!==null&&d.state!==void 0?d.state:null,d.updater=dg,a.stateNode=d,d._reactInternals=a,m&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=S,a.__reactInternalMemoizedMaskedChildContext=C),d}function uV(a,d,p,m){a=d.state,typeof d.componentWillReceiveProps=="function"&&d.componentWillReceiveProps(p,m),typeof d.UNSAFE_componentWillReceiveProps=="function"&&d.UNSAFE_componentWillReceiveProps(p,m),d.state!==a&&dg.enqueueReplaceState(d,d.state,null)}function zC(a,d,p,m){var S=a.stateNode;S.props=p,S.state=a.memoizedState,S.refs={},MI(a);var C=d.contextType;typeof C=="object"&&C!==null?S.context=yo(C):(C=Ai(d)?md:Jr.current,S.context=_u(a,C)),S.state=a.memoizedState,C=d.getDerivedStateFromProps,typeof C=="function"&&(YC(a,d,C,p),S.state=a.memoizedState),typeof d.getDerivedStateFromProps=="function"||typeof S.getSnapshotBeforeUpdate=="function"||typeof S.UNSAFE_componentWillMount!="function"&&typeof S.componentWillMount!="function"||(d=S.state,typeof S.componentWillMount=="function"&&S.componentWillMount(),typeof S.UNSAFE_componentWillMount=="function"&&S.UNSAFE_componentWillMount(),d!==S.state&&dg.enqueueReplaceState(S,S.state,null),YE(a,p,S,m),S.state=a.memoizedState),typeof S.componentDidMount=="function"&&(a.flags|=4194308)}function Su(a,d){try{var p="",m=d;do p+=xZ(m),m=m.return;while(m);var S=p}catch(C){S=`
Error generating stack: `+C.message+`
`+C.stack}return{value:a,source:d,stack:S,digest:null}}function lC(a,d,p){return{value:a,source:null,stack:p??null,digest:d??null}}function qC(a,d){try{console.error(d.value)}catch(p){setTimeout(function(){throw p})}}var lee=typeof WeakMap=="function"?WeakMap:Map;function yB(a,d,p){p=ea(-1,p),p.tag=3,p.payload={element:null};var m=d.value;return p.callback=function(){QE||(QE=!0,iI=m),qC(a,d)},p}function CB(a,d,p){p=ea(-1,p),p.tag=3;var m=a.type.getDerivedStateFromError;if(typeof m=="function"){var S=d.value;p.payload=function(){return m(S)},p.callback=function(){qC(a,d)}}var C=a.stateNode;return C!==null&&typeof C.componentDidCatch=="function"&&(p.callback=function(){qC(a,d),typeof m!="function"&&(ec===null?ec=new Set([this]):ec.add(this));var N=d.stack;this.componentDidCatch(d.value,{componentStack:N!==null?N:""})}),p}function hV(a,d,p){var m=a.pingCache;if(m===null){m=a.pingCache=new lee;var S=new Set;m.set(d,S)}else S=m.get(d),S===void 0&&(S=new Set,m.set(d,S));S.has(p)||(S.add(p),a=Cee.bind(null,a,d,p),d.then(a,a))}function pV(a){do{var d;if((d=a.tag===13)&&(d=a.memoizedState,d=d!==null?d.dehydrated!==null:!0),d)return a;a=a.return}while(a!==null);return null}function fV(a,d,p,m,S){return a.mode&1?(a.flags|=65536,a.lanes=S,a):(a===d?a.flags|=65536:(a.flags|=128,p.flags|=131072,p.flags&=-52805,p.tag===1&&(p.alternate===null?p.tag=17:(d=ea(-1,1),d.tag=2,$a(p,d,1))),p.lanes|=1),a)}var uee=oa.ReactCurrentOwner,Ii=!1;function oi(a,d,p,m){d.child=a===null?$F(d,null,p,m):Eu(d,a.child,p,m)}function _V(a,d,p,m,S){p=p.render;var C=d.ref;return hu(d,S),m=BI(a,d,p,m,C,S),p=jI(),a!==null&&!Ii?(d.updateQueue=a.updateQueue,d.flags&=-2053,a.lanes&=~S,ia(a,d,S)):(Vn&&p&&bI(d),d.flags|=1,oi(a,d,m,S),d.child)}function mV(a,d,p,m,S){if(a===null){var C=p.type;return typeof C=="function"&&!QI(C)&&C.defaultProps===void 0&&p.compare===null&&p.defaultProps===void 0?(d.tag=15,d.type=C,IB(a,d,C,m,S)):(a=bE(p.type,null,m,d,d.mode,S),a.ref=d.ref,a.return=d,d.child=a)}if(C=a.child,!(a.lanes&S)){var N=C.memoizedProps;if(p=p.compare,p=p!==null?p:Pp,p(N,m)&&a.ref===d.ref)return ia(a,d,S)}return d.flags|=1,a=nc(C,m),a.ref=d.ref,a.return=d,d.child=a}function IB(a,d,p,m,S){if(a!==null){var C=a.memoizedProps;if(Pp(C,m)&&a.ref===d.ref)if(Ii=!1,d.pendingProps=m=C,(a.lanes&S)!==0)a.flags&131072&&(Ii=!0);else return d.lanes=a.lanes,ia(a,d,S)}return XC(a,d,p,m,S)}function wB(a,d,p){var m=d.pendingProps,S=m.children,C=a!==null?a.memoizedState:null;if(m.mode==="hidden")if(!(d.mode&1))d.memoizedState={baseLanes:0,cachePool:null,transitions:null},vn(au,Wi),Wi|=p;else{if(!(p&1073741824))return a=C!==null?C.baseLanes|p:p,d.lanes=d.childLanes=1073741824,d.memoizedState={baseLanes:a,cachePool:null,transitions:null},d.updateQueue=null,vn(au,Wi),Wi|=a,null;d.memoizedState={baseLanes:0,cachePool:null,transitions:null},m=C!==null?C.baseLanes:p,vn(au,Wi),Wi|=m}else C!==null?(m=C.baseLanes|p,d.memoizedState=null):m=p,vn(au,Wi),Wi|=m;return oi(a,d,S,p),d.child}function AB(a,d){var p=d.ref;(a===null&&p!==null||a!==null&&a.ref!==p)&&(d.flags|=512,d.flags|=2097152)}function XC(a,d,p,m,S){var C=Ai(p)?md:Jr.current;return C=_u(d,C),hu(d,S),p=BI(a,d,p,m,C,S),m=jI(),a!==null&&!Ii?(d.updateQueue=a.updateQueue,d.flags&=-2053,a.lanes&=~S,ia(a,d,S)):(Vn&&m&&bI(d),d.flags|=1,oi(a,d,p,S),d.child)}function EV(a,d,p,m,S){if(Ai(p)){var C=!0;jE(d)}else C=!1;if(hu(d,S),d.stateNode===null)IE(a,d),RB(d,p,m),zC(d,p,m,S),m=!0;else if(a===null){var N=d.stateNode,F=d.memoizedProps;N.props=F;var x=N.context,X=p.contextType;typeof X=="object"&&X!==null?X=yo(X):(X=Ai(p)?md:Jr.current,X=_u(d,X));var _e=p.getDerivedStateFromProps,oe=typeof _e=="function"||typeof N.getSnapshotBeforeUpdate=="function";oe||typeof N.UNSAFE_componentWillReceiveProps!="function"&&typeof N.componentWillReceiveProps!="function"||(F!==m||x!==X)&&uV(d,N,m,X),Ha=!1;var re=d.memoizedState;N.state=re,YE(d,m,N,S),x=d.memoizedState,F!==m||re!==x||wi.current||Ha?(typeof _e=="function"&&(YC(d,p,_e,m),x=d.memoizedState),(F=Ha||lV(d,p,F,m,re,x,X))?(oe||typeof N.UNSAFE_componentWillMount!="function"&&typeof N.componentWillMount!="function"||(typeof N.componentWillMount=="function"&&N.componentWillMount(),typeof N.UNSAFE_componentWillMount=="function"&&N.UNSAFE_componentWillMount()),typeof N.componentDidMount=="function"&&(d.flags|=4194308)):(typeof N.componentDidMount=="function"&&(d.flags|=4194308),d.memoizedProps=m,d.memoizedState=x),N.props=m,N.state=x,N.context=X,m=F):(typeof N.componentDidMount=="function"&&(d.flags|=4194308),m=!1)}else{N=d.stateNode,tB(a,d),F=d.memoizedProps,X=d.type===d.elementType?F:Zo(d.type,F),N.props=X,oe=d.pendingProps,re=N.context,x=p.contextType,typeof x=="object"&&x!==null?x=yo(x):(x=Ai(p)?md:Jr.current,x=_u(d,x));var Ce=p.getDerivedStateFromProps;(_e=typeof Ce=="function"||typeof N.getSnapshotBeforeUpdate=="function")||typeof N.UNSAFE_componentWillReceiveProps!="function"&&typeof N.componentWillReceiveProps!="function"||(F!==oe||re!==x)&&uV(d,N,m,x),Ha=!1,re=d.memoizedState,N.state=re,YE(d,m,N,S);var fe=d.memoizedState;F!==oe||re!==fe||wi.current||Ha?(typeof Ce=="function"&&(YC(d,p,Ce,m),fe=d.memoizedState),(X=Ha||lV(d,p,X,m,re,fe,x)||!1)?(_e||typeof N.UNSAFE_componentWillUpdate!="function"&&typeof N.componentWillUpdate!="function"||(typeof N.componentWillUpdate=="function"&&N.componentWillUpdate(m,fe,x),typeof N.UNSAFE_componentWillUpdate=="function"&&N.UNSAFE_componentWillUpdate(m,fe,x)),typeof N.componentDidUpdate=="function"&&(d.flags|=4),typeof N.getSnapshotBeforeUpdate=="function"&&(d.flags|=1024)):(typeof N.componentDidUpdate!="function"||F===a.memoizedProps&&re===a.memoizedState||(d.flags|=4),typeof N.getSnapshotBeforeUpdate!="function"||F===a.memoizedProps&&re===a.memoizedState||(d.flags|=1024),d.memoizedProps=m,d.memoizedState=fe),N.props=m,N.state=fe,N.context=x,m=X):(typeof N.componentDidUpdate!="function"||F===a.memoizedProps&&re===a.memoizedState||(d.flags|=4),typeof N.getSnapshotBeforeUpdate!="function"||F===a.memoizedProps&&re===a.memoizedState||(d.flags|=1024),m=!1)}return JC(a,d,p,m,C,S)}function JC(a,d,p,m,S,C){AB(a,d);var N=(d.flags&128)!==0;if(!m&&!N)return S&&nV(d,p,!1),ia(a,d,C);m=d.stateNode,uee.current=d;var F=N&&typeof p.getDerivedStateFromError!="function"?null:m.render();return d.flags|=1,a!==null&&N?(d.child=Eu(d,a.child,null,C),d.child=Eu(d,null,F,C)):oi(a,d,F,C),d.memoizedState=m.state,S&&nV(d,p,!0),d.child}function bB(a){var d=a.stateNode;d.pendingContext?tV(a,d.pendingContext,d.pendingContext!==d.context):d.context&&tV(a,d.context,!1),UI(a,d.containerInfo)}function gV(a,d,p,m,S){return mu(),NI(S),d.flags|=256,oi(a,d,p,m),d.child}var QC={dehydrated:null,treeContext:null,retryLane:0};function ZC(a){return{baseLanes:a,cachePool:null,transitions:null}}function OB(a,d,p){var m=d.pendingProps,S=Hn.current,C=!1,N=(d.flags&128)!==0,F;if((F=N)||(F=a!==null&&a.memoizedState===null?!1:(S&2)!==0),F?(C=!0,d.flags&=-129):(a===null||a.memoizedState!==null)&&(S|=1),vn(Hn,S&1),a===null)return HC(d),a=d.memoizedState,a!==null&&(a=a.dehydrated,a!==null)?(d.mode&1?a.data==="$!"?d.lanes=8:d.lanes=1073741824:d.lanes=1,null):(N=m.children,a=m.fallback,C?(m=d.mode,C=d.child,N={mode:"hidden",children:N},!(m&1)&&C!==null?(C.childLanes=0,C.pendingProps=N):C=hg(N,m,0,null),a=_d(a,m,p,null),C.return=d,a.return=d,C.sibling=a,d.child=C,d.child.memoizedState=ZC(p),d.memoizedState=QC,a):HI(d,N));if(S=a.memoizedState,S!==null&&(F=S.dehydrated,F!==null))return hee(a,d,N,m,F,S,p);if(C){C=m.fallback,N=d.mode,S=a.child,F=S.sibling;var x={mode:"hidden",children:m.children};return!(N&1)&&d.child!==S?(m=d.child,m.childLanes=0,m.pendingProps=x,d.deletions=null):(m=nc(S,x),m.subtreeFlags=S.subtreeFlags&14680064),F!==null?C=nc(F,C):(C=_d(C,N,p,null),C.flags|=2),C.return=d,m.return=d,m.sibling=C,d.child=m,m=C,C=d.child,N=a.child.memoizedState,N=N===null?ZC(p):{baseLanes:N.baseLanes|p,cachePool:null,transitions:N.transitions},C.memoizedState=N,C.childLanes=a.childLanes&~p,d.memoizedState=QC,m}return C=a.child,a=C.sibling,m=nc(C,{mode:"visible",children:m.children}),!(d.mode&1)&&(m.lanes=p),m.return=d,m.sibling=null,a!==null&&(p=d.deletions,p===null?(d.deletions=[a],d.flags|=16):p.push(a)),d.child=m,d.memoizedState=null,m}function HI(a,d){return d=hg({mode:"visible",children:d},a.mode,0,null),d.return=a,a.child=d}function pE(a,d,p,m){return m!==null&&NI(m),Eu(d,a.child,null,p),a=HI(d,d.pendingProps.children),a.flags|=2,d.memoizedState=null,a}function hee(a,d,p,m,S,C,N){if(p)return d.flags&256?(d.flags&=-257,m=lC(Error(ye(422))),pE(a,d,N,m)):d.memoizedState!==null?(d.child=a.child,d.flags|=128,null):(C=m.fallback,S=d.mode,m=hg({mode:"visible",children:m.children},S,0,null),C=_d(C,S,N,null),C.flags|=2,m.return=d,C.return=d,m.sibling=C,d.child=m,d.mode&1&&Eu(d,a.child,null,N),d.child.memoizedState=ZC(N),d.memoizedState=QC,C);if(!(d.mode&1))return pE(a,d,N,null);if(S.data==="$!"){if(m=S.nextSibling&&S.nextSibling.dataset,m)var F=m.dgst;return m=F,C=Error(ye(419)),m=lC(C,m,void 0),pE(a,d,N,m)}if(F=(N&a.childLanes)!==0,Ii||F){if(m=Cr,m!==null){switch(N&-N){case 4:S=2;break;case 16:S=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:S=32;break;case 536870912:S=268435456;break;default:S=0}S=S&(m.suspendedLanes|N)?0:S,S!==0&&S!==C.retryLane&&(C.retryLane=S,ra(a,S),ns(m,a,S,-1))}return JI(),m=lC(Error(ye(421))),pE(a,d,N,m)}return S.data==="$?"?(d.flags|=128,d.child=a.child,d=Iee.bind(null,a),S._reactRetry=d,null):(a=C.treeContext,Hi=Za(S.nextSibling),Ki=d,Vn=!0,es=null,a!==null&&(So[To++]=Zs,So[To++]=$s,So[To++]=Ed,Zs=a.id,$s=a.overflow,Ed=d),d=HI(d,m.children),d.flags|=4096,d)}function SV(a,d,p){a.lanes|=d;var m=a.alternate;m!==null&&(m.lanes|=d),KC(a.return,d,p)}function uC(a,d,p,m,S){var C=a.memoizedState;C===null?a.memoizedState={isBackwards:d,rendering:null,renderingStartTime:0,last:m,tail:p,tailMode:S}:(C.isBackwards=d,C.rendering=null,C.renderingStartTime=0,C.last=m,C.tail=p,C.tailMode=S)}function NB(a,d,p){var m=d.pendingProps,S=m.revealOrder,C=m.tail;if(oi(a,d,m.children,p),m=Hn.current,m&2)m=m&1|2,d.flags|=128;else{if(a!==null&&a.flags&128)e:for(a=d.child;a!==null;){if(a.tag===13)a.memoizedState!==null&&SV(a,p,d);else if(a.tag===19)SV(a,p,d);else if(a.child!==null){a.child.return=a,a=a.child;continue}if(a===d)break e;for(;a.sibling===null;){if(a.return===null||a.return===d)break e;a=a.return}a.sibling.return=a.return,a=a.sibling}m&=1}if(vn(Hn,m),!(d.mode&1))d.memoizedState=null;else switch(S){case"forwards":for(p=d.child,S=null;p!==null;)a=p.alternate,a!==null&&zE(a)===null&&(S=p),p=p.sibling;p=S,p===null?(S=d.child,d.child=null):(S=p.sibling,p.sibling=null),uC(d,!1,S,p,C);break;case"backwards":for(p=null,S=d.child,d.child=null;S!==null;){if(a=S.alternate,a!==null&&zE(a)===null){d.child=S;break}a=S.sibling,S.sibling=p,p=S,S=a}uC(d,!0,p,null,C);break;case"together":uC(d,!1,null,null,void 0);break;default:d.memoizedState=null}return d.child}function IE(a,d){!(d.mode&1)&&a!==null&&(a.alternate=null,d.alternate=null,d.flags|=2)}function ia(a,d,p){if(a!==null&&(d.dependencies=a.dependencies),Sd|=d.lanes,!(p&d.childLanes))return null;if(a!==null&&d.child!==a.child)throw Error(ye(153));if(d.child!==null){for(a=d.child,p=nc(a,a.pendingProps),d.child=p,p.return=d;a.sibling!==null;)a=a.sibling,p=p.sibling=nc(a,a.pendingProps),p.return=d;p.sibling=null}return d.child}function pee(a,d,p){switch(d.tag){case 3:bB(d),mu();break;case 5:nB(d);break;case 1:Ai(d.type)&&jE(d);break;case 4:UI(d,d.stateNode.containerInfo);break;case 10:var m=d.type._context,S=d.memoizedProps.value;vn(HE,m._currentValue),m._currentValue=S;break;case 13:if(m=d.memoizedState,m!==null)return m.dehydrated!==null?(vn(Hn,Hn.current&1),d.flags|=128,null):p&d.child.childLanes?OB(a,d,p):(vn(Hn,Hn.current&1),a=ia(a,d,p),a!==null?a.sibling:null);vn(Hn,Hn.current&1);break;case 19:if(m=(p&d.childLanes)!==0,a.flags&128){if(m)return NB(a,d,p);d.flags|=128}if(S=d.memoizedState,S!==null&&(S.rendering=null,S.tail=null,S.lastEffect=null),vn(Hn,Hn.current),m)break;return null;case 22:case 23:return d.lanes=0,wB(a,d,p)}return ia(a,d,p)}var DB,$C,PB,LB;DB=function(a,d){for(var p=d.child;p!==null;){if(p.tag===5||p.tag===6)a.appendChild(p.stateNode);else if(p.tag!==4&&p.child!==null){p.child.return=p,p=p.child;continue}if(p===d)break;for(;p.sibling===null;){if(p.return===null||p.return===d)return;p=p.return}p.sibling.return=p.return,p=p.sibling}};$C=function(){};PB=function(a,d,p,m){var S=a.memoizedProps;if(S!==m){a=d.stateNode,pd(Ps.current);var C=null;switch(p){case"input":S=vC(a,S),m=vC(a,m),C=[];break;case"select":S=Yn({},S,{value:void 0}),m=Yn({},m,{value:void 0}),C=[];break;case"textarea":S=CC(a,S),m=CC(a,m),C=[];break;default:typeof S.onClick!="function"&&typeof m.onClick=="function"&&(a.onclick=FE)}wC(p,m);var N;p=null;for(X in S)if(!m.hasOwnProperty(X)&&S.hasOwnProperty(X)&&S[X]!=null)if(X==="style"){var F=S[X];for(N in F)F.hasOwnProperty(N)&&(p||(p={}),p[N]="")}else X!=="dangerouslySetInnerHTML"&&X!=="children"&&X!=="suppressContentEditableWarning"&&X!=="suppressHydrationWarning"&&X!=="autoFocus"&&(Ip.hasOwnProperty(X)?C||(C=[]):(C=C||[]).push(X,null));for(X in m){var x=m[X];if(F=S!=null?S[X]:void 0,m.hasOwnProperty(X)&&x!==F&&(x!=null||F!=null))if(X==="style")if(F){for(N in F)!F.hasOwnProperty(N)||x&&x.hasOwnProperty(N)||(p||(p={}),p[N]="");for(N in x)x.hasOwnProperty(N)&&F[N]!==x[N]&&(p||(p={}),p[N]=x[N])}else p||(C||(C=[]),C.push(X,p)),p=x;else X==="dangerouslySetInnerHTML"?(x=x?x.__html:void 0,F=F?F.__html:void 0,x!=null&&F!==x&&(C=C||[]).push(X,x)):X==="children"?typeof x!="string"&&typeof x!="number"||(C=C||[]).push(X,""+x):X!=="suppressContentEditableWarning"&&X!=="suppressHydrationWarning"&&(Ip.hasOwnProperty(X)?(x!=null&&X==="onScroll"&&Nn("scroll",a),C||F===x||(C=[])):(C=C||[]).push(X,x))}p&&(C=C||[]).push("style",p);var X=C;(d.updateQueue=X)&&(d.flags|=4)}};LB=function(a,d,p,m){p!==m&&(d.flags|=4)};function dp(a,d){if(!Vn)switch(a.tailMode){case"hidden":d=a.tail;for(var p=null;d!==null;)d.alternate!==null&&(p=d),d=d.sibling;p===null?a.tail=null:p.sibling=null;break;case"collapsed":p=a.tail;for(var m=null;p!==null;)p.alternate!==null&&(m=p),p=p.sibling;m===null?d||a.tail===null?a.tail=null:a.tail.sibling=null:m.sibling=null}}function qr(a){var d=a.alternate!==null&&a.alternate.child===a.child,p=0,m=0;if(d)for(var S=a.child;S!==null;)p|=S.lanes|S.childLanes,m|=S.subtreeFlags&14680064,m|=S.flags&14680064,S.return=a,S=S.sibling;else for(S=a.child;S!==null;)p|=S.lanes|S.childLanes,m|=S.subtreeFlags,m|=S.flags,S.return=a,S=S.sibling;return a.subtreeFlags|=m,a.childLanes=p,d}function fee(a,d,p){var m=d.pendingProps;switch(OI(d),d.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return qr(d),null;case 1:return Ai(d.type)&&BE(),qr(d),null;case 3:return m=d.stateNode,gu(),Dn(wi),Dn(Jr),VI(),m.pendingContext&&(m.context=m.pendingContext,m.pendingContext=null),(a===null||a.child===null)&&(uE(d)?d.flags|=4:a===null||a.memoizedState.isDehydrated&&!(d.flags&256)||(d.flags|=1024,es!==null&&(aI(es),es=null))),$C(a,d),qr(d),null;case 5:xI(d);var S=pd(xp.current);if(p=d.type,a!==null&&d.stateNode!=null)PB(a,d,p,m,S),a.ref!==d.ref&&(d.flags|=512,d.flags|=2097152);else{if(!m){if(d.stateNode===null)throw Error(ye(166));return qr(d),null}if(a=pd(Ps.current),uE(d)){m=d.stateNode,p=d.type;var C=d.memoizedProps;switch(m[Ns]=d,m[Mp]=C,a=(d.mode&1)!==0,p){case"dialog":Nn("cancel",m),Nn("close",m);break;case"iframe":case"object":case"embed":Nn("load",m);break;case"video":case"audio":for(S=0;S<fp.length;S++)Nn(fp[S],m);break;case"source":Nn("error",m);break;case"img":case"image":case"link":Nn("error",m),Nn("load",m);break;case"details":Nn("toggle",m);break;case"input":bx(m,C),Nn("invalid",m);break;case"select":m._wrapperState={wasMultiple:!!C.multiple},Nn("invalid",m);break;case"textarea":Nx(m,C),Nn("invalid",m)}wC(p,C),S=null;for(var N in C)if(C.hasOwnProperty(N)){var F=C[N];N==="children"?typeof F=="string"?m.textContent!==F&&(C.suppressHydrationWarning!==!0&&lE(m.textContent,F,a),S=["children",F]):typeof F=="number"&&m.textContent!==""+F&&(C.suppressHydrationWarning!==!0&&lE(m.textContent,F,a),S=["children",""+F]):Ip.hasOwnProperty(N)&&F!=null&&N==="onScroll"&&Nn("scroll",m)}switch(p){case"input":nE(m),Ox(m,C,!0);break;case"textarea":nE(m),Dx(m);break;case"select":case"option":break;default:typeof C.onClick=="function"&&(m.onclick=FE)}m=S,d.updateQueue=m,m!==null&&(d.flags|=4)}else{N=S.nodeType===9?S:S.ownerDocument,a==="http://www.w3.org/1999/xhtml"&&(a=aF(p)),a==="http://www.w3.org/1999/xhtml"?p==="script"?(a=N.createElement("div"),a.innerHTML="<script><\/script>",a=a.removeChild(a.firstChild)):typeof m.is=="string"?a=N.createElement(p,{is:m.is}):(a=N.createElement(p),p==="select"&&(N=a,m.multiple?N.multiple=!0:m.size&&(N.size=m.size))):a=N.createElementNS(a,p),a[Ns]=d,a[Mp]=m,DB(a,d,!1,!1),d.stateNode=a;e:{switch(N=AC(p,m),p){case"dialog":Nn("cancel",a),Nn("close",a),S=m;break;case"iframe":case"object":case"embed":Nn("load",a),S=m;break;case"video":case"audio":for(S=0;S<fp.length;S++)Nn(fp[S],a);S=m;break;case"source":Nn("error",a),S=m;break;case"img":case"image":case"link":Nn("error",a),Nn("load",a),S=m;break;case"details":Nn("toggle",a),S=m;break;case"input":bx(a,m),S=vC(a,m),Nn("invalid",a);break;case"option":S=m;break;case"select":a._wrapperState={wasMultiple:!!m.multiple},S=Yn({},m,{value:void 0}),Nn("invalid",a);break;case"textarea":Nx(a,m),S=CC(a,m),Nn("invalid",a);break;default:S=m}wC(p,S),F=S;for(C in F)if(F.hasOwnProperty(C)){var x=F[C];C==="style"?lF(a,x):C==="dangerouslySetInnerHTML"?(x=x?x.__html:void 0,x!=null&&cF(a,x)):C==="children"?typeof x=="string"?(p!=="textarea"||x!=="")&&wp(a,x):typeof x=="number"&&wp(a,""+x):C!=="suppressContentEditableWarning"&&C!=="suppressHydrationWarning"&&C!=="autoFocus"&&(Ip.hasOwnProperty(C)?x!=null&&C==="onScroll"&&Nn("scroll",a):x!=null&&fI(a,C,x,N))}switch(p){case"input":nE(a),Ox(a,m,!1);break;case"textarea":nE(a),Dx(a);break;case"option":m.value!=null&&a.setAttribute("value",""+rc(m.value));break;case"select":a.multiple=!!m.multiple,C=m.value,C!=null?cu(a,!!m.multiple,C,!1):m.defaultValue!=null&&cu(a,!!m.multiple,m.defaultValue,!0);break;default:typeof S.onClick=="function"&&(a.onclick=FE)}switch(p){case"button":case"input":case"select":case"textarea":m=!!m.autoFocus;break e;case"img":m=!0;break e;default:m=!1}}m&&(d.flags|=4)}d.ref!==null&&(d.flags|=512,d.flags|=2097152)}return qr(d),null;case 6:if(a&&d.stateNode!=null)LB(a,d,a.memoizedProps,m);else{if(typeof m!="string"&&d.stateNode===null)throw Error(ye(166));if(p=pd(xp.current),pd(Ps.current),uE(d)){if(m=d.stateNode,p=d.memoizedProps,m[Ns]=d,(C=m.nodeValue!==p)&&(a=Ki,a!==null))switch(a.tag){case 3:lE(m.nodeValue,p,(a.mode&1)!==0);break;case 5:a.memoizedProps.suppressHydrationWarning!==!0&&lE(m.nodeValue,p,(a.mode&1)!==0)}C&&(d.flags|=4)}else m=(p.nodeType===9?p:p.ownerDocument).createTextNode(m),m[Ns]=d,d.stateNode=m}return qr(d),null;case 13:if(Dn(Hn),m=d.memoizedState,a===null||a.memoizedState!==null&&a.memoizedState.dehydrated!==null){if(Vn&&Hi!==null&&d.mode&1&&!(d.flags&128))QF(),mu(),d.flags|=98560,C=!1;else if(C=uE(d),m!==null&&m.dehydrated!==null){if(a===null){if(!C)throw Error(ye(318));if(C=d.memoizedState,C=C!==null?C.dehydrated:null,!C)throw Error(ye(317));C[Ns]=d}else mu(),!(d.flags&128)&&(d.memoizedState=null),d.flags|=4;qr(d),C=!1}else es!==null&&(aI(es),es=null),C=!0;if(!C)return d.flags&65536?d:null}return d.flags&128?(d.lanes=p,d):(m=m!==null,m!==(a!==null&&a.memoizedState!==null)&&m&&(d.child.flags|=8192,d.mode&1&&(a===null||Hn.current&1?pr===0&&(pr=3):JI())),d.updateQueue!==null&&(d.flags|=4),qr(d),null);case 4:return gu(),$C(a,d),a===null&&Lp(d.stateNode.containerInfo),qr(d),null;case 10:return LI(d.type._context),qr(d),null;case 17:return Ai(d.type)&&BE(),qr(d),null;case 19:if(Dn(Hn),C=d.memoizedState,C===null)return qr(d),null;if(m=(d.flags&128)!==0,N=C.rendering,N===null)if(m)dp(C,!1);else{if(pr!==0||a!==null&&a.flags&128)for(a=d.child;a!==null;){if(N=zE(a),N!==null){for(d.flags|=128,dp(C,!1),m=N.updateQueue,m!==null&&(d.updateQueue=m,d.flags|=4),d.subtreeFlags=0,m=p,p=d.child;p!==null;)C=p,a=m,C.flags&=14680066,N=C.alternate,N===null?(C.childLanes=0,C.lanes=a,C.child=null,C.subtreeFlags=0,C.memoizedProps=null,C.memoizedState=null,C.updateQueue=null,C.dependencies=null,C.stateNode=null):(C.childLanes=N.childLanes,C.lanes=N.lanes,C.child=N.child,C.subtreeFlags=0,C.deletions=null,C.memoizedProps=N.memoizedProps,C.memoizedState=N.memoizedState,C.updateQueue=N.updateQueue,C.type=N.type,a=N.dependencies,C.dependencies=a===null?null:{lanes:a.lanes,firstContext:a.firstContext}),p=p.sibling;return vn(Hn,Hn.current&1|2),d.child}a=a.sibling}C.tail!==null&&nr()>Tu&&(d.flags|=128,m=!0,dp(C,!1),d.lanes=4194304)}else{if(!m)if(a=zE(N),a!==null){if(d.flags|=128,m=!0,p=a.updateQueue,p!==null&&(d.updateQueue=p,d.flags|=4),dp(C,!0),C.tail===null&&C.tailMode==="hidden"&&!N.alternate&&!Vn)return qr(d),null}else 2*nr()-C.renderingStartTime>Tu&&p!==1073741824&&(d.flags|=128,m=!0,dp(C,!1),d.lanes=4194304);C.isBackwards?(N.sibling=d.child,d.child=N):(p=C.last,p!==null?p.sibling=N:d.child=N,C.last=N)}return C.tail!==null?(d=C.tail,C.rendering=d,C.tail=d.sibling,C.renderingStartTime=nr(),d.sibling=null,p=Hn.current,vn(Hn,m?p&1|2:p&1),d):(qr(d),null);case 22:case 23:return XI(),m=d.memoizedState!==null,a!==null&&a.memoizedState!==null!==m&&(d.flags|=8192),m&&d.mode&1?Wi&1073741824&&(qr(d),d.subtreeFlags&6&&(d.flags|=8192)):qr(d),null;case 24:return null;case 25:return null}throw Error(ye(156,d.tag))}function _ee(a,d){switch(OI(d),d.tag){case 1:return Ai(d.type)&&BE(),a=d.flags,a&65536?(d.flags=a&-65537|128,d):null;case 3:return gu(),Dn(wi),Dn(Jr),VI(),a=d.flags,a&65536&&!(a&128)?(d.flags=a&-65537|128,d):null;case 5:return xI(d),null;case 13:if(Dn(Hn),a=d.memoizedState,a!==null&&a.dehydrated!==null){if(d.alternate===null)throw Error(ye(340));mu()}return a=d.flags,a&65536?(d.flags=a&-65537|128,d):null;case 19:return Dn(Hn),null;case 4:return gu(),null;case 10:return LI(d.type._context),null;case 22:case 23:return XI(),null;case 24:return null;default:return null}}var fE=!1,Xr=!1,mee=typeof WeakSet=="function"?WeakSet:Set,He=null;function su(a,d){var p=a.ref;if(p!==null)if(typeof p=="function")try{p(null)}catch(m){Qn(a,d,m)}else p.current=null}function eI(a,d,p){try{p()}catch(m){Qn(a,d,m)}}var TV=!1;function Eee(a,d){if(xC=UE,a=VF(),AI(a)){if("selectionStart"in a)var p={start:a.selectionStart,end:a.selectionEnd};else e:{p=(p=a.ownerDocument)&&p.defaultView||window;var m=p.getSelection&&p.getSelection();if(m&&m.rangeCount!==0){p=m.anchorNode;var S=m.anchorOffset,C=m.focusNode;m=m.focusOffset;try{p.nodeType,C.nodeType}catch{p=null;break e}var N=0,F=-1,x=-1,X=0,_e=0,oe=a,re=null;t:for(;;){for(var Ce;oe!==p||S!==0&&oe.nodeType!==3||(F=N+S),oe!==C||m!==0&&oe.nodeType!==3||(x=N+m),oe.nodeType===3&&(N+=oe.nodeValue.length),(Ce=oe.firstChild)!==null;)re=oe,oe=Ce;for(;;){if(oe===a)break t;if(re===p&&++X===S&&(F=N),re===C&&++_e===m&&(x=N),(Ce=oe.nextSibling)!==null)break;oe=re,re=oe.parentNode}oe=Ce}p=F===-1||x===-1?null:{start:F,end:x}}else p=null}p=p||{start:0,end:0}}else p=null;for(VC={focusedElem:a,selectionRange:p},UE=!1,He=d;He!==null;)if(d=He,a=d.child,(d.subtreeFlags&1028)!==0&&a!==null)a.return=d,He=a;else for(;He!==null;){d=He;try{var fe=d.alternate;if(d.flags&1024)switch(d.tag){case 0:case 11:case 15:break;case 1:if(fe!==null){var Oe=fe.memoizedProps,Vt=fe.memoizedState,J=d.stateNode,K=J.getSnapshotBeforeUpdate(d.elementType===d.type?Oe:Zo(d.type,Oe),Vt);J.__reactInternalSnapshotBeforeUpdate=K}break;case 3:var Q=d.stateNode.containerInfo;Q.nodeType===1?Q.textContent="":Q.nodeType===9&&Q.documentElement&&Q.removeChild(Q.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(ye(163))}}catch(Te){Qn(d,d.return,Te)}if(a=d.sibling,a!==null){a.return=d.return,He=a;break}He=d.return}return fe=TV,TV=!1,fe}function Rp(a,d,p){var m=d.updateQueue;if(m=m!==null?m.lastEffect:null,m!==null){var S=m=m.next;do{if((S.tag&a)===a){var C=S.destroy;S.destroy=void 0,C!==void 0&&eI(d,p,C)}S=S.next}while(S!==m)}}function lg(a,d){if(d=d.updateQueue,d=d!==null?d.lastEffect:null,d!==null){var p=d=d.next;do{if((p.tag&a)===a){var m=p.create;p.destroy=m()}p=p.next}while(p!==d)}}function tI(a){var d=a.ref;if(d!==null){var p=a.stateNode;switch(a.tag){case 5:a=p;break;default:a=p}typeof d=="function"?d(a):d.current=a}}function kB(a){var d=a.alternate;d!==null&&(a.alternate=null,kB(d)),a.child=null,a.deletions=null,a.sibling=null,a.tag===5&&(d=a.stateNode,d!==null&&(delete d[Ns],delete d[Mp],delete d[jC],delete d[$$],delete d[eee])),a.stateNode=null,a.return=null,a.dependencies=null,a.memoizedProps=null,a.memoizedState=null,a.pendingProps=null,a.stateNode=null,a.updateQueue=null}function MB(a){return a.tag===5||a.tag===3||a.tag===4}function vV(a){e:for(;;){for(;a.sibling===null;){if(a.return===null||MB(a.return))return null;a=a.return}for(a.sibling.return=a.return,a=a.sibling;a.tag!==5&&a.tag!==6&&a.tag!==18;){if(a.flags&2||a.child===null||a.tag===4)continue e;a.child.return=a,a=a.child}if(!(a.flags&2))return a.stateNode}}function nI(a,d,p){var m=a.tag;if(m===5||m===6)a=a.stateNode,d?p.nodeType===8?p.parentNode.insertBefore(a,d):p.insertBefore(a,d):(p.nodeType===8?(d=p.parentNode,d.insertBefore(a,p)):(d=p,d.appendChild(a)),p=p._reactRootContainer,p!=null||d.onclick!==null||(d.onclick=FE));else if(m!==4&&(a=a.child,a!==null))for(nI(a,d,p),a=a.sibling;a!==null;)nI(a,d,p),a=a.sibling}function rI(a,d,p){var m=a.tag;if(m===5||m===6)a=a.stateNode,d?p.insertBefore(a,d):p.appendChild(a);else if(m!==4&&(a=a.child,a!==null))for(rI(a,d,p),a=a.sibling;a!==null;)rI(a,d,p),a=a.sibling}var Ur=null,$o=!1;function ja(a,d,p){for(p=p.child;p!==null;)UB(a,d,p),p=p.sibling}function UB(a,d,p){if(Ds&&typeof Ds.onCommitFiberUnmount=="function")try{Ds.onCommitFiberUnmount(ng,p)}catch{}switch(p.tag){case 5:Xr||su(p,d);case 6:var m=Ur,S=$o;Ur=null,ja(a,d,p),Ur=m,$o=S,Ur!==null&&($o?(a=Ur,p=p.stateNode,a.nodeType===8?a.parentNode.removeChild(p):a.removeChild(p)):Ur.removeChild(p.stateNode));break;case 18:Ur!==null&&($o?(a=Ur,p=p.stateNode,a.nodeType===8?iC(a.parentNode,p):a.nodeType===1&&iC(a,p),Np(a)):iC(Ur,p.stateNode));break;case 4:m=Ur,S=$o,Ur=p.stateNode.containerInfo,$o=!0,ja(a,d,p),Ur=m,$o=S;break;case 0:case 11:case 14:case 15:if(!Xr&&(m=p.updateQueue,m!==null&&(m=m.lastEffect,m!==null))){S=m=m.next;do{var C=S,N=C.destroy;C=C.tag,N!==void 0&&(C&2||C&4)&&eI(p,d,N),S=S.next}while(S!==m)}ja(a,d,p);break;case 1:if(!Xr&&(su(p,d),m=p.stateNode,typeof m.componentWillUnmount=="function"))try{m.props=p.memoizedProps,m.state=p.memoizedState,m.componentWillUnmount()}catch(F){Qn(p,d,F)}ja(a,d,p);break;case 21:ja(a,d,p);break;case 22:p.mode&1?(Xr=(m=Xr)||p.memoizedState!==null,ja(a,d,p),Xr=m):ja(a,d,p);break;default:ja(a,d,p)}}function RV(a){var d=a.updateQueue;if(d!==null){a.updateQueue=null;var p=a.stateNode;p===null&&(p=a.stateNode=new mee),d.forEach(function(m){var S=wee.bind(null,a,m);p.has(m)||(p.add(m),m.then(S,S))})}}function Qo(a,d){var p=d.deletions;if(p!==null)for(var m=0;m<p.length;m++){var S=p[m];try{var C=a,N=d,F=N;e:for(;F!==null;){switch(F.tag){case 5:Ur=F.stateNode,$o=!1;break e;case 3:Ur=F.stateNode.containerInfo,$o=!0;break e;case 4:Ur=F.stateNode.containerInfo,$o=!0;break e}F=F.return}if(Ur===null)throw Error(ye(160));UB(C,N,S),Ur=null,$o=!1;var x=S.alternate;x!==null&&(x.return=null),S.return=null}catch(X){Qn(S,d,X)}}if(d.subtreeFlags&12854)for(d=d.child;d!==null;)xB(d,a),d=d.sibling}function xB(a,d){var p=a.alternate,m=a.flags;switch(a.tag){case 0:case 11:case 14:case 15:if(Qo(d,a),bs(a),m&4){try{Rp(3,a,a.return),lg(3,a)}catch(Oe){Qn(a,a.return,Oe)}try{Rp(5,a,a.return)}catch(Oe){Qn(a,a.return,Oe)}}break;case 1:Qo(d,a),bs(a),m&512&&p!==null&&su(p,p.return);break;case 5:if(Qo(d,a),bs(a),m&512&&p!==null&&su(p,p.return),a.flags&32){var S=a.stateNode;try{wp(S,"")}catch(Oe){Qn(a,a.return,Oe)}}if(m&4&&(S=a.stateNode,S!=null)){var C=a.memoizedProps,N=p!==null?p.memoizedProps:C,F=a.type,x=a.updateQueue;if(a.updateQueue=null,x!==null)try{F==="input"&&C.type==="radio"&&C.name!=null&&oF(S,C),AC(F,N);var X=AC(F,C);for(N=0;N<x.length;N+=2){var _e=x[N],oe=x[N+1];_e==="style"?lF(S,oe):_e==="dangerouslySetInnerHTML"?cF(S,oe):_e==="children"?wp(S,oe):fI(S,_e,oe,X)}switch(F){case"input":RC(S,C);break;case"textarea":sF(S,C);break;case"select":var re=S._wrapperState.wasMultiple;S._wrapperState.wasMultiple=!!C.multiple;var Ce=C.value;Ce!=null?cu(S,!!C.multiple,Ce,!1):re!==!!C.multiple&&(C.defaultValue!=null?cu(S,!!C.multiple,C.defaultValue,!0):cu(S,!!C.multiple,C.multiple?[]:"",!1))}S[Mp]=C}catch(Oe){Qn(a,a.return,Oe)}}break;case 6:if(Qo(d,a),bs(a),m&4){if(a.stateNode===null)throw Error(ye(162));S=a.stateNode,C=a.memoizedProps;try{S.nodeValue=C}catch(Oe){Qn(a,a.return,Oe)}}break;case 3:if(Qo(d,a),bs(a),m&4&&p!==null&&p.memoizedState.isDehydrated)try{Np(d.containerInfo)}catch(Oe){Qn(a,a.return,Oe)}break;case 4:Qo(d,a),bs(a);break;case 13:Qo(d,a),bs(a),S=a.child,S.flags&8192&&(C=S.memoizedState!==null,S.stateNode.isHidden=C,!C||S.alternate!==null&&S.alternate.memoizedState!==null||(zI=nr())),m&4&&RV(a);break;case 22:if(_e=p!==null&&p.memoizedState!==null,a.mode&1?(Xr=(X=Xr)||_e,Qo(d,a),Xr=X):Qo(d,a),bs(a),m&8192){if(X=a.memoizedState!==null,(a.stateNode.isHidden=X)&&!_e&&a.mode&1)for(He=a,_e=a.child;_e!==null;){for(oe=He=_e;He!==null;){switch(re=He,Ce=re.child,re.tag){case 0:case 11:case 14:case 15:Rp(4,re,re.return);break;case 1:su(re,re.return);var fe=re.stateNode;if(typeof fe.componentWillUnmount=="function"){m=re,p=re.return;try{d=m,fe.props=d.memoizedProps,fe.state=d.memoizedState,fe.componentWillUnmount()}catch(Oe){Qn(m,p,Oe)}}break;case 5:su(re,re.return);break;case 22:if(re.memoizedState!==null){CV(oe);continue}}Ce!==null?(Ce.return=re,He=Ce):CV(oe)}_e=_e.sibling}e:for(_e=null,oe=a;;){if(oe.tag===5){if(_e===null){_e=oe;try{S=oe.stateNode,X?(C=S.style,typeof C.setProperty=="function"?C.setProperty("display","none","important"):C.display="none"):(F=oe.stateNode,x=oe.memoizedProps.style,N=x!=null&&x.hasOwnProperty("display")?x.display:null,F.style.display=dF("display",N))}catch(Oe){Qn(a,a.return,Oe)}}}else if(oe.tag===6){if(_e===null)try{oe.stateNode.nodeValue=X?"":oe.memoizedProps}catch(Oe){Qn(a,a.return,Oe)}}else if((oe.tag!==22&&oe.tag!==23||oe.memoizedState===null||oe===a)&&oe.child!==null){oe.child.return=oe,oe=oe.child;continue}if(oe===a)break e;for(;oe.sibling===null;){if(oe.return===null||oe.return===a)break e;_e===oe&&(_e=null),oe=oe.return}_e===oe&&(_e=null),oe.sibling.return=oe.return,oe=oe.sibling}}break;case 19:Qo(d,a),bs(a),m&4&&RV(a);break;case 21:break;default:Qo(d,a),bs(a)}}function bs(a){var d=a.flags;if(d&2){try{e:{for(var p=a.return;p!==null;){if(MB(p)){var m=p;break e}p=p.return}throw Error(ye(160))}switch(m.tag){case 5:var S=m.stateNode;m.flags&32&&(wp(S,""),m.flags&=-33);var C=vV(a);rI(a,C,S);break;case 3:case 4:var N=m.stateNode.containerInfo,F=vV(a);nI(a,F,N);break;default:throw Error(ye(161))}}catch(x){Qn(a,a.return,x)}a.flags&=-3}d&4096&&(a.flags&=-4097)}function gee(a,d,p){He=a,VB(a)}function VB(a,d,p){for(var m=(a.mode&1)!==0;He!==null;){var S=He,C=S.child;if(S.tag===22&&m){var N=S.memoizedState!==null||fE;if(!N){var F=S.alternate,x=F!==null&&F.memoizedState!==null||Xr;F=fE;var X=Xr;if(fE=N,(Xr=x)&&!X)for(He=S;He!==null;)N=He,x=N.child,N.tag===22&&N.memoizedState!==null?IV(S):x!==null?(x.return=N,He=x):IV(S);for(;C!==null;)He=C,VB(C),C=C.sibling;He=S,fE=F,Xr=X}yV(a)}else S.subtreeFlags&8772&&C!==null?(C.return=S,He=C):yV(a)}}function yV(a){for(;He!==null;){var d=He;if(d.flags&8772){var p=d.alternate;try{if(d.flags&8772)switch(d.tag){case 0:case 11:case 15:Xr||lg(5,d);break;case 1:var m=d.stateNode;if(d.flags&4&&!Xr)if(p===null)m.componentDidMount();else{var S=d.elementType===d.type?p.memoizedProps:Zo(d.type,p.memoizedProps);m.componentDidUpdate(S,p.memoizedState,m.__reactInternalSnapshotBeforeUpdate)}var C=d.updateQueue;C!==null&&aV(d,C,m);break;case 3:var N=d.updateQueue;if(N!==null){if(p=null,d.child!==null)switch(d.child.tag){case 5:p=d.child.stateNode;break;case 1:p=d.child.stateNode}aV(d,N,p)}break;case 5:var F=d.stateNode;if(p===null&&d.flags&4){p=F;var x=d.memoizedProps;switch(d.type){case"button":case"input":case"select":case"textarea":x.autoFocus&&p.focus();break;case"img":x.src&&(p.src=x.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(d.memoizedState===null){var X=d.alternate;if(X!==null){var _e=X.memoizedState;if(_e!==null){var oe=_e.dehydrated;oe!==null&&Np(oe)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(ye(163))}Xr||d.flags&512&&tI(d)}catch(re){Qn(d,d.return,re)}}if(d===a){He=null;break}if(p=d.sibling,p!==null){p.return=d.return,He=p;break}He=d.return}}function CV(a){for(;He!==null;){var d=He;if(d===a){He=null;break}var p=d.sibling;if(p!==null){p.return=d.return,He=p;break}He=d.return}}function IV(a){for(;He!==null;){var d=He;try{switch(d.tag){case 0:case 11:case 15:var p=d.return;try{lg(4,d)}catch(x){Qn(d,p,x)}break;case 1:var m=d.stateNode;if(typeof m.componentDidMount=="function"){var S=d.return;try{m.componentDidMount()}catch(x){Qn(d,S,x)}}var C=d.return;try{tI(d)}catch(x){Qn(d,C,x)}break;case 5:var N=d.return;try{tI(d)}catch(x){Qn(d,N,x)}}}catch(x){Qn(d,d.return,x)}if(d===a){He=null;break}var F=d.sibling;if(F!==null){F.return=d.return,He=F;break}He=d.return}}var See=Math.ceil,JE=oa.ReactCurrentDispatcher,KI=oa.ReactCurrentOwner,Ro=oa.ReactCurrentBatchConfig,Jt=0,Cr=null,cr=null,xr=0,Wi=0,au=sc(0),pr=0,jp=null,Sd=0,ug=0,YI=0,yp=null,Ci=null,zI=0,Tu=1/0,Js=null,QE=!1,iI=null,ec=null,_E=!1,qa=null,ZE=0,Cp=0,oI=null,wE=-1,AE=0;function si(){return Jt&6?nr():wE!==-1?wE:wE=nr()}function tc(a){return a.mode&1?Jt&2&&xr!==0?xr&-xr:nee.transition!==null?(AE===0&&(AE=RF()),AE):(a=ln,a!==0||(a=window.event,a=a===void 0?16:OF(a.type)),a):1}function ns(a,d,p,m){if(50<Cp)throw Cp=0,oI=null,Error(ye(185));Wp(a,p,m),(!(Jt&2)||a!==Cr)&&(a===Cr&&(!(Jt&2)&&(ug|=p),pr===4&&Ya(a,xr)),bi(a,m),p===1&&Jt===0&&!(d.mode&1)&&(Tu=nr()+500,ag&&ac()))}function bi(a,d){var p=a.callbackNode;n$(a,d);var m=ME(a,a===Cr?xr:0);if(m===0)p!==null&&kx(p),a.callbackNode=null,a.callbackPriority=0;else if(d=m&-m,a.callbackPriority!==d){if(p!=null&&kx(p),d===1)a.tag===0?tee(wV.bind(null,a)):qF(wV.bind(null,a)),Q$(function(){!(Jt&6)&&ac()}),p=null;else{switch(yF(m)){case 1:p=SI;break;case 4:p=TF;break;case 16:p=kE;break;case 536870912:p=vF;break;default:p=kE}p=YB(p,FB.bind(null,a))}a.callbackPriority=d,a.callbackNode=p}}function FB(a,d){if(wE=-1,AE=0,Jt&6)throw Error(ye(327));var p=a.callbackNode;if(pu()&&a.callbackNode!==p)return null;var m=ME(a,a===Cr?xr:0);if(m===0)return null;if(m&30||m&a.expiredLanes||d)d=$E(a,m);else{d=m;var S=Jt;Jt|=2;var C=jB();(Cr!==a||xr!==d)&&(Js=null,Tu=nr()+500,fd(a,d));do try{Ree();break}catch(F){BB(a,F)}while(!0);PI(),JE.current=C,Jt=S,cr!==null?d=0:(Cr=null,xr=0,d=pr)}if(d!==0){if(d===2&&(S=PC(a),S!==0&&(m=S,d=sI(a,S))),d===1)throw p=jp,fd(a,0),Ya(a,m),bi(a,nr()),p;if(d===6)Ya(a,m);else{if(S=a.current.alternate,!(m&30)&&!Tee(S)&&(d=$E(a,m),d===2&&(C=PC(a),C!==0&&(m=C,d=sI(a,C))),d===1))throw p=jp,fd(a,0),Ya(a,m),bi(a,nr()),p;switch(a.finishedWork=S,a.finishedLanes=m,d){case 0:case 1:throw Error(ye(345));case 2:dd(a,Ci,Js);break;case 3:if(Ya(a,m),(m&130023424)===m&&(d=zI+500-nr(),10<d)){if(ME(a,0)!==0)break;if(S=a.suspendedLanes,(S&m)!==m){si(),a.pingedLanes|=a.suspendedLanes&S;break}a.timeoutHandle=BC(dd.bind(null,a,Ci,Js),d);break}dd(a,Ci,Js);break;case 4:if(Ya(a,m),(m&4194240)===m)break;for(d=a.eventTimes,S=-1;0<m;){var N=31-ts(m);C=1<<N,N=d[N],N>S&&(S=N),m&=~C}if(m=S,m=nr()-m,m=(120>m?120:480>m?480:1080>m?1080:1920>m?1920:3e3>m?3e3:4320>m?4320:1960*See(m/1960))-m,10<m){a.timeoutHandle=BC(dd.bind(null,a,Ci,Js),m);break}dd(a,Ci,Js);break;case 5:dd(a,Ci,Js);break;default:throw Error(ye(329))}}}return bi(a,nr()),a.callbackNode===p?FB.bind(null,a):null}function sI(a,d){var p=yp;return a.current.memoizedState.isDehydrated&&(fd(a,d).flags|=256),a=$E(a,d),a!==2&&(d=Ci,Ci=p,d!==null&&aI(d)),a}function aI(a){Ci===null?Ci=a:Ci.push.apply(Ci,a)}function Tee(a){for(var d=a;;){if(d.flags&16384){var p=d.updateQueue;if(p!==null&&(p=p.stores,p!==null))for(var m=0;m<p.length;m++){var S=p[m],C=S.getSnapshot;S=S.value;try{if(!rs(C(),S))return!1}catch{return!1}}}if(p=d.child,d.subtreeFlags&16384&&p!==null)p.return=d,d=p;else{if(d===a)break;for(;d.sibling===null;){if(d.return===null||d.return===a)return!0;d=d.return}d.sibling.return=d.return,d=d.sibling}}return!0}function Ya(a,d){for(d&=~YI,d&=~ug,a.suspendedLanes|=d,a.pingedLanes&=~d,a=a.expirationTimes;0<d;){var p=31-ts(d),m=1<<p;a[p]=-1,d&=~m}}function wV(a){if(Jt&6)throw Error(ye(327));pu();var d=ME(a,0);if(!(d&1))return bi(a,nr()),null;var p=$E(a,d);if(a.tag!==0&&p===2){var m=PC(a);m!==0&&(d=m,p=sI(a,m))}if(p===1)throw p=jp,fd(a,0),Ya(a,d),bi(a,nr()),p;if(p===6)throw Error(ye(345));return a.finishedWork=a.current.alternate,a.finishedLanes=d,dd(a,Ci,Js),bi(a,nr()),null}function qI(a,d){var p=Jt;Jt|=1;try{return a(d)}finally{Jt=p,Jt===0&&(Tu=nr()+500,ag&&ac())}}function Td(a){qa!==null&&qa.tag===0&&!(Jt&6)&&pu();var d=Jt;Jt|=1;var p=Ro.transition,m=ln;try{if(Ro.transition=null,ln=1,a)return a()}finally{ln=m,Ro.transition=p,Jt=d,!(Jt&6)&&ac()}}function XI(){Wi=au.current,Dn(au)}function fd(a,d){a.finishedWork=null,a.finishedLanes=0;var p=a.timeoutHandle;if(p!==-1&&(a.timeoutHandle=-1,J$(p)),cr!==null)for(p=cr.return;p!==null;){var m=p;switch(OI(m),m.tag){case 1:m=m.type.childContextTypes,m!=null&&BE();break;case 3:gu(),Dn(wi),Dn(Jr),VI();break;case 5:xI(m);break;case 4:gu();break;case 13:Dn(Hn);break;case 19:Dn(Hn);break;case 10:LI(m.type._context);break;case 22:case 23:XI()}p=p.return}if(Cr=a,cr=a=nc(a.current,null),xr=Wi=d,pr=0,jp=null,YI=ug=Sd=0,Ci=yp=null,hd!==null){for(d=0;d<hd.length;d++)if(p=hd[d],m=p.interleaved,m!==null){p.interleaved=null;var S=m.next,C=p.pending;if(C!==null){var N=C.next;C.next=S,m.next=N}p.pending=m}hd=null}return a}function BB(a,d){do{var p=cr;try{if(PI(),yE.current=XE,qE){for(var m=Kn.memoizedState;m!==null;){var S=m.queue;S!==null&&(S.pending=null),m=m.next}qE=!1}if(gd=0,yr=hr=Kn=null,vp=!1,Vp=0,KI.current=null,p===null||p.return===null){pr=1,jp=d,cr=null;break}e:{var C=a,N=p.return,F=p,x=d;if(d=xr,F.flags|=32768,x!==null&&typeof x=="object"&&typeof x.then=="function"){var X=x,_e=F,oe=_e.tag;if(!(_e.mode&1)&&(oe===0||oe===11||oe===15)){var re=_e.alternate;re?(_e.updateQueue=re.updateQueue,_e.memoizedState=re.memoizedState,_e.lanes=re.lanes):(_e.updateQueue=null,_e.memoizedState=null)}var Ce=pV(N);if(Ce!==null){Ce.flags&=-257,fV(Ce,N,F,C,d),Ce.mode&1&&hV(C,X,d),d=Ce,x=X;var fe=d.updateQueue;if(fe===null){var Oe=new Set;Oe.add(x),d.updateQueue=Oe}else fe.add(x);break e}else{if(!(d&1)){hV(C,X,d),JI();break e}x=Error(ye(426))}}else if(Vn&&F.mode&1){var Vt=pV(N);if(Vt!==null){!(Vt.flags&65536)&&(Vt.flags|=256),fV(Vt,N,F,C,d),NI(Su(x,F));break e}}C=x=Su(x,F),pr!==4&&(pr=2),yp===null?yp=[C]:yp.push(C),C=N;do{switch(C.tag){case 3:C.flags|=65536,d&=-d,C.lanes|=d;var J=yB(C,x,d);sV(C,J);break e;case 1:F=x;var K=C.type,Q=C.stateNode;if(!(C.flags&128)&&(typeof K.getDerivedStateFromError=="function"||Q!==null&&typeof Q.componentDidCatch=="function"&&(ec===null||!ec.has(Q)))){C.flags|=65536,d&=-d,C.lanes|=d;var Te=CB(C,F,d);sV(C,Te);break e}}C=C.return}while(C!==null)}WB(p)}catch(Ve){d=Ve,cr===p&&p!==null&&(cr=p=p.return);continue}break}while(!0)}function jB(){var a=JE.current;return JE.current=XE,a===null?XE:a}function JI(){(pr===0||pr===3||pr===2)&&(pr=4),Cr===null||!(Sd&268435455)&&!(ug&268435455)||Ya(Cr,xr)}function $E(a,d){var p=Jt;Jt|=2;var m=jB();(Cr!==a||xr!==d)&&(Js=null,fd(a,d));do try{vee();break}catch(S){BB(a,S)}while(!0);if(PI(),Jt=p,JE.current=m,cr!==null)throw Error(ye(261));return Cr=null,xr=0,pr}function vee(){for(;cr!==null;)GB(cr)}function Ree(){for(;cr!==null&&!zZ();)GB(cr)}function GB(a){var d=KB(a.alternate,a,Wi);a.memoizedProps=a.pendingProps,d===null?WB(a):cr=d,KI.current=null}function WB(a){var d=a;do{var p=d.alternate;if(a=d.return,d.flags&32768){if(p=_ee(p,d),p!==null){p.flags&=32767,cr=p;return}if(a!==null)a.flags|=32768,a.subtreeFlags=0,a.deletions=null;else{pr=6,cr=null;return}}else if(p=fee(p,d,Wi),p!==null){cr=p;return}if(d=d.sibling,d!==null){cr=d;return}cr=d=a}while(d!==null);pr===0&&(pr=5)}function dd(a,d,p){var m=ln,S=Ro.transition;try{Ro.transition=null,ln=1,yee(a,d,p,m)}finally{Ro.transition=S,ln=m}return null}function yee(a,d,p,m){do pu();while(qa!==null);if(Jt&6)throw Error(ye(327));p=a.finishedWork;var S=a.finishedLanes;if(p===null)return null;if(a.finishedWork=null,a.finishedLanes=0,p===a.current)throw Error(ye(177));a.callbackNode=null,a.callbackPriority=0;var C=p.lanes|p.childLanes;if(r$(a,C),a===Cr&&(cr=Cr=null,xr=0),!(p.subtreeFlags&2064)&&!(p.flags&2064)||_E||(_E=!0,YB(kE,function(){return pu(),null})),C=(p.flags&15990)!==0,p.subtreeFlags&15990||C){C=Ro.transition,Ro.transition=null;var N=ln;ln=1;var F=Jt;Jt|=4,KI.current=null,Eee(a,p),xB(p,a),W$(VC),UE=!!xC,VC=xC=null,a.current=p,gee(p),qZ(),Jt=F,ln=N,Ro.transition=C}else a.current=p;if(_E&&(_E=!1,qa=a,ZE=S),C=a.pendingLanes,C===0&&(ec=null),QZ(p.stateNode),bi(a,nr()),d!==null)for(m=a.onRecoverableError,p=0;p<d.length;p++)S=d[p],m(S.value,{componentStack:S.stack,digest:S.digest});if(QE)throw QE=!1,a=iI,iI=null,a;return ZE&1&&a.tag!==0&&pu(),C=a.pendingLanes,C&1?a===oI?Cp++:(Cp=0,oI=a):Cp=0,ac(),null}function pu(){if(qa!==null){var a=yF(ZE),d=Ro.transition,p=ln;try{if(Ro.transition=null,ln=16>a?16:a,qa===null)var m=!1;else{if(a=qa,qa=null,ZE=0,Jt&6)throw Error(ye(331));var S=Jt;for(Jt|=4,He=a.current;He!==null;){var C=He,N=C.child;if(He.flags&16){var F=C.deletions;if(F!==null){for(var x=0;x<F.length;x++){var X=F[x];for(He=X;He!==null;){var _e=He;switch(_e.tag){case 0:case 11:case 15:Rp(8,_e,C)}var oe=_e.child;if(oe!==null)oe.return=_e,He=oe;else for(;He!==null;){_e=He;var re=_e.sibling,Ce=_e.return;if(kB(_e),_e===X){He=null;break}if(re!==null){re.return=Ce,He=re;break}He=Ce}}}var fe=C.alternate;if(fe!==null){var Oe=fe.child;if(Oe!==null){fe.child=null;do{var Vt=Oe.sibling;Oe.sibling=null,Oe=Vt}while(Oe!==null)}}He=C}}if(C.subtreeFlags&2064&&N!==null)N.return=C,He=N;else e:for(;He!==null;){if(C=He,C.flags&2048)switch(C.tag){case 0:case 11:case 15:Rp(9,C,C.return)}var J=C.sibling;if(J!==null){J.return=C.return,He=J;break e}He=C.return}}var K=a.current;for(He=K;He!==null;){N=He;var Q=N.child;if(N.subtreeFlags&2064&&Q!==null)Q.return=N,He=Q;else e:for(N=K;He!==null;){if(F=He,F.flags&2048)try{switch(F.tag){case 0:case 11:case 15:lg(9,F)}}catch(Ve){Qn(F,F.return,Ve)}if(F===N){He=null;break e}var Te=F.sibling;if(Te!==null){Te.return=F.return,He=Te;break e}He=F.return}}if(Jt=S,ac(),Ds&&typeof Ds.onPostCommitFiberRoot=="function")try{Ds.onPostCommitFiberRoot(ng,a)}catch{}m=!0}return m}finally{ln=p,Ro.transition=d}}return!1}function AV(a,d,p){d=Su(p,d),d=yB(a,d,1),a=$a(a,d,1),d=si(),a!==null&&(Wp(a,1,d),bi(a,d))}function Qn(a,d,p){if(a.tag===3)AV(a,a,p);else for(;d!==null;){if(d.tag===3){AV(d,a,p);break}else if(d.tag===1){var m=d.stateNode;if(typeof d.type.getDerivedStateFromError=="function"||typeof m.componentDidCatch=="function"&&(ec===null||!ec.has(m))){a=Su(p,a),a=CB(d,a,1),d=$a(d,a,1),a=si(),d!==null&&(Wp(d,1,a),bi(d,a));break}}d=d.return}}function Cee(a,d,p){var m=a.pingCache;m!==null&&m.delete(d),d=si(),a.pingedLanes|=a.suspendedLanes&p,Cr===a&&(xr&p)===p&&(pr===4||pr===3&&(xr&130023424)===xr&&500>nr()-zI?fd(a,0):YI|=p),bi(a,d)}function HB(a,d){d===0&&(a.mode&1?(d=oE,oE<<=1,!(oE&130023424)&&(oE=4194304)):d=1);var p=si();a=ra(a,d),a!==null&&(Wp(a,d,p),bi(a,p))}function Iee(a){var d=a.memoizedState,p=0;d!==null&&(p=d.retryLane),HB(a,p)}function wee(a,d){var p=0;switch(a.tag){case 13:var m=a.stateNode,S=a.memoizedState;S!==null&&(p=S.retryLane);break;case 19:m=a.stateNode;break;default:throw Error(ye(314))}m!==null&&m.delete(d),HB(a,p)}var KB;KB=function(a,d,p){if(a!==null)if(a.memoizedProps!==d.pendingProps||wi.current)Ii=!0;else{if(!(a.lanes&p)&&!(d.flags&128))return Ii=!1,pee(a,d,p);Ii=!!(a.flags&131072)}else Ii=!1,Vn&&d.flags&1048576&&XF(d,WE,d.index);switch(d.lanes=0,d.tag){case 2:var m=d.type;IE(a,d),a=d.pendingProps;var S=_u(d,Jr.current);hu(d,p),S=BI(null,d,m,a,S,p);var C=jI();return d.flags|=1,typeof S=="object"&&S!==null&&typeof S.render=="function"&&S.$$typeof===void 0?(d.tag=1,d.memoizedState=null,d.updateQueue=null,Ai(m)?(C=!0,jE(d)):C=!1,d.memoizedState=S.state!==null&&S.state!==void 0?S.state:null,MI(d),S.updater=dg,d.stateNode=S,S._reactInternals=d,zC(d,m,a,p),d=JC(null,d,m,!0,C,p)):(d.tag=0,Vn&&C&&bI(d),oi(null,d,S,p),d=d.child),d;case 16:m=d.elementType;e:{switch(IE(a,d),a=d.pendingProps,S=m._init,m=S(m._payload),d.type=m,S=d.tag=bee(m),a=Zo(m,a),S){case 0:d=XC(null,d,m,a,p);break e;case 1:d=EV(null,d,m,a,p);break e;case 11:d=_V(null,d,m,a,p);break e;case 14:d=mV(null,d,m,Zo(m.type,a),p);break e}throw Error(ye(306,m,""))}return d;case 0:return m=d.type,S=d.pendingProps,S=d.elementType===m?S:Zo(m,S),XC(a,d,m,S,p);case 1:return m=d.type,S=d.pendingProps,S=d.elementType===m?S:Zo(m,S),EV(a,d,m,S,p);case 3:e:{if(bB(d),a===null)throw Error(ye(387));m=d.pendingProps,C=d.memoizedState,S=C.element,tB(a,d),YE(d,m,null,p);var N=d.memoizedState;if(m=N.element,C.isDehydrated)if(C={element:m,isDehydrated:!1,cache:N.cache,pendingSuspenseBoundaries:N.pendingSuspenseBoundaries,transitions:N.transitions},d.updateQueue.baseState=C,d.memoizedState=C,d.flags&256){S=Su(Error(ye(423)),d),d=gV(a,d,m,p,S);break e}else if(m!==S){S=Su(Error(ye(424)),d),d=gV(a,d,m,p,S);break e}else for(Hi=Za(d.stateNode.containerInfo.firstChild),Ki=d,Vn=!0,es=null,p=$F(d,null,m,p),d.child=p;p;)p.flags=p.flags&-3|4096,p=p.sibling;else{if(mu(),m===S){d=ia(a,d,p);break e}oi(a,d,m,p)}d=d.child}return d;case 5:return nB(d),a===null&&HC(d),m=d.type,S=d.pendingProps,C=a!==null?a.memoizedProps:null,N=S.children,FC(m,S)?N=null:C!==null&&FC(m,C)&&(d.flags|=32),AB(a,d),oi(a,d,N,p),d.child;case 6:return a===null&&HC(d),null;case 13:return OB(a,d,p);case 4:return UI(d,d.stateNode.containerInfo),m=d.pendingProps,a===null?d.child=Eu(d,null,m,p):oi(a,d,m,p),d.child;case 11:return m=d.type,S=d.pendingProps,S=d.elementType===m?S:Zo(m,S),_V(a,d,m,S,p);case 7:return oi(a,d,d.pendingProps,p),d.child;case 8:return oi(a,d,d.pendingProps.children,p),d.child;case 12:return oi(a,d,d.pendingProps.children,p),d.child;case 10:e:{if(m=d.type._context,S=d.pendingProps,C=d.memoizedProps,N=S.value,vn(HE,m._currentValue),m._currentValue=N,C!==null)if(rs(C.value,N)){if(C.children===S.children&&!wi.current){d=ia(a,d,p);break e}}else for(C=d.child,C!==null&&(C.return=d);C!==null;){var F=C.dependencies;if(F!==null){N=C.child;for(var x=F.firstContext;x!==null;){if(x.context===m){if(C.tag===1){x=ea(-1,p&-p),x.tag=2;var X=C.updateQueue;if(X!==null){X=X.shared;var _e=X.pending;_e===null?x.next=x:(x.next=_e.next,_e.next=x),X.pending=x}}C.lanes|=p,x=C.alternate,x!==null&&(x.lanes|=p),KC(C.return,p,d),F.lanes|=p;break}x=x.next}}else if(C.tag===10)N=C.type===d.type?null:C.child;else if(C.tag===18){if(N=C.return,N===null)throw Error(ye(341));N.lanes|=p,F=N.alternate,F!==null&&(F.lanes|=p),KC(N,p,d),N=C.sibling}else N=C.child;if(N!==null)N.return=C;else for(N=C;N!==null;){if(N===d){N=null;break}if(C=N.sibling,C!==null){C.return=N.return,N=C;break}N=N.return}C=N}oi(a,d,S.children,p),d=d.child}return d;case 9:return S=d.type,m=d.pendingProps.children,hu(d,p),S=yo(S),m=m(S),d.flags|=1,oi(a,d,m,p),d.child;case 14:return m=d.type,S=Zo(m,d.pendingProps),S=Zo(m.type,S),mV(a,d,m,S,p);case 15:return IB(a,d,d.type,d.pendingProps,p);case 17:return m=d.type,S=d.pendingProps,S=d.elementType===m?S:Zo(m,S),IE(a,d),d.tag=1,Ai(m)?(a=!0,jE(d)):a=!1,hu(d,p),RB(d,m,S),zC(d,m,S,p),JC(null,d,m,!0,a,p);case 19:return NB(a,d,p);case 22:return wB(a,d,p)}throw Error(ye(156,d.tag))};function YB(a,d){return SF(a,d)}function Aee(a,d,p,m){this.tag=a,this.key=p,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=d,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=m,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function vo(a,d,p,m){return new Aee(a,d,p,m)}function QI(a){return a=a.prototype,!(!a||!a.isReactComponent)}function bee(a){if(typeof a=="function")return QI(a)?1:0;if(a!=null){if(a=a.$$typeof,a===mI)return 11;if(a===EI)return 14}return 2}function nc(a,d){var p=a.alternate;return p===null?(p=vo(a.tag,d,a.key,a.mode),p.elementType=a.elementType,p.type=a.type,p.stateNode=a.stateNode,p.alternate=a,a.alternate=p):(p.pendingProps=d,p.type=a.type,p.flags=0,p.subtreeFlags=0,p.deletions=null),p.flags=a.flags&14680064,p.childLanes=a.childLanes,p.lanes=a.lanes,p.child=a.child,p.memoizedProps=a.memoizedProps,p.memoizedState=a.memoizedState,p.updateQueue=a.updateQueue,d=a.dependencies,p.dependencies=d===null?null:{lanes:d.lanes,firstContext:d.firstContext},p.sibling=a.sibling,p.index=a.index,p.ref=a.ref,p}function bE(a,d,p,m,S,C){var N=2;if(m=a,typeof a=="function")QI(a)&&(N=1);else if(typeof a=="string")N=5;else e:switch(a){case Ql:return _d(p.children,S,C,d);case _I:N=8,S|=8;break;case EC:return a=vo(12,p,d,S|2),a.elementType=EC,a.lanes=C,a;case gC:return a=vo(13,p,d,S),a.elementType=gC,a.lanes=C,a;case SC:return a=vo(19,p,d,S),a.elementType=SC,a.lanes=C,a;case nF:return hg(p,S,C,d);default:if(typeof a=="object"&&a!==null)switch(a.$$typeof){case eF:N=10;break e;case tF:N=9;break e;case mI:N=11;break e;case EI:N=14;break e;case Wa:N=16,m=null;break e}throw Error(ye(130,a==null?a:typeof a,""))}return d=vo(N,p,d,S),d.elementType=a,d.type=m,d.lanes=C,d}function _d(a,d,p,m){return a=vo(7,a,m,d),a.lanes=p,a}function hg(a,d,p,m){return a=vo(22,a,m,d),a.elementType=nF,a.lanes=p,a.stateNode={isHidden:!1},a}function hC(a,d,p){return a=vo(6,a,null,d),a.lanes=p,a}function pC(a,d,p){return d=vo(4,a.children!==null?a.children:[],a.key,d),d.lanes=p,d.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation},d}function Oee(a,d,p,m,S){this.tag=d,this.containerInfo=a,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=zy(0),this.expirationTimes=zy(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=zy(0),this.identifierPrefix=m,this.onRecoverableError=S,this.mutableSourceEagerHydrationData=null}function ZI(a,d,p,m,S,C,N,F,x){return a=new Oee(a,d,p,F,x),d===1?(d=1,C===!0&&(d|=8)):d=0,C=vo(3,null,null,d),a.current=C,C.stateNode=a,C.memoizedState={element:m,isDehydrated:p,cache:null,transitions:null,pendingSuspenseBoundaries:null},MI(C),a}function Nee(a,d,p){var m=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Jl,key:m==null?null:""+m,children:a,containerInfo:d,implementation:p}}function zB(a){if(!a)return ic;a=a._reactInternals;e:{if(Rd(a)!==a||a.tag!==1)throw Error(ye(170));var d=a;do{switch(d.tag){case 3:d=d.stateNode.context;break e;case 1:if(Ai(d.type)){d=d.stateNode.__reactInternalMemoizedMergedChildContext;break e}}d=d.return}while(d!==null);throw Error(ye(171))}if(a.tag===1){var p=a.type;if(Ai(p))return zF(a,p,d)}return d}function qB(a,d,p,m,S,C,N,F,x){return a=ZI(p,m,!0,a,S,C,N,F,x),a.context=zB(null),p=a.current,m=si(),S=tc(p),C=ea(m,S),C.callback=d??null,$a(p,C,S),a.current.lanes=S,Wp(a,S,m),bi(a,m),a}function pg(a,d,p,m){var S=d.current,C=si(),N=tc(S);return p=zB(p),d.context===null?d.context=p:d.pendingContext=p,d=ea(C,N),d.payload={element:a},m=m===void 0?null:m,m!==null&&(d.callback=m),a=$a(S,d,N),a!==null&&(ns(a,S,N,C),RE(a,S,N)),N}function eg(a){if(a=a.current,!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function bV(a,d){if(a=a.memoizedState,a!==null&&a.dehydrated!==null){var p=a.retryLane;a.retryLane=p!==0&&p<d?p:d}}function $I(a,d){bV(a,d),(a=a.alternate)&&bV(a,d)}function Dee(){return null}var XB=typeof reportError=="function"?reportError:function(a){console.error(a)};function ew(a){this._internalRoot=a}fg.prototype.render=ew.prototype.render=function(a){var d=this._internalRoot;if(d===null)throw Error(ye(409));pg(a,d,null,null)};fg.prototype.unmount=ew.prototype.unmount=function(){var a=this._internalRoot;if(a!==null){this._internalRoot=null;var d=a.containerInfo;Td(function(){pg(null,a,null,null)}),d[na]=null}};function fg(a){this._internalRoot=a}fg.prototype.unstable_scheduleHydration=function(a){if(a){var d=wF();a={blockedOn:null,target:a,priority:d};for(var p=0;p<Ka.length&&d!==0&&d<Ka[p].priority;p++);Ka.splice(p,0,a),p===0&&bF(a)}};function tw(a){return!(!a||a.nodeType!==1&&a.nodeType!==9&&a.nodeType!==11)}function _g(a){return!(!a||a.nodeType!==1&&a.nodeType!==9&&a.nodeType!==11&&(a.nodeType!==8||a.nodeValue!==" react-mount-point-unstable "))}function OV(){}function Pee(a,d,p,m,S){if(S){if(typeof m=="function"){var C=m;m=function(){var X=eg(N);C.call(X)}}var N=qB(d,m,a,0,null,!1,!1,"",OV);return a._reactRootContainer=N,a[na]=N.current,Lp(a.nodeType===8?a.parentNode:a),Td(),N}for(;S=a.lastChild;)a.removeChild(S);if(typeof m=="function"){var F=m;m=function(){var X=eg(x);F.call(X)}}var x=ZI(a,0,!1,null,null,!1,!1,"",OV);return a._reactRootContainer=x,a[na]=x.current,Lp(a.nodeType===8?a.parentNode:a),Td(function(){pg(d,x,p,m)}),x}function mg(a,d,p,m,S){var C=p._reactRootContainer;if(C){var N=C;if(typeof S=="function"){var F=S;S=function(){var x=eg(N);F.call(x)}}pg(d,N,a,S)}else N=Pee(p,d,a,S,m);return eg(N)}CF=function(a){switch(a.tag){case 3:var d=a.stateNode;if(d.current.memoizedState.isDehydrated){var p=pp(d.pendingLanes);p!==0&&(TI(d,p|1),bi(d,nr()),!(Jt&6)&&(Tu=nr()+500,ac()))}break;case 13:Td(function(){var m=ra(a,1);if(m!==null){var S=si();ns(m,a,1,S)}}),$I(a,1)}};vI=function(a){if(a.tag===13){var d=ra(a,134217728);if(d!==null){var p=si();ns(d,a,134217728,p)}$I(a,134217728)}};IF=function(a){if(a.tag===13){var d=tc(a),p=ra(a,d);if(p!==null){var m=si();ns(p,a,d,m)}$I(a,d)}};wF=function(){return ln};AF=function(a,d){var p=ln;try{return ln=a,d()}finally{ln=p}};OC=function(a,d,p){switch(d){case"input":if(RC(a,p),d=p.name,p.type==="radio"&&d!=null){for(p=a;p.parentNode;)p=p.parentNode;for(p=p.querySelectorAll("input[name="+JSON.stringify(""+d)+'][type="radio"]'),d=0;d<p.length;d++){var m=p[d];if(m!==a&&m.form===a.form){var S=sg(m);if(!S)throw Error(ye(90));iF(m),RC(m,S)}}}break;case"textarea":sF(a,p);break;case"select":d=p.value,d!=null&&cu(a,!!p.multiple,d,!1)}};pF=qI;fF=Td;var Lee={usingClientEntryPoint:!1,Events:[Kp,tu,sg,uF,hF,qI]},lp={findFiberByHostInstance:ud,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},kee={bundleType:lp.bundleType,version:lp.version,rendererPackageName:lp.rendererPackageName,rendererConfig:lp.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:oa.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){return a=EF(a),a===null?null:a.stateNode},findFiberByHostInstance:lp.findFiberByHostInstance||Dee,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var mE=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!mE.isDisabled&&mE.supportsFiber)try{ng=mE.inject(kee),Ds=mE}catch{}}zi.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Lee;zi.createPortal=function(a,d){var p=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!tw(d))throw Error(ye(200));return Nee(a,d,null,p)};zi.createRoot=function(a,d){if(!tw(a))throw Error(ye(299));var p=!1,m="",S=XB;return d!=null&&(d.unstable_strictMode===!0&&(p=!0),d.identifierPrefix!==void 0&&(m=d.identifierPrefix),d.onRecoverableError!==void 0&&(S=d.onRecoverableError)),d=ZI(a,1,!1,null,null,p,!1,m,S),a[na]=d.current,Lp(a.nodeType===8?a.parentNode:a),new ew(d)};zi.findDOMNode=function(a){if(a==null)return null;if(a.nodeType===1)return a;var d=a._reactInternals;if(d===void 0)throw typeof a.render=="function"?Error(ye(188)):(a=Object.keys(a).join(","),Error(ye(268,a)));return a=EF(d),a=a===null?null:a.stateNode,a};zi.flushSync=function(a){return Td(a)};zi.hydrate=function(a,d,p){if(!_g(d))throw Error(ye(200));return mg(null,a,d,!0,p)};zi.hydrateRoot=function(a,d,p){if(!tw(a))throw Error(ye(405));var m=p!=null&&p.hydratedSources||null,S=!1,C="",N=XB;if(p!=null&&(p.unstable_strictMode===!0&&(S=!0),p.identifierPrefix!==void 0&&(C=p.identifierPrefix),p.onRecoverableError!==void 0&&(N=p.onRecoverableError)),d=qB(d,null,a,1,p??null,S,!1,C,N),a[na]=d.current,Lp(a),m)for(a=0;a<m.length;a++)p=m[a],S=p._getVersion,S=S(p._source),d.mutableSourceEagerHydrationData==null?d.mutableSourceEagerHydrationData=[p,S]:d.mutableSourceEagerHydrationData.push(p,S);return new fg(d)};zi.render=function(a,d,p){if(!_g(d))throw Error(ye(200));return mg(null,a,d,!1,p)};zi.unmountComponentAtNode=function(a){if(!_g(a))throw Error(ye(40));return a._reactRootContainer?(Td(function(){mg(null,null,a,!1,function(){a._reactRootContainer=null,a[na]=null})}),!0):!1};zi.unstable_batchedUpdates=qI;zi.unstable_renderSubtreeIntoContainer=function(a,d,p,m){if(!_g(p))throw Error(ye(200));if(a==null||a._reactInternals===void 0)throw Error(ye(38));return mg(a,d,p,!1,m)};zi.version="18.3.1-next-f1338f8080-20240426";function JB(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(JB)}catch(a){console.error(a)}}JB(),JV.exports=zi;var Mee=JV.exports,NV=Mee;_C.createRoot=NV.createRoot,_C.hydrateRoot=NV.hydrateRoot;var QB={exports:{}};(function(a,d){(function(p,m){a.exports=m()})($m,function(){function p(e,t){return t.forEach(function(n){n&&typeof n!="string"&&!Array.isArray(n)&&Object.keys(n).forEach(function(r){if(r!=="default"&&!(r in e)){var i=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(e,r,i.get?i:{enumerable:!0,get:function(){return n[r]}})}})}),Object.freeze(e)}var m=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof $m<"u"?$m:typeof self<"u"?self:{};function S(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var C=function(e){try{return!!e()}catch{return!0}},N=!C(function(){var e=(function(){}).bind();return typeof e!="function"||e.hasOwnProperty("prototype")}),F=N,x=Function.prototype,X=x.call,_e=F&&x.bind.bind(X,X),oe=F?_e:function(e){return function(){return X.apply(e,arguments)}},re=oe({}.isPrototypeOf),Ce=function(e){return e&&e.Math===Math&&e},fe=Ce(typeof globalThis=="object"&&globalThis)||Ce(typeof window=="object"&&window)||Ce(typeof self=="object"&&self)||Ce(typeof m=="object"&&m)||Ce(typeof m=="object"&&m)||function(){return this}()||Function("return this")(),Oe=N,Vt=Function.prototype,J=Vt.apply,K=Vt.call,Q=typeof Reflect=="object"&&Reflect.apply||(Oe?K.bind(J):function(){return K.apply(J,arguments)}),Te=oe,Ve=Te({}.toString),Be=Te("".slice),Me=function(e){return Be(Ve(e),8,-1)},ze=Me,Kt=oe,ht=function(e){if(ze(e)==="Function")return Kt(e)},Ye=typeof document=="object"&&document.all,qe=Ye===void 0&&Ye!==void 0?function(e){return typeof e=="function"||e===Ye}:function(e){return typeof e=="function"},Tn={},At=!C(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),rr=N,Fr=Function.prototype.call,$t=rr?Fr.bind(Fr):function(){return Fr.apply(Fr,arguments)},be={},lt={}.propertyIsEnumerable,gt=Object.getOwnPropertyDescriptor,Rn=gt&&!lt.call({1:2},1);be.f=Rn?function(e){var t=gt(this,e);return!!t&&t.enumerable}:lt;var tn,Io,Fn=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},Ls=C,Br=Me,Xi=Object,Eg=oe("".split),cc=Ls(function(){return!Xi("z").propertyIsEnumerable(0)})?function(e){return Br(e)==="String"?Eg(e,""):Xi(e)}:Xi,dc=function(e){return e==null},gg=dc,Cu=TypeError,is=function(e){if(gg(e))throw new Cu("Can't call method on "+e);return e},Sg=cc,zp=is,Ir=function(e){return Sg(zp(e))},Iu=qe,yn=function(e){return typeof e=="object"?e!==null:Iu(e)},wr={},lc=wr,wu=fe,Tg=qe,sa=function(e){return Tg(e)?e:void 0},Zn=function(e,t){return arguments.length<2?sa(lc[e])||sa(wu[e]):lc[e]&&lc[e][t]||wu[e]&&wu[e][t]},uc=fe.navigator,yd=uc&&uc.userAgent,Oi=yd?String(yd):"",qp=fe,Au=Oi,Xp=qp.process,Jp=qp.Deno,bu=Xp&&Xp.versions||Jp&&Jp.version,Ou=bu&&bu.v8;Ou&&(Io=(tn=Ou.split("."))[0]>0&&tn[0]<4?1:+(tn[0]+tn[1])),!Io&&Au&&(!(tn=Au.match(/Edge\/(\d+)/))||tn[1]>=74)&&(tn=Au.match(/Chrome\/(\d+)/))&&(Io=+tn[1]);var ks=Io,Cd=ks,Qp=C,Zp=fe.String,aa=!!Object.getOwnPropertySymbols&&!Qp(function(){var e=Symbol("symbol detection");return!Zp(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Cd&&Cd<41}),hc=aa&&!Symbol.sham&&typeof Symbol.iterator=="symbol",Nu=Zn,ie=qe,ve=re,Lt=Object,bt=hc?function(e){return typeof e=="symbol"}:function(e){var t=Nu("Symbol");return ie(t)&&ve(t.prototype,Lt(e))},wo=String,di=function(e){try{return wo(e)}catch{return"Object"}},ca=qe,ej=di,tj=TypeError,li=function(e){if(ca(e))return e;throw new tj(ej(e)+" is not a function")},nj=li,rj=dc,Du=function(e,t){var n=e[t];return rj(n)?void 0:nj(n)},nw=$t,rw=qe,iw=yn,ij=TypeError,ow={exports:{}},sw=fe,oj=Object.defineProperty,sj=fe,aj=function(e,t){try{oj(sw,e,{value:t,configurable:!0,writable:!0})}catch{sw[e]=t}return t},aw="__core-js_shared__",cw=ow.exports=sj[aw]||aj(aw,{});(cw.versions||(cw.versions=[])).push({version:"3.46.0",mode:"pure",copyright:" 2014-2025 Denis Pushkarev (zloirock.ru), 2025 CoreJS Company (core-js.io)",license:"https://github.com/zloirock/core-js/blob/v3.46.0/LICENSE",source:"https://github.com/zloirock/core-js"});var vg=ow.exports,dw=vg,Id=function(e,t){return dw[e]||(dw[e]=t||{})},cj=is,dj=Object,os=function(e){return dj(cj(e))},lj=os,uj=oe({}.hasOwnProperty),ir=Object.hasOwn||function(e,t){return uj(lj(e),t)},hj=oe,pj=0,fj=Math.random(),_j=hj(1.1.toString),Rg=function(e){return"Symbol("+(e===void 0?"":e)+")_"+_j(++pj+fj,36)},mj=Id,lw=ir,Ej=Rg,gj=aa,Sj=hc,wd=fe.Symbol,yg=mj("wks"),Tj=Sj?wd.for||wd:wd&&wd.withoutSetter||Ej,un=function(e){return lw(yg,e)||(yg[e]=gj&&lw(wd,e)?wd[e]:Tj("Symbol."+e)),yg[e]},vj=$t,uw=yn,hw=bt,Rj=Du,yj=function(e,t){var n,r;if(rw(n=e.toString)&&!iw(r=nw(n,e))||rw(n=e.valueOf)&&!iw(r=nw(n,e)))return r;throw new ij("Can't convert object to primitive value")},Cj=TypeError,Ij=un("toPrimitive"),wj=function(e,t){if(!uw(e)||hw(e))return e;var n,r=Rj(e,Ij);if(r){if(n=vj(r,e,t),!uw(n)||hw(n))return n;throw new Cj("Can't convert object to primitive value")}return yj(e)},Aj=bt,Cg=function(e){var t=wj(e,"string");return Aj(t)?t:t+""},pw=yn,Ig=fe.document,bj=pw(Ig)&&pw(Ig.createElement),wg=function(e){return bj?Ig.createElement(e):{}},Oj=wg,fw=!At&&!C(function(){return Object.defineProperty(Oj("div"),"a",{get:function(){return 7}}).a!==7}),Nj=At,Dj=$t,Pj=be,Lj=Fn,kj=Ir,Mj=Cg,Uj=ir,xj=fw,_w=Object.getOwnPropertyDescriptor;Tn.f=Nj?_w:function(e,t){if(e=kj(e),t=Mj(t),xj)try{return _w(e,t)}catch{}if(Uj(e,t))return Lj(!Dj(Pj.f,e,t),e[t])};var Vj=C,Fj=qe,Bj=/#|\.prototype\./,Pu=function(e,t){var n=Gj[jj(e)];return n===Hj||n!==Wj&&(Fj(t)?Vj(t):!!t)},jj=Pu.normalize=function(e){return String(e).replace(Bj,".").toLowerCase()},Gj=Pu.data={},Wj=Pu.NATIVE="N",Hj=Pu.POLYFILL="P",mw=Pu,Kj=li,Yj=N,zj=ht(ht.bind),da=function(e,t){return Kj(e),t===void 0?e:Yj?zj(e,t):function(){return e.apply(t,arguments)}},Ji={},Ew=At&&C(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),qj=yn,Xj=String,Jj=TypeError,Qr=function(e){if(qj(e))return e;throw new Jj(Xj(e)+" is not an object")},Qj=At,Zj=fw,$j=Ew,$p=Qr,gw=Cg,e3=TypeError,Ag=Object.defineProperty,t3=Object.getOwnPropertyDescriptor,bg="enumerable",Og="configurable",Ng="writable";Ji.f=Qj?$j?function(e,t,n){if($p(e),t=gw(t),$p(n),typeof e=="function"&&t==="prototype"&&"value"in n&&Ng in n&&!n[Ng]){var r=t3(e,t);r&&r[Ng]&&(e[t]=n.value,n={configurable:Og in n?n[Og]:r[Og],enumerable:bg in n?n[bg]:r[bg],writable:!1})}return Ag(e,t,n)}:Ag:function(e,t,n){if($p(e),t=gw(t),$p(n),Zj)try{return Ag(e,t,n)}catch{}if("get"in n||"set"in n)throw new e3("Accessors not supported");return"value"in n&&(e[t]=n.value),e};var n3=Ji,r3=Fn,pc=At?function(e,t,n){return n3.f(e,t,r3(1,n))}:function(e,t,n){return e[t]=n,e},Lu=fe,i3=Q,o3=ht,s3=qe,a3=Tn.f,c3=mw,Ad=wr,d3=da,bd=pc,Sw=ir,l3=function(e){var t=function(n,r,i){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(n);case 2:return new e(n,r)}return new e(n,r,i)}return i3(e,this,arguments)};return t.prototype=e.prototype,t},ft=function(e,t){var n,r,i,o,s,c,l,u,h,f=e.target,_=e.global,E=e.stat,I=e.proto,v=_?Lu:E?Lu[f]:Lu[f]&&Lu[f].prototype,R=_?Ad:Ad[f]||bd(Ad,f,{})[f],A=R.prototype;for(o in t)r=!(n=c3(_?o:f+(E?".":"#")+o,e.forced))&&v&&Sw(v,o),c=R[o],r&&(l=e.dontCallGetSet?(h=a3(v,o))&&h.value:v[o]),s=r&&l?l:t[o],(n||I||typeof c!=typeof s)&&(u=e.bind&&r?d3(s,Lu):e.wrap&&r?l3(s):I&&s3(s)?o3(s):s,(e.sham||s&&s.sham||c&&c.sham)&&bd(u,"sham",!0),bd(R,o,u),I&&(Sw(Ad,i=f+"Prototype")||bd(Ad,i,{}),bd(Ad[i],o,s),e.real&&A&&(n||!A[o])&&bd(A,o,s)))},u3=Math.ceil,h3=Math.floor,p3=Math.trunc||function(e){var t=+e;return(t>0?h3:u3)(t)},f3=p3,Dg=function(e){var t=+e;return t!=t||t===0?0:f3(t)},_3=Dg,m3=Math.max,E3=Math.min,Pg=function(e,t){var n=_3(e);return n<0?m3(n+t,0):E3(n,t)},g3=Dg,S3=Math.min,Tw=function(e){var t=g3(e);return t>0?S3(t,9007199254740991):0},T3=Tw,la=function(e){return T3(e.length)},v3=Ir,R3=Pg,y3=la,vw=function(e){return function(t,n,r){var i=v3(t),o=y3(i);if(o===0)return!e&&-1;var s,c=R3(r,o);if(e&&n!=n){for(;o>c;)if((s=i[c++])!=s)return!0}else for(;o>c;c++)if((e||c in i)&&i[c]===n)return e||c||0;return!e&&-1}},Lg={includes:vw(!0),indexOf:vw(!1)},C3=Lg.includes;ft({target:"Array",proto:!0,forced:C(function(){return!Array(1).includes()})},{includes:function(e){return C3(this,e,arguments.length>1?arguments[1]:void 0)}});var I3=fe,w3=wr,Ni=function(e,t){var n=w3[e+"Prototype"],r=n&&n[t];if(r)return r;var i=I3[e],o=i&&i.prototype;return o&&o[t]},A3=Ni("Array","includes"),b3=yn,O3=Me,N3=un("match"),kg=function(e){var t;return b3(e)&&((t=e[N3])!==void 0?!!t:O3(e)==="RegExp")},D3=kg,P3=TypeError,Rw={};Rw[un("toStringTag")]="z";var Mg=String(Rw)==="[object z]",L3=Mg,k3=qe,ef=Me,M3=un("toStringTag"),U3=Object,x3=ef(function(){return arguments}())==="Arguments",ua=L3?ef:function(e){var t,n,r;return e===void 0?"Undefined":e===null?"Null":typeof(n=function(i,o){try{return i[o]}catch{}}(t=U3(e),M3))=="string"?n:x3?ef(t):(r=ef(t))==="Object"&&k3(t.callee)?"Arguments":r},V3=ua,F3=String,Zr=function(e){if(V3(e)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return F3(e)},B3=un("match"),j3=ft,G3=function(e){if(D3(e))throw new P3("The method doesn't accept regular expressions");return e},W3=is,yw=Zr,H3=function(e){var t=/./;try{"/./"[e](t)}catch{try{return t[B3]=!1,"/./"[e](t)}catch{}}return!1},K3=oe("".indexOf);j3({target:"String",proto:!0,forced:!H3("includes")},{includes:function(e){return!!~K3(yw(W3(this)),yw(G3(e)),arguments.length>1?arguments[1]:void 0)}});var Y3=Ni("String","includes"),Cw=re,z3=A3,q3=Y3,Ug=Array.prototype,xg=String.prototype,X3=function(e){var t=e.includes;return e===Ug||Cw(Ug,e)&&t===Ug.includes?z3:typeof e=="string"||e===xg||Cw(xg,e)&&t===xg.includes?q3:t},Z=S(X3),J3=li,Q3=os,Z3=cc,$3=la,Iw=TypeError,ww="Reduce of empty array with no initial value",e4=function(e){return function(t,n,r,i){var o=Q3(t),s=Z3(o),c=$3(o);if(J3(n),c===0&&r<2)throw new Iw(ww);var l=e?c-1:0,u=e?-1:1;if(r<2)for(;;){if(l in s){i=s[l],l+=u;break}if(l+=u,e?l<0:c<=l)throw new Iw(ww)}for(;e?l>=0:c>l;l+=u)l in s&&(i=n(i,s[l],l,o));return i}},t4={left:e4(!1)},n4=C,tf=function(e,t){var n=[][e];return!!n&&n4(function(){n.call(null,t||function(){return 1},1)})},ku=fe,r4=Oi,i4=Me,nf=function(e){return r4.slice(0,e.length)===e},Vg=nf("Bun/")?"BUN":nf("Cloudflare-Workers")?"CLOUDFLARE":nf("Deno/")?"DENO":nf("Node.js/")?"NODE":ku.Bun&&typeof Bun.version=="string"?"BUN":ku.Deno&&typeof Deno.version=="object"?"DENO":i4(ku.process)==="process"?"NODE":ku.window&&ku.document?"BROWSER":"REST",rf=Vg==="NODE",o4=t4.left;ft({target:"Array",proto:!0,forced:!rf&&ks>79&&ks<83||!tf("reduce")},{reduce:function(e){var t=arguments.length;return o4(this,e,t,t>1?arguments[1]:void 0)}});var s4=Ni("Array","reduce"),a4=re,c4=s4,Fg=Array.prototype,d4=function(e){var t=e.reduce;return e===Fg||a4(Fg,e)&&t===Fg.reduce?c4:t},Aw=d4,Di=S(Aw),l4=Me,Mu=Array.isArray||function(e){return l4(e)==="Array"},u4=ft,h4=Mu,p4=oe([].reverse),bw=[1,2];u4({target:"Array",proto:!0,forced:String(bw)===String(bw.reverse())},{reverse:function(){return h4(this)&&(this.length=this.length),p4(this)}});var f4=Ni("Array","reverse"),_4=re,m4=f4,Bg=Array.prototype,E4=function(e){var t=e.reverse;return e===Bg||_4(Bg,e)&&t===Bg.reverse?m4:t},Ow=E4,Nw=S(Ow),g4=Rg,Dw=Id("keys"),of=function(e){return Dw[e]||(Dw[e]=g4(e))},S4=!C(function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}),T4=ir,v4=qe,R4=os,y4=S4,Pw=of("IE_PROTO"),jg=Object,C4=jg.prototype,Gg=y4?jg.getPrototypeOf:function(e){var t=R4(e);if(T4(t,Pw))return t[Pw];var n=t.constructor;return v4(n)&&t instanceof n?n.prototype:t instanceof jg?C4:null},I4=oe,w4=li,A4=yn,b4=function(e){return A4(e)||e===null},O4=String,N4=TypeError,D4=function(e,t,n){try{return I4(w4(Object.getOwnPropertyDescriptor(e,t)[n]))}catch{}},P4=yn,L4=is,k4=function(e){if(b4(e))return e;throw new N4("Can't set "+O4(e)+" as a prototype")},M4=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,n={};try{(e=D4(Object.prototype,"__proto__","set"))(n,[]),t=n instanceof Array}catch{}return function(r,i){return L4(r),k4(i),P4(r)&&(t?e(r,i):r.__proto__=i),r}}():void 0),sf={},af={},Wg=ir,U4=Ir,x4=Lg.indexOf,V4=af,Lw=oe([].push),kw=function(e,t){var n,r=U4(e),i=0,o=[];for(n in r)!Wg(V4,n)&&Wg(r,n)&&Lw(o,n);for(;t.length>i;)Wg(r,n=t[i++])&&(~x4(o,n)||Lw(o,n));return o},Hg=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],F4=kw,B4=Hg.concat("length","prototype");sf.f=Object.getOwnPropertyNames||function(e){return F4(e,B4)};var Uu={};Uu.f=Object.getOwnPropertySymbols;var j4=Zn,G4=sf,W4=Uu,H4=Qr,K4=oe([].concat),Y4=j4("Reflect","ownKeys")||function(e){var t=G4.f(H4(e)),n=W4.f;return n?K4(t,n(e)):t},Mw=ir,z4=Y4,q4=Tn,X4=Ji,Kg={},J4=kw,Q4=Hg,cf=Object.keys||function(e){return J4(e,Q4)},Z4=At,$4=Ew,e5=Ji,t5=Qr,n5=Ir,r5=cf;Kg.f=Z4&&!$4?Object.defineProperties:function(e,t){t5(e);for(var n,r=n5(t),i=r5(t),o=i.length,s=0;o>s;)e5.f(e,n=i[s++],r[n]);return e};var df,Uw=Zn("document","documentElement"),i5=Qr,o5=Kg,xw=Hg,s5=af,a5=Uw,c5=wg,Yg="prototype",zg="script",Vw=of("IE_PROTO"),qg=function(){},Fw=function(e){return"<"+zg+">"+e+"</"+zg+">"},Bw=function(e){e.write(Fw("")),e.close();var t=e.parentWindow.Object;return e=null,t},lf=function(){try{df=new ActiveXObject("htmlfile")}catch{}var e,t,n;lf=typeof document<"u"?document.domain&&df?Bw(df):(t=c5("iframe"),n="java"+zg+":",t.style.display="none",a5.appendChild(t),t.src=String(n),(e=t.contentWindow.document).open(),e.write(Fw("document.F=Object")),e.close(),e.F):Bw(df);for(var r=xw.length;r--;)delete lf[Yg][xw[r]];return lf()};s5[Vw]=!0;var xu=Object.create||function(e,t){var n;return e!==null?(qg[Yg]=i5(e),n=new qg,qg[Yg]=null,n[Vw]=e):n=lf(),t===void 0?n:o5.f(n,t)},d5=yn,l5=pc,jw=Error,u5=oe("".replace),h5=String(new jw("zxcasd").stack),Gw=/\n\s*at [^:]*:[^\n]*/,p5=Gw.test(h5),f5=Fn,_5=!C(function(){var e=new Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",f5(1,7)),e.stack!==7)}),m5=pc,E5=function(e,t){if(p5&&typeof e=="string"&&!jw.prepareStackTrace)for(;t--;)e=u5(e,Gw,"");return e},g5=_5,Ww=Error.captureStackTrace,Od={},S5=Od,T5=un("iterator"),v5=Array.prototype,Hw=function(e){return e!==void 0&&(S5.Array===e||v5[T5]===e)},R5=ua,Kw=Du,y5=dc,C5=Od,I5=un("iterator"),uf=function(e){if(!y5(e))return Kw(e,I5)||Kw(e,"@@iterator")||C5[R5(e)]},w5=$t,A5=li,b5=Qr,O5=di,N5=uf,D5=TypeError,Xg=function(e,t){var n=arguments.length<2?N5(e):t;if(A5(n))return b5(w5(n,e));throw new D5(O5(e)+" is not iterable")},P5=$t,Yw=Qr,L5=Du,zw=function(e,t,n){var r,i;Yw(e);try{if(!(r=L5(e,"return"))){if(t==="throw")throw n;return n}r=P5(r,e)}catch(o){i=!0,r=o}if(t==="throw")throw n;if(i)throw r;return Yw(r),n},k5=da,M5=$t,U5=Qr,x5=di,V5=Hw,F5=la,qw=re,B5=Xg,j5=uf,Xw=zw,G5=TypeError,hf=function(e,t){this.stopped=e,this.result=t},Jw=hf.prototype,Vu=function(e,t,n){var r,i,o,s,c,l,u,h=n&&n.that,f=!(!n||!n.AS_ENTRIES),_=!(!n||!n.IS_RECORD),E=!(!n||!n.IS_ITERATOR),I=!(!n||!n.INTERRUPTED),v=k5(t,h),R=function(O){return r&&Xw(r,"normal"),new hf(!0,O)},A=function(O){return f?(U5(O),I?v(O[0],O[1],R):v(O[0],O[1])):I?v(O,R):v(O)};if(_)r=e.iterator;else if(E)r=e;else{if(!(i=j5(e)))throw new G5(x5(e)+" is not iterable");if(V5(i)){for(o=0,s=F5(e);s>o;o++)if((c=A(e[o]))&&qw(Jw,c))return c;return new hf(!1)}r=B5(e,i)}for(l=_?e.next:r.next;!(u=M5(l,r)).done;){try{c=A(u.value)}catch(O){Xw(r,"throw",O)}if(typeof c=="object"&&c&&qw(Jw,c))return c}return new hf(!1)},W5=Zr,H5=ft,K5=re,Y5=Gg,pf=M4,z5=function(e,t,n){for(var r=z4(t),i=X4.f,o=q4.f,s=0;s<r.length;s++){var c=r[s];Mw(e,c)||n&&Mw(n,c)||i(e,c,o(t,c))}},Qw=xu,Jg=pc,Qg=Fn,q5=function(e,t){d5(t)&&"cause"in t&&l5(e,"cause",t.cause)},X5=function(e,t,n,r){g5&&(Ww?Ww(e,t):m5(e,"stack",E5(n,r)))},J5=Vu,Q5=function(e,t){return e===void 0?arguments.length<2?"":t:W5(e)},Z5=un("toStringTag"),ff=Error,$5=[].push,Nd=function(e,t){var n,r=K5(Zg,this);pf?n=pf(new ff,r?Y5(this):Zg):(n=r?this:Qw(Zg),Jg(n,Z5,"Error")),t!==void 0&&Jg(n,"message",Q5(t)),X5(n,Nd,n.stack,1),arguments.length>2&&q5(n,arguments[2]);var i=[];return J5(e,$5,{that:i}),Jg(n,"errors",i),n};pf?pf(Nd,ff):z5(Nd,ff,{name:!0});var Zg=Nd.prototype=Qw(ff.prototype,{constructor:Qg(1,Nd),message:Qg(1,""),name:Qg(1,"AggregateError")});H5({global:!0},{AggregateError:Nd});var _f,Fu,mf,eG=qe,Zw=fe.WeakMap,tG=eG(Zw)&&/native code/.test(String(Zw)),$w=fe,nG=yn,rG=pc,$g=ir,eS=vg,iG=of,oG=af,eA="Object already initialized",tS=$w.TypeError,sG=$w.WeakMap;if(tG||eS.state){var ss=eS.state||(eS.state=new sG);ss.get=ss.get,ss.has=ss.has,ss.set=ss.set,_f=function(e,t){if(ss.has(e))throw new tS(eA);return t.facade=e,ss.set(e,t),t},Fu=function(e){return ss.get(e)||{}},mf=function(e){return ss.has(e)}}else{var Dd=iG("state");oG[Dd]=!0,_f=function(e,t){if($g(e,Dd))throw new tS(eA);return t.facade=e,rG(e,Dd,t),t},Fu=function(e){return $g(e,Dd)?e[Dd]:{}},mf=function(e){return $g(e,Dd)}}var fc,tA,nA,_c={set:_f,get:Fu,has:mf,enforce:function(e){return mf(e)?Fu(e):_f(e,{})},getterFor:function(e){return function(t){var n;if(!nG(t)||(n=Fu(t)).type!==e)throw new tS("Incompatible receiver, "+e+" required");return n}}},nS=At,aG=ir,rA=Function.prototype,cG=nS&&Object.getOwnPropertyDescriptor,iA=aG(rA,"name"),oA={PROPER:iA&&(function(){}).name==="something",CONFIGURABLE:iA&&(!nS||nS&&cG(rA,"name").configurable)},dG=pc,ha=function(e,t,n,r){return r&&r.enumerable?e[t]=n:dG(e,t,n),e},lG=C,uG=qe,hG=yn,pG=xu,sA=Gg,fG=ha,rS=un("iterator"),aA=!1;[].keys&&("next"in(nA=[].keys())?(tA=sA(sA(nA)))!==Object.prototype&&(fc=tA):aA=!0);var _G=!hG(fc)||lG(function(){var e={};return fc[rS].call(e)!==e});uG((fc=_G?{}:pG(fc))[rS])||fG(fc,rS,function(){return this});var cA={IteratorPrototype:fc,BUGGY_SAFARI_ITERATORS:aA},mG=ua,EG=Mg?{}.toString:function(){return"[object "+mG(this)+"]"},gG=Mg,SG=Ji.f,TG=pc,vG=ir,RG=EG,dA=un("toStringTag"),Ms=function(e,t,n,r){var i=n?e:e&&e.prototype;i&&(vG(i,dA)||SG(i,dA,{configurable:!0,value:t}),r&&!gG&&TG(i,"toString",RG))},yG=cA.IteratorPrototype,CG=xu,IG=Fn,wG=Ms,AG=Od,bG=function(){return this},iS=function(e,t,n,r){var i=t+" Iterator";return e.prototype=CG(yG,{next:IG(+!r,n)}),wG(e,i,!1,!0),AG[i]=bG,e},OG=ft,NG=$t,DG=oA,PG=iS,LG=Gg,kG=Ms,lA=ha,uA=Od,MG=cA,UG=DG.PROPER,Ef=MG.BUGGY_SAFARI_ITERATORS,oS=un("iterator"),hA="keys",gf="values",pA="entries",xG=function(){return this},fA=function(e,t,n,r,i,o,s){PG(n,t,r);var c,l,u,h=function(A){if(A===i&&v)return v;if(!Ef&&A&&A in E)return E[A];switch(A){case hA:case gf:case pA:return function(){return new n(this,A)}}return function(){return new n(this)}},f=t+" Iterator",_=!1,E=e.prototype,I=E[oS]||E["@@iterator"]||i&&E[i],v=!Ef&&I||h(i),R=t==="Array"&&E.entries||I;if(R&&(c=LG(R.call(new e)))!==Object.prototype&&c.next&&(kG(c,f,!0,!0),uA[f]=xG),UG&&i===gf&&I&&I.name!==gf&&(_=!0,v=function(){return NG(I,this)}),i)if(l={values:h(gf),keys:o?v:h(hA),entries:h(pA)},s)for(u in l)(Ef||_||!(u in E))&&lA(E,u,l[u]);else OG({target:t,proto:!0,forced:Ef||_},l);return s&&E[oS]!==v&&lA(E,oS,v,{}),uA[t]=v,l},Sf=function(e,t){return{value:e,done:t}},VG=Ir,_A=Od,mA=_c;Ji.f;var FG=fA,Tf=Sf,EA="Array Iterator",BG=mA.set,jG=mA.getterFor(EA);FG(Array,"Array",function(e,t){BG(this,{type:EA,target:VG(e),index:0,kind:t})},function(){var e=jG(this),t=e.target,n=e.index++;if(!t||n>=t.length)return e.target=null,Tf(void 0,!0);switch(e.kind){case"keys":return Tf(n,!1);case"values":return Tf(t[n],!1)}return Tf([n,t[n]],!1)},"values"),_A.Arguments=_A.Array;var GG=Ji,vf=function(e,t,n){return GG.f(e,t,n)},WG=Zn,HG=vf,KG=At,gA=un("species"),YG=re,zG=TypeError,sS=function(e,t){if(YG(t,e))return e;throw new zG("Incorrect invocation")},qG=qe,aS=vg,XG=oe(Function.toString);qG(aS.inspectSource)||(aS.inspectSource=function(e){return XG(e)});var SA=aS.inspectSource,JG=oe,QG=C,TA=qe,ZG=ua,$G=SA,vA=function(){},RA=Zn("Reflect","construct"),cS=/^\s*(?:class|function)\b/,eW=JG(cS.exec),tW=!cS.test(vA),Bu=function(e){if(!TA(e))return!1;try{return RA(vA,[],e),!0}catch{return!1}},yA=function(e){if(!TA(e))return!1;switch(ZG(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return tW||!!eW(cS,$G(e))}catch{return!0}};yA.sham=!0;var ju,Pd,CA,dS,Rf=!RA||QG(function(){var e;return Bu(Bu.call)||!Bu(Object)||!Bu(function(){e=!0})||e})?yA:Bu,nW=Rf,rW=di,iW=TypeError,IA=Qr,oW=function(e){if(nW(e))return e;throw new iW(rW(e)+" is not a constructor")},sW=dc,aW=un("species"),lS=function(e,t){var n,r=IA(e).constructor;return r===void 0||sW(n=IA(r)[aW])?t:oW(n)},pa=oe([].slice),cW=TypeError,mc=function(e,t){if(e<t)throw new cW("Not enough arguments");return e},wA=/(?:ipad|iphone|ipod).*applewebkit/i.test(Oi),Pi=fe,dW=Q,lW=da,AA=qe,uW=ir,bA=C,OA=Uw,hW=pa,NA=wg,pW=mc,fW=wA,_W=rf,uS=Pi.setImmediate,hS=Pi.clearImmediate,mW=Pi.process,pS=Pi.Dispatch,EW=Pi.Function,DA=Pi.MessageChannel,gW=Pi.String,fS=0,Gu={},PA="onreadystatechange";bA(function(){ju=Pi.location});var _S=function(e){if(uW(Gu,e)){var t=Gu[e];delete Gu[e],t()}},mS=function(e){return function(){_S(e)}},LA=function(e){_S(e.data)},kA=function(e){Pi.postMessage(gW(e),ju.protocol+"//"+ju.host)};uS&&hS||(uS=function(e){pW(arguments.length,1);var t=AA(e)?e:EW(e),n=hW(arguments,1);return Gu[++fS]=function(){dW(t,void 0,n)},Pd(fS),fS},hS=function(e){delete Gu[e]},_W?Pd=function(e){mW.nextTick(mS(e))}:pS&&pS.now?Pd=function(e){pS.now(mS(e))}:DA&&!fW?(dS=(CA=new DA).port2,CA.port1.onmessage=LA,Pd=lW(dS.postMessage,dS)):Pi.addEventListener&&AA(Pi.postMessage)&&!Pi.importScripts&&ju&&ju.protocol!=="file:"&&!bA(kA)?(Pd=kA,Pi.addEventListener("message",LA,!1)):Pd=PA in NA("script")?function(e){OA.appendChild(NA("script"))[PA]=function(){OA.removeChild(this),_S(e)}}:function(e){setTimeout(mS(e),0)});var yf={set:uS,clear:hS},MA=fe,SW=At,TW=Object.getOwnPropertyDescriptor,UA=function(e){if(!SW)return MA[e];var t=TW(MA,e);return t&&t.value},xA=function(){this.head=null,this.tail=null};xA.prototype={add:function(e){var t={item:e,next:null},n=this.tail;n?n.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return(this.head=e.next)===null&&(this.tail=null),e.item}};var Ld,ES,gS,SS,VA,FA=xA,vW=/ipad|iphone|ipod/i.test(Oi)&&typeof Pebble<"u",RW=/web0s(?!.*chrome)/i.test(Oi),kd=fe,yW=UA,BA=da,TS=yf.set,CW=FA,IW=wA,wW=vW,AW=RW,vS=rf,jA=kd.MutationObserver||kd.WebKitMutationObserver,GA=kd.document,WA=kd.process,Cf=kd.Promise,RS=yW("queueMicrotask");if(!RS){var If=new CW,wf=function(){var e,t;for(vS&&(e=WA.domain)&&e.exit();t=If.get();)try{t()}catch(n){throw If.head&&Ld(),n}e&&e.enter()};IW||vS||AW||!jA||!GA?!wW&&Cf&&Cf.resolve?((SS=Cf.resolve(void 0)).constructor=Cf,VA=BA(SS.then,SS),Ld=function(){VA(wf)}):vS?Ld=function(){WA.nextTick(wf)}:(TS=BA(TS,kd),Ld=function(){TS(wf)}):(ES=!0,gS=GA.createTextNode(""),new jA(wf).observe(gS,{characterData:!0}),Ld=function(){gS.data=ES=!ES}),RS=function(e){If.head||Ld(),If.add(e)}}var HA=RS,Md=function(e){try{return{error:!1,value:e()}}catch(t){return{error:!0,value:t}}},Ec=fe.Promise,bW=fe,Wu=Ec,OW=qe,NW=mw,DW=SA,PW=un,KA=Vg,yS=ks,YA=Wu&&Wu.prototype,LW=PW("species"),zA=OW(bW.PromiseRejectionEvent),kW=NW("Promise",function(){var e=DW(Wu),t=e!==String(Wu);if(!t&&yS===66||!YA.catch||!YA.finally)return!0;if(!yS||yS<51||!/native code/.test(e)){var n=new Wu(function(i){i(1)}),r=function(i){i(function(){},function(){})};if((n.constructor={})[LW]=r,!(n.then(function(){})instanceof r))return!0}return!(t||KA!=="BROWSER"&&KA!=="DENO"||zA)}),Hu={CONSTRUCTOR:kW,REJECTION_EVENT:zA},as={},qA=li,MW=TypeError,UW=function(e){var t,n;this.promise=new e(function(r,i){if(t!==void 0||n!==void 0)throw new MW("Bad Promise constructor");t=r,n=i}),this.resolve=qA(t),this.reject=qA(n)};as.f=function(e){return new UW(e)};var CS,XA,JA,xW=ft,Af=rf,fa=fe,VW=wr,Ku=$t,FW=ha,BW=Ms,jW=function(e){var t=WG(e);KG&&t&&!t[gA]&&HG(t,gA,{configurable:!0,get:function(){return this}})},GW=li,IS=qe,WW=yn,HW=sS,KW=lS,QA=yf.set,wS=HA,YW=function(e,t){try{arguments.length===1?console.error(e):console.error(e,t)}catch{}},zW=Md,qW=FA,ZA=_c,AS=Ec,$A=Hu,e0=as,bf="Promise",t0=$A.CONSTRUCTOR,XW=$A.REJECTION_EVENT,bS=ZA.getterFor(bf),JW=ZA.set,QW=AS&&AS.prototype,Yu=AS,OS=QW,n0=fa.TypeError,NS=fa.document,DS=fa.process,PS=e0.f,ZW=PS,$W=!!(NS&&NS.createEvent&&fa.dispatchEvent),r0="unhandledrejection",i0=function(e){var t;return!(!WW(e)||!IS(t=e.then))&&t},o0=function(e,t){var n,r,i,o=t.value,s=t.state===1,c=s?e.ok:e.fail,l=e.resolve,u=e.reject,h=e.domain;try{c?(s||(t.rejection===2&&t6(t),t.rejection=1),c===!0?n=o:(h&&h.enter(),n=c(o),h&&(h.exit(),i=!0)),n===e.promise?u(new n0("Promise-chain cycle")):(r=i0(n))?Ku(r,n,l,u):l(n)):u(o)}catch(f){h&&!i&&h.exit(),u(f)}},s0=function(e,t){e.notified||(e.notified=!0,wS(function(){for(var n,r=e.reactions;n=r.get();)o0(n,e);e.notified=!1,t&&!e.rejection&&e6(e)}))},a0=function(e,t,n){var r,i;$W?((r=NS.createEvent("Event")).promise=t,r.reason=n,r.initEvent(e,!1,!0),fa.dispatchEvent(r)):r={promise:t,reason:n},!XW&&(i=fa["on"+e])?i(r):e===r0&&YW("Unhandled promise rejection",n)},e6=function(e){Ku(QA,fa,function(){var t,n=e.facade,r=e.value;if(c0(e)&&(t=zW(function(){Af?DS.emit("unhandledRejection",r,n):a0(r0,n,r)}),e.rejection=Af||c0(e)?2:1,t.error))throw t.value})},c0=function(e){return e.rejection!==1&&!e.parent},t6=function(e){Ku(QA,fa,function(){var t=e.facade;Af?DS.emit("rejectionHandled",t):a0("rejectionhandled",t,e.value)})},Ud=function(e,t,n){return function(r){e(t,r,n)}},xd=function(e,t,n){e.done||(e.done=!0,n&&(e=n),e.value=t,e.state=2,s0(e,!0))},LS=function(e,t,n){if(!e.done){e.done=!0,n&&(e=n);try{if(e.facade===t)throw new n0("Promise can't be resolved itself");var r=i0(t);r?wS(function(){var i={done:!1};try{Ku(r,t,Ud(LS,i,e),Ud(xd,i,e))}catch(o){xd(i,o,e)}}):(e.value=t,e.state=1,s0(e,!1))}catch(i){xd({done:!1},i,e)}}};t0&&(OS=(Yu=function(e){HW(this,OS),GW(e),Ku(CS,this);var t=bS(this);try{e(Ud(LS,t),Ud(xd,t))}catch(n){xd(t,n)}}).prototype,(CS=function(e){JW(this,{type:bf,done:!1,notified:!1,parent:!1,reactions:new qW,rejection:!1,state:0,value:null})}).prototype=FW(OS,"then",function(e,t){var n=bS(this),r=PS(KW(this,Yu));return n.parent=!0,r.ok=!IS(e)||e,r.fail=IS(t)&&t,r.domain=Af?DS.domain:void 0,n.state===0?n.reactions.add(r):wS(function(){o0(r,n)}),r.promise}),XA=function(){var e=new CS,t=bS(e);this.promise=e,this.resolve=Ud(LS,t),this.reject=Ud(xd,t)},e0.f=PS=function(e){return e===Yu||e===JA?new XA(e):ZW(e)}),xW({global:!0,wrap:!0,forced:t0},{Promise:Yu}),JA=VW.Promise,BW(Yu,bf,!1,!0),jW(bf);var d0=un("iterator"),l0=!1;try{var n6=0,u0={next:function(){return{done:!!n6++}},return:function(){l0=!0}};u0[d0]=function(){return this},Array.from(u0,function(){throw 2})}catch{}var r6=Ec,i6=function(e,t){try{if(!t&&!l0)return!1}catch{return!1}var n=!1;try{var r={};r[d0]=function(){return{next:function(){return{done:n=!0}}}},e(r)}catch{}return n},Of=Hu.CONSTRUCTOR||!i6(function(e){r6.all(e).then(void 0,function(){})}),o6=$t,s6=li,a6=as,c6=Md,d6=Vu;ft({target:"Promise",stat:!0,forced:Of},{all:function(e){var t=this,n=a6.f(t),r=n.resolve,i=n.reject,o=c6(function(){var s=s6(t.resolve),c=[],l=0,u=1;d6(e,function(h){var f=l++,_=!1;u++,o6(s,t,h).then(function(E){_||(_=!0,c[f]=E,--u||r(c))},i)}),--u||r(c)});return o.error&&i(o.value),n.promise}});var l6=ft,u6=Hu.CONSTRUCTOR;Ec&&Ec.prototype,l6({target:"Promise",proto:!0,forced:u6,real:!0},{catch:function(e){return this.then(void 0,e)}});var h6=$t,p6=li,f6=as,_6=Md,m6=Vu;ft({target:"Promise",stat:!0,forced:Of},{race:function(e){var t=this,n=f6.f(t),r=n.reject,i=_6(function(){var o=p6(t.resolve);m6(e,function(s){h6(o,t,s).then(n.resolve,r)})});return i.error&&r(i.value),n.promise}});var E6=as;ft({target:"Promise",stat:!0,forced:Hu.CONSTRUCTOR},{reject:function(e){var t=E6.f(this);return(0,t.reject)(e),t.promise}});var g6=Qr,S6=yn,T6=as,h0=function(e,t){if(g6(e),S6(t)&&t.constructor===e)return t;var n=T6.f(e);return(0,n.resolve)(t),n.promise},v6=ft,R6=Ec,y6=Hu.CONSTRUCTOR,C6=h0,I6=Zn("Promise"),w6=!y6;v6({target:"Promise",stat:!0,forced:!0},{resolve:function(e){return C6(w6&&this===I6?R6:this,e)}});var A6=$t,b6=li,O6=as,N6=Md,D6=Vu;ft({target:"Promise",stat:!0,forced:Of},{allSettled:function(e){var t=this,n=O6.f(t),r=n.resolve,i=n.reject,o=N6(function(){var s=b6(t.resolve),c=[],l=0,u=1;D6(e,function(h){var f=l++,_=!1;u++,A6(s,t,h).then(function(E){_||(_=!0,c[f]={status:"fulfilled",value:E},--u||r(c))},function(E){_||(_=!0,c[f]={status:"rejected",reason:E},--u||r(c))})}),--u||r(c)});return o.error&&i(o.value),n.promise}});var P6=$t,L6=li,k6=Zn,M6=as,U6=Md,x6=Vu,p0="No one promise resolved";ft({target:"Promise",stat:!0,forced:Of},{any:function(e){var t=this,n=k6("AggregateError"),r=M6.f(t),i=r.resolve,o=r.reject,s=U6(function(){var c=L6(t.resolve),l=[],u=0,h=1,f=!1;x6(e,function(_){var E=u++,I=!1;h++,P6(c,t,_).then(function(v){I||f||(f=!0,i(v))},function(v){I||f||(I=!0,l[E]=v,--h||o(new n(l,p0)))})}),--h||o(new n(l,p0))});return s.error&&o(s.value),r.promise}});var V6=ft,F6=Q,B6=pa,j6=as,G6=li,f0=Md,kS=fe.Promise,_0=!1;V6({target:"Promise",stat:!0,forced:!kS||!kS.try||f0(function(){kS.try(function(e){_0=e===8},8)}).error||!_0},{try:function(e){var t=arguments.length>1?B6(arguments,1):[],n=j6.f(this),r=f0(function(){return F6(G6(e),void 0,t)});return(r.error?n.reject:n.resolve)(r.value),n.promise}});var W6=as;ft({target:"Promise",stat:!0},{withResolvers:function(){var e=W6.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var H6=ft,MS=Ec,K6=C,Y6=Zn,z6=qe,q6=lS,m0=h0,X6=MS&&MS.prototype;H6({target:"Promise",proto:!0,real:!0,forced:!!MS&&K6(function(){X6.finally.call({then:function(){}},function(){})})},{finally:function(e){var t=q6(this,Y6("Promise")),n=z6(e);return this.then(n?function(r){return m0(t,e()).then(function(){return r})}:e,n?function(r){return m0(t,e()).then(function(){throw r})}:e)}});var US=oe,J6=Dg,Q6=Zr,Z6=is,$6=US("".charAt),E0=US("".charCodeAt),eH=US("".slice),g0=function(e){return function(t,n){var r,i,o=Q6(Z6(t)),s=J6(n),c=o.length;return s<0||s>=c?e?"":void 0:(r=E0(o,s))<55296||r>56319||s+1===c||(i=E0(o,s+1))<56320||i>57343?e?$6(o,s):r:e?eH(o,s,s+2):i-56320+(r-55296<<10)+65536}},xS={codeAt:g0(!1),charAt:g0(!0)},tH=xS.charAt,nH=Zr,S0=_c,rH=fA,T0=Sf,v0="String Iterator",iH=S0.set,oH=S0.getterFor(v0);rH(String,"String",function(e){iH(this,{type:v0,string:nH(e),index:0})},function(){var e,t=oH(this),n=t.string,r=t.index;return r>=n.length?T0(void 0,!0):(e=tH(n,r),t.index+=e.length,T0(e,!1))});var sH=wr.Promise,aH={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},cH=fe,dH=Ms,R0=Od;for(var VS in aH)dH(cH[VS],VS),R0[VS]=R0.Array;var y0=sH,se=S(y0),lH=Ni("Array","values"),uH=ua,hH=ir,pH=re,fH=lH,FS=Array.prototype,_H={DOMTokenList:!0,NodeList:!0},mH=function(e){var t=e.values;return e===FS||pH(FS,e)&&t===FS.values||hH(_H,uH(e))?fH:t},$r=S(mH),C0=di,EH=TypeError,I0=pa,gH=Math.floor,BS=function(e,t){var n=e.length;if(n<8)for(var r,i,o=1;o<n;){for(i=o,r=e[o];i&&t(e[i-1],r)>0;)e[i]=e[--i];i!==o++&&(e[i]=r)}else for(var s=gH(n/2),c=BS(I0(e,0,s),t),l=BS(I0(e,s),t),u=c.length,h=l.length,f=0,_=0;f<u||_<h;)e[f+_]=f<u&&_<h?t(c[f],l[_])<=0?c[f++]:l[_++]:f<u?c[f++]:l[_++];return e},w0=BS,A0=Oi.match(/firefox\/(\d+)/i),SH=!!A0&&+A0[1],TH=/MSIE|Trident/.test(Oi),b0=Oi.match(/AppleWebKit\/(\d+)\./),vH=!!b0&&+b0[1],RH=ft,O0=oe,yH=li,CH=os,N0=la,IH=function(e,t){if(!delete e[t])throw new EH("Cannot delete property "+C0(t)+" of "+C0(e))},D0=Zr,jS=C,wH=w0,AH=tf,P0=SH,bH=TH,L0=ks,k0=vH,_a=[],M0=O0(_a.sort),OH=O0(_a.push),NH=jS(function(){_a.sort(void 0)}),DH=jS(function(){_a.sort(null)}),PH=AH("sort"),U0=!jS(function(){if(L0)return L0<70;if(!(P0&&P0>3)){if(bH)return!0;if(k0)return k0<603;var e,t,n,r,i="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(r=0;r<47;r++)_a.push({k:t+r,v:n})}for(_a.sort(function(o,s){return s.v-o.v}),r=0;r<_a.length;r++)t=_a[r].k.charAt(0),i.charAt(i.length-1)!==t&&(i+=t);return i!=="DGBEFHACIJK"}});RH({target:"Array",proto:!0,forced:NH||!DH||!PH||!U0},{sort:function(e){e!==void 0&&yH(e);var t=CH(this);if(U0)return e===void 0?M0(t):M0(t,e);var n,r,i=[],o=N0(t);for(r=0;r<o;r++)r in t&&OH(i,t[r]);for(wH(i,function(s){return function(c,l){return l===void 0?-1:c===void 0?1:s!==void 0?+s(c,l)||0:D0(c)>D0(l)?1:-1}}(e)),n=N0(i),r=0;r<n;)t[r]=i[r++];for(;r<o;)IH(t,r++);return t}});var LH=Ni("Array","sort"),kH=re,MH=LH,GS=Array.prototype,UH=function(e){var t=e.sort;return e===GS||kH(GS,e)&&t===GS.sort?MH:t},gc=S(UH),xH=ft,VH=oe,FH=Pg,BH=RangeError,x0=String.fromCharCode,V0=String.fromCodePoint,jH=VH([].join);xH({target:"String",stat:!0,forced:!!V0&&V0.length!==1},{fromCodePoint:function(e){for(var t,n=[],r=arguments.length,i=0;r>i;){if(t=+arguments[i++],FH(t,1114111)!==t)throw new BH(t+" is not a valid code point");n[i]=t<65536?x0(t):x0(55296+((t-=65536)>>10),t%1024+56320)}return jH(n,"")}});var GH=C,WH=un("iterator"),Nf=!GH(function(){var e=new URL("b?a=1&b=2&c=3","https://a"),t=e.searchParams,n=new URLSearchParams("a=1&a=2&b=3"),r="";return e.pathname="c%20d",t.forEach(function(i,o){t.delete("b"),r+=o+i}),n.delete("a",2),n.delete("b",void 0),!e.toJSON||!n.has("a",1)||n.has("a",2)||!n.has("a",void 0)||n.has("b")||!t.size&&!0||!t.sort||e.href!=="https://a/c%20d?a=1&c=3"||t.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!t[WH]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://").host!=="xn--e1aybc"||new URL("https://a#").hash!=="#%D0%B1"||r!=="a1c3"||new URL("https://x",void 0).host!=="x"}),HH=ha,WS=ft,F0=fe,HS=UA,KH=Zn,Df=$t,Ao=oe,zu=At,B0=Nf,j0=ha,YH=vf,zH=function(e,t,n){for(var r in t)n&&n.unsafe&&e[r]?e[r]=t[r]:HH(e,r,t[r],n);return e},qH=Ms,XH=iS,KS=_c,G0=sS,YS=qe,JH=ir,QH=da,ZH=ua,$H=Qr,W0=yn,ei=Zr,e8=xu,H0=Fn,K0=Xg,t8=uf,Pf=Sf,Vd=mc,n8=w0,r8=un("iterator"),Fd="URLSearchParams",Y0=Fd+"Iterator",z0=KS.set,Qi=KS.getterFor(Fd),i8=KS.getterFor(Y0),q0=HS("fetch"),Lf=HS("Request"),qu=HS("Headers"),zS=Lf&&Lf.prototype,X0=qu&&qu.prototype,o8=F0.TypeError,s8=F0.encodeURIComponent,a8=String.fromCharCode,c8=KH("String","fromCodePoint"),d8=parseInt,kf=Ao("".charAt),J0=Ao([].join),ma=Ao([].push),Q0=Ao("".replace),l8=Ao([].shift),Z0=Ao([].splice),$0=Ao("".split),eb=Ao("".slice),u8=Ao(/./.exec),h8=/\+/g,p8=/^[0-9a-f]+$/i,tb=function(e,t){var n=eb(e,t,t+2);return u8(p8,n)?d8(n,16):NaN},f8=function(e){for(var t=0,n=128;n>0&&e&n;n>>=1)t++;return t},_8=function(e){var t=null;switch(e.length){case 1:t=e[0];break;case 2:t=(31&e[0])<<6|63&e[1];break;case 3:t=(15&e[0])<<12|(63&e[1])<<6|63&e[2];break;case 4:t=(7&e[0])<<18|(63&e[1])<<12|(63&e[2])<<6|63&e[3]}return t>1114111?null:t},nb=function(e){for(var t=(e=Q0(e,h8," ")).length,n="",r=0;r<t;){var i=kf(e,r);if(i==="%"){if(kf(e,r+1)==="%"||r+3>t){n+="%",r++;continue}var o=tb(e,r+1);if(o!=o){n+=i,r++;continue}r+=2;var s=f8(o);if(s===0)i=a8(o);else{if(s===1||s>4){n+="",r++;continue}for(var c=[o],l=1;l<s&&!(++r+3>t||kf(e,r)!=="%");){var u=tb(e,r+1);if(u!=u){r+=3;break}if(u>191||u<128)break;ma(c,u),r+=2,l++}if(c.length!==s){n+="";continue}var h=_8(c);h===null?n+="":i=c8(h)}}n+=i,r++}return n},m8=/[!'()~]|%20/g,E8={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},g8=function(e){return E8[e]},rb=function(e){return Q0(s8(e),m8,g8)},qS=XH(function(e,t){z0(this,{type:Y0,target:Qi(e).entries,index:0,kind:t})},Fd,function(){var e=i8(this),t=e.target,n=e.index++;if(!t||n>=t.length)return e.target=null,Pf(void 0,!0);var r=t[n];switch(e.kind){case"keys":return Pf(r.key,!1);case"values":return Pf(r.value,!1)}return Pf([r.key,r.value],!1)},!0),ib=function(e){this.entries=[],this.url=null,e!==void 0&&(W0(e)?this.parseObject(e):this.parseQuery(typeof e=="string"?kf(e,0)==="?"?eb(e,1):e:ei(e)))};ib.prototype={type:Fd,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,n,r,i,o,s,c,l=this.entries,u=t8(e);if(u)for(n=(t=K0(e,u)).next;!(r=Df(n,t)).done;){if(o=(i=K0($H(r.value))).next,(s=Df(o,i)).done||(c=Df(o,i)).done||!Df(o,i).done)throw new o8("Expected sequence with length 2");ma(l,{key:ei(s.value),value:ei(c.value)})}else for(var h in e)JH(e,h)&&ma(l,{key:h,value:ei(e[h])})},parseQuery:function(e){if(e)for(var t,n,r=this.entries,i=$0(e,"&"),o=0;o<i.length;)(t=i[o++]).length&&(n=$0(t,"="),ma(r,{key:nb(l8(n)),value:nb(J0(n,"="))}))},serialize:function(){for(var e,t=this.entries,n=[],r=0;r<t.length;)e=t[r++],ma(n,rb(e.key)+"="+rb(e.value));return J0(n,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Mf=function(){G0(this,Bd);var e=z0(this,new ib(arguments.length>0?arguments[0]:void 0));zu||(this.size=e.entries.length)},Bd=Mf.prototype;if(zH(Bd,{append:function(e,t){var n=Qi(this);Vd(arguments.length,2),ma(n.entries,{key:ei(e),value:ei(t)}),zu||this.length++,n.updateURL()},delete:function(e){for(var t=Qi(this),n=Vd(arguments.length,1),r=t.entries,i=ei(e),o=n<2?void 0:arguments[1],s=o===void 0?o:ei(o),c=0;c<r.length;){var l=r[c];if(l.key!==i||s!==void 0&&l.value!==s)c++;else if(Z0(r,c,1),s!==void 0)break}zu||(this.size=r.length),t.updateURL()},get:function(e){var t=Qi(this).entries;Vd(arguments.length,1);for(var n=ei(e),r=0;r<t.length;r++)if(t[r].key===n)return t[r].value;return null},getAll:function(e){var t=Qi(this).entries;Vd(arguments.length,1);for(var n=ei(e),r=[],i=0;i<t.length;i++)t[i].key===n&&ma(r,t[i].value);return r},has:function(e){for(var t=Qi(this).entries,n=Vd(arguments.length,1),r=ei(e),i=n<2?void 0:arguments[1],o=i===void 0?i:ei(i),s=0;s<t.length;){var c=t[s++];if(c.key===r&&(o===void 0||c.value===o))return!0}return!1},set:function(e,t){var n=Qi(this);Vd(arguments.length,1);for(var r,i=n.entries,o=!1,s=ei(e),c=ei(t),l=0;l<i.length;l++)(r=i[l]).key===s&&(o?Z0(i,l--,1):(o=!0,r.value=c));o||ma(i,{key:s,value:c}),zu||(this.size=i.length),n.updateURL()},sort:function(){var e=Qi(this);n8(e.entries,function(t,n){return t.key>n.key?1:-1}),e.updateURL()},forEach:function(e){for(var t,n=Qi(this).entries,r=QH(e,arguments.length>1?arguments[1]:void 0),i=0;i<n.length;)r((t=n[i++]).value,t.key,this)},keys:function(){return new qS(this,"keys")},values:function(){return new qS(this,"values")},entries:function(){return new qS(this,"entries")}},{enumerable:!0}),j0(Bd,r8,Bd.entries,{}),j0(Bd,"toString",function(){return Qi(this).serialize()},{enumerable:!0}),zu&&YH(Bd,"size",{get:function(){return Qi(this).entries.length},configurable:!0,enumerable:!0}),qH(Mf,Fd),WS({global:!0,forced:!B0},{URLSearchParams:Mf}),!B0&&YS(qu)){var S8=Ao(X0.has),T8=Ao(X0.set),ob=function(e){if(W0(e)){var t,n=e.body;if(ZH(n)===Fd)return t=e.headers?new qu(e.headers):new qu,S8(t,"content-type")||T8(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),e8(e,{body:H0(0,ei(n)),headers:H0(0,t)})}return e};if(YS(q0)&&WS({global:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return q0(e,arguments.length>1?ob(arguments[1]):{})}}),YS(Lf)){var XS=function(e){return G0(this,zS),new Lf(e,arguments.length>1?ob(arguments[1]):{})};zS.constructor=XS,XS.prototype=zS,WS({global:!0,dontCallGetSet:!0,forced:!0},{Request:XS})}}var Zi,v8={URLSearchParams:Mf,getState:Qi},R8=wr.URLSearchParams,sb=At,y8=oe,C8=$t,I8=C,JS=cf,w8=Uu,A8=be,b8=os,O8=cc,jd=Object.assign,ab=Object.defineProperty,N8=y8([].concat),D8=!jd||I8(function(){if(sb&&jd({b:1},jd(ab({},"a",{enumerable:!0,get:function(){ab(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var e={},t={},n=Symbol("assign detection"),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach(function(i){t[i]=i}),jd({},e)[n]!==7||JS(jd({},t)).join("")!==r})?function(e,t){for(var n=b8(e),r=arguments.length,i=1,o=w8.f,s=A8.f;r>i;)for(var c,l=O8(arguments[i++]),u=o?N8(JS(l),o(l)):JS(l),h=u.length,f=0;h>f;)c=u[f++],sb&&!C8(s,l,c)||(n[c]=l[c]);return n}:jd,P8=Qr,L8=zw,k8=At,M8=Ji,U8=Fn,QS=function(e,t,n){k8?M8.f(e,t,U8(0,n)):e[t]=n},x8=da,V8=$t,F8=os,B8=function(e,t,n,r){try{return r?t(P8(n)[0],n[1]):t(n)}catch(i){L8(e,"throw",i)}},j8=Hw,G8=Rf,W8=la,cb=QS,H8=Xg,K8=uf,db=Array,Sc=oe,ZS=2147483647,Y8=/[^\0-\u007E]/,lb=/[.\u3002\uFF0E\uFF61]/g,ub="Overflow: input needs wider integers to process",hb=RangeError,z8=Sc(lb.exec),Gd=Math.floor,$S=String.fromCharCode,pb=Sc("".charCodeAt),fb=Sc([].join),Ea=Sc([].push),q8=Sc("".replace),X8=Sc("".split),J8=Sc("".toLowerCase),_b=function(e){return e+22+75*(e<26)},Q8=function(e,t,n){var r=0;for(e=n?Gd(e/700):e>>1,e+=Gd(e/t);e>455;)e=Gd(e/35),r+=36;return Gd(r+36*e/(e+38))},Z8=function(e){var t=[];e=function(A){for(var O=[],P=0,M=A.length;P<M;){var U=pb(A,P++);if(U>=55296&&U<=56319&&P<M){var L=pb(A,P++);(64512&L)==56320?Ea(O,((1023&U)<<10)+(1023&L)+65536):(Ea(O,U),P--)}else Ea(O,U)}return O}(e);var n,r,i=e.length,o=128,s=0,c=72;for(n=0;n<e.length;n++)(r=e[n])<128&&Ea(t,$S(r));var l=t.length,u=l;for(l&&Ea(t,"-");u<i;){var h=ZS;for(n=0;n<e.length;n++)(r=e[n])>=o&&r<h&&(h=r);var f=u+1;if(h-o>Gd((ZS-s)/f))throw new hb(ub);for(s+=(h-o)*f,o=h,n=0;n<e.length;n++){if((r=e[n])<o&&++s>ZS)throw new hb(ub);if(r===o){for(var _=s,E=36;;){var I=E<=c?1:E>=c+26?26:E-c;if(_<I)break;var v=_-I,R=36-I;Ea(t,$S(_b(I+v%R))),_=Gd(v/R),E+=36}Ea(t,$S(_b(_))),c=Q8(s,f,u===l),s=0,u++}}s++,o++}return fb(t,"")},$8=ft,eT=At,eK=Nf,tT=fe,mb=da,$i=oe,Uf=ha,eo=vf,tK=sS,nT=ir,rT=D8,Wd=function(e){var t=F8(e),n=G8(this),r=arguments.length,i=r>1?arguments[1]:void 0,o=i!==void 0;o&&(i=x8(i,r>2?arguments[2]:void 0));var s,c,l,u,h,f,_=K8(t),E=0;if(!_||this===db&&j8(_))for(s=W8(t),c=n?new this(s):db(s);s>E;E++)f=o?i(t[E],E):t[E],cb(c,E,f);else for(c=n?new this:[],h=(u=H8(t,_)).next;!(l=V8(h,u)).done;E++)f=o?B8(u,i,[l.value,E],!0):l.value,cb(c,E,f);return c.length=E,c},bo=pa,nK=xS.codeAt,rK=function(e){var t,n,r=[],i=X8(q8(J8(e),lb,"."),".");for(t=0;t<i.length;t++)n=i[t],Ea(r,z8(Y8,n)?"xn--"+Z8(n):n);return fb(r,".")},Us=Zr,iK=Ms,oK=mc,Eb=v8,gb=_c,sK=gb.set,xf=gb.getterFor("URL"),aK=Eb.URLSearchParams,cK=Eb.getState,Xu=tT.URL,iT=tT.TypeError,Vf=tT.parseInt,dK=Math.floor,Sb=Math.pow,to=$i("".charAt),Oo=$i(/./.exec),Ju=$i([].join),lK=$i(1.1.toString),uK=$i([].pop),Hd=$i([].push),oT=$i("".replace),hK=$i([].shift),pK=$i("".split),Qu=$i("".slice),Ff=$i("".toLowerCase),fK=$i([].unshift),sT="Invalid scheme",Tc="Invalid host",Tb="Invalid port",vb=/[a-z]/i,_K=/[\d+-.a-z]/i,aT=/\d/,mK=/^0x/i,EK=/^[0-7]+$/,gK=/^\d+$/,Rb=/^[\da-f]+$/i,SK=/[\0\t\n\r #%/:<>?@[\\\]^|]/,TK=/[\0\t\n\r #/:<>?@[\\\]^|]/,vK=/^[\u0000-\u0020]+/,RK=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,yK=/[\t\n\r]/g,Zu=function(e){var t,n,r,i;if(typeof e=="number"){for(t=[],n=0;n<4;n++)fK(t,e%256),e=dK(e/256);return Ju(t,".")}if(typeof e=="object"){for(t="",r=function(o){for(var s=null,c=1,l=null,u=0,h=0;h<8;h++)o[h]!==0?(u>c&&(s=l,c=u),l=null,u=0):(l===null&&(l=h),++u);return u>c?l:s}(e),n=0;n<8;n++)i&&e[n]===0||(i&&(i=!1),r===n?(t+=n?":":"::",i=!0):(t+=lK(e[n],16),n<7&&(t+=":")));return"["+t+"]"}return e},Bf={},yb=rT({},Bf,{" ":1,'"':1,"<":1,">":1,"`":1}),Cb=rT({},yb,{"#":1,"?":1,"{":1,"}":1}),cT=rT({},Cb,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),ga=function(e,t){var n=nK(e,0);return n>32&&n<127&&!nT(t,e)?e:encodeURIComponent(e)},jf={ftp:21,file:null,http:80,https:443,ws:80,wss:443},$u=function(e,t){var n;return e.length===2&&Oo(vb,to(e,0))&&((n=to(e,1))===":"||!t&&n==="|")},Ib=function(e){var t;return e.length>1&&$u(Qu(e,0,2))&&(e.length===2||(t=to(e,2))==="/"||t==="\\"||t==="?"||t==="#")},CK=function(e){return e==="."||Ff(e)==="%2e"},dT={},wb={},lT={},Ab={},bb={},uT={},Ob={},Nb={},Gf={},Wf={},hT={},pT={},fT={},_T={},Db={},mT={},Kd={},cs={},Pb={},vc={},xs={},ET=function(e,t,n){var r,i,o,s=Us(e);if(t){if(i=this.parse(s))throw new iT(i);this.searchParams=null}else{if(n!==void 0&&(r=new ET(n,!0)),i=this.parse(s,null,r))throw new iT(i);(o=cK(new aK)).bindURL(this),this.searchParams=o}};ET.prototype={type:"URL",parse:function(e,t,n){var r,i,o,s,c,l=this,u=t||dT,h=0,f="",_=!1,E=!1,I=!1;for(e=Us(e),t||(l.scheme="",l.username="",l.password="",l.host=null,l.port=null,l.path=[],l.query=null,l.fragment=null,l.cannotBeABaseURL=!1,e=oT(e,vK,""),e=oT(e,RK,"$1")),e=oT(e,yK,""),r=Wd(e);h<=r.length;){switch(i=r[h],u){case dT:if(!i||!Oo(vb,i)){if(t)return sT;u=lT;continue}f+=Ff(i),u=wb;break;case wb:if(i&&(Oo(_K,i)||i==="+"||i==="-"||i==="."))f+=Ff(i);else{if(i!==":"){if(t)return sT;f="",u=lT,h=0;continue}if(t&&(l.isSpecial()!==nT(jf,f)||f==="file"&&(l.includesCredentials()||l.port!==null)||l.scheme==="file"&&!l.host))return;if(l.scheme=f,t)return void(l.isSpecial()&&jf[l.scheme]===l.port&&(l.port=null));f="",l.scheme==="file"?u=_T:l.isSpecial()&&n&&n.scheme===l.scheme?u=Ab:l.isSpecial()?u=Nb:r[h+1]==="/"?(u=bb,h++):(l.cannotBeABaseURL=!0,Hd(l.path,""),u=Pb)}break;case lT:if(!n||n.cannotBeABaseURL&&i!=="#")return sT;if(n.cannotBeABaseURL&&i==="#"){l.scheme=n.scheme,l.path=bo(n.path),l.query=n.query,l.fragment="",l.cannotBeABaseURL=!0,u=xs;break}u=n.scheme==="file"?_T:uT;continue;case Ab:if(i!=="/"||r[h+1]!=="/"){u=uT;continue}u=Gf,h++;break;case bb:if(i==="/"){u=Wf;break}u=cs;continue;case uT:if(l.scheme=n.scheme,i===Zi)l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=bo(n.path),l.query=n.query;else if(i==="/"||i==="\\"&&l.isSpecial())u=Ob;else if(i==="?")l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=bo(n.path),l.query="",u=vc;else{if(i!=="#"){l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=bo(n.path),l.path.length--,u=cs;continue}l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,l.path=bo(n.path),l.query=n.query,l.fragment="",u=xs}break;case Ob:if(!l.isSpecial()||i!=="/"&&i!=="\\"){if(i!=="/"){l.username=n.username,l.password=n.password,l.host=n.host,l.port=n.port,u=cs;continue}u=Wf}else u=Gf;break;case Nb:if(u=Gf,i!=="/"||to(f,h+1)!=="/")continue;h++;break;case Gf:if(i!=="/"&&i!=="\\"){u=Wf;continue}break;case Wf:if(i==="@"){_&&(f="%40"+f),_=!0,o=Wd(f);for(var v=0;v<o.length;v++){var R=o[v];if(R!==":"||I){var A=ga(R,cT);I?l.password+=A:l.username+=A}else I=!0}f=""}else if(i===Zi||i==="/"||i==="?"||i==="#"||i==="\\"&&l.isSpecial()){if(_&&f==="")return"Invalid authority";h-=Wd(f).length+1,f="",u=hT}else f+=i;break;case hT:case pT:if(t&&l.scheme==="file"){u=mT;continue}if(i!==":"||E){if(i===Zi||i==="/"||i==="?"||i==="#"||i==="\\"&&l.isSpecial()){if(l.isSpecial()&&f==="")return Tc;if(t&&f===""&&(l.includesCredentials()||l.port!==null))return;if(s=l.parseHost(f))return s;if(f="",u=Kd,t)return;continue}i==="["?E=!0:i==="]"&&(E=!1),f+=i}else{if(f==="")return Tc;if(s=l.parseHost(f))return s;if(f="",u=fT,t===pT)return}break;case fT:if(!Oo(aT,i)){if(i===Zi||i==="/"||i==="?"||i==="#"||i==="\\"&&l.isSpecial()||t){if(f!==""){var O=Vf(f,10);if(O>65535)return Tb;l.port=l.isSpecial()&&O===jf[l.scheme]?null:O,f=""}if(t)return;u=Kd;continue}return Tb}f+=i;break;case _T:if(l.scheme="file",i==="/"||i==="\\")u=Db;else{if(!n||n.scheme!=="file"){u=cs;continue}switch(i){case Zi:l.host=n.host,l.path=bo(n.path),l.query=n.query;break;case"?":l.host=n.host,l.path=bo(n.path),l.query="",u=vc;break;case"#":l.host=n.host,l.path=bo(n.path),l.query=n.query,l.fragment="",u=xs;break;default:Ib(Ju(bo(r,h),""))||(l.host=n.host,l.path=bo(n.path),l.shortenPath()),u=cs;continue}}break;case Db:if(i==="/"||i==="\\"){u=mT;break}n&&n.scheme==="file"&&!Ib(Ju(bo(r,h),""))&&($u(n.path[0],!0)?Hd(l.path,n.path[0]):l.host=n.host),u=cs;continue;case mT:if(i===Zi||i==="/"||i==="\\"||i==="?"||i==="#"){if(!t&&$u(f))u=cs;else if(f===""){if(l.host="",t)return;u=Kd}else{if(s=l.parseHost(f))return s;if(l.host==="localhost"&&(l.host=""),t)return;f="",u=Kd}continue}f+=i;break;case Kd:if(l.isSpecial()){if(u=cs,i!=="/"&&i!=="\\")continue}else if(t||i!=="?")if(t||i!=="#"){if(i!==Zi&&(u=cs,i!=="/"))continue}else l.fragment="",u=xs;else l.query="",u=vc;break;case cs:if(i===Zi||i==="/"||i==="\\"&&l.isSpecial()||!t&&(i==="?"||i==="#")){if((c=Ff(c=f))===".."||c==="%2e."||c===".%2e"||c==="%2e%2e"?(l.shortenPath(),i==="/"||i==="\\"&&l.isSpecial()||Hd(l.path,"")):CK(f)?i==="/"||i==="\\"&&l.isSpecial()||Hd(l.path,""):(l.scheme==="file"&&!l.path.length&&$u(f)&&(l.host&&(l.host=""),f=to(f,0)+":"),Hd(l.path,f)),f="",l.scheme==="file"&&(i===Zi||i==="?"||i==="#"))for(;l.path.length>1&&l.path[0]==="";)hK(l.path);i==="?"?(l.query="",u=vc):i==="#"&&(l.fragment="",u=xs)}else f+=ga(i,Cb);break;case Pb:i==="?"?(l.query="",u=vc):i==="#"?(l.fragment="",u=xs):i!==Zi&&(l.path[0]+=ga(i,Bf));break;case vc:t||i!=="#"?i!==Zi&&(i==="'"&&l.isSpecial()?l.query+="%27":l.query+=i==="#"?"%23":ga(i,Bf)):(l.fragment="",u=xs);break;case xs:i!==Zi&&(l.fragment+=ga(i,yb))}h++}},parseHost:function(e){var t,n,r;if(to(e,0)==="["){if(to(e,e.length-1)!=="]"||(t=function(i){var o,s,c,l,u,h,f,_=[0,0,0,0,0,0,0,0],E=0,I=null,v=0,R=function(){return to(i,v)};if(R()===":"){if(to(i,1)!==":")return;v+=2,I=++E}for(;R();){if(E===8)return;if(R()!==":"){for(o=s=0;s<4&&Oo(Rb,R());)o=16*o+Vf(R(),16),v++,s++;if(R()==="."){if(s===0||(v-=s,E>6))return;for(c=0;R();){if(l=null,c>0){if(!(R()==="."&&c<4))return;v++}if(!Oo(aT,R()))return;for(;Oo(aT,R());){if(u=Vf(R(),10),l===null)l=u;else{if(l===0)return;l=10*l+u}if(l>255)return;v++}_[E]=256*_[E]+l,++c!=2&&c!==4||E++}if(c!==4)return;break}if(R()===":"){if(v++,!R())return}else if(R())return;_[E++]=o}else{if(I!==null)return;v++,I=++E}}if(I!==null)for(h=E-I,E=7;E!==0&&h>0;)f=_[E],_[E--]=_[I+h-1],_[I+--h]=f;else if(E!==8)return;return _}(Qu(e,1,-1)),!t))return Tc;this.host=t}else if(this.isSpecial()){if(e=rK(e),Oo(SK,e)||(t=function(i){var o,s,c,l,u,h,f,_=pK(i,".");if(_.length&&_[_.length-1]===""&&_.length--,(o=_.length)>4)return i;for(s=[],c=0;c<o;c++){if((l=_[c])==="")return i;if(u=10,l.length>1&&to(l,0)==="0"&&(u=Oo(mK,l)?16:8,l=Qu(l,u===8?1:2)),l==="")h=0;else{if(!Oo(u===10?gK:u===8?EK:Rb,l))return i;h=Vf(l,u)}Hd(s,h)}for(c=0;c<o;c++)if(h=s[c],c===o-1){if(h>=Sb(256,5-o))return null}else if(h>255)return null;for(f=uK(s),c=0;c<s.length;c++)f+=s[c]*Sb(256,3-c);return f}(e),t===null))return Tc;this.host=t}else{if(Oo(TK,e))return Tc;for(t="",n=Wd(e),r=0;r<n.length;r++)t+=ga(n[r],Bf);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return nT(jf,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||this.scheme==="file"&&t===1&&$u(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,n=e.username,r=e.password,i=e.host,o=e.port,s=e.path,c=e.query,l=e.fragment,u=t+":";return i!==null?(u+="//",e.includesCredentials()&&(u+=n+(r?":"+r:"")+"@"),u+=Zu(i),o!==null&&(u+=":"+o)):t==="file"&&(u+="//"),u+=e.cannotBeABaseURL?s[0]:s.length?"/"+Ju(s,"/"):"",c!==null&&(u+="?"+c),l!==null&&(u+="#"+l),u},setHref:function(e){var t=this.parse(e);if(t)throw new iT(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if(e==="blob")try{return new Yd(e.path[0]).origin}catch{return"null"}return e!=="file"&&this.isSpecial()?e+"://"+Zu(this.host)+(t!==null?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(Us(e)+":",dT)},getUsername:function(){return this.username},setUsername:function(e){var t=Wd(Us(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var n=0;n<t.length;n++)this.username+=ga(t[n],cT)}},getPassword:function(){return this.password},setPassword:function(e){var t=Wd(Us(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var n=0;n<t.length;n++)this.password+=ga(t[n],cT)}},getHost:function(){var e=this.host,t=this.port;return e===null?"":t===null?Zu(e):Zu(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,hT)},getHostname:function(){var e=this.host;return e===null?"":Zu(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,pT)},getPort:function(){var e=this.port;return e===null?"":Us(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||((e=Us(e))===""?this.port=null:this.parse(e,fT))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+Ju(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,Kd))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){(e=Us(e))===""?this.query=null:(to(e,0)==="?"&&(e=Qu(e,1)),this.query="",this.parse(e,vc)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){(e=Us(e))!==""?(to(e,0)==="#"&&(e=Qu(e,1)),this.fragment="",this.parse(e,xs)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Yd=function(e){var t=tK(this,ti),n=oK(arguments.length,1)>1?arguments[1]:void 0,r=sK(t,new ET(e,!1,n));eT||(t.href=r.serialize(),t.origin=r.getOrigin(),t.protocol=r.getProtocol(),t.username=r.getUsername(),t.password=r.getPassword(),t.host=r.getHost(),t.hostname=r.getHostname(),t.port=r.getPort(),t.pathname=r.getPathname(),t.search=r.getSearch(),t.searchParams=r.getSearchParams(),t.hash=r.getHash())},ti=Yd.prototype,no=function(e,t){return{get:function(){return xf(this)[e]()},set:t&&function(n){return xf(this)[t](n)},configurable:!0,enumerable:!0}};if(eT&&(eo(ti,"href",no("serialize","setHref")),eo(ti,"origin",no("getOrigin")),eo(ti,"protocol",no("getProtocol","setProtocol")),eo(ti,"username",no("getUsername","setUsername")),eo(ti,"password",no("getPassword","setPassword")),eo(ti,"host",no("getHost","setHost")),eo(ti,"hostname",no("getHostname","setHostname")),eo(ti,"port",no("getPort","setPort")),eo(ti,"pathname",no("getPathname","setPathname")),eo(ti,"search",no("getSearch","setSearch")),eo(ti,"searchParams",no("getSearchParams")),eo(ti,"hash",no("getHash","setHash"))),Uf(ti,"toJSON",function(){return xf(this).serialize()},{enumerable:!0}),Uf(ti,"toString",function(){return xf(this).serialize()},{enumerable:!0}),Xu){var Lb=Xu.createObjectURL,kb=Xu.revokeObjectURL;Lb&&Uf(Yd,"createObjectURL",mb(Lb,Xu)),kb&&Uf(Yd,"revokeObjectURL",mb(kb,Xu))}iK(Yd,"URL"),$8({global:!0,forced:!eK,sham:!eT},{URL:Yd});var IK=ft,Mb=C,wK=mc,Ub=Zr,AK=Nf,gT=Zn("URL"),bK=AK&&Mb(function(){gT.canParse()}),OK=Mb(function(){return gT.canParse.length!==1});IK({target:"URL",stat:!0,forced:!bK||OK},{canParse:function(e){var t=wK(arguments.length,1),n=Ub(e),r=t<2||arguments[1]===void 0?void 0:Ub(arguments[1]);try{return!!new gT(n,r)}catch{return!1}}});var NK=ft,DK=mc,xb=Zr,PK=Nf,LK=Zn("URL");NK({target:"URL",stat:!0,forced:!PK},{parse:function(e){var t=DK(arguments.length,1),n=xb(e),r=t<2||arguments[1]===void 0?void 0:xb(arguments[1]);try{return new LK(n,r)}catch{return null}}});var Hf=S(wr.URL);let Vb=!0,Fb=!0;function Kf(e,t,n){const r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}function Rc(e,t,n){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(s,c){if(s!==t)return i.apply(this,arguments);const l=u=>{const h=n(u);h&&(c.handleEvent?c.handleEvent(h):c(h))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(c,l),i.apply(this,[s,l])};const o=r.removeEventListener;r.removeEventListener=function(s,c){if(s!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(c))return o.apply(this,arguments);const l=this._eventMap[t].get(c);return this._eventMap[t].delete(c),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[s,l])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(s){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),s&&this.addEventListener(t,this["_on"+t]=s)},enumerable:!0,configurable:!0})}function kK(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Vb=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function MK(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Fb=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function Bb(){if(typeof window=="object"){if(Vb)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function ST(e,t){Fb&&console.warn(e+" is deprecated, please use "+t+" instead.")}function jb(e){return Object.prototype.toString.call(e)==="[object Object]"}function Gb(e){var t;return jb(e)?Di(t=Object.keys(e)).call(t,function(n,r){const i=jb(e[r]),o=i?Gb(e[r]):e[r],s=i&&!Object.keys(o).length;return o===void 0||s?n:Object.assign(n,{[r]:o})},{}):e}function TT(e,t,n){t&&!n.has(t.id)&&(n.set(t.id,t),Object.keys(t).forEach(r=>{r.endsWith("Id")?TT(e,e.get(t[r]),n):r.endsWith("Ids")&&t[r].forEach(i=>{TT(e,e.get(i),n)})}))}function Wb(e,t,n){const r=n?"outbound-rtp":"inbound-rtp",i=new Map;if(t===null)return i;const o=[];return e.forEach(s=>{s.type==="track"&&s.trackIdentifier===t.id&&o.push(s)}),o.forEach(s=>{e.forEach(c=>{c.type===r&&c.trackId===s.id&&TT(e,c,i)})}),i}const Hb=Bb;function Kb(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const r=function(s){if(typeof s!="object"||s.mandatory||s.optional)return s;const c={};return Object.keys(s).forEach(l=>{if(l==="require"||l==="advanced"||l==="mediaSource")return;const u=typeof s[l]=="object"?s[l]:{ideal:s[l]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);const h=function(f,_){return f?f+_.charAt(0).toUpperCase()+_.slice(1):_==="deviceId"?"sourceId":_};if(u.ideal!==void 0){c.optional=c.optional||[];let f={};typeof u.ideal=="number"?(f[h("min",l)]=u.ideal,c.optional.push(f),f={},f[h("max",l)]=u.ideal,c.optional.push(f)):(f[h("",l)]=u.ideal,c.optional.push(f))}u.exact!==void 0&&typeof u.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[h("",l)]=u.exact):["min","max"].forEach(f=>{u[f]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[h(f,l)]=u[f])})}),s.advanced&&(c.optional=(c.optional||[]).concat(s.advanced)),c},i=function(s,c){if(t.version>=61)return c(s);if((s=JSON.parse(JSON.stringify(s)))&&typeof s.audio=="object"){const l=function(u,h,f){h in u&&!(f in u)&&(u[f]=u[h],delete u[h])};l((s=JSON.parse(JSON.stringify(s))).audio,"autoGainControl","googAutoGainControl"),l(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=r(s.audio)}if(s&&typeof s.video=="object"){let l=s.video.facingMode;l=l&&(typeof l=="object"?l:{ideal:l});const u=t.version<66;if(l&&(l.exact==="user"||l.exact==="environment"||l.ideal==="user"||l.ideal==="environment")&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||u)){let h;if(delete s.video.facingMode,l.exact==="environment"||l.ideal==="environment"?h=["back","rear"]:l.exact!=="user"&&l.ideal!=="user"||(h=["front"]),h)return n.mediaDevices.enumerateDevices().then(f=>{f=f.filter(E=>E.kind==="videoinput");let _=f.find(E=>h.some(I=>{var v;return Z(v=E.label.toLowerCase()).call(v,I)}));return!_&&f.length&&Z(h).call(h,"back")&&(_=f[f.length-1]),_&&(s.video.deviceId=l.exact?{exact:_.deviceId}:{ideal:_.deviceId}),s.video=r(s.video),Hb("chrome: "+JSON.stringify(s)),c(s)})}s.video=r(s.video)}return Hb("chrome: "+JSON.stringify(s)),c(s)},o=function(s){return t.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(n.getUserMedia=(function(s,c,l){i(s,u=>{n.webkitGetUserMedia(u,c,h=>{l&&l(o(h))})})}).bind(n),n.mediaDevices.getUserMedia){const s=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(c){return i(c,l=>s(l).then(u=>{if(l.audio&&!u.getAudioTracks().length||l.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(h=>{h.stop()}),new DOMException("","NotFoundError");return u},u=>se.reject(o(u))))}}}function Yb(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function zb(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=n=>{n.stream.addEventListener("addtrack",r=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===r.track.id):{track:r.track};const o=new Event("track");o.track=r.track,o.receiver=i,o.transceiver={receiver:i},o.streams=[n.stream],this.dispatchEvent(o)}),n.stream.getTracks().forEach(r=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===r.id):{track:r};const o=new Event("track");o.track=r,o.receiver=i,o.transceiver={receiver:i},o.streams=[n.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Rc(e,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function qb(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(i,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=i.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:i}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(s,c){let l=i.apply(this,arguments);return l||(l=t(this,s),this._senders.push(l)),l};const o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(s){o.apply(this,arguments);const c=this._senders.indexOf(s);c!==-1&&this._senders.splice(c,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(i){this._senders=this._senders||[],n.apply(this,[i]),i.getTracks().forEach(o=>{this._senders.push(t(this,o))})};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(i){this._senders=this._senders||[],r.apply(this,[i]),i.getTracks().forEach(o=>{const s=this._senders.find(c=>c.track===o);s&&this._senders.splice(this._senders.indexOf(s),1)})}}else if(typeof e=="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const n=t.apply(this,[]);return n.forEach(r=>r._pc=this),n},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Xb(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[n,r,i]=arguments;if(arguments.length>0&&typeof n=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof n!="function"))return t.apply(this,[]);const o=function(c){const l={};return c.result().forEach(u=>{const h={id:u.id,timestamp:u.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[u.type]||u.type};u.names().forEach(f=>{h[f]=u.stat(f)}),l[h.id]=h}),l},s=function(c){return new Map(Object.keys(c).map(l=>[l,c[l]]))};if(arguments.length>=2){const c=function(l){r(s(o(l)))};return t.apply(this,[c,n])}return new se((c,l)=>{t.apply(this,[function(u){c(s(o(u)))},l])}).then(r,i)}}function Jb(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const n=e.RTCPeerConnection.prototype.getSenders;n&&(e.RTCPeerConnection.prototype.getSenders=function(){const i=n.apply(this,[]);return i.forEach(o=>o._pc=this),i});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const i=r.apply(this,arguments);return i._pc=this,i}),e.RTCRtpSender.prototype.getStats=function(){const i=this;return this._pc.getStats().then(o=>Wb(o,i.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const n=e.RTCPeerConnection.prototype.getReceivers;n&&(e.RTCPeerConnection.prototype.getReceivers=function(){const r=n.apply(this,[]);return r.forEach(i=>i._pc=this),r}),Rc(e,"track",r=>(r.receiver._pc=r.srcElement,r)),e.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(i=>Wb(i,r.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const n=arguments[0];let r,i,o;return this.getSenders().forEach(s=>{s.track===n&&(r?o=!0:r=s)}),this.getReceivers().forEach(s=>(s.track===n&&(i?o=!0:i=s),s.track===n)),o||r&&i?se.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():i?i.getStats():se.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function Qb(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(o,s){if(!s)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=t.apply(this,arguments);return this._shimmedLocalStreams[s.id]?this._shimmedLocalStreams[s.id].indexOf(c)===-1&&this._shimmedLocalStreams[s.id].push(c):this._shimmedLocalStreams[s.id]=[s,c],c};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(l=>{if(this.getSenders().find(h=>h.track===l))throw new DOMException("Track already exists.","InvalidAccessError")});const s=this.getSenders();n.apply(this,arguments);const c=this.getSenders().filter(l=>s.indexOf(l)===-1);this._shimmedLocalStreams[o.id]=[o].concat(c)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],r.apply(this,arguments)};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(s=>{const c=this._shimmedLocalStreams[s].indexOf(o);c!==-1&&this._shimmedLocalStreams[s].splice(c,1),this._shimmedLocalStreams[s].length===1&&delete this._shimmedLocalStreams[s]}),i.apply(this,arguments)}}function Zb(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return Qb(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const l=n.apply(this);return this._reverseStreams=this._reverseStreams||{},l.map(u=>this._reverseStreams[u.id])};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(l){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},l.getTracks().forEach(u=>{if(this.getSenders().find(f=>f.track===u))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[l.id]){const u=new e.MediaStream(l.getTracks());this._streams[l.id]=u,this._reverseStreams[u.id]=l,l=u}r.apply(this,[l])};const i=e.RTCPeerConnection.prototype.removeStream;function o(l,u){let h=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(f=>{const _=l._reverseStreams[f],E=l._streams[_.id];h=h.replace(new RegExp(E.id,"g"),_.id)}),new RTCSessionDescription({type:u.type,sdp:h})}e.RTCPeerConnection.prototype.removeStream=function(l){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[l.id]||l]),delete this._reverseStreams[this._streams[l.id]?this._streams[l.id].id:l.id],delete this._streams[l.id]},e.RTCPeerConnection.prototype.addTrack=function(l,u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(E=>E===l))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(E=>E.track===l))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const _=this._streams[u.id];if(_)_.addTrack(l),se.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const E=new e.MediaStream([l]);this._streams[u.id]=E,this._reverseStreams[E.id]=u,this.addStream(E)}return this.getSenders().find(E=>E.track===l)},["createOffer","createAnswer"].forEach(function(l){const u=e.RTCPeerConnection.prototype[l],h={[l](){const f=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[_=>{const E=o(this,_);f[0].apply(null,[E])},_=>{f[1]&&f[1].apply(null,_)},arguments[2]]):u.apply(this,arguments).then(_=>o(this,_))}};e.RTCPeerConnection.prototype[l]=h[l]});const s=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(l,u){let h=u.sdp;return Object.keys(l._reverseStreams||[]).forEach(f=>{const _=l._reverseStreams[f],E=l._streams[_.id];h=h.replace(new RegExp(_.id,"g"),E.id)}),new RTCSessionDescription({type:u.type,sdp:h})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const l=c.get.apply(this);return l.type===""?l:o(this,l)}}),e.RTCPeerConnection.prototype.removeTrack=function(l){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!l._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(l._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let u;this._streams=this._streams||{},Object.keys(this._streams).forEach(h=>{this._streams[h].getTracks().find(f=>l.track===f)&&(u=this._streams[h])}),u&&(u.getTracks().length===1?this.removeStream(this._reverseStreams[u.id]):u.removeTrack(l.track),this.dispatchEvent(new Event("negotiationneeded")))}}function vT(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const r=e.RTCPeerConnection.prototype[n],i={[n](){return arguments[0]=new(n==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[n]=i[n]})}function $b(e,t){Rc(e,"negotiationneeded",n=>{const r=n.target;if(!(t.version<72||r.getConfiguration&&r.getConfiguration().sdpSemantics==="plan-b")||r.signalingState==="stable")return n})}var eO=Object.freeze({__proto__:null,fixNegotiationNeeded:$b,shimAddTrackRemoveTrack:Zb,shimAddTrackRemoveTrackWithNative:Qb,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(typeof t=="function"?e.navigator.mediaDevices.getDisplayMedia=function(n){return t(n).then(r=>{const i=n.video&&n.video.width,o=n.video&&n.video.height,s=n.video&&n.video.frameRate;return n.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:s||3}},i&&(n.video.mandatory.maxWidth=i),o&&(n.video.mandatory.maxHeight=o),e.navigator.mediaDevices.getUserMedia(n)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:qb,shimGetStats:Xb,shimGetUserMedia:Kb,shimMediaStream:Yb,shimOnTrack:zb,shimPeerConnection:vT,shimSenderReceiverGetStats:Jb});function tO(e,t){const n=e&&e.navigator,r=e&&e.MediaStreamTrack;if(n.getUserMedia=function(i,o,s){ST("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(i).then(o,s)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const i=function(s,c,l){c in s&&!(l in s)&&(s[l]=s[c],delete s[c])},o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(s){return typeof s=="object"&&typeof s.audio=="object"&&(s=JSON.parse(JSON.stringify(s)),i(s.audio,"autoGainControl","mozAutoGainControl"),i(s.audio,"noiseSuppression","mozNoiseSuppression")),o(s)},r&&r.prototype.getSettings){const s=r.prototype.getSettings;r.prototype.getSettings=function(){const c=s.apply(this,arguments);return i(c,"mozAutoGainControl","autoGainControl"),i(c,"mozNoiseSuppression","noiseSuppression"),c}}if(r&&r.prototype.applyConstraints){const s=r.prototype.applyConstraints;r.prototype.applyConstraints=function(c){return this.kind==="audio"&&typeof c=="object"&&(c=JSON.parse(JSON.stringify(c)),i(c,"autoGainControl","mozAutoGainControl"),i(c,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[c])}}}}function nO(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function RT(e,t){if(typeof e!="object"||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){const o=e.RTCPeerConnection.prototype[i],s={[i](){return arguments[0]=new(i==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};e.RTCPeerConnection.prototype[i]=s[i]});const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[i,o,s]=arguments;return r.apply(this,[i||null]).then(c=>{if(t.version<53&&!o)try{c.forEach(l=>{l.type=n[l.type]||l.type})}catch(l){if(l.name!=="TypeError")throw l;c.forEach((u,h)=>{c.set(h,Object.assign({},u,{type:n[u.type]||u.type}))})}return c}).then(o,s)}}function rO(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const r=t.apply(this,[]);return r.forEach(i=>i._pc=this),r});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const r=n.apply(this,arguments);return r._pc=this,r}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):se.resolve(new Map)}}function iO(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const n=t.apply(this,[]);return n.forEach(r=>r._pc=this),n}),Rc(e,"track",n=>(n.receiver._pc=n.srcElement,n)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function oO(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(t){ST("removeStream","removeTrack"),this.getSenders().forEach(n=>{var r;n.track&&Z(r=t.getTracks()).call(r,n.track)&&this.removeTrack(n)})})}function sO(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function aO(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let n=arguments[1]&&arguments[1].sendEncodings;n===void 0&&(n=[]),n=[...n];const r=n.length>0;r&&n.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const i=t.apply(this,arguments);if(r){const{sender:o}=i,s=o.getParameters();(!("encodings"in s)||s.encodings.length===1&&Object.keys(s.encodings[0]).length===0)&&(s.encodings=n,o.sendEncodings=n,this.setParametersPromises.push(o.setParameters(s).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return i})}function cO(e){if(typeof e!="object"||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const n=t.apply(this,arguments);return"encodings"in n||(n.encodings=[].concat(this.sendEncodings||[{}])),n})}function dO(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?se.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function lO(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?se.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var uO=Object.freeze({__proto__:null,shimAddTransceiver:aO,shimCreateAnswer:lO,shimCreateOffer:dO,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(n){if(!n||!n.video){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,se.reject(r)}return n.video===!0?n.video={mediaSource:t}:n.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(n)})},shimGetParameters:cO,shimGetUserMedia:tO,shimOnTrack:nO,shimPeerConnection:RT,shimRTCDataChannel:sO,shimReceiverGetStats:iO,shimRemoveStream:oO,shimSenderGetStats:rO});function hO(e){if(typeof e=="object"&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(n){var r;this._localStreams||(this._localStreams=[]),Z(r=this._localStreams).call(r,n)||this._localStreams.push(n),n.getAudioTracks().forEach(i=>t.call(this,i,n)),n.getVideoTracks().forEach(i=>t.call(this,i,n))},e.RTCPeerConnection.prototype.addTrack=function(n){for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];return i&&i.forEach(s=>{var c;this._localStreams?Z(c=this._localStreams).call(c,s)||this._localStreams.push(s):this._localStreams=[s]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const n=this._localStreams.indexOf(t);if(n===-1)return;this._localStreams.splice(n,1);const r=t.getTracks();this.getSenders().forEach(i=>{Z(r).call(r,i.track)&&this.removeTrack(i)})})}}function pO(e){if(typeof e=="object"&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=r=>{r.streams.forEach(i=>{var o;if(this._remoteStreams||(this._remoteStreams=[]),Z(o=this._remoteStreams).call(o,i))return;this._remoteStreams.push(i);const s=new Event("addstream");s.stream=i,this.dispatchEvent(s)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const n=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(i=>{if(n._remoteStreams||(n._remoteStreams=[]),n._remoteStreams.indexOf(i)>=0)return;n._remoteStreams.push(i);const o=new Event("addstream");o.stream=i,n.dispatchEvent(o)})}),t.apply(n,arguments)}}}function fO(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,r=t.createAnswer,i=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(l,u){const h=arguments.length>=2?arguments[2]:arguments[0],f=n.apply(this,[h]);return u?(f.then(l,u),se.resolve()):f},t.createAnswer=function(l,u){const h=arguments.length>=2?arguments[2]:arguments[0],f=r.apply(this,[h]);return u?(f.then(l,u),se.resolve()):f};let c=function(l,u,h){const f=i.apply(this,[l]);return h?(f.then(u,h),se.resolve()):f};t.setLocalDescription=c,c=function(l,u,h){const f=o.apply(this,[l]);return h?(f.then(u,h),se.resolve()):f},t.setRemoteDescription=c,c=function(l,u,h){const f=s.apply(this,[l]);return h?(f.then(u,h),se.resolve()):f},t.addIceCandidate=c}function _O(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const n=t.mediaDevices,r=n.getUserMedia.bind(n);t.mediaDevices.getUserMedia=i=>r(mO(i))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(n,r,i){t.mediaDevices.getUserMedia(n).then(r,i)}).bind(t))}function mO(e){return e&&e.video!==void 0?Object.assign({},e,{video:Gb(e.video)}):e}function EO(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(n,r){if(n&&n.iceServers){const i=[];for(let o=0;o<n.iceServers.length;o++){let s=n.iceServers[o];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(ST("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,i.push(s)):i.push(n.iceServers[o])}n.iceServers=i}return new t(n,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function gO(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function SO(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(n){if(n){n.offerToReceiveAudio!==void 0&&(n.offerToReceiveAudio=!!n.offerToReceiveAudio);const r=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");n.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):n.offerToReceiveAudio!==!0||r||this.addTransceiver("audio",{direction:"recvonly"}),n.offerToReceiveVideo!==void 0&&(n.offerToReceiveVideo=!!n.offerToReceiveVideo);const i=this.getTransceivers().find(o=>o.receiver.track.kind==="video");n.offerToReceiveVideo===!1&&i?i.direction==="sendrecv"?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":i.direction==="recvonly"&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):n.offerToReceiveVideo!==!0||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function TO(e){typeof e!="object"||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var vO=Object.freeze({__proto__:null,shimAudioContext:TO,shimCallbacksAPI:fO,shimConstraints:mO,shimCreateOfferLegacy:SO,shimGetUserMedia:_O,shimLocalStreamsAPI:hO,shimRTCIceServerUrls:EO,shimRemoteStreamsAPI:pO,shimTrackEventTransceiver:gO}),RO=`	
\v\f\r \u2028\u2029\uFEFF`,UK=is,xK=Zr,yT=RO,yO=oe("".replace),VK=RegExp("^["+yT+"]+"),FK=RegExp("(^|[^"+yT+"])["+yT+"]+$"),BK=function(e){return function(t){var n=xK(UK(t));return 1&e&&(n=yO(n,VK,"")),2&e&&(n=yO(n,FK,"$1")),n}},jK={trim:BK(3)},GK=oA.PROPER,WK=C,CO=RO,HK=jK.trim;ft({target:"String",proto:!0,forced:function(e){return WK(function(){return!!CO[e]()||""[e]()!==""||GK&&CO[e].name!==e})}("trim")},{trim:function(){return HK(this)}});var KK=Ni("String","trim"),YK=re,zK=KK,CT=String.prototype,qK=function(e){var t=e.trim;return typeof e=="string"||e===CT||YK(CT,e)&&t===CT.trim?zK:t},_r=S(qK),IO={exports:{}};(function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(n){return n.trim().split(`
`).map(r=>r.trim())},t.splitSections=function(n){return n.split(`
m=`).map((r,i)=>(i>0?"m="+r:r).trim()+`\r
`)},t.getDescription=function(n){const r=t.splitSections(n);return r&&r[0]},t.getMediaSections=function(n){const r=t.splitSections(n);return r.shift(),r},t.matchPrefix=function(n,r){return t.splitLines(n).filter(i=>i.indexOf(r)===0)},t.parseCandidate=function(n){let r;r=n.indexOf("a=candidate:")===0?n.substring(12).split(" "):n.substring(10).split(" ");const i={foundation:r[0],component:{1:"rtp",2:"rtcp"}[r[1]]||r[1],protocol:r[2].toLowerCase(),priority:parseInt(r[3],10),ip:r[4],address:r[4],port:parseInt(r[5],10),type:r[7]};for(let o=8;o<r.length;o+=2)switch(r[o]){case"raddr":i.relatedAddress=r[o+1];break;case"rport":i.relatedPort=parseInt(r[o+1],10);break;case"tcptype":i.tcpType=r[o+1];break;case"ufrag":i.ufrag=r[o+1],i.usernameFragment=r[o+1];break;default:i[r[o]]===void 0&&(i[r[o]]=r[o+1])}return i},t.writeCandidate=function(n){const r=[];r.push(n.foundation);const i=n.component;i==="rtp"?r.push(1):i==="rtcp"?r.push(2):r.push(i),r.push(n.protocol.toUpperCase()),r.push(n.priority),r.push(n.address||n.ip),r.push(n.port);const o=n.type;return r.push("typ"),r.push(o),o!=="host"&&n.relatedAddress&&n.relatedPort&&(r.push("raddr"),r.push(n.relatedAddress),r.push("rport"),r.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(r.push("tcptype"),r.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(r.push("ufrag"),r.push(n.usernameFragment||n.ufrag)),"candidate:"+r.join(" ")},t.parseIceOptions=function(n){return n.substring(14).split(" ")},t.parseRtpMap=function(n){let r=n.substring(9).split(" ");const i={payloadType:parseInt(r.shift(),10)};return r=r[0].split("/"),i.name=r[0],i.clockRate=parseInt(r[1],10),i.channels=r.length===3?parseInt(r[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(n){let r=n.payloadType;n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType);const i=n.channels||n.numChannels||1;return"a=rtpmap:"+r+" "+n.name+"/"+n.clockRate+(i!==1?"/"+i:"")+`\r
`},t.parseExtmap=function(n){const r=n.substring(9).split(" ");return{id:parseInt(r[0],10),direction:r[0].indexOf("/")>0?r[0].split("/")[1]:"sendrecv",uri:r[1],attributes:r.slice(2).join(" ")}},t.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},t.parseFmtp=function(n){const r={};let i;const o=n.substring(n.indexOf(" ")+1).split(";");for(let s=0;s<o.length;s++)i=o[s].trim().split("="),r[i[0].trim()]=i[1];return r},t.writeFmtp=function(n){let r="",i=n.payloadType;if(n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const o=[];Object.keys(n.parameters).forEach(s=>{n.parameters[s]!==void 0?o.push(s+"="+n.parameters[s]):o.push(s)}),r+="a=fmtp:"+i+" "+o.join(";")+`\r
`}return r},t.parseRtcpFb=function(n){const r=n.substring(n.indexOf(" ")+1).split(" ");return{type:r.shift(),parameter:r.join(" ")}},t.writeRtcpFb=function(n){let r="",i=n.payloadType;return n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(o=>{r+="a=rtcp-fb:"+i+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),r},t.parseSsrcMedia=function(n){const r=n.indexOf(" "),i={ssrc:parseInt(n.substring(7,r),10)},o=n.indexOf(":",r);return o>-1?(i.attribute=n.substring(r+1,o),i.value=n.substring(o+1)):i.attribute=n.substring(r+1),i},t.parseSsrcGroup=function(n){const r=n.substring(13).split(" ");return{semantics:r.shift(),ssrcs:r.map(i=>parseInt(i,10))}},t.getMid=function(n){const r=t.matchPrefix(n,"a=mid:")[0];if(r)return r.substring(6)},t.parseFingerprint=function(n){const r=n.substring(14).split(" ");return{algorithm:r[0].toLowerCase(),value:r[1].toUpperCase()}},t.getDtlsParameters=function(n,r){return{role:"auto",fingerprints:t.matchPrefix(n+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(n,r){let i="a=setup:"+r+`\r
`;return n.fingerprints.forEach(o=>{i+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),i},t.parseCryptoLine=function(n){const r=n.substring(9).split(" ");return{tag:parseInt(r[0],10),cryptoSuite:r[1],keyParams:r[2],sessionParams:r.slice(3)}},t.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?t.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;const r=n.substring(7).split("|");return{keyMethod:"inline",keySalt:r[0],lifeTime:r[1],mkiValue:r[2]?r[2].split(":")[0]:void 0,mkiLength:r[2]?r[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},t.getCryptoParameters=function(n,r){return t.matchPrefix(n+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(n,r){const i=t.matchPrefix(n+r,"a=ice-ufrag:")[0],o=t.matchPrefix(n+r,"a=ice-pwd:")[0];return i&&o?{usernameFragment:i.substring(12),password:o.substring(10)}:null},t.writeIceParameters=function(n){let r="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(r+=`a=ice-lite\r
`),r},t.parseRtpParameters=function(n){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(n)[0].split(" ");r.profile=i[2];for(let s=3;s<i.length;s++){const c=i[s],l=t.matchPrefix(n,"a=rtpmap:"+c+" ")[0];if(l){const u=t.parseRtpMap(l),h=t.matchPrefix(n,"a=fmtp:"+c+" ");switch(u.parameters=h.length?t.parseFmtp(h[0]):{},u.rtcpFeedback=t.matchPrefix(n,"a=rtcp-fb:"+c+" ").map(t.parseRtcpFb),r.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(u.name.toUpperCase())}}}t.matchPrefix(n,"a=extmap:").forEach(s=>{r.headerExtensions.push(t.parseExtmap(s))});const o=t.matchPrefix(n,"a=rtcp-fb:* ").map(t.parseRtcpFb);return r.codecs.forEach(s=>{o.forEach(c=>{s.rtcpFeedback.find(l=>l.type===c.type&&l.parameter===c.parameter)||s.rtcpFeedback.push(c)})}),r},t.writeRtpDescription=function(n,r){let i="";i+="m="+n+" ",i+=r.codecs.length>0?"9":"0",i+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=r.codecs.map(s=>s.preferredPayloadType!==void 0?s.preferredPayloadType:s.payloadType).join(" ")+`\r
`,i+=`c=IN IP4 0.0.0.0\r
`,i+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,r.codecs.forEach(s=>{i+=t.writeRtpMap(s),i+=t.writeFmtp(s),i+=t.writeRtcpFb(s)});let o=0;return r.codecs.forEach(s=>{s.maxptime>o&&(o=s.maxptime)}),o>0&&(i+="a=maxptime:"+o+`\r
`),r.headerExtensions&&r.headerExtensions.forEach(s=>{i+=t.writeExtmap(s)}),i},t.parseRtpEncodingParameters=function(n){const r=[],i=t.parseRtpParameters(n),o=i.fecMechanisms.indexOf("RED")!==-1,s=i.fecMechanisms.indexOf("ULPFEC")!==-1,c=t.matchPrefix(n,"a=ssrc:").map(_=>t.parseSsrcMedia(_)).filter(_=>_.attribute==="cname"),l=c.length>0&&c[0].ssrc;let u;const h=t.matchPrefix(n,"a=ssrc-group:FID").map(_=>_.substring(17).split(" ").map(E=>parseInt(E,10)));h.length>0&&h[0].length>1&&h[0][0]===l&&(u=h[0][1]),i.codecs.forEach(_=>{if(_.name.toUpperCase()==="RTX"&&_.parameters.apt){let E={ssrc:l,codecPayloadType:parseInt(_.parameters.apt,10)};l&&u&&(E.rtx={ssrc:u}),r.push(E),o&&(E=JSON.parse(JSON.stringify(E)),E.fec={ssrc:l,mechanism:s?"red+ulpfec":"red"},r.push(E))}}),r.length===0&&l&&r.push({ssrc:l});let f=t.matchPrefix(n,"b=");return f.length&&(f=f[0].indexOf("b=TIAS:")===0?parseInt(f[0].substring(7),10):f[0].indexOf("b=AS:")===0?1e3*parseInt(f[0].substring(5),10)*.95-16e3:void 0,r.forEach(_=>{_.maxBitrate=f})),r},t.parseRtcpParameters=function(n){const r={},i=t.matchPrefix(n,"a=ssrc:").map(c=>t.parseSsrcMedia(c)).filter(c=>c.attribute==="cname")[0];i&&(r.cname=i.value,r.ssrc=i.ssrc);const o=t.matchPrefix(n,"a=rtcp-rsize");r.reducedSize=o.length>0,r.compound=o.length===0;const s=t.matchPrefix(n,"a=rtcp-mux");return r.mux=s.length>0,r},t.writeRtcpParameters=function(n){let r="";return n.reducedSize&&(r+=`a=rtcp-rsize\r
`),n.mux&&(r+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(r+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),r},t.parseMsid=function(n){let r;const i=t.matchPrefix(n,"a=msid:");if(i.length===1)return r=i[0].substring(7).split(" "),{stream:r[0],track:r[1]};const o=t.matchPrefix(n,"a=ssrc:").map(s=>t.parseSsrcMedia(s)).filter(s=>s.attribute==="msid");return o.length>0?(r=o[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},t.parseSctpDescription=function(n){const r=t.parseMLine(n),i=t.matchPrefix(n,"a=max-message-size:");let o;i.length>0&&(o=parseInt(i[0].substring(19),10)),isNaN(o)&&(o=65536);const s=t.matchPrefix(n,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:r.fmt,maxMessageSize:o};const c=t.matchPrefix(n,"a=sctpmap:");if(c.length>0){const l=c[0].substring(10).split(" ");return{port:parseInt(l[0],10),protocol:l[1],maxMessageSize:o}}},t.writeSctpDescription=function(n,r){let i=[];return i=n.protocol!=="DTLS/SCTP"?["m="+n.kind+" 9 "+n.protocol+" "+r.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+r.port+`\r
`]:["m="+n.kind+" 9 "+n.protocol+" "+r.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+r.port+" "+r.protocol+` 65535\r
`],r.maxMessageSize!==void 0&&i.push("a=max-message-size:"+r.maxMessageSize+`\r
`),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(n,r,i){let o;const s=r!==void 0?r:2;return o=n||t.generateSessionId(),`v=0\r
o=`+(i||"thisisadapterortc")+" "+o+" "+s+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(n,r){const i=t.splitLines(n);for(let o=0;o<i.length;o++)switch(i[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[o].substring(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(n){return t.splitLines(n)[0].split(" ")[0].substring(2)},t.isRejected=function(n){return n.split(" ",2)[1]==="0"},t.parseMLine=function(n){const r=t.splitLines(n)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(n){const r=t.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;const r=t.splitLines(n);for(let i=0;i<r.length;i++)if(r[i].length<2||r[i].charAt(1)!=="=")return!1;return!0},e.exports=t})(IO);var wO=IO.exports,zd=S(wO),XK=p({__proto__:null,default:zd},[wO]);function Yf(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(n){if(typeof n=="object"&&n.candidate&&n.candidate.indexOf("a=")===0&&((n=JSON.parse(JSON.stringify(n))).candidate=n.candidate.substr(2)),n.candidate&&n.candidate.length){const r=new t(n),i=zd.parseCandidate(n.candidate),o=Object.assign(r,i);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new t(n)},e.RTCIceCandidate.prototype=t.prototype,Rc(e,"icecandidate",n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new e.RTCIceCandidate(n.candidate),writable:"false"}),n))}function IT(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||Rc(e,"icecandidate",t=>{if(t.candidate){const n=zd.parseCandidate(t.candidate.candidate);n.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return t})}function zf(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});const n=function(c){if(!c||!c.sdp)return!1;const l=zd.splitSections(c.sdp);return l.shift(),l.some(u=>{const h=zd.parseMLine(u);return h&&h.kind==="application"&&h.protocol.indexOf("SCTP")!==-1})},r=function(c){const l=c.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(l===null||l.length<2)return-1;const u=parseInt(l[1],10);return u!=u?-1:u},i=function(c){let l=65536;return t.browser==="firefox"&&(l=t.version<57?c===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637),l},o=function(c,l){let u=65536;t.browser==="firefox"&&t.version===57&&(u=65535);const h=zd.matchPrefix(c.sdp,"a=max-message-size:");return h.length>0?u=parseInt(h[0].substr(19),10):t.browser==="firefox"&&l!==-1&&(u=2147483637),u},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const c=r(arguments[0]),l=i(c),u=o(arguments[0],c);let h;h=l===0&&u===0?Number.POSITIVE_INFINITY:l===0||u===0?Math.max(l,u):Math.min(l,u);const f={};Object.defineProperty(f,"maxMessageSize",{get:()=>h}),this._sctp=f}return s.apply(this,arguments)}}function qf(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(r,i){const o=r.send;r.send=function(){const s=arguments[0],c=s.length||s.size||s.byteLength;if(r.readyState==="open"&&i.sctp&&c>i.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+i.sctp.maxMessageSize+" bytes)");return o.apply(r,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const r=n.apply(this,arguments);return t(r,this),r},Rc(e,"datachannel",r=>(t(r.channel,r.target),r))}function wT(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(n=>{const r=t[n];t[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=i=>{const o=i.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;const s=new Event("connectionstatechange",i);o.dispatchEvent(s)}return i},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function AT(e,t){if(!e.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const i=r.sdp.split(`
`).filter(o=>_r(o).call(o)!=="a=extmap-allow-mixed").join(`
`);e.RTCSessionDescription&&r instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:r.type,sdp:i}):r.sdp=i}return n.apply(this,arguments)}}function Xf(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.addIceCandidate;n&&n.length!==0&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?se.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),se.resolve())})}function Jf(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const n=e.RTCPeerConnection.prototype.setLocalDescription;n&&n.length!==0&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return n.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer"}return r.sdp||r.type!=="offer"&&r.type!=="answer"?n.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(i=>n.apply(this,[i]))})}var JK=Object.freeze({__proto__:null,removeExtmapAllowMixed:AT,shimAddIceCandidateNullOrEmpty:Xf,shimConnectionState:wT,shimMaxMessageSize:zf,shimParameterlessSetLocalDescription:Jf,shimRTCIceCandidate:Yf,shimRTCIceCandidateRelayProtocol:IT,shimSendThrowTypeError:qf});(function(){let{window:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const n=Bb,r=function(o){const s={browser:null,version:null};if(o===void 0||!o.navigator)return s.browser="Not a browser.",s;const{navigator:c}=o;if(c.mozGetUserMedia)s.browser="firefox",s.version=Kf(c.userAgent,/Firefox\/(\d+)\./,1);else if(c.webkitGetUserMedia||o.isSecureContext===!1&&o.webkitRTCPeerConnection)s.browser="chrome",s.version=Kf(c.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!o.RTCPeerConnection||!c.userAgent.match(/AppleWebKit\/(\d+)\./))return s.browser="Not a supported browser.",s;s.browser="safari",s.version=Kf(c.userAgent,/AppleWebKit\/(\d+)\./,1),s.supportsUnifiedPlan=o.RTCRtpTransceiver&&"currentDirection"in o.RTCRtpTransceiver.prototype}return s}(e),i={browserDetails:r,commonShim:JK,extractVersion:Kf,disableLog:kK,disableWarnings:MK,sdp:XK};switch(r.browser){case"chrome":if(!eO||!vT||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),i;if(r.version===null)return n("Chrome shim can not determine version, not shimming."),i;n("adapter.js shimming chrome."),i.browserShim=eO,Xf(e,r),Jf(e),Kb(e,r),Yb(e),vT(e,r),zb(e),Zb(e,r),qb(e),Xb(e),Jb(e),$b(e,r),Yf(e),IT(e),wT(e),zf(e,r),qf(e),AT(e,r);break;case"firefox":if(!uO||!RT||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),i;n("adapter.js shimming firefox."),i.browserShim=uO,Xf(e,r),Jf(e),tO(e,r),RT(e,r),nO(e),oO(e),rO(e),iO(e),sO(e),aO(e),cO(e),dO(e),lO(e),Yf(e),wT(e),zf(e,r),qf(e);break;case"safari":if(!vO||!t.shimSafari)return n("Safari shim is not included in this adapter release."),i;n("adapter.js shimming safari."),i.browserShim=vO,Xf(e,r),Jf(e),EO(e),SO(e),fO(e),hO(e),pO(e),gO(e),_O(e),TO(e),Yf(e),IT(e),zf(e,r),qf(e),AT(e,r);break;default:n("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var QK=C,AO=fe.RegExp,ZK=!QK(function(){var e=!0;try{AO(".","d")}catch{e=!1}var t={},n="",r=e?"dgimsy":"gimsy",i=function(c,l){Object.defineProperty(t,c,{get:function(){return n+=l,!0}})},o={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var s in e&&(o.hasIndices="d"),o)i(s,o[s]);return Object.getOwnPropertyDescriptor(AO.prototype,"flags").get.call(t)!==r||n!==r}),$K=Qr,eY=$t,tY=ir,nY=re,bO={correct:ZK},rY=function(){var e=$K(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},iY=RegExp.prototype,bT=bO.correct?function(e){return e.flags}:function(e){return bO.correct||!nY(iY,e)||tY(e,"flags")?e.flags:eY(rY,e)},OT=oe,oY=Math.floor,NT=OT("".charAt),sY=OT("".replace),DT=OT("".slice),aY=/\$([$&'`]|\d{1,2})/g,cY=ft,dY=$t,PT=oe,OO=is,lY=qe,uY=yn,hY=kg,qd=Zr,pY=Du,fY=bT,_Y=function(e,t,n,r,i,o){var s=n+e.length,c=r.length,l=aY;return sY(o,l,function(u,h){var f;switch(NT(h,0)){case"$":return"$";case"&":return e;case"`":return DT(t,0,n);case"'":return DT(t,s);case"<":f=i[DT(h,1,-1)];break;default:var _=+h;if(_===0)return u;if(_>c){var E=oY(_/10);return E===0?u:E<=c?r[E-1]===void 0?NT(h,1):r[E-1]+NT(h,1):u}f=r[_-1]}return f===void 0?"":f})},mY=un("replace"),EY=TypeError,LT=PT("".indexOf),gY=PT("".replace),NO=PT("".slice),SY=Math.max;cY({target:"String",proto:!0},{replaceAll:function(e,t){var n,r,i,o,s,c,l,u,h,f,_=OO(this),E=0,I="";if(uY(e)){if((n=hY(e))&&(r=qd(OO(fY(e))),!~LT(r,"g")))throw new EY("`.replaceAll` does not allow non-global regexes");if(i=pY(e,mY))return dY(i,e,_,t);if(n)return gY(qd(_),e,t)}for(o=qd(_),s=qd(e),(c=lY(t))||(t=qd(t)),l=s.length,u=SY(1,l),h=LT(o,s);h!==-1;)f=c?qd(t(s,h,o)):_Y(s,o,h,[],void 0,t),I+=NO(o,E,h)+f,E=h+l,h=h+u>o.length?-1:LT(o,s,h+u);return E<o.length&&(I+=NO(o,E)),I}});var TY=Ni("String","replaceAll"),vY=re,RY=TY,kT=String.prototype,yY=function(e){var t=e.replaceAll;return typeof e=="string"||e===kT||vY(kT,e)&&t===kT.replaceAll?RY:t},CY=S(yY),MT=fe;ft({global:!0,forced:MT.globalThis!==MT},{globalThis:MT});var DO=S(fe),UT={exports:{}};(function(e,t){(function(n,r){var i="function",o="undefined",s="object",c="string",l="major",u="model",h="name",f="type",_="vendor",E="version",I="architecture",v="console",R="mobile",A="tablet",O="smarttv",P="wearable",M="embedded",U="Amazon",L="Apple",V="ASUS",H="BlackBerry",q="Browser",de="Chrome",Ne="Firefox",Ae="Google",Ge="Honor",xe="Huawei",ct="LG",jt="Microsoft",Y="Motorola",ne="Nvidia",he="OnePlus",z="Opera",T="OPPO",D="Samsung",k="Sharp",ee="Sony",Le="Xiaomi",Dt="Zebra",On="Facebook",Gi="Chromium OS",Fa="Mac OS",Jm=" Browser",Wl=function(fn){for(var Sn={},xt=0;xt<fn.length;xt++)Sn[fn[xt].toUpperCase()]=fn[xt];return Sn},Qm=function(fn,Sn){return typeof fn===c&&od(Sn).indexOf(od(fn))!==-1},od=function(fn){return fn.toLowerCase()},np=function(fn,Sn){if(typeof fn===c)return fn=fn.replace(/^\s\s*/,""),typeof Sn===o?fn:fn.substring(0,500)},sd=function(fn,Sn){for(var xt,Yr,Xo,on,Xs,it,Jo=0;Jo<Sn.length&&!Xs;){var ad=Sn[Jo],As=Sn[Jo+1];for(xt=Yr=0;xt<ad.length&&!Xs&&ad[xt];)if(Xs=ad[xt++].exec(fn))for(Xo=0;Xo<As.length;Xo++)it=Xs[++Yr],typeof(on=As[Xo])===s&&on.length>0?on.length===2?typeof on[1]==i?this[on[0]]=on[1].call(this,it):this[on[0]]=on[1]:on.length===3?typeof on[1]!==i||on[1].exec&&on[1].test?this[on[0]]=it?it.replace(on[1],on[2]):r:this[on[0]]=it?on[1].call(this,it,on[2]):r:on.length===4&&(this[on[0]]=it?on[3].call(this,it.replace(on[1],on[2])):r):this[on]=it||r;Jo+=2}},Ba=function(fn,Sn){for(var xt in Sn)if(typeof Sn[xt]===s&&Sn[xt].length>0){for(var Yr=0;Yr<Sn[xt].length;Yr++)if(Qm(Sn[xt][Yr],fn))return xt==="?"?r:xt}else if(Qm(Sn[xt],fn))return xt==="?"?r:xt;return Sn.hasOwnProperty("*")?Sn["*"]:fn},Tx={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},vx={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[E,[h,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[E,[h,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[h,E],[/opios[\/ ]+([\w\.]+)/i],[E,[h,z+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[E,[h,z+" GX"]],[/\bopr\/([\w\.]+)/i],[E,[h,z]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[E,[h,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[E,[h,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[h,E],[/quark(?:pc)?\/([-\w\.]+)/i],[E,[h,"Quark"]],[/\bddg\/([\w\.]+)/i],[E,[h,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[E,[h,"UC"+q]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[E,[h,"WeChat"]],[/konqueror\/([\w\.]+)/i],[E,[h,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[E,[h,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[E,[h,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[E,[h,"Smart Lenovo "+q]],[/(avast|avg)\/([\w\.]+)/i],[[h,/(.+)/,"$1 Secure "+q],E],[/\bfocus\/([\w\.]+)/i],[E,[h,Ne+" Focus"]],[/\bopt\/([\w\.]+)/i],[E,[h,z+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[E,[h,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[E,[h,"Dolphin"]],[/coast\/([\w\.]+)/i],[E,[h,z+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[E,[h,"MIUI"+Jm]],[/fxios\/([\w\.-]+)/i],[E,[h,Ne]],[/\bqihoobrowser\/?([\w\.]*)/i],[E,[h,"360"]],[/\b(qq)\/([\w\.]+)/i],[[h,/(.+)/,"$1Browser"],E],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[h,/(.+)/,"$1"+Jm],E],[/samsungbrowser\/([\w\.]+)/i],[E,[h,D+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[E,[h,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[h,"Sogou Mobile"],E],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[h,E],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[h],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[E,h],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[h,On],E],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/(daum)apps[\/ ]([\w\.]+)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[h,E],[/\bgsa\/([\w\.]+) .*safari\//i],[E,[h,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[E,[h,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[E,[h,de+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[h,de+" WebView"],E],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[E,[h,"Android "+q]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[h,E],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[E,[h,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[E,h],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[h,[E,Ba,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[h,E],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[h,"Netscape"],E],[/(wolvic|librewolf)\/([\w\.]+)/i],[h,E],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[E,[h,Ne+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(amaya|dillo|doris|icab|ladybird|lynx|mosaic|netsurf|obigo|polaris|w3m|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/\b(links) \(([\w\.]+)/i],[h,[E,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[h,[E,/master.|lts./,""]]],cpu:[[/\b((amd|x|x86[-_]?|wow|win)64)\b/i],[[I,"amd64"]],[/(ia32(?=;))/i,/\b((i[346]|x)86)(pc)?\b/i],[[I,"ia32"]],[/\b(aarch64|arm(v?[89]e?l?|_?64))\b/i],[[I,"arm64"]],[/\b(arm(v[67])?ht?n?[fl]p?)\b/i],[[I,"armhf"]],[/( (ce|mobile); ppc;|\/[\w\.]+arm\b)/i],[[I,"arm"]],[/((ppc|powerpc)(64)?)( mac|;|\))/i],[[I,/ower/,"",od]],[/ sun4\w[;\)]/i],[[I,"sparc"]],[/\b(avr32|ia64(?=;)|68k(?=\))|\barm(?=v([1-7]|[5-7]1)l?|;|eabi)|(irix|mips|sparc)(64)?\b|pa-risc)/i],[[I,od]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[u,[_,D],[f,A]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[u,[_,D],[f,R]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[u,[_,L],[f,R]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[u,[_,L],[f,A]],[/(macintosh);/i],[u,[_,L]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[u,[_,k],[f,R]],[/\b((?:brt|eln|hey2?|gdi|jdn)-a?[lnw]09|(?:ag[rm]3?|jdn2|kob2)-a?[lw]0[09]hn)(?: bui|\)|;)/i],[u,[_,Ge],[f,A]],[/honor([-\w ]+)[;\)]/i],[u,[_,Ge],[f,R]],[/\b((?:ag[rs][2356]?k?|bah[234]?|bg[2o]|bt[kv]|cmr|cpn|db[ry]2?|jdn2|got|kob2?k?|mon|pce|scm|sht?|[tw]gr|vrd)-[ad]?[lw][0125][09]b?|605hw|bg2-u03|(?:gem|fdr|m2|ple|t1)-[7a]0[1-4][lu]|t1-a2[13][lw]|mediapad[\w\. ]*(?= bui|\)))\b(?!.+d\/s)/i],[u,[_,xe],[f,A]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[u,[_,xe],[f,R]],[/oid[^\)]+; (2[\dbc]{4}(182|283|rp\w{2})[cgl]|m2105k81a?c)(?: bui|\))/i,/\b((?:red)?mi[-_ ]?pad[\w- ]*)(?: bui|\))/i],[[u,/_/g," "],[_,Le],[f,A]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i,/ ([\w ]+) miui\/v?\d/i],[[u,/_/g," "],[_,Le],[f,R]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[u,[_,T],[f,R]],[/\b(opd2(\d{3}a?))(?: bui|\))/i],[u,[_,Ba,{OnePlus:["304","403","203"],"*":T}],[f,A]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[u,[_,"Vivo"],[f,R]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[u,[_,"Realme"],[f,R]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto(?! 360)[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[u,[_,Y],[f,R]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[u,[_,Y],[f,A]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[u,[_,ct],[f,A]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv|watch)\w+)/i,/\blg-?([\d\w]+) bui/i],[u,[_,ct],[f,R]],[/(ideatab[-\w ]+|602lv|d-42a|a101lv|a2109a|a3500-hv|s[56]000|pb-6505[my]|tb-?x?\d{3,4}(?:f[cu]|xu|[av])|yt\d?-[jx]?\d+[lfmx])( bui|;|\)|\/)/i,/lenovo ?(b[68]0[08]0-?[hf]?|tab(?:[\w- ]+?)|tb[\w-]{6,7})( bui|;|\)|\/)/i],[u,[_,"Lenovo"],[f,A]],[/(nokia) (t[12][01])/i],[_,u,[f,A]],[/(?:maemo|nokia).*(n900|lumia \d+|rm-\d+)/i,/nokia[-_ ]?(([-\w\. ]*))/i],[[u,/_/g," "],[f,R],[_,"Nokia"]],[/(pixel (c|tablet))\b/i],[u,[_,Ae],[f,A]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[u,[_,Ae],[f,R]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[u,[_,ee],[f,R]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[u,"Xperia Tablet"],[_,ee],[f,A]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[u,[_,he],[f,R]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[u,[_,U],[f,A]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[u,/(.+)/g,"Fire Phone $1"],[_,U],[f,R]],[/(playbook);[-\w\),; ]+(rim)/i],[u,_,[f,A]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[u,[_,H],[f,R]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[u,[_,V],[f,A]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[u,[_,V],[f,R]],[/(nexus 9)/i],[u,[_,"HTC"],[f,A]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[_,[u,/_/g," "],[f,R]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[u,[_,"TCL"],[f,A]],[/(itel) ((\w+))/i],[[_,od],u,[f,Ba,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[u,[_,"Acer"],[f,A]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[u,[_,"Meizu"],[f,R]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[u,[_,"Ulefone"],[f,R]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[u,[_,"Energizer"],[f,R]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[u,[_,"Cat"],[f,R]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[u,[_,"Smartfren"],[f,R]],[/droid.+; (a(?:015|06[35]|142p?))/i],[u,[_,"Nothing"],[f,R]],[/; (x67 5g|tikeasy \w+|ac[1789]\d\w+)( b|\))/i,/archos ?(5|gamepad2?|([\w ]*[t1789]|hello) ?\d+[\w ]*)( b|\))/i],[u,[_,"Archos"],[f,A]],[/archos ([\w ]+)( b|\))/i,/; (ac[3-6]\d\w{2,8})( b|\))/i],[u,[_,"Archos"],[f,R]],[/(imo) (tab \w+)/i,/(infinix) (x1101b?)/i],[_,u,[f,A]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus(?! zenw)|dell|jolla|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (hmd|imo) ([\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w ]+?)(?: bui|\)|\/)/i,/(oppo) ?([\w ]+) bui/i],[_,u,[f,R]],[/(kobo)\s(ereader|touch)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[_,u,[f,A]],[/(surface duo)/i],[u,[_,jt],[f,A]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[u,[_,"Fairphone"],[f,R]],[/(u304aa)/i],[u,[_,"AT&T"],[f,R]],[/\bsie-(\w*)/i],[u,[_,"Siemens"],[f,R]],[/\b(rct\w+) b/i],[u,[_,"RCA"],[f,A]],[/\b(venue[\d ]{2,7}) b/i],[u,[_,"Dell"],[f,A]],[/\b(q(?:mv|ta)\w+) b/i],[u,[_,"Verizon"],[f,A]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[u,[_,"Barnes & Noble"],[f,A]],[/\b(tm\d{3}\w+) b/i],[u,[_,"NuVision"],[f,A]],[/\b(k88) b/i],[u,[_,"ZTE"],[f,A]],[/\b(nx\d{3}j) b/i],[u,[_,"ZTE"],[f,R]],[/\b(gen\d{3}) b.+49h/i],[u,[_,"Swiss"],[f,R]],[/\b(zur\d{3}) b/i],[u,[_,"Swiss"],[f,A]],[/\b((zeki)?tb.*\b) b/i],[u,[_,"Zeki"],[f,A]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[_,"Dragon Touch"],u,[f,A]],[/\b(ns-?\w{0,9}) b/i],[u,[_,"Insignia"],[f,A]],[/\b((nxa|next)-?\w{0,9}) b/i],[u,[_,"NextBook"],[f,A]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[_,"Voice"],u,[f,R]],[/\b(lvtel\-)?(v1[12]) b/i],[[_,"LvTel"],u,[f,R]],[/\b(ph-1) /i],[u,[_,"Essential"],[f,R]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[u,[_,"Envizen"],[f,A]],[/\b(trio[-\w\. ]+) b/i],[u,[_,"MachSpeed"],[f,A]],[/\btu_(1491) b/i],[u,[_,"Rotor"],[f,A]],[/((?:tegranote|shield t(?!.+d tv))[\w- ]*?)(?: b|\))/i],[u,[_,ne],[f,A]],[/(sprint) (\w+)/i],[_,u,[f,R]],[/(kin\.[onetw]{3})/i],[[u,/\./g," "],[_,jt],[f,R]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[u,[_,Dt],[f,A]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[u,[_,Dt],[f,R]],[/smart-tv.+(samsung)/i],[_,[f,O]],[/hbbtv.+maple;(\d+)/i],[[u,/^/,"SmartTV"],[_,D],[f,O]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[_,ct],[f,O]],[/(apple) ?tv/i],[_,[u,L+" TV"],[f,O]],[/crkey/i],[[u,de+"cast"],[_,Ae],[f,O]],[/droid.+aft(\w+)( bui|\))/i],[u,[_,U],[f,O]],[/(shield \w+ tv)/i],[u,[_,ne],[f,O]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[u,[_,k],[f,O]],[/(bravia[\w ]+)( bui|\))/i],[u,[_,ee],[f,O]],[/(mi(tv|box)-?\w+) bui/i],[u,[_,Le],[f,O]],[/Hbbtv.*(technisat) (.*);/i],[_,u,[f,O]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[_,np],[u,np],[f,O]],[/droid.+; ([\w- ]+) (?:android tv|smart[- ]?tv)/i],[u,[f,O]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[f,O]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[_,u,[f,v]],[/droid.+; (shield)( bui|\))/i],[u,[_,ne],[f,v]],[/(playstation \w+)/i],[u,[_,ee],[f,v]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[u,[_,jt],[f,v]],[/\b(sm-[lr]\d\d[0156][fnuw]?s?|gear live)\b/i],[u,[_,D],[f,P]],[/((pebble))app/i,/(asus|google|lg|oppo) ((pixel |zen)?watch[\w ]*)( bui|\))/i],[_,u,[f,P]],[/(ow(?:19|20)?we?[1-3]{1,3})/i],[u,[_,T],[f,P]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[u,[_,L],[f,P]],[/(opwwe\d{3})/i],[u,[_,he],[f,P]],[/(moto 360)/i],[u,[_,Y],[f,P]],[/(smartwatch 3)/i],[u,[_,ee],[f,P]],[/(g watch r)/i],[u,[_,ct],[f,P]],[/droid.+; (wt63?0{2,3})\)/i],[u,[_,Dt],[f,P]],[/droid.+; (glass) \d/i],[u,[_,Ae],[f,P]],[/(pico) (4|neo3(?: link|pro)?)/i],[_,u,[f,P]],[/; (quest( \d| pro)?)/i],[u,[_,On],[f,P]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[_,[f,M]],[/(aeobc)\b/i],[u,[_,U],[f,M]],[/(homepod).+mac os/i],[u,[_,L],[f,M]],[/windows iot/i],[[f,M]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[u,[f,R]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[u,[f,A]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[f,A]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[f,R]],[/droid .+?; ([\w\. -]+)( bui|\))/i],[u,[_,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[E,[h,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[h,E],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[E,[h,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[h,E],[/ladybird\//i],[[h,"LibWeb"]],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[E,h]],os:[[/microsoft (windows) (vista|xp)/i],[h,E],[/(windows (?:phone(?: os)?|mobile|iot))[\/ ]?([\d\.\w ]*)/i],[h,[E,Ba,Tx]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[E,Ba,Tx],[h,"Windows"]],[/[adehimnop]{4,7}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[E,/_/g,"."],[h,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[h,Fa],[E,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[E,h],[/(ubuntu) ([\w\.]+) like android/i],[[h,/(.+)/,"$1 Touch"],E],[/(android|bada|blackberry|kaios|maemo|meego|openharmony|qnx|rim tablet os|sailfish|series40|symbian|tizen|webos)\w*[-\/; ]?([\d\.]*)/i],[h,E],[/\(bb(10);/i],[E,[h,H]],[/(?:symbian ?os|symbos|s60(?=;)|series ?60)[-\/ ]?([\w\.]*)/i],[E,[h,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[E,[h,Ne+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[E,[h,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[E,[h,"watchOS"]],[/crkey\/([\d\.]+)/i],[E,[h,de+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[h,Gi],E],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux)(?: arm\w*| x86\w*| ?)([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[h,E],[/(sunos) ?([\w\.\d]*)/i],[[h,"Solaris"],E],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[h,E]]},qo=function(fn,Sn){if(typeof fn===s&&(Sn=fn,fn=r),!(this instanceof qo))return new qo(fn,Sn).getResult();var xt=typeof n!==o&&n.navigator?n.navigator:r,Yr=fn||(xt&&xt.userAgent?xt.userAgent:""),Xo=xt&&xt.userAgentData?xt.userAgentData:r,on=Sn?function(it,Jo){var ad={};for(var As in it)Jo[As]&&Jo[As].length%2==0?ad[As]=Jo[As].concat(it[As]):ad[As]=it[As];return ad}(vx,Sn):vx,Xs=xt&&xt.userAgent==Yr;return this.getBrowser=function(){var it={};return it[h]=r,it[E]=r,sd.call(it,Yr,on.browser),it[l]=function(Jo){return typeof Jo===c?Jo.replace(/[^\d\.]/g,"").split(".")[0]:r}(it[E]),Xs&&xt&&xt.brave&&typeof xt.brave.isBrave==i&&(it[h]="Brave"),it},this.getCPU=function(){var it={};return it[I]=r,sd.call(it,Yr,on.cpu),it},this.getDevice=function(){var it={};return it[_]=r,it[u]=r,it[f]=r,sd.call(it,Yr,on.device),Xs&&!it[f]&&Xo&&Xo.mobile&&(it[f]=R),Xs&&it[u]=="Macintosh"&&xt&&typeof xt.standalone!==o&&xt.maxTouchPoints&&xt.maxTouchPoints>2&&(it[u]="iPad",it[f]=A),it},this.getEngine=function(){var it={};return it[h]=r,it[E]=r,sd.call(it,Yr,on.engine),it},this.getOS=function(){var it={};return it[h]=r,it[E]=r,sd.call(it,Yr,on.os),Xs&&!it[h]&&Xo&&Xo.platform&&Xo.platform!="Unknown"&&(it[h]=Xo.platform.replace(/chrome os/i,Gi).replace(/macos/i,Fa)),it},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return Yr},this.setUA=function(it){return Yr=typeof it===c&&it.length>500?np(it,500):it,this},this.setUA(Yr),this};qo.VERSION="0.7.41",qo.BROWSER=Wl([h,E,l]),qo.CPU=Wl([I]),qo.DEVICE=Wl([u,_,f,v,R,O,A,P,M]),qo.ENGINE=qo.OS=Wl([h,E]),e.exports&&(t=e.exports=qo),t.UAParser=qo;var Hl=typeof n!==o&&(n.jQuery||n.Zepto);if(Hl&&!Hl.ua){var Zm=new qo;Hl.ua=Zm.getResult(),Hl.ua.get=function(){return Zm.getUA()},Hl.ua.set=function(fn){Zm.setUA(fn);var Sn=Zm.getResult();for(var xt in Sn)Hl.ua[xt]=Sn[xt]}}})(typeof window=="object"?window:m)})(UT,UT.exports);var IY=S(UT.exports),PO=yf.clear;ft({global:!0,bind:!0,forced:fe.clearImmediate!==PO},{clearImmediate:PO});var LO=fe,wY=Q,AY=qe,bY=Vg,OY=Oi,NY=pa,DY=mc,PY=LO.Function,LY=/MSIE .\./.test(OY)||bY==="BUN"&&function(){var e=LO.Bun.version.split(".");return e.length<3||e[0]==="0"&&(e[1]<3||e[1]==="3"&&e[2]==="0")}(),kY=ft,kO=fe,MO=yf.set,MY=function(e,t){var n=1;return LY?function(r,i){var o=DY(arguments.length,1)>n,s=AY(r)?r:PY(r),c=o?NY(arguments,n):[],l=o?function(){wY(s,this,c)}:s;return e(l)}:e},UO=kO.setImmediate?MY(MO):MO;kY({global:!0,bind:!0,forced:kO.setImmediate!==UO},{setImmediate:UO});var xO=S(wr.setImmediate),UY=fe,xY=HA,VY=li,FY=mc,BY=At;ft({global:!0,dontCallGetSet:!0,forced:C(function(){return BY&&Object.getOwnPropertyDescriptor(UY,"queueMicrotask").value.length!==1})},{queueMicrotask:function(e){FY(arguments.length,1),xY(VY(e))}});var VO=S(wr.queueMicrotask);function FO(e,t){return function(){return e.apply(t,arguments)}}const{toString:jY}=Object.prototype,{getPrototypeOf:xT}=Object,{iterator:Qf,toStringTag:BO}=Symbol,Zf=(VT=Object.create(null),e=>{const t=jY.call(e);return VT[t]||(VT[t]=t.slice(8,-1).toLowerCase())});var VT;const No=e=>(e=e.toLowerCase(),t=>Zf(t)===e),$f=e=>t=>typeof t===e,{isArray:Xd}=Array,Jd=$f("undefined");function eh(e){return e!==null&&!Jd(e)&&e.constructor!==null&&!Jd(e.constructor)&&ui(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}const jO=No("ArrayBuffer"),GY=$f("string"),ui=$f("function"),GO=$f("number"),th=e=>e!==null&&typeof e=="object",e_=e=>{if(Zf(e)!=="object")return!1;const t=xT(e);return!(t!==null&&t!==Object.prototype&&Object.getPrototypeOf(t)!==null||BO in e||Qf in e)},WY=No("Date"),HY=No("File"),KY=No("Blob"),YY=No("FileList"),zY=No("URLSearchParams"),[qY,XY,JY,QY]=["ReadableStream","Request","Response","Headers"].map(No);function nh(e,t){let n,r,{allOwnKeys:i=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(e!=null)if(typeof e!="object"&&(e=[e]),Xd(e))for(n=0,r=e.length;n<r;n++)t.call(null,e[n],n,e);else{if(eh(e))return;const o=i?Object.getOwnPropertyNames(e):Object.keys(e),s=o.length;let c;for(n=0;n<s;n++)c=o[n],t.call(null,e[c],c,e)}}function WO(e,t){if(eh(e))return null;t=t.toLowerCase();const n=Object.keys(e);let r,i=n.length;for(;i-- >0;)if(r=n[i],t===r.toLowerCase())return r;return null}const yc=DO!==void 0?DO:typeof self<"u"?self:typeof window<"u"?window:$m,HO=e=>!Jd(e)&&e!==yc,ZY=(FT=typeof Uint8Array<"u"&&xT(Uint8Array),e=>FT&&e instanceof FT);var FT;const $Y=No("HTMLFormElement"),KO=(e=>{let{hasOwnProperty:t}=e;return(n,r)=>t.call(n,r)})(Object.prototype),ez=No("RegExp"),YO=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),r={};nh(n,(i,o)=>{let s;(s=t(i,o,e))!==!1&&(r[o]=s||i)}),Object.defineProperties(e,r)},tz=No("AsyncFunction"),zO=(qO=typeof xO=="function",XO=ui(yc.postMessage),qO?xO:XO?(BT="axios@".concat(Math.random()),t_=[],yc.addEventListener("message",e=>{let{source:t,data:n}=e;t===yc&&n===BT&&t_.length&&t_.shift()()},!1),e=>{t_.push(e),yc.postMessage(BT,"*")}):e=>setTimeout(e));var qO,XO,BT,t_;const nz=VO!==void 0?VO.bind(yc):typeof process<"u"&&process.nextTick||zO;var ce={isArray:Xd,isArrayBuffer:jO,isBuffer:eh,isFormData:e=>{let t;return e&&(typeof FormData=="function"&&e instanceof FormData||ui(e.append)&&((t=Zf(e))==="formdata"||t==="object"&&ui(e.toString)&&e.toString()==="[object FormData]"))},isArrayBufferView:function(e){let t;return t=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&jO(e.buffer),t},isString:GY,isNumber:GO,isBoolean:e=>e===!0||e===!1,isObject:th,isPlainObject:e_,isEmptyObject:e=>{if(!th(e)||eh(e))return!1;try{return Object.keys(e).length===0&&Object.getPrototypeOf(e)===Object.prototype}catch{return!1}},isReadableStream:qY,isRequest:XY,isResponse:JY,isHeaders:QY,isUndefined:Jd,isDate:WY,isFile:HY,isBlob:KY,isRegExp:ez,isFunction:ui,isStream:e=>th(e)&&ui(e.pipe),isURLSearchParams:zY,isTypedArray:ZY,isFileList:YY,forEach:nh,merge:function e(){const{caseless:t,skipUndefined:n}=HO(this)&&this||{},r={},i=(o,s)=>{const c=t&&WO(r,s)||s;e_(r[c])&&e_(o)?r[c]=e(r[c],o):e_(o)?r[c]=e({},o):Xd(o)?r[c]=o.slice():n&&Jd(o)||(r[c]=o)};for(let o=0,s=arguments.length;o<s;o++)arguments[o]&&nh(arguments[o],i);return r},extend:function(e,t,n){let{allOwnKeys:r}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return nh(t,(i,o)=>{n&&ui(i)?e[o]=FO(i,n):e[o]=i},{allOwnKeys:r}),e},trim:e=>_r(e)?_r(e).call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(e.charCodeAt(0)===65279&&(e=e.slice(1)),e),inherits:(e,t,n,r)=>{e.prototype=Object.create(t.prototype,r),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),n&&Object.assign(e.prototype,n)},toFlatObject:(e,t,n,r)=>{let i,o,s;const c={};if(t=t||{},e==null)return t;do{for(i=Object.getOwnPropertyNames(e),o=i.length;o-- >0;)s=i[o],r&&!r(s,e,t)||c[s]||(t[s]=e[s],c[s]=!0);e=n!==!1&&xT(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},kindOf:Zf,kindOfTest:No,endsWith:(e,t,n)=>{e=String(e),(n===void 0||n>e.length)&&(n=e.length),n-=t.length;const r=e.indexOf(t,n);return r!==-1&&r===n},toArray:e=>{if(!e)return null;if(Xd(e))return e;let t=e.length;if(!GO(t))return null;const n=new Array(t);for(;t-- >0;)n[t]=e[t];return n},forEachEntry:(e,t)=>{const n=(e&&e[Qf]).call(e);let r;for(;(r=n.next())&&!r.done;){const i=r.value;t.call(e,i[0],i[1])}},matchAll:(e,t)=>{let n;const r=[];for(;(n=e.exec(t))!==null;)r.push(n);return r},isHTMLForm:$Y,hasOwnProperty:KO,hasOwnProp:KO,reduceDescriptors:YO,freezeMethods:e=>{YO(e,(t,n)=>{if(ui(e)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const r=e[n];ui(r)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")}))})},toObjectSet:(e,t)=>{const n={},r=i=>{i.forEach(o=>{n[o]=!0})};return Xd(e)?r(e):r(String(e).split(t)),n},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,n,r){return n.toUpperCase()+r}),noop:()=>{},toFiniteNumber:(e,t)=>e!=null&&Number.isFinite(e=+e)?e:t,findKey:WO,global:yc,isContextDefined:HO,isSpecCompliantForm:function(e){return!!(e&&ui(e.append)&&e[BO]==="FormData"&&e[Qf])},toJSONObject:e=>{const t=new Array(10),n=(r,i)=>{if(th(r)){if(t.indexOf(r)>=0)return;if(eh(r))return r;if(!("toJSON"in r)){t[i]=r;const o=Xd(r)?[]:{};return nh(r,(s,c)=>{const l=n(s,i+1);!Jd(l)&&(o[c]=l)}),t[i]=void 0,o}}return r};return n(e,0)},isAsyncFn:tz,isThenable:e=>e&&(th(e)||ui(e))&&ui(e.then)&&ui(e.catch),setImmediate:zO,asap:nz,isIterable:e=>e!=null&&ui(e[Qf])};function yt(e,t,n,r,i){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),r&&(this.request=r),i&&(this.response=i,this.status=i.status?i.status:null)}ce.inherits(yt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:ce.toJSONObject(this.config),code:this.code,status:this.status}}});const JO=yt.prototype,QO={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(e=>{QO[e]={value:e}}),Object.defineProperties(yt,QO),Object.defineProperty(JO,"isAxiosError",{value:!0}),yt.from=(e,t,n,r,i,o)=>{const s=Object.create(JO);ce.toFlatObject(e,s,function(u){return u!==Error.prototype},u=>u!=="isAxiosError");const c=e&&e.message?e.message:"Error",l=t==null&&e?e.code:t;return yt.call(s,c,l,n,r,i),e&&s.cause==null&&Object.defineProperty(s,"cause",{value:e,configurable:!0}),s.name=e&&e.name||"Error",o&&Object.assign(s,o),s};function jT(e){return ce.isPlainObject(e)||ce.isArray(e)}function ZO(e){return ce.endsWith(e,"[]")?e.slice(0,-2):e}function $O(e,t,n){return e?e.concat(t).map(function(r,i){return r=ZO(r),!n&&i?"["+r+"]":r}).join(n?".":""):t}const rz=ce.toFlatObject(ce,{},null,function(e){return/^is[A-Z]/.test(e)});function n_(e,t,n){if(!ce.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;const r=(n=ce.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(_,E){return!ce.isUndefined(E[_])})).metaTokens,i=n.visitor||u,o=n.dots,s=n.indexes,c=(n.Blob||typeof Blob<"u"&&Blob)&&ce.isSpecCompliantForm(t);if(!ce.isFunction(i))throw new TypeError("visitor must be a function");function l(_){if(_===null)return"";if(ce.isDate(_))return _.toISOString();if(ce.isBoolean(_))return _.toString();if(!c&&ce.isBlob(_))throw new yt("Blob is not supported. Use a Buffer instead.");return ce.isArrayBuffer(_)||ce.isTypedArray(_)?c&&typeof Blob=="function"?new Blob([_]):Buffer.from(_):_}function u(_,E,I){let v=_;if(_&&!I&&typeof _=="object"){if(ce.endsWith(E,"{}"))E=r?E:E.slice(0,-2),_=JSON.stringify(_);else if(ce.isArray(_)&&function(R){return ce.isArray(R)&&!R.some(jT)}(_)||(ce.isFileList(_)||ce.endsWith(E,"[]"))&&(v=ce.toArray(_)))return E=ZO(E),v.forEach(function(R,A){!ce.isUndefined(R)&&R!==null&&t.append(s===!0?$O([E],A,o):s===null?E:E+"[]",l(R))}),!1}return!!jT(_)||(t.append($O(I,E,o),l(_)),!1)}const h=[],f=Object.assign(rz,{defaultVisitor:u,convertValue:l,isVisitable:jT});if(!ce.isObject(e))throw new TypeError("data must be an object");return function _(E,I){if(!ce.isUndefined(E)){if(h.indexOf(E)!==-1)throw Error("Circular reference detected in "+I.join("."));h.push(E),ce.forEach(E,function(v,R){(!(ce.isUndefined(v)||v===null)&&i.call(t,v,ce.isString(R)?_r(R).call(R):R,I,f))===!0&&_(v,I?I.concat(R):[R])}),h.pop()}}(e),t}function eN(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,function(n){return t[n]})}function GT(e,t){this._pairs=[],e&&n_(e,this,t)}const tN=GT.prototype;function iz(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+")}function nN(e,t,n){if(!t)return e;const r=n&&n.encode||iz;ce.isFunction(n)&&(n={serialize:n});const i=n&&n.serialize;let o;if(o=i?i(t,n):ce.isURLSearchParams(t)?t.toString():new GT(t,n).toString(r),o){const s=e.indexOf("#");s!==-1&&(e=e.slice(0,s)),e+=(e.indexOf("?")===-1?"?":"&")+o}return e}tN.append=function(e,t){this._pairs.push([e,t])},tN.toString=function(e){const t=e?function(n){return e.call(this,n,eN)}:eN;return this._pairs.map(function(n){return t(n[0])+"="+t(n[1])},"").join("&")};var rN=class{constructor(){this.handlers=[]}use(e,t,n){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!n&&n.synchronous,runWhen:n?n.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){ce.forEach(this.handlers,function(t){t!==null&&e(t)})}},iN={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},oN={exports:{}},oz=ft,sz=At,sN=Ji.f;oz({target:"Object",stat:!0,forced:Object.defineProperty!==sN,sham:!sz},{defineProperty:sN});var aN=wr.Object,az=oN.exports=function(e,t,n){return aN.defineProperty(e,t,n)};aN.defineProperty.sham&&(az.sham=!0);var cN=S(oN.exports),cz=TypeError,dN=Mu,dz=Rf,lz=yn,uz=un("species"),lN=Array,hz=function(e){var t;return dN(e)&&(t=e.constructor,(dz(t)&&(t===lN||dN(t.prototype))||lz(t)&&(t=t[uz])===null)&&(t=void 0)),t===void 0?lN:t},uN=function(e,t){return new(hz(e))(t===0?0:t)},pz=C,fz=ks,_z=un("species"),hN=function(e){return fz>=51||!pz(function(){var t=[];return(t.constructor={})[_z]=function(){return{foo:1}},t[e](Boolean).foo!==1})},mz=ft,Ez=C,gz=Mu,Sz=yn,Tz=os,vz=la,pN=function(e){if(e>9007199254740991)throw cz("Maximum allowed index exceeded");return e},fN=QS,Rz=uN,yz=hN,Cz=ks,_N=un("isConcatSpreadable"),Iz=Cz>=51||!Ez(function(){var e=[];return e[_N]=!1,e.concat()[0]!==e}),wz=function(e){if(!Sz(e))return!1;var t=e[_N];return t!==void 0?!!t:gz(e)};mz({target:"Array",proto:!0,forced:!Iz||!yz("concat")},{concat:function(e){var t,n,r,i,o,s=Tz(this),c=Rz(s,0),l=0;for(t=-1,r=arguments.length;t<r;t++)if(wz(o=t===-1?s:arguments[t]))for(i=vz(o),pN(l+i),n=0;n<i;n++,l++)n in o&&fN(c,l,o[n]);else pN(l+1),fN(c,l++,o);return c.length=l,c}});var mN={},Az=Me,bz=Ir,EN=sf.f,Oz=pa,gN=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];mN.f=function(e){return gN&&Az(e)==="Window"?function(t){try{return EN(t)}catch{return Oz(gN)}}(e):EN(bz(e))};var Qd={},Nz=un;Qd.f=Nz;var SN=wr,Dz=ir,Pz=Qd,Lz=Ji.f,Bn=function(e){var t=SN.Symbol||(SN.Symbol={});Dz(t,e)||Lz(t,e,{value:Pz.f(e)})},kz=$t,Mz=Zn,Uz=un,xz=ha,TN=function(){var e=Mz("Symbol"),t=e&&e.prototype,n=t&&t.valueOf,r=Uz("toPrimitive");t&&!t[r]&&xz(t,r,function(i){return kz(n,this)},{})},Vz=da,Fz=cc,Bz=os,jz=la,Gz=uN,vN=oe([].push),Wz=function(e){var t=e===1,n=e===2,r=e===3,i=e===4,o=e===6,s=e===7,c=e===5||o;return function(l,u,h,f){for(var _,E,I=Bz(l),v=Fz(I),R=jz(v),A=Vz(u,h),O=0,P=f||Gz,M=t?P(l,R):n||s?P(l,0):void 0;R>O;O++)if((c||O in v)&&(E=A(_=v[O],O,I),e))if(t)M[O]=E;else if(E)switch(e){case 3:return!0;case 5:return _;case 6:return O;case 2:vN(M,_)}else switch(e){case 4:return!1;case 7:vN(M,_)}return o?-1:r||i?i:M}},RN={forEach:Wz(0)},r_=ft,rh=fe,WT=$t,Hz=oe,Zd=At,$d=aa,Kz=C,mr=ir,Yz=re,HT=Qr,i_=Ir,KT=Cg,zz=Zr,YT=Fn,el=xu,yN=cf,qz=sf,CN=mN,Xz=Uu,IN=Tn,wN=Ji,Jz=Kg,AN=be,bN=ha,Qz=vf,zT=Id,ON=af,NN=Rg,Zz=un,$z=Qd,e9=Bn,t9=TN,n9=Ms,DN=_c,o_=RN.forEach,hi=of("hidden"),s_="Symbol",ih="prototype",r9=DN.set,PN=DN.getterFor(s_),Do=Object[ih],Cc=rh.Symbol,a_=Cc&&Cc[ih],i9=rh.RangeError,o9=rh.TypeError,qT=rh.QObject,LN=IN.f,Ic=wN.f,kN=CN.f,s9=AN.f,MN=Hz([].push),Vs=zT("symbols"),oh=zT("op-symbols"),a9=zT("wks"),XT=!qT||!qT[ih]||!qT[ih].findChild,UN=function(e,t,n){var r=LN(Do,t);r&&delete Do[t],Ic(e,t,n),r&&e!==Do&&Ic(Do,t,r)},JT=Zd&&Kz(function(){return el(Ic({},"a",{get:function(){return Ic(this,"a",{value:7}).a}})).a!==7})?UN:Ic,QT=function(e,t){var n=Vs[e]=el(a_);return r9(n,{type:s_,tag:e,description:t}),Zd||(n.description=t),n},c_=function(e,t,n){e===Do&&c_(oh,t,n),HT(e);var r=KT(t);return HT(n),mr(Vs,r)?(n.enumerable?(mr(e,hi)&&e[hi][r]&&(e[hi][r]=!1),n=el(n,{enumerable:YT(0,!1)})):(mr(e,hi)||Ic(e,hi,YT(1,el(null))),e[hi][r]=!0),JT(e,r,n)):Ic(e,r,n)},ZT=function(e,t){HT(e);var n=i_(t),r=yN(n).concat(BN(n));return o_(r,function(i){Zd&&!WT(xN,n,i)||c_(e,i,n[i])}),e},xN=function(e){var t=KT(e),n=WT(s9,this,t);return!(this===Do&&mr(Vs,t)&&!mr(oh,t))&&(!(n||!mr(this,t)||!mr(Vs,t)||mr(this,hi)&&this[hi][t])||n)},VN=function(e,t){var n=i_(e),r=KT(t);if(n!==Do||!mr(Vs,r)||mr(oh,r)){var i=LN(n,r);return!i||!mr(Vs,r)||mr(n,hi)&&n[hi][r]||(i.enumerable=!0),i}},FN=function(e){var t=kN(i_(e)),n=[];return o_(t,function(r){mr(Vs,r)||mr(ON,r)||MN(n,r)}),n},BN=function(e){var t=e===Do,n=kN(t?oh:i_(e)),r=[];return o_(n,function(i){!mr(Vs,i)||t&&!mr(Do,i)||MN(r,Vs[i])}),r};$d||(Cc=function(){if(Yz(a_,this))throw new o9("Symbol is not a constructor");var e=arguments.length&&arguments[0]!==void 0?zz(arguments[0]):void 0,t=NN(e),n=function(r){var i=this===void 0?rh:this;i===Do&&WT(n,oh,r),mr(i,hi)&&mr(i[hi],t)&&(i[hi][t]=!1);var o=YT(1,r);try{JT(i,t,o)}catch(s){if(!(s instanceof i9))throw s;UN(i,t,o)}};return Zd&&XT&&JT(Do,t,{configurable:!0,set:n}),QT(t,e)},bN(a_=Cc[ih],"toString",function(){return PN(this).tag}),bN(Cc,"withoutSetter",function(e){return QT(NN(e),e)}),AN.f=xN,wN.f=c_,Jz.f=ZT,IN.f=VN,qz.f=CN.f=FN,Xz.f=BN,$z.f=function(e){return QT(Zz(e),e)},Zd&&Qz(a_,"description",{configurable:!0,get:function(){return PN(this).description}})),r_({global:!0,wrap:!0,forced:!$d,sham:!$d},{Symbol:Cc}),o_(yN(a9),function(e){e9(e)}),r_({target:s_,stat:!0,forced:!$d},{useSetter:function(){XT=!0},useSimple:function(){XT=!1}}),r_({target:"Object",stat:!0,forced:!$d,sham:!Zd},{create:function(e,t){return t===void 0?el(e):ZT(el(e),t)},defineProperty:c_,defineProperties:ZT,getOwnPropertyDescriptor:VN}),r_({target:"Object",stat:!0,forced:!$d},{getOwnPropertyNames:FN}),t9(),n9(Cc,s_),ON[hi]=!0;var jN=aa&&!!Symbol.for&&!!Symbol.keyFor,c9=ft,d9=Zn,l9=ir,u9=Zr,GN=Id,h9=jN,$T=GN("string-to-symbol-registry"),p9=GN("symbol-to-string-registry");c9({target:"Symbol",stat:!0,forced:!h9},{for:function(e){var t=u9(e);if(l9($T,t))return $T[t];var n=d9("Symbol")(t);return $T[t]=n,p9[n]=t,n}});var f9=ft,_9=ir,m9=bt,E9=di,g9=jN,WN=Id("symbol-to-string-registry");f9({target:"Symbol",stat:!0,forced:!g9},{keyFor:function(e){if(!m9(e))throw new TypeError(E9(e)+" is not a symbol");if(_9(WN,e))return WN[e]}});var HN=Mu,S9=qe,KN=Me,T9=Zr,YN=oe([].push),v9=ft,zN=Zn,qN=Q,R9=$t,sh=oe,XN=C,JN=qe,QN=bt,ZN=pa,y9=function(e){if(S9(e))return e;if(HN(e)){for(var t=e.length,n=[],r=0;r<t;r++){var i=e[r];typeof i=="string"?YN(n,i):typeof i!="number"&&KN(i)!=="Number"&&KN(i)!=="String"||YN(n,T9(i))}var o=n.length,s=!0;return function(c,l){if(s)return s=!1,l;if(HN(this))return l;for(var u=0;u<o;u++)if(n[u]===c)return l}}},C9=aa,I9=String,Sa=zN("JSON","stringify"),d_=sh(/./.exec),$N=sh("".charAt),w9=sh("".charCodeAt),A9=sh("".replace),b9=sh(1.1.toString),O9=/[\uD800-\uDFFF]/g,eD=/^[\uD800-\uDBFF]$/,tD=/^[\uDC00-\uDFFF]$/,nD=!C9||XN(function(){var e=zN("Symbol")("stringify detection");return Sa([e])!=="[null]"||Sa({a:e})!=="{}"||Sa(Object(e))!=="{}"}),rD=XN(function(){return Sa("\uDF06\uD834")!=='"\\udf06\\ud834"'||Sa("\uDEAD")!=='"\\udead"'}),N9=function(e,t){var n=ZN(arguments),r=y9(t);if(JN(r)||e!==void 0&&!QN(e))return n[1]=function(i,o){if(JN(r)&&(o=R9(r,this,I9(i),o)),!QN(o))return o},qN(Sa,null,n)},D9=function(e,t,n){var r=$N(n,t-1),i=$N(n,t+1);return d_(eD,e)&&!d_(tD,i)||d_(tD,e)&&!d_(eD,r)?"\\u"+b9(w9(e,0),16):e};Sa&&v9({target:"JSON",stat:!0,forced:nD||rD},{stringify:function(e,t,n){var r=ZN(arguments),i=qN(nD?N9:Sa,null,r);return rD&&typeof i=="string"?A9(i,O9,D9):i}});var iD=Uu,P9=os;ft({target:"Object",stat:!0,forced:!aa||C(function(){iD.f(1)})},{getOwnPropertySymbols:function(e){var t=iD.f;return t?t(P9(e)):[]}}),Bn("asyncDispose"),Bn("asyncIterator"),Bn("dispose"),Bn("hasInstance"),Bn("isConcatSpreadable"),Bn("iterator"),Bn("match"),Bn("matchAll"),Bn("replace"),Bn("search"),Bn("species"),Bn("split");var L9=TN;Bn("toPrimitive"),L9();var k9=Zn,M9=Ms;Bn("toStringTag"),M9(k9("Symbol"),"Symbol"),Bn("unscopables"),Ms(fe.JSON,"JSON",!0);var U9=wr.Symbol,x9=un,V9=Ji.f,oD=x9("metadata"),sD=Function.prototype;sD[oD]===void 0&&V9(sD,oD,{value:null}),Bn("metadata");var F9=U9,B9=oe,ev=Zn("Symbol"),j9=ev.keyFor,G9=B9(ev.prototype.valueOf),aD=ev.isRegisteredSymbol||function(e){try{return j9(G9(e))!==void 0}catch{return!1}};ft({target:"Symbol",stat:!0},{isRegisteredSymbol:aD});for(var W9=Id,cD=Zn,H9=oe,K9=bt,Y9=un,l_=cD("Symbol"),dD=l_.isWellKnownSymbol,lD=cD("Object","getOwnPropertyNames"),z9=H9(l_.prototype.valueOf),uD=W9("wks"),tv=0,hD=lD(l_),q9=hD.length;tv<q9;tv++)try{var pD=hD[tv];K9(l_[pD])&&Y9(pD)}catch{}var fD=function(e){if(dD&&dD(e))return!0;try{for(var t=z9(e),n=0,r=lD(uD),i=r.length;n<i;n++)if(uD[r[n]]==t)return!0}catch{}return!1};ft({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:fD}),Bn("customMatcher"),Bn("observable"),ft({target:"Symbol",stat:!0},{isRegistered:aD}),ft({target:"Symbol",stat:!0,forced:!0},{isWellKnown:fD}),Bn("matcher"),Bn("metadataKey"),Bn("patternMatch"),Bn("replaceAll");var tl=S(F9),_D=S(Qd.f("iterator"));function ah(e){return ah=typeof tl=="function"&&typeof _D=="symbol"?function(t){return typeof t}:function(t){return t&&typeof tl=="function"&&t.constructor===tl&&t!==tl.prototype?"symbol":typeof t},ah(e)}var X9=S(Qd.f("toPrimitive"));function J9(e){var t=function(n,r){if(ah(n)!="object"||!n)return n;var i=n[X9];if(i!==void 0){var o=i.call(n,r);if(ah(o)!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(r==="string"?String:Number)(n)}(e,"string");return ah(t)=="symbol"?t:t+""}function y(e,t,n){return(t=J9(t))in e?cN(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var mD=S(R8),Q9={isBrowser:!0,classes:{URLSearchParams:mD!==void 0?mD:GT,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};const nv=typeof window<"u"&&typeof document<"u",rv=typeof navigator=="object"&&navigator||void 0,Z9=nv&&(!rv||["ReactNative","NativeScript","NS"].indexOf(rv.product)<0),$9=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",e7=nv&&window.location.href||"http://localhost";function ED(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function gD(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?ED(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ED(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}var jr=gD(gD({},Object.freeze({__proto__:null,hasBrowserEnv:nv,hasStandardBrowserEnv:Z9,hasStandardBrowserWebWorkerEnv:$9,navigator:rv,origin:e7})),Q9);function SD(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function t7(e,t){return n_(e,new jr.classes.URLSearchParams,function(n){for(var r=1;r<arguments.length;r++){var i=arguments[r]!=null?arguments[r]:{};r%2?SD(Object(i),!0).forEach(function(o){y(n,o,i[o])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(i)):SD(Object(i)).forEach(function(o){Object.defineProperty(n,o,Object.getOwnPropertyDescriptor(i,o))})}return n}({visitor:function(n,r,i,o){return jr.isNode&&ce.isBuffer(n)?(this.append(r,n.toString("base64")),!1):o.defaultVisitor.apply(this,arguments)}},t))}var n7=xS.charAt,TD=$t,r7=Qr,i7=qe,o7=Me,s7=/./.exec,a7=TypeError,c7=ft,vD=$t,RD=ht,d7=iS,u_=Sf,yD=is,CD=Tw,ch=Zr,l7=Qr,u7=yn,h7=Me,p7=kg,ID=bT,f7=Du,_7=C,m7=lS,E7=function(e,t,n){return t+(n?n7(e,t).length:1)},g7=function(e,t){var n=e.exec;if(i7(n)){var r=TD(n,e,t);return r!==null&&r7(r),r}if(o7(e)==="RegExp")return TD(s7,e,t);throw new a7("RegExp#exec called on incompatible receiver")},wD=_c,S7=un("matchAll"),AD="RegExp String",bD=AD+" Iterator",T7=wD.set,v7=wD.getterFor(bD),R7=TypeError,iv=RD("".indexOf),h_=RD("".matchAll),ov=!!h_&&!_7(function(){h_("a",/./)}),y7=d7(function(e,t,n,r){T7(this,{type:bD,regexp:e,string:t,global:n,unicode:r,done:!1})},AD,function(){var e=v7(this);if(e.done)return u_(void 0,!0);var t=e.regexp,n=e.string,r=g7(t,n);return r===null?(e.done=!0,u_(void 0,!0)):e.global?(ch(r[0])===""&&(t.lastIndex=E7(n,CD(t.lastIndex),e.unicode)),u_(r,!1)):(e.done=!0,u_(r,!1))}),OD=function(e){var t,n,r,i=l7(this),o=ch(e),s=m7(i,RegExp),c=ch(ID(i));return t=new s(s===RegExp?i.source:i,c),n=!!~iv(c,"g"),r=!!~iv(c,"u"),t.lastIndex=CD(i.lastIndex),new y7(t,o,n,r)};c7({target:"String",proto:!0,forced:ov},{matchAll:function(e){var t,n,r,i,o=yD(this);if(u7(e)){if(p7(e)&&(t=ch(yD(ID(e))),!~iv(t,"g")))throw new R7("`.matchAll` does not allow non-global regexes");if(ov)return h_(o,e);if((r=f7(e,S7))===void 0&&h7(e)==="RegExp"&&(r=OD),r)return vD(r,e,o)}else if(ov)return h_(o,e);return n=ch(o),i=new RegExp(e,"g"),vD(OD,i,n)}});var C7=Ni("String","matchAll"),I7=re,w7=C7,sv=String.prototype,A7=function(e){var t=e.matchAll;return typeof e=="string"||e===sv||I7(sv,e)&&t===sv.matchAll?w7:t},b7=S(A7);function ND(e){function t(n,r,i,o){let s=n[o++];if(s==="__proto__")return!0;const c=Number.isFinite(+s),l=o>=n.length;return s=!s&&ce.isArray(i)?i.length:s,l?(ce.hasOwnProp(i,s)?i[s]=[i[s],r]:i[s]=r,!c):(i[s]&&ce.isObject(i[s])||(i[s]=[]),t(n,r,i[s],o)&&ce.isArray(i[s])&&(i[s]=function(u){const h={},f=Object.keys(u);let _;const E=f.length;let I;for(_=0;_<E;_++)I=f[_],h[I]=u[I];return h}(i[s])),!c)}if(ce.isFormData(e)&&ce.isFunction(e.entries)){const n={};return ce.forEachEntry(e,(r,i)=>{t(function(o){return b7(ce).call(ce,/\w+|\[(\w*)]/g,o).map(s=>s[0]==="[]"?"":s[1]||s[0])}(r),i,n,0)}),n}return null}const av={transitional:iN,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const n=t.getContentType()||"",r=n.indexOf("application/json")>-1,i=ce.isObject(e);if(i&&ce.isHTMLForm(e)&&(e=new FormData(e)),ce.isFormData(e))return r?JSON.stringify(ND(e)):e;if(ce.isArrayBuffer(e)||ce.isBuffer(e)||ce.isStream(e)||ce.isFile(e)||ce.isBlob(e)||ce.isReadableStream(e))return e;if(ce.isArrayBufferView(e))return e.buffer;if(ce.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(i){if(n.indexOf("application/x-www-form-urlencoded")>-1)return t7(e,this.formSerializer).toString();if((o=ce.isFileList(e))||n.indexOf("multipart/form-data")>-1){const s=this.env&&this.env.FormData;return n_(o?{"files[]":e}:e,s&&new s,this.formSerializer)}}return i||r?(t.setContentType("application/json",!1),function(s,c,l){if(ce.isString(s))try{return(c||JSON.parse)(s),_r(ce).call(ce,s)}catch(u){if(u.name!=="SyntaxError")throw u}return(l||JSON.stringify)(s)}(e)):e}],transformResponse:[function(e){const t=this.transitional||av.transitional,n=t&&t.forcedJSONParsing,r=this.responseType==="json";if(ce.isResponse(e)||ce.isReadableStream(e))return e;if(e&&ce.isString(e)&&(n&&!this.responseType||r)){const i=!(t&&t.silentJSONParsing)&&r;try{return JSON.parse(e,this.parseReviver)}catch(o){if(i)throw o.name==="SyntaxError"?yt.from(o,yt.ERR_BAD_RESPONSE,this,null,this.response):o}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:jr.classes.FormData,Blob:jr.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};ce.forEach(["delete","get","head","post","put","patch"],e=>{av.headers[e]={}});var cv=av;const O7=ce.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),DD=Symbol("internals");function dh(e){var t;return e&&_r(t=String(e)).call(t).toLowerCase()}function p_(e){return e===!1||e==null?e:ce.isArray(e)?e.map(p_):String(e)}function dv(e,t,n,r,i){return ce.isFunction(r)?r.call(this,t,n):(i&&(t=n),ce.isString(t)?ce.isString(r)?t.indexOf(r)!==-1:ce.isRegExp(r)?r.test(t):void 0:void 0)}class f_{constructor(t){t&&this.set(t)}set(t,n,r){const i=this;function o(l,u,h){const f=dh(u);if(!f)throw new Error("header name must be a non-empty string");const _=ce.findKey(i,f);(!_||i[_]===void 0||h===!0||h===void 0&&i[_]!==!1)&&(i[_||u]=p_(l))}const s=(l,u)=>ce.forEach(l,(h,f)=>o(h,f,u));if(ce.isPlainObject(t)||t instanceof this.constructor)s(t,n);else if(ce.isString(t)&&(t=_r(t).call(t))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(_r(c=t).call(c)))s((l=>{const u={};let h,f,_;return l&&l.split(`
`).forEach(function(E){var I,v;_=E.indexOf(":"),h=_r(I=E.substring(0,_)).call(I).toLowerCase(),f=_r(v=E.substring(_+1)).call(v),!h||u[h]&&O7[h]||(h==="set-cookie"?u[h]?u[h].push(f):u[h]=[f]:u[h]=u[h]?u[h]+", "+f:f)}),u})(t),n);else if(ce.isObject(t)&&ce.isIterable(t)){let l,u,h={};for(const f of t){if(!ce.isArray(f))throw TypeError("Object iterator must return a key-value pair");h[u=f[0]]=(l=h[u])?ce.isArray(l)?[...l,f[1]]:[l,f[1]]:f[1]}s(h,n)}else t!=null&&o(n,t,r);var c;return this}get(t,n){if(t=dh(t)){const r=ce.findKey(this,t);if(r){const i=this[r];if(!n)return i;if(n===!0)return function(o){const s=Object.create(null),c=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let l;for(;l=c.exec(o);)s[l[1]]=l[2];return s}(i);if(ce.isFunction(n))return n.call(this,i,r);if(ce.isRegExp(n))return n.exec(i);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,n){if(t=dh(t)){const r=ce.findKey(this,t);return!(!r||this[r]===void 0||n&&!dv(0,this[r],r,n))}return!1}delete(t,n){const r=this;let i=!1;function o(s){if(s=dh(s)){const c=ce.findKey(r,s);!c||n&&!dv(0,r[c],c,n)||(delete r[c],i=!0)}}return ce.isArray(t)?t.forEach(o):o(t),i}clear(t){const n=Object.keys(this);let r=n.length,i=!1;for(;r--;){const o=n[r];t&&!dv(0,this[o],o,t,!0)||(delete this[o],i=!0)}return i}normalize(t){const n=this,r={};return ce.forEach(this,(i,o)=>{var s;const c=ce.findKey(r,o);if(c)return n[c]=p_(i),void delete n[o];const l=t?function(u){return _r(u).call(u).toLowerCase().replace(/([a-z\d])(\w*)/g,(h,f,_)=>f.toUpperCase()+_)}(o):_r(s=String(o)).call(s);l!==o&&delete n[o],n[l]=p_(i),r[l]=!0}),this}concat(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return this.constructor.concat(this,...n)}toJSON(t){const n=Object.create(null);return ce.forEach(this,(r,i)=>{r!=null&&r!==!1&&(n[i]=t&&ce.isArray(r)?r.join(", "):r)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(t=>{let[n,r]=t;return n+": "+r}).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t){const n=new this(t);for(var r=arguments.length,i=new Array(r>1?r-1:0),o=1;o<r;o++)i[o-1]=arguments[o];return i.forEach(s=>n.set(s)),n}static accessor(t){const n=(this[DD]=this[DD]={accessors:{}}).accessors,r=this.prototype;function i(o){const s=dh(o);n[s]||(function(c,l){const u=ce.toCamelCase(" "+l);["get","set","has"].forEach(h=>{Object.defineProperty(c,h+u,{value:function(f,_,E){return this[h].call(this,l,f,_,E)},configurable:!0})})}(r,o),n[s]=!0)}return ce.isArray(t)?t.forEach(i):i(t),this}}f_.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),ce.reduceDescriptors(f_.prototype,(e,t)=>{let{value:n}=e,r=t[0].toUpperCase()+t.slice(1);return{get:()=>n,set(i){this[r]=i}}}),ce.freezeMethods(f_);var Po=f_;function lv(e,t){const n=this||cv,r=t||n,i=Po.from(r.headers);let o=r.data;return ce.forEach(e,function(s){o=s.call(n,o,i.normalize(),t?t.status:void 0)}),i.normalize(),o}function PD(e){return!(!e||!e.__CANCEL__)}function nl(e,t,n){yt.call(this,e??"canceled",yt.ERR_CANCELED,t,n),this.name="CanceledError"}function LD(e,t,n){const r=n.config.validateStatus;n.status&&r&&!r(n.status)?t(new yt("Request failed with status code "+n.status,[yt.ERR_BAD_REQUEST,yt.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n)):e(n)}ce.inherits(nl,yt,{__CANCEL__:!0});const __=function(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,r=0;const i=function(o,s){o=o||10;const c=new Array(o),l=new Array(o);let u,h=0,f=0;return s=s!==void 0?s:1e3,function(_){const E=Date.now(),I=l[f];u||(u=E),c[h]=_,l[h]=E;let v=f,R=0;for(;v!==h;)R+=c[v++],v%=o;if(h=(h+1)%o,h===f&&(f=(f+1)%o),E-u<s)return;const A=I&&E-I;return A?Math.round(1e3*R/A):void 0}}(50,250);return function(o,s){let c,l,u=0,h=1e3/s;const f=function(_){u=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),c=null,l&&(clearTimeout(l),l=null),o(..._)};return[function(){const _=Date.now(),E=_-u;for(var I=arguments.length,v=new Array(I),R=0;R<I;R++)v[R]=arguments[R];E>=h?f(v,_):(c=v,l||(l=setTimeout(()=>{l=null,f(c)},h-E)))},()=>c&&f(c)]}(o=>{const s=o.loaded,c=o.lengthComputable?o.total:void 0,l=s-r,u=i(l);r=s,e({loaded:s,total:c,progress:c?s/c:void 0,bytes:l,rate:u||void 0,estimated:u&&c&&s<=c?(c-s)/u:void 0,event:o,lengthComputable:c!=null,[t?"download":"upload"]:!0})},n)},kD=(e,t)=>{const n=e!=null;return[r=>t[0]({lengthComputable:n,total:e,loaded:r}),t[1]]},MD=e=>function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return ce.asap(()=>e(...n))};var N7=jr.hasStandardBrowserEnv?((e,t)=>n=>(n=new Hf(n,jr.origin),e.protocol===n.protocol&&e.host===n.host&&(t||e.port===n.port)))(new Hf(jr.origin),jr.navigator&&/(msie|trident)/i.test(jr.navigator.userAgent)):()=>!0,D7=jr.hasStandardBrowserEnv?{write(e,t,n,r,i,o,s){if(typeof document>"u")return;const c=["".concat(e,"=").concat(encodeURIComponent(t))];ce.isNumber(n)&&c.push("expires=".concat(new Date(n).toUTCString())),ce.isString(r)&&c.push("path=".concat(r)),ce.isString(i)&&c.push("domain=".concat(i)),o===!0&&c.push("secure"),ce.isString(s)&&c.push("SameSite=".concat(s)),document.cookie=c.join("; ")},read(e){if(typeof document>"u")return null;const t=document.cookie.match(new RegExp("(?:^|; )"+e+"=([^;]*)"));return t?decodeURIComponent(t[1]):null},remove(e){this.write(e,"",Date.now()-864e5,"/")}}:{write(){},read:()=>null,remove(){}};function UD(e,t,n){let r=!function(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)}(t);return e&&(r||n==0)?function(i,o){return o?i.replace(/\/?\/$/,"")+"/"+o.replace(/^\/+/,""):i}(e,t):t}function xD(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function uv(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?xD(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xD(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}const VD=e=>e instanceof Po?uv({},e):e;function wc(e,t){t=t||{};const n={};function r(u,h,f,_){return ce.isPlainObject(u)&&ce.isPlainObject(h)?ce.merge.call({caseless:_},u,h):ce.isPlainObject(h)?ce.merge({},h):ce.isArray(h)?h.slice():h}function i(u,h,f,_){return ce.isUndefined(h)?ce.isUndefined(u)?void 0:r(void 0,u,0,_):r(u,h,0,_)}function o(u,h){if(!ce.isUndefined(h))return r(void 0,h)}function s(u,h){return ce.isUndefined(h)?ce.isUndefined(u)?void 0:r(void 0,u):r(void 0,h)}function c(u,h,f){return f in t?r(u,h):f in e?r(void 0,u):void 0}const l={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:c,headers:(u,h,f)=>i(VD(u),VD(h),0,!0)};return ce.forEach(Object.keys(uv(uv({},e),t)),function(u){const h=l[u]||i,f=h(e[u],t[u],u);ce.isUndefined(f)&&h!==c||(n[u]=f)}),n}var FD=e=>{const t=wc({},e);let{data:n,withXSRFToken:r,xsrfHeaderName:i,xsrfCookieName:o,headers:s,auth:c}=t;if(t.headers=s=Po.from(s),t.url=nN(UD(t.baseURL,t.url,t.allowAbsoluteUrls),e.params,e.paramsSerializer),c&&s.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),ce.isFormData(n)){if(jr.hasStandardBrowserEnv||jr.hasStandardBrowserWebWorkerEnv)s.setContentType(void 0);else if(ce.isFunction(n.getHeaders)){const l=n.getHeaders(),u=["content-type","content-length"];Object.entries(l).forEach(h=>{let[f,_]=h;Z(u).call(u,f.toLowerCase())&&s.set(f,_)})}}if(jr.hasStandardBrowserEnv&&(r&&ce.isFunction(r)&&(r=r(t)),r||r!==!1&&N7(t.url))){const l=i&&o&&D7.read(o);l&&s.set(i,l)}return t},P7=typeof XMLHttpRequest<"u"&&function(e){return new se(function(t,n){const r=FD(e);let i=r.data;const o=Po.from(r.headers).normalize();let s,c,l,u,h,{responseType:f,onUploadProgress:_,onDownloadProgress:E}=r;function I(){u&&u(),h&&h(),r.cancelToken&&r.cancelToken.unsubscribe(s),r.signal&&r.signal.removeEventListener("abort",s)}let v=new XMLHttpRequest;function R(){if(!v)return;const O=Po.from("getAllResponseHeaders"in v&&v.getAllResponseHeaders());LD(function(P){t(P),I()},function(P){n(P),I()},{data:f&&f!=="text"&&f!=="json"?v.response:v.responseText,status:v.status,statusText:v.statusText,headers:O,config:e,request:v}),v=null}v.open(r.method.toUpperCase(),r.url,!0),v.timeout=r.timeout,"onloadend"in v?v.onloadend=R:v.onreadystatechange=function(){v&&v.readyState===4&&(v.status!==0||v.responseURL&&v.responseURL.indexOf("file:")===0)&&setTimeout(R)},v.onabort=function(){v&&(n(new yt("Request aborted",yt.ECONNABORTED,e,v)),v=null)},v.onerror=function(O){const P=new yt(O&&O.message?O.message:"Network Error",yt.ERR_NETWORK,e,v);P.event=O||null,n(P),v=null},v.ontimeout=function(){let O=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const P=r.transitional||iN;r.timeoutErrorMessage&&(O=r.timeoutErrorMessage),n(new yt(O,P.clarifyTimeoutError?yt.ETIMEDOUT:yt.ECONNABORTED,e,v)),v=null},i===void 0&&o.setContentType(null),"setRequestHeader"in v&&ce.forEach(o.toJSON(),function(O,P){v.setRequestHeader(P,O)}),ce.isUndefined(r.withCredentials)||(v.withCredentials=!!r.withCredentials),f&&f!=="json"&&(v.responseType=r.responseType),E&&([l,h]=__(E,!0),v.addEventListener("progress",l)),_&&v.upload&&([c,u]=__(_),v.upload.addEventListener("progress",c),v.upload.addEventListener("loadend",u)),(r.cancelToken||r.signal)&&(s=O=>{v&&(n(!O||O.type?new nl(null,e,v):O),v.abort(),v=null)},r.cancelToken&&r.cancelToken.subscribe(s),r.signal&&(r.signal.aborted?s():r.signal.addEventListener("abort",s)));const A=function(O){const P=/^([-+\w]{1,25})(:?\/\/|:)/.exec(O);return P&&P[1]||""}(r.url);A&&jr.protocols.indexOf(A)===-1?n(new yt("Unsupported protocol "+A+":",yt.ERR_BAD_REQUEST,e)):v.send(i||null)})},L7=(e,t)=>{const{length:n}=e=e?e.filter(Boolean):[];if(t||n){let r,i=new AbortController;const o=function(u){if(!r){r=!0,c();const h=u instanceof Error?u:this.reason;i.abort(h instanceof yt?h:new nl(h instanceof Error?h.message:h))}};let s=t&&setTimeout(()=>{s=null,o(new yt("timeout ".concat(t," of ms exceeded"),yt.ETIMEDOUT))},t);const c=()=>{e&&(s&&clearTimeout(s),s=null,e.forEach(u=>{u.unsubscribe?u.unsubscribe(o):u.removeEventListener("abort",o)}),e=null)};e.forEach(u=>u.addEventListener("abort",o));const{signal:l}=i;return l.unsubscribe=()=>ce.asap(c),l}},hv=S(y0),BD=Qd.f("asyncIterator"),k7=S(BD);function pv(e,t){this.v=e,this.k=t}function Ar(e){return function(){return new lh(e.apply(this,arguments))}}function lh(e){var t,n;function r(o,s){try{var c=e[o](s),l=c.value,u=l instanceof pv;hv.resolve(u?l.v:l).then(function(h){if(u){var f=o==="return"?"return":"next";if(!l.k||h.done)return r(f,h);h=e[f](h).value}i(c.done?"return":"normal",h)},function(h){r("throw",h)})}catch(h){i("throw",h)}}function i(o,s){switch(o){case"return":t.resolve({value:s,done:!0});break;case"throw":t.reject(s);break;default:t.resolve({value:s,done:!1})}(t=t.next)?r(t.key,t.arg):n=null}this._invoke=function(o,s){return new hv(function(c,l){var u={key:o,arg:s,resolve:c,reject:l,next:null};n?n=n.next=u:(t=n=u,r(o,s))})},typeof e.return!="function"&&(this.return=void 0)}function We(e){return new pv(e,0)}function rl(e){var t={},n=!1;function r(i,o){return n=!0,o=new hv(function(s){s(e[i](o))}),{done:!1,value:new pv(o,1)}}return t[tl!==void 0&&_D||"@@iterator"]=function(){return this},t.next=function(i){return n?(n=!1,i):r("next",i)},typeof e.throw=="function"&&(t.throw=function(i){if(n)throw n=!1,i;return r("throw",i)}),typeof e.return=="function"&&(t.return=function(i){return n?(n=!1,i):r("return",i)}),t}lh.prototype[typeof tl=="function"&&k7||"@@asyncIterator"]=function(){return this},lh.prototype.next=function(e){return this._invoke("next",e)},lh.prototype.throw=function(e){return this._invoke("throw",e)},lh.prototype.return=function(e){return this._invoke("return",e)};var m_=S(BD);function fv(e){var t,n,r,i=2;for(typeof Symbol<"u"&&(n=m_,r=Symbol.iterator);i--;){if(n&&(t=e[n])!=null)return t.call(e);if(r&&(t=e[r])!=null)return new E_(t.call(e));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function E_(e){function t(n){if(Object(n)!==n)return se.reject(new TypeError(n+" is not an object."));var r=n.done;return se.resolve(n.value).then(function(i){return{value:i,done:r}})}return E_=function(n){this.s=n,this.n=n.next},E_.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return r===void 0?se.resolve({value:n,done:!0}):t(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return r===void 0?se.reject(n):t(r.apply(this.s,arguments))}},new E_(e)}const M7=function*(e,t){let n=e.byteLength;if(!t||n<t)return void(yield e);let r,i=0;for(;i<n;)r=i+t,yield e.slice(i,r),i=r},U7=function(){var e=Ar(function*(t,n){var r,i=!1,o=!1;try{for(var s,c=fv(x7(t));i=!(s=yield We(c.next())).done;i=!1){const l=s.value;yield*rl(fv(M7(l,n)))}}catch(l){o=!0,r=l}finally{try{i&&c.return!=null&&(yield We(c.return()))}finally{if(o)throw r}}});return function(t,n){return e.apply(this,arguments)}}(),x7=function(){var e=Ar(function*(t){if(t[m_])return void(yield*rl(fv(t)));const n=t.getReader();try{for(;;){const{done:r,value:i}=yield We(n.read());if(r)break;yield i}}finally{yield We(n.cancel())}});return function(t){return e.apply(this,arguments)}}(),jD=(e,t,n,r)=>{const i=U7(e,t);let o,s=0,c=l=>{o||(o=!0,r&&r(l))};return new ReadableStream({async pull(l){try{const{done:u,value:h}=await i.next();if(u)return c(),void l.close();let f=h.byteLength;if(n){let _=s+=f;n(_)}l.enqueue(new Uint8Array(h))}catch(u){throw c(u),u}},cancel:l=>(c(l),i.return())},{highWaterMark:2})};function GD(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function WD(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?GD(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):GD(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}const{isFunction:g_}=ce,V7=(e=>{let{Request:t,Response:n}=e;return{Request:t,Response:n}})(ce.global),{ReadableStream:HD,TextEncoder:KD}=ce.global,YD=function(e){try{for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return!!e(...n)}catch{return!1}},F7=e=>{e=ce.merge.call({skipUndefined:!0},V7,e);const{fetch:t,Request:n,Response:r}=e,i=t?g_(t):typeof fetch=="function",o=g_(n),s=g_(r);if(!i)return!1;const c=i&&g_(HD),l=i&&(typeof KD=="function"?(u=new KD,I=>u.encode(I)):async I=>new Uint8Array(await new n(I).arrayBuffer()));var u;const h=o&&c&&YD(()=>{let I=!1;const v=new n(jr.origin,{body:new HD,method:"POST",get duplex(){return I=!0,"half"}}).headers.has("Content-Type");return I&&!v}),f=s&&c&&YD(()=>ce.isReadableStream(new r("").body)),_={stream:f&&(I=>I.body)};i&&["text","arrayBuffer","blob","formData","stream"].forEach(I=>{!_[I]&&(_[I]=(v,R)=>{let A=v&&v[I];if(A)return A.call(v);throw new yt("Response type '".concat(I,"' is not supported"),yt.ERR_NOT_SUPPORT,R)})});const E=async(I,v)=>{const R=ce.toFiniteNumber(I.getContentLength());return R??(async A=>A==null?0:ce.isBlob(A)?A.size:ce.isSpecCompliantForm(A)?(await new n(jr.origin,{method:"POST",body:A}).arrayBuffer()).byteLength:ce.isArrayBufferView(A)||ce.isArrayBuffer(A)?A.byteLength:(ce.isURLSearchParams(A)&&(A+=""),ce.isString(A)?(await l(A)).byteLength:void 0))(v)};return async I=>{let{url:v,method:R,data:A,signal:O,cancelToken:P,timeout:M,onDownloadProgress:U,onUploadProgress:L,responseType:V,headers:H,withCredentials:q="same-origin",fetchOptions:de}=FD(I),Ne=t||fetch;V=V?(V+"").toLowerCase():"text";let Ae=L7([O,P&&P.toAbortSignal()],M),Ge=null;const xe=Ae&&Ae.unsubscribe&&(()=>{Ae.unsubscribe()});let ct;try{if(L&&h&&R!=="get"&&R!=="head"&&(ct=await E(H,A))!==0){let T,D=new n(v,{method:"POST",body:A,duplex:"half"});if(ce.isFormData(A)&&(T=D.headers.get("content-type"))&&H.setContentType(T),D.body){const[k,ee]=kD(ct,__(MD(L)));A=jD(D.body,65536,k,ee)}}ce.isString(q)||(q=q?"include":"omit");const jt=o&&"credentials"in n.prototype,Y=WD(WD({},de),{},{signal:Ae,method:R.toUpperCase(),headers:H.normalize().toJSON(),body:A,duplex:"half",credentials:jt?q:void 0});Ge=o&&new n(v,Y);let ne=await(o?Ne(Ge,de):Ne(v,Y));const he=f&&(V==="stream"||V==="response");if(f&&(U||he&&xe)){const T={};["status","statusText","headers"].forEach(Le=>{T[Le]=ne[Le]});const D=ce.toFiniteNumber(ne.headers.get("content-length")),[k,ee]=U&&kD(D,__(MD(U),!0))||[];ne=new r(jD(ne.body,65536,k,()=>{ee&&ee(),xe&&xe()}),T)}V=V||"text";let z=await _[ce.findKey(_,V)||"text"](ne,I);return!he&&xe&&xe(),await new se((T,D)=>{LD(T,D,{data:z,headers:Po.from(ne.headers),status:ne.status,statusText:ne.statusText,config:I,request:Ge})})}catch(jt){throw xe&&xe(),jt&&jt.name==="TypeError"&&/Load failed|fetch/i.test(jt.message)?Object.assign(new yt("Network Error",yt.ERR_NETWORK,I,Ge),{cause:jt.cause||jt}):yt.from(jt,jt&&jt.code,I,Ge)}}},B7=new Map,zD=e=>{let t=e&&e.env||{};const{fetch:n,Request:r,Response:i}=t,o=[r,i,n];let s,c,l=o.length,u=B7;for(;l--;)s=o[l],c=u.get(s),c===void 0&&u.set(s,c=l?new Map:F7(t)),u=c;return c};zD();const _v={http:null,xhr:P7,fetch:{get:zD}};ce.forEach(_v,(e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch{}Object.defineProperty(e,"adapterName",{value:t})}});const qD=e=>"- ".concat(e),j7=e=>ce.isFunction(e)||e===null||e===!1;var XD={getAdapter:function(e,t){e=ce.isArray(e)?e:[e];const{length:n}=e;let r,i;const o={};for(let s=0;s<n;s++){let c;if(r=e[s],i=r,!j7(r)&&(i=_v[(c=String(r)).toLowerCase()],i===void 0))throw new yt("Unknown adapter '".concat(c,"'"));if(i&&(ce.isFunction(i)||(i=i.get(t))))break;o[c||"#"+s]=i}if(!i){const s=Object.entries(o).map(c=>{let[l,u]=c;return"adapter ".concat(l," ")+(u===!1?"is not supported by the environment":"is not available in the build")});throw new yt("There is no suitable adapter to dispatch the request "+(n?s.length>1?`since :
`+s.map(qD).join(`
`):" "+qD(s[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return i},adapters:_v};function mv(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new nl(null,e)}function JD(e){return mv(e),e.headers=Po.from(e.headers),e.data=lv.call(e,e.transformRequest),["post","put","patch"].indexOf(e.method)!==-1&&e.headers.setContentType("application/x-www-form-urlencoded",!1),XD.getAdapter(e.adapter||cv.adapter,e)(e).then(function(t){return mv(e),t.data=lv.call(e,e.transformResponse,t),t.headers=Po.from(t.headers),t},function(t){return PD(t)||(mv(e),t&&t.response&&(t.response.data=lv.call(e,e.transformResponse,t.response),t.response.headers=Po.from(t.response.headers))),se.reject(t)})}const QD="1.13.2",S_={};["object","boolean","number","function","string","symbol"].forEach((e,t)=>{S_[e]=function(n){return typeof n===e||"a"+(t<1?"n ":" ")+e}});const ZD={};S_.transitional=function(e,t,n){function r(i,o){return"[Axios v"+QD+"] Transitional option '"+i+"'"+o+(n?". "+n:"")}return(i,o,s)=>{if(e===!1)throw new yt(r(o," has been removed"+(t?" in "+t:"")),yt.ERR_DEPRECATED);return t&&!ZD[o]&&(ZD[o]=!0,console.warn(r(o," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(i,o,s)}},S_.spelling=function(e){return(t,n)=>(console.warn("".concat(n," is likely a misspelling of ").concat(e)),!0)};var T_={assertOptions:function(e,t,n){if(typeof e!="object")throw new yt("options must be an object",yt.ERR_BAD_OPTION_VALUE);const r=Object.keys(e);let i=r.length;for(;i-- >0;){const o=r[i],s=t[o];if(s){const c=e[o],l=c===void 0||s(c,o,e);if(l!==!0)throw new yt("option "+o+" must be "+l,yt.ERR_BAD_OPTION_VALUE)}else if(n!==!0)throw new yt("Unknown option "+o,yt.ERR_BAD_OPTION)}},validators:S_};const ds=T_.validators;let v_=class{constructor(e){this.defaults=e||{},this.interceptors={request:new rN,response:new rN}}async request(e,t){try{return await this._request(e,t)}catch(n){if(n instanceof Error){let r={};Error.captureStackTrace?Error.captureStackTrace(r):r=new Error;const i=r.stack?r.stack.replace(/^.+\n/,""):"";try{n.stack?i&&!String(n.stack).endsWith(i.replace(/^.+\n.+\n/,""))&&(n.stack+=`
`+i):n.stack=i}catch{}}throw n}}_request(e,t){typeof e=="string"?(t=t||{}).url=e:t=e||{},t=wc(this.defaults,t);const{transitional:n,paramsSerializer:r,headers:i}=t;n!==void 0&&T_.assertOptions(n,{silentJSONParsing:ds.transitional(ds.boolean),forcedJSONParsing:ds.transitional(ds.boolean),clarifyTimeoutError:ds.transitional(ds.boolean)},!1),r!=null&&(ce.isFunction(r)?t.paramsSerializer={serialize:r}:T_.assertOptions(r,{encode:ds.function,serialize:ds.function},!0)),t.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?t.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:t.allowAbsoluteUrls=!0),T_.assertOptions(t,{baseUrl:ds.spelling("baseURL"),withXsrfToken:ds.spelling("withXSRFToken")},!0),t.method=(t.method||this.defaults.method||"get").toLowerCase();let o=i&&ce.merge(i.common,i[t.method]);i&&ce.forEach(["delete","get","head","post","put","patch","common"],E=>{delete i[E]}),t.headers=Po.concat(o,i);const s=[];let c=!0;this.interceptors.request.forEach(function(E){typeof E.runWhen=="function"&&E.runWhen(t)===!1||(c=c&&E.synchronous,s.unshift(E.fulfilled,E.rejected))});const l=[];let u;this.interceptors.response.forEach(function(E){l.push(E.fulfilled,E.rejected)});let h,f=0;if(!c){const E=[JD.bind(this),void 0];for(E.unshift(...s),E.push(...l),h=E.length,u=se.resolve(t);f<h;)u=u.then(E[f++],E[f++]);return u}h=s.length;let _=t;for(;f<h;){const E=s[f++],I=s[f++];try{_=E(_)}catch(v){I.call(this,v);break}}try{u=JD.call(this,_)}catch(E){return se.reject(E)}for(f=0,h=l.length;f<h;)u=u.then(l[f++],l[f++]);return u}getUri(e){return nN(UD((e=wc(this.defaults,e)).baseURL,e.url,e.allowAbsoluteUrls),e.params,e.paramsSerializer)}};ce.forEach(["delete","get","head","options"],function(e){v_.prototype[e]=function(t,n){return this.request(wc(n||{},{method:e,url:t,data:(n||{}).data}))}}),ce.forEach(["post","put","patch"],function(e){function t(n){return function(r,i,o){return this.request(wc(o||{},{method:e,headers:n?{"Content-Type":"multipart/form-data"}:{},url:r,data:i}))}}v_.prototype[e]=t(),v_.prototype[e+"Form"]=t(!0)});var R_=v_;class Ev{constructor(t){if(typeof t!="function")throw new TypeError("executor must be a function.");let n;this.promise=new se(function(i){n=i});const r=this;this.promise.then(i=>{if(!r._listeners)return;let o=r._listeners.length;for(;o-- >0;)r._listeners[o](i);r._listeners=null}),this.promise.then=i=>{let o;const s=new se(c=>{r.subscribe(c),o=c}).then(i);return s.cancel=function(){r.unsubscribe(o)},s},t(function(i,o,s){r.reason||(r.reason=new nl(i,o,s),n(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;const n=this._listeners.indexOf(t);n!==-1&&this._listeners.splice(n,1)}toAbortSignal(){const t=new AbortController,n=r=>{t.abort(r)};return this.subscribe(n),t.signal.unsubscribe=()=>this.unsubscribe(n),t.signal}static source(){let t;return{token:new Ev(function(r){t=r}),cancel:t}}}var G7=Ev;const gv={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511,WebServerIsDown:521,ConnectionTimedOut:522,OriginIsUnreachable:523,TimeoutOccurred:524,SslHandshakeFailed:525,InvalidSslCertificate:526};Object.entries(gv).forEach(e=>{let[t,n]=e;gv[n]=t});var W7=gv;const or=function e(t){const n=new R_(t),r=FO(R_.prototype.request,n);return ce.extend(r,R_.prototype,n,{allOwnKeys:!0}),ce.extend(r,n,null,{allOwnKeys:!0}),r.create=function(i){return e(wc(t,i))},r}(cv);or.Axios=R_,or.CanceledError=nl,or.CancelToken=G7,or.isCancel=PD,or.VERSION=QD,or.toFormData=n_,or.AxiosError=yt,or.Cancel=or.CanceledError,or.all=function(e){return se.all(e)},or.spread=function(e){return function(t){return e.apply(null,t)}},or.isAxiosError=function(e){return ce.isObject(e)&&e.isAxiosError===!0},or.mergeConfig=wc,or.AxiosHeaders=Po,or.formToJSON=e=>ND(ce.isHTMLForm(e)?new FormData(e):e),or.getAdapter=XD.getAdapter,or.HttpStatusCode=W7,or.default=or;var br=or;const H7=()=>{};function uh(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:H7};return e.promise=new se((t,n)=>{e.resolve=r=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(r),e.value=r)},e.reject=r=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,n(r))}}),e}const y_=new Map,C_=new Map,ls=new Map;let Cn=function(e){return e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot",e}({}),at=function(e){return e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger",e}({});const $D=new IY;let Lo=$D.getResult(),Sv=null;function ot(e){if(!Sv){Lo=$D.getResult();const t=function(c){if(c.engine.name==="Blink"&&c.browser.name!=="WeChat")return at.CHROME;switch(c.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return at.CHROME;case"Safari":case"Mobile Safari":return at.SAFARI;case"Edge":return at.EDGE;case"Firefox":return at.FIREFOX;case"QQ":case"QQBrowser":return at.QQ;case"Opera":return at.OPERA;case"WeChat":return at.WECHAT;default:return c.browser.name||""}}(Lo),n=eP(Lo),r=function(c){return c.os.name==="Windows"?c.os.version?c.os.name+" "+c.os.version:c.os.name:c.os.name||""}(Lo),i=Lo.os.version,o=eP(Lo,!1),s=Lo.device.type;if(!(t&&n&&r&&i))return{name:t,version:n,os:r,osVersion:i,browserVersion:o,deviceType:s};Sv={name:t,version:n,os:r,osVersion:i,browserVersion:o,deviceType:s}}return Sv}function eP(e){let t,n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return t=e.engine.name==="Blink"?e.engine.version||"":e.browser.version||"",n?t.split(".")[0]:t}function I_(){return ot().os}function tP(){const e=ot();return"".concat(e.os," ").concat(e.osVersion)}function w_(){const e=ot();return!!(Lo.engine.name==="WebKit"&&e.os===Cn.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==at.SAFARI||sr()&&e.name!==at.SAFARI)}function Fs(){return ot().name===at.CHROME}function Pn(){return ot().name===at.SAFARI}function nP(){const e=ot();if(e.name!==at.SAFARI||!e.browserVersion)return!1;const t=e.browserVersion.split(".");return Number(t[0])>15||Number(t[0])===15&&Number(t[1])>=4}function rP(){return ot().name===at.EDGE}function kt(){return ot().name===at.FIREFOX}function sr(){return ot().os===Cn.IOS}function ko(e){const t=ot();return!(t.name!==at.CHROME||!t.osVersion)&&Number(t.version)>=e}function iP(e){const t=ot();return!(t.name!==at.CHROME||!t.osVersion)&&Number(t.version)<e}function Tv(e,t,n){const r=ot();return!(r.name!==e||!r.osVersion)&&(n?Number(r.version)>=t&&Number(r.version)<=n:Number(r.version)===t)}function Ta(e){const t=ot();return!(t.name!==at.EDGE||!t.osVersion)&&Number(t.version)>=e}function vv(e){const t=ot();return!(t.name!==at.FIREFOX||!t.osVersion)&&Number(t.version)>=e}function oP(e){const t=ot();return!(t.name!==at.SAFARI||!t.osVersion)&&Number(t.version)>=e}function sP(e,t,n){const r=ot();if(r.os!==Cn.IOS||!r.osVersion)return!1;const i=r.osVersion.split(".");return n?t&&Number(i[0])===e&&Number(i[1])>t||Number(i[0])>e:t?Number(i[0])===e&&Number(i[1])>=t||Number(i[0])>e:Number(i[0])>=e}function aP(e,t,n){const r=ot();if(r.os!==Cn.IOS||!r.osVersion)return!1;const i=r.osVersion.split(".");return n?t&&Number(i[0])===e&&Number(i[1])<t||Number(i[0])<e:t?Number(i[0])===e&&Number(i[1])<=t||Number(i[0])<e:Number(i[0])<=e}function Rv(e,t,n){const r=ot();if(r.name!==at.SAFARI||!r.osVersion||!r.browserVersion)return!1;const i=r.browserVersion.split(".");return n?t&&Number(i[0])===e&&Number(i[1])<t||Number(i[0])<e:t?Number(i[0])===e&&Number(i[1])<=t||Number(i[0])<e:Number(i[0])<=e}function Ac(e){const t=ot();return!(t.name!==at.OPERA||!t.osVersion)&&Number(t.version)>=e}function cP(){const e=ot();if(e.os!==Cn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function il(){const e=ot();if(e.os!==Cn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15}function yv(){const e=ot();if(e.os!==Cn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===16}function dP(){const e=ot();if(e.os!==Cn.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function ro(){return Pn()&&navigator.maxTouchPoints>0}function lP(){return ot().name===at.WECHAT}function uP(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function hP(){const e=I_();return function(){const{deviceType:t}=ot();return t==="mobile"||t==="tablet"}()||e===Cn.ANDROID||e===Cn.IOS||e===Cn.HARMONY_OS}function us(){const e=ot();return e.name!==at.EDGE&&e.name!==at.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function hh(){return I_()===Cn.ANDROID}function ph(){const e=ot();return hh()&&(e.name===at.CHROME||e.name===at.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function ke(e,t,n){return(t=function(r){var i=function(o,s){if(typeof o!="object"||!o)return o;var c=o[Symbol.toPrimitive];if(c!==void 0){var l=c.call(o,"string");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(r);return typeof i=="symbol"?i:i+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function pP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function te(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?pP(Object(n),!0).forEach(function(r){ke(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):pP(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}let b=function(e){return e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",e}({}),W=class extends Error{constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",n=arguments.length>2?arguments[2]:void 0;super(t),ke(this,"code",void 0),ke(this,"message",void 0),ke(this,"data",void 0),ke(this,"name","AgoraRTCException"),this.code=e,this.message="AgoraRTCError ".concat(this.code,": ").concat(t),this.data=n}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",t=arguments.length>1?arguments[1]:void 0;return e==="error"&&(t||console).error(this.toString()),e==="warning"&&(t||console).warn(this.toString()),this}throw(e){throw this.print("error",e),this}};function io(e,t){if(typeof e!="boolean")throw new W(b.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function sn(e,t,n){if(!Z(n).call(n,e))throw new W(b.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(n)))}function Ct(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(e<n||e>r||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(i){return typeof i=="number"&&i%1==0}(e))throw new W(b.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(n,", ").concat(r,"]. integer only"))}function Cv(e,t){if(typeof e!="number"){if(!(e.min||e.max||e.ideal||e.exact))throw new W(b.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));e.min!==void 0&&Ct(e.min,"".concat(t,".min"),0,1/0),e.max!==void 0&&Ct(e.max,"".concat(t,".max"),1,1/0),e.exact!==void 0&&Ct(e.exact,"".concat(t,".exact"),1,1/0),e.ideal!==void 0&&Ct(e.ideal,"".concat(t,".ideal"),1,1/0)}else Ct(e,t,1,1/0)}function jn(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,i=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(e==null)throw new W(b.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!fP(e,n,r,i))throw new W(b.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(n,",").concat(r,"].").concat(i?" ASCII characters only.":""))}function Bs(e,t){if(!Array.isArray(e))throw new W(b.INVALID_PARAMS,"".concat(t," should be an array"))}function zt(e){return e==null}function fP(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,r=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof e=="string"&&e.length<=n&&e.length>=t&&(!r||function(i){if(typeof i!="string")return!1;for(let o=0;o<i.length;o+=1){const s=i.charCodeAt(o);if(s<0||s>255)return!1}return!0}(e))}function _P(e,t,n){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,n);const r=e.getUint32(t,n),i=e.getUint32(t+4,n),o=0,s=+!n;return BigInt(r*s+i*o)<<BigInt(32)|BigInt(r*o+i*s)}function mP(e,t,n,r){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,n,r);const i=Number(n>>BigInt(32)),o=Number(n&BigInt(4294967295));e.setUint32(t,i,r),e.setUint32(t+4,o,r)}var fh=function(e){return e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE",e}(fh||{}),Iv=function(e){return e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",e}(Iv||{});const EP=new class{constructor(){ke(this,"_clientSize",null),ke(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),ke(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),ke(this,"getStyle",e=>window.getComputedStyle(e,null)),ke(this,"checkCssVisibleProperty",e=>{var t;let n=!0;const r=this.getStyle(e),{display:i,visibility:o,opacity:s,filter:c}=r;return(i==="none"||Z(t=["hidden","collapse"]).call(t,o)||Number(s)<.1)&&(n=!1),!!n&&(c&&c.split(" ").filter(l=>{var u;const h=l.split("(")[0];return Z(u=["brightness","blur","opacity"]).call(u,h)}).map(l=>{const[u,h]=l.split(/\(|\)/);return[u,Number(h.match(/^[0-9\.]+/))]}).forEach(l=>{const[u,h]=l;switch(u){case"brightness":(h<.1||h>3)&&(n=!1);break;case"blur":h>3&&(n=!1);break;case"opacity":h<.1&&(n=!1)}}),n)}),ke(this,"checkPropertyUpToAllParentNodes",(e,t)=>{let n=!0,r=!0;const i=s=>t(s);let o=e;for(;o&&r;)i(o)||(n=!1,r=!1),o=o.parentElement,o||(r=!1);return n}),ke(this,"checkActualCssVisibleIncludeInherit",e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty)),ke(this,"getSizeAboutClient",e=>{const{width:t,height:n,left:r,right:i,top:o,bottom:s}=e.getBoundingClientRect(),c=this.getClientWidth(),l=this.getClientHeight();return{width:t,height:n,left:r,right:i,top:o,bottom:s,clientWidth:c,clientHeight:l,clientMin:Math.min(c,l)}}),ke(this,"checkActualSize",()=>{const{width:e,height:t,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(e,t,n)}),ke(this,"elementFromPoint",(e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null),ke(this,"checkCoverForAPoint",(e,t,n)=>{const r=this.elementFromPoint(e,t);return r!==null&&r!==n}),ke(this,"getPointPositionList",()=>{const{width:e,height:t,left:n,top:r}=this._clientSize,i=e/6,o=t/6,s=[],c=10**6;for(let l=0;l<5;l++)for(let u=0;u<5;u++){const h=(n*c+(l===0?.1:l===4?(i*l*c-1e5)/c:i*l)*c)/c,f=(r*c+(u===0?.1:u===4?(o*u*c-1e5)/c:o*u)*c)/c;s.push({x:h,y:f})}return[...s]}),ke(this,"checkElementCover",e=>this.getPointPositionList().map(t=>this.checkCoverForAPoint(t.x,t.y,e)).filter(t=>!!t).length>6),ke(this,"checkSizeIsVisible",(e,t,n)=>(e>50||n/e<=10)&&(t>50||n/t<=10)),ke(this,"checkSizeOfPartInClient",()=>{const{left:e,right:t,top:n,bottom:r,clientHeight:i,clientWidth:o,clientMin:s}=this._clientSize;let c,l,u,h;if(e<0)c=0;else{if(!(e<o))return!1;c=e}if(t<0)return!1;if(l=t<o?t:o,n<0)u=0;else{if(!(n<i))return!1;u=n}if(r<0)return!1;h=r<i?r:i;const f=l-c,_=h-u;return this.checkSizeIsVisible(f,_,s)}),ke(this,"returnHiddenResult",e=>(this._clientSize=null,{visible:!1,reason:e})),ke(this,"checkOneElementVisible",e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(fh.COVERED);{const t=this.checkActualSize(),n=this.checkSizeOfPartInClient();return t&&!n?this.returnHiddenResult(fh.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(fh.SIZE)}}return this.returnHiddenResult(fh.STYLE)}return this.returnHiddenResult(Iv.UNMOUNTED)}return this.returnHiddenResult(Iv.INVALID_HTML_ELEMENT)}),ke(this,"checkElementIsMountedOnDom",e=>this.checkPropertyUpToAllParentNodes(e,t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))}};function wv(e){return new TextEncoder().encode(e)}const gP=function(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n},Av=async e=>function(t,n){let r="";return new Uint8Array(t).forEach(i=>{r+=i.toString(n).padStart(2,"0")}),r}(await crypto.subtle.digest("SHA-256",wv(e)),16);let Wt=class{constructor(){ke(this,"_events",{}),ke(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map(t=>t.listener):[]}on(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];this._indexOfListener(n,t)===-1&&n.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);const n=this._events[e];this._indexOfListener(n,t)===-1&&n.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;const n=this._events[e],r=this._indexOfListener(n,t);r!==-1&&n.splice(r,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);const t=this._events[e].map(o=>o);for(var n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];for(let o=0;o<t.length;o+=1){const s=t[o];s.once&&this.off(e,s.listener),s.listener.apply(this,r||[])}}safeEmit(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];[...this._events[e]||[]].forEach(i=>{i.once&&this.off(e,i.listener);try{i.listener.apply(this,n)}catch(o){console.error("safeEmit event:".concat(e," error ").concat(o==null?void 0:o.toString()))}})}_indexOfListener(e,t){let n=e.length;for(;n--;)if(e[n].listener===t)return n;return-1}},_h=null;function SP(){if(_h)return _h;if(window.electron)return _h=window.electron;if(!window.require)return null;try{return _h=window.require("electron"),_h}catch{return null}}let Ft=function(e){return e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.PRELOAD="PRELOAD",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload",e.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",e.PRELOAD_MEDIA_FAILED="preloadMediaFailed",e.MISMATCH_DTLS_PARAMETERS="mismatchDtlsParameters",e.VOS_FALLBACK_CN="vosFallbackCN",e.DATACHANNEL_FAILBACK="datachannelFailback",e}({}),It=function(e){return e.TRACER="tracer",e}({});function TP(e){return Ct(e.timeout,"config.timeout",0,1e5),Ct(e.timeoutFactor,"config.timeoutFactor",0,100,!1),Ct(e.maxRetryCount,"config.maxRetryConfig",0,1/0),Ct(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let K7=function(e){return e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",e}({}),Ze=function(e){return e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.FALLBACK="FALLBACK",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e.FALLBACK_TO_HLS="FALLBACK_TO_HLS",e.UID_CONFLICT="UID_CONFLICT",e}({});function bc(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach(t=>{if(!t.urls)throw Error()})}catch{return!1}return!0}function vP(e){return jn(e.turnServerURL,"turnServerURL"),jn(e.username,"username"),jn(e.password,"password"),e.udpport&&Ct(e.udpport,"udpport",1,99999,!0),e.forceturn&&io(e.forceturn,"forceturn"),e.security&&io(e.security,"security"),e.tcpport&&Ct(e.tcpport,"tcpport",1,99999,!0),!0}let ol=function(e){return e[e.AUTO_SIMULCAST_STREAM=-1]="AUTO_SIMULCAST_STREAM",e[e.DISABLE_SIMULCAST_STREM=0]="DISABLE_SIMULCAST_STREM",e[e.ENABLE_SIMULCAST_STREAM=1]="ENABLE_SIMULCAST_STREAM",e}({});function bv(e){return e.level!==void 0&&sn(e.level,"level",[1,2,3]),e.delay!==void 0&&Ct(e.delay,"delay",0,3e3,!0),!0}let Ke=function(e){return e.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",e.AUDIO_METADATA="audio-metadata",e.AUDIO_PTS="audio-pts",e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",e.FALLBACK_TO_HLS="fallback-to-hls",e.FIRST_VIDEO_BUFFER_READY="first-video-buffer-ready",e.FIRST_VIDEO_PRE_RENDER="first-video-pre-render",e.AV1_DECODABLE_RESULT="av1-decodable-result",e}({}),Ov=function(e){return e.CONFIG="config",e.VOSERROR="vos_error",e.AP_ERROR="ap_error",e}({}),zn=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",e}({}),Er=function(e){return e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({}),Oc=function(e){return e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({});function hn(e,t){for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return e.getListeners(t).length===0?se.reject(new W(b.UNEXPECTED_ERROR,"can not emit promise")):new se((o,s)=>{e.emit(t,...r,o,s)})}function Ot(e,t){if(e.getListeners(t).length===0)return se.resolve();for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return hn(e,t,...r)}function ni(e,t){if(e.getListeners(t).length===0)return null;for(var n=arguments.length,r=new Array(n>2?n-2:0),i=2;i<n;i++)r[i-2]=arguments[i];return Nc(e,t,...r)}function Nc(e,t){let n=null,r=null;for(var i=arguments.length,o=new Array(i>2?i-2:0),s=2;s<i;s++)o[s-2]=arguments[s];if(e.emit(t,...o,c=>{n=c},c=>{r=c}),r!==null)throw r;if(n===null)throw new W(b.UNEXPECTED_ERROR,"handler is not sync");return n}const qt=new class extends Wt{set networkState(e){this.emit(Oc.NETWORK_STATE_CHANGE,e,this._networkState),e===Er.ONLINE?this.emit(Oc.ONLINE):e===Er.OFFLINE&&(this.onlineWaiter=new se(t=>{this.once(Oc.ONLINE,()=>{this.onlineWaiter=void 0,t(Er.ONLINE)})}),this.emit(Oc.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===Er.ONLINE}constructor(){super(),ke(this,"_moduleName","network-indicator"),ke(this,"_networkState",Er.ONLINE),ke(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Er.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Er.OFFLINE})}},Or=[];for(let e=0;e<256;++e)Or.push((e+256).toString(16).slice(1));const RP=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);let Nv;const Y7=new Uint8Array(16);function z7(){return RP?RP():function(n,r,i){var o,s,c,l;const u=(o=(s=(n=n||{}).random)!==null&&s!==void 0?s:(c=(l=n).rng)===null||c===void 0?void 0:c.call(l))!==null&&o!==void 0?o:function(){if(!Nv){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Nv=crypto.getRandomValues.bind(crypto)}return Nv(Y7)}();if(u.length<16)throw new Error("Random bytes length must be >= 16");if(u[6]=15&u[6]|64,u[8]=63&u[8]|128,r){if((i=i||0)<0||i+16>r.length)throw new RangeError("UUID byte range ".concat(i,":").concat(i+15," is out of buffer bounds"));for(let h=0;h<16;++h)r[i+h]=u[h];return r}return function(h){let f=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0;return(Or[h[f+0]]+Or[h[f+1]]+Or[h[f+2]]+Or[h[f+3]]+"-"+Or[h[f+4]]+Or[h[f+5]]+"-"+Or[h[f+6]]+Or[h[f+7]]+"-"+Or[h[f+8]]+Or[h[f+9]]+"-"+Or[h[f+10]]+Or[h[f+11]]+Or[h[f+12]]+Or[h[f+13]]+Or[h[f+14]]+Or[h[f+15]]).toLowerCase()}(u)}(e,t,void 0);var e,t}function A_(e,t){const n=e.indexOf(t);n!==-1&&e.splice(n,1)}function sl(e){const t=[];return e.forEach(n=>{t.indexOf(n)===-1&&t.push(n)}),t}function b_(e){se!==void 0?se.resolve().then(e):setTimeout(e,0)}function Mt(e){return JSON.parse(JSON.stringify(e))}function Dc(e){try{return Mt(e)}catch{return e}}const yP={};function va(e,t){yP[t]||(yP[t]=!0,e())}function Pc(e){const t=window.atob(e),n=new Uint8Array(new ArrayBuffer(t.length));for(let r=0;r<t.length;r+=1)n[r]=t.charCodeAt(r);return n}function Ra(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return window.btoa(t)}function CP(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=new TextEncoder().encode(e);if(n.length>t)n=n.slice(0,t);else if(n.length<t){const r=new Uint8Array(t);r.set(n),n=r}return n}function IP(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=Di(t).call(t,(s,c)=>s+c.length,0),i=new Uint8Array(new ArrayBuffer(r));let o=0;return t.forEach(s=>{i.set(s,o),o+=s.length}),i}function hs(e){return window.TextEncoder?new TextEncoder().encode(e).length:e.length}function wP(e){let t=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&e.realFormData&&(e=e.realFormData),e.forEach(n=>{t+=typeof n=="string"?hs(n):n.size}),t+138}function q7(e){const t=new W(b.TIMEOUT,"timeout");return new se((n,r)=>{window.setTimeout(()=>r(t),e)})}function In(e){return new se(t=>{window.setTimeout(t,e)})}function _t(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,e).toLowerCase();return n.length===e?"".concat(t).concat(n):"".concat(t).concat(n)+_t(e-n.length,"")}function Lc(){let e,t=!1;try{var n;e=CY(n=z7()).call(n,"-","")}catch{t=!0}return!t&&e&&e.length===32||(e=_t(32,"")),e.toUpperCase()}const mh=()=>{},AP=new class{constructor(){ke(this,"fnMap",new Map)}throttleByKey(e,t,n,r){for(var i=arguments.length,o=new Array(i>4?i-4:0),s=4;s<i;s++)o[s-4]=arguments[s];if(this.fnMap.has(t)){const c=this.fnMap.get(t);if(c.threshold!==n){c.fn(...c.args),clearTimeout(c.timer);const l=window.setTimeout(()=>{const u=this.fnMap.get(t);u&&u.fn(...u.args),this.fnMap.delete(t)},n);this.fnMap.set(t,{fn:e,threshold:n,timer:l,args:o,skipFn:r})}else c.skipFn&&c.skipFn(...c.args),this.fnMap.set(t,te(te({},c),{},{fn:e,args:o,skipFn:r}))}else{const c=window.setTimeout(()=>{const l=this.fnMap.get(t);l&&l.fn(...l.args),this.fnMap.delete(t)},n);this.fnMap.set(t,{fn:e,threshold:n,timer:c,args:o,skipFn:r})}}},bP=AP.throttleByKey.bind(AP);function OP(e){return typeof e=="object"&&e!==null&&!(e instanceof RegExp)}function Dv(e,t){if(!OP(e)||!OP(t)||Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){const n=[...e];for(let r=0;r<t.length;r++)n[r]=Dv(e[r],t[r]);return n}{const n=te({},e);for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(Object.prototype.hasOwnProperty.call(e,r)?n[r]=Dv(e[r],t[r]):n[r]=t[r]);return n}}function NP(e,t){let n=[0];if(n=new Array(t).fill(0),e===0)return n;let r=0;for(;e>0&&(n[r]=255&e,e>>=8,r++,r!==t););return n}function al(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function Pv(e,t){try{return typeof e=="object"&&typeof t=="object"&&JSON.stringify(e)===JSON.stringify(t)}catch{return!1}}function Lv(e){return Di(e).call(e,(t,n)=>t+n,0)}function DP(e){const t="0123456789abcdef";function n(P){let M,U="";for(M=0;M<=3;M++)U+=t.charAt(P>>8*M+4&15)+t.charAt(P>>8*M&15);return U}function r(P,M){const U=(65535&P)+(65535&M);return(P>>16)+(M>>16)+(U>>16)<<16|65535&U}function i(P,M,U,L,V,H){return r(function(q,de){return q<<de|q>>>32-de}(r(r(M,P),r(L,H)),V),U)}function o(P,M,U,L,V,H,q){return i(M&U|~M&L,P,M,V,H,q)}function s(P,M,U,L,V,H,q){return i(M&L|U&~L,P,M,V,H,q)}function c(P,M,U,L,V,H,q){return i(M^U^L,P,M,V,H,q)}function l(P,M,U,L,V,H,q){return i(U^(M|~L),P,M,V,H,q)}const u=function(P){let M;const U=1+(P.length+8>>6),L=new Array(16*U);for(M=0;M<16*U;M++)L[M]=0;for(M=0;M<P.length;M++)L[M>>2]|=P.charCodeAt(M)<<M%4*8;return L[M>>2]|=128<<M%4*8,L[16*U-2]=8*P.length,L}(e);let h,f,_,E,I,v=1732584193,R=-271733879,A=-1732584194,O=271733878;for(h=0;h<u.length;h+=16)f=v,_=R,E=A,I=O,v=o(v,R,A,O,u[h+0],7,-680876936),O=o(O,v,R,A,u[h+1],12,-389564586),A=o(A,O,v,R,u[h+2],17,606105819),R=o(R,A,O,v,u[h+3],22,-1044525330),v=o(v,R,A,O,u[h+4],7,-176418897),O=o(O,v,R,A,u[h+5],12,1200080426),A=o(A,O,v,R,u[h+6],17,-1473231341),R=o(R,A,O,v,u[h+7],22,-45705983),v=o(v,R,A,O,u[h+8],7,1770035416),O=o(O,v,R,A,u[h+9],12,-1958414417),A=o(A,O,v,R,u[h+10],17,-42063),R=o(R,A,O,v,u[h+11],22,-1990404162),v=o(v,R,A,O,u[h+12],7,1804603682),O=o(O,v,R,A,u[h+13],12,-40341101),A=o(A,O,v,R,u[h+14],17,-1502002290),R=o(R,A,O,v,u[h+15],22,1236535329),v=s(v,R,A,O,u[h+1],5,-165796510),O=s(O,v,R,A,u[h+6],9,-1069501632),A=s(A,O,v,R,u[h+11],14,643717713),R=s(R,A,O,v,u[h+0],20,-373897302),v=s(v,R,A,O,u[h+5],5,-701558691),O=s(O,v,R,A,u[h+10],9,38016083),A=s(A,O,v,R,u[h+15],14,-660478335),R=s(R,A,O,v,u[h+4],20,-405537848),v=s(v,R,A,O,u[h+9],5,568446438),O=s(O,v,R,A,u[h+14],9,-1019803690),A=s(A,O,v,R,u[h+3],14,-187363961),R=s(R,A,O,v,u[h+8],20,1163531501),v=s(v,R,A,O,u[h+13],5,-1444681467),O=s(O,v,R,A,u[h+2],9,-51403784),A=s(A,O,v,R,u[h+7],14,1735328473),R=s(R,A,O,v,u[h+12],20,-1926607734),v=c(v,R,A,O,u[h+5],4,-378558),O=c(O,v,R,A,u[h+8],11,-2022574463),A=c(A,O,v,R,u[h+11],16,1839030562),R=c(R,A,O,v,u[h+14],23,-35309556),v=c(v,R,A,O,u[h+1],4,-1530992060),O=c(O,v,R,A,u[h+4],11,1272893353),A=c(A,O,v,R,u[h+7],16,-155497632),R=c(R,A,O,v,u[h+10],23,-1094730640),v=c(v,R,A,O,u[h+13],4,681279174),O=c(O,v,R,A,u[h+0],11,-358537222),A=c(A,O,v,R,u[h+3],16,-722521979),R=c(R,A,O,v,u[h+6],23,76029189),v=c(v,R,A,O,u[h+9],4,-640364487),O=c(O,v,R,A,u[h+12],11,-421815835),A=c(A,O,v,R,u[h+15],16,530742520),R=c(R,A,O,v,u[h+2],23,-995338651),v=l(v,R,A,O,u[h+0],6,-198630844),O=l(O,v,R,A,u[h+7],10,1126891415),A=l(A,O,v,R,u[h+14],15,-1416354905),R=l(R,A,O,v,u[h+5],21,-57434055),v=l(v,R,A,O,u[h+12],6,1700485571),O=l(O,v,R,A,u[h+3],10,-1894986606),A=l(A,O,v,R,u[h+10],15,-1051523),R=l(R,A,O,v,u[h+1],21,-2054922799),v=l(v,R,A,O,u[h+8],6,1873313359),O=l(O,v,R,A,u[h+15],10,-30611744),A=l(A,O,v,R,u[h+6],15,-1560198380),R=l(R,A,O,v,u[h+13],21,1309151649),v=l(v,R,A,O,u[h+4],6,-145523070),O=l(O,v,R,A,u[h+11],10,-1120210379),A=l(A,O,v,R,u[h+2],15,718787259),R=l(R,A,O,v,u[h+9],21,-343485551),v=r(v,f),R=r(R,_),A=r(A,E),O=r(O,I);return n(v)+n(R)+n(A)+n(O)}let X7=1,PP=console,Ln=class{static setLogger(e){PP=e}constructor(e,t){ke(this,"id",void 0),ke(this,"lockingPromise",se.resolve()),ke(this,"locks",0),ke(this,"name",""),ke(this,"lockId",void 0),this.lockId=X7++,e&&(this.name=e),t&&(this.id=t),this.logger("created")}logger(e,t){const n=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),r=e==="created"?"is ".concat(e,"."):"is ".concat(e,", current queue ").concat(this.locks,". ").concat(t??"");PP.debug("".concat(n," ").concat(r))}setId(e){this.id=e}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,this.logger("locked",e);const n=new se(i=>{t=()=>{this.locks-=1,this.logger("unlocked",e),i()}}),r=this.lockingPromise.then(()=>t);return this.lockingPromise=this.lockingPromise.then(()=>n),r}};function cl(e,t){return function(n,r,i){const o=i.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){const s=this[t];if(!s)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const c=await s.lock("From ".concat(e,".").concat(r));try{for(var l=arguments.length,u=new Array(l),h=0;h<l;h++)u[h]=arguments[h];return await o.apply(this,u)}finally{c()}},i}}const an={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function O_(e,t){const n=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,n)}function Mo(e,t,n,r){const i=Object.assign({},an,r);let o=i.timeout;const s=async()=>{await function(u){return new se(h=>{window.setTimeout(h,u)})}(o),o*=i.timeoutFactor,o=Math.min(i.maxRetryTimeout,o)};let c=!1;const l=new se(async(u,h)=>{t=t||(()=>!1),n=n||(()=>!0);for(let f=0;f<i.maxRetryCount;f+=1){if(c)return h(new W(b.OPERATION_ABORTED));try{const _=await e();if(!t(_,f)||f+1===i.maxRetryCount)return u(_);await s()}catch(_){if(!n(_,f)||f+1===i.maxRetryCount)return h(_);await s()}}});return l.cancel=()=>c=!0,l}let N_,kv=class{constructor(e){ke(this,"input",[]),ke(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}mean(){var e;return this.input.length===0?0:Di(e=this.input).call(e,(t,n)=>t+n)/this.input.length}},D_=0,Mv=0;function Uv(e,t,n,r){return new se((i,o)=>{t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),D_+=hs(t.data)):n&&(t.data.size?D_+=t.data.size:t.data instanceof FormData?D_+=wP(t.data):D_+=hs(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,br.request(t).then(s=>{typeof s.data=="string"?Mv+=hs(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?Mv+=s.data.byteLength:Mv+=hs(JSON.stringify(s.data)),i(s.data)}).catch(s=>{br.isCancel(s)?o(new W(b.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new W(b.NETWORK_TIMEOUT,s.message)):s.response?o(new W(b.NETWORK_RESPONSE_ERROR,s.response.status)):o(new W(b.NETWORK_ERROR,s.message))})})}async function J7(e,t){const n=new Blob([t.data],{type:"buffer"});return await Uv(e,te(te({},t),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}const LP=()=>window.isSecureContext!==void 0;function oo(e){if(Array.isArray(e))return e.map(n=>n);if(!kP(e))return e;const t={};for(const n in e){const r=e[n];kP(r)||Array.isArray(r)?t[n]=oo(r):t[n]=r}return t}function kP(e){return!(typeof e!="object"||Array.isArray(e)||!e)}let xv=class{constructor(e){ke(this,"input",[]),ke(this,"size",void 0),this.size=e}add(e){this.input.push(e),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}};const so={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Eh={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],transport:{bytesSent:0,bytesReceived:0,packetsSent:0,packetsReceived:0},selectedCandidatePair:{id:"unknown",localCandidate:so,remoteCandidate:so},updateInterval:0},MP={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},UP={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},xP={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},VP={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0};let Vv=class{constructor(e,t){ke(this,"onFirstVideoReceived",void 0),ke(this,"onFirstVideoDecoded",void 0),ke(this,"onFirstAudioReceived",void 0),ke(this,"onFirstVideoDecodedTimeout",void 0),ke(this,"onFirstAudioDecoded",void 0),ke(this,"onSelectedLocalCandidateChanged",void 0),ke(this,"onSelectedRemoteCandidateChanged",void 0),ke(this,"videoIsReady",!1),ke(this,"videoIsReady2",{}),ke(this,"pc",void 0),ke(this,"options",void 0),ke(this,"intervalTimer",void 0),ke(this,"stats",oo(Eh)),ke(this,"isFirstVideoReceived",{}),ke(this,"isFirstVideoDecoded",{}),ke(this,"isFirstAudioReceived",{}),ke(this,"isFirstAudioDecoded",{}),ke(this,"isFirstVideoDecodedTimeout",{}),ke(this,"lossRateWindowStats",[]),this.pc=e,this.options=t,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new se(e=>{e({local:te({},so),remote:te({},so)})})}setVideoIsReady(e){this.videoIsReady=e}setVideoIsReady2(e,t){this.videoIsReady2[e]=t}getVideoIsReady(e){return this.videoIsReady2[e]||!1}setIsFirstAudioDecoded(e){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(e){this.lossRateWindowStats.push(e),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const t=this.lossRateWindowStats.length,n=["videoSend","audioSend","videoRecv","audioRecv"];let r=0,i=0,o=0,s=0;for(const c of n)e[c].forEach((l,u)=>{if(!this.lossRateWindowStats[t-1][c][u]||!this.lossRateWindowStats[0][c][u])return;const h=this.lossRateWindowStats[t-1][c][u].packets-this.lossRateWindowStats[0][c][u].packets,f=this.lossRateWindowStats[t-1][c][u].packetsLost-this.lossRateWindowStats[0][c][u].packetsLost;c==="videoSend"||c==="audioSend"?(r+=h,o+=f):(i+=h,s+=f),Number.isNaN(h)||Number.isNaN(h)?l.packetLostRate=0:l.packetLostRate=h<=0||f<=0?0:f/(h+f)});e.sendPacketLossRate=r<=0||o<=0?0:o/(r+o),e.recvPacketLossRate=i<=0||s<=0?0:s/(i+s)}},Q7=class extends Vv{constructor(){super(...arguments),ke(this,"_stats",Eh),ke(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){const e=await this._getStats(),t=this.statsResponsesToObjects(e);this._stats=oo(Eh);const n=t.filter(i=>i.type==="ssrc");this.processSSRCStats(n);const r=t.find(i=>i.type==="VideoBwe");r&&this.processBandwidthStats(r),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(e){this._stats.bitrate={actualEncoded:Number(e.googActualEncBitrate),targetEncoded:Number(e.googTargetEncBitrate),retransmit:Number(e.googRetransmitBitrate),transmit:Number(e.googTransmitBitrate)},this._stats.sendBandwidth=Number(e.googAvailableSendBandwidth)}processSSRCStats(e){e.forEach(t=>{var n;const r=Z(n=t.id).call(n,"send");switch("".concat(t.mediaType,"_").concat(r?"send":"recv")){case"video_send":{const i=oo(UP);i.codec=t.googCodecName,i.adaptionChangeReason="none",t.googCpuLimitedResolution&&(i.adaptionChangeReason="cpu"),t.googBandwidthLimitedResolution&&(i.adaptionChangeReason="bandwidth"),i.avgEncodeMs=Number(t.googAvgEncodeMs),i.inputFrame={width:Number(t.googFrameWidthInput)||Number(t.googFrameWidthSent),height:Number(t.googFrameHeightInput)||Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},i.sentFrame={width:Number(t.googFrameWidthSent),height:Number(t.googFrameHeightSent),frameRate:Number(t.googFrameRateInput)},i.firsCount=Number(t.googFirReceived),i.nacksCount=Number(t.googNacksReceived),i.plisCount=Number(t.googPlisReceived),i.frameCount=Number(t.framesEncoded),i.bytes=Number(t.bytesSent),i.packets=Number(t.packetsSent),i.packetsLost=Number(t.packetsLost),i.ssrc=Number(t.ssrc),i.rttMs=Number(t.googRtt||0),this._stats.videoSend.push(i),this._stats.rtt=i.rttMs;break}case"video_recv":{const i=oo(MP),o=this.lastDecodeVideoReceiverStats.get(Number(t.ssrc));if(i.codec=t.googCodecName,i.targetDelayMs=Number(t.googTargetDelayMs),i.renderDelayMs=Number(t.googRenderDelayMs),i.currentDelayMs=Number(t.googCurrentDelayMs),i.minPlayoutDelayMs=Number(t.googMinPlayoutDelayMs),i.decodeMs=Number(t.googDecodeMs),i.maxDecodeMs=Number(t.googMaxDecodeMs),i.receivedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateReceived)},i.decodedFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateDecoded)},i.decodeFrameRate=Number(t.googFrameRateDecoded),i.outputFrame={width:Number(t.googFrameWidthReceived),height:Number(t.googFrameHeightReceived),frameRate:Number(t.googFrameRateOutput)},i.jitterBufferMs=Number(t.googJitterBufferMs),i.firsCount=Number(t.googFirsSent),i.nacksCount=Number(t.googNacksSent),i.plisCount=Number(t.googPlisSent),i.framesDecodeCount=Number(t.framesDecoded),i.bytes=Number(t.bytesReceived),i.packets=Number(t.packetsReceived),i.packetsLost=Number(t.packetsLost),i.ssrc=Number(t.ssrc),i.packets>0&&!this.isFirstVideoReceived[i.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(i.ssrc),this.isFirstVideoReceived[i.ssrc]=!0),i.framesDecodeCount>0&&!this.isFirstVideoDecoded[i.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(i.ssrc,i.decodedFrame.width,i.decodedFrame.height),this.isFirstVideoDecoded[i.ssrc]=!0),o){const s=o.stats,c=Date.now()-o.lts;i.framesDecodeFreezeTime=s.framesDecodeFreezeTime,i.framesDecodeInterval=s.framesDecodeInterval,i.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[i.ssrc]?(o.lts=Date.now(),i.framesDecodeInterval=c,i.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc,10))?i.framesDecodeFreezeTime+=i.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):i.framesDecodeCount<o.stats.framesDecodeCount&&(i.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(i.ssrc,{stats:te({},i),lts:Date.now()}),this._stats.videoRecv.push(i);break}case"audio_recv":{const i=oo(VP);i.codec=t.googCodecName,i.outputLevel=Math.abs(Number(t.audioOutputLevel))/32767,i.decodingCNG=Number(t.googDecodingCNG),i.decodingCTN=Number(t.googDecodingCTN),i.decodingCTSG=Number(t.googDecodingCTSG),i.decodingNormal=Number(t.googDecodingNormal),i.decodingPLC=Number(t.googDecodingPLC),i.decodingPLCCNG=Number(t.googDecodingPLCCNG),i.expandRate=Number(t.googExpandRate),i.accelerateRate=Number(t.googAccelerateRate),i.preemptiveExpandRate=Number(t.googPreemptiveExpandRate),i.secondaryDecodedRate=Number(t.googSecondaryDecodedRate),i.speechExpandRate=Number(t.googSpeechExpandRate),i.preferredJitterBufferMs=Number(t.googPreferredJitterBufferMs),i.jitterBufferMs=Number(t.googJitterBufferMs),i.jitterMs=Number(t.googJitterReceived),i.bytes=Number(t.bytesReceived),i.packets=Number(t.packetsReceived),i.packetsLost=Number(t.packetsLost),i.ssrc=Number(t.ssrc),i.receivedFrames=Number(t.googDecodingCTN)||Number(t.packetsReceived),i.droppedFrames=Number(t.googDecodingPLC)+Number(t.googDecodingPLCCNG)||Number(t.packetsLost),i.receivedFrames>0&&!this.isFirstAudioReceived[i.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(i.ssrc),this.isFirstAudioReceived[i.ssrc]=!0),i.decodingNormal>0&&!this.isFirstAudioDecoded[i.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(i.ssrc),this.isFirstAudioDecoded[i.ssrc]=!0),this._stats.audioRecv.push(i);break}case"audio_send":{const i=oo(xP);i.codec=t.googCodecName,i.inputLevel=Math.abs(Number(t.audioInputLevel))/32767,i.aecReturnLoss=Number(t.googEchoCancellationReturnLoss||0),i.aecReturnLossEnhancement=Number(t.googEchoCancellationReturnLossEnhancement||0),i.residualEchoLikelihood=Number(t.googResidualEchoLikelihood||0),i.residualEchoLikelihoodRecentMax=Number(t.googResidualEchoLikelihoodRecentMax||0),i.bytes=Number(t.bytesSent),i.packets=Number(t.packetsSent),i.packetsLost=Number(t.packetsLost),i.ssrc=Number(t.ssrc),i.rttMs=Number(t.googRtt||0),this._stats.rtt=i.rttMs,this._stats.audioSend.push(i);break}}})}_getStats(){return new se((e,t)=>{this.pc.getStats(e,t)})}statsResponsesToObjects(e){const t=[];return e.result().forEach(n=>{const r={id:n.id,timestamp:n.timestamp.valueOf().toString(),type:n.type};n.names().forEach(i=>{r[i]=n.stat(i)}),t.push(r)}),t}},dl=function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e}({}),P_=function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L1T3_KEY="L1T3_KEY",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e}({}),Fv=function(e){return e[e.new=0]="new",e[e.connecting=1]="connecting",e[e.connected=2]="connected",e[e.disconnected=3]="disconnected",e[e.failed=4]="failed",e[e.closed=5]="closed",e}({}),pi=function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e}({});var ll=function(e){return e[e.kNone=1]="kNone",e[e.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",e[e.kBytesToBits=8]="kBytesToBits",e}(ll||{});function gh(e,t,n,r){let i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:ll.kNone;if(!t)return;const o=Number(t[n]);if(typeof o!="number")return;const s=Number(t[r]);if(typeof s!="number")return;if(!e)return s?o/s*i:void 0;const c=Number(e[n]);if(typeof c!="number")return;const l=Number(e[r]);if(typeof l!="number")return;const u=s-l;return u?(o-c)/u*i:void 0}let FP=class extends Vv{constructor(){super(...arguments),ke(this,"_stats",Eh),ke(this,"report",void 0),ke(this,"lastDecodeVideoReceiverStats",new Map),ke(this,"lastVideoFramesRecv",new Map),ke(this,"lastVideoFramesSent",new Map),ke(this,"lastVideoFramesDecode",new Map),ke(this,"lastVideoFramesOutput",new Map),ke(this,"lastVideoJBDelay",new Map),ke(this,"lastAudioJBDelay",new Map),ke(this,"mediaBytesSent",new Map),ke(this,"mediaBytesRetransmit",new Map),ke(this,"mediaBytesTargetEncode",new Map),ke(this,"lastDecodeAudioReceiverStats",new Map),ke(this,"lastAudioConcealment",new Map),ke(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=oo(Eh),this.report.forEach(e=>{switch(e.type){case pi.OUTBOUND:case pi.INBOUND:{const t=e.mediaType||e.kind,n=!t&&"frameWidth"in e,r=!t&&!("frameWidth"in e);e.type===pi.OUTBOUND?t==="audio"||r?this.processAudioOutboundStats(e):(t==="video"||n)&&this.processVideoOutboundStats(e):e.type===pi.INBOUND&&(t==="audio"||r?this.processAudioInboundStats(e):(t==="video"||n)&&this.processVideoInboundStats(e));break}case pi.TRANSPORT:{this.processTransportStats(e);const t=this.report.get(e.selectedCandidatePairId);t&&this.processCandidatePairStats(t);break}case pi.CANDIDATE_PAIR:e.selected&&this.processCandidatePairStats(e)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const e=await this.pc.getStats(),t={local:te({},so),remote:te({},so)};return e.forEach(n=>{let r;if(n.type===pi.TRANSPORT&&(r=e.get(n.selectedCandidatePairId)),n.type===pi.CANDIDATE_PAIR&&n.selected&&(r=n),r){const i=(o,s)=>{o.type=s.type,o.id=s.id,s.address&&(o.address=s.address),s.candidateType&&(o.candidateType=s.candidateType),s.port&&(o.port=s.port),s.priority&&(o.priority=s.priority),s.protocol&&(o.protocol=s.protocol),s.relayProtocol&&(o.relayProtocol=s.relayProtocol)};if(r.localCandidateId){const o=e.get(r.localCandidateId);o&&i(t.local,o)}if(r.remoteCandidateId){const o=e.get(r.remoteCandidateId);o&&i(t.remote,o)}}}),t}processCandidatePairStats(e){if(this._stats.sendBandwidth=e.availableOutgoingBitrate||0,e.currentRoundTripTime&&(this._stats.rtt=1e3*e.currentRoundTripTime),this._stats.videoSend.forEach(t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)}),this._stats.audioSend.forEach(t=>{e.currentRoundTripTime&&(t.rttMs=1e3*e.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=e.id,e.localCandidateId){const t=this.report.get(e.localCandidateId);t&&this.processCandidateStats(t)}if(e.remoteCandidateId){const t=this.report.get(e.remoteCandidateId);t&&this.processCandidateStats(t)}}processCandidateStats(e){let t;e.type===pi.LOCAL_CANDIDATE&&(t=this._stats.selectedCandidatePair.localCandidate),e.type===pi.REMOTE_CANDIDATE&&(t=this._stats.selectedCandidatePair.remoteCandidate),t&&(t.type=e.type,t.id=e.id,e.address&&(t.address=e.address),e.candidateType&&(t.candidateType=e.candidateType),e.port&&(t.port=e.port),e.priority&&(t.priority=e.priority),e.protocol&&(t.protocol=e.protocol),e.relayProtocol&&(t.relayProtocol=e.relayProtocol),e.type===pi.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==t.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(te({},t),te({},this.stats.selectedCandidatePair.localCandidate)),e.type===pi.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==t.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(te({},t),te({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(e){let t=this._stats.audioRecv.find(r=>r.ssrc===e.ssrc);t||(t=oo(VP),this._stats.audioRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.packetsDiscarded=e.packetsDiscarded,t.bytes=e.bytesReceived,t.jitterMs=1e3*e.jitter,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.totalProcessingDelay=e.totalProcessingDelay,t.jitterBufferEmittedCount=e.jitterBufferEmittedCount,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const n=this.lastDecodeAudioReceiverStats.get(t.ssrc);t.avgProcessingDelayMs=gh(n,t,"totalProcessingDelay","jitterBufferEmittedCount",ll.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(e,e.trackId,t),this.calculateAudioFreeze(t,n,e),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),t.receivedFrames||(t.receivedFrames=e.packetsReceived),t.droppedFrames||(t.droppedFrames=e.packetsLost),t.receivedFrames>0&&!this.isFirstAudioReceived[t.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(t.ssrc),this.isFirstAudioReceived[t.ssrc]=!0),t.outputLevel&&t.outputLevel>0&&!this.isFirstAudioDecoded[t.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(t.ssrc),this.isFirstAudioDecoded[t.ssrc]=!0),typeof e.concealedSamples=="number"&&(t.concealedSamples=e.concealedSamples),this.lastDecodeAudioReceiverStats.set(t.ssrc,te({},t))}calculateAudioFreeze(e,t,n){const r=this.lastAudioConcealment.get(e.ssrc);if(t!=null&&r!=null){const i=r.lts,o=n.timestamp,s=o-i;if(s<=0)return;const c=e.concealedSamples-t.concealedSamples-0,l=r.nonSilent+c,u=e.totalSamplesReceived-t.totalSamplesReceived;if(u<=0)return;const h=80*u/s,f=200*u/s,_=s/u;let E=0;e.freezeSamples80=t.freezeSamples80,e.freezeMs80=t.freezeMs80,l>h&&(r.plc80>0?(e.freezeSamples80+=c,e.freezeMs80+=Math.round(c*_)):(e.freezeSamples80+=l,e.freezeMs80+=Math.round(l*_)),E=r.plc80+1);let I=0;e.freezeSamples200=t.freezeSamples200,e.freezeMs200=t.freezeMs200,l>f&&(r.plc200>0?(e.freezeSamples200+=c,e.freezeMs200+=Math.round(c*_)):(e.freezeSamples200+=l,e.freezeMs200+=Math.round(l*_)),I=r.plc200+1),this.lastAudioConcealment.set(e.ssrc,{nonSilent:c,lts:o,plc80:E,plc200:I})}else e.freezeSamples80=0,e.freezeSamples200=0,e.freezeMs80=0,e.freezeMs200=0,this.lastAudioConcealment.set(e.ssrc,{nonSilent:0,lts:n.timestamp,plc80:0,plc200:0})}processVideoInboundStats(e){let t=this._stats.videoRecv.find(s=>s.ssrc===e.ssrc);t||(t=oo(MP),this._stats.videoRecv.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsReceived,t.packetsLost=e.packetsLost,t.bytes=e.bytesReceived,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.framesDecodeCount=e.framesDecoded,t.framesDroppedCount=e.framesDropped,t.totalInterFrameDelay=e.totalInterFrameDelay,t.totalSquaredInterFrameDelay=e.totalSquaredInterFrameDelay,t.totalFreezesDuration=e.totalFreezesDuration,t.totalProcessingDelay=e.totalProcessingDelay,t.packetsDiscarded=e.packetsDiscarded,t.framesAssembledFromMultiplePackets=e.framesAssembledFromMultiplePackets,t.totalAssemblyTime=e.totalAssemblyTime,t.keyFramesDecoded=e.keyFramesDecoded,t.retransmittedBytesReceived=e.retransmittedBytesReceived,t.retransmittedPacketsReceived=e.retransmittedPacketsReceived,t.estimatedPlayoutTimestamp=e.estimatedPlayoutTimestamp;const n=this.lastDecodeVideoReceiverStats.get(t.ssrc),r=this.lastVideoFramesDecode.get(t.ssrc),i=this.lastVideoFramesOutput.get(t.ssrc),o=Date.now();if(t.framesDecodeCount>0&&!this.isFirstVideoDecoded[t.ssrc]){const s=t.decodedFrame?t.decodedFrame.width:0,c=t.decodedFrame?t.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(t.ssrc,s,c),this.isFirstVideoDecoded[t.ssrc]=!0}if(n){const s=n.stats,c=o-n.lts;t.framesDecodeFreezeTime=s.framesDecodeFreezeTime,t.framesDecodeInterval=s.framesDecodeInterval,!this.isFirstVideoDecoded[t.ssrc]&&c>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[t.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(t.ssrc),this.isFirstVideoDecodedTimeout[t.ssrc]=!0),t.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[t.ssrc]?(n.lts=Date.now(),t.framesDecodeInterval=c,t.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc))?t.framesDecodeFreezeTime+=t.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):t.framesDecodeCount<s.framesDecodeCount&&(t.framesDecodeInterval=0),e.framesDecoded&&e.qpSum&&(n.stats.framesDecodeCount>e.framesDecoded?t.qpSumPerFrame=e.qpSum/e.framesDecoded:t.qpSumPerFrame=(e.qpSum-n.qpSum)/(e.framesDecoded-n.stats.framesDecodeCount))}e.totalDecodeTime&&(t.decodeMs=1e3*e.totalDecodeTime,t.avgDecodeMs=gh(n==null?void 0:n.stats,t,"decodeMs","framesDecodeCount")),t.avgProcessingDelayMs=gh(n==null?void 0:n.stats,t,"totalProcessingDelay","framesDecodeCount",ll.kMillisecondsFromSeconds),t.avgFramesAssembledFromMultiplePacketsMs=gh(n==null?void 0:n.stats,t,"totalAssemblyTime","framesAssembledFromMultiplePackets",ll.kMillisecondsFromSeconds),t.avgInterFrameDelayMs=gh(n==null?void 0:n.stats,t,"totalInterFrameDelay","framesDecodeCount",ll.kMillisecondsFromSeconds),r&&o-r.lts>=800?(t.decodeFrameRate=Math.round((t.framesDecodeCount-r.count)/((o-r.lts)/1e3)),this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:o,rate:t.decodeFrameRate})):r?t.decodeFrameRate=r.rate:this.lastVideoFramesDecode.set(t.ssrc,{count:t.framesDecodeCount,lts:o,rate:0}),t.framesDroppedCount&&e.framesReceived&&(i&&o-i.lts>=800?(t.outputFrameRate=Math.round((e.framesReceived-t.framesDroppedCount-i.count)/((o-i.lts)/1e3)),this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:o,rate:Math.max(t.outputFrameRate,0)})):i?t.outputFrameRate=i.rate:this.lastVideoFramesOutput.set(t.ssrc,{count:e.framesReceived-t.framesDroppedCount,lts:o,rate:0})),this.processVideoTrackReceiverStats(e,e.trackId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.framerateMean&&(t.framesRateFirefox=e.framerateMean),t.packets>0&&!this.isFirstVideoReceived[t.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(t.ssrc),this.isFirstVideoReceived[t.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(t.ssrc,{stats:te({},t),lts:n?n.lts:Date.now(),qpSum:e.qpSum})}processVideoOutboundStats(e){let t=this._stats.videoSend.find(r=>r.ssrc===e.ssrc);t||(t=oo(UP),this._stats.videoSend.push(t));const n=this.mediaBytesSent.get(e.ssrc);if(n)n.add(e.bytesSent);else{const r=new xv(10);r.add(e.bytesSent),this.mediaBytesSent.set(e.ssrc,r)}if(e.retransmittedBytesSent!==void 0){const r=this.mediaBytesRetransmit.get(e.ssrc);if(r)r.add(e.retransmittedBytesSent);else{const i=new xv(10);i.add(e.retransmittedBytesSent),this.mediaBytesRetransmit.set(e.ssrc,i)}}if(e.totalEncodedBytesTarget){const r=this.mediaBytesTargetEncode.get(e.ssrc);if(r)r.add(e.totalEncodedBytesTarget);else{const i=new xv(10);i.add(e.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(e.ssrc,i)}}if(t.ssrc=e.ssrc,t.bytes=e.bytesSent,t.packets=e.packetsSent,t.firsCount=e.firCount,t.nacksCount=e.nackCount,t.plisCount=e.pliCount,t.frameCount=e.framesEncoded,t.adaptionChangeReason=e.qualityLimitationReason,t.scalabilityMode=e.scalabilityMode,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,t.hugeFramesSent=e.hugeFramesSent,t.keyFramesEncoded=e.keyFramesEncoded,t.targetBitrate=e.targetBitrate,e.totalEncodeTime&&e.framesEncoded){const r=this.lastEncoderMs.get(e.ssrc);if(!r||r.lastFrameCount>e.framesEncoded)t.avgEncodeMs=1e3*e.totalEncodeTime/e.framesEncoded;else{const i=e.framesEncoded-r.lastFrameCount,o=e.totalEncodeTime-r.lastEncoderTime;t.avgEncodeMs=1e3*o/i}}if(e.framesEncoded&&e.qpSum){const r=this.lastEncoderMs.get(e.ssrc);!r||r.lastFrameCount>e.framesEncoded?t.qpSumPerFrame=e.qpSum/e.framesEncoded:t.qpSumPerFrame=(e.qpSum-r.lastQpSum)/(e.framesEncoded-r.lastFrameCount)}if(this.lastEncoderMs.set(e.ssrc,{lastFrameCount:e.framesEncoded,lastEncoderTime:e.totalEncodeTime,lastQpSum:e.qpSum,lts:Date.now()}),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),e.mediaSourceId&&this.processVideoMediaSource(e.mediaSourceId,t),this.processVideoTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const r=this.findRemoteStatsId(e.ssrc,pi.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,t)}}processAudioOutboundStats(e){let t=this._stats.audioSend.find(n=>n.ssrc===e.ssrc);if(t||(t=oo(xP),this._stats.audioSend.push(t)),t.ssrc=e.ssrc,t.packets=e.packetsSent,t.bytes=e.bytesSent,t.retransmittedBytesSent=e.retransmittedBytesSent,t.retransmittedPacketsSent=e.retransmittedPacketsSent,e.mediaSourceId&&this.processAudioMediaSource(e.mediaSourceId,t),e.codecId&&(t.codec=this.getCodecFromCodecStats(e.codecId)),this.processAudioTrackSenderStats(e,e.trackId,t),e.remoteId)this.processRemoteInboundStats(e.remoteId,t);else{const n=this.findRemoteStatsId(e.ssrc,pi.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,t)}}processTransportStats(e){this._stats.transport.bytesReceived=e.bytesReceived||this._stats.transport.bytesReceived,this._stats.transport.bytesSent=e.bytesSent||this._stats.transport.bytesSent,this._stats.transport.packetsReceived=e.packetsReceived||this._stats.transport.packetsReceived,this._stats.transport.packetsSent=e.packetsSent||this._stats.transport.packetsSent}findRemoteStatsId(e,t){var n;const r=Array.from($r(n=this.report).call(n)).find(i=>i.type===t&&i.ssrc===e);return r?r.id:null}processVideoMediaSource(e,t){const n=this.report.get(e);n&&n.width&&n.height&&n.framesPerSecond&&(t.inputFrame={width:n.width,height:n.height,frameRate:n.framesPerSecond})}processAudioMediaSource(e,t){const n=this.report.get(e);n&&(t.inputLevel=n.audioLevel)}processVideoTrackSenderStats(e,t,n){var r,i,o,s;const c=t?this.report.get(t):void 0,l=(r=c==null?void 0:c.framesSent)!==null&&r!==void 0?r:e.framesSent;if(typeof l!="number")return;let u=(i=c==null?void 0:c.frameWidth)!==null&&i!==void 0?i:e.frameWidth,h=(o=c==null?void 0:c.frameHeight)!==null&&o!==void 0?o:e.frameHeight,f=(s=c==null?void 0:c.framesPerSecond)!==null&&s!==void 0?s:e.framesPerSecond;if(typeof u=="number"&&typeof h=="number"||(u=0,h=0),f==null){const _=Date.now(),E=this.lastVideoFramesSent.get(n.ssrc);E&&_-E.lts>=800?(f=Math.round((l-E.count)/((_-E.lts)/1e3)),this.lastVideoFramesSent.set(n.ssrc,{count:l,lts:_,rate:f})):E?f=E.rate:this.lastVideoFramesSent.set(n.ssrc,{count:l,lts:_,rate:0})}n.sentFrame={width:u,height:h,frameRate:Math.max(0,f)}}processVideoTrackReceiverStats(e,t,n){var r,i,o,s,c;const l=t?this.report.get(t):void 0,u=(r=l==null?void 0:l.framesReceived)!==null&&r!==void 0?r:e.framesReceived,h=(i=l==null?void 0:l.frameWidth)!==null&&i!==void 0?i:e.frameWidth,f=(o=l==null?void 0:l.frameHeight)!==null&&o!==void 0?o:e.frameHeight,_=(s=l==null?void 0:l.jitterBufferDelay)!==null&&s!==void 0?s:e.jitterBufferDelay,E=(c=l==null?void 0:l.jitterBufferEmittedCount)!==null&&c!==void 0?c:e.jitterBufferEmittedCount;if(typeof u=="number"){const I=this.lastVideoFramesRecv.get(n.ssrc),v=Date.now();n.framesReceivedCount=u;let R=0;I&&v-I.lts>=800?(R=Math.round((u-I.count)/((v-I.lts)/1e3)),this.lastVideoFramesRecv.set(n.ssrc,{count:u,lts:v,rate:R})):I?R=I.rate:this.lastVideoFramesRecv.set(n.ssrc,{count:u,lts:v,rate:0}),n.receivedFrame={width:h||0,height:f||0,frameRate:R||0},n.decodedFrame={width:h||0,height:f||0,frameRate:n.decodeFrameRate||0},n.outputFrame={width:h||0,height:f||0,frameRate:n.outputFrameRate||n.decodeFrameRate||0}}if(_&&E){const I=this.lastVideoJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let v=I.jitterBufferMs;const R=E-I.jitterBufferEmittedCount;R>0&&(v=1e3*(_-I.jitterBufferDelay)/R),n.jitterBufferMs=v,n.currentDelayMs=Math.round(v),this.lastVideoJBDelay.set(n.ssrc,{jitterBufferDelay:_,jitterBufferEmittedCount:E,jitterBufferMs:n.currentDelayMs})}}processAudioTrackSenderStats(e,t,n){var r,i,o,s;const c=t?this.report.get(t):void 0,l=(r=(i=c==null?void 0:c.echoReturnLoss)!==null&&i!==void 0?i:e.echoReturnLoss)!==null&&r!==void 0?r:0,u=(o=(s=c==null?void 0:c.echoReturnLossEnhancement)!==null&&s!==void 0?s:e.echoReturnLossEnhancement)!==null&&o!==void 0?o:0;n.aecReturnLoss=l,n.aecReturnLossEnhancement=u}processAudioTrackReceiverStats(e,t,n){var r,i,o,s,c,l,u,h,f;const _=t?this.report.get(t):void 0,E=(r=_==null?void 0:_.removedSamplesForAcceleration)!==null&&r!==void 0?r:e.removedSamplesForAcceleration,I=(i=_==null?void 0:_.totalSamplesReceived)!==null&&i!==void 0?i:e.totalSamplesReceived,v=(o=_==null?void 0:_.jitterBufferDelay)!==null&&o!==void 0?o:e.jitterBufferDelay,R=(s=_==null?void 0:_.jitterBufferEmittedCount)!==null&&s!==void 0?s:e.jitterBufferEmittedCount,A=(c=_==null?void 0:_.audioLevel)!==null&&c!==void 0?c:e==null?void 0:e.audioLevel,O=(l=_==null?void 0:_.totalSamplesDuration)!==null&&l!==void 0?l:e==null?void 0:e.totalSamplesDuration,P=(u=_==null?void 0:_.concealedSamples)!==null&&u!==void 0?u:e.concealedSamples,M=(h=_==null?void 0:_.silentConcealedSamples)!==null&&h!==void 0?h:e.silentConcealedSamples,U=(f=_==null?void 0:_.concealmentEvents)!==null&&f!==void 0?f:e.concealmentEvents;if(typeof I=="number"&&(n.totalSamplesReceived=I),typeof M=="number"&&(n.silentConcealedSamples=M),typeof U=="number"&&(n.concealmentEvents=U),typeof P=="number"&&(n.concealedSamples=P),E&&I&&(n.accelerateRate=E/I),v&&R){const V=this.lastAudioJBDelay.get(n.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let H=V.jitterBufferMs;const q=R-V.jitterBufferEmittedCount;q>0&&(H=1e3*(v-V.jitterBufferDelay)/q),n.jitterBufferMs=Math.round(H),this.lastAudioJBDelay.set(n.ssrc,{jitterBufferDelay:v,jitterBufferEmittedCount:R,jitterBufferMs:n.jitterBufferMs})}n.outputLevel=A;let L=1920;O&&I&&(L=I/O/50,n.receivedFrames=Math.round(I/L)),P&&(n.droppedFrames=Math.round(P/L))}processRemoteInboundStats(e,t){const n=this.report.get(e);n&&(t.packetsLost=n.packetsLost,n.roundTripTime&&(t.rttMs=1e3*n.roundTripTime),n.jitter&&(t.jitterMs=1e3*n.jitter),n.timestamp&&(t.timestamp=n.timestamp))}getCodecFromCodecStats(e){const t=this.report.get(e);if(!t)return"";const n=t.mimeType.match(/\/(.*)$/);return n&&n[1]?n[1]:""}updateSendBitrate(){let e=0,t=null,n=null;this.mediaBytesSent.forEach(i=>{e+=i.diffMean()}),this.mediaBytesRetransmit.forEach(i=>{t=t===null?i.diffMean():t+i.diffMean()}),this.mediaBytesTargetEncode.forEach(i=>{n=n===null?i.diffMean():n+i.diffMean()});const r=t!==null?e-t:e;this._stats.bitrate={actualEncoded:8*r/(this.options.updateInterval/1e3),transmit:8*e/(this.options.updateInterval/1e3)},t!==null&&(this._stats.bitrate.retransmit=8*t/(this.options.updateInterval/1e3)),n!==null&&(this._stats.bitrate.targetEncoded=8*n/(this.options.updateInterval/1e3))}},Z7=class extends Vv{updateStats(){return se.resolve()}};function L_(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,i=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const o=function(){const s=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return s&&s[0]?Number(s[0].split("/")[1]):null}();return o?o<76?new Q7(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i}):new FP(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i}):function(s){if(!window.RTCStatsReport)return!1;const c=s.getStats();return!!(c instanceof se||function(l){return!!l&&(typeof l=="object"||typeof l=="function")&&typeof l.then=="function"}(c))}(e)?new FP(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i}):new Z7(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:r,firstVideoDecodedTimeout:i})}const BP="websdk_ng_install_id";function Bv(){try{if(w("INSTALL_ID"))return w("INSTALL_ID");let e=window.localStorage.getItem(BP);return e||(e=Lc(),window.localStorage.setItem(BP,e)),vt("INSTALL_ID",e),e}catch{return}}const Li=function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(t&&t[1]&&t[2]){const n=t[1],r=t[2];return"".concat(n,".").concat(r)}return"4.0.0.999"}("4.24.2"),jv=function(){try{return JSON.parse("true")===!0}catch{return!0}}();let kc=function(e){return e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn",e}({});const qn=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const r=n.join(""),i=[];for(let c=0;c<6;c++)i.push("1");const o=i.join(""),s={};return s[e]=r,s[t]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=qn;const k_={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!0,FORCE_ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:1,ENABLE_AUT_FEEDBACK:!0,SVC_EXTENDED:["VP9"]},Gv={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},Wv="v4.24.2-0-g002485b1-dirty(12/12/2025, 5:26:54 PM)",Hv={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",TURN_DOMAINS:["edge.agora.io"],USE_TURN_IP:!0,NEW_TURN_MODE:4,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1,FLS_FALLBACK_TIMEOUT:3e4,RTE_DETAIL_REPORT_INTERVAL:6e4,ENCODE_EXCEPTION_TIMES:5,ENABLE_ENCODE_EXCEPTION:!0,ENCODE_EXCEPTION_VALIDATE_CODEC:["h264"],VIDEO_ENCODER_CONFIG_LIST:[{width:240,height:180},{width:320,height:240},{width:400,height:300},{width:480,height:360},{width:560,height:420},{width:640,height:480}],DELETE_NEQ_AFTER_USER_LEAVE:!0,UPDATE_RTP_CAP_IN_HOST:!1,IOS_BG_TAG:!0,IOS_AUTO_RESTART_BG_TAG:!0,IGNORE_UID_CHECK:!1,ENABLE_UP_SPS_PPS:!1,ENABLE_DOWN_SPS_PPS:!1,NO_EDGES_RETRY:!0,BUFFER_READY_FRAMES:3,FLS_SYNC_AV_PLAY_LIMIT:0,FLS_BUFFER_WAIT_TIME:1500,VOS_CONFIGURE:void 0,ENABLE_QUALITY_FALLBACK:!1,QUALITY_FALLBACK_REHEARSAL:!0,ENABLE_FLS_AV1_FIRST:!1,ENABLE_AP_MULTI_IP:!0,FLS_ENABLE_AV1_DETECT:!0,FLS_ENABLE_AV1_DECODE_DETECT:!0},mt=te(te(te(te({},Hv),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_MANAGER_WSS:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_WSS:"",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ENABLE_ABSSENDTIME_AS_SENTTS:!0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,DC_JOIN_WITH_FAILBACK:4e3,DC_CONNECTION_TIMEOUT:2e3,DC_PINGPONG_INTERVAL:2e3,DC_DEBUG_LOG:!1,UNSUPPORTED_VIDEO_UPLINK_CODEC:[],UNSUPPORTED_VIDEO_DOWNLINK_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:Gv,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},k_),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,REMOTE_VIDEO_STREAM_TYPE:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1,ENABLE_FORCE_HLS:!1,MAX_WEBAUDIO_VOLUME:300,ENABLE_VOS_FALLBACK:!1,ENABLE_FALLBACK_TO_HLS:!1,ENABLE_PRE_RENDER:!1,FORCE_DISABLE_AUTO_SUB:!1,ENABLE_PRE_SUB_WITH_PRE_PC:!0,PRE_USE_LOCAL_CODECS:!0},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:2,BASELINE_MORE_H264_BITRATE_RATIO:1.1,IGNORE_RTC_DEVICE_CHECK:!1,FLS_AUTOPLAY_EMITS:!1,ENABLE_DUAL_STREAM_FLAG:!1,FORBID_MODIFY_LOCAL_OFFER_SDP:!1,RESERVE_MID_1_MLINE:!1});function vt(e,t,n){var r,i,o;Z(r=Object.keys(mt)).call(r,e)&&(!n&&Z(i=Object.keys(fi)).call(i,e)||(mt[e]=t,e!=="ENABLE_VIDEO_SEI"&&e!=="ENABLE_AUDIO_TOPN"&&e!=="ENABLE_AUDIO_METADATA"&&e!=="ENABLE_AUDIO_PTS"||t!==!0||(mt.ENABLE_ENCODED_TRANSFORM=!0),e==="USE_NEW_NETWORK_CONFIG"&&t&&(o=!!t,mt.USE_NEW_NETWORK_CONFIG=o,o&&(mt.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],mt.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],mt.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],mt.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],mt.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",mt.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",mt.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),e==="ENABLE_PRE_SUB"&&t&&(mt.ENABLE_INSTANT_VIDEO=!0,mt.ENABLE_PREALLOC_PC=!0),e==="ENABLE_SVC"&&t&&(mt.ENABLE_AUT_CC=!0),e==="NEW_FORCE_TURN"&&t&&(mt.NEW_TURN_MODE||(mt.NEW_TURN_MODE=4))))}function w(e){if(e==="TURN_DOMAINS"){const t=mt.TURN_DOMAINS;return Z(t).call(t,w("TURN_DOMAIN"))?t:[w("TURN_DOMAIN")].concat(t)}return mt[e]}jv||(mt.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],mt.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],mt.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],mt.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],mt.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],mt.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],mt.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",mt.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",mt.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",mt.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",mt.AREAS=["NORTH_AMERICA","OVERSEA"]);let jP=function(e){return e[e.REALTIME=1]="REALTIME",e}({});const fi={};var De=function(e){return e.SET_SESSION_ID="SET_SESSION_ID",e.SET_RTE_URL="SET_RTE_URL",e.SET_RTE_SID="SET_RTE_SID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.KEY_METRIC_PRELOAD_START="KEY_METRIC_PRELOAD_START",e.KEY_METRIC_PRELOAD_END="KEY_METRIC_PRELOAD_END",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_REQUEST_SUA_END="KEY_METRIC_REQUEST_SUA_END",e.KEY_METRIC_BEFORE_CONNECT="KEY_METRIC_BEFORE_CONNECT",e.KEY_METRIC_PEER_RECEIVER="KEY_METRIC_PEER_RECEIVER",e.KEY_METRIC_SIGNAL_CONNECTED="KEY_METRIC_SIGNAL_CONNECTED",e.KEY_METRIC_JOIN_REQ="KEY_METRIC_JOIN_REQ",e.KEY_METRIC_JOIN_REP="KEY_METRIC_JOIN_REP",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED="KEY_METRIC_FIRST_VIDEO_FRAME_DECODED",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.RESET_FIRST_VIDEO_FRAME_DECODED="RESET_FIRST_VIDEO_FRAME_DECODED",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",e}(De||{});let Mc=function(e){return e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1",e}({});(function(e){e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722"})({});const GP=128,$7=96,WP=1e3,ul=10;let eq=0;var HP=(()=>{var e={8:(r,i,o)=>{o.r(i),o.d(i,{Parser:()=>q,Printer:()=>xe,parse:()=>ne,print:()=>he});const s=`
`,c="".concat("\r").concat(s),l=" ";let u;function h(z){return z>="0"&&z<="9"}function f(z){return z>="!"&&z<="~"}function _(z){return f(z)||z>=""&&z<=""}function E(z){return z==="!"||z>="#"&&z<="'"||z>="*"&&z<="+"||z>="-"&&z<="."||z>="0"&&z<="9"||z>="A"&&z<="Z"||z>="^"&&z<="~"}function I(z){return z>="1"&&z<="9"}function v(z){return z>="A"&&z<="Z"||z>="a"&&z<="z"}function R(z){return z==="d"||z==="h"||z==="m"||z==="s"}function A(z){return z>""&&z<"	"||z>"\v"&&z<"\f"||z>""&&z<""}function O(z){return v(z)||h(z)||z==="+"||z==="/"}function P(z){return h(z)||v(z)||z==="+"||z==="/"||z==="-"||z==="_"}function M(z){return v(z)||h(z)||z==="+"||z==="/"}function U(z,T){var D=Object.keys(z);if(Object.getOwnPropertySymbols){var k=Object.getOwnPropertySymbols(z);T&&(k=k.filter(function(ee){return Object.getOwnPropertyDescriptor(z,ee).enumerable})),D.push.apply(D,k)}return D}function L(z){for(var T=1;T<arguments.length;T++){var D=arguments[T]!=null?arguments[T]:{};T%2?U(Object(D),!0).forEach(function(k){V(z,k,D[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(z,Object.getOwnPropertyDescriptors(D)):U(Object(D)).forEach(function(k){Object.defineProperty(z,k,Object.getOwnPropertyDescriptor(D,k))})}return z}function V(z,T,D){return T in z?Object.defineProperty(z,T,{value:D,enumerable:!0,configurable:!0,writable:!0}):z[T]=D,z}(function(z){z.VERSION="v",z.ORIGIN="o",z.SESSION_NAME="s",z.INFORMATION="i",z.URI="u",z.EMAIL="e",z.PHONE="p",z.CONNECTION="c",z.BANDWIDTH="b",z.TIME="t",z.REPEAT="r",z.ZONE_ADJUSTMENTS="z",z.KEY="k",z.ATTRIBUTE="a",z.MEDIA="m"})(u||(u={}));class H{consumeText(T,D){let k=D;for(;k<T.length;){const ee=T[k];if(ee==="\0"||ee==="\r"||ee===s)break;k+=1}if(k-D==0)throw new Error("Invalid text, at ".concat(T));return k}consumeUnicastAddress(T,D,k){return this.consumeTill(T,D,l)}consumeOneOrMore(T,D,k){let ee=D;for(;k(T[ee]);)ee++;if(ee-D==0)throw new Error("Invalid rule at ".concat(D,"."));return ee}consumeSpace(T,D){if(T[D]===l)return D+1;throw new Error("Invalid space at ".concat(D,"."))}consumeIP4Address(T,D){let k=D;for(let ee=0;ee<4;ee++)if(k=this.consumeDecimalUChar(T,k),ee!==3){if(T[k]!==".")throw new Error("Invalid IP4 address.");k++}return k}consumeDecimalUChar(T,D){let k=D;for(let Le=0;Le<3&&h(T[k]);Le++,k++);if(k-D==0)throw new Error("Invalid decimal uchar.");const ee=parseInt(T.slice(D,k));if(ee>=0&&ee<=255)return k;throw new Error("Invalid decimal uchar")}consumeIP6Address(T,D){let k=this.consumeHexpart(T,D);return T[k]===":"&&(k+=1,k=this.consumeIP4Address(T,k)),k}consumeHexpart(T,D){let k=D;if(T[k]===":"&&T[k+1]===":"){k+=2;try{k=this.consumeHexseq(T,k)}catch{}return k}if(k=this.consumeHexseq(T,k),T[k]===":"&&T[k+1]===":"){k+=2;try{k=this.consumeHexseq(T,k)}catch{}return k}return k}consumeHexseq(T,D){let k=D;for(;k=this.consumeHex4(T,k),T[k]===":"&&T[k+1]!==":";)k+=1;return k}consumeHex4(T,D){let k=0;for(;k<4;k++)if(!((ee=T[D+k])>="0"&&ee<="9"||ee>="a"&&ee<="f"||ee>="A"&&ee<="F")){if(k===0)throw new Error("Invalid hex 4");break}var ee;return D+k}consumeFQDN(T,D){let k=D;for(;h(T[k])||v(T[k])||T[k]==="-"||T[k]===".";)k+=1;if(k-D<4)throw new Error("Invalid FQDN");return k}consumeExtnAddr(T,D){return this.consumeOneOrMore(T,D,_)}consumeMulticastAddress(T,D,k){switch(k){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(T,D);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(T,D);default:try{return this.consumeFQDN(T,D)}catch{return this.consumeExtnAddr(T,D)}}}consumeIP6MulticastAddress(T,D){const k=this.consumeHexpart(T,D);return T[k]==="/"?this.consumeInteger(T,k+1):k}consumeIP4MulticastAddress(T,D){let k=D+3;const ee=T.slice(D,k),Le=parseInt(ee);if(Le<224||Le>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let Dt=0;Dt<3;Dt++){if(T[k]!==".")throw new Error("Invalid IP4 multicast address.");k+=1,k=this.consumeDecimalUChar(T,k)}return T[k]==="/"&&(k+=1),k=this.consumeTTL(T,k),T[k]==="/"&&(k=this.consumeInteger(T,k)),k}consumeInteger(T,D){if(!I(T[D]))throw new Error("Invalid integer.");for(D+=1;h(T[D]);)D+=1;return D}consumeTTL(T,D){if(T[D]==="0")return D+1;if(!I(T[D]))throw new Error("Invalid TTL.");D+=1;for(let k=0;k<2&&h(T[D]);k++)D+=1;return D}consumeToken(T,D){return this.consumeOneOrMore(T,D,E)}consumeTime(T,D){let k=D;if(T[k]==="0")return k+1;for(I(T[k])&&(k+=1);h(T[k]);)k++;if(k-D<10)throw new Error("Invalid time");return k}consumeAddress(T,D){return this.consumeTill(T,D,l)}consumeTypedTime(T,D){let k=D;return k=this.consumeOneOrMore(T,k,h),R(T[k])?k+1:k}consumeRepeatInterval(T,D){if(!I(T[D]))throw new Error("Invalid repeat interval");for(D+=1;h(T[D]);)D+=1;return R(T[D])&&(D+=1),D}consumePort(T,D){return this.consumeOneOrMore(T,D,h)}consume(T,D,k){for(let ee=0;ee<k.length;ee++){if(D+ee>=T.length)throw new Error("consume exceeding value length");if(T[D+ee]!==k[ee])throw new Error("consume ".concat(k," failed at ").concat(ee))}return D+k.length}consumeTill(T,D,k){let ee=D;for(;ee<T.length&&(typeof k!="string"||T[ee]!==k)&&(typeof k!="function"||!k(T[ee]));)ee++;return ee}}class q extends H{constructor(){super(),V(this,"records",[]),V(this,"currentLine",0)}parse(T){const D=this.probeEOL(T);this.records=T.split(D).filter(Ba=>!!_r(Ba).call(Ba)).map(this.parseLine),this.currentLine=0;const k=this.parseVersion(),ee=this.parseOrigin(),Le=this.parseSessionName(),Dt=this.parseInformation(),On=this.parseUri(),Gi=this.parseEmail(),Fa=this.parsePhone(),Jm=this.parseConnection(),Wl=this.parseBandWidth(),Qm=this.parseTimeFields(),od=this.parseKey(),np=this.parseSessionAttribute(),sd=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:k,origin:ee,sessionName:Le,information:Dt,uri:On,emails:Gi,phones:Fa,connection:Jm,bandwidths:Wl,timeFields:Qm,key:od,attributes:np,mediaDescriptions:sd}}getCurrentRecord(){const T=this.records[this.currentLine];if(!T)throw new Error("Record doesn't exit.");return T}probeEOL(T){for(let D=0;D<T.length;D++)if(T[D]===s)return T[D-1]==="\r"?c:s;throw new Error("Invalid newline character.")}parseLine(T,D){if(T.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const k=T[0];if(T[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:k,value:T.slice(2),line:D,cur:0}}parseSessionAttribute(){const T=new Ne;for(;this.currentLine<this.records.length;){const D=this.getCurrentRecord();if(D.type!==u.ATTRIBUTE)break;const k={attField:this.extractOneOrMore(D,ee=>E(ee)&&ee!==":"),_cur:0};D.value[D.cur]===":"&&(D.cur+=1,k.attValue=this.extractOneOrMore(D,A)),T.parse(k),this.currentLine++}return T.digest()}parseMediaAttributes(T){const D=new Ae(T);for(;this.currentLine<this.records.length;){const k=this.getCurrentRecord();if(k.type!==u.ATTRIBUTE)break;const ee={attField:this.extractOneOrMore(k,Le=>E(Le)&&Le!==":"),_cur:0};k.value[k.cur]===":"&&(k.cur+=1,ee.attValue=this.extractOneOrMore(k,A)),D.parse(ee),this.currentLine++}return D.digest()}parseKey(){const T=this.getCurrentRecord();if(T.type===u.KEY){if(T.value==="prompt"||T.value==="clear:"||T.value==="base64:"||T.value==="uri:")return T.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const T=this.getCurrentRecord();if(T.type===u.ZONE_ADJUSTMENTS){const D=[];for(;;)try{const k=this.extract(T,this.consumeTime);this.consumeSpaceForRecord(T);let ee=!1;T.value[T.cur]==="-"&&(ee=!0,T.cur+=1);const Le=this.extract(T,this.consumeTypedTime);D.push({time:k,typedTime:Le,back:ee})}catch{break}if(D.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,D}return[]}parseRepeat(){const T=[];for(;;){const D=this.getCurrentRecord();if(D.type!==u.REPEAT)break;{const k=this.extract(D,this.consumeRepeatInterval),ee=this.parseTypedTime(D);T.push({repeatInterval:k,typedTimes:ee}),this.currentLine++}}return T}parseTypedTime(T){const D=[];for(;;)try{this.consumeSpaceForRecord(T),D.push(this.extract(T,this.consumeTypedTime))}catch{break}if(D.length===0)throw new Error("Invalid typed time.");return D}parseTime(){const T=this.getCurrentRecord(),D=this.extract(T,this.consumeTime);this.consumeSpaceForRecord(T);const k=this.extract(T,this.consumeTime);return this.currentLine++,{startTime:D,stopTime:k}}parseBandWidth(){const T=[];for(;this.currentLine<this.records.length;){const D=this.getCurrentRecord();if(D.type!==u.BANDWIDTH)break;{const k=this.extractOneOrMore(D,E);if(D.value[D.cur]!==":")throw new Error("Invalid bandwidth field.");D.cur++;const ee=this.extractOneOrMore(D,h);T.push({bwtype:k,bandwidth:ee}),this.currentLine++}}return T}parseVersion(){const T=this.getCurrentRecord();if(T.type!==u.VERSION)throw new Error("first sdp record must be version");const D=T.value.slice(0,this.consumeOneOrMore(T.value,0,h));if(D.length!==T.value.length)throw new Error('invalid proto version, "v='.concat(T.value,'"'));return this.currentLine++,D}parseOrigin(){const T=this.getCurrentRecord();if(T.type!==u.ORIGIN)throw new Error("second line of sdp must be origin");const D=this.extractOneOrMore(T,_);this.consumeSpaceForRecord(T);const k=this.extractOneOrMore(T,h);this.consumeSpaceForRecord(T);const ee=this.extractOneOrMore(T,h);this.consumeSpaceForRecord(T);const Le=this.extractOneOrMore(T,E);this.consumeSpaceForRecord(T);const Dt=this.extractOneOrMore(T,E);this.consumeSpaceForRecord(T);const On=this.extract(T,this.consumeUnicastAddress);return this.currentLine++,{username:D,sessId:k,sessVersion:ee,nettype:Le,addrtype:Dt,unicastAddress:On}}parseSessionName(){const T=this.getCurrentRecord();if(T.type===u.SESSION_NAME){const D=this.extract(T,this.consumeText);return this.currentLine++,D}}parseInformation(){const T=this.getCurrentRecord();if(T.type!==u.INFORMATION)return;const D=this.extract(T,this.consumeText);return this.currentLine++,D}parseUri(){const T=this.getCurrentRecord();if(T.type===u.URI)return this.currentLine++,T.value}parseEmail(){const T=[];for(;;){const D=this.getCurrentRecord();if(D.type!==u.EMAIL)break;T.push(D.value),this.currentLine++}return T}parsePhone(){const T=[];for(;;){const D=this.getCurrentRecord();if(D.type!==u.PHONE)break;T.push(D.value),this.currentLine++}return T}parseConnection(){const T=this.getCurrentRecord();if(T.type===u.CONNECTION){const D=this.extractOneOrMore(T,E);this.consumeSpaceForRecord(T);const k=this.extractOneOrMore(T,E);this.consumeSpaceForRecord(T);const ee=this.extract(T,this.consumeAddress);return this.currentLine++,{nettype:D,addrtype:k,address:ee}}}parseMedia(){const T=this.getCurrentRecord(),D=this.extract(T,this.consumeToken);this.consumeSpaceForRecord(T);let k=this.extract(T,this.consumePort);T.value[T.cur]==="/"&&(T.cur+=1,k+=this.extract(T,this.consumeInteger)),this.consumeSpaceForRecord(T);const ee=[];for(ee.push(this.extract(T,this.consumeToken));T.value[T.cur]==="/";)T.cur+=1,ee.push(this.extract(T,this.consumeToken));if(ee.length===0)throw new Error("Invalid proto");const Le=this.parseFmt(T);return this.currentLine++,{mediaType:D,port:k,protos:ee,fmts:Le}}parseTimeFields(){const T=[];for(;this.getCurrentRecord().type===u.TIME;){const D=this.parseTime(),k=this.parseRepeat(),ee=this.parseZone();T.push({time:D,repeats:k,zones:ee})}return T}parseMediaDescription(){const T=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===u.MEDIA;){const D=this.parseMedia(),k=this.parseInformation(),ee=this.parseConnections(),Le=this.parseBandWidth(),Dt=this.parseKey(),On=this.parseMediaAttributes(D);T.push({media:D,information:k,connections:ee,bandwidths:Le,key:Dt,attributes:On})}return T}parseConnections(){const T=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===u.CONNECTION;)T.push(this.parseConnection());return T}parseFmt(T){const D=[];for(;;)try{this.consumeSpaceForRecord(T),D.push(this.extract(T,this.consumeToken))}catch{break}if(D.length===0)throw new Error("Invalid fmts");return D}extract(T,D){for(var k=arguments.length,ee=new Array(k>2?k-2:0),Le=2;Le<k;Le++)ee[Le-2]=arguments[Le];const Dt=D.call(this,T.value,T.cur,...ee),On=T.value.slice(T.cur,Dt);return T.cur=Dt,On}extractOneOrMore(T,D){const k=this.consumeOneOrMore(T.value,T.cur,D),ee=T.value.slice(T.cur,k);return T.cur=k,ee}consumeSpaceForRecord(T){if(T.value[T.cur]!==l)throw new Error("Invalid space at ".concat(T.cur,"."));T.cur+=1}}class de extends H{constructor(){super(...arguments),V(this,"attributes",void 0),V(this,"digested",!1)}extractOneOrMore(T,D,k){const ee=this.consumeOneOrMore(T.attValue,T._cur,D),Le=T.attValue.slice(T._cur,ee),[Dt,On]=k||[];if(typeof Dt=="number"&&Le.length<Dt)throw new Error("error in length, should be more or equal than ".concat(Dt," characters."));if(typeof On=="number"&&Le.length>On)throw new Error("error in length, should be less or equal than ".concat(On," characters."));return T._cur=ee,Le}consumeAttributeSpace(T){if(T.attValue[T._cur]!==l)throw new Error("Invalid space at ".concat(T._cur,"."));T._cur+=1}extract(T,D){if(!T.attValue)throw new Error("Nothing to extract from attValue.");for(var k=arguments.length,ee=new Array(k>2?k-2:0),Le=2;Le<k;Le++)ee[Le-2]=arguments[Le];const Dt=D.call(this,T.attValue,T._cur,...ee),On=T.attValue.slice(T._cur,Dt);return T._cur=Dt,On}atEnd(T){if(!T.attValue)throw new Error;return T._cur>=T.attValue.length}peekChar(T){if(!T.attValue)throw new Error;return T.attValue[T._cur]}peek(T,D){if(!T.attValue)throw new Error;for(let k=0;k<D.length;k++)if(D[k]!==T.attValue[T._cur+k])return!1;return!0}parseIceUfrag(T){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(T,O,[4,256])}parseIcePwd(T){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(T,O,[22,256])}parseIceOptions(T){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const D=[];for(;!this.atEnd(T);){D.push(this.extractOneOrMore(T,O));try{this.consumeAttributeSpace(T)}catch(k){if(this.atEnd(T))break;throw k}}this.attributes.iceOptions=D}parseFingerprint(T){const D=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T);const k=this.extract(T,this.consumeTill);this.attributes.fingerprints.push({hashFunction:D,fingerprint:k})}parseExtmap(T){const D=this.extractOneOrMore(T,h);let k;this.peekChar(T)==="/"&&(this.extract(T,this.consume,"/"),k=this.extract(T,this.consumeToken)),this.consumeAttributeSpace(T);const ee=this.extract(T,this.consumeTill,l),Le=L(L({entry:parseInt(D,10)},k&&{direction:k}),{},{extensionName:ee});this.peekChar(T)===l&&(this.consumeAttributeSpace(T),Le.extensionAttributes=this.extract(T,this.consumeTill)),this.attributes.extmaps.push(Le)}parseSetup(T){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const D=this.extract(T,this.consumeTill);if(D!=="active"&&D!=="passive"&&D!=="actpass"&&D!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=D}}class Ne extends de{constructor(){super(...arguments),V(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(T){if(this.digested)throw new Error("already digested");try{switch(T.attField){case"group":this.parseGroup(T);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(T);break;case"ice-pwd":this.parseIcePwd(T);break;case"ice-options":this.parseIceOptions(T);break;case"fingerprint":this.parseFingerprint(T);break;case"setup":this.parseSetup(T);break;case"tls-id":this.parseTlsId(T);break;case"identity":this.parseIdentity(T);break;case"extmap":this.parseExtmap(T);break;case"msid-semantic":this.parseMsidSemantic(T);break;default:T.ignored=!0,this.attributes.unrecognized.push(T)}}catch(D){throw console.error("parsing session attribute ".concat(T.attField,' error, "a=').concat(T.attField,":").concat(T.attValue,'"')),D}if(!T.ignored&&T.attValue&&!this.atEnd(T))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(T){const D=this.extract(T,this.consumeToken),k=[];for(;!this.atEnd(T)&&this.peekChar(T)===l;)this.consumeAttributeSpace(T),k.push(this.extract(T,this.consumeToken));this.attributes.groups.push({semantic:D,identificationTag:k})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(T){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(T,P)}parseIdentity(T){const D=this.extractOneOrMore(T,M),k=[];for(;!this.atEnd(T)&&this.peekChar(T)===l;){this.consumeAttributeSpace(T);const ee=this.extract(T,this.consumeToken);this.extract(T,this.consume,"=");const Le=this.extractOneOrMore(T,Dt=>Dt!==l&&A(Dt));k.push({name:ee,value:Le})}this.attributes.identities.push({assertionValue:D,extensions:k})}parseMsidSemantic(T){this.peekChar(T)===l&&this.consumeAttributeSpace(T);const D={semantic:this.extract(T,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(T)}catch{break}if(this.peekChar(T)==="*"){this.extract(T,this.consume,"*"),D.applyForAll=!0;break}{const k=this.extract(T,this.consumeTill,l);D.identifierList.push(k)}}this.attributes.msidSemantic=D}}class Ae extends de{constructor(T){super(),V(this,"attributes",void 0),T.protos.indexOf("RTP")!==-1||T.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(T){if(this.digested)throw new Error("already digested");try{switch(T.attField){case"extmap":this.parseExtmap(T);break;case"setup":this.parseSetup(T);break;case"ice-ufrag":this.parseIceUfrag(T);break;case"ice-pwd":this.parseIcePwd(T);break;case"ice-options":this.parseIceOptions(T);break;case"candidate":this.parseCandidate(T);break;case"remote-candidate":this.parseRemoteCandidate(T);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(T);break;case"rtpmap":this.parseRtpmap(T);break;case"ptime":this.parsePtime(T);break;case"maxptime":this.parseMaxPtime(T);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(T);break;case"ssrc":this.parseSSRC(T);break;case"fmtp":this.parseFmtp(T);break;case"rtcp-fb":this.parseRtcpFb(T);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(T);break;case"mid":this.parseMid(T);break;case"msid":this.parseMsid(T);break;case"imageattr":this.parseImageAttr(T);break;case"rid":this.parseRid(T);break;case"simulcast":this.parseSimulcast(T);break;case"sctp-port":this.parseSctpPort(T);break;case"max-message-size":this.parseMaxMessageSize(T);break;case"ssrc-group":this.parseSSRCGroup(T);break;default:T.ignored=!0,this.attributes.unrecognized.push(T)}}catch(D){throw console.error("parsing media attribute ".concat(T.attField,' error, "a=').concat(T.attField,":").concat(T.attValue,'"')),D}if(!T.ignored&&T.attValue&&!this.atEnd(T))throw new Error("attribute parsing error")}parseCandidate(T){const D=this.extractOneOrMore(T,O,[1,32]);this.consumeAttributeSpace(T);const k=this.extractOneOrMore(T,h,[1,5]);this.consumeAttributeSpace(T);const ee=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T);const Le=this.extractOneOrMore(T,h,[1,10]);this.consumeAttributeSpace(T);const Dt=this.extract(T,this.consumeAddress);this.consumeAttributeSpace(T);const On=this.extract(T,this.consumePort);this.consumeAttributeSpace(T),this.extract(T,this.consume,"typ"),this.consumeAttributeSpace(T);const Gi={foundation:D,componentId:k,transport:ee,priority:Le,connectionAddress:Dt,port:On,type:this.extract(T,this.consumeToken),extension:{}};for(this.peek(T," raddr")&&(this.extract(T,this.consume," raddr"),this.consumeAttributeSpace(T),Gi.relAddr=this.extract(T,this.consumeAddress)),this.peek(T," rport")&&(this.extract(T,this.consume," rport"),this.consumeAttributeSpace(T),Gi.relPort=this.extract(T,this.consumePort));this.peekChar(T)===l;){this.consumeAttributeSpace(T);const Fa=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T),Gi.extension[Fa]=this.extractOneOrMore(T,f)}this.attributes.candidates.push(Gi)}parseRemoteCandidate(T){const D=[];for(;;){const k=this.extractOneOrMore(T,h,[1,5]);this.consumeAttributeSpace(T);const ee=this.extract(T,this.consumeAddress);this.consumeAttributeSpace(T);const Le=this.extract(T,this.consumePort);D.push({componentId:k,connectionAddress:ee,port:Le});try{this.consumeAttributeSpace(T)}catch{break}}this.attributes.remoteCandidatesList.push(D)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(T){const D=this.extract(T,this.consumeToken);this.consumeAttributeSpace(T);const k=this.extract(T,this.consumeTill,"/");this.extract(T,this.consume,"/");const ee={encodingName:k,clockRate:this.extractOneOrMore(T,h)};this.atEnd(T)||this.peekChar(T)!=="/"||(this.extract(T,this.consume,"/"),ee.encodingParameters=parseInt(this.extract(T,this.consumeTill),10));const Le=this.attributes.payloads.find(Dt=>Dt.payloadType===parseInt(D,10));Le?Le.rtpMap=ee:this.attributes.payloads.push({payloadType:parseInt(D,10),rtpMap:ee,rtcpFeedbacks:[]})}parsePtime(T){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(T,this.consumeTill)}parseMaxPtime(T){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(T,this.consumeTill)}parseDirection(T){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=T.attField}parseSSRC(T){const D=this.extractOneOrMore(T,h);this.consumeAttributeSpace(T);const k=this.extract(T,this.consumeTill,":");let ee;this.peekChar(T)===":"&&(this.extract(T,this.consume,":"),ee=this.extract(T,this.consumeTill));const Le=this.attributes.ssrcs.find(Dt=>Dt.ssrcId===parseInt(D,10));Le?Le.attributes[k]=ee:this.attributes.ssrcs.push({ssrcId:parseInt(D,10),attributes:{[k]:ee}})}parseFmtp(T){const D=this.extract(T,this.consumeTill,l);this.consumeAttributeSpace(T);const k=this.extract(T,this.consumeTill),ee={};k.split(";").forEach(Dt=>{let[On,Gi]=Dt.split("=");On=_r(On).call(On);const Fa=typeof Gi=="string"?_r(Gi).call(Gi):null;typeof On=="string"&&On.length>0&&(ee[On]=Fa)});const Le=this.attributes.payloads.find(Dt=>Dt.payloadType===parseInt(D,10));Le?Le.fmtp={parameters:ee}:this.attributes.payloads.push({payloadType:parseInt(D,10),rtcpFeedbacks:[],fmtp:{parameters:ee}})}parseFmtParameters(T){const D={},k=this.extract(T,this.consumeTill,"=");T._cur++;const ee=this.extract(T,this.consumeTill,";");for(D[k]=ee;T.attValue[T._cur]===";";){const Le=this.extract(T,this.consumeTill,"=");T._cur++;const Dt=this.extract(T,this.consumeTill,";");D[Le]=Dt}return D}parseRtcpFb(T){let D="";D=this.peekChar(T)==="*"?this.extract(T,this.consume,"*"):this.extract(T,this.consumeTill,l),this.consumeAttributeSpace(T);const k=this.extract(T,this.consumeTill,l);let ee;if(k==="trr-int")ee={type:k,interval:this.extract(T,this.consumeTill)};else{const Le={type:k};this.peekChar(T)===l&&(this.consumeAttributeSpace(T),Le.parameter=this.extract(T,this.consumeToken),this.peekChar(T)===l&&(Le.additional=this.extract(T,this.consumeTill))),ee=Le}if(D==="*")this.attributes.rtcpFeedbackWildcards.push(ee);else{const Le=this.attributes.payloads.find(Dt=>Dt.payloadType===parseInt(D,10));Le?Le.rtcpFeedbacks.push(ee):this.attributes.payloads.push({payloadType:parseInt(D,10),rtcpFeedbacks:[ee]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(T){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const D={port:this.extract(T,this.consumePort)};this.peekChar(T)===l&&(this.consumeAttributeSpace(T),D.netType=this.extractOneOrMore(T,E),this.consumeAttributeSpace(T),D.addressType=this.extractOneOrMore(T,E),this.consumeAttributeSpace(T),D.address=this.extract(T,this.consumeAddress)),this.attributes.rtcp=D}parseMsid(T){const D={id:this.extractOneOrMore(T,E,[1,64])};this.peekChar(T)===l&&(this.consumeAttributeSpace(T),D.appdata=this.extractOneOrMore(T,E,[1,64])),this.attributes.msids.push(D)}parseImageAttr(T){this.attributes.imageattr.push(T.attValue)}parseRid(T){const D=this.extractOneOrMore(T,ee=>v(ee)||h(ee)||ee==="_"||ee==="-");this.consumeAttributeSpace(T);const k={id:D,direction:this.extract(T,this.consumeToken),params:[]};if(this.peekChar(T)===l){if(this.consumeAttributeSpace(T),this.peek(T,"pt=")){this.extract(T,this.consume,"pt=");const ee=[];for(;;){const Le=this.extract(T,this.consumeToken);ee.push(Le);try{this.extract(T,this.consume,",")}catch{break}}k.payloads=ee,this.peekChar(T)===l&&this.extract(T,this.consume,l)}for(;;){const ee=this.extract(T,this.consumeToken);switch(ee){case"depend":{const Le={type:ee,rids:this.extract(T,this.consume,"=").split(",")};k.params.push(Le);break}default:{const Le={type:ee};this.peekChar(T)==="="&&(this.extract(T,this.consume,"="),Le.val=this.extract(T,this.consumeTill,";")),k.params.push(Le)}}try{this.extract(T,this.consume,";")}catch{break}}}this.attributes.rids.push(k)}parseSimulcast(T){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=T.attValue,this.extract(T,this.consumeTill)}parseSctpPort(T){this.attributes.sctpPort=this.extractOneOrMore(T,h,[1,5])}parseMaxMessageSize(T){this.attributes.maxMessageSize=this.extractOneOrMore(T,h,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(T){this.attributes.mid=this.extract(T,this.consumeToken)}parseSSRCGroup(T){const D=this.extract(T,this.consumeToken),k=[];for(;;)try{this.consumeAttributeSpace(T);const ee=this.extract(T,this.consumeInteger);k.push(parseInt(ee,10))}catch{break}this.attributes.ssrcGroups.push({semantic:D,ssrcIds:k})}}function Ge(z,T,D){return T in z?Object.defineProperty(z,T,{value:D,enumerable:!0,configurable:!0,writable:!0}):z[T]=D,z}class xe{constructor(){Ge(this,"eol",c)}print(T,D){let k="";return D&&(this.eol=D),k+=this.printVersion(T.version),k+=this.printOrigin(T.origin),k+=this.printSessionName(T.sessionName),k+=this.printInformation(T.information),k+=this.printUri(T.uri),k+=this.printEmail(T.emails),k+=this.printPhone(T.phones),k+=this.printConnection(T.connection),k+=this.printBandwidth(T.bandwidths),k+=this.printTimeFields(T.timeFields),k+=this.printKey(T.key),k+=this.printSessionAttributes(T.attributes),k+=this.printMediaDescription(T.mediaDescriptions),k}printVersion(T){return"v=".concat(T).concat(this.eol)}printOrigin(T){return"o=".concat(T.username," ").concat(T.sessId," ").concat(T.sessVersion," ").concat(T.nettype," ").concat(T.addrtype," ").concat(T.unicastAddress).concat(this.eol)}printSessionName(T){return T?"s=".concat(T).concat(this.eol):""}printInformation(T){return T?"i=".concat(T).concat(this.eol):""}printUri(T){return T?"u=".concat(T).concat(this.eol):""}printEmail(T){let D="";for(const k of T)D+="e=".concat(k).concat(this.eol);return D}printPhone(T){let D="";for(const k of T)D+="e=".concat(k).concat(this.eol);return D}printConnection(T){return T?"c=".concat(T.nettype," ").concat(T.addrtype," ").concat(T.address).concat(this.eol):""}printBandwidth(T){let D="";for(const k of T)D+="b=".concat(k.bwtype,":").concat(k.bandwidth).concat(this.eol);return D}printTimeFields(T){let D="";for(const k of T){D+="t=".concat(k.time.startTime," ").concat(k.time.startTime).concat(this.eol);for(const ee of k.repeats)D+="r=".concat(ee.repeatInterval," ").concat(ee.typedTimes.join(" ")).concat(this.eol);k.zoneAdjustments&&(D+="z=",D+="z=".concat(k.zoneAdjustments.map(ee=>"".concat(ee.time," ").concat(ee.back?"-":""," ").concat(ee.typedTime)).join(" ")).concat(this.eol),D+=this.eol)}return D}printKey(T){return T?"k=".concat(T).concat(this.eol):""}printAttributes(T){let D="";for(const k of T)D+="a=".concat(k.attField).concat(k.attValue?":".concat(k.attValue):"").concat(this.eol);return D}printMediaDescription(T){let D="";for(const k of T)D+=this.printMedia(k.media),D+=this.printInformation(k.information),D+=this.printConnections(k.connections),D+=this.printBandwidth(k.bandwidths),D+=this.printKey(k.key),D+=this.printMediaAttributes(k);return D}printConnections(T){let D="";for(const k of T)D+=this.printConnection(k);return D}printMedia(T){return"m=".concat(T.mediaType," ").concat(T.port," ").concat(T.protos.join("/")," ").concat(T.fmts.join(" ")).concat(this.eol)}printSessionAttributes(T){return new jt(this.eol).print(T)}printMediaAttributes(T){return new Y(this.eol).print(T)}}class ct{constructor(T){Ge(this,"eol",void 0),this.eol=T}printIceUfrag(T){return T===void 0?"":"a=ice-ufrag:".concat(T).concat(this.eol)}printIcePwd(T){return T===void 0?"":"a=ice-pwd:".concat(T).concat(this.eol)}printIceOptions(T){return T===void 0?"":"a=ice-options:".concat(T.join(l)).concat(this.eol)}printFingerprints(T){return T.length>0?T.map(D=>"a=fingerprint:".concat(D.hashFunction).concat(l).concat(D.fingerprint)).join(this.eol)+this.eol:""}printExtmap(T){return T.map(D=>"a=extmap:".concat(D.entry).concat(D.direction?"/".concat(D.direction):"").concat(l).concat(D.extensionName).concat(D.extensionAttributes?"".concat(l).concat(D.extensionAttributes):"").concat(this.eol)).join("")}printSetup(T){return T===void 0?"":"a=setup:".concat(T).concat(this.eol)}printUnrecognized(T){return T.map(D=>"a=".concat(D.attField).concat(D.attValue?":".concat(D.attValue):"").concat(this.eol)).join("")}}class jt extends ct{print(T){let D="";return D+=this.printGroups(T.groups),D+=this.printMsidSemantic(T.msidSemantic),D+=this.printIceLite(T.iceLite),D+=this.printIceUfrag(T.iceUfrag),D+=this.printIcePwd(T.icePwd),D+=this.printIceOptions(T.iceOptions),D+=this.printFingerprints(T.fingerprints),D+=this.printSetup(T.setup),D+=this.printTlsId(T.tlsId),D+=this.printIdentity(T.identities),D+=this.printExtmap(T.extmaps),D+=this.printUnrecognized(T.unrecognized),D}printGroups(T){let D="";return T.length>0&&(D+=T.map(k=>"a=group:".concat(k.semantic).concat(k.identificationTag.map(ee=>"".concat(l).concat(ee)).join("")).concat(this.eol)).join("")),D}printIceLite(T){return T===void 0?"":"a=ice-lite"+this.eol}printTlsId(T){return T?"a=tls-id:".concat(T).concat(this.eol):""}printIdentity(T){return T.length===0?"":T.map(D=>"a=identity:".concat(D.assertionValue).concat(D.extensions.map(k=>"".concat(l).concat(k.name).concat(k.value?"=".concat(k.value):"")))).join(this.eol)+this.eol}printMsidSemantic(T){if(!T)return"";let D="a=msid-semantic:".concat(T.semantic);return T.applyForAll?D+="".concat(l,"*"):T.identifierList.length>0&&(D+=T.identifierList.map(k=>"".concat(l).concat(k))),D+this.eol}}class Y extends ct{print(T){const D=T.attributes;let k="";return k+=this.printRTCP(D.rtcp),k+=this.printIceUfrag(D.iceUfrag),k+=this.printIcePwd(D.icePwd),k+=this.printIceOptions(D.iceOptions),k+=this.printCandidates(D.candidates),k+=this.printRemoteCandidatesList(D.remoteCandidatesList),k+=this.printEndOfCandidates(D.endOfCandidates),k+=this.printFingerprints(D.fingerprints),k+=this.printSetup(D.setup),k+=this.printMid(D.mid),k+=this.printExtmap(D.extmaps),k+=this.printRTPRelated(D),k+=this.printPtime(D.ptime),k+=this.printMaxPtime(D.maxPtime),k+=this.printDirection(D.direction),k+=this.printSSRCGroups(D.ssrcGroups),k+=this.printSSRC(D.ssrcs),k+=this.printRTCPMux(D.rtcpMux),k+=this.printRTCPMuxOnly(D.rtcpMuxOnly),k+=this.printRTCPRsize(D.rtcpRsize),k+=this.printMSId(D.msids),k+=this.printImageattr(D.imageattr),k+=this.printRid(D.rids),k+=this.printSimulcast(D.simulcast),k+=this.printSCTPPort(D.sctpPort),k+=this.printMaxMessageSize(D.maxMessageSize),k+=this.printUnrecognized(D.unrecognized),k}printCandidates(T){return T.map(D=>"a=candidate:".concat(D.foundation).concat(l).concat(D.componentId).concat(l).concat(D.transport).concat(l).concat(D.priority).concat(l).concat(D.connectionAddress).concat(l).concat(D.port).concat(l,"typ").concat(l).concat(D.type).concat(D.relAddr?"".concat(l,"raddr").concat(l).concat(D.relAddr):"").concat(D.relPort?"".concat(l,"rport").concat(l).concat(D.relPort):"").concat(Object.keys(D.extension).map(k=>"".concat(l).concat(k).concat(l).concat(D.extension[k])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(T){return T.map(D=>"a=remote-candidates:".concat(D.join(l)).concat(this.eol)).join("")}printEndOfCandidates(T){return T===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(T){if(!T.payloads)return"";const D=T.payloads;let k="";k+=T.rtcpFeedbackWildcards.map(ee=>this.printRTCPFeedback("*",ee)).join("");for(const ee of D)k+=this.printRtpMap(ee.payloadType,ee.rtpMap),k+=this.printFmtp(ee.payloadType,ee.fmtp),k+=ee.rtcpFeedbacks.map(Le=>this.printRTCPFeedback(ee.payloadType,Le)).join("");return k}printFmtp(T,D){if(!D)return"";const k=Object.keys(D.parameters);return k.length===1&&D.parameters[k[0]]===null?"a=fmtp:".concat(T).concat(l).concat(k[0]).concat(this.eol):"a=fmtp:".concat(T).concat(l).concat(Object.keys(D.parameters).map(ee=>"".concat(ee,"=").concat(D.parameters[ee])).join(";")).concat(this.eol)}printRtpMap(T,D){return D?"a=rtpmap:".concat(T).concat(l).concat(D.encodingName,"/").concat(D.clockRate).concat(D.encodingParameters?"/".concat(D.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(T,D){let k="a=rtcp-fb:".concat(T).concat(l),ee=D;return ee.type==="trr-int"?k+="ttr-int".concat(l).concat(ee.interval):(k+="".concat(ee.type),ee.parameter&&(k+="".concat(l).concat(ee.parameter),ee.additional&&(k+="".concat(l).concat(ee.additional)))),k+this.eol}printPtime(T){return T===void 0?"":"a=ptime:".concat(T).concat(this.eol)}printMaxPtime(T){return T===void 0?"":"a=maxptime:".concat(T).concat(this.eol)}printDirection(T){return T===void 0?"":"a=".concat(T).concat(this.eol)}printSSRC(T){return T.map(D=>Object.keys(D.attributes).map(k=>"a=ssrc:".concat(D.ssrcId.toString(10)).concat(l).concat(k).concat(D.attributes[k]?":".concat(D.attributes[k]):"").concat(this.eol)).join("")).join("")}printRTCPMux(T){return T===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(T){return T===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(T){return T===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(T){if(T===void 0)return"";let D="a=rtcp:".concat(T.port);return T.netType&&(D+="".concat(l).concat(T.netType)),T.addressType&&(D+="".concat(l).concat(T.addressType)),T.address&&(D+="".concat(l).concat(T.address)),D+this.eol}printMSId(T){return T.map(D=>"a=msid:".concat(D.id).concat(D.appdata?"".concat(l).concat(D.appdata):"").concat(this.eol)).join("")}printImageattr(T){return T.map(D=>"a=imageattr:".concat(D).concat(this.eol)).join("")}printRid(T){return T.map(D=>{let k="a=rid:".concat(D.id).concat(l).concat(D.direction);return D.payloads&&(k+="".concat(l,"pt=").concat(D.payloads.join(","))),D.params.length>0&&(k+="".concat(l).concat(D.params.map(ee=>ee.type==="depend"?"depend=".concat(ee.rids.join(",")):"".concat(ee.type,"=").concat(ee.val)).join(";"))),k+this.eol}).join("")}printSimulcast(T){return T===void 0?"":"a=simulcast:".concat(T).concat(this.eol)}printSCTPPort(T){return T===void 0?"":"a=sctp-port:".concat(T).concat(this.eol)}printMaxMessageSize(T){return T===void 0?"":"a=max-message-size:".concat(T).concat(this.eol)}printMid(T){return T===void 0?"":"a=mid:".concat(T).concat(this.eol)}printSSRCGroups(T){return T.map(D=>"a=ssrc-group:".concat(D.semantic).concat(D.ssrcIds.map(k=>"".concat(l).concat(k.toString(10))).join("")).concat(this.eol)).join("")}}function ne(z){return new q().parse(z)}function he(z,T){return new xe().print(z,T)}}},t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={exports:{}};return e[r](i,i.exports,n),i.exports}return n.d=(r,i)=>{for(var o in i)n.o(i,o)&&!n.o(r,o)&&Object.defineProperty(r,o,{enumerable:!0,get:i[o]})},n.o=(r,i)=>Object.prototype.hasOwnProperty.call(r,i),n.r=r=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},n(8)})();function gr(e){return HP.parse(e)}function js(e,t){return HP.print(e,t)}var tq=Ni("Array","keys"),nq=ua,rq=ir,iq=re,oq=tq,Kv=Array.prototype,sq={DOMTokenList:!0,NodeList:!0},aq=function(e){var t=e.keys;return e===Kv||iq(Kv,e)&&t===Kv.keys||rq(sq,nq(e))?oq:t},ar=S(aq);function Xt(e,t,n){return(t=function(r){var i=function(o,s){if(typeof o!="object"||!o)return o;var c=o[Symbol.toPrimitive];if(c!==void 0){var l=c.call(o,"string");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(r);return typeof i=="symbol"?i:i+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function KP(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function je(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?KP(Object(n),!0).forEach(function(r){Xt(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):KP(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}function M_(e,t){return M_=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,r){return n.__proto__=r,n},M_(e,t)}function Yv(){Yv=function(i,o){return new n(i,void 0,o)};var e=RegExp.prototype,t=new WeakMap;function n(i,o,s){var c=RegExp(i,o);return t.set(c,s||t.get(i)),M_(c,n.prototype)}function r(i,o){var s,c=t.get(o);return Di(s=Object.keys(c)).call(s,function(l,u){var h=c[u];if(typeof h=="number")l[u]=i[h];else{for(var f=0;i[h[f]]===void 0&&f+1<h.length;)f++;l[u]=i[h[f]]}return l},Object.create(null))}return function(i,o){if(typeof o!="function"&&o!==null)throw new TypeError("Super expression must either be null or a function");i.prototype=Object.create(o&&o.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),Object.defineProperty(i,"prototype",{writable:!1}),o&&M_(i,o)}(n,RegExp),n.prototype.exec=function(i){var o=e.exec.call(this,i);if(o){o.groups=r(o,this);var s=o.indices;s&&(s.groups=r(s,this))}return o},n.prototype[Symbol.replace]=function(i,o){if(typeof o=="string"){var s=t.get(this);return e[Symbol.replace].call(this,i,o.replace(/\$<([^>]+)(>|$)/g,function(l,u,h){if(h==="")return l;var f=s[u];return Array.isArray(f)?"$"+f.join("$"):typeof f=="number"?"$"+f:""}))}if(typeof o=="function"){var c=this;return e[Symbol.replace].call(this,i,function(){var l=arguments;return typeof l[l.length-1]!="object"&&(l=[].slice.call(l)).push(r(l,c)),o.apply(this,l)})}return e[Symbol.replace].call(this,i,o)},Yv.apply(this,arguments)}const YP=new class extends Wt{constructor(){super(...arguments),Xt(this,"currentUploadLogID",0)}reportLogUploadError(e){const{errorRange:t}=e;t[t.length-1]&&t[t.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=t[t.length-1],this.emit("REPORT_LOG_UPLOAD",e))}};class cq{constructor(t){Xt(this,"logger",void 0),Xt(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];this.logger.debug(...this.prefixLists,...n)}info(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];this.logger.info(...this.prefixLists,...n)}warning(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];this.logger.warning(...this.prefixLists,...n)}error(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];this.logger.error(...this.prefixLists,...n)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function zv(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function zP(){const e=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?(t==null?void 0:t[0])+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const ki={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},U_=Date.now(),Sh=e=>{for(const t in ki)if(Object.prototype.hasOwnProperty.call(ki,t)&&ki[t]===e)return t;return"DEFAULT"},g=new class{constructor(){Xt(this,"proxyServerURL",void 0),Xt(this,"logLevel",ki.DEBUG),Xt(this,"uploadState","collecting"),Xt(this,"uploadLogWaitingList",[]),Xt(this,"uploadLogUploadingList",[]),Xt(this,"uploadErrorCount",0),Xt(this,"currentLogID",0),Xt(this,"url",void 0),Xt(this,"extLog",(e,t)=>{this.appendLogToWaitingList(e,...t)})}debug(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[ki.DEBUG].concat(t);this.log.apply(this,r)}info(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[ki.INFO].concat(t);this.log.apply(this,r)}warning(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[ki.WARNING].concat(t);this.log.apply(this,r)}warn(){this.warning(...arguments)}error(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[ki.ERROR].concat(t);this.log.apply(this,r)}upload(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[ki.DEBUG].concat(t);this.uploadLog.apply(this,r)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){vt("UPLOAD_LOG",!0)}disableLogUpload(){vt("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new cq(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-U_<100)return void setTimeout(()=>{this.log(...t)},Date.now()-U_);const r=Math.max(0,Math.min(4,t[0]));if(t[0]=zv()+" Agora-SDK [".concat(Sh(r),"]:"),this.appendLogToWaitingList(r,...t),r<this.logLevel)return;const i=zv()+" %cAgora-SDK [".concat(Sh(r),"]:");let o=[];if(!w("USE_NEW_LOG"))switch(r){case ki.DEBUG:o=[i,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,o);break;case ki.INFO:o=[i,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,o);break;case ki.WARNING:o=[i,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,o);break;case ki.ERROR:o=[i,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(Date.now()-U_<100)return void setTimeout(()=>{this.uploadLog(...t)},Date.now()-U_);const r=Math.max(0,Math.min(4,t[0]));t[0]=zv()+" Agora-SDK [".concat(Sh(r),"]:"),this.appendLogToWaitingList(r,...t)}appendLogToWaitingList(e){if(!w("UPLOAD_LOG"))return;for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];Array.isArray(n[0])?n[0][0]=zP()+" Agora-SDK [".concat(Sh(e),"]:"):n[0]=zP()+" Agora-SDK [".concat(Sh(e),"]:");let i="";n.forEach(o=>{typeof o=="object"&&(o=JSON.stringify(o)),i+="".concat(o," ")}),this.uploadLogWaitingList.push({payload_str:i,log_level:e,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const e=this.uploadLogUploadingList,t={sdk_version:Li,process_id:w("PROCESS_ID"),payload:JSON.stringify(e)};return Mo(async()=>{const n=await br.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(w("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(w("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if(n.data!=="OK"){const r=new Error("unexpected upload log response");throw r.response=n,r}},()=>(this.uploadLogUploadingList=[],!1),n=>{const r={status:-1,message:n.message,errorRange:e.map(i=>i.log_item_id)};return n.response?(r.status=n.response.status,r.data=n.response.data,r.headers=n.response.headers):n.request&&(r.status=n.request.status),YP.reportLogUploadError(r),!0},{timeout:w("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:w("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,w("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),w("UPLOAD_LOG_INTERVAL"))}).catch(e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),w("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),w("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var qP;function dq(e){return jn(e.reportId,"params.reportId",0,100,!1),jn(e.category,"params.category",0,100,!1),jn(e.event,"params.event",0,100,!1),jn(e.label,"params.label",0,100,!1),Ct(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(qP={}).FREE="free",qP.UPLOADING="uploading",function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"}({});const lq={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let _n=function(e){return e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.RTE_DETAIL="rte_detail_stats",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.XLA_PEER_FIRST_VIDEO_FRAME="xla_peer_first_video_frame",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",e.AB_TEST="ab_test",e}({}),Bt=function(e){return e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.RTE_DETAIL="io.agora.pb.Wrtc.RteDetailStats",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.XLA_PEER_FIRST_VIDEO_FRAME="io.agora.pb.Wrtc.XLAPeerFirstVideoFrame",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",e.AB_TEST="io.agora.pb.Wrtc.ABTest",e}({});(function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let uq=function(e){return e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",e}({});function Ie(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,n,r){const i=r.value;if(typeof i=="function"){const o=e.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);r.value=function(){for(var s,c=arguments.length,l=new Array(c),u=0;u<c;u++)l[u]=arguments[u];let h=l;if(e.argsMap)try{h=e.argsMap(this,...l)}catch(_){g.warning(_),h=[]}try{JSON.stringify(h)}catch{g.warning("arguments for method ".concat(o,".").concat(String(n)," not serializable for apiInvoke.")),h=[]}const f=(e.report||pe).reportApiInvoke(this._sessionId||null,{id:this._clientId||((s=this.store)===null||s===void 0?void 0:s.clientId)||this._ID,name:"".concat(o,".").concat(String(n)),options:h,tag:It.TRACER,reportResult:e.reportResult},e.throttleTime);try{const _=i.apply(this,l);return _ instanceof se?_.then(E=>(f.onSuccess(e.reportResult&&E),E)).catch(E=>{throw f.onError(E),E}):(f.onSuccess(e.reportResult&&_),_)}catch(_){throw f.onError(_),_}}}return r}}const pe=new class{constructor(){Xt(this,"baseInfoMap",new Map),Xt(this,"proxyServer",void 0),Xt(this,"eventUploadTimer",void 0),Xt(this,"setSessionIdTimer",void 0),Xt(this,"url",void 0),Xt(this,"sids",new Set),Xt(this,"backupUrl",void 0),Xt(this,"_appId",void 0),Xt(this,"_aid",0),Xt(this,"keyEventUploadPendingItems",[]),Xt(this,"normalEventUploadPendingItems",[]),Xt(this,"apiInvokeUploadPendingItems",[]),Xt(this,"apiInvokeCount",0),Xt(this,"apiInvokeLoggedCount",0),Xt(this,"ltsList",[]),Xt(this,"lastSendNormalEventTime",Date.now()),Xt(this,"customReportCounterTimer",void 0),Xt(this,"customReportCount",0),Xt(this,"extApiInvoke",async e=>{for(const t of e){const n=je(je({},t),{},{sid:null,invokeId:++this.apiInvokeCount,tag:It.TRACER});this.sendApiInvoke(n)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),w("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),w("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(e){return this.baseInfoMap.get(e)}setAppId(e){this._appId=e,this._aid=parseInt(e.replace(/[a-fA-F0-9]{8}/g,t=>{let[n,r]=t;return n+r}),16)||0}reportApiInvoke(e,t,n){t.timeout=t.timeout||6e4,t.reportResult=t.reportResult===void 0||t.reportResult;const r=Date.now();this.apiInvokeCount+=1;const i=this.apiInvokeCount,o=!!w("SHOW_REPORT_INVOKER_LOG"),s=!!w("SHOW_REPORT_USER_INVOKER_LOG"),c=o||s&&t.id;c&&(this.apiInvokeLoggedCount+=1);const l=this.apiInvokeLoggedCount;function u(E,I){if(c){let v="[apiInvoke-".concat(l,"]");if(t.id&&(v+="[".concat(t.id,"]")),t.name&&(v+="[".concat(t.name,"]"),t.name===Ft.JOIN))return g.info("".concat(v," ").concat(E));g.info("".concat(v," ").concat(E),E==="start"?t.options:I||"")}}const h=()=>({tag:t.tag,invokeId:i,sid:e,name:t.name,apiInvokeTime:r,options:t.options,states:t.states||null});u("start");let f=!1;In(t.timeout).then(()=>{f||(this.sendApiInvoke(je(je({},h()),{},{error:b.API_INVOKE_TIMEOUT,success:!1})),u("timeout"))});const _=new W(b.UNEXPECTED_ERROR,"".concat(t.name,": this api invoke is end"));return{onSuccess:E=>{const I=()=>{if(f)throw _;return f=!0,this.sendApiInvoke(je(je({},h()),{},{success:!0},t.reportResult&&{result:E})),u("onSuccess"),E};return n?bP(I,t.name+"Success",n,()=>f=!0):I()},onError:E=>{const I=()=>{if(f)throw E;f=!0,this.sendApiInvoke(je(je({},h()),{},{success:!1,error:E})),u("onFailure",E.toString())};return n?bP(I,t.name+"Error",n,()=>f=!0):I()}}}_send(e,t,n){this.send({type:e,data:t},n)}_sendApiInvoke(e){return this.sendApiInvoke(e)}sessionInit(e,t){if(this.baseInfoMap.has(e))return;const n=Date.now(),r=this.createBaseInfo(e,n);r.cname=t.cname,r.rteUrl=t.rteUrl;const i=Object.assign({},{willUploadConsoleLog:w("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:jv?"global":"oversea",areas:w("AREAS")&&w("AREAS").join(",")},t.extend),{stringUid:o,channelProfile:s,channelMode:c,isABTestSuccess:l,lsid:u,clientRole:h}=t,f=Date.now(),_=je(je({},r),{},{eventType:_n.SESSION_INIT,appid:t.appid,browser:navigator.userAgent,buildFormat:t.buildFormat,build:Wv,lts:f,elapse:f-n,extend:JSON.stringify(i),mode:t.mode,process:w("PROCESS_ID"),appType:w("APP_TYPE"),success:!0,version:Li,stringUid:o,channelProfile:s,channelMode:c,isABTestSuccess:l,lsid:u,clientType:Z(E=window.navigator.userAgent).call(E,"AgoraWebView")?42:20,clientRole:h,serviceId:w("PROCESS_ID"),extensionID:w("PLUGIN_INFO").join(",")||"",rteUrl:t.rteUrl,rteSid:t.rteSid});var E;this.send({type:Bt.SESSION,data:_},!0)}reportRteDetail(e){const t=this.baseInfoMap.get(e);if(!t)return;const n=t.info,r=Date.now(),i=je(je({},n),{},{eventType:_n.RTE_DETAIL,lts:r,success:!0,elapse:r-t.startTime,vid:n.vid===void 0?0:Number(n.vid),ua:navigator.userAgent});this.send({type:Bt.RTE_DETAIL,data:i},!0)}joinChooseServer(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info;t.vid&&(r.vid=t.vid);const i=Date.now(),o=je(je({},r),{},{role:t.role,eventType:_n.JOIN_CHOOSE_SERVER,lts:i,eventElapse:t.elapse||i-t.lts,chooseServerAddr:t.csAddr,errorCode:t.ec,elapse:i-n.startTime,success:t.succ,chooseServerAddrList:JSON.stringify(t.serverList),uid:t.uid?parseInt(t.uid):null,cid:t.cid?parseInt(t.cid):null,chooseServerIp:t.csIp||"",opid:t.opid,unilbsServerIds:t.unilbsServerIds,extend:t.extend||void 0,isHttp3:t.isHttp3,corssRegionTagReq:t.corssRegionTagReq||void 0,corssRegionTagRes:t.corssRegionTagRes||void 0,ua:navigator.userAgent,resourceTimingInfo:t.resourceTimingInfo||void 0});this.send({type:Bt.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je({},r),{},{eventType:_n.REQ_USER_ACCOUNT,lts:i,success:t.success,serverAddress:t.serverAddr,stringUid:t.stringUid,uid:t.uid,errorCode:t.errorCode,elapse:t.elapse||i-n.startTime,eventElapse:i-t.lts,extend:JSON.stringify(t.extend)});this.send({type:Bt.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info;t.vid&&(r.vid=t.vid),r.uid=t.uid,r.cid=t.cid;const i=Date.now(),{firstSuccess:o,addr:s,isProxy:c}=t,l=i-n.startTime,u=je(je({},r),{},{eventType:_n.JOIN_GATEWAY,lts:i,gatewayAddr:t.addr,success:t.succ,errorCode:t.ec,errorMsg:t.errorMsg||"",elapse:l,eventElapse:i-t.lts,firstSuccess:o,signalChannel:t.signalChannel,preload:t.preload?1:0,installId:Bv(),isABTestSuccess:t.isABTestSuccess?1:0,gatewayIp:null,gatewayPort:null,isProxy:c?1:0}),h=u.success?1:0;if(t.succ&&(n.lastJoinSuccessTime=i),s)if(u.signalChannel==="1"){const f=Yv(/(\d+\.\d+\.\d+\.\d+):(\d+)/,{ip:1,port:2}),_=s.match(f);u.gatewayIp=_&&_.groups?_.groups.ip:"",u.gatewayPort=_&&_.groups?_.groups.port:""}else if(c){const f=s.match(/h=(\d{1,3}-){3}\d{1,3}/g),_=s.match(/p=[0-9]{1,6}/g);u.gatewayIp=f&&f.length?f[0].split("=")[1].replace(/-/g,"."):"",u.gatewayPort=_&&_.length?_[0].split("=")[1]:""}else{const f=s.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),_=s.match(/(:|p=)[0-9]{1,6}/g);u.gatewayIp=f&&f.length?f[0].split("//")[1].replace(/-/g,"."):"",u.gatewayPort=_&&_.length?_[0].split(/:|p=/g)[1]:""}if(o)this.send({type:Bt.JOIN_GATEWAY,data:u},!0);else{let f={isSuccess:h,port:u.gatewayPort};delete u.success,delete u.eventType,delete u.firstSuccess,delete u.gatewayPort,u.vid=Number(u.vid);const _=Object.assign({},u,f,{eventType:_n.REJOIN_GATEWAY});this.send({type:Bt.RE_JOIN_GATEWAY,data:_},!0)}}joinChannelTimeout(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=Date.now(),i=je(je({},n.info),{},{lts:r,timeout:t,elapse:r-n.startTime});this.send({type:Bt.JOIN_CHANNEL_TIMEOUT,data:i},!0)}publish(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je({},r),{},{eventType:_n.PUBLISH,lts:i,eventElapse:t.eventElapse,elapse:i-n.startTime,success:t.succ,errorCode:t.ec,videoName:t.videoName,audioName:t.audioName,screenName:t.screenName,screenshare:t.screenshare,audio:t.audio,video:t.video,p2pid:t.p2pid,publishRequestid:t.publishRequestid});this.send({type:Bt.PUBLISH,data:o},!0)}subscribe(e,t,n){const r=this.baseInfoMap.get(e);if(!r)return;const i=r.info,o=Date.now(),s=je(je({},i),{},{eventType:_n.SUBSCRIBE,lts:o,eventElapse:t.eventElapse,elapse:o-r.startTime,success:t.succ,errorCode:t.ec,video:t.video,audio:t.audio,subscribeRequestid:t.subscribeRequestid,p2pid:t.p2pid,preSsrc:t.preSsrc?1:0},n&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof t.peerid=="string"?s.peerSuid=t.peerid:s.peer=t.peerid,this.send({type:Bt.SUBSCRIBE,data:s},!0)}wsCompressorInit(e){var t;const n=[...ar(t=this.baseInfoMap).call(t)],r=n.length?n[0]:"UnableToGetSid",i=this.baseInfoMap.get(r);if(!i)return;const o=i.info,s=Date.now(),c=je(je({},o),{},{eventType:_n.WS_COMPRESSOR_INIT,lts:s,eventElapse:e.eventElapse,elapse:s-i.startTime,status:e.status?1:2});this.send({type:Bt.WS_COMPRESSOR_INIT,data:c},!0)}firstXLAPeerFirstVideoFrame(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=t.peerPubStatusMs-(n.lastJoinSuccessTime||i),s=je(je({},r),{},{elapse:i-n.startTime,eventType:_n.XLA_PEER_FIRST_VIDEO_FRAME,lts:i,peer:t.peer,width:t.width,height:t.height,ssrc:t.ssrc,p2pid:t.p2pid,peerPublishDuration:t.peerPublishDuration,joinChannelSuccessElapse:o,peerPubStatusMs:t.peerPubStatusMs-t.joinChannelStart,availablePublish:t.peerPublishDuration>o?1:0,preloadStart:Math.max(t.preloadStart-t.joinChannelStart,0),preloadEnd:Math.max(t.preloadEnd-t.joinChannelStart,0),encrypt:Math.max(t.apStart-t.joinChannelStart,0),ap:Math.max(t.apEnd-t.joinChannelStart,0),sua:Math.max(t.suaEnd-t.joinChannelStart,0),beforeConnect:Math.max(t.beforeConnect-t.joinChannelStart,0),peerRecevier:Math.max(t.peerReceiver-t.joinChannelStart,0),ice:Math.max(t.ice-t.joinChannelStart,0),pc:Math.max(t.pc-t.joinChannelStart,0),signalConnected:Math.max(t.signalConnected-t.joinChannelStart,0),joinReq:Math.max(t.joinReq-t.joinChannelStart,0),joinRes:Math.max(t.joinRes-t.joinChannelStart,0),userJoinNotify:Math.max(t.userJoinNotify-t.joinChannelStart,0),videoSsrcNotify:Math.max(t.videoAddNotify-t.joinChannelStart,0),subscribeDelayMs:Math.max(t.subscribeStart-t.videoAddNotify,0),subscribeStart:Math.max(t.subscribeStart-t.joinChannelStart,0),subscribeEnd:Math.max(t.subscribeEnd-t.joinChannelStart,0),firstReceived:Math.max(t.firstReceived-t.joinChannelStart,0),firstDecoded:Math.max(t.firstDecoded-t.joinChannelStart,0),firstPreRender:Math.max(t.firstPreRender-t.joinChannelStart,0),firstRender:Math.max(t.firstRender-t.joinChannelStart,0),playDelayMs:Math.max(t.playStart-t.subscribeEnd,0),playStart:Math.max(t.playStart-t.joinChannelStart,0),playEnd:Math.max(t.playEnd-t.joinChannelStart,0),isPreSub:t.isPreSub?1:0,isPrePc:t.isPrePc?1:0,isPreInstantVideo:t.isPreInstantVideo?1:0,firstReceivedEncodedFrame:t.firstReceivedEncodedFrame?Math.max(t.firstReceivedEncodedFrame-t.joinChannelStart,0):void 0,frameType:t.frameType||"",rtpTimestamp:t.rtpTimestamp||0,framePayloadType:t.framePayloadType||0,frameDataLength:t.frameDataLength||0,mimeType:t.mimeType||""});this.send({type:Bt.XLA_PEER_FIRST_VIDEO_FRAME,data:s},!0)}firstRemoteVideoDecode(e,t,n,r){const i=this.baseInfoMap.get(e);if(!i)return;const o=i.info,s=Date.now(),c=je(je(je({},o),r),{},{elapse:s-i.startTime,eventType:t,lts:s,firstDecodeFrame:Math.max((r.firstFrame||s)-i.startTime,0),apEnd:Math.max(r.apEnd-i.startTime,0),apStart:Math.max(r.apStart-i.startTime,0),joinGwEnd:Math.max(r.joinGwEnd-i.startTime,0),joinGwStart:Math.max(r.joinGwStart-i.startTime,0),pcEnd:Math.max(r.pcEnd-i.startTime,0),pcStart:Math.max(r.pcStart-i.startTime,0),subscriberEnd:Math.max(r.subscriberEnd-i.startTime,0),subscriberStart:Math.max(r.subscriberStart-i.startTime,0),videoAddNotify:Math.max(r.videoAddNotify-i.startTime,0)});this.send({type:n,data:c},!0)}firstRemoteFrame(e,t,n,r){const i=this.baseInfoMap.get(e);if(!i)return;const o=i.info,s=Date.now(),c=je(je(je({},o),r),{},{elapse:s-i.startTime,eventType:t,lts:s});this.send({type:n,data:c},!0)}abTest(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je(je({},r),t),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:i-n.startTime,eventType:_n.AB_TEST,lts:i});this.send({type:Bt.AB_TEST,data:o},!0)}pcStats(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je(je({},r),t),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:i-n.startTime,eventType:_n.PC_STATS,lts:i,preallocation:t.preallocation?1:0});this.send({type:Bt.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(e,t){if(e){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je(je({},r),t),{},{vid:r.vid===void 0?0:Number(r.vid),eventType:_n.UPDATE_REMOTE_RTPCAPABILITIES,lts:i});this.send({type:Bt.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(e,t,n,r){const i=this.baseInfoMap.get(e);if(!i)return;const o=i.info,s=Date.now(),c=je(je(je({},o),r),{},{eventType:t,lts:s});this.send({type:n,data:c},!0)}streamSwitch(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je({},r),{},{eventType:_n.STREAM_SWITCH,lts:i,isDual:t.isdual,elapse:i-n.startTime,success:t.succ});this.send({type:Bt.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je({},r),{},{eventType:_n.REQUEST_PROXY_APPCENTER,lts:i,eventElapse:i-t.lts,elapse:i-n.startTime,APAddr:t.APAddr,workerManagerList:t.workerManagerList,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Bt.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je({},r),{},{eventType:_n.REQUEST_PROXY_WORKER_MANAGER,lts:i,eventElapse:i-t.lts,elapse:i-n.startTime,workerManagerAddr:t.workerManagerAddr,response:t.response,errorCode:t.ec,success:t.succ});this.send({type:Bt.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(e){this.proxyServer=e,e?g.debug("reportProxyServerurl: ".concat(e)):g.debug("disable reportProxyServerurl: ".concat(e))}peerPublishStatus(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je({},r),{},{subscribeElapse:t.subscribeElapse,peer:t.peer,peerPublishDuration:Math.max(t.audioPublishDuration,t.videoPublishDuration),audiotag:t.audioPublishDuration>0?1:-1,videotag:t.videoPublishDuration>0?1:-1,lts:i,elapse:i-n.startTime,joinChannelSuccessElapse:i-(n.lastJoinSuccessTime||i),peerPublishDurationVideo:t.videoPublishDuration,peerPublishDurationAudio:t.audioPublishDuration});this.send({type:Bt.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now();(function(o,s,c){const l=o[s];if(!l||typeof l!="string")return[o];o[s]="";const u=hs(JSON.stringify(o));let h=0;const f=[];let _=0;for(let E=0;E<l.length;E++)_+=l.charCodeAt(E)<=127?1:3,_<=c-u||(f[f.length]=te(te({},o),{},{[s]:l.substring(h,E)}),h=E,_=l.charCodeAt(E)<=127?1:3);return h!==l.length-1&&(f[f.length]=te(te({},o),{},{[s]:l.substring(h)})),f})(je(je(je({},r),t),{},{elapse:i-n.startTime,lts:i,productType:"WebRTC"}),"payload",1300).forEach(o=>this.send({type:Bt.WORKER_EVENT,data:o},!0))}apworkerEvent(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je(je({},r),t),{},{elapse:i-n.startTime,lts:i});this.send({type:Bt.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je(je({},r),t),{},{elapse:i-n.startTime,lts:i,extend:t.extend||void 0});this.send({type:Bt.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(e,t){const n=this.baseInfoMap.get(e);if(!n)return;const r=n.info,i=Date.now(),o=je(je(je({},r),t),{},{elapse:i-n.startTime,lts:i});this.send({type:Bt.WEBSOCKET_QUIT,data:o},!0)}async sendCustomReportMessage(e,t){if(this.customReportCount+=t.length,this.customReportCount>w("CUSTOM_REPORT_LIMIT"))throw new W(b.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const n=Date.now(),r=t.map(i=>({type:Bt.USER_ANALYTICS,data:je(je({sid:e},i),{},{lts:n})}));try{w("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(r):await this.postDataToStatsCollector(r)}catch(i){throw g.error("send custom report message failed",i.toString()),new W(b.CUSTOM_REPORT_SEND_FAILED,i.message)}}sendApiInvoke(e){const t=w("NOT_REPORT_EVENT");if(e.tag&&Z(t)&&Z(t).call(t,e.tag))return!1;if(e.sid===null)return this.apiInvokeUploadPendingItems.push(e),!1;const n=this.baseInfoMap.get(e.sid);if(!n)return this.apiInvokeUploadPendingItems.push(e),!1;const{cname:r,uid:i,cid:o}=n.info;let s;if(e.lts=e.lts||Date.now(),e.error)if(e.error instanceof W){const{code:l,message:u}=e.error;s=l||u||e.error.toString()}else s=e.error.toString();const c={invokeId:e.invokeId,sid:e.sid,cname:r,cid:o,uid:i,lts:e.lts,success:e.success,elapse:e.lts-n.startTime,execElapse:e.lts-e.apiInvokeTime,apiName:e.name,options:e.options?JSON.stringify(e.options):void 0,execStates:e.states?JSON.stringify(e.states):void 0,execResult:e.result?JSON.stringify(e.result):void 0,errorCode:e.error?s:void 0,errorMsg:e.error?JSON.stringify(e.error):void 0};return this.send({type:Bt.API_INVOKE,data:c},!1),!0}addSid(e){this.sids.add(e)}removeSid(e){this.sids.delete(e)}appendSessionId(){const e=this.apiInvokeUploadPendingItems;if(e.length===0)return;const t=Array.from(this.sids).find(n=>n!==null);t&&e.forEach(n=>{n&&(n.sid=t,this.sendApiInvoke(Object.assign({},n)))}),e.length=0}send(e,t){if(t)return this.keyEventUploadPendingItems.push(e),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(e),this.normalEventUploadPendingItems.length>w("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(e,t){const n=[],r=[];for(;e.length;){const o=e.shift();n.length<20?n.push(o):r.push(o)}e.push(...r);for(const o of[...n]){var i;this.ltsList.indexOf(o.data.lts)!==-1?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),gc(i=this.ltsList).call(i,(s,c)=>s-c))}return t||(this.lastSendNormalEventTime=Date.now()),w("ENABLE_EVENT_REPORT")&&n.length&&(w("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(n):this.postDataToStatsCollector(n)).catch((o=>s=>{w("EVENT_REPORT_RETRY")&&(t?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>w("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-w("NORMAL_EVENT_QUEUE_CAPACITY")),g.warning("report: drop normal events"))))})(n)),e}async postDataToStatsCollector2(e){qt.networkState===Er.OFFLINE&&await se.race([qt.onlineWaiter,In(2*an.maxRetryTimeout)]);const t=i=>{let o=new Uint8Array;return i.forEach(s=>{const c=wv(JSON.stringify(s.data)),l=new ArrayBuffer(5),u=(f=>{let _=0;return Object.entries(Bt).forEach(E=>{let[I,v]=E;v===f.type&&(_=uq[I])}),_})(s),h=new DataView(l);h.setUint16(0,c.byteLength,!0),h.setUint8(2,255&u),h.setUint8(3,u>>>8&255),h.setUint8(4,u>>>16&255),o=gP(o,new Uint8Array(l)),o=gP(o,c)}),o},n="event";let r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(w("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(n):"https://".concat(w("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(n);for(let i=0;i<2;i+=1){i===1&&(r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(w("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(n):"https://".concat(w("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(n));try{await Uv(r,{timeout:1e4,data:t(e),headers:je(je({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(o){if(i===1)throw o;continue}return}}async postDataToStatsCollector(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=(c=>{const l=c&&c.data.sid&&this.baseInfoMap.get(c.data.sid);return l&&l.info.vid&&+l.info.vid||0})(e[0]),r=n?void 0:this._aid,i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:e.map(c=>JSON.stringify(c)),vid:n,aid:r};qt.networkState===Er.OFFLINE&&await se.race([qt.onlineWaiter,In(2*an.maxRetryTimeout)]);const o=t?"/events/proto-raws":"/events/messages";let s=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(w("EVENT_REPORT_DOMAIN"),"&p=").concat(w("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(w("EVENT_REPORT_DOMAIN"),":").concat(w("STATS_COLLECTOR_PORT")).concat(o));for(let c=0;c<2;c+=1){c===1&&(s=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(w("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(w("STATS_COLLECTOR_PORT"),"&d=").concat(o):"https://".concat(w("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(w("STATS_COLLECTOR_PORT")).concat(o)));try{t?await J7(s,{timeout:1e4,data:i}):await Uv(s,{timeout:1e4,data:i})}catch(l){if(c===1)throw l;continue}return}}createBaseInfo(e,t){const n=Object.assign({},lq);return n.sid=e,this.baseInfoMap.set(e,{info:n,startTime:t}),n}reportResourceTiming(e,t){const n=performance.getEntriesByName(e),r=n[n.length-1];r&&this.reportApiInvoke(t,{name:"Client.resourceTiming",options:r,tag:It.TRACER}).onSuccess()}};YP.on("REPORT_LOG_UPLOAD",e=>{e.networkState=qt.networkState,pe.reportApiInvoke(null,{name:"logUploadError",options:e,tag:It.TRACER}).onSuccess("logUploadError")});let B=class extends W{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),Xt(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,g)}throw(){super.throw(g)}};const wn={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1,supportSuppressLocalAudioPlayback:!1,supportRestrictOwnAudio:!1};function Xe(){return wn}function XP(){return"setSinkId"in HTMLAudioElement.prototype&&(!w("RESTRICTION_SET_PLAYBACK_DEVICE")||(Fs()||rP())&&!hP())}function x_(){return!wn.supportUnifiedPlan||w("CHROME_FORCE_PLAN_B")&&us()}function Th(e){return!(kt()||iP(87)||x_()||!w("ENABLE_PRE_SUB")&&(e==null||!e.autoSubscribe||w("FORCE_DISABLE_AUTO_SUB")))}function JP(e){return w("ENABLE_INSTANT_VIDEO")?w("ENABLE_INSTANT_VIDEO"):!(e==null||!e.autoSubscribe||w("FORCE_DISABLE_AUTO_SUB"))}function QP(){return navigator.mediaDevices&&"getSupportedConstraints"in navigator.mediaDevices}function ZP(){if(QP()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("suppressLocalAudioPlayback"in e)||!e.suppressLocalAudioPlayback)}return ko(141)||Ta(141)||Ac(141)}function $P(){if(QP()){const e=navigator.mediaDevices.getSupportedConstraints();return!(!("restrictOwnAudio"in e)||!e.restrictOwnAudio)}return ko(141)||Ta(141)||Ac(125)}let Gn=function(e){return e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change",e}({});function hl(e,t,n){return{sampleRate:e,stereo:t,bitrate:n}}function st(e,t,n,r,i){return{width:e,height:t,frameRate:n,bitrateMin:r,bitrateMax:i}}function ao(e,t,n,r,i){return{width:{max:e},height:{max:t},frameRate:n,bitrateMin:r,bitrateMax:i}}function qv(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}const hq={"90p":st(160,90),"90p_1":st(160,90),"120p":st(160,120,15,30,65),"120p_1":st(160,120,15,30,65),"120p_3":st(120,120,15,30,50),"120p_4":st(212,120),"180p":st(320,180,15,30,140),"180p_1":st(320,180,15,30,140),"180p_3":st(180,180,15,30,100),"180p_4":st(240,180,15,30,120),"240p":st(320,240,15,40,200),"240p_1":st(320,240,15,40,200),"240p_3":st(240,240,15,40,140),"240p_4":st(424,240,15,40,220),"360p":st(640,360,15,80,400),"360p_1":st(640,360,15,80,400),"360p_3":st(360,360,15,80,260),"360p_4":st(640,360,30,80,600),"360p_6":st(360,360,30,80,400),"360p_7":st(480,360,15,80,320),"360p_8":st(480,360,30,80,490),"360p_9":st(640,360,15,80,800),"360p_10":st(640,360,24,80,800),"360p_11":st(640,360,24,80,1e3),"480p":st(640,480,15,100,500),"480p_1":st(640,480,15,100,500),"480p_2":st(640,480,30,100,1e3),"480p_3":st(480,480,15,100,400),"480p_4":st(640,480,30,100,750),"480p_6":st(480,480,30,100,600),"480p_8":st(848,480,15,100,610),"480p_9":st(848,480,30,100,930),"480p_10":st(640,480,10,100,400),"720p":st(1280,720,15,120,1130),"720p_auto":st(1280,720,30,900,3e3),"720p_1":st(1280,720,15,120,1130),"720p_2":st(1280,720,30,120,2e3),"720p_3":st(1280,720,30,120,1710),"720p_5":st(960,720,15,120,910),"720p_6":st(960,720,30,120,1380),"1080p":st(1920,1080,15,120,2080),"1080p_1":st(1920,1080,15,120,2080),"1080p_2":st(1920,1080,30,120,3e3),"1080p_3":st(1920,1080,30,120,3150),"1080p_5":st(1920,1080,60,120,4780),"1440p":st(2560,1440,30,120,4850),"1440p_1":st(2560,1440,30,120,4850),"1440p_2":st(2560,1440,60,120,7350),"4k":st(3840,2160,30,120,8910),"4k_1":st(3840,2160,30,120,8910),"4k_3":st(3840,2160,60,120,13500)},pq={"480p":ao(640,480,5),"480p_1":ao(640,480,5),"480p_2":ao(640,480,30),"480p_3":ao(640,480,15),"720p":ao(1280,720,5),"720p_auto":st(1280,720,30,900,3e3),"720p_1":ao(1280,720,5),"720p_2":ao(1280,720,30),"720p_3":ao(1280,720,15),"1080p":ao(1920,1080,5),"1080p_1":ao(1920,1080,5),"1080p_2":ao(1920,1080,30),"1080p_3":ao(1920,1080,15)},fq={"1SL1TL":qv(1,1),"3SL3TL":qv(3,3),"2SL3TL":qv(2,3)};function co(e){return e||(e="480p_1"),typeof e=="string"?Object.assign({},hq[e]):e}function Xv(e){return typeof e=="string"?Object.assign({},pq[e]):e}function V_(e){return typeof e=="string"?Object.assign({},fq[e]):e}const _q={speech_low_quality:hl(16e3,!1),speech_standard:hl(32e3,!1,18),music_standard:hl(48e3,!1),standard_stereo:hl(48e3,!0,56),high_quality:hl(48e3,!1,128),high_quality_stereo:hl(48e3,!0,192)};function F_(e){return typeof e=="string"?Object.assign({},_q[e]):e}const Uc=[];function eL(e){return sn(e,"mediaSource",["screen","window","application"]),!0}let me=function(e){return e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track",e}({}),pt=function(e){return e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream",e.SCREEN_LOW_TRACK="screen_low_track",e}({}),pl=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e}({}),mq=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",e}({}),Eq=function(e){return e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e[e.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",e[e.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",e[e.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",e[e.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",e[e.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",e[e.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",e}({}),xc=function(e){return e.TRANSCEIVER_UPDATED="transceiver-updated",e.SEI_TO_SEND="sei-to-send",e.SEI_RECEIVED="sei-received",e.TRACK_UPDATED="track-updated",e}({}),fl=function(e){return e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed",e}({}),Mi=function(e){return e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.VIDEO_STATE_CHANGED="video-state-changed",e.PLAY_START="play-start",e.PLAY_END="play-end",e.FIRST_FRAME_RENDER="first-frame-render",e}({}),_l=function(e){return e.AUDIO="audio",e.VIDEO="video",e.DATA="data",e}({}),_i=function(e){return e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source",e}({});(function(e){e.UPDATE_TRACK_SOURCE="update-track-source"})({});const Jv={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},Qv={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},tL={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},gq={uplinkNetworkQuality:0,downlinkNetworkQuality:0},nL={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let Sr=function(e){return e.ON_TRACK="on_track",e.ON_NODE="on_node",e}({}),mi=function(e){return e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints",e}({}),vh=function(e){return e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND",e}({}),Vc=function(e){return e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e}({}),$n=function(e){return e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata",e}({}),ps=function(e){return e[e.VideoStateStopped=0]="VideoStateStopped",e[e.VideoStateStarting=1]="VideoStateStarting",e[e.VideoStateDecoding=2]="VideoStateDecoding",e[e.VideoStateFrozen=3]="VideoStateFrozen",e}({});const Zv={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let B_=function(e){return e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error",e}({});function tt(e,t,n,r,i){var o,s,c={};return Object.keys(r).forEach(function(l){c[l]=r[l]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=Di(o=Nw(s=n.slice()).call(s)).call(o,function(l,u){return u(e,t,l)||l},c),i&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(i):void 0,c.initializer=void 0),c.initializer===void 0?(Object.defineProperty(e,t,c),null):c}function j(e,t,n){return(t=function(r){var i=function(o,s){if(typeof o!="object"||!o)return o;var c=o[Symbol.toPrimitive];if(c!==void 0){var l=c.call(o,"string");if(typeof l!="object")return l;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(r);return typeof i=="symbol"?i:i+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function rL(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Pt(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?rL(Object(n),!0).forEach(function(r){j(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rL(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}class iL extends Wt{set _mediaStreamTrack(t){t!==this.mediaStreamTrack&&(this.safeEmit(xc.TRACK_UPDATED,t),this.mediaStreamTrack=t)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(t,n){super(),j(this,"trackMediaType",void 0),j(this,"_ID",void 0),j(this,"_rtpTransceiver",void 0),j(this,"_lowRtpTransceiver",void 0),j(this,"_hints",[]),j(this,"_isClosed",!1),j(this,"_originMediaStreamTrack",void 0),j(this,"mediaStreamTrack",void 0),j(this,"_external",{}),this._ID=n||_t(8,"track-"),this._originMediaStreamTrack=t,this.mediaStreamTrack=t,function(r){Z(Uc).call(Uc,r)||Uc.push(r)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){return t||va(()=>{var n;pe.reportApiInvoke(null,{name:Ft.GET_MEDIA_STREAM_TRACK,options:[],tag:It.TRACER}).onSuccess(((n=this._mediaStreamTrack)===null||n===void 0?void 0:n.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===pl.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(t){const n=Uc.indexOf(t);n!==-1&&Uc.splice(n,1)}(this),this.emit(fl.CLOSED),this.removeAllListeners(xc.SEI_RECEIVED)}_updateRtpTransceiver(t,n){if(n===pl.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(xc.TRANSCEIVER_UPDATED,t,n)}}class ml extends iL{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(t,n){super(t,n),j(this,"_enabled",!0),j(this,"_muted",!1),j(this,"_isExternalTrack",!1),j(this,"_isClosed",!1),j(this,"_enabledMutex",void 0),j(this,"processor",void 0),j(this,"_processorContext",void 0),j(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Ln("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,n;return(t=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,g.debug("[".concat(this.getTrackId(),"] close")),this.emit(me.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,n){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=r,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ot(this,me.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){g.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(fl.TRACK_ENDED)}stateCheck(t,n){if(g.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(n,"]")),io(n,t),this._enabled&&this._muted&&t==="enabled"&&n===!1)throw new W(b.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",g);if(!this._enabled&&!this._muted&&t==="muted"&&n===!0)throw new W(b.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",g)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():se.resolve([])}}const oL=window.AudioContext||window.webkitAudioContext;let $v,Ei=null;const Rt=new class extends Wt{constructor(){super(...arguments),j(this,"prevState",void 0),j(this,"curState",void 0),j(this,"currentTime",void 0),j(this,"currentTimeStuckAt",void 0),j(this,"interruptDetectorTrack",void 0),j(this,"onLocalAudioTrackMute",()=>{g.info("ios15-interruption-start"),this.emit(Gn.IOS_15_16_INTERRUPTION_START)}),j(this,"onLocalAudioTrackUnmute",async()=>{g.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?g.info("ios15-interruption-end-canceled"):(Ei&&await Ei.suspend(),this.emit(Gn.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(e){g.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){g.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function El(){if(!Ei){if(function(){if(!oL)return void g.error("your browser is not support web audio");g.info("create audio context");const e=Pt({},w("WEBAUDIO_INIT_OPTIONS"));g.debug("audio context init option:",JSON.stringify(e)),Ei=new oL(e),Rt.curState=Ei.state,Ei.onstatechange=()=>{Rt.prevState=Rt.curState,Rt.curState=Ei?Ei.state:void 0;const{prevState:t,curState:n}=Rt,r=n==="running",i=n==="interrupted",o=t==="running",s=t==="suspended",c=t==="interrupted",l=ot().osVersion;(sr()||ro())&&o&&i&&(g.info("ios".concat(l,"-interruption-start")),Rt.emit(Gn.IOS_INTERRUPTION_START)),(sr()||ro())&&(s||c)&&r&&(g.info("ios".concat(l,"-interruption-end")),Rt.emit(Gn.IOS_INTERRUPTION_END)),t!==n&&Rt.emit(Gn.STATE_CHANGE,n,t)},setInterval(()=>{var t;const n=(t=Ei)===null||t===void 0?void 0:t.currentTime;Rt.currentTime!==n?(Rt.currentTimeStuckAt&&(g.debug("AudioContext current time resume at ".concat(n)),Rt.currentTimeStuckAt=void 0),Rt.currentTime=n):(n!==Rt.currentTimeStuckAt&&(pe.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:It.TRACER}).onSuccess(),g.warning("AudioContext current time stuck at ".concat(n))),Rt.currentTimeStuckAt=n)},5e3),async function(t){const n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let r,i,o=!1,s=!1,c=!1;function l(A){t.state==="running"?u(!1):sr()||ro()?t.state==="suspended"&&(u(!0),A&&t.resume().then(h,h)):t.state!=="closed"&&(u(!0),A&&t.resume().then(h,h))}function u(A){if(o!==A){o=A;for(let O=0,P=n;O<P.length;O+=1){const M=P[O];A?window.addEventListener(M,f,{capture:!0,passive:!0}):window.removeEventListener(M,f,{capture:!0,passive:!0})}}}function h(){l(!1)}function f(){l(!0)}function _(){let A;try{A=r.play(),A?A.then(v,v):(r.addEventListener("playing",v),r.addEventListener("abort",v),r.addEventListener("error",v))}catch{v()}}function E(A){c||(r.paused?A?(I(!1),c=!0,_()):I(!0):I(!1))}function I(A){if(s!==A){s=A;for(let O=0,P=n;O<P.length;O++){const M=P[O];A?window.addEventListener(M,R,{capture:!0,passive:!0}):window.removeEventListener(M,R,{capture:!0,passive:!0})}}}function v(){r.removeEventListener("playing",v),r.removeEventListener("abort",v),r.removeEventListener("error",v),c=!1,E(!1)}function R(){E(!0)}if(sr()&&w("IOS_BG_TAG")){const A=t.createMediaStreamDestination(),O=document.createElement("div");O.innerHTML="<audio x-webkit-airplay='deny'></audio>",r=O.children.item(0),r.controls=!1,r.disableRemotePlayback=!0,r.preload="auto",r.srcObject=A.stream,i=()=>{if(w("IOS_AUTO_RESTART_BG_TAG")&&r&&r.srcObject&&!c&&(!r.paused||s!==!0)){r.paused||r.pause();try{c=!0,_()}catch{c=!1}return!0}},E(!0)}return Rt.on(Gn.STATE_CHANGE,function(){l(!0)}),l(!1),i}(Ei).then(t=>{$v=t})}(),!Ei)throw new W(b.NOT_SUPPORTED,"can not create audio context");return Ei}return Ei}function Fc(e){if(function(){if(eR!==null)return eR;const r=El(),i=r.createBufferSource(),o=r.createGain(),s=r.createGain();i.connect(o),i.connect(s),i.disconnect(o);let c=!1;try{i.disconnect(o)}catch{c=!0}return i.disconnect(),eR=c,c}())return;const t=e.connect,n=e.disconnect;e.connect=(r,i,o)=>{var s;return e._inputNodes||(e._inputNodes=[]),Z(s=e._inputNodes).call(s,r)||(r instanceof AudioNode?(e._inputNodes.push(r),t.call(e,r,i,o)):t.call(e,r,i)),e},e.disconnect=(r,i,o)=>{n.call(e),r?A_(e._inputNodes,r):e._inputNodes=[];for(const s of e._inputNodes)t.call(e,s)}}let eR=null;function tR(e,t){let n=!1;const r=1/t;if(w("DISABLE_WEBAUDIO")){const i=window.setInterval(()=>{n?window.clearInterval(i):e(performance.now()/1e3)},1e3*r)}else{const i=El();let o=i.createGain();o.gain.value=0,o.connect(i.destination);const s=()=>{if(n)return void(o=null);const c=i.createOscillator();c.onended=s,c.connect(o),c.start(0),c.stop(i.currentTime+r),e(i.currentTime)};s()}return()=>{n=!0}}class sL{constructor(){j(this,"context",void 0),j(this,"analyserNode",void 0),j(this,"sourceNode",void 0),this.context=El(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t==null||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||sr()||ro()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const r=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(r);for(let i=0;i<t.length;++i)t[i]=r[i]/128-1}const n=Di(t).call(t,(r,i)=>r+i*i,0)/t.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,n;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode)}catch{g.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class aL extends Wt{get processSourceNode(){return this.sourceNode}set processedNode(t){var n;if(!this.isDestroyed&&this._processedNode!==t){try{var r;(r=this.sourceNode)===null||r===void 0||r.disconnect(this.outputNode)}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),j(this,"outputNode",void 0),j(this,"outputTrack",void 0),j(this,"isPlayed",!1),j(this,"sourceNode",void 0),j(this,"context",void 0),j(this,"audioBufferNode",void 0),j(this,"destNode",void 0),j(this,"audioOutputLevel",0),j(this,"volumeLevelAnalyser",void 0),j(this,"_processedNode",void 0),j(this,"playNode",void 0),j(this,"isDestroyed",!1),j(this,"onNoAudioInput",void 0),j(this,"isNoAudioInput",!1),j(this,"_noAudioInputCount",0),this.context=El(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Fc(this.outputNode),this.volumeLevelAnalyser=new sL}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(_i.ON_AUDIO_BUFFER,function(r){for(let i=0;i<r.outputBuffer.numberOfChannels;i+=1){const o=r.outputBuffer.getChannelData(i);for(let s=0;s<o.length;s+=1)o[s]=0}return r.inputBuffer}(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Xe().webAudioMediaStreamDest)throw new W(b.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&b_(()=>{Rt.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;sr()||ro()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const n=this.volumeLevelAnalyser.getAnalyserNode();let r;n.getFloatTimeDomainData?(r=new Float32Array(n.fftSize),n.getFloatTimeDomainData(r)):(r=new Uint8Array(n.fftSize),n.getByteTimeDomainData(r));let i=!1;for(let o=0;o<r.length;o++)r[o]!==0&&(i=!0);return i?(this.isNoAudioInput=!1,!0):(await In(200),await this.checkHasAudioInput(t?t+1:1)&&i)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,n;(t=this.processedNode)===null||t===void 0||t.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class nR extends aL{get isFreeze(){return!1}constructor(t,n,r){var i;if(super(),j(this,"sourceNode",void 0),j(this,"track",void 0),j(this,"clonedTrack",void 0),j(this,"audioElement",void 0),j(this,"isCurrentTrackCloned",!1),j(this,"isRemoteTrack",!1),j(this,"originVolumeLevelAnalyser",void 0),j(this,"rebuildWebAudio",async()=>{if(g.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void g.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>g.info("resume success")),g.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const c=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?c.stop():this.isCurrentTrackCloned=!0;const l=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(l),Fc(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const u=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(u,this.context.currentTime),Fc(this.outputNode),this.emit(_i.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=l,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),t.kind!=="audio")throw new W(b.UNEXPECTED_ERROR);this.track=t;const o=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(o),Fc(this.sourceNode),r){const c=r.clone();c.enabled=!0,this.clonedTrack=c,g.debug("create an unmuted track ".concat(c.id," from the original track ").concat(r.id," to get the volume"));const l=this.context.createMediaStreamSource(new MediaStream([c]));Fc(l),this.originVolumeLevelAnalyser=new sL,this.originVolumeLevelAnalyser.updateSource(l)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;const s=ot();n&&s.os===Cn.IOS&&Number((i=s.osVersion)===null||i===void 0?void 0:i.split(".")[0])<15&&(Rt.on(Gn.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(c=>{c||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const n=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(n),Fc(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(_i.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),Rt.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const n=t.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),g.debug("create an unmuted track ".concat(n.id," from the original track ").concat(t.id," to get the volume"));const r=this.context.createMediaStreamSource(new MediaStream([n]));Fc(r),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(r)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function cL(e,t,n){const r=(o,s)=>o?typeof o!="number"?o.max||o.exact||o.ideal||o.min||s:o:s,i={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:r(t.height,1080),maxWidth:r(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(i.video.mandatory.maxFrameRate=t.frameRate.max,i.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(i.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(i)}async function Sq(e,t){const n=await dL(e.mediaSource),{sourceId:r,audio:i}=await function(o){let s=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new se((c,l)=>{const u=document.createElement("div");u.innerText="share screen",u.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const h=document.createElement("div");h.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const f=document.createElement("div");f.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",f.setAttribute("style","height: 12%;");const _=document.createElement("div");_.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const E=document.createElement("div");E.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const I=document.createElement("button");I.innerHTML="cancel",I.setAttribute("style","width: 85px;"),I.onclick=()=>{document.body.removeChild(A);const O=new Error("NotAllowedError");O.name="NotAllowedError",l(O)};let v=s;const R=document.createElement("div");if(s){const O=document.createElement("input");O.setAttribute("type","checkbox");const P=document.createElement("span");O.setAttribute("style","margin-right: 6px;"),P.innerText="Share audio",O.checked=v,O.onchange=()=>{v=O.checked},R.appendChild(O),R.appendChild(P)}E.appendChild(R),E.appendChild(I),h.appendChild(f),h.appendChild(_),h.appendChild(E);const A=document.createElement("div");A.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),A.appendChild(u),A.appendChild(h),document.body.appendChild(A),o.map(O=>{if(O.id){const P=document.createElement("div");P.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let M=O.thumbnail;try{const{width:U}=M.getSize();U>1920&&(M=M.resize({width:1920}))}catch(U){throw U&&U.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),U}P.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+M.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+O.name.replace(/[\u00A0-\u9999<>\&]/g,function(U){return"&#"+U.charCodeAt(0)+";"})+"</span>",P.onclick=()=>{document.body.removeChild(A),c({sourceId:O.id,audio:v})},_.appendChild(P)}})})}(n,t);return await cL(r,e,i)}async function dL(e){let t=["window","screen"];e!=="application"&&e!=="window"||(t=["window"]),e==="screen"&&(t=["screen"]);const n=SP();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new W(b.ELECTRON_IS_NULL);let r=null;try{var i;r=((i=n.desktopCapturer)===null||i===void 0?void 0:i.getSources({types:t}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{r=null}r&&r.then||(r=new se((o,s)=>{n.desktopCapturer.getSources({types:t},(c,l)=>{c?s(c):o(l)})}));try{return await r}catch(o){throw new W(b.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}const rR=new Ln("safari");let lL=!1,uL=!1;async function gi(e,t){let n=0,r=null;for(;n<2;)try{r=await Tq(e,t,n>0);break}catch(i){if(i instanceof W)throw g.error("[".concat(t,"] ").concat(i.toString())),i;const o=j_(i.name||i.code||i,i.message);if(o.code===b.MEDIA_OPTION_INVALID){g.debug("[".concat(t,"] detect media option invalid, retry")),n+=1,await In(500);continue}throw g.error("[".concat(t,"] ").concat(o.toString())),o}if(!r)throw new W(b.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return r}async function Tq(e,t,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new W(b.NOT_SUPPORTED,"can not find getUserMedia");n&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const r=Xe(),i=new MediaStream;if(e.audioSource&&i.addTrack(e.audioSource),e.videoSource&&i.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return g.debug("Using Video Source/ Audio Source"),i;if(e.screen)if(SP())e.screen.sourceId?gl(i,await cL(e.screen.sourceId,e.screen,!!e.screenAudio)):gl(i,await Sq(e.screen,!!e.screenAudio));else if(Fs()&&e.screen.extensionId&&e.screen.mandatory){if(!r.getStreamFromExtension)throw new W(b.NOT_SUPPORTED,"This browser does not support screen sharing");g.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const _=await(s=e.screen.extensionId,c=t,new se((E,I)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},v=>{if(!v||!v.streamId)return g.error("[".concat(c,"] No response from Chrome Plugin. Plugin not installed properly"),v),void I(new W(b.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));E(v.streamId)})}catch(v){g.error("[".concat(c,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),v.toString()),I(new W(b.CHROME_PLUGIN_NOT_INSTALL))}}));e.screen.mandatory.chromeMediaSourceId=_,gl(i,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(r.getDisplayMedia){var o;e.screen.mediaSource&&eL(e.screen.mediaSource);const _={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:(o=e.screen.displaySurface)!==null&&o!==void 0?o:e.screen.mediaSource==="screen"?"monitor":e.screen.mediaSource},{selfBrowserSurface:E,surfaceSwitching:I,systemAudio:v,preferCurrentTab:R,windowAudio:A,monitorTypeSurfaces:O}=e.screen,P={selfBrowserSurface:E,surfaceSwitching:I,systemAudio:v,preferCurrentTab:R,windowAudio:A,monitorTypeSurfaces:O};!E&&delete P.selfBrowserSurface,!I&&delete P.surfaceSwitching,!v&&delete P.systemAudio,!R&&delete P.preferCurrentTab,!A&&delete P.windowAudio,!O&&delete P.monitorTypeSurfaces,g.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:_,audio:e.screenAudio,controls:P})),gl(i,await navigator.mediaDevices.getDisplayMedia(Pt({video:_,audio:e.screenAudio},P)))}else{if(!kt())throw g.error("[".concat(t,"] This browser does not support screenSharing")),new W(b.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&eL(e.screen.mediaSource);const _={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};g.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(_))),gl(i,await navigator.mediaDevices.getUserMedia(_))}}var s,c;if(!e.video&&!e.audio)return i;let l={video:e.video,audio:e.audio},u=w("MEDIA_DEVICE_CONSTRAINTS");if(u)try{typeof u=="string"&&(u=JSON.parse(u)),l=Dv(l,u)}catch{}g.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(l)),ot();let h,f=null;(Pn()||sr()||w_())&&(f=await rR.lock());try{h=await navigator.mediaDevices.getUserMedia(l)}catch(_){throw f&&f(),_}return l.audio&&(lL=!0),l.video&&(uL=!0),gl(i,h),f&&f(),i}function j_(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new W(b.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new W(b.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new W(b.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new W(b.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new W(b.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new W(b.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return g.error("getUserMedia unexpected error",e),new W(b.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function gl(e,t){const n=e.getVideoTracks()[0],r=e.getAudioTracks()[0],i=t.getVideoTracks()[0],o=t.getAudioTracks()[0];o&&(r&&e.removeTrack(r),e.addTrack(o)),i&&(n&&e.removeTrack(n),e.addTrack(i))}const Si=new class extends Wt{get state(){return this._state}set state(e){e!==this._state&&(this.emit(Vc.STATE_CHANGE,e),this._state=e)}constructor(){super(),j(this,"_state",vh.IDLE),j(this,"isAccessMicrophonePermission",!1),j(this,"isAccessCameraPermission",!1),j(this,"lastAccessMicrophonePermission",!1),j(this,"lastAccessCameraPermission",!1),j(this,"checkdeviceMatched",!1),j(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(w("ENUMERATE_DEVICES_INTERVAL")||(hh()||I_()===Cn.HARMONY_OS)&&us())&&this.updateDevicesInfo()},w("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(e=>g.error(e.toString()))}async enumerateDevices(e,t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)throw new W(b.NOT_SUPPORTED,"enumerateDevices() not supported.");const r=await navigator.mediaDevices.enumerateDevices(),i=this.checkMediaDeviceInfoIsOk(r);let o=!this.isAccessMicrophonePermission&&e,s=!this.isAccessCameraPermission&&t;i.audio&&(o=!1),i.video&&(s=!1);let c=null,l=null,u=null;if(!n&&(o||s)){if(rR.isLocked&&(g.debug("[device manager] wait GUM lock"),(await rR.lock())(),g.debug("[device manager] GUM unlock")),lL&&(o=!1,this.isAccessMicrophonePermission=!0),uL&&(s=!1,this.isAccessCameraPermission=!0),g.debug("[device manager] check media device permissions",e,t,o,s),o&&s){try{u=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(h){const f=j_(h.name||h.code||h,h.message);if(f.code===b.PERMISSION_DENIED)throw f;g.warning("getUserMedia failed in getDevices",f)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{c=await navigator.mediaDevices.getUserMedia({audio:e})}catch(h){const f=j_(h.name||h.code||h,h.message);if(f.code===b.PERMISSION_DENIED)throw f;g.warning("getUserMedia failed in getDevices",f)}this.isAccessMicrophonePermission=!0}else if(s){try{l=await navigator.mediaDevices.getUserMedia({video:t})}catch(h){const f=j_(h.name||h.code||h,h.message);if(f.code===b.PERMISSION_DENIED)throw f;g.warning("getUserMedia failed in getDevices",f)}this.isAccessCameraPermission=!0}g.debug("[device manager] mic permission",e,"cam permission",t)}try{const h=await navigator.mediaDevices.enumerateDevices();return c&&c.getTracks().forEach(f=>f.stop()),l&&l.getTracks().forEach(f=>f.stop()),u&&u.getTracks().forEach(f=>f.stop()),c=null,l=null,u=null,h}catch(h){return c&&c.getTracks().forEach(f=>f.stop()),l&&l.getTracks().forEach(f=>f.stop()),u&&u.getTracks().forEach(f=>f.stop()),c=null,l=null,u=null,new W(b.ENUMERATE_DEVICES_FAILED,h.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter(t=>t.kind==="audioinput")}async getCamerasDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter(t=>t.kind==="videoinput")}async getSpeakers(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter(t=>t.kind==="audiooutput")}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach(n=>{n.device.label===e&&(t=n.device.deviceId)}),t}async getDeviceById(e){const t=(await this.enumerateDevices(!0,!0,!0)).find(n=>n.deviceId===e);if(!t)throw new W(b.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=vh.INITING;try{await this.updateDevicesInfo(),this.state=vh.INITEND}catch(e){throw this.state=vh.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")?(g.warning("Device Detection functionality cannot start properly.",e.toString()),e):new W(b.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.")}}async updateDevicesInfo(){const e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),n=[];if(e[0]&&e[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const i=e.find(s=>s.kind==="audioinput"&&s.deviceId==="default"),o=e.find(s=>s.kind==="audiooutput"&&s.deviceId==="default");i&&o?o.groupId===i.groupId?g.debug("[device-check] default input ".concat(i.label," and output ").concat(o.label," is the same group")):g.debug("[device-check] default input ".concat(i.label," and output ").concat(o.label," is not the same group")):g.debug("[device-check] default input or output not found")}const r=this.checkMediaDeviceInfoIsOk(e);if(e.forEach(i=>{if(!i.deviceId)return;const o=this.deviceInfoMap.get("".concat(i.kind,"_").concat(i.deviceId));if((o?o.state:"INACTIVE")!=="ACTIVE"){const s={initAt:t,updateAt:t,device:i,state:"ACTIVE"};this.deviceInfoMap.set("".concat(i.kind,"_").concat(i.deviceId),s),n.push(s)}o&&(o.updateAt=t)}),this.deviceInfoMap.forEach((i,o)=>{i.state==="ACTIVE"&&i.updateAt!==t&&(i.state="INACTIVE",n.push(i))}),this.state!==vh.INITEND)return r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));n.forEach(i=>{switch(i.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Vc.RECORDING_DEVICE_CHANGED,i);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Vc.CAMERA_DEVICE_CHANGED,i);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Vc.PLAYOUT_DEVICE_CHANGED,i)}}),r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){const t=e.filter(i=>i.kind==="audioinput"),n=e.filter(i=>i.kind==="videoinput"),r={audio:!1,video:!1};for(const i of t)if(i.label&&i.deviceId){r.audio=!0;break}for(const i of n)if(i.label&&i.deviceId){r.video=!0;break}return r}};let iR=!1;const Nr=new class extends Wt{constructor(){super(...arguments),j(this,"onAutoplayFailed",void 0),j(this,"onAudioAutoplayFailed",void 0)}};function hL(){if(iR)return w("FLS_AUTOPLAY_EMITS")?(Nr.onAutoplayFailed&&Nr.onAutoplayFailed(),Nr.emit("autoplay-failed")):void 0;{const e=t=>{t.preventDefault(),iR=!1,ph()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};iR=!0,ph()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),g.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Nr.onAutoplayFailed?Nr.onAutoplayFailed():Nr.onAudioAutoplayFailed?g.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):g.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Nr.emit("autoplay-failed")}}function pL(e,t,n,r){if(!e)return;const i=pe.getBaseInfoBySessionId(e);if(!i)return;const o=i.info,s=Date.now(),c=Pt(Pt({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:s,elapse:s-i.startTime,cbRegistered:Nr.onAutoplayFailed||Nr.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:t,trackId:r,extend:void 0});pe.send({type:Bt.AUTOPLAY_FAILED,data:c},!0)}const vq=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],dr=new class{constructor(){j(this,"onAutoplayFailed",void 0),j(this,"elementMap",new Map),j(this,"elementStateMap",new Map),j(this,"elementsNeedToResume",[]),j(this,"sinkIdMap",new Map),j(this,"autoResumeAfterInterruption",e=>se.all(Array.from(this.elementMap.entries()).map(async t=>{let[n,r]=t;const i=this.elementStateMap.get(n),o=r.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(g.debug("resume after interrupted, ele: ".concat(i," audio: ").concat(s," ").concat(e)),s==="live"){if(e)return r.pause(),r.play();if(Rt.curState==="running")return il()?(r.pause(),r.play()):i&&i==="paused"?r.play():void 0}}))),j(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(e=>{let[t,n]=e;const r=n.srcObject.getAudioTracks()[0];r&&r.readyState==="live"&&(g.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())})}),this.autoResumeAudioElement(),Rt.on(Gn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Rt.on(Gn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Rt.on(Gn.STATE_CHANGE,()=>{sr()&&Rt.prevState==="suspended"&&Rt.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(e,t){const n=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),n)try{await n.setSinkId(t)}catch(r){throw new W(b.PERMISSION_DENIED,"can not set sink id: "+r.toString())}}play(e,t,n,r){if(this.elementMap.has(t))return;const i=document.createElement("audio");i.autoplay=!0,i.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,i),this.elementMap.set(t,i),this.elementStateMap.set(t,$n.INIT),this.setVolume(t,n);const o=this.sinkIdMap.get(t);if(o)try{i.setSinkId(o).catch(c=>{g.warning("[".concat(t,"] set sink id failed"),c.toString())})}catch(c){g.warning("[".concat(t,"] set sink id failed"),c.toString())}const s=i.play();s&&s.then&&s.catch(c=>{r&&pL(r,"audio",c.message,t),g.warning("audio element play warning",c.toString()),this.elementMap.has(t)&&c.name==="NotAllowedError"&&(g.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(i),b_(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),hL()}))})}updateTrack(e,t){const n=this.elementMap.get(e);n&&(n.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&this.elementStateMap.get(e)==="playing"}setVolume(e,t){const n=this.elementMap.get(e);n&&(t=Math.max(0,Math.min(100,t)),n.volume=t/100)}getVolume(e){const t=this.elementMap.get(e);return t?t.volume:0}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const n=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(n,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){vq.forEach(n=>{t.addEventListener(n,r=>{const i=this.elementStateMap.get(e),o=r.type==="pause"?"paused":r.type;if(g.debug("[".concat(e,"] audio-element-status change ").concat(i," => ").concat(o)),r.type==="error"){const s=t==null?void 0:t.error;s&&g.error("[".concat(e,"] media error, code: ").concat(s.code,", message: ").concat(s.message))}this.elementStateMap.set(e,o)})})}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach(t=>{t.play().then(n=>{g.debug("Auto resume audio element success")}).catch(n=>{g.warning("Auto resume audio element failed!",n)})}),this.elementsNeedToResume=[]};new se(t=>{document.body?t():window.addEventListener("load",()=>t())}).then(()=>{ph()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))})}};function Qt(){return function(e,t,n){const r=n.value;return typeof r=="function"&&(n.value=function(){this._isClosed&&new W(b.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",g);for(var i=arguments.length,o=new Array(i),s=0;s<i;s++)o[s]=arguments[s];const c=r.apply(this,o);return c instanceof se?new se((l,u)=>{c.then(l).catch(u)}):c}),n}}class fL extends Wt{constructor(t){super(),j(this,"name","VideoProcessorDestination"),j(this,"ID","0"),j(this,"_source",void 0),j(this,"videoContext",void 0),j(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new W(b.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new W(b.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(Sr.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Sr.ON_TRACK,void 0)}}class _L extends Wt{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,n){super(),j(this,"constraintsMap",new Map),j(this,"statsRegistry",[]),j(this,"usageRegistry",[]),j(this,"trackId",void 0),j(this,"direction",void 0),j(this,"_chained",!1),this.trackId=t,this.direction=n}async getConstraints(){return await hn(this,mi.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,n){var r;return g.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(n,t),Ot(this,mi.REQUEST_UPDATE_CONSTRAINTS,Array.from($r(r=this.constraintsMap).call(r)))}async requestRevertConstraints(t){var n;if(this.constraintsMap.has(t))return g.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),Ot(this,mi.REQUEST_UPDATE_CONSTRAINTS,Array.from($r(n=this.constraintsMap).call(n)))}registerStats(t,n,r){this.statsRegistry.find(i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===n)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:n,cb:r})}unregisterStats(t,n){const r=this.statsRegistry.findIndex(i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===n);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){const t=[];for(const{processorID:n,processorName:r,type:i,cb:o}of this.statsRegistry)try{const s=o();t.push({processorID:n,processorName:r,type:i,stats:s})}catch(s){g.error(new W(b.UNEXPECTED_ERROR,s.message))}return t}registerUsage(t,n){this.usageRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:n})}unregisterUsage(t){const n=this.usageRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let r=n();r instanceof se&&(r=await r),t.push(Pt(Pt({},r),{},{direction:this.direction}))}catch(r){g.error("gather extension usage error",r)}return t}getDirection(){return this.direction}}class mL extends Wt{constructor(t){super(),j(this,"name","AudioProcessorDestination"),j(this,"ID","0"),j(this,"inputTrack",void 0),j(this,"inputNode",void 0),j(this,"audioProcessorContext",void 0),j(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new W(b.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new W(b.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Sr.ON_TRACK,void 0),this.emit(Sr.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(Sr.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(Sr.ON_NODE,this.inputNode))}}class EL extends Wt{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,n,r){super(),j(this,"constraintsMap",new Map),j(this,"statsRegistry",[]),j(this,"audioContext",void 0),j(this,"trackId",void 0),j(this,"direction",void 0),j(this,"usageRegistry",[]),j(this,"_chained",!1),this.audioContext=t,this.trackId=n,this.direction=r}async getConstraints(){return hn(this,mi.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,n){var r;return g.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(n,t),Ot(this,mi.REQUEST_UPDATE_CONSTRAINTS,Array.from($r(r=this.constraintsMap).call(r)))}async requestRevertConstraints(t){var n;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),Ot(this,mi.REQUEST_UPDATE_CONSTRAINTS,Array.from($r(n=this.constraintsMap).call(n)))}registerStats(t,n,r){this.statsRegistry.find(i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===n)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:n,cb:r})}unregisterStats(t,n){const r=this.statsRegistry.findIndex(i=>i.processorID===t.ID&&i.processorName===t.name&&i.type===n);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){const t=[];for(const{processorID:n,processorName:r,type:i,cb:o}of this.statsRegistry)try{const s=o();t.push({processorID:n,processorName:r,type:i,stats:s})}catch(s){g.error(new W(b.UNEXPECTED_ERROR,s.message))}return t}registerUsage(t,n){this.usageRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:n})}unregisterUsage(t){const n=this.usageRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let r=n();r instanceof se&&(r=await r),t.push(Pt(Pt({},r),{},{direction:this.direction}))}catch(r){g.error("gather extension usage error",r)}return t}getDirection(){return this.direction}}class oR extends Wt{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),j(this,"context",void 0),j(this,"processSourceNode",void 0),j(this,"outputTrack",void 0),j(this,"processedNode",void 0),j(this,"clonedTrack",void 0),j(this,"outputNode",void 0),this.outputNode=new Rq}setVolume(){}createOutputTrack(){throw new W(b.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class Rq{disconnect(){}connect(){}}function gL(e){return new se((t,n)=>{let r=!1;const i=document.createElement("video");i.setAttribute("autoplay",""),i.setAttribute("muted",""),i.muted=!0,i.autoplay=!0,i.setAttribute("playsinline",""),i.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(i);const o=sr()?"canplay":"playing";i.addEventListener(o,()=>{const s=i.videoWidth,c=i.videoHeight;!s&&kt()||(r=!0,i.srcObject=null,i.remove(),t([s,c]))}),i.srcObject=new MediaStream([e]),i.play().catch(mh),setTimeout(()=>{r||(i.srcObject=null,i.remove(),t([i.videoWidth,i.videoHeight]))},4e3)})}function G_(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const n=co(e.encoderConfig);return n.width!=null&&(t.width=n.width),n.height!=null&&(t.height=n.height),!uP()&&n.frameRate&&(t.frameRate=n.frameRate),rP()&&typeof t.frameRate=="object"&&(t.frameRate.max=60),kt()&&(t.frameRate={ideal:30,max:30}),t}function SL(e){const t={};return uP()||(e.AGC!==void 0&&(t.autoGainControl=e.AGC),e.AEC!==void 0&&(t.echoCancellation=e.AEC),e.ANS!==void 0&&(t.noiseSuppression=e.ANS,Fs()&&e.ANS&&(t.googHighpassFilter=e.ANS))),t}function TL(e){const t=SL(e);if(e.encoderConfig){const n=F_(e.encoderConfig);t.channelCount=n.stereo?2:1,t.sampleRate=n.sampleRate,t.sampleSize=n.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),hh()&&(t.sampleRate=void 0),t}const vL=e=>{const t=e._encoderConfig;if(!t)return;const{frameRate:n,width:r,height:i}=e.getMediaStreamTrackSettings();let{frameRate:o=n,width:s=r,height:c=i}=t;if(!o||!s||!c)return;s=al(s),c=al(c),o=al(o);const{max:l,min:u}=function(E,I,v){const R=200*Math.pow(v/15,.6)*Math.pow(E*I/640/360,.75);return{min:Math.floor(R),max:Math.floor(4*R)}}(s,c,o),{bitrateMax:h,bitrateMin:f}=t||{};h||g.debug("calculate bitrate: [w: ".concat(s,", h: ").concat(c,", fps: ").concat(o,"] => [brMax: ").concat(h,", brMin: ").concat(f,"]"));const{maxFramerate:_}=w("ENCODER_CONFIG_LIMIT");return _&&typeof _=="number"&&(o=Math.min(o,_)),{frameRate:o,bitrateMax:h||l,bitrateMin:f||u,scaleResolutionDownBy:1,scale:0}},RL=async(e,t,n)=>await(async(r,i,o)=>{const s=function(u){const h=[];for(let f=0;f<u.length;f+=2)h.push(parseInt(u.slice(f,f+2),16));return Uint8Array.from(h)}(DP(""+i+o)).slice(0,16),c=s.slice(0,12),l=await window.crypto.subtle.importKey("raw",s,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:c},l,r))})(e.buffer,t,n),sR=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new se((n,r)=>{t.toBlob(async i=>{if(t.remove(),i){const o=await yL(i);n({buffer:o,width:t.width,height:t.height})}else r(new W(b.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,1)})},yL=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)};var CL,IL,wL,AL,bL,OL,NL,DL,PL,LL,kL,ML,UL,xL,VL,FL,BL,jL,Yt,GL,WL,HL,KL,YL,zL,fs,qL,XL,JL,QL,ZL,$L,ek,tk,nk,rk,ik,ok,sk,Xn;let Zt=(CL=Ie({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),IL=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),wL=Qt(),AL=cl("LocalAudioTrack","_enabledMutex"),bL=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),OL=Qt(),NL=cl("LocalAudioTrack","_enabledMutex"),DL=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),PL=Qt(),LL=Qt(),kL=Qt(),ML=Ie({argsMap:e=>[e.getTrackId()]}),UL=Qt(),xL=Ie({argsMap:e=>[e.getTrackId()]}),VL=Qt(),FL=Ie({argsMap:e=>[e.getTrackId()]}),BL=Ie({argsMap:(e,t)=>[e.getTrackId(),t.name]}),jL=Ie({argsMap:e=>[e.getTrackId()]}),tt((Yt=class extends ml{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?dr.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,n,r){super(e,n),j(this,"trackMediaType",_l.AUDIO),j(this,"_encoderConfig",void 0),j(this,"_trackSource",void 0),j(this,"metadata",[]),j(this,"_enabled",!0),j(this,"_volume",100),j(this,"_useAudioElement",!0),j(this,"_bypassWebAudio",!1),j(this,"processor",void 0),j(this,"_processorContext",void 0),j(this,"_processorDestination",void 0),j(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!r,this._trackSource=new oR,w("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),w("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Pn()&&!Ei?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(e){Ct(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&dr.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void g.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,Ot(this,me.NEED_REPLACE_TRACK,this).then(()=>{g.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(n=>{g.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!XP())throw new W(b.NOT_SUPPORTED,"your browser does not support setting the audio output device");await dr.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,n){return this._setEnabled(e,t,n)}async _setEnabled(e,t,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(g.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await Ot(this,me.NEED_ENABLE_TRACK,this),g.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(r){throw n||(this._enabled=!1),g.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await Ot(this,me.NEED_DISABLE_TRACK,this)}catch(r){throw n||(this._enabled=!0),g.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,g.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Ot(this,me.NEED_MUTE_TRACK,this):await Ot(this,me.NEED_UNMUTE_TRACK,this))}getStats(){return va(()=>{g.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),ni(this,me.GET_STATS)||Pt({},Jv)}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(_i.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(_i.ON_AUDIO_BUFFER),this._source.on(_i.ON_AUDIO_BUFFER,n=>e(n))}play(){g.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(g.debug("[".concat(this.getTrackId(),"] start audio playback in element")),dr.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){g.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?dr.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];g.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&dr.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ot(this,me.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return se.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new W(b.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new W(b.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(e){e.on(Sr.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await Ot(this,me.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ot(this,me.NEED_REPLACE_TRACK,this))}),e.on(Sr.ON_NODE,t=>{this._source.processedNode=t})}unbindProcessorDestinationEvents(e){e.removeAllListeners(Sr.ON_TRACK),e.removeAllListeners(Sr.ON_NODE)}bindProcessorContextEvents(e){e.on(mi.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(e){e.removeAllListeners(mi.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof oR&&(this._trackSource=new nR(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new EL(this._source.context,this.getTrackId(),"local"),t=new mL(e);return this._processorContext=e,this._processorDestination=t,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(t),this._source.on(_i.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(dr.stop(this.getTrackId()),this._source.play()),Ot(this,me.NEED_REPLACE_MIXING_TRACK,this).then(()=>{g.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(n=>{g.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n)})),{processorContext:e,processorDestination:t}}}).prototype,"setVolume",[CL],Object.getOwnPropertyDescriptor(Yt.prototype,"setVolume"),Yt.prototype),tt(Yt.prototype,"setPlaybackDevice",[IL,wL],Object.getOwnPropertyDescriptor(Yt.prototype,"setPlaybackDevice"),Yt.prototype),tt(Yt.prototype,"setEnabled",[AL,bL,OL],Object.getOwnPropertyDescriptor(Yt.prototype,"setEnabled"),Yt.prototype),tt(Yt.prototype,"setMuted",[NL,DL,PL],Object.getOwnPropertyDescriptor(Yt.prototype,"setMuted"),Yt.prototype),tt(Yt.prototype,"getStats",[LL],Object.getOwnPropertyDescriptor(Yt.prototype,"getStats"),Yt.prototype),tt(Yt.prototype,"setAudioFrameCallback",[kL],Object.getOwnPropertyDescriptor(Yt.prototype,"setAudioFrameCallback"),Yt.prototype),tt(Yt.prototype,"play",[ML,UL],Object.getOwnPropertyDescriptor(Yt.prototype,"play"),Yt.prototype),tt(Yt.prototype,"stop",[xL,VL],Object.getOwnPropertyDescriptor(Yt.prototype,"stop"),Yt.prototype),tt(Yt.prototype,"close",[FL],Object.getOwnPropertyDescriptor(Yt.prototype,"close"),Yt.prototype),tt(Yt.prototype,"pipe",[BL],Object.getOwnPropertyDescriptor(Yt.prototype,"pipe"),Yt.prototype),tt(Yt.prototype,"unpipe",[jL],Object.getOwnPropertyDescriptor(Yt.prototype,"unpipe"),Yt.prototype),Yt),Rh=(GL=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),WL=Qt(),HL=cl("MicrophoneAudioTrack","_enabledMutex"),KL=Ie({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),YL=Qt(),zL=Ie({argsMap:e=>[e.getTrackId()]}),tt((fs=class extends Zt{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,n,r){super(e,t.encoderConfig?F_(t.encoderConfig):{},r,w("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),j(this,"_config",void 0),j(this,"_deviceName","default"),j(this,"_constraints",void 0),j(this,"_originalConstraints",void 0),j(this,"_enabled",!0),this._config=t,this._constraints=n,this._originalConstraints=n,this._deviceName=e.label,typeof t.bypassWebAudio=="boolean"&&(this._bypassWebAudio=t.bypassWebAudio),(il()||yv())&&Rt.bindInterruptDetectorTrack(this)}async setDevice(e){if(g.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await Si.getDeviceById(e),n={};n.audio=Pt({},this._constraints),n.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let r=null;try{r=await gi(n,this.getTrackId())}catch(i){throw g.error("[".concat(this.getTrackId(),"] setDevice failed"),i.toString()),r=await gi({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),i}await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw g.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const t=await Si.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw g.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}g.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,n){if(t)return g.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(g.info("[".concat(this.getTrackId(),"] start setEnabled"),e),w("AUTO_RESET_AUDIO_ROUTE")&&(sr()||ro())){const s=navigator.audioSession;s&&(e||(s.type="playback"),s.type="auto")}if(!e){var r;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(r=this._source.clonedTrack)===null||r===void 0||r.stop(),n||(this._enabled=!1);try{await Ot(this,me.NEED_DISABLE_TRACK,this)}catch(s){throw g.error("[".concat(this.getTrackId(),"] setEnabled false failed"),s.toString()),s}return}const i=Pt({},this._constraints),o=Si.searchDeviceIdByName(this._deviceName);o&&!i.deviceId&&(i.deviceId=o);try{n||(this._enabled=!0);const s=await gi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!1),await Ot(this,me.NEED_ENABLE_TRACK,this)}catch(s){throw n||(this._enabled=!1),g.error("[".concat(this.getTrackId(),"] setEnabled true failed"),s.toString()),s}g.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(il()||yv())&&Rt.unbindInterruptDetectorTrack(this),Uc.some(e=>function(t){return"__className__"in t&&t.__className__==="MicrophoneAudioTrack"}(e))||$v&&$v()&&(pe.reportApiInvoke(null,{name:"BG_AUDIO_TAG_RESTART",options:{},tag:It.TRACER}).onSuccess(),g.debug("restart background audio tag success"))}onTrackEnded(){if((sr()||ro())&&this._enabled&&!this._isClosed&&Rt.duringInterruption){const e=async()=>{Rt.off(Gn.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(g.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Rt.on(Gn.IOS_INTERRUPTION_END,e)}else g.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(fl.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,n=Si.searchDeviceIdByName(this._deviceName);if(n&&!t.deviceId&&(t.deviceId=n),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const r=await gi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(mi.REQUEST_UPDATE_CONSTRAINTS,async(t,n,r)=>{try{const i=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(i),n()}catch(i){r(i)}})}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(mi.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[GL,WL],Object.getOwnPropertyDescriptor(fs.prototype,"setDevice"),fs.prototype),tt(fs.prototype,"setEnabled",[HL,KL,YL],Object.getOwnPropertyDescriptor(fs.prototype,"setEnabled"),fs.prototype),tt(fs.prototype,"close",[zL],Object.getOwnPropertyDescriptor(fs.prototype,"close"),fs.prototype),fs),yq=(qL=Ie({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),XL=Qt(),JL=Ie({argsMap:e=>[e.getTrackId()]}),QL=Qt(),ZL=Ie({argsMap:e=>[e.getTrackId()]}),$L=Qt(),ek=Ie({argsMap:e=>[e.getTrackId()]}),tk=Qt(),nk=Ie({argsMap:e=>[e.getTrackId()]}),rk=Qt(),ik=Ie({argsMap:e=>[e.getTrackId()]}),ok=Ie({argsMap:e=>[e.getTrackId()]}),sk=Qt(),tt((Xn=class extends Zt{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,n,r){super(t.createOutputTrack(),n,r),j(this,"source",void 0),j(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=t,this._bufferSource.on(_i.AUDIO_SOURCE_STATE_CHANGE,i=>{this.safeEmit(fl.SOURCE_STATE_CHANGE,i)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){Ct(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}).prototype,"startProcessAudioBuffer",[qL,XL],Object.getOwnPropertyDescriptor(Xn.prototype,"startProcessAudioBuffer"),Xn.prototype),tt(Xn.prototype,"pauseProcessAudioBuffer",[JL,QL],Object.getOwnPropertyDescriptor(Xn.prototype,"pauseProcessAudioBuffer"),Xn.prototype),tt(Xn.prototype,"seekAudioBuffer",[ZL,$L],Object.getOwnPropertyDescriptor(Xn.prototype,"seekAudioBuffer"),Xn.prototype),tt(Xn.prototype,"resumeProcessAudioBuffer",[ek,tk],Object.getOwnPropertyDescriptor(Xn.prototype,"resumeProcessAudioBuffer"),Xn.prototype),tt(Xn.prototype,"stopProcessAudioBuffer",[nk,rk],Object.getOwnPropertyDescriptor(Xn.prototype,"stopProcessAudioBuffer"),Xn.prototype),tt(Xn.prototype,"close",[ik],Object.getOwnPropertyDescriptor(Xn.prototype,"close"),Xn.prototype),tt(Xn.prototype,"setAudioBufferPlaybackSpeed",[ok,sk],Object.getOwnPropertyDescriptor(Xn.prototype,"setAudioBufferPlaybackSpeed"),Xn.prototype),Xn);class mn extends Zt{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=El().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,_t(8,"track-mix-")),j(this,"trackList",void 0),j(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(g.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):g.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){g.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}A_(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach(n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(t.stereo=!0))}),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach(n=>{n instanceof mn?n.emit(xc.TRANSCEIVER_UPDATED,t):n._updateRtpTransceiver(t)}))}}class Cq extends aL{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(_i.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),j(this,"audioBuffer",void 0),j(this,"sourceNode",void 0),j(this,"startPlayTime",0),j(this,"startPlayOffset",0),j(this,"pausePlayTime",0),j(this,"options",void 0),j(this,"currentLoopCount",0),j(this,"currentPlaybackSpeed",100),j(this,"_currentState","stopped"),this.audioBuffer=t,this.options=n,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){this.currentState==="stopped"?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):g.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=t,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){const t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}const ak=new Map;function ck(e,t){if(e.length===0||t.length===0)return 1/0;const n=Lv(e),r=Lv(t);return Math.floor(r/n)}class aR{get rendFrameRate(){const t=Math.max(1,ck(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/t)}get videoElementStatus(){return this._isInPage?this._videoElementStatus:$n.DESTROYED}set videoElementStatus(t){t!==this._videoElementStatus&&(g.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}get videoState(){return this._videoState}set videoState(t){var n;t!==this._videoState&&(this._videoState=t,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState))}constructor(t){j(this,"trackId",void 0),j(this,"config",void 0),j(this,"onFirstVideoFrameDecoded",void 0),j(this,"onFirstVideoFrameRender",void 0),j(this,"onVideoBufferReady",void 0),j(this,"onVideoStateChanged",void 0),j(this,"freezeTimeCounterList",[]),j(this,"renderFreezeAccTime",0),j(this,"renderFreezeAccTime2",0),j(this,"isKeepLastFrame",!1),j(this,"isDestroyed",!1),j(this,"timeUpdatedCount",0),j(this,"freezeTime",0),j(this,"playbackTime",0),j(this,"lastTimeUpdatedTime",0),j(this,"autoplayFailed",!1),j(this,"videoTrack",void 0),j(this,"videoElement",void 0),j(this,"cacheVideoElement",void 0),j(this,"cancelRVFId",void 0),j(this,"internal",!1),j(this,"_render_interframe_delays",[]),j(this,"_render_interframe_delays_sizes",[]),j(this,"_videoState",ps.VideoStateStopped),j(this,"videoElementCheckInterval",void 0),j(this,"videoElementFreezeTimeout",void 0),j(this,"_videoElementStatus",$n.NONE),j(this,"_isInPage",!0),j(this,"isGettingVideoDimensions",!1),j(this,"startGetVideoDimensions",()=>{const n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return g.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()}),j(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Rt.curState==="running"&&(g.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(tP())),dP()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),j(this,"handleVideoEvents",n=>{switch(n.type){case"play":case"playing":n.type==="play"&&g.debug("[".concat(this.trackId,"] video element status: play")),this.startGetVideoDimensions(),this.videoElementStatus=$n.PLAYING;break;case"loadeddata":if(this.videoState=ps.VideoStateStarting,this.onFirstVideoFrameRender&&this.onFirstVideoFrameRender(),this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=$n.CANPLAY;break;case"stalled":this.videoElementStatus=$n.STALLED;break;case"suspend":this.videoElementStatus=$n.SUSPEND;break;case"pause":this.videoElementStatus=$n.PAUSED,sr()||ro()||Pn()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(g.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=$n.WAITING;break;case"abort":this.videoElementStatus=$n.ABORT;break;case"ended":this.videoElementStatus=$n.ENDED;break;case"emptied":this.videoElementStatus=$n.EMPTIED;break;case"error":{const r=this.videoElement.error;r&&(this.videoElementStatus=$n.ERROR,g.error("[".concat(this.trackId,"] media error: ").concat(r.message," (").concat(r.code,")")));break}case"timeupdate":{const r=performance.now();if(this.timeUpdatedCount+=1,this.onVideoBufferReady&&this.timeUpdatedCount>w("BUFFER_READY_FRAMES")&&this.onVideoBufferReady(),this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=r);const i=r-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=r,ri.lastVisibleTime<ri.lastHiddenTime||o<ri.lastHiddenTime||o<ri.lastVisibleTime||this.isSkipCalcRenderFreezeTime())return;for(i>w("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=i),this.playbackTime+=i;this.playbackTime>=6e3;){this.playbackTime-=6e3;const s=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(s),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),j(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(g.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(tP())),dP()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),Rt.on(Gn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Rt.on(Gn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const n=this.videoElement.play();n&&n.catch&&n.catch(i=>{t&&pL(t,"video",i.message,this.trackId),i.name==="NotAllowedError"?(g.warning("detected video element autoplay failed",i),this.autoplayFailed=!0,this.handleAutoPlayFailed()):g.warning("[".concat(this.trackId,"] play warning: "),i)});const r=ot();if((r.name==="Safari"&&Number(r.version)===15||il())&&n&&n.then){const i=()=>{this.config.mirror&&!this.config.noStyle&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(i).catch(i)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const n=t.getContext("2d");if(!n)return g.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,t.width,t.height);const r=n.getImageData(0,0,t.width,t.height);return t.remove(),r}async getCurrentFrameToUint8Array(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const r=document.createElement("canvas");r.width=this.videoElement.videoWidth,r.height=this.videoElement.videoHeight;const i=r.getContext("2d");return i?(i.drawImage(this.videoElement,0,0,r.width,r.height),new se((o,s)=>{r.toBlob(async c=>{if(r.remove(),c){const l=await yL(c);o({buffer:l,width:r.width,height:r.height})}else s(new W(b.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,n<0?.1:n>1?1:n)})):await sR(t)}destroy(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this.isDestroyed=!0,Rt.off(Gn.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Rt.off(Gn.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),t?this.videoElement.pause():this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=ps.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=$n.INIT,!this.videoElementCheckInterval&&(dk.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{this._isInPage=function(o){return o!==document.body&&document.body.contains(o)}(this.videoElement)},1e3),w("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,n;let o;const s=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",s),this.videoElementFreezeTimeout=window.setTimeout(c,w("VIDEO_FREEZE_DURATION")))},c=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===ps.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=ps.VideoStateFrozen:document.addEventListener("visibilitychange",s))},l=(u,h)=>{if(this.videoElementStatus===$n.PLAYING){if(o){const E=h.presentationTime-o.presentationTime,I=h.presentedFrames-o.presentedFrames;this._render_interframe_delays_sizes.push(I),this._render_interframe_delays.push(E);const v=Lv(this._render_interframe_delays_sizes),R=v-this._render_interframe_delays_sizes[0];if(v>30&&R>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===ps.VideoStateStarting&&(this.videoState=ps.VideoStateDecoding),this.videoState===ps.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(c,w("VIDEO_FREEZE_DURATION"))),E<w("VIDEO_FREEZE_DURATION")&&this.videoState===ps.VideoStateFrozen&&(this.videoState=ps.VideoStateDecoding),E>w("VIDEO_FREEZE_DURATION")&&ri.lastVisibleTime>=ri.lastHiddenTime&&o.timestamp>ri.lastVisibleTime&&o.timestamp>ri.lastHiddenTime){const A=Math.min(66,ck(this._render_interframe_delays_sizes,this._render_interframe_delays)),O=Math.max(0,E-(I-1)*A);this.renderFreezeAccTime2+=O>A?O:0,this.renderFreezeAccTime+=E}}o=Pt(Pt({},h),{},{timestamp:u})}else this.isSkipCalcRenderFreezeTime()&&(o=Pt(Pt({},h),{},{timestamp:u}));var f,_;w("ENABLE_VIDEO_FRAME_CALLBACK")&&(this.cancelRVFId=(f=(_=this.videoElement).requestVideoFrameCallback)===null||f===void 0?void 0:f.call(_,l))};this.cancelRVFId=(t=(n=this.videoElement).requestVideoFrameCallback)===null||t===void 0?void 0:t.call(n,l)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),hh()&&!w("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const r=ot();this.config.noStyle||(r.name==="Safari"&&Number(r.version)===15||il()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover"),this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,kt()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,kt()&&this.videoElement.load());const i=this.videoElement.play();i!==void 0&&i.catch(o=>{g.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){var t,n;dk.forEach(r=>{this.videoElement&&this.videoElement.removeEventListener(r,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.cancelRVFId&&this.videoElement&&((t=(n=this.videoElement).cancelVideoFrameCallback)===null||t===void 0||t.call(n,this.cancelRVFId),this.cancelRVFId=void 0),this.videoElementStatus=$n.NONE}isSkipCalcRenderFreezeTime(){return this.videoElementStatus===$n.DESTROYED||this.internal}handleAutoPlayFailed(){const t=n=>{n.preventDefault(),this.videoElement.play().then(()=>{g.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(r=>{g.error(r)}),this.autoplayFailed=!1,ph()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};ph()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),hL()}}const dk=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class W_ extends aR{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];super(t),j(this,"container",void 0),j(this,"slot",void 0),this.slot=t.element,this.internal=n,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const n=t.element;var r;!this.internal||this.slot?(n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()):(this.slot=n,n&&this.container?(this.internal=!1,this.container.id="agora-video-player-".concat(this.trackId),this.videoElement.id="video_".concat(this.trackId),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",(r=this.slot)===null||r===void 0||r.appendChild(this.container)):this.createElements())}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var n;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,r):await sR(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{var t;this.container.remove(),(t=this.slot)===null||t===void 0||t.removeChild(this.container)}catch{}this.container=void 0}}createElements(){var t;this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",w("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),(t=this.slot)===null||t===void 0||t.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var lk,uk,hk,pk,fk,_k,mk,Ek,gk,Sk,Tk,vk,Rk,yk,Ck,Ik,wk,Ak,bk,Ok,Nk,Dk,Pk,Lk,kk,Mk,Uk,xk,Je,Vk,Fk,Bk,jk,Gk,Wk,Hk,Kk,Ti;let wt=(lk=Ie({argsMap:(e,t,n)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),uk=Qt(),hk=Ie({argsMap:e=>[e.getTrackId()]}),pk=cl("LocalVideoTrack","_enabledMutex"),fk=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),_k=Qt(),mk=cl("LocalVideoTrack","_enabledMutex"),Ek=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),gk=Qt(),Sk=Ie({argsMap:(e,t)=>[e.getTrackId(),t,e._saveEncodeBitrateRatio]}),Tk=Qt(),vk=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),Rk=Qt(),yk=Qt(),Ck=Ie({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),Ik=Qt(),wk=Qt(),Ak=Qt(),bk=Ie({argsMap:e=>[e.getTrackId()]}),Ok=Qt(),Nk=Qt(),Dk=Qt(),Pk=Qt(),Lk=Qt(),kk=Ie({argsMap:(e,t)=>[e.getTrackId(),t.name]}),Mk=Ie({argsMap:e=>[e.getTrackId()]}),Uk=Ie({argsMap:e=>[e.getTrackId()]}),xk=Ie({argsMap:(e,t,n)=>[e.getTrackId(),t.label,n]}),Je=class ZB extends ml{get videoHeight(){if(Pn()){const{height:t}=this._mediaStreamTrack.getSettings();return this._videoHeight=t,this._videoHeight}return this._videoHeight}get videoWidth(){if(Pn()){const{width:t}=this._mediaStreamTrack.getSettings();return this._videoWidth=t,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==$n.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,n,r,i,o,s){if(super(t,o),j(this,"trackMediaType",_l.VIDEO),j(this,"_player",void 0),j(this,"isUseScaleResolutionDownBy",!1),j(this,"_videoVisibleTimer",null),j(this,"_previousVideoVisibleStatus",void 0),j(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),j(this,"_encoderConfig",void 0),j(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),j(this,"_optimizationMode",void 0),j(this,"_saveEncodeBitrateRatio",1),j(this,"_videoHeight",void 0),j(this,"_videoWidth",void 0),j(this,"_forceBitrateLimit",void 0),j(this,"_enabled",!0),j(this,"_processorDestination",void 0),j(this,"_processorContext",void 0),Pn()){const{width:c,height:l}=t.getSettings();this._videoWidth=c,this._videoHeight=l}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=r,this._optimizationMode=i,this._hints=s||[],n&&this._hints.indexOf(pt.CUSTOM_TRACK)!==-1?this._encoderConfig=Mt(n):this._encoderConfig=n,this._hints.indexOf(pt.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(Tv(at.CHROME,115)&&I_().indexOf("Windows")!==-1){const c=function(l,u){if("VideoFrame"in window&&"TransformStream"in window&&Xe().supportWebRTCInsertableStream){const h=new MediaStreamTrackProcessor(l),f=new MediaStreamTrackGenerator({kind:"video"});let _,E,I=Date.now();const v=()=>{R&&(clearInterval(R),R=void 0),_&&(_.close(),_=void 0),l.stop(),E=void 0,f.removeEventListener("ended",v)};let R=window.setInterval(()=>{if(E&&_&&Date.now()-I>1e3)try{f.readyState==="live"?E.enqueue(_.clone()):v()}catch{v()}},1e3);const A=new TransformStream({transform:(O,P)=>{f.readyState==="live"?(E=P,I=Date.now(),_===void 0?(_=O,P.enqueue(O.clone())):(P.enqueue(_),_=O)):O.close()}});return f.addEventListener("ended",v),h.readable.pipeThrough(A).pipeTo(f.writable),f}}(t);c&&(g.info("local screen video track begin to inject frame"),this._mediaStreamTrack=c)}n&&this._hints.indexOf(pt.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new _L(this.getTrackId(),"local"),this._processorDestination=new fL(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const i=document.getElementById(t);i?t=i:(g.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}g.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const r=Pt(Pt(Pt({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(r):(t instanceof HTMLVideoElement?this._player=new aR(r):this._player=new W_(r),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const i=this.getVideoElementVisibleStatus();this.safeEmit(fl.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}},w("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,g.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(g.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await Ot(this,me.NEED_DISABLE_TRACK,this)}catch(r){throw g.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}return n||(this._enabled=!1),void g.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Ot(this,me.NEED_ENABLE_TRACK,this)}catch(r){throw g.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}g.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,g.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Ot(this,me.NEED_MUTE_TRACK,this):await Ot(this,me.NEED_UNMUTE_TRACK,this))}async setSaveEncodeBitrateRatio(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this._saveEncodeBitrateRatio;if(this._saveEncodeBitrateRatio!==1&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*t),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*t),g.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(t)),this._saveEncodeBitrateRatio=1;try{await Ot(this,me.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(g)}}}async setEncoderConfiguration(t,n){if(!this._enabled)throw new W(b.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t=co(t),w("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const r=G_({encoderConfig:t});(Pn()||sr()||ro())&&(r.deviceId=void 0),g.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(i){const o=new W(b.UNEXPECTED_ERROR,i.toString());throw g.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=t,this._hints.indexOf(pt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ot(this,me.NEED_UPDATE_VIDEO_ENCODER,this)}catch(r){return r.throw(g)}}getStats(){return va(()=>{g.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),ni(this,me.GET_STATS)||Pt({},Qv)}async setBeautyEffect(t){g.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,n):await sR(t)}async findClosestProfile(){const{width:t,height:n,frameRate:r}=this.getMediaStreamTrackSettings(),{width:i,height:o,frameRate:s}=this._encoderConfig||{},c=al(this._videoWidth||t||i||0),l=al(this._videoHeight||n||o||0),u=function(h,f,_){if(!Array.isArray(w("VIDEO_ENCODER_CONFIG_LIST"))||w("VIDEO_ENCODER_CONFIG_LIST").length===0)return!1;const E=Math.min(h,f);return!(E>=480)&&Pt(Pt({},w("VIDEO_ENCODER_CONFIG_LIST").find(I=>I.height>E)),{},{frameRate:_})}(c,l,al(r||s||15));if(u)return g.debug("[".concat(this.getTrackId(),"] find closest profile, ").concat(c,"x").concat(l," => ").concat(JSON.stringify(u))),this.setEncoderConfiguration(u)}async setBitrateLimit(t){g.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t&&(this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate))}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void g.error(b.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const n=this._optimizationMode;try{this._optimizationMode=t,await Ot(this,me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(r){throw this._optimizationMode=n,g.error("[".concat(this.getTrackId(),"] set optimization mode failed"),r.toString()),r}g.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return g.error(b.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,g.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){gL(this._originMediaStreamTrack).then(t=>{let[n,r]=t;this._videoHeight=r,this._videoWidth=n}).catch(mh)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new W(b.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");g.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=co(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf(pt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ot(this,me.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(g)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:n,frameRate:r}=this.getMediaStreamTrackSettings();if(!t||!n||!r)return;const{bitrateMax:i,bitrateMin:o}=this._encoderConfig;if(o==null||i==null){const{max:s,min:c}=function(l,u,h,f,_){const E=w("BITRATE_ADAPTER_TYPE");if(E==="DEFAULT_BITRATE")return{min:f,max:_};if(_===void 0){const I=Math.floor(200*Math.pow(h/15,.6)*Math.pow(l*u/640/360,.75));_=E==="STANDARD_BITRATE"?4*I:2*I,f=f??I}else f=f??Math.floor(_/10);return{min:f,max:_}}(t,n,r,o,i);if(this._encoderConfig.bitrateMin=c,this._encoderConfig.bitrateMax=s,w("VIDEO_STANDARD_BITRATE_VERSION")&&o==null&&i==null){const[l,u]=function(h,f,_){const E=4*Math.floor(2e5*Math.pow(_/15,.6)*Math.pow(h*f/230400,.75)),I=h*f,v=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),R=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]);let A=$r(v).call(v).next().value,O=1;if(v.has(I))A=v.get(I);else{var P;const de=gc(P=Array.from(v.entries())).call(P,(Ae,Ge)=>{let[xe]=Ae,[ct]=Ge;return xe-ct}),Ne=de.find(Ae=>{let[Ge]=Ae;return Ge>I});if(Ne){const Ae=de.indexOf(Ne);if(Ae>0){const Ge=de[Ae-1],xe=(I-Ge[0])/(Ne[0]-Ge[0]);A=Ge[1]+xe*(Ne[1]-Ge[1])}else A=Ne[1]}else A=de[de.length-1][1]}if(R.has(I))O=R.get(I);else{var M;const de=gc(M=Array.from(R.entries())).call(M,(Ae,Ge)=>{let[xe]=Ae,[ct]=Ge;return xe-ct}),Ne=de.find(Ae=>{let[Ge]=Ae;return Ge>I});if(Ne){const Ae=de.indexOf(Ne);if(Ae>0){const Ge=de[Ae-1],xe=(I-Ge[0])/(Ne[0]-Ge[0]);O=Ge[1]+xe*(Ne[1]-Ge[1])}else O=Ne[1]}else O=de[de.length-1][1]}const U=w("VIDEO_NEW_BITRATE_RATIO");U&&U>0&&(A=U/100);const L=Math.floor(E*A),V=Math.floor(65e4*Math.pow(h*f/230400,.5)*Math.pow(_/15,.69));let H=L;const q=w("VIDEO_STANDARD_BITRATE_VERSION");return q&&q>0&&(q===1?H=E:q===2?H=L:q===3&&(H=V)),[Math.floor(H/1e3),O]}(t,n,r);this._encoderConfig.bitrateMax=l,this._encoderConfig.bitrateMin=c?Math.min(c,l):l,this._saveEncodeBitrateRatio=u,g.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(t,", h: ").concat(n,", fps: ").concat(r,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else g.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(n,", fps: ").concat(r,"] => [brMax: ").concat(s,", brMin: ").concat(c,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var t,n;const r=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),i={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:r==null?void 0:r.parentElement},{element:o,slot:s}=i;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){const c=EP.checkOneElementVisible(o),l=Object.assign({},c);if(l.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=l.visible;const u=pe.reportApiInvoke(null,{tag:It.TRACER,name:Ft.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});l.visible?u.onSuccess("Video is visible"):u.onSuccess("Invisible because of ".concat(l.reason))}return l}return}catch(r){throw new W(b.GET_VIDEO_ELEMENT_VISIBLE_ERROR,r.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new W(b.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;t&&(r=Pt(Pt({},r),co(t))),r=Dc(r);const i=_t(8,"track-video-cloned-"),o=new ZB(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,r,Dc(this._scalabilityMode),this._optimizationMode,i,Dc(this._hints));return t&&r&&o.setEncoderConfiguration(r),g.debug("clone video track from ".concat(this.getTrackId()," to ").concat(i,", clone ").concat(n)),o}async replaceTrack(t,n){if(!(t instanceof MediaStreamTrack))throw new W(b.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new W(b.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,n,!0),this.updateMediaStreamTrackResolution()}sendSeiData(t){if(va(()=>{pe.reportApiInvoke(null,{name:Ft.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:It.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!w("ENABLE_VIDEO_SEI")||!w("ENABLE_ENCODED_TRANSFORM"))return void g.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(t instanceof Uint8Array==0)return new W(b.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const n=this.getRTCRtpTransceiver();if(!n)return void g.warning("Video track is not published, SEI can not be send");const r=n.sender.getParameters();if(r.codecs.length===0)return;const i=r.codecs[0].mimeType.toLocaleLowerCase();i==="video/h264"||i==="video/h265"?this.safeEmit("sei-to-send",t):g.warning("SEI is not supported by ".concat(i))}bindProcessorDestinationEvents(){this.processorDestination.on(Sr.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await Ot(this,me.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ot(this,me.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Sr.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(mi.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(mi.REQUEST_CONSTRAINTS)}},tt(Je.prototype,"play",[lk,uk],Object.getOwnPropertyDescriptor(Je.prototype,"play"),Je.prototype),tt(Je.prototype,"stop",[hk],Object.getOwnPropertyDescriptor(Je.prototype,"stop"),Je.prototype),tt(Je.prototype,"setEnabled",[pk,fk,_k],Object.getOwnPropertyDescriptor(Je.prototype,"setEnabled"),Je.prototype),tt(Je.prototype,"setMuted",[mk,Ek,gk],Object.getOwnPropertyDescriptor(Je.prototype,"setMuted"),Je.prototype),tt(Je.prototype,"setSaveEncodeBitrateRatio",[Sk,Tk],Object.getOwnPropertyDescriptor(Je.prototype,"setSaveEncodeBitrateRatio"),Je.prototype),tt(Je.prototype,"setEncoderConfiguration",[vk,Rk],Object.getOwnPropertyDescriptor(Je.prototype,"setEncoderConfiguration"),Je.prototype),tt(Je.prototype,"getStats",[yk],Object.getOwnPropertyDescriptor(Je.prototype,"getStats"),Je.prototype),tt(Je.prototype,"setBeautyEffect",[Ck,Ik],Object.getOwnPropertyDescriptor(Je.prototype,"setBeautyEffect"),Je.prototype),tt(Je.prototype,"getCurrentFrameData",[wk],Object.getOwnPropertyDescriptor(Je.prototype,"getCurrentFrameData"),Je.prototype),tt(Je.prototype,"getCurrentFrameImage",[Ak],Object.getOwnPropertyDescriptor(Je.prototype,"getCurrentFrameImage"),Je.prototype),tt(Je.prototype,"findClosestProfile",[bk,Ok],Object.getOwnPropertyDescriptor(Je.prototype,"findClosestProfile"),Je.prototype),tt(Je.prototype,"setBitrateLimit",[Nk],Object.getOwnPropertyDescriptor(Je.prototype,"setBitrateLimit"),Je.prototype),tt(Je.prototype,"setOptimizationMode",[Dk],Object.getOwnPropertyDescriptor(Je.prototype,"setOptimizationMode"),Je.prototype),tt(Je.prototype,"setScalabiltyMode",[Pk],Object.getOwnPropertyDescriptor(Je.prototype,"setScalabiltyMode"),Je.prototype),tt(Je.prototype,"updateMediaStreamTrackResolution",[Lk],Object.getOwnPropertyDescriptor(Je.prototype,"updateMediaStreamTrackResolution"),Je.prototype),tt(Je.prototype,"pipe",[kk],Object.getOwnPropertyDescriptor(Je.prototype,"pipe"),Je.prototype),tt(Je.prototype,"unpipe",[Mk],Object.getOwnPropertyDescriptor(Je.prototype,"unpipe"),Je.prototype),tt(Je.prototype,"close",[Uk],Object.getOwnPropertyDescriptor(Je.prototype,"close"),Je.prototype),tt(Je.prototype,"replaceTrack",[xk],Object.getOwnPropertyDescriptor(Je.prototype,"replaceTrack"),Je.prototype),Je),H_=(Vk=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),Fk=Qt(),Bk=cl("CameraVideoTrack","_enabledMutex"),jk=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),Gk=Qt(),Wk=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),Hk=Qt(),Kk=Ie({argsMap:e=>[e.getTrackId()]}),Ti=class $B extends wt{get __className__(){return"CameraVideoTrack"}constructor(t,n,r,i,o,s){super(t,co(n.encoderConfig),i,o,s),j(this,"_config",void 0),j(this,"_originalConstraints",void 0),j(this,"_constraints",void 0),j(this,"_enabled",!0),j(this,"_deviceName","default"),j(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(il()||yv())&&!function(){const c=ot();if(c.os!==Cn.IOS||!c.osVersion)return!1;const l=c.osVersion.split(".");return Number(l[0])===15&&Number(l[1])>=2}()&&lP()&&this._enabled&&!this._isClosed&&(g.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=n,this._originalConstraints=r,this._constraints=r,this._deviceName=t.label,this._encoderConfig=co(this._config.encoderConfig),Rt.on(Gn.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Rt.on(Gn.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(g.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const n=await Si.getDeviceById(t),r={};r.video=Pt({},this._constraints),r.video.deviceId={exact:t},r.video.facingMode=void 0,this._originMediaStreamTrack.stop();let i=null;try{i=await gi(r,this.getTrackId())}catch(o){throw g.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),i=await gi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(n){throw g.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await Si.getDeviceById(t);this._deviceName=n.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(n){throw g.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}g.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){g.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));const n={video:Pt(Pt({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let r=null;try{r=await gi(n,this.getTrackId())}catch(i){throw g.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),i.toString()),r=await gi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),i}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=Pt({},n.video),g.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(g.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const r=await gi({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1)}await Ot(this,me.NEED_ENABLE_TRACK,this)}catch(r){throw g.error("[".concat(this.getTrackId(),"] setEnabled true error"),r.toString()),r}this.updateMediaStreamTrackResolution(),g.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await Ot(this,me.NEED_DISABLE_TRACK,this)}catch(r){throw g.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}g.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,n){if(!this._enabled)throw new W(b.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t=co(t),w("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate||t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate||t.bitrateMin);const r=Mt(this._config);r.encoderConfig=t;const i=G_(r);(Pn()||sr()||ro())&&(i.deviceId=void 0),g.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(o){const s=new W(b.UNEXPECTED_ERROR,o.toString());throw g.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}this._config=r,this._constraints=i,this._originalConstraints=i,this._encoderConfig=t,this._hints.indexOf(pt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ot(this,me.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(g)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((sr()||ro())&&this._enabled&&!this._isClosed&&Rt.duringInterruption){const t=async()=>{Rt.off(Gn.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(g.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Rt.on(Gn.IOS_INTERRUPTION_END,t)}else g.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(fl.TRACK_ENDED)}async renewMediaStreamTrack(t){const n=t||this._constraints,r=Si.searchDeviceIdByName(this._deviceName);if(r&&!n.deviceId&&(n.deviceId={exact:r}),this._enabled){const i=await gi({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Rt.off(Gn.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Rt.off(Gn.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;t&&(r=Pt(Pt({},r),co(t))),r=Dc(r);const i=_t(8,"track-cam-cloned-"),o=new $B(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,Dc(Pt(Pt({},this._config),{},{encoderConfig:r})),Dc(this._constraints),Dc(this._scalabilityMode),this._optimizationMode,i);return t&&r&&o.setEncoderConfiguration(r),g.debug("clone track from ".concat(this.getTrackId()," to ").concat(i,", clone ").concat(n)),o}bindProcessorContextEvents(){this.processorContext.on(mi.REQUEST_UPDATE_CONSTRAINTS,async(t,n,r)=>{try{const i=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(i),n()}catch(i){r(i)}}),this.processorContext.on(mi.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}},tt(Ti.prototype,"setDevice",[Vk,Fk],Object.getOwnPropertyDescriptor(Ti.prototype,"setDevice"),Ti.prototype),tt(Ti.prototype,"setEnabled",[Bk,jk,Gk],Object.getOwnPropertyDescriptor(Ti.prototype,"setEnabled"),Ti.prototype),tt(Ti.prototype,"setEncoderConfiguration",[Wk,Hk],Object.getOwnPropertyDescriptor(Ti.prototype,"setEncoderConfiguration"),Ti.prototype),tt(Ti.prototype,"close",[Kk],Object.getOwnPropertyDescriptor(Ti.prototype,"close"),Ti.prototype),Ti);function Yk(e){const t=_t(8,"track-cus-"),n=pe.reportApiInvoke(null,{id:t,tag:It.TRACER,name:Ft.CREATE_CUSTOM_AUDIO_TRACK,options:[e]}),r=new Zt(e.mediaStreamTrack,e.encoderConfig?F_(e.encoderConfig):{},t,!1);return g.info("create custom audio track success with config",e,"trackId",r.getTrackId()),n.onSuccess(r.getTrackId()),r}function cR(e,t,n,r){n.optimizationMode&&(r&&r.width&&r.height?(n.encoderConfig=Pt(Pt({},r),{},{bitrateMin:r.bitrateMin,bitrateMax:r.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(t.contentHint=n.optimizationMode,t.contentHint===n.optimizationMode?g.debug("[".concat(e,"] set content hint to"),n.optimizationMode):g.debug("[".concat(e,"] set content hint failed")))):g.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}var zk,qk,Xk,Jk,Ui,Qk,Zk,$k,e1,t1,n1,r1,Jn;class i1 extends iL{getUserId(){return this._userId}constructor(t,n,r,i){super(t,"track-".concat(t.kind,"-").concat(n,"-").concat(i.clientId,"_").concat(_t(5,""))),j(this,"_userId",void 0),j(this,"_uintId",void 0),j(this,"_isDestroyed",!1),j(this,"store",void 0),j(this,"processor",void 0),j(this,"processorContext",void 0),this._userId=n,this._uintId=r,this.store=i}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,g.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let Sl=(zk=Ie({argsMap:(e,t,n)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),qk=Ie({argsMap:e=>[e.getTrackId()]}),Xk=Ie({argsMap:(e,t)=>[e.getTrackId(),t.name]}),Jk=Ie({argsMap:e=>[e.getTrackId()]}),tt((Ui=class extends i1{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==$n.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,n,r,i){super(e,t,n,r),j(this,"_videoVisibleTimer",null),j(this,"_previousVideoVisibleStatus",void 0),j(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),j(this,"trackMediaType",_l.VIDEO),j(this,"_videoWidth",void 0),j(this,"_videoHeight",void 0),j(this,"_player",void 0),j(this,"_prePlayer",void 0),j(this,"processorDestination",void 0),j(this,"processorContext",void 0),this._prePlayer=i,this.updateMediaStreamTrackResolution(),this.processorContext=new _L(this.getTrackId(),"remote"),this.processorDestination=new fL(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return va(()=>{g.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),ni(this,me.GET_STATS)||Pt({},nL)}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(this.safeEmit(Mi.PLAY_START),typeof e=="string"){const r=document.getElementById(e);r?e=r:(g.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}g.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const n=Pt(Pt({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});if(this._player)this._player.updateConfig(n);else{let r=!1,i=!1;e instanceof HTMLVideoElement?(this._player=new aR(n),this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0,i=!0)):this._prePlayer&&!this._prePlayer.isDestroyed?(this._player=this._prePlayer,this._prePlayer=void 0,r=this._player.videoState>0,this._player.updateConfig(n)):this._player=new W_(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Mi.FIRST_FRAME_DECODED),i&&this.safeEmit(Mi.FIRST_FRAME_RENDER)},this._player.onVideoStateChanged=o=>{this.safeEmit(Mi.VIDEO_STATE_CHANGED,o)},r&&(this._player.onFirstVideoFrameDecoded(),this._player.onVideoStateChanged(this._player.videoState))}this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(Mi.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},w("CHECK_VIDEO_VISIBLE_INTERVAL")),this.safeEmit(Mi.PLAY_END)}stop(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(e),this._player=void 0,g.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){gL(this._originMediaStreamTrack).then(e=>{let[t,n]=e;this._videoHeight=n,this._videoWidth=t}).catch(mh)}_updatePlayerSource(){g.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const n=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:n==null?void 0:n.parentElement},{element:i,slot:o}=r;if(this.isPlaying&&i instanceof HTMLVideoElement&&o instanceof HTMLElement){const s=EP.checkOneElementVisible(i),c=Object.assign({},s);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const l=pe.reportApiInvoke(null,{tag:It.TRACER,name:Ft.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?l.onSuccess("Video is visible"):l.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(n){throw new W(b.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new W(b.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Sr.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Sr.ON_TRACK)}_destroy(){this._prePlayer&&(this._prePlayer.destroy(),this._prePlayer=void 0),super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(xc.SEI_RECEIVED,e)}}).prototype,"play",[zk],Object.getOwnPropertyDescriptor(Ui.prototype,"play"),Ui.prototype),tt(Ui.prototype,"stop",[qk],Object.getOwnPropertyDescriptor(Ui.prototype,"stop"),Ui.prototype),tt(Ui.prototype,"pipe",[Xk],Object.getOwnPropertyDescriptor(Ui.prototype,"pipe"),Ui.prototype),tt(Ui.prototype,"unpipe",[Jk],Object.getOwnPropertyDescriptor(Ui.prototype,"unpipe"),Ui.prototype),Ui),Tl=(Qk=Ie({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),Zk=Ie({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),$k=Ie({argsMap:(e,t)=>[e.getTrackId(),t]}),e1=Ie({argsMap:e=>[e.getTrackId()]}),t1=Ie({argsMap:e=>[e.getTrackId()]}),n1=Ie({argsMap:(e,t)=>[e.getTrackId(),t.name]}),r1=Ie({argsMap:e=>[e.getTrackId()]}),tt((Jn=class extends i1{get isPlaying(){return this._useAudioElement?dr.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,n,r){super(e,t,n,r),j(this,"trackMediaType",_l.AUDIO),j(this,"_source",void 0),j(this,"_useAudioElement",!0),j(this,"_volume",100),j(this,"processorContext",void 0),j(this,"processorDestination",void 0),j(this,"_played",!1),j(this,"_bypassWebAudio",!1),w("DISABLE_WEBAUDIO")?(this._source=new oR,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new nR(e,!0),w("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(_i.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Mi.FIRST_FRAME_DECODED)}),this.processorContext=new EL(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new mL(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(_i.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(_i.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(_i.ON_AUDIO_BUFFER),this._source.on(_i.ON_AUDIO_BUFFER,n=>e(n))}setVolume(e){this._volume=e,this._useAudioElement?dr.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}setAmplifiedVolume(e){this._useAudioElement&&this._played&&(dr.stop(this.getTrackId()),this._source.play()),this._useAudioElement=!1,e=Math.min(e,w("MAX_WEBAUDIO_VOLUME")),this._volume=e,this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!XP())throw new W(b.NOT_SUPPORTED,"your browser does not support setting the audio output device");await dr.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getVolume(){return this._useAudioElement?dr.getVolume(this.getTrackId()):this._source instanceof nR?this._source.getAudioVolume():0}getStats(){return va(()=>{g.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),ni(this,me.GET_STATS)||Pt({},tL)}play(){g.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(g.debug("[".concat(this.getTrackId(),"] use audio element to play")),dr.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):(g.debug("[".concat(this.getTrackId(),"] use audio context to play")),this._source.play())}stop(){g.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?dr.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];g.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&dr.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new W(b.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new W(b.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new W(b.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Sr.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(Sr.ON_NODE,e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Sr.ON_TRACK),this.processorDestination.removeAllListeners(Sr.ON_NODE)}}).prototype,"setVolume",[Qk],Object.getOwnPropertyDescriptor(Jn.prototype,"setVolume"),Jn.prototype),tt(Jn.prototype,"setAmplifiedVolume",[Zk],Object.getOwnPropertyDescriptor(Jn.prototype,"setAmplifiedVolume"),Jn.prototype),tt(Jn.prototype,"setPlaybackDevice",[$k],Object.getOwnPropertyDescriptor(Jn.prototype,"setPlaybackDevice"),Jn.prototype),tt(Jn.prototype,"play",[e1],Object.getOwnPropertyDescriptor(Jn.prototype,"play"),Jn.prototype),tt(Jn.prototype,"stop",[t1],Object.getOwnPropertyDescriptor(Jn.prototype,"stop"),Jn.prototype),tt(Jn.prototype,"pipe",[n1],Object.getOwnPropertyDescriptor(Jn.prototype,"pipe"),Jn.prototype),tt(Jn.prototype,"unpipe",[r1],Object.getOwnPropertyDescriptor(Jn.prototype,"unpipe"),Jn.prototype),Jn);const ri=new class extends Wt{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),j(this,"_lastHiddenTime",0),j(this,"_lastVisibleTime",0),j(this,"needUploadStats",[]),j(this,"isCollectingStats",!1),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),this.isCollectingStats&&this.needUploadStats.push(document.visibilityState==="visible"?1:0),g.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}startCollectStats(){this.isCollectingStats=!0,this.needUploadStats.push(this.visibility==="visible"?1:0)}stopCollectStats(){this.isCollectingStats=!1,this.needUploadStats.length=0}};class o1 extends Wt{constructor(t,n){super(),j(this,"trackMediaType",_l.DATA),j(this,"_version",1),j(this,"_type",3),j(this,"_config",void 0),j(this,"_originDataChannel",void 0),j(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),j(this,"_dataStreamPacketHandler",{serialize:r=>r,deserialize:r=>r}),j(this,"_datachannelEventMap",new Map),this._config=t,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader()}useDataStream(t){this._dataStreamPacketHandler=t}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return w("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,n;return(t=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,n;return(t=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new se((t,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();const r=setTimeout(()=>{var i;n(new W(b.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((i=this._originDataChannel)===null||i===void 0?void 0:i.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(r),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(r),new W(b.DATACHANNEL_CONNECTION_TIMEOUT)}}else n(new W(b.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){const t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[B_.OPEN,B_.CLOSE,B_.ERROR].forEach(n=>{const r=()=>{this.emit(n)};this._datachannelEventMap.set(n,r),t.addEventListener(n,r)})}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach(n=>{let[r,i]=n;t.removeEventListener(r,i)}),this._datachannelEventMap.clear()}}class Iq extends o1{constructor(t){super(t),j(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const r=n.data.slice(0,this._dataStreamPacketHeader.byteLength),i=new DataView(r).getUint8(3);if(i!==this.id)return void(w("SHOW_DATASTREAM2_LOG")&&g.debug("invalid datachannel id: ".concat(i," !== ").concat(this.id)));let o=n.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit(B_.MESSAGE,o)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class wq extends o1{send(t){if(this._originDataChannel){let n=t;n=this._dataStreamPacketHandler.serialize(t);const r=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);r.set(new Uint8Array(this._dataStreamPacketHeader),0),r.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(r.buffer)}}}function K_(){const e=new Blob([atob("Y29uc3QgdD0idmlkZW8vaDI2NCIsZT0idmlkZW8vaDI2NSI7ZnVuY3Rpb24gbih0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLHI9W10sbz0wO2Zvcig7ci5sZW5ndGg8bjspbyszPG4mJjA9PT1hW29dJiYwPT09YVtvKzFdJiYzPT09YVtvKzJdJiYoMD09PWFbbyszXXx8MT09PWFbbyszXXx8Mj09PWFbbyszXXx8Mz09PWFbbyszXSk/KHIucHVzaChhW29dLGFbbysxXSxhW28rM10pLG8rPTQpOihyLnB1c2goYVtvXSksbysrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkocil9ZnVuY3Rpb24gYShhLHIpe3N3aXRjaChyKXtjYXNlIHQ6cmV0dXJuIGZ1bmN0aW9uKHQpe2NvbnN0IGU9bmV3IERhdGFWaWV3KHQuZGF0YSk7bGV0IGE9MDtmb3IoO2ErNDx0LmRhdGEuYnl0ZUxlbmd0aDspe2lmKDA9PT1lLmdldFVpbnQ4KGErMCkmJjA9PT1lLmdldFVpbnQ4KGErMSkmJjA9PT1lLmdldFVpbnQ4KGErMikmJjE9PT1lLmdldFVpbnQ4KGErMykmJjY9PT1lLmdldFVpbnQ4KGErNCkpe2xldCByPWErNixvPTAsaT0wO2Zvcig7MjU1PT09KGk9ZS5nZXRVaW50OChyKyspKTspbys9MjU1O28rPWk7Y29uc3Qgcz1uKHQuZGF0YSxyLG8pO3JldHVybiBuZXcgVWludDhBcnJheShzKX1hKyt9cmV0dXJuIG51bGx9KGEpO2Nhc2UgZTpyZXR1cm4gZnVuY3Rpb24odCl7Y29uc3QgZT1uZXcgRGF0YVZpZXcodC5kYXRhKTtsZXQgYT0wO2Zvcig7YSs1PHQuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PWUuZ2V0VWludDgoYSswKSYmMD09PWUuZ2V0VWludDgoYSsxKSYmMD09PWUuZ2V0VWludDgoYSsyKSYmMT09PWUuZ2V0VWludDgoYSszKSYmNzg9PT1lLmdldFVpbnQ4KGErNCkmJjE9PT1lLmdldFVpbnQ4KGErNSkmJjEwMT09PWUuZ2V0VWludDgoYSs2KSl7bGV0IHI9YSs3LG89MCxpPTA7Zm9yKDsyNTU9PT0oaT1lLmdldFVpbnQ4KHIrKykpOylvKz0yNTU7bys9aTtjb25zdCBzPW4odC5kYXRhLHIsbyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KHMpfWErK31yZXR1cm4gbnVsbH0oYSk7ZGVmYXVsdDpyZXR1cm4gbnVsbH19ZnVuY3Rpb24gcih0KXtjb25zdCBlPXQubGVuZ3RoO2xldCBuPVtdLGE9MDtmb3IoO2E8ZTspYSsyPGUmJjA9PT10W2FdJiYwPT09dFthKzFdJiYoMD09PXRbYSsyXXx8MT09PXRbYSsyXXx8Mj09PXRbYSsyXXx8Mz09PXRbYSsyXSk/KG4ucHVzaCh0W2FdLHRbYSsxXSwzLHRbYSsyXSksYSs9Myk6KG4ucHVzaCh0W2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShuKX1mdW5jdGlvbiBvKG4sYSxvKXtzd2l0Y2gobyl7Y2FzZSB0OnJldHVybiBmdW5jdGlvbih0LGUpe2NvbnN0IG49cihlKSxhPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihhLzI1NSksaT1hJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK2ErdC5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNitmXT0yNTUsZisrO3JldHVybiBzWzYrZl09aSxmKysscy5zZXQobiw2K2YpLHMuc2V0KG5ldyBVaW50OEFycmF5KHQpLDYrZithKSxzLmJ1ZmZlcn0obixhKTtjYXNlIGU6cmV0dXJuIGZ1bmN0aW9uKHQsZSl7Y29uc3Qgbj1yKGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxpPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNytvKzErYSsxK3QuYnl0ZUxlbmd0aCk7c1swXT0wLHNbMV09MCxzWzJdPTAsc1szXT0xLHNbNF09Nzgsc1s1XT0xLHNbNl09MTAxO2xldCBmPTA7Zm9yKDtmPG87KXNbNytmXT0yNTUsZisrO3JldHVybiBzWzcrZl09aSxmKysscy5zZXQobiw3K2YpLGYrPWEsc1s3K2ZdPTEyOCxmKysscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNytmKSxzLmJ1ZmZlcn0obixhKTtkZWZhdWx0OnJldHVybiBudWxsfX1mdW5jdGlvbiBpKG4pe2lmKG4ubGVuZ3RoPDUpcmV0dXJuIiI7bGV0IGE9LTE7Zm9yKGxldCB0PTA7dDxuLmxlbmd0aC0zO3QrKyl7aWYoMD09PW5bdF0mJjA9PT1uW3QrMV0mJjE9PT1uW3QrMl0pe2E9dDticmVha31pZih0PG4ubGVuZ3RoLTQmJjA9PT1uW3RdJiYwPT09blt0KzFdJiYwPT09blt0KzJdJiYxPT09blt0KzNdKXthPXQ7YnJlYWt9fWlmKC0xPT09YSlyZXR1cm4iIjtjb25zdCByPWErKDA9PT1uW2ErMl0/NDozKTtpZihyPj1uLmxlbmd0aClyZXR1cm4iIjtjb25zdCBvPW5bcl07aWYoMTI4Jm8pcmV0dXJuIiI7aWYoKG8+PjEmNjMpPj0zMilyZXR1cm4gZTtpZihyKzE8bi5sZW5ndGgpe2lmKDA9PSgyNDgmbltyKzFdKSlyZXR1cm4gZX1yZXR1cm4oMzEmbyk8PTMxP3Q6IiJ9Y29uc3Qgcz03MSxmPTEsbD0yLHU9MSxnPTI7dmFyIGM7ZnVuY3Rpb24gZCh0LGU9ITEpe2NvbnN0IG49dC5nZXRVaW50OCgwKTtpZihuIT09cylyZXR1cm47Y29uc3QgYT10LmdldFVpbnQxNigxKSxyPWYrbCthLG89bmV3IFVpbnQ4QXJyYXkodC5ieXRlTGVuZ3RoLXIpO28uc2V0KG5ldyBVaW50OEFycmF5KHQuYnVmZmVyLHIsdC5ieXRlTGVuZ3RoLXIpKTtjb25zdCBpPXttOm4sdGx2TGVuOmEsdGx2OltdLGZyYW1lOm99O2xldCBkPWYrbDtmb3IoO2Q8cjspe2NvbnN0IG49dC5nZXRVaW50OChkKSxhPXQuZ2V0VWludDE2KGQrdSkscj11K2c7aWYobj09PWMuQVVESU9fTEVWRUwpe2xldCBvPXQuZ2V0VWludDgoZCtyKTtmb3IobGV0IGU9MTtlPGE7ZSsrKW89bzw8OHx0LmdldFVpbnQ4KGQrcitlKTtpLnRsdi5wdXNoKHt0YWc6bixsZW5ndGg6YSx2YWx1ZTplPzEyN15vPj4xOjEyNyZvfSl9ZWxzZSBpZihuPT09Yy5NRVRBREFUQXx8bj09PWMuQVVESU9fNjRfQklUX1BUUyl7Y29uc3QgZT1uZXcgVWludDhBcnJheShhKTtmb3IobGV0IG49MDtuPGE7bisrKWVbbl09dC5nZXRVaW50OChkK3Irbik7aS50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZX0pfWQrPXIrYX1yZXR1cm4gaX0hZnVuY3Rpb24odCl7dFt0LkFVRElPX0xFVkVMPTFdPSJBVURJT19MRVZFTCIsdFt0Lk1FVEFEQVRBPTJdPSJNRVRBREFUQSIsdFt0LkFVRElPXzY0X0JJVF9QVFM9M109IkFVRElPXzY0X0JJVF9QVFMifShjfHwoYz17fSkpLHNlbGYub25ydGN0cmFuc2Zvcm09dD0+e2NvbnN0IGU9dC50cmFuc2Zvcm1lcixuPVtdLHI9W107bGV0IGg9bnVsbDtlLm9wdGlvbnMucG9ydC5vbm1lc3NhZ2U9dD0+e3QuZGF0YS5zZWkmJm4ucHVzaCh0LmRhdGEuc2VpKSx0LmRhdGEubWV0YWRhdGEmJnIucHVzaCh0LmRhdGEubWV0YWRhdGEpfSxzZWxmLnBvc3RNZXNzYWdlKCJzdGFydGVkIik7Y29uc3QgcD1lLnJlYWRhYmxlLmdldFJlYWRlcigpLFU9ZS53cml0YWJsZS5nZXRXcml0ZXIoKTsic2VpLXJ4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KG4udmFsdWUuZGF0YSkpLHI9YShuLnZhbHVlLHQpO2lmKHImJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtzZWk6cn0pLCFoKXtjb25zdCB0PW4udmFsdWUuZ2V0TWV0YWRhdGEoKXx8e307aD17dHlwZTpuLnZhbHVlLnR5cGUscnRwVGltZXN0YW1wOm4udmFsdWUudGltZXN0YW1wLHBheWxvYWRUeXBlOnQucGF5bG9hZFR5cGV8fDAsc3NyYzp0LnN5bmNocm9uaXphdGlvblNvdXJjZXx8MCxsZW5ndGg6bi52YWx1ZS5kYXRhLmJ5dGVMZW5ndGgsLi4uIm1pbWVUeXBlImluIHQ/e21pbWVUeXBlOnQubWltZVR5cGV9Ont9fSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7Zmlyc3RGcmFtZUluZm86aH0pfX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToic2VpLXR4Ij09PWUub3B0aW9ucy5uYW1lP2Z1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigoYT0+e2lmKCFhLmRvbmUpe2lmKGEudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgdD1pKG5ldyBVaW50OEFycmF5KGEudmFsdWUuZGF0YSkpLGU9bi5zaGlmdCgpO2lmKGUpe2NvbnN0IG49byhhLnZhbHVlLmRhdGEsZSx0KTtuJiYoYS52YWx1ZS5kYXRhPW4pfX1VLndyaXRlKGEudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtcngiPT09ZS5vcHRpb25zLm5hbWU/ZnVuY3Rpb24gdChlKXtwLnJlYWQoKS50aGVuKChuPT57aWYoIW4uZG9uZSl7aWYobi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PW5ldyBEYXRhVmlldyhuLnZhbHVlLmRhdGEpLGE9dC5nZXRVaW50OCgwKTtsZXQgcjtpZigwIT0oMTI4JmEpJiY3MSE9PWEpe2NvbnN0IGU9ZnVuY3Rpb24odCl7aWYodC5ieXRlTGVuZ3RoPD0wKXJldHVybltdO2NvbnN0IGU9W107bGV0IG49MDtmb3IoO248dC5ieXRlTGVuZ3RoOyl7Y29uc3QgYT0oMTI4JnQuZ2V0VWludDgobikpPj43LHI9MTI3JnQuZ2V0VWludDgobik7aWYoIShhJiZuKzQ8PXQuYnl0ZUxlbmd0aCkpe24rKzticmVha317Y29uc3QgYT10LmdldFVpbnQzMihuLCExKSxvPSgxNjc3NjE5MiZhKT4+MTAsaT0xMDIzJmE7ZS5wdXNoKHtwdDpyLHRzX29mZnNldDpvLGxlbmd0aDppLGRhdGE6bmV3IFVpbnQ4QXJyYXl9KSxuKz00fX1sZXQgYT10LmJ5dGVMZW5ndGgtbjtmb3IoY29uc3QgciBvZiBlKXtpZihyLmxlbmd0aD5hKXJldHVybiBjb25zb2xlLndhcm4oIkJyb2tlbiByZWQgcGF5bG9hZCIpLFtdO3IubGVuZ3RoPjAmJihyLmRhdGE9bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sci5sZW5ndGgpLG4rPXIubGVuZ3RoLGEtPXIubGVuZ3RoKX1pZihhPjApe2NvbnN0IHI9e3B0OmUubGVuZ3RoPjA/ZVtlLmxlbmd0aC0xXS5wdDowLHRzX29mZnNldDowLGxlbmd0aDphLGRhdGE6bmV3IFVpbnQ4QXJyYXkodC5idWZmZXIsdC5ieXRlT2Zmc2V0K24sYSl9O2UucHVzaChyKX1yZXR1cm4gZX0odCk7aWYoZS5sZW5ndGg+MCl7Y29uc3QgdD1mdW5jdGlvbih0KXtsZXQgZT0wO2ZvcihsZXQgbj0wO248dC5sZW5ndGg7bisrKWUrPW48dC5sZW5ndGgtMT80OjEsZSs9dFtuXS5sZW5ndGg7Y29uc3Qgbj1uZXcgVWludDhBcnJheShlKTtsZXQgYT0wO2ZvcihsZXQgZT0wO2U8dC5sZW5ndGg7ZSsrKWlmKGU8dC5sZW5ndGgtMSl7Y29uc3Qgcj0oMjE0NzQ4MzY0OHwoMTI3JnRbZV0ucHQpPDwyNHwoMjYyMTQzJnRbZV0udHNfb2Zmc2V0KTw8MTB8MTAyMyZ0W2VdLmxlbmd0aCk+Pj4wO25bYSsrXT1yPj4yNCYyNTUsblthKytdPXI+PjE2JjI1NSxuW2ErK109cj4+OCYyNTUsblthKytdPTI1NSZyfWVsc2UgblthKytdPTEyNyZ0W2VdLnB0O2Zvcihjb25zdCBlIG9mIHQpbi5zZXQoZS5kYXRhLGEpLGErPWUubGVuZ3RoO3JldHVybiBufShlLm1hcCgodD0+e2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkodC5sZW5ndGgpO2Uuc2V0KHQuZGF0YSk7Y29uc3Qgbj1kKG5ldyBEYXRhVmlldyhlLmJ1ZmZlcikpO3JldHVybiBuPy5mcmFtZSYmKHQuZGF0YT1uPy5mcmFtZSkscj1uLHR9KSkpO24udmFsdWUuZGF0YT10LmJ1ZmZlcn19ZWxzZSByPWQodCksciYmKG4udmFsdWUuZGF0YT1yLmZyYW1lLmJ1ZmZlcik7aWYocil7bGV0IHQ9ci50bHYuZmluZCgodD0+dC50YWc9PT1jLk1FVEFEQVRBKSk7aWYodCYmdC52YWx1ZSBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkmJmUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHttZXRhZGF0YTp0LnZhbHVlfSksdD1yLnRsdi5maW5kKCh0PT50LnRhZz09PWMuQVVESU9fNjRfQklUX1BUUykpLHQmJnQudmFsdWUgaW5zdGFuY2VvZiBVaW50OEFycmF5JiY4PT10LnZhbHVlLmxlbmd0aCl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcodC52YWx1ZS5idWZmZXIpLmdldEJpZ1VpbnQ2NCgwLCEwKTt0JiZ0LnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3B0czpufSl9fX1VLndyaXRlKG4udmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfShlKToiYXVkaW8tbWV0YWRhdGEtdHgiPT09ZS5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIHQoZSl7cC5yZWFkKCkudGhlbigobj0+e2lmKCFuLmRvbmUpe2lmKGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHtnZXRNZXRhZGF0YTohMH0pLG4udmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkQXVkaW9GcmFtZSl7Y29uc3QgdD1yLnNoaWZ0KCk7dCYmKG4udmFsdWUuZGF0YT1mdW5jdGlvbih0LGUsbil7Y29uc3QgYT1uLmJ5dGVMZW5ndGgscj1hK3UrZyxvPWYrbCtyLGk9bmV3IEFycmF5QnVmZmVyKHQuYnl0ZUxlbmd0aCtvKSxjPW5ldyBEYXRhVmlldyhpKTtjLnNldFVpbnQ4KDAscyksYy5zZXRVaW50MTYoMSxyKSxjLnNldFVpbnQ4KDMsZSksYy5zZXRVaW50MTYoNCxhKTtmb3IobGV0IHQ9MDt0PGE7dCsrKWMuc2V0VWludDgoNit0LG5bdF0pO2NvbnN0IGQ9bmV3IFVpbnQ4QXJyYXkoYy5idWZmZXIpO3JldHVybiBkLnNldChuZXcgVWludDhBcnJheSh0KSxvKSxkLmJ1ZmZlcn0obi52YWx1ZS5kYXRhLGMuQVVESU9fNjRfQklUX1BUUyx0KSl9VS53cml0ZShuLnZhbHVlKSxlLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSx0KGUpfX0pKX0oZSl9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKTsK")],{type:"text/javascript"});return setTimeout(()=>Hf.revokeObjectURL(e),0),new Worker(Hf.createObjectURL(e))}const s1=71,dR=1,lR=2,uR=1,a1=2;var ya=function(e){return e[e.AUDIO_LEVEL=1]="AUDIO_LEVEL",e[e.METADATA=2]="METADATA",e[e.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",e}(ya||{});function hR(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=e.getUint8(0);if(n!==s1)return;const r=e.getUint16(1),i=dR+lR+r,o=new Uint8Array(e.byteLength-i);o.set(new Uint8Array(e.buffer,i,e.byteLength-i));const s={m:n,tlvLen:r,tlv:[],frame:o};let c=dR+lR;for(;c<i;){const l=e.getUint8(c),u=e.getUint16(c+uR),h=uR+a1;if(l===ya.AUDIO_LEVEL){let f=e.getUint8(c+h);for(let _=1;_<u;_++)f=f<<8|e.getUint8(c+h+_);s.tlv.push({tag:l,length:u,value:t?127^f>>1:127&f})}else if(l===ya.METADATA||l===ya.AUDIO_64_BIT_PTS){const f=new Uint8Array(u);for(let _=0;_<u;_++)f[_]=e.getUint8(c+h+_);s.tlv.push({tag:l,length:u,value:f})}c+=h+u}return s}const Y_=new Map,z_=127,Bc=1e-10,pR=139/13,q_=new Map;function fR(e,t,n){const r="".concat(e,"-").concat(t,"-").concat(n);let i=0;return q_.has(r)?i=q_.get(r):(i=Math.log(function(s,c){const l=s-c;c<l&&(c=l);let u=1;for(let h=s,f=1;h>c;h--,f++)u=u*h/f;return u}(t,e))+e*Math.log(.5)+(t-e)*Math.log(1-.5)-Math.log(n)+n*e,q_.set(r,i)),i<Bc&&(i=Bc),i}function c1(e,t,n){const r=t.length,i=e.length/r;let o=!1;for(let s=0,c=0;s<r;s++){let l=0;for(let u=c+i;c<u;c++)e[c]>n&&l++;t[s]!==l&&(t[s]=l,o=!0)}return o}window.cache=q_;let Aq=0;class d1{constructor(t){j(this,"id",void 0),j(this,"immediates",[]),j(this,"lastNonSilence",-1),j(this,"immediateSpeechActivityScore",Bc),j(this,"lastLevelChangedTime",Date.now()),j(this,"levels",[]),j(this,"longs",[]),j(this,"longSpeechActivityScore",Bc),j(this,"mediums",[]),j(this,"mediumSpeechActivityScore",Bc),j(this,"minLevel",0),j(this,"nextMinLevel",0),j(this,"nextMinLevelWindowLength",0),j(this,"energyScore",0),this.id=t||"".concat(Aq++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){const t=this.immediates,n=this.levels,r=this.minLevel+pR;let i=!1;for(let o=0;o<t.length;++o){let s=n[o];s<r&&(s=0);const c=Math.floor(s/pR);t[o]!==c&&(t[o]=c,i=!0)}return i}computeLongs(){return c1(this.mediums,this.longs,4)}computeMediums(){return c1(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=fR(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(t){this.longSpeechActivityScore=fR(this.longs[0],10,47),this.longSpeechActivityScore>Bc&&(this.lastNonSilence=t)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=fR(this.mediums[0],5,24)}evaluateSpeechActivityScores(t){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(t)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var t;return"[".concat(Nw(t=[...this.levels]).call(t).join(),"]")}getSpeechActivityScore(t){switch(t){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+t)}}levelChanged(t,n){if(this.lastLevelChangedTime<=n){this.lastLevelChangedTime=n;let r=t;return t<0&&(r=0),t>z_&&(r=z_),this.levels.unshift(r),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(r),r>=this.minLevel+pR?r:r/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(t){if(t!==0){if(this.minLevel===0||this.minLevel>t)return this.minLevel=t,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=t,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>t&&(this.nextMinLevel=t),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let n=Math.sqrt(this.minLevel*this.nextMinLevel);n<0?n=0:n>z_&&(n=z_),this.minLevel=n,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class bq{constructor(t){j(this,"algorithm",void 0),this.algorithm=t}execute(){let t=!this.algorithm;if(!t)try{const n=this.algorithm.runInDecisionMaker(this);n<=0?t=!0:setTimeout(this.execute.bind(this),n)}catch{t=!0}t&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class _R{constructor(t,n,r){j(this,"isDominant",void 0),j(this,"energyRanking",void 0),j(this,"energyScore",void 0),this.isDominant=t,this.energyRanking=n,this.energyScore=r}}class Oq extends Wt{constructor(t){super(),j(this,"dominantId",null),j(this,"lastDecisionTime",0),j(this,"lastLevelChangedTime",0),j(this,"lastLevelIdleTime",0),j(this,"relativeSpeechActivities",[]),j(this,"speakers",new Map),j(this,"enableSilence",!1),j(this,"timeoutToSilenceInterval",0),j(this,"decisionMaker",null),j(this,"loudest",[]),j(this,"numLoudestToTrack",3),j(this,"energyExpireTimeMs",250),j(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=t,this.enableSilence=t>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,n=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=t,n!=null&&(this.energyExpireTimeMs=n),r!=null&&(this.energyAlphaPct=r),this.loudest.length>t&&this.loudest.splice(t)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(t){return this.loudest.some(n=>n.id===t)}levelChanged(t,n){const r=Date.now(),i=this.getOrCreateSpeaker(t);this.lastLevelChangedTime<r&&(this.lastLevelChangedTime=r,this.maybeStartDecisionMaker());const o=i.levelChanged(n,r);return this.updateLoudestList(i,o,r)}runInDecisionMaker(t){return this.decisionMaker!==t||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(t){this.decisionMaker===t&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(t){t.forEach(n=>{this.speakers.has(n.id)||this.speakers.set(n.id,n)})}removeSpeakers(t){t.forEach(n=>{this.speakers.delete(n.id)})}getOrCreateSpeaker(t){let n=this.speakers.get(t);return n||(n=new d1(t),this.speakers.set(t,n),this.maybeStartDecisionMaker()),n}updateLoudestList(t,n,r){const i=t.id===this.dominantId;if(n<0){let l=0;for(;l<this.loudest.length&&this.loudest[l]!==t;)++l;return new _R(i,l,t.energyScore)}if(t.energyScore=Math.floor((this.energyAlphaPct*n+(100-this.energyAlphaPct)*t.energyScore+50)/100),this.numLoudestToTrack===0)return new _R(i,0,t.energyScore);const o=r-this.energyExpireTimeMs;let s=0;for(;s<this.loudest.length;){const l=this.loudest[s];if(l.getLastLevelChangedTime()<o&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(s,1);else if(l.id!==t.id)++s;else if(this.loudest.splice(s,1),this.loudest.length<this.numLoudestToTrack)break}let c=0;for(;c<this.loudest.length&&!(this.loudest[c].energyScore<t.energyScore);)++c;return c<this.numLoudestToTrack&&(this.loudest.splice(c,0,t),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new _R(i,c,t.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new bq(this),this.decisionMaker.execute())}makeDecision(t){let n=null,r=null;const i=this.speakers.size;let o=null;if(i===0)o=null;else if(i===1){var s;const c=$r(s=this.speakers).call(s).next().value;this.enableSilence&&c&&(o=c.id,c.evaluateSpeechActivityScores(t),t-c.lastNonSilence>this.timeoutToSilenceInterval&&(o=null))}else{let c=this.dominantId==null?null:this.speakers.get(this.dominantId);if(c==null){const h=this.speakers.entries().next();h.value&&(o=h.value[0],c=h.value[1])}else o=c.id;c!=null&&c.evaluateSpeechActivityScores(t);const l=this.relativeSpeechActivities;let u=2;for(const h of this.speakers.entries()){const[f,_]=h;if(_===c)continue;_.evaluateSpeechActivityScores(t);for(let R=0;R<l.length;++R){const A=c==null?Bc:c.getSpeechActivityScore(R);l[R]=Math.log(_.getSpeechActivityScore(R)/A)}const E=l[0],I=l[1],v=l[2];E>3&&I>2&&v>0&&I>u&&(u=I,o=f)}this.enableSilence&&c!=null&&o===c.id&&t-c.lastNonSilence>this.timeoutToSilenceInterval&&(o=null)}o==null&&!this.enableSilence||o===this.dominantId||(n=this.dominantId,this.dominantId=o,r=this.dominantId),r==null&&!this.enableSilence||r===n||this.emit("ActiveSpeakerChanged",r)}_runInDecisionMaker(){const t=Date.now(),n=300-(t-this.lastLevelIdleTime);let r=0;n<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(t),this.lastLevelIdleTime=t):r=n;let i=300-(t-this.lastDecisionTime);return i<=0&&(this.lastDecisionTime=t,this.makeDecision(t),i=300-(Date.now()-t)),i>0&&r>i&&(r=i),r}timeoutIdleLevels(t){const n=[];for(const i of $r(r=this.speakers).call(r)){var r;const o=t-i.getLastLevelChangedTime();36e5<o&&(this.dominantId==null||i.id!==this.dominantId)?n.push(i.id):300<o&&i.levelTimedOut()}n.forEach(i=>this.speakers.delete(i))}}const vl=new Map;let Uo=null,X_=null;const l1=3;let jc=[];const xo=new Map,J_=new Map;class Nq{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(t,n){j(this,"id",void 0),j(this,"track",void 0),j(this,"score",0),j(this,"active",!0),j(this,"muted",!1),j(this,"timer",0),j(this,"actives",0),j(this,"inactives",0),this.id=t,this.track=n,this.setActive(xo.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){const t=this.active;this.active=this.activeRate>=.8;const{actives:n,inactives:r}=function(){const i=[],o=[];return Array.from($r(xo).call(xo)).forEach(s=>{s.active?i.push(s):o.push(s)}),{actives:i,inactives:o}}();if(n.length>3){let i;n.forEach(o=>{(!i||i.score>o.score)&&(i=o)}),i&&i.setActive(!1)}if(n.length<3&&r.length>0){let i;r.forEach(o=>{(!i||i.score<o.score)&&o.id!==this.id&&(i=o)}),i&&t&&!this.active&&(i.samples>40&&i.activeRate-this.activeRate>.4?i.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(t){this.active=t,this.resetTimer(),this.setMuted(!t)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){const t=function(n){let r;return Array.from($r(xo).call(xo)).forEach(i=>{!i.active||i.id===n||i.samples<40||(!r||i.score<r.score)&&(r=i)}),r}(this.id);t&&this.activeRate-t.activeRate>.4&&(t.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){const t=function(n){let r;return Array.from($r(xo).call(xo)).forEach(i=>{i.active||i.id===n||i.samples<40||(!r||i.score>r.score)&&(r=i)}),r}(this.id);t&&t.activeRate-this.activeRate>.4&&(t.setActive(!0),this.setActive(!1))}addSample(t){t?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(t){this.track&&(this.track.enabled=!t,this.muted=t)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout(()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()},1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let Q_;function u1(e){const t=xo.get(e);t&&(xo.delete(e),t.clearTimer())}const Z_=new Map,Dq=new Map,mR="video/h264",ER="video/h265";function h1(e,t,n){let r=new Uint8Array(e,t,n),i=[],o=0;for(;i.length<n;)o+3<n&&r[o]===0&&r[o+1]===0&&r[o+2]===3&&(r[o+3]===0||r[o+3]===1||r[o+3]===2||r[o+3]===3)?(i.push(r[o],r[o+1],r[o+3]),o+=4):(i.push(r[o]),o++);return new Uint8Array(i)}function p1(e){const t=e.length;let n=[],r=0;for(;r<t;)r+2<t&&e[r]===0&&e[r+1]===0&&(e[r+2]===0||e[r+2]===1||e[r+2]===2||e[r+2]===3)?(n.push(e[r],e[r+1],3,e[r+2]),r+=3):(n.push(e[r]),r++);return new Uint8Array(n)}function f1(e){if(e.length<5)return"";let t=-1;for(let i=0;i<e.length-3;i++){if(e[i]===0&&e[i+1]===0&&e[i+2]===1){t=i;break}if(i<e.length-4&&e[i]===0&&e[i+1]===0&&e[i+2]===0&&e[i+3]===1){t=i;break}}if(t===-1)return"";const n=t+(e[t+2]===0?4:3);if(n>=e.length)return"";const r=e[n];return 128&r?"":(r>>1&63)>=32||n+1<e.length&&!(248&e[n+1])?ER:(31&r)<=31?mR:""}const $_=new Map,yh=new Map;(function(){const e=ot();wn.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),wn.getStreamFromExtension=e.name===at.CHROME&&Number(e.version)>34,wn.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let n=!1;try{t.addTransceiver("audio"),n=!0}catch{}return t.close(),n}(),wn.supportMinBitrate=e.name===at.CHROME||e.name===at.EDGE,wn.supportSetRtpSenderParameters=function(){const t=ot();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!us()||!(!Pn()&&!w_())||t.name===at.FIREFOX&&Number(t.version)>=64)}(),e.name===at.SAFARI&&(Number(e.version)>=14?wn.supportDualStream=!0:wn.supportDualStream=!1),wn.webAudioMediaStreamDest=function(){const t=ot();return!(t.name===at.SAFARI&&Number(t.version)<12)}(),wn.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",wn.supportWebGL=typeof WebGLRenderingContext<"u",wn.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,us()||(wn.webAudioWithAEC=!0),wn.supportShareAudio=function(){const t=ot();return(t.os===Cn.WIN_10||t.os===Cn.WIN_81||t.os===Cn.WIN_7||t.os===Cn.LINUX||t.os===Cn.MAC_OS||t.os===Cn.CHROMIUM_OS)&&t.name===at.CHROME&&Number(t.version)>=74}(),wn.supportDataChannel=!!(ko(76)||vv(68)||oP(14)),wn.supportPCSetConfiguration=function(){const t=window.RTCPeerConnection;return!kt()&&!!t&&t.prototype.setConfiguration instanceof Function}(),wn.supportWebRTCEncodedTransform=ko(87)||nP()||vv(117),wn.supportWebRTCInsertableStream=function(){const t=ot();return(t.name===at.CHROME||t.name===at.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),wn.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,wn.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,wn.supportSuppressLocalAudioPlayback=ZP(),wn.supportRestrictOwnAudio=$P(),b_(()=>{wn.supportDualStreamEncoding=function(){const t=ot();return!!w("DISABLE_WEBAUDIO")||t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&w("CHROME_DUAL_STREAM_USE_ENCODING"))}(),g.debug("browser ua: ",navigator.userAgent),g.info("browser info: ",e),g.info("browser compatibility: ",wn)})})();const Pq=["CHINA","GLOBAL"],_1=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Gc=[],Rl=[];function Wc(e,t){return!!t&&Gc.some(n=>n.uid===e&&n.channelName===t)}function gR(){return Rl.length>0}var Lq=RN.forEach,m1=tf("forEach")?[].forEach:function(e){return Lq(this,e,arguments.length>1?arguments[1]:void 0)};ft({target:"Array",proto:!0,forced:[].forEach!==m1},{forEach:m1});var kq=Ni("Array","forEach"),Mq=ua,Uq=ir,xq=re,Vq=kq,SR=Array.prototype,Fq={DOMTokenList:!0,NodeList:!0},Bq=function(e){var t=e.forEach;return e===SR||xq(SR,e)&&t===SR.forEach||Uq(Fq,Mq(e))?Vq:t},jq=S(Bq),Gq=os,E1=cf;ft({target:"Object",stat:!0,forced:C(function(){E1(1)})},{keys:function(e){return E1(Gq(e))}});var Wq=S(wr.Object.keys),Hq=S(Aw),Kq=S(Ow),Yq=ft,g1=Mu,zq=Rf,qq=yn,S1=Pg,Xq=la,Jq=Ir,Qq=QS,Zq=un,$q=pa,eX=hN("slice"),tX=Zq("species"),TR=Array,nX=Math.max;Yq({target:"Array",proto:!0,forced:!eX},{slice:function(e,t){var n,r,i,o=Jq(this),s=Xq(o),c=S1(e,s),l=S1(t===void 0?s:t,s);if(g1(o)&&(n=o.constructor,(zq(n)&&(n===TR||g1(n.prototype))||qq(n)&&(n=n[tX])===null)&&(n=void 0),n===TR||n===void 0))return $q(o,c,l);for(r=new(n===void 0?TR:n)(nX(l-c,0)),i=0;c<l;c++,i++)c in o&&Qq(r,i,o[c]);return r.length=i,r}});var rX=Ni("Array","slice"),iX=re,oX=rX,vR=Array.prototype,sX=function(e){var t=e.slice;return e===vR||iX(vR,e)&&t===vR.slice?oX:t},aX=S(sX);function ae(e,t,n,r,i){var o,s,c,l={};return jq(o=Wq(r)).call(o,function(u){l[u]=r[u]}),l.enumerable=!!l.enumerable,l.configurable=!!l.configurable,("value"in l||l.initializer)&&(l.writable=!0),l=Hq(s=Kq(c=aX(n).call(n)).call(c)).call(s,function(u,h){return h(e,t,u)||u},l),i&&l.initializer!==void 0&&(l.value=l.initializer?l.initializer.call(i):void 0,l.initializer=void 0),l.initializer===void 0?(cN(e,t,l),null):l}let em=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),RR=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),xi=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e[e.REQ_DOWNGRADE_FALLBACK=27]="REQ_DOWNGRADE_FALLBACK",e}({}),Tr=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),Re=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.K_VOS_FALLBACK=30]="K_VOS_FALLBACK",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),$e=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),Ee=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.PRE_CONNECT_PC="pre_connect_pc",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e.RECOVER_NOTIFICATION="recover_notification",e.VOS_FALLBACK="vos_fallback",e.VOS_FALLBACK_PROMISE="vos_fallback_promise",e}({}),ge=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SET_DUAL_STREAM_MODE="set_dual_stream_mode",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.CONFIGURE="configure",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e.DOWNGRADE_CODEC="downgrade_codec",e}({}),Hc=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),Pe=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e.ENABLE_MULTI_STREAM="enable_multi_stream",e}({}),vr=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),Fe=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e.ON_FALLBACK="websocket:on_fallback",e}({});function tm(e){if(typeof e!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw g.error("Invalid Channel Name ".concat(e)),new B(b.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function nm(e){if(t=e,!(typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295||fP(e,1,255)))throw new B(b.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;typeof e=="string"&&g.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Gs=function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e}({});const cX={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},yR={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function CR(e,t){jn(e.url,"".concat(t,".url"),1,1e3,!1),zt(e.x)||Ct(e.x,"".concat(t,".x"),0,1e4),zt(e.y)||Ct(e.y,"".concat(t,".y"),0,1e4),zt(e.width)||Ct(e.width,"".concat(t,".width"),0,1e4),zt(e.height)||Ct(e.height,"".concat(t,".height"),0,1e4),zt(e.zOrder)||Ct(e.zOrder,"".concat(t,".zOrder"),0,255),zt(e.alpha)||Ct(e.alpha,"".concat(t,".alpha"),0,1,!1)}const dX={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""};let Ca=function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e}({}),IR=function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e}({}),En=function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e}({});function T1(e){if(!e.channelName)throw new B(b.INVALID_PARAMS,"invalid channelName in info");if(typeof e.uid!="number")throw new B(b.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&jn(e.token,"info.token",1,2047),nm(e.uid),tm(e.channelName),!0}let Dr=function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e}({}),Ws=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),Gr=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),yl=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),Et=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),nn=function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.PRE_CONNECT_PC="pre-connect_pc",e.UPDATE_GATEWAY_CONFIG="update-gateway-config",e.VOS_FALLBACK="vos-fallback",e.VOS_FALLBACK_PROMISE="vos-fallback-promise",e.RESET_SIGNAL="reset-signal",e.DATACHANNEL_FAILBACK="datachannel-failback",e}({}),rm=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({}),An=function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e}({}),dt=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});const v1=[dt.AFRICA,dt.ASIA,dt.CHINA,dt.EUROPE,dt.GLOBAL,dt.INDIA,dt.JAPAN,dt.NORTH_AMERICA,dt.OCEANIA,dt.OVERSEA,dt.SOUTH_AMERICA];let er=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});const im={CHINA:{},ASIA:{CODE:er.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:er.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:er.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:er.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:er.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:er.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:er.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:er.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:er.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:er.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:er.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:er.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:er.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};jv&&(im.CHINA={CODE:er.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Vo=function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",e.UPDATE_REMOTE_VIDEO_STREAM_TYPE="update_remote_video_stream_type",e.FALLBACK_TO_HLS="fallback_to_hls",e.UPDATE_VOS_CONFIGURE="update_vos_configure",e}({});function R1(e){return!!e&&!(!e.uplink||!e.id)&&e.uplink.max_bitrate!==void 0&&e.uplink.min_bitrate!==void 0}class y1 extends Wt{constructor(t,n){super(),y(this,"onICEConnectionStateChange",void 0),y(this,"onConnectionStateChange",void 0),y(this,"onDTLSTransportStateChange",void 0),y(this,"onDTLSTransportError",void 0),y(this,"onICETransportStateChange",void 0),y(this,"onFirstAudioReceived",void 0),y(this,"onFirstVideoReceived",void 0),y(this,"onFirstAudioDecoded",void 0),y(this,"onFirstVideoDecoded",void 0),y(this,"onFirstVideoRender",void 0),y(this,"onFirstVideoBufferReady",void 0),y(this,"onFirstVideoDecodedTimeout",void 0),y(this,"onSelectedLocalCandidateChanged",void 0),y(this,"onSelectedRemoteCandidateChanged",void 0),y(this,"onICECandidateError",void 0),y(this,"getLocalVideoStats",void 0)}}class om extends y1{constructor(t,n){super(t,n),y(this,"establishPromise",void 0)}}let ue=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),kn=function(e){return e.UDP_RELAY="udp_relay",e.UDP_TCP_RELAY="udp_tcp_relay",e.TCP_RELAY="tcp_relay",e.RELAY="relay",e}({}),Hs=function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.TCP_RESTART=3]="TCP_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e}({});const C1=["disconnected","failed"];let $=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),ut=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),Se=function(e){return e.AudioMetadata="audioMetadata",e.AudioPts="audioPts",e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e.FirstVideoPreRender="FirstVideoPreRender",e.FirstVideoBufferReady="FirstVideoBufferReady",e}({}),lo=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),uo=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),Mn=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),Ia=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),gn=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e.PRE_CONNECT_PC="transmitter:pre_connect_pc",e}({}),_s=function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e}({}),Vi=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),Fo=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),Cl=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),rn=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),Il=function(e){return e.ABORT="abort",e}({}),wa=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),lX=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({});const uX={[em.ACCESS_POINT]:{[Tr.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Tr.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Tr.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Tr.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Tr.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Tr.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Tr.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[em.UNILBS]:{[xi.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[xi.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[xi.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[xi.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[xi.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[xi.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[xi.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[xi.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[xi.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[xi.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[xi.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[xi.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1},[xi.REQ_DOWNGRADE_FALLBACK]:{desc:"request downgrade fallback",retry:!1}},[em.STRING_UID_ALLOCATOR]:{[RR.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[RR.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[RR.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function wl(e){const t=uX[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};const n=t[e%1e4];if(!n){if(Math.floor(e/1e4)===em.ACCESS_POINT){const r=e%1e4;if(r.toString()[0]==="1")return{desc:e.toString(),retry:!1};if(r.toString()[0]==="2")return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}const hX={[Re.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Re.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Re.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Re.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Re.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Re.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Re.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Re.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Re.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Re.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Re.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Re.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[Re.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Re.K_VOS_FALLBACK]:{desc:"K_VOS_FALLBACK",action:"tryNext"},[Re.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Re.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Re.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Re.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Re.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Re.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Re.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Re.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Re.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Re.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Re.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Re.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Re.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Re.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Re.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Re.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Re.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Re.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Re.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Re.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Re.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Re.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Re.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Re.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Re.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Re.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Re.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Re.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Re.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Re.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Re.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Re.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Re.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Re.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Re.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Re.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Re.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Re.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Re.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Re.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Re.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Re.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Re.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Re.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Re.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Re.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Re.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Re.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Re.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Re.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Re.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Kc(e){return hX[e]||{desc:"UNKNOWN_ERROR_".concat(e),action:"failed"}}function I1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function wR(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?I1(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):I1(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}function AR(e,t){if(typeof e=="string")return e;const{proxy:n,host:r,port:i}=e;if(t){const o=w("JOIN_GATEWAY_FALLBACK_PORT")||443;return o===443?"wss://".concat(r,"/ws/?p=").concat(Number(i)+150):"wss://".concat(r,":").concat(o,"/ws/?p=").concat(Number(i)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(r,"&p=").concat(i):"wss://".concat(r,":").concat(i)}const pX=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,fX=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,_X=/wss:\/\/(.+):([0-9]+)\/?/,mX=/wss:\/\/(.[^\/]+)\/?/;let EX=0;class gX{constructor(t,n){y(this,"id",0),y(this,"store",void 0),y(this,"recordIndex",void 0),y(this,"websockets",[]),y(this,"try443PortDuration",2e3),y(this,"forceCloseWSDuration",5e3),y(this,"try443PortTimeout",null),y(this,"forceCloseTimeout",null),y(this,"isTry443PortFailed",!1),y(this,"isNormalPortFailed",!1),y(this,"useDoubleDomain",!1),y(this,"useProxy",!1),y(this,"startTime",Date.now()),this.id=++EX,this.try443PortDuration=w("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach(t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var t;const n=Date.now()-this.startTime;for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];g.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...i)}createWebSocket(t,n,r){this.logger("createWebSocket:",t,{isTry443Port:n,hasTimeoutDetection:r});const i=w("GATEWAY_DOMAINS"),o=Date.now(),s=[],c=i.find(_=>{var E;return Z(E=t.host).call(E,_)});c||(this.useDoubleDomain=!1);const l=[];if(this.useDoubleDomain)i.forEach(_=>{l.push(AR(wR(wR({},t),{},{host:t.host.replace(c,_)}),n))});else{const _=wR({},t);if(n&&c){const E=i.find(I=>I!==c);E&&(_.host=_.host.replace(c,E))}l.push(AR(_,n))}try{l.forEach(_=>{const E=new WebSocket(_);E.binaryType="arraybuffer",s.push(E),this.logger("ws is connecting:",E.url)})}catch(_){if(this.logger("ws create failed"),s.forEach(E=>E.close()),s.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,n,r);if(!n&&Number(t.port)!==443)return this.createWebSocket(t,!0,r);throw new B(b.WS_ERR,"init websocket failed! Error: ".concat(_.toString()))}const u=uh();this.store&&this.store.recordJoinChannelService({urls:s.map(_=>_.url),service:"gateway"},this.recordIndex),s.forEach(_=>{_.onopen=()=>{this.logger("onopen: ws ".concat(_.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(E=>{E!==_&&(E.onopen=null,E.onclose=null,E.onmessage=null,E.close(),this.logger("close backup websocket: ".concat(E.url)))}),this.websockets.length=0,u.resolve(_)},_.onclose=E=>{this.logger("onclose: ws ".concat(_.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(_.readyState));const I=s.every(v=>v.readyState===WebSocket.CLOSED||v.readyState===WebSocket.CLOSING);this.logger("".concat(n?"443":"47xx"," websocket closed, all failed: ").concat(I)),I&&(n||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(E.reason)),u.reject({code:E.code,reason:rm.A_ROUND_WS_FAILED})):!n&&I&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),f()),n?this.isTry443PortFailed=I:this.isNormalPortFailed=I},_.onmessage=E=>this.logger("".concat(_.url," onmessage: ").concat(E.data))}),this.websockets.push(...s);const h=()=>{this.websockets.forEach(_=>_.readyState!==WebSocket.OPEN&&_.close())},f=()=>{if(u.isResolved)return h();ot().os===Cn.MAC_OS&&kt()&&h(),this.createWebSocket(t,!0,!0).then(_=>{u.resolve(_)}).catch(_=>{this.isNormalPortFailed&&u.reject(_),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",u.isResolved),this.forceCloseTimeout=null,h()},this.forceCloseWSDuration)};return r||(()=>{if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(()=>{this.forceCloseTimeout=null,h()},this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{this.logger("2s timeout, isWebsocket created: ",u.isResolved),this.try443PortTimeout=null,f()},this.try443PortDuration)})(),u.promise}chooseBestWebsocket(t,n,r,i){return this.useDoubleDomain=!!n,typeof t=="string"&&(t=function(o){let s,c,l;return[,s,c,l]=o.match(pX)||[],s||([,c,l]=o.match(fX)||[]),c&&l||([,c,l]=o.match(_X)||[]),c&&l||([,c]=o.match(mX)||[]),c||g.warning("un-destructible url: ",o),{proxy:s,host:c,port:l||"443"}}(t)),this.recordIndex=i,this.useProxy=!!t.proxy,r&&this.useProxy&&(g.warn("cannot use 443 only when use proxy"),r=!1),this.createWebSocket(t,!!r,!1).finally(()=>this.clearTimeout())}}function w1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}class A1 extends Wt{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var n;Z(n=["tryNext","recover"]).call(n,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(Fe.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Fe.CONNECTED):this._state==="closed"?this.emit(Fe.CLOSED):this._state==="failed"&&this.emit(Fe.FAILED))}resetReconnectCount(t){g.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,n){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2],i=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4&&arguments[4]!==void 0&&arguments[4],s=arguments.length>5?arguments[5]:void 0;super(),y(this,"_websocketUrl",null),y(this,"connectionID",0),y(this,"currentURLIndex",0),y(this,"urls",[]),y(this,"_reconnectMode","tryNext"),y(this,"reconnectReason",void 0),y(this,"_initMutex",void 0),y(this,"name",void 0),y(this,"_state","closed"),y(this,"reconnectInterrupter",void 0),y(this,"websocket",void 0),y(this,"retryConfig",void 0),y(this,"reconnectCount",0),y(this,"forceCloseTimeout",5e3),y(this,"onlineReconnectListener",void 0),y(this,"useCompress",void 0),y(this,"tryDoubleDomain",!1),y(this,"use443PortOnly",!1),y(this,"wsInflateLength",0),y(this,"wsDeflateLength",0),y(this,"closeEstablishingWs",()=>{}),y(this,"store",void 0),y(this,"joinGatewayRecordIndex",void 0),this.store=s,this.name=t,this.retryConfig=function(f){for(var _=1;_<arguments.length;_++){var E=arguments[_]!=null?arguments[_]:{};_%2?w1(Object(E),!0).forEach(function(I){y(f,I,E[I])}):Object.getOwnPropertyDescriptors?Object.defineProperties(f,Object.getOwnPropertyDescriptors(E)):w1(Object(E)).forEach(function(I){Object.defineProperty(f,I,Object.getOwnPropertyDescriptor(E,I))})}return f}({},n),this.useCompress=r,this.tryDoubleDomain=i,this.use443PortOnly=o,this._initMutex=new Ln("websocket",s?s.clientId:void 0);const{timeout:c,timeoutFactor:l}=n,u=Math.max(300,Math.floor(3*c/5)),h=Math.max(1.2,Math.floor(8*l)/10);Er.ONLINE&&(this.retryConfig.timeout=u,this.retryConfig.timeoutFactor=h),qt.on(Oc.NETWORK_STATE_CHANGE,(f,_)=>{f!==_&&(this.resetReconnectCount("network state change: ".concat(_," -> ").concat(f)),f===Er.ONLINE?(this.retryConfig.timeout=u,this.retryConfig.timeoutFactor=h):(this.retryConfig.timeout=c,this.retryConfig.timeoutFactor=l))})}getConnection(){return this.websocket||void 0}async init(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const r=await this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=n,this.urls=t,this.state="connecting";try{var i;const o=uh(),s=this.urls[this.currentURLIndex];(i=this.store)===null||i===void 0||i.beforeConnect(),function(c){return!(x_()||w("USE_NEW_TOKEN")||!w("ENABLE_PREALLOC_PC")&&(c==null||!c.autoSubscribe||w("FORCE_DISABLE_AUTO_SUB")))}(this.store)&&this.emit(gn.PRE_CONNECT_PC),this.createWebSocketConnection(s).then(o.resolve).catch(o.reject),this.once(Fe.CLOSED,()=>{o.reject(new W(b.WS_DISCONNECT))}),this.once(Fe.CONNECTED,o.resolve),await o.promise}catch{}finally{r()}}close(t,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const r=this.websocket;n?setTimeout(()=>r.close(),500):r.close(),this.websocket=void 0,this._websocketUrl=null}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,n){if(!this.websocket)return void g.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),g.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);const r=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),r&&r.bind(this.websocket)({code:9999,reason:n})}sendMessage(t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new W(b.WS_ABORT,"websocket is not ready");try{n||(t=JSON.stringify(t)),this.websocket.send(t)}catch(r){throw new W(b.WS_ERR,"send websocket message error"+r.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var n;const r=uh();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const i=h=>{var f;(f=this.store)===null||f===void 0||f.signalChannelOpen(),g.debug("[".concat(this.name,"] websocket opened:"),h),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),r.resolve()},o=async h=>{var f;if(g.debug("[".concat(this.name,"] websocket close ").concat((f=this.websocket)===null||f===void 0?void 0:f.url,", code: ").concat(h.code,", reason: ").concat(h.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)r.reject(new W(b.WS_DISCONNECT,"websocket close: ".concat(h.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=h.reason,this.state="reconnecting");const _=ni(this,Fe.WILL_RECONNECT,this.reconnectMode,h.reason)||this.reconnectMode,E=await this.reconnectWithAction(_);if(this.state==="closed")return void g.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!E)return r.reject(new W(b.WS_DISCONNECT,"websocket reconnect failed: ".concat(h.code))),this.close(!0);r.resolve()}},s=h=>{this.emit(Fe.ON_MESSAGE,h)},c=h=>{g.warn("[".concat(this.connectionID,"] ws open error ").concat(h))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),w("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=w("GATEWAY_WSS_ADDRESS")),g.debug("[".concat(this.name,"] start connect, url:"),t);const l=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var u;this._websocketUrl=AR(t);const h=await this.chooseBestWebsocketConnection(t);this.websocket=h,i&&i(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=s,this.websocket.onerror=c,(u=this.store)===null||u===void 0||u.recordJoinChannelService({endTs:Date.now(),status:"success"},l),this.joinGatewayRecordIndex=l}catch(h){const f=this.state==="closed",_=h instanceof W,E=_&&h.code===b.WS_ABORT,I=_&&h.code===b.WS_ERR,v=_?h.message:h&&(h.reason||h.toString());g.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(v)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:E?"aborted":"error",errors:[h]},l),f||I?(r.reject(f?new W(b.WS_DISCONNECT,"websocket is closed: ".concat(v)):new W(b.WS_ERR,"init websocket failed: ".concat(v))),I&&g.error("[".concat(this.name,"] init websocket failed: ").concat(v))):o&&o(h)}return r.promise}async reconnectWithAction(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;g.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||qt.isOnline||!qt.onlineWaiter||(this.onlineReconnectListener=qt.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let r=!0;if(this.reconnectInterrupter=()=>r=!1,n){const s=O_(this.reconnectCount,this.retryConfig);g.debug("[".concat(this.name,"] wait ").concat(s,"ms to reconnect websocket, mode: ").concat(t)),await se.race([In(s),this.onlineReconnectListener||new se(()=>{})])}if(this._state==="closed"||!r)return!1;this.reconnectCount+=1;const i=async(s,c)=>{this.emit(Fe.RECONNECT_CREATE_CONNECTION,c),await this.createWebSocketConnection(s)};try{if(t==="retry")await i(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);g.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),await i(this.urls[this.currentURLIndex],t)}else t==="recover"&&(g.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=await hn(this,Fe.REQUEST_NEW_URLS),this.currentURLIndex=0,await i(this.urls[this.currentURLIndex],t))}catch(s){var o;g.error("[".concat(this.name,"] reconnect failed ").concat(s&&s.toString()));const c=s==null||(o=s.data)===null||o===void 0?void 0:o.desc;if(Array.isArray(c)){if(Z(c).call(c,"dynamic key expired"))return this.emit(Fe.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1;if(Z(c).call(c,"request downgrade fallback"))return this.emit(Fe.ON_FALLBACK),!1}return this.reconnectWithAction(t,n)}return!0}}class bR extends A1{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,n){const r=uh(),i=function(s,c){return new gX(s,c)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{g.debug("[choose-best-ws] close establishing websockets"),i.closeAllWebsockets(),r.reject(new W(b.WS_ABORT,"choose best websocket aborted"))};const o=w("GATEWAY_DOMAINS");return g.debug("[choose-best-ws] currentDomain: ",t,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),i.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,n).then(r.resolve).catch(r.reject),r.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class Ch extends A1{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,n){return new se((r,i)=>{let o=!1;const s=[];this.closeEstablishingWs=()=>{g.debug("[choose-best-ws] close establishing websockets"),s.forEach(I=>{I.onclose=null,I.onopen=null,I.onmessage=null,I.close()}),i(new W(b.WS_ABORT,"choose best websocket aborted"))};const c=w("GATEWAY_DOMAINS");let l;const u=t.indexOf("?h="),h=c.find(I=>u!==-1?Z(t).call(t,I,u):Z(t).call(t,I));g.debug("[choose-best-ws] currentDomain: ",h,", domains: ",c);let f=!this.tryDoubleDomain||!h;if(!f&&h){var _;const I=Date.now();try{c.forEach(v=>{const R=u===-1?t.replace(h,v):t.substr(0,u)+t.substr(u).replace(h,v),A=new WebSocket(R);A.binaryType="arraybuffer",s.push(A),g.debug("[choose-best-ws] ws is connecting:",A.url)})}catch{for(g.debug("[choose-best-ws] ws create failed, fallback to single url"),s.forEach(R=>R.close());s.length;)s.pop();f=!0}(_=this.store)===null||_===void 0||_.recordJoinChannelService({urls:s.map(v=>v.url),service:"gateway"},n),s.forEach(v=>{v.onopen=()=>{if(o)return;const R=Date.now()-I;g.debug("[choose-best-ws] ws open cost ".concat(R,"ms")),s.filter(A=>A!==v).forEach(A=>{g.debug("[choose-best-ws]close backup websocket: ".concat(A.url)),A.close()}),o=!0,r(v)},v.onclose=R=>{l=R,!o&&(s.find(A=>!(A.readyState===WebSocket.CLOSED||A.readyState===WebSocket.CLOSING))||(g.debug("[choose-best-ws] all websocket is closed"),o=!0,i(l)))},v.onmessage=R=>{g.debug("[choose-best-ws]".concat(v.url," onmessage: ").concat(R.data))}}),In(this.forceCloseTimeout).then(()=>{s.forEach(v=>{v.readyState!==WebSocket.OPEN&&v.close()})})}if(f){var E;let I;g.debug("[choose-best-ws] use single url: ",t),(E=this.store)===null||E===void 0||E.recordJoinChannelService({urls:[t],service:"gateway"},n);try{I=new WebSocket(t),s.push(I),I.binaryType="arraybuffer"}catch(v){const R=new W(b.WS_ERR,"init websocket failed! Error: ".concat(v.toString()));return g.error("[".concat(this.name,"]").concat(R)),void i(R)}I.onopen=()=>{r(I)},I.onclose=v=>{i(v)},I.onmessage=v=>{g.debug("[choose-best-ws]".concat(I.url," onmessage: ").concat(v.data))},In(this.forceCloseTimeout).then(()=>{I&&I.readyState!==WebSocket.OPEN&&I.close()})}}).then(r=>(this.closeEstablishingWs=void 0,r)).catch(r=>{throw this.closeEstablishingWs=void 0,r})}}class b1 extends Wt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===$e.CONNECTED?this.emit(Ee.WS_CONNECTED):t===$e.RECONNECTING?this.emit(Ee.WS_RECONNECTING,this._websocketReconnectReason):t===$e.CLOSED&&this.emit(Ee.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,n){super(),y(this,"__name__","AgoraRTCSignal"),y(this,"_disconnectedReason",void 0),y(this,"_websocketReconnectReason",void 0),y(this,"_connectionState",$e.CLOSED),y(this,"reconnectToken",void 0),y(this,"websocket",void 0),y(this,"openConnectionTime",void 0),y(this,"clientId",void 0),y(this,"lastMsgTime",Date.now()),y(this,"uploadCache",[]),y(this,"uploadCacheInterval",void 0),y(this,"rttRolling",new kv(5)),y(this,"pingpongTimer",void 0),y(this,"wsInflateDataTimer",void 0),y(this,"pingpongTimeoutCount",0),y(this,"ortc",void 0),y(this,"joinResponse",void 0),y(this,"multiIpOption",void 0),y(this,"initError",void 0),y(this,"spec",void 0),y(this,"store",void 0),y(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(Ee.ON_BINARY_DATA,r.data);const i=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const o="res-@".concat(i._id);this.emit(o,i._result,i._message)}else if(Object.prototype.hasOwnProperty.call(i,"_type")){if(this.emit(i._type,i._message),i._type===Pe.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===Pe.ON_USER_BANNED)switch(i._message.error_code){case 14:this.close(Ze.UID_BANNED);break;case 15:this.close(Ze.IP_BANNED);break;case 16:this.close(Ze.CHANNEL_BANNED)}if(i._type===Pe.ON_USER_LICENSE_BANNED)switch(i._message.error_code){case Re.ERR_LICENSE_MISSING:this.close(Ze.LICENSE_MISSING);break;case Re.ERR_LICENSE_EXPIRED:this.close(Ze.LICENSE_EXPIRED);break;case Re.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ze.LICENSE_MINUTES_EXCEEDED);break;case Re.ERR_LICENSE_PERIOD_INVALID:this.close(Ze.LICENSE_PERIOD_INVALID);break;case Re.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ze.LICENSE_MULTIPLE_SDK_SERVICE);break;case Re.ERR_LICENSE_ILLEGAL:this.close(Ze.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new bR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,w("JOIN_GATEWAY_USE_DUAL_DOMAIN"),w("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===$e.CONNECTED&&this.reconnect("retry",zn.OFFLINE)})}async request(t,n,r,i){const o=_t(6,""),s={_id:o,_type:t,_message:n},c=this.websocket.connectionID,l=()=>new se((I,v)=>{if(this.connectionState===$e.CONNECTED)return I();const R=()=>{this.off(Ee.WS_CLOSED,A),I()},A=()=>{this.off(Ee.WS_CONNECTED,R),v(new B(b.WS_ABORT))};this.once(Ee.WS_CONNECTED,R),this.once(Ee.WS_CLOSED,A),t!==ge.PUBLISH&&t!==ge.PUBLISH_DATASTREAM&&t!==ge.SUBSCRIBE&&t!==ge.SUBSCRIBE_DATASTREAM&&t!==ge.UNSUBSCRIBE&&t!==ge.UNSUBSCRIBE_DATASTREAM&&t!==ge.UNPUBLISH&&t!==ge.UNPUBLISH_DATASTREAM&&t!==ge.CONTROL&&t!==ge.RESTART_ICE||this.once(Ee.DISCONNECT_P2P,()=>{v(new B(b.DISCONNECT_P2P))}),t!==ge.PUBLISH&&t!==ge.RESTART_ICE||this.once(Ee.ABORT_P2P_EXECUTION,()=>{v(new B(b.DISCONNECT_P2P))})});if(this.connectionState!==$e.CONNECTING&&this.connectionState!==$e.RECONNECTING||t===ge.JOIN||t===ge.REJOIN||await l(),this.websocket.sendMessage(s,!0),i)return;const u=new se((I,v)=>{let R=!1;const A=(P,M)=>{R=!0,I({isSuccess:P==="success",message:M||{}}),this.off(Ee.WS_CLOSED,O),this.off(Ee.WS_RECONNECTING,O),this.emit(Ee.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(o),A);const O=()=>{v(new B(b.WS_ABORT,"type: ".concat(t))),this.off(Ee.WS_CLOSED,O),this.off(Ee.WS_RECONNECTING,O),this.off("res-@".concat(o),A)};this.once(Ee.WS_CLOSED,O),this.once(Ee.WS_RECONNECTING,O),In(w("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==c||R||(g.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(Ee.REQUEST_TIMEOUT,t,n))})});let h=null;try{h=await u}catch(I){if(this.connectionState===$e.CLOSED||t===ge.LEAVE)throw new B(b.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?I.throw():t===ge.JOIN||t===ge.REJOIN?null:(await l(),await this.request(t,n))}if(h.isSuccess)return h.message;const f=Number(h.message.error_code||h.message.code),_=Kc(f),E=new B(b.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(h.message.error_str),{code:f,data:h.message,desc:_.desc});return _.action==="success"?h.message:(g.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(f,", message: ").concat(_.desc,", action: ").concat(_.action)),f===Re.ERR_TOO_MANY_BROADCASTERS?((t===ge.JOIN||t===ge.REJOIN)&&(this.initError=E,this.close()),E.throw()):_.action==="failed"?E.throw():_.action==="quit"?(this.initError=E,this.close(),E.throw()):(f===Re.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,g.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",zn.MULTI_IP)):this.reconnect(_.action,zn.SERVER_ERROR),t===ge.JOIN||t===ge.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new se(r=>{const i=o=>{(!n||n(o))&&(this.off(t,i),r(o))};this.on(t,i)})}uploadWRTCStats(t){if(!this.store.sessionId)return void g.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Hc.WRTC_STATS,n)}upload(t,n){const r={_type:t,_message:n};try{this.websocket.sendMessage(r)}catch{const o=w("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==$e.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},w("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,n){const r={_type:t,_message:n};this.websocket.sendMessage(r)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new se((n,r)=>{this.once(Ee.WS_CONNECTED,()=>n(this.joinResponse)),this.once(Ee.WS_CLOSED,i=>r(this.initError||new B(b.WS_ABORT,i))),this.connectionState=$e.CONNECTING,this.websocket.init(t).catch(r),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||Ze.LEAVE,this.connectionState=$e.CLOSED,g.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}async join(){if(!this.joinResponse){this.emit(Ee.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await hn(this,Ee.REQUEST_JOIN_INFO);this.store.joinReq();const n=await this.request(ge.JOIN,t);if(this.ortc=t==null?void 0:t.ortc,this.store.joinRep(),!n)return this.emit(Ee.REPORT_JOIN_GATEWAY,rm.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(Ee.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=$e.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new B(b.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=Nc(this,Ee.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const n=await this.request(ge.REJOIN,t);return!!n&&(this.connectionState=$e.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(r=>{this.emit(Pe.ON_USER_ONLINE,{uid:r.uid}),r.audio&&this.emit(Pe.ON_ADD_AUDIO_STREAM,{uid:r.uid,uint_id:r.uint_id,audio:!0,ssrcId:r.audio_ssrc}),r.video&&this.emit(Pe.ON_ADD_VIDEO_STREAM,{uid:r.uid,uint_id:r.uint_id,video:!0,ssrcId:r.video_ssrc}),r.audio_mute?this.emit(Pe.MUTE_AUDIO,{uid:r.uid}):this.emit(Pe.UNMUTE_AUDIO,{uid:r.uid}),r.video_mute?this.emit(Pe.MUTE_VIDEO,{uid:r.uid}):this.emit(Pe.UNMUTE_VIDEO,{uid:r.uid}),r.audio_enable_local?this.emit(Pe.ENABLE_LOCAL_AUDIO,{uid:r.uid}):this.emit(Pe.DISABLE_LOCAL_AUDIO,{uid:r.uid}),r.video_enable_local?this.emit(Pe.ENABLE_LOCAL_VIDEO,{uid:r.uid}):this.emit(Pe.DISABLE_LOCAL_VIDEO,{uid:r.uid}),r.audio||r.video||this.emit(Pe.ON_REMOVE_STREAM,{uid:r.uid,uint_id:r.uint_id})}),!0)}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}async downgradeCodec(t){if(!this.ortc)return!1;const n={downgrade_codec:t,ortc:this.ortc};return!!await this.request(ge.DOWNGRADE_CODEC,n)}handleNotification(t){g.debug("[".concat(this.clientId,"] receive notification: "),t);const n=Kc(t.code);if(t.code===28&&"detail"in t&&(g.info("[".concat(this.clientId,"] receive recover notification: "),t.detail),this.emit(Ee.RECOVER_NOTIFICATION,t.detail)),n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?t.code===Re.ERR_REPEAT_JOIN_CHANNEL&&w("IGNORE_UID_CHECK")?void this.close(Ze.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ze.UID_BANNED),void this.close()):t.code===Re.K_VOS_FALLBACK&&"detail"in t?(g.info("[".concat(this.clientId,"] receive vos fallback notification: "),t.detail),t.detail==="FALLBACKCN"&&w("ENABLE_QUALITY_FALLBACK")?void hn(this,Ee.VOS_FALLBACK_PROMISE,t.detail).then(()=>{this.reconnect("recover",n.desc)}).catch(r=>{g.debug("[".concat(this.clientId,"] cancel vos fallback cn, error: "),r)}):t.detail==="fallback_hls"&&w("ENABLE_FALLBACK_TO_HLS")?(this.emit(Ee.VOS_FALLBACK,t.detail),void this.close(Ze.FALLBACK_TO_HLS)):this.reconnect(n.action,n.desc)):void this.reconnect(n.action,zn.SERVER_ERROR);g.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=w("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(g.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>w("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",zn.TIMEOUT):this.request(ge.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-n;this.rttRolling.add(r),w("REPORT_STATS")&&this.send(ge.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:n}=this.websocket.getWsInflateData();t!==0&&n!==0&&this.upload(Hc.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(Fe.RECONNECT_CREATE_CONNECTION,t=>{this.emit(Ee.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(Fe.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Fe.CLOSED,()=>{this.connectionState=$e.CLOSED}),this.websocket.on(Fe.FAILED,()=>{this._disconnectedReason=Ze.NETWORK_ERROR,this.connectionState=$e.CLOSED}),this.websocket.on(Fe.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===$e.CONNECTED?this.connectionState=$e.RECONNECTING:this.connectionState=$e.CONNECTING}),this.websocket.on(Fe.WILL_RECONNECT,(t,n,r)=>{const i=Nc(this,Ee.IS_P2P_DISCONNECTED),o=i||t!=="retry";i&&t==="retry"&&(g.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",n=rm.P2P_DISCONNECTED),o&&(g.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(Ee.REPORT_JOIN_GATEWAY,n||rm.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(Ee.DISCONNECT_P2P)),r(t)}),this.websocket.on(Fe.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{g.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",zn.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(Ee.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof B){if(t.code===b.UNEXPECTED_RESPONSE&&t.data.code===Re.ERR_NO_AUTHORIZED)return this.initError=new B(b.TOKEN_EXPIRE,"dynamic key expired"),void this.close(Ze.TOKEN_EXPIRE);g.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",zn.SERVER_ERROR):(this.initError=t,this.close())}})}),this.websocket.on(Fe.REQUEST_NEW_URLS,(t,n)=>{hn(this,Ee.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)}),this.websocket.on(Fe.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Pe.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(gn.PRE_CONNECT_PC,()=>{this.emit(Ee.PRE_CONNECT_PC)}),this.websocket.on(Fe.ON_FALLBACK,()=>{w("ENABLE_FALLBACK_TO_HLS")&&this.emit(Ee.VOS_FALLBACK,"fallback_hls")})}}let SX=function(e){return e.NATIVE_RTC="native_rtc",e.NATIVE_RTM="native_rtm",e.WEB_RTC="web_rtc",e.WEB_RTM="web_rtm",e}({}),cn=function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e}({});function O1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function sm(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?O1(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):O1(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}let OR=0;function ho(e){const t=w("TURN_DOMAINS");OR=(OR+1)%t.length;const n=t[OR]||"edge.agora.io";return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(n):(g.debug("Cannot recognized as ip address: ".concat(e,", use as host2")),e)}function am(e){try{const t=w("TURN_DOMAINS"),n=w("GATEWAY_DOMAINS").concat(t).find(r=>Z(e).call(e,r));return n?e.split(".".concat(n))[0].replace(/-/g,"."):e}catch{return g.debug("serverUrlToIp error, fallback to url",e),e}}function NR(e,t){e.addresses||(e.addresses=[]);const n=function(c,l){if(w("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return c.map(f=>{let{ip:_,port:E}=f;return{address:"".concat(_,":").concat(E)}});const u=w("GATEWAY_DOMAINS");let h=u[1]&&Z(l).call(l,u[1])?1:0;return c.map(f=>{let{domain_prefix:_,port:E,ip:I}=f;if(_)return{address:"".concat(_,".").concat(u[h++%u.length],":").concat(E)};const v=/^[\.\:\d]+$/.test(I),R=v?"".concat(I.replace(/[^\d]/g,"-"),".").concat(u[h++%u.length],":").concat(E):"".concat(I,":").concat(E);return v||g.debug("Cannot recognized as ip address: ".concat(I,", use as host3")),{ip:I,port:E,address:R}})}(e.addresses,t),r=Array.isArray(e.detail)&&e.detail[18];if(r&&typeof r=="string"){const c=r.split(";");for(let l=0;l<c.length;l++){var i;const u=_r(i=c[l]).call(i);n[l]&&u&&(n[l].ip6=u)}}const o=e.detail&&e.detail.candidate;let s;if(o){const[c,l]=o.split(":");c&&l&&(s={port:Number(l),ip:c,address:"".concat(c,":").concat(l)})}return{gatewayAddrs:n,apGatewayAddress:s,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function Pr(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function N1(e){const t=e._encoderConfig;if(!t)return{};const n={resolution:t.width&&t.height?"".concat(Pr(t.width),"x").concat(Pr(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(n.maxFrameRate=t.frameRate,n.minFrameRate=t.frameRate):t.frameRate&&(n.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,n.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),n}function cm(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function Ih(e,t){let n,r,i;switch(t){case cn.CHOOSE_SERVER:r=4096,i="choose server";break;case cn.CLOUD_PROXY:r=1048576,i="proxy";break;case cn.CLOUD_PROXY_5:r=4194304,i="proxy5";break;case cn.CLOUD_PROXY_FALLBACK:r=4194310,i="proxy fallback";break;default:throw new B(b.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach(o=>{o.buffer&&o.buffer.flag===r&&(n={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(s=>sm(sm({},s),{},{ticket:o.buffer.cert})),server_ts:e.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:sm(sm({},o.buffer.detail),e.detail),flag:o.buffer.flag,opid:e.opid,cert:o.buffer.cert})}),!n)throw new B(b.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(i," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return n}async function D1(e,t){return await se.all(e.addresses.map(async n=>({address:ho(n.ip),tcpport:n.port,udpport:n.port,username:t&&w("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():qn.username,password:t&&w("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await Av(t.toString()):qn.password})))}function DR(e,t){const n=t.getMediaStreamTrack(!0).getSettings(),r=t.videoHeight||n.height,i=t.videoWidth||n.width;return r&&i?Math.max(Math.min(r,i)/Math.min(Pr(e.height),Pr(e.width)),1):(g.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function Aa(e){let{candidateType:t,relayProtocol:n,type:r,address:i,port:o,protocol:s}=e;const c={candidateType:t,relayProtocol:n,protocol:s};if(r!=="local-candidate"){const l=i.split(".");l.length>=4&&(l[1]="*",l[2]="*"),c.address=l.join("."),c.port=o}return c}function ms(e){const t=e.split(":"),n=e.split(/[-.]/),r=Z(e).call(e,"-")?"-":".";let i=e;return t.length>1?n.length>1?(n[1]="**",i=n[0]+r+"**:"+t[t.length-1]):i=t.length>2?t[0]+r+"**:"+t[t.length-1]:"**:"+t[t.length-1]:n.length>1&&(i=n[0]+r+"**"),i}function P1(e,t){return e.getTransceivers().find(n=>n.sender.track===t||n.receiver.track===t)}function wh(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:w("SVC_MODE");if(w("ENABLE_SVC"))return function(t){return t in P_}(e)?e:P_.L1T3}const L1={[ue.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[ue.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function k1(e){e.send&&(Al(ue.VIDEO,e.send.videoExtensions),Al(ue.AUDIO,e.send.audioExtensions)),e.recv&&(Al(ue.VIDEO,e.recv.videoExtensions),Al(ue.AUDIO,e.recv.audioExtensions)),e.sendrecv&&(Al(ue.VIDEO,e.sendrecv.videoExtensions),Al(ue.AUDIO,e.sendrecv.audioExtensions))}function M1(e,t){e.send&&(dm(ue.VIDEO,e.send.videoExtensions,t.send.videoExtensions),dm(ue.AUDIO,e.send.audioExtensions,t.send.audioExtensions)),e.recv&&(dm(ue.VIDEO,e.recv.videoExtensions,t.recv.videoExtensions),dm(ue.AUDIO,e.recv.audioExtensions,t.recv.audioExtensions))}function dm(e,t,n){t.forEach(r=>{var i;const o=L1[e].find(c=>{var l;let{key:u}=c;return Z(l=r.extensionName).call(l,u)});if(!o)return;const s=n.find(c=>{let{extensionName:l}=c;return Z(l).call(l,o.key)});s&&Z(i=s.extensionName).call(i,"gdpr_forbidden")&&(r.extensionName=s.extensionName)})}function Al(e,t){t.forEach(n=>{var r;const i=L1[e].find(o=>{var s;let{key:c}=o;return Z(s=n.extensionName).call(s,c)});Z(r=n.extensionName).call(r,"gdpr_forbidden")&&i&&(n.extensionName=i.extensionName)})}function U1(e){return e==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||Z(e).call(e,"abs-send-time")}function lm(e){return e==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||Z(e).call(e,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function x1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function V1(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?x1(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):x1(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}function Ah(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0;const{filterRTX:i,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:c,filterVideoCodec:l,unsupportedVideoUplinkCodec:u,unsupportedVideoDownlinkCodec:h}=t,{useXR:f}=n;let _=[],E=[],I=[],v=[],R=!1,A=!1;if(gr(e).mediaDescriptions.forEach(P=>{r&&r!==P.attributes.direction||(P.media.mediaType!=="video"||R||(E=P.attributes.payloads,v=P.attributes.extmaps,R=!0),P.media.mediaType!=="audio"||A||(_=P.attributes.payloads,I=P.attributes.extmaps,A=!0))}),!v||E.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!I||_.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(E.forEach(P=>{var M;(M=P.rtpMap)!==null&&M!==void 0&&M.clockRate&&(P.rtpMap.clockRate=parseInt(P.rtpMap.clockRate)),f&&P.rtcpFeedbacks.push({type:"rrtr"})}),_.forEach(P=>{var M;(M=P.rtpMap)!==null&&M!==void 0&&M.clockRate&&(P.rtpMap.clockRate=parseInt(P.rtpMap.clockRate)),f&&P.rtcpFeedbacks.push({type:"rrtr"})}),i&&(_=_.filter(P=>{var M;return((M=P.rtpMap)===null||M===void 0?void 0:M.encodingName.toLowerCase())!=="rtx"}),E=E.filter(P=>{var M;return((M=P.rtpMap)===null||M===void 0?void 0:M.encodingName.toLowerCase())!=="rtx"})),o){const P=E.filter(L=>{var V;return/(red)|(ulpfec)|(flexfec)/i.test(((V=L.rtpMap)===null||V===void 0?void 0:V.encodingName)||"")}),M=ba(P,E).map(L=>L.payloadType),U=[...P.map(L=>L.payloadType),...M];E=E.filter(L=>!Z(U).call(U,L.payloadType))}if(s&&(_=_.filter(P=>{var M;return!/(red)|(ulpfec)|(flexfec)/i.test(((M=P.rtpMap)===null||M===void 0?void 0:M.encodingName)||"")})),c&&(c==null?void 0:c.length)>0&&(_=_.filter(P=>{var M;return Z(c).call(c,((M=P.rtpMap)===null||M===void 0?void 0:M.encodingName.toLowerCase())||"")})),l&&(l==null?void 0:l.length)>0){const P=E.filter(M=>{var U;return Z(l).call(l,((U=M.rtpMap)===null||U===void 0?void 0:U.encodingName.toLowerCase())||"")});E=P.concat(i?[]:ba(P,E))}const O=w("UNSUPPORTED_VIDEO_CODEC");if(O&&O.length>0){const P=E.filter(L=>L.rtpMap&&Z(O).call(O,L.rtpMap.encodingName.toLowerCase())),M=ba(P,E),U=P.concat(M).map(L=>L.payloadType);E=E.filter(L=>!Z(U).call(U,L.payloadType)),g.debug("unsupportedVideoCodec: ".concat(O,", toBeRemoved: ").concat(U))}if(u&&u.length>0&&r==="sendonly"){const P=E.filter(L=>L.rtpMap&&Z(u).call(u,L.rtpMap.encodingName.toLowerCase())),M=ba(P,E),U=P.concat(M).map(L=>L.payloadType);E=E.filter(L=>!Z(U).call(U,L.payloadType)),g.debug("unsupportedVideoUplinkCodec: ".concat(u,", toBeRemoved: ").concat(U))}if(h&&h.length>0&&r==="recvonly"){const P=E.filter(L=>L.rtpMap&&Z(h).call(h,L.rtpMap.encodingName.toLowerCase())),M=ba(P,E),U=P.concat(M).map(L=>L.payloadType);E=E.filter(L=>!Z(U).call(U,L.payloadType)),g.debug("unsupportedVideoDownlinkCodec: ".concat(h,", toBeRemoved: ").concat(U))}return{audioCodecs:_,videoCodecs:E,audioExtensions:I,videoExtensions:v}}function Es(e){const t=gr(e);let n,r;for(const i of t.mediaDescriptions){if(!n){const o=i.attributes.iceUfrag,s=i.attributes.icePwd;if(!o||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:o,icePwd:s}}if(!r){const o=i.attributes.fingerprints;o.length>0&&(r={fingerprints:o})}}if(!r&&t.attributes.fingerprints.length>0&&(r={fingerprints:t.attributes.fingerprints}),!r||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:r}}function PR(e,t){const n=[],r=e.attributes.ssrcGroups.filter(s=>s.semantic==="FID"),i=e.attributes.ssrcGroups.find(s=>s.semantic==="SIM"),o=e.attributes.ssrcs;if(i)i.ssrcIds.forEach(s=>{var c;const l=(c=r.find(u=>u.ssrcIds[0]===s))===null||c===void 0?void 0:c.ssrcIds[1];n.push({ssrcId:s,rtx:t?l:void 0})});else if(r.length>0){const s=r[0].ssrcIds[0],c=r[0].ssrcIds[1];n.push({ssrcId:s,rtx:t?c:void 0})}else{if(o.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:o[0].ssrcId})}return n}function F1(e,t,n){const{cname:r}=e;let i=[];t&&(i=B1(t)),i.length===0&&(i=e.iceParameters.candidates.map(h=>({foundation:h.foundation,componentId:"1",transport:h.protocol,priority:h.priority.toString(),connectionAddress:h.ip,port:h.port.toString(),type:h.type,extension:{}})),g.debug("Using candidates from gateway."));const o={fingerprints:e.dtlsParameters.fingerprints.map(h=>({hashFunction:h.algorithm,fingerprint:h.fingerprint}))},s={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let c;switch(e.dtlsParameters.role){case"server":c="passive";break;case"client":c="active";break;case"auto":c="actpass"}const l=Oh(e.rtpCapabilities),u=[];return Array.isArray(n)&&n.length>0&&n.forEach(h=>{u.push({kind:ue.VIDEO,ssrcMsg:[{ssrcId:h.v,rtx:h.v_rtx}],mslabel:"".concat(h.v,"_").concat(h.a)},{kind:ue.AUDIO,ssrcMsg:[{ssrcId:h.a}],mslabel:"".concat(h.v,"_").concat(h.a)})}),{dtlsParameters:o,iceParameters:s,candidates:i,rtpCapabilities:l,setup:c,cname:r,preSSRCs:u}}function B1(e){let t=[];return e.ip&&typeof e.port=="number"&&(t=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip,port:e.port.toString(),type:"host",extension:{}}],g.debug("Using remote candidate from AP ".concat(ms(e.ip),":").concat(e.port)),e.ip6&&(t.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:e.ip6,port:e.port.toString(),type:"host",extension:{}}),g.debug("Using IPV6 remote candidate from AP ".concat(ms(e.ip6),":").concat(e.port)))),t}function bh(e,t,n){const r=[],i=[];return e.forEach(o=>{let{ssrcId:s,rtx:c}=o;const l=_t(8,"track-"),u={ssrcId:s,attributes:V1({label:l,mslabel:n=n||_t(10,""),msid:"".concat(n," ").concat(l)},t&&{cname:t})};if(r.push(u),c!==void 0){const h={ssrcId:c,attributes:V1({label:l,mslabel:n,msid:"".concat(n," ").concat(l)},t&&{cname:t})};r.push(h),i.push({semantic:"FID",ssrcIds:[s,c]})}}),e.length>1&&i.push({semantic:"SIM",ssrcIds:e.map(o=>{let{ssrcId:s}=o;return s})}),{ssrcs:r,ssrcGroups:i}}function Yc(e,t){t instanceof Zt&&e.attributes.payloads.forEach(n=>{var r;const i=(r=n.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase();if(!i||["opus","pcmu","pcma","g722"].indexOf(i)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),i==="opus"&&typeof w("OPUS_PTIME")=="number"?n.fmtp.parameters.ptime=w("OPUS_PTIME"):n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";const o=t._encoderConfig;o&&(i!=="pcmu"&&i!=="pcma"&&i!=="g722"&&(o.bitrate&&!kt()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1")),t instanceof Rh&&i==="opus"&&t._config.DTX&&(n.fmtp.parameters.usedtx="1"))})}function LR(e){const t=e.attributes.unrecognized.findIndex(n=>n.attField==="x-google-flag"&&n.attValue==="conference");t!==-1&&e.attributes.unrecognized.splice(t,1)}function kR(e,t){var n;if(e.attributes.payloads.forEach(i=>{var o;((o=i.rtpMap)===null||o===void 0?void 0:o.encodingName.toLowerCase())==="h264"&&i.fmtp&&i.fmtp.parameters&&w("ENABLE_UP_SPS_PPS")&&(i.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),!(t instanceof wt&&t._encoderConfig&&t._hints.indexOf(pt.SCREEN_TRACK)===-1))return;const r=t._encoderConfig;Xe().supportMinBitrate&&r.bitrateMin&&e.attributes.payloads.forEach(i=>{var o,s;Z(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=i.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters["x-google-min-bitrate"]="".concat(r.bitrateMin))}),Xe().supportMinBitrate&&!Z(n=t._hints).call(n,pt.LOW_STREAM)&&r.bitrateMax&&e.attributes.payloads.forEach(i=>{var o,s;Z(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=i.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters["x-google-start-bitrate"]="".concat(w("X_GOOGLE_START_BITRATE")||Math.floor(r.bitrateMax)))})}function j1(e){if(e.media.mediaType!=="video")return;const t=ot();if(t.name!==at.SAFARI&&t.os!==Cn.IOS)return;const n=e.attributes.extmaps.findIndex(r=>/video-orientation/g.test(r.extensionName));n!==-1&&e.attributes.extmaps.splice(n,1)}function um(e,t,n){if(!t)return;let r,i;if(e.media.mediaType==="video"?(r=n.videoExtensions,i=n.videoCodecs):(r=n.audioExtensions,i=n.audioCodecs),t.twcc===!0){const o=r.find(s=>lm(s.extensionName));if(o){const s=o.extensionName;e.attributes.extmaps.find(l=>lm(l.extensionName))||e.attributes.extmaps.push({entry:o.entry,extensionName:s}),function(l,u){return u.filter(h=>!!l.find(f=>f.payloadType===h.payloadType&&!!f.rtcpFeedbacks.find(_=>_.type==="transport-cc")))}(i,e.attributes.payloads).forEach(l=>{l.rtcpFeedbacks.find(u=>u.type==="transport-cc")||l.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(t.twcc===!1){const o=e.attributes.extmaps.findIndex(s=>lm(s.extensionName));o!==-1&&e.attributes.extmaps.splice(o,1),e.attributes.payloads.forEach(s=>{const c=s.rtcpFeedbacks.findIndex(l=>l.type==="transport-cc");c!==-1&&s.rtcpFeedbacks.splice(c,1)})}if(t.remb===!0){const o=r.find(s=>U1(s.extensionName));if(o){const s=o.extensionName;e.attributes.extmaps.find(l=>l.extensionName===s)||e.attributes.extmaps.push({entry:o.entry,extensionName:s}),function(l,u){return u.filter(h=>!!l.find(f=>f.payloadType===h.payloadType&&!!f.rtcpFeedbacks.find(_=>_.type==="goog-remb")))}(i,e.attributes.payloads).forEach(l=>{l.rtcpFeedbacks.find(u=>u.type==="goog-remb")||l.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(t.remb===!1){const o=e.attributes.extmaps.findIndex(s=>U1(s.extensionName));o!==-1&&e.attributes.extmaps.splice(o,1),e.attributes.payloads.forEach(s=>{const c=s.rtcpFeedbacks.findIndex(l=>l.type==="goog-remb");c!==-1&&s.rtcpFeedbacks.splice(c,1)})}}function MR(e,t,n){if(kt()||e.media.mediaType!=="video"||!(t instanceof wt)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!w("SIMULCAST")||n==="vp9"&&w("ENABLE_SVC")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;const r=n==="vp8"?2:t._scalabilityMode.numSpatialLayers,i=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find(c=>c.semantic==="FID"&&c.ssrcIds[0]===i.ssrcId),s={semantic:"SIM",ssrcIds:[i.ssrcId]};for(let c=1;c<r;c++)e.attributes.ssrcs.push({ssrcId:i.ssrcId+c,attributes:Mt(i.attributes)}),s.ssrcIds.push(i.ssrcId+c),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+c,attributes:Mt(i.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[i.ssrcId+c,o.ssrcIds[1]+c]}));e.attributes.ssrcGroups.unshift(s)}async function G1(){try{const e=new RTCPeerConnection;e.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:P_.L1T3}]});const t=await e.createOffer();if(!t.sdp)return void e.close();const n=gr(t.sdp).mediaDescriptions[0];if(!n)return;const r=n.attributes.extmaps.find(i=>i.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension");return e.close(),r}catch{return}}async function UR(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const r=(await n.createOffer()).sdp,{send:i,recv:o,sendrecv:s}=function(){let c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},l=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},u=arguments.length>2?arguments[2]:void 0;const h=Ah(u,c,l,"sendonly"),f=Ah(u,c,l,"recvonly"),_={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},E={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},I={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(po(h,f,"videoExtensions",_,E,I),po(h,f,"videoCodecs",_,E,I),po(h,f,"audioExtensions",_,E,I),po(h,f,"audioCodecs",_,E,I),w("RAISE_H264_BASELINE_PRIORITY")){const v=[],R=[];if(I.videoCodecs.forEach((A,O)=>{var P;if(((P=A.rtpMap)===null||P===void 0?void 0:P.encodingName.toLocaleLowerCase())==="h264"){var M,U;const L=I.videoCodecs[O+1],V=L&&Y1(A,L),H=(M=A.fmtp)===null||M===void 0?void 0:M.parameters["profile-level-id"],q=(U=A.fmtp)===null||U===void 0?void 0:U.parameters["packetization-mode"];!H||H!==w("FIRST_H264_PROFILE_LEVEL_ID")||w("FIRST_PACKETIZATION_MODE")&&q!==w("FIRST_PACKETIZATION_MODE")?V?R.push([A,L]):R.push([A]):V?v.push([A,L]):v.push([A])}}),v.length>0&&R.length>0){g.debug("raising H264 baseline profile priority"),I.videoCodecs.forEach((O,P)=>{var M;if(((M=O.rtpMap)===null||M===void 0?void 0:M.encodingName.toLocaleLowerCase())==="h264"){const U=Y1(O,I.videoCodecs[P+1]),L=v.shift()||R.shift()||[];L.length>0&&(U?I.videoCodecs.splice(P,2,...L):I.videoCodecs.splice(P,1,...L))}});const A=E.videoCodecs.filter(O=>{var P,M;return((P=O.rtpMap)===null||P===void 0?void 0:P.encodingName.toLocaleLowerCase())==="h264"&&((M=O.fmtp)===null||M===void 0?void 0:M.parameters["profile-level-id"])!==w("FIRST_H264_PROFILE_LEVEL_ID")});if(A.length>0){const O=ba(A,E.videoCodecs).map(M=>M.payloadType),P=[...A.map(M=>M.payloadType),...O];E.videoCodecs=E.videoCodecs.filter(M=>!Z(P).call(P,M.payloadType))}w("FILTER_SEND_H264_BASELINE")&&(_.videoCodecs=_.videoCodecs.filter(O=>{var P,M;return!(((P=O.rtpMap)===null||P===void 0?void 0:P.encodingName.toLocaleLowerCase())==="h264"&&((M=O.fmtp)===null||M===void 0?void 0:M.parameters["profile-level-id"])!==w("FIRST_H264_PROFILE_LEVEL_ID"))}))}return{send:_,recv:E,sendrecv:I}}return{send:_,recv:E,sendrecv:I}}(e,t,r);try{n.close()}catch{}return{send:i,recv:o,sendrecv:s}}function W1(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=Ah(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(po(e,t,"videoExtensions",n,r,i),po(e,t,"videoCodecs",n,r,i),po(e,t,"audioExtensions",n,r,i),po(e,t,"audioCodecs",n,r,i),w("RAISE_H264_BASELINE_PRIORITY")){const o=i.videoCodecs.findIndex(s=>s.rtpMap&&s.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&s.fmtp&&s.fmtp.parameters["profile-level-id"]==="42001f");if(o!==-1){const s=i.videoCodecs.findIndex(c=>c.rtpMap&&c.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(s<o){g.debug("raising H264 baseline profile priority");const c=i.videoCodecs[o];i.videoCodecs.splice(o,1),i.videoCodecs.splice(s,0,c)}s!==-1&&(r.videoCodecs=r.videoCodecs.filter(c=>!(c.rtpMap&&c.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&c.fmtp&&c.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:n,recv:r,sendrecv:i}}function po(e,t,n,r,i,o){if(n==="videoExtensions"||n==="audioExtensions"){const s=[];return e[n].forEach(c=>{t[n].some((l,u)=>{if(c.entry===l.entry&&c.extensionName===l.extensionName)return s.push(u),!0})?o[n].push(c):r[n].push(c)}),void t[n].forEach((c,l)=>{s.indexOf(l)===-1&&i[n].push(c)})}if(n==="videoCodecs"||n==="audioCodecs"){const s=[];return e[n].forEach(c=>{t[n].some((l,u)=>{if(c.payloadType===l.payloadType&&JSON.stringify(c)===JSON.stringify(l))return s.push(u),!0})?o[n].push(c):r[n].push(c)}),void t[n].forEach((c,l)=>{s.indexOf(l)===-1&&i[n].push(c)})}}function Oh(e){const{send:t,recv:n,sendrecv:r}=e;if(!r){if(!t||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:n}}let i,o;return t?(i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i.audioCodecs=[...t.audioCodecs,...r.audioCodecs],i.videoCodecs=[...t.videoCodecs,...r.videoCodecs],i.audioExtensions=[...t.audioExtensions,...r.audioExtensions],i.videoExtensions=[...t.videoExtensions,...r.videoExtensions]):i=Mt(r),n?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...n.audioCodecs,...r.audioCodecs],o.videoCodecs=[...n.videoCodecs,...r.videoCodecs],o.audioExtensions=[...n.audioExtensions,...r.audioExtensions],o.videoExtensions=[...n.videoExtensions,...r.videoExtensions]):o=Mt(r),{send:i,recv:o}}function bl(e){e.media.mediaType==="audio"&&e.attributes.payloads.filter(t=>{var n;return((n=t.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"}).forEach(t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"})}function Nh(e,t,n,r){let i=[];if(e===ue.VIDEO){if(w("H264_PROFILE_LEVEL_ID")&&r==="h264"&&(i=t.videoCodecs.filter(o=>{var s;return Z(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,r)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===w("H264_PROFILE_LEVEL_ID")})),!Array.isArray(i)||i.length===0){let o=[];const s=[],c=[],l=[];if(n.videoCodecs.forEach(u=>{const h=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"";Z(h).call(h,r)?o.push(u):Z(h).call(h,"vp9")?s.push(u):Z(h).call(h,"vp8")?c.push(u):Z(h).call(h,"h264")&&l.push(u)}),o.length===0){let u="";s.length!==0?(o=s,u="vp9"):c.length!==0?(o=c,u="vp8"):l.length!==0&&(o=l,u="h264"),g.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(u))}o.length!==0&&(i=t.videoCodecs.filter(u=>o.some(h=>h.payloadType===u.payloadType)))}if(i.length===0&&(g.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),i=t.videoCodecs),w("USE_PUB_RTX")||w("USE_SUB_RTX")){const o=ba(i,t.videoCodecs);i=[...i,...o]}}else{i=t.audioCodecs.filter(s=>{var c;return Z(c=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(c,r)});const o=t.audioCodecs.filter(s=>{var c;return Z(c=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(c,"red")});i.length===0&&(g.warning("codec ".concat(r," not included in rtpCapabilities, fallback to opus")),i=t.audioCodecs.filter(s=>{var c;return Z(c=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(c,"opus")})),w("ENABLE_AUDIO_RED")&&o.length!==0&&(i=[...o,...i])}return i}function ba(e,t){const n=e.map(r=>r.payloadType.toString());return t.filter(r=>r.rtpMap&&r.rtpMap.encodingName==="rtx"&&r.fmtp&&r.fmtp.parameters.apt&&Z(n).call(n,r.fmtp&&r.fmtp.parameters.apt))}async function Wr(e,t,n){const r=t.toString(),i=H1(r,"offer","remote","exchangeSDP");await e.setRemoteDescription({type:"offer",sdp:r});const o=await e.createAnswer();if(!o.sdp)throw new Error("cannot get answer sdp");let s=o.sdp;s=xR(s,n||{}),i==null||i(s||""),await e.setLocalDescription({type:"answer",sdp:s})}function xR(e,t,n){if(w("FORBID_MODIFY_LOCAL_OFFER_SDP"))return e;const r=gr(e),{useXR:i}=t;return r.mediaDescriptions.forEach(o=>{var s;o.attributes.mid&&(Array.isArray(n)&&!Z(n).call(n,o.attributes.mid)||(o.media.mediaType==="audio"&&bl(o),o.media.mediaType==="video"&&function(c){c.media.mediaType==="video"&&w("ENABLE_DOWN_SPS_PPS")&&c.attributes.payloads.filter(l=>{var u;return((u=l.rtpMap)===null||u===void 0?void 0:u.encodingName.toLowerCase())==="h264"}).forEach(l=>{l.fmtp||(l.fmtp={parameters:{}}),l.fmtp.parameters["sps-pps-idr-in-keyframe"]="1"})}(o),i&&Z(s=["audio","video"]).call(s,o.media.mediaType)&&o.attributes.payloads.forEach(c=>{c.rtcpFeedbacks.findIndex(l=>l.type==="rrtr")===-1&&c.rtcpFeedbacks.push({type:"rrtr"})})))}),js(r)}function H1(e,t,n,r){if(w("SDP_LOGGING"))return g.upload("exchanging ".concat(n," ").concat(t," SDP during P2PConnection.").concat(r,`
`),e),t==="offer"?i=>{H1(i,"answer",n==="local"?"remote":"local",r)}:void 0}async function K1(e,t,n){try{var r;if(!Xe().supportSetRtpSenderParameters||!function(l){return l==="vp9"||l==="av1"}(e)||!w("ENABLE_SVC"))return;const i={},o={},s=t.getParameters(),c=(r=s.encodings)===null||r===void 0?void 0:r[0];o.scalabilityMode=wh(n),c&&Object.assign(c,o),Object.assign(s,i),await t.setParameters(s),g.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(s.encodings)))}catch(i){g.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",i)}}function hm(e){const t=w("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(t)&&t.length>0)&&t.some(n=>Z(e).call(e,n))}function Y1(e,t){try{var n;return((n=e.fmtp)===null||n===void 0?void 0:n.parameters.apt)===t.payloadType.toString()}catch{return!1}}function z1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function ii(e,t){return typeof w(e)===t?w(e):void 0}function TX(){try{const e=w("EXPERIMENTS")||{};return typeof e=="string"||Array.isArray(e)?{}:function(t){for(var n=1;n<arguments.length;n++){var r=arguments[n]!=null?arguments[n]:{};n%2?z1(Object(r),!0).forEach(function(i){y(t,i,r[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):z1(Object(r)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(r,i))})}return t}({},e)}catch(e){return g.debug("handle gateway attributes failed: ",e),{}}}const q1={};function gs(e){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&g.debug("install service ".concat(e.name)),q1[e.name]=e}function Bo(e){const t=q1[e];if(!t)throw new W(b.INVALID_OPERATION,"".concat(e," not found, please use AgoraRTC.use(").concat(e,"Service) to load it first"));return t}function X1(e,t){return Bo("DataStream").create(e,t)}function pm(){return Bo("InterceptFrame").create()}function J1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Un(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?J1(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):J1(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}const VR=new Map;class vX extends Wt{get state(){return this._state}set state(t){if(t===this._state)return;const n=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(nn.CONNECTION_STATE_CHANGE,t,n,this._disconnectedReason):this.emit(nn.CONNECTION_STATE_CHANGE,t,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){g.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,n){var r,i,o;super(),y(this,"store",void 0),y(this,"joinInfo",void 0),y(this,"key",void 0),y(this,"ntpOffset",0),y(this,"usingProxy",!1),y(this,"signal",void 0),y(this,"role",void 0),y(this,"isPreallocation",void 0),y(this,"isPreSub",void 0),y(this,"inChannelInfo",{joinAt:null,duration:0}),y(this,"spec",void 0),y(this,"_state","DISCONNECTED"),y(this,"_statsCollector",void 0),y(this,"_disconnectedReason",void 0),y(this,"isSignalRecover",!1),y(this,"hasChangeBGPAddress",!1),y(this,"trafficStatsInterval",void 0),y(this,"networkQualityInterval",void 0),y(this,"_joinGatewayStartTime",0),y(this,"_signalTimeout",!1),y(this,"_clientRoleOptions",void 0),y(this,"_isProactiveJoin",!1),this.store=t,this.spec=n,this.signal=this.store.useP2P?(r={spec:Un(Un({},n),{},{retryConfig:n.websocketRetryConfig}),store:t},(i=(o=Bo("P2PChannel")).createSubmodule)===null||i===void 0?void 0:i.call(o,r)):this.store.useDcSignal?function(s){return Bo("DataChannelSignal").create(s)}({spec:Un(Un({},n),{},{retryConfig:n.websocketRetryConfig}),store:t}):new b1(Un(Un({},n),{},{retryConfig:n.websocketRetryConfig}),t),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}setUsingProxy(t){this.usingProxy=t}async join(t,n,r){if(this.store.useDcSignal){let h=!1;t.cloudProxyServer!=="disabled"?(g.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),h=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(g.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),h=!0):t.apResponse.addresses.some(f=>f.fingerprint)||w("FINGERPRINT")||(g.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),h=!0),h&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const i=Date.now();let o=VR.get(t.cname);if(o||(o=new Map,VR.set(t.cname,o)),this._isProactiveJoin=!0,o.has(t.uid)){const h=new B(b.UID_CONFLICT);throw pe.joinGateway(t.sid,{lts:i,succ:!1,ec:h.code,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!t.proxyServer||this.usingProxy,signalChannel:this.store.useDcSignal?"1":"0",preload:t.preload}),h}o.set(t.uid,!0),this.joinInfo=t,this.key=n;let s=0;this.joinGatewayStartTime=i;const c=t.proxyServer,l=this.store.useDcSignal?"datachannel":"websocket";try{g.debug("[".concat(this.store.clientId,"] use ").concat(l," join uid ").concat(s));const h=t.gatewayAddrs.map(_=>{let{address:E}=_;const[I,v]=E.split(":"),R={host:I,port:v};return t.proxyServer&&(R.proxy=t.proxyServer),R});let f;f=this.store.useDcSignal?await this.signal.init(t.apResponse.addresses):await this.signal.init(h),s=f.uid,g.debug("[".concat(this.store.clientId,"] ").concat(l," join uid ").concat(s," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(h){var u;throw h.code===b.INIT_DATACHANNEL_TIMEOUT&&this.signal.__name__==="AgoraRTCSignal"||pe.joinGateway(t.sid,{lts:i,succ:!1,ec:((u=h.data)===null||u===void 0?void 0:u.desc)||h.code,errorMsg:h.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,isProxy:!!c||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:t.preload}),h&&h.code===b.INIT_DATACHANNEL_TIMEOUT?(g.warning("[".concat(this.store.clientId,"] User join datachannel failed"),h.toString()),this.resetSignal(),h):(g.error("[".concat(this.store.clientId,"] User join failed"),h.toString()),o.delete(t.uid),this.signal.close(),h)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),g.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(h=>{g.warning("[".concat(this.store.clientId,"] get traffic stats error"),h.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(nn.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(nn.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(nn.NETWORK_QUALITY,{uplinkNetworkQuality:cm(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:cm(this._statsCollector.trafficStats.B_dnq)}):this.emit(nn.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),s}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==Ze.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==$e.CONNECTED||await function(r,i){return i===1/0?r:se.race([r,q7(i)])}(this.signal.request(ge.LEAVE,void 0,!0),3e3)}catch(r){g.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),r)}this.signal.close(n),n!==Ze.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,n,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const i={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:w("PUB_EXTEND"),twcc:!!w("PUBLISH_TWCC"),rtx:!!w("USE_PUB_RTX")};try{return(await this.signal.request(ge.PUBLISH,i,!0))._message}catch(o){if(r&&o.data&&o.data.code===Re.ERR_PUBLISH_REQUEST_INVALID)return g.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),await this.tryUnpubBeforeRepub(t,n),this.publish(t,n,!1);throw o}}async publishDataChannel(t,n,r){var i;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(i=n.maxRetransmits)!==null&&i!==void 0?i:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request(ge.PUBLISH_DATASTREAM,o,!0)}catch(s){if(r&&s.data&&s.data.code===Re.ERR_PUBLISH_REQUEST_INVALID)return g.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(t,n),this.publishDataChannel(t,n,!1);throw s}}async unpublish(t,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(ge.UNPUBLISH,{stream_id:n,ortc:t},!0)}catch(r){g.warning("[".concat(this.store.clientId,"] unpublish warning: "),r)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await se.all(t.map(n=>this.signal.request(ge.UNPUBLISH_DATASTREAM,{channel_id:n},!0)))}catch(n){g.warning("unpublish datachannels warning: ",n)}}async presubscribe(t,n,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const i={stream_id:t,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!w("SUBSCRIBE_TWCC"),rtx:!!w("USE_SUB_RTX")||void 0,extend:w("SUB_EXTEND"),svc:Array.isArray(w("SVC"))&&w("SVC").length!==0?w("SVC"):void 0};try{return await this.signal.request(ge.PRE_SUBSCRIBE,i,!0)}catch(o){if(r&&o.data&&o.data.code===Re.ERR_SUBSCRIBE_REQUEST_INVALID)return g.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),o.toString()),this.presubscribe(t,n,!1);throw o}}async subscribe(t,n,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const i={stream_id:t,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!w("SUBSCRIBE_TWCC"),rtx:!!w("USE_SUB_RTX"),extend:w("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(w("SVC"))&&w("SVC").length!==0?w("SVC"):void 0};try{return(await this.signal.request(ge.SUBSCRIBE,i,!0))._message}catch(o){if(r&&o.data&&o.data.code===Re.ERR_SUBSCRIBE_REQUEST_INVALID)return g.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),await this.tryUnsubBeforeResub(t,n),await this.subscribe(t,n,!1);throw o}}async subscribeDataChannel(t,n,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const i={uid:t,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request(ge.SUBSCRIBE_DATASTREAM,i,!0)}catch(o){if(r&&o.data&&o.data.code===Re.ERR_SUBSCRIBE_REQUEST_INVALID)return g.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),o.toString()),await this.tryUnsubDataChannelBeforeResub(t,n),await this.subscribeDataChannel(t,n,!1);throw o}}async subscribeAll(t,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const r={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!w("USE_SUB_RTX"),twcc:!!w("SUBSCRIBE_TWCC"),svc:Array.isArray(w("SVC"))&&w("SVC").length!==0?w("SVC"):void 0};try{return await this.signal.request(ge.SUBSCRIBE_STREAMS,r,!0)}catch(i){if(n&&i.data&&i.data.code===Re.ERR_SUBSCRIBE_REQUEST_INVALID)return g.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),i.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw i}}async setVideoProfile(t){const n=function(r){if(!(r.bitrateMax&&r.bitrateMin&&r.frameRate&&r.height&&r.width))return;let i=r.frameRate,o=r.width,s=r.height,c=!0;return typeof i!="number"&&(i=i.exact||i.ideal||i.max||i.min||0,i||(c=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(c=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,i||(c=!1)),c?{stream_type:0,width:o,height:s,fps:i,start_bps:1e3*r.bitrateMax,min_bps:1e3*r.bitrateMin,target_bps:1e3*r.bitrateMax}:void 0}(t);if(n)return this.signal.request(ge.SET_VIDEO_PROFILE,n);g.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,n){try{await this.signal.request(ge.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:n},!0)}catch(r){g.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),r)}}async unsubscribeDataChannel(t,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await se.all(t.map(r=>this.signal.request(ge.UNSUBSCRIBE_DATASTREAM,{stream_id:r,uid:n},!0)))}catch(r){g.warning("unsubscribeDataChannel warning: ",r)}}async massUnsubscribe(t){try{await this.signal.request(ge.UNSUBSCRIBE_STREAMS,t,!0)}catch(n){g.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n)}}async reconnectPC(t){const{iceParameters:n,dtlsParameters:r,rtpCapabilities:i}=t;return{gatewayEstablishParams:await this.signal.request(ge.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:r,rtpCapabilities:i}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(ge.GATEWAY_INFO)}async renewToken(t){await this.signal.request(ge.RENEW_TOKEN,t),this.key=t.token}updateClientRole(t,n){n&&(this._clientRoleOptions=Object.assign({},n)),w("CLIENT_ROLE_OPTIONS")&&(g.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(w("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},w("CLIENT_ROLE_OPTIONS"))),this.role=t}async setClientRole(t,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),w("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},w("CLIENT_ROLE_OPTIONS")),g.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(w("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=t);let r,i=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(r=this._clientRoleOptions.delay,i=1):i=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:i=0;const o=Object.assign({},n);delete o.delay,delete o.level,await this.signal.request(ge.SET_CLIENT_ROLE,Un(Un({role:t,level:i,delay:r},o),{},{client_ts:Date.now()})),this.role=t}async setDualStreamMode(t,n,r){await this.signal.request(ge.SET_DUAL_STREAM_MODE,{mode:t},r,n)}async setRemoteVideoStreamType(t,n){await this.signal.request(ge.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:n})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(ge.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,n){await this.signal.request(ge.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:n})}async pickSVCLayer(t,n){await this.signal.request(ge.PICK_SVC_LAYER,{stream_id:t,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})}async setRTM2Flag(t){await this.signal.request(ge.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,n,r){if(this.store.useP2P)return this.signal.sendExtensionMessage(t,n,r)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Un({},this.inChannelInfo)}async setConfigure(t){if(t&&Array.isArray(t)&&t.length!==0)return this.signal.request(ge.CONFIGURE,t)}async getGatewayVersion(){return(await this.signal.request(ge.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=VR.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0),this.usingProxy=!1}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=function(n){let r;return r=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),r?{username:qn.username,password:qn.password,turnServerURL:r[2],tcpport:parseInt(r[3])+30,udpport:parseInt(r[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Un(Un({},qn),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const t=await this.signal.request(ge.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach(n=>{const r=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(i=>i.peer_uid===n.peer_uid);r&&r.B_st!==n.B_st&&b_(()=>{this.emit(nn.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st)})}),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){var n,r,i,o;if(!this.joinInfo||!this.key)throw new B(b.UNEXPECTED_ERROR,"can not generate join message, no join info");const s=Object.assign({},this.joinInfo.apResponse);let c=w("REPORT_APP_SCENARIO");if(typeof c!="string")try{c=JSON.stringify(c)}catch{c=void 0}var l;c&&c.length>128&&(c=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(nn.UPDATE_GATEWAY_CONFIG),l=this.store.clientId,Z(Rl).call(Rl,l)||Rl.push(l);const u=Th(this.store),h=!((n=this.isPreallocation)===null||n===void 0||!n.call(this)),f=JP(this.store),_=TX(),E=ko(87)||nP()||vv(117),I=(function(){const O=ot();if(O.name!==at.SAFARI||!O.browserVersion)return!1;const P=O.browserVersion.split(".");return Number(P[0])>18||Number(P[0])===18&&Number(P[1])>=4}()||sP(18,4,!1))&&Rv(18,6,!0)&&this.spec.codec==="h264"&&w("ENABLE_ABSSENDTIME_AS_SENTTS"),v=!(((r=s.detail)===null||r===void 0?void 0:r[3])!=="CN"||!w("ENABLE_QUALITY_FALLBACK"))&&w("ENABLE_QUALITY_FALLBACK"),R=!!w("ENABLE_AP_MULTI_IP")&&((i=s.detail)===null||i===void 0?void 0:i[5])==="multi-ip",A=Un({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:Li,browser:navigator.userAgent,process_id:w("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:R||this.hasChangeBGPAddress,ap_response:s,extend:w("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:c,attributes:{userAttributes:Un(Un({enableEncodedTransform:(!!w("ENABLE_AUDIO_METADATA")||!!w("ENABLE_AUDIO_PTS"))&&E||!!w("ENABLE_AUDIO_TOPN")&&Tv(at.CHROME,87,116)||void 0,enableAudioMetadata:!!w("ENABLE_AUDIO_METADATA")&&E,enableAudioPts:!!w("ENABLE_AUDIO_PTS")&&E,topnSmoothLevel:w("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:w("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:w("TOPN_SWITCH_HOLD_MS"),topnAudioGain:w("TOPN_AUDIO_GAIN"),enableNetworkQualityProbe:this.store.networkQualityProbe,enablePublishedUserList:w("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:w("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:ii("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:ii("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:ii("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:w("USE_PUB_RTX")===!0||w("USE_SUB_RTX")===!0||void 0,disableFEC:w("DISABLE_FEC"),enableNTPReport:!!w("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:f,enableFulllinkAvSync:!!w("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:ii("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!w("FORCE_ENABLE_AUT_CC")||!x_()&&(!!w("ENABLE_AUT_FEEDBACK")||void 0),rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!w("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:ii("USE_XR","boolean"),enableLossbasedBwe:ii("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!w("FORCE_ENABLE_AUT_CC")||!x_()&&(!!w("ENABLE_AUT_CC")||void 0),enableCCFallback:ii("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:h,preSubNum:u?ii("PRE_SUB_NUM","number"):void 0,enablePubTWCC:ii("PUBLISH_TWCC","boolean"),enableSubTWCC:ii("SUBSCRIBE_TWCC","boolean"),enablePubRTX:ii("USE_PUB_RTX","boolean"),enableSubRTX:ii("USE_SUB_RTX","boolean"),enableSubSVC:w("ENABLE_SVC")?w("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(w("SVC"))&&w("SVC").length!==0?w("SVC"):void 0,enableSvcExtended:w("ENABLE_SVC")&&Array.isArray(w("SVC_EXTENDED"))&&w("SVC_EXTENDED").length!==0?w("SVC_EXTENDED"):void 0,enableVosFallback:w("ENABLE_VOS_FALLBACK"),enableQualityFallback:v},_),{},{audioDuplicate:ii("ENABLE_AUDIO_RED","boolean")?(o=ii("AUDIO_DUPLICATE_NUM","number"))!==null&&o!==void 0?o:2:void 0,senttsUsesAbsSendTime:!!I||void 0,enableDualStreamFlag:ii("ENABLE_DUAL_STREAM_FLAG","boolean")})},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(A.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(A.aes_mode=this.joinInfo.aesmode,w("ENCRYPT_AES")?(A.aes_secret=this.joinInfo.aespassword,A.aes_encrypt=!0):A.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(A.aes_salt=this.joinInfo.aessalt)),s.addresses[this.signal.websocket.currentURLIndex]&&(A.ap_response.ticket=s.addresses[this.signal.websocket.currentURLIndex].ticket,delete s.addresses),this.joinInfo.defaultVideoStream!==void 0&&(A.default_video_stream=this.joinInfo.defaultVideoStream),A}getRejoinMessage(){if(!this.joinInfo)throw new B(b.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(Ee.WS_RECONNECT_CREATE_CONNECTION,t=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(Ee.WS_RECONNECTING,t=>{this.joinInfo&&pe.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||zn.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",pe.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(Ee.WS_CLOSED,t=>{let n;switch(t){case Ze.LEAVE:n=zn.LEAVE;break;case Ze.UID_BANNED:case Ze.IP_BANNED:case Ze.CHANNEL_BANNED:case Ze.SERVER_ERROR:n=zn.SERVER_ERROR;break;case Ze.FALLBACK:n=zn.FALLBACK;break;case Ze.LICENSE_MISSING:case Ze.LICENSE_EXPIRED:case Ze.LICENSE_MINUTES_EXCEEDED:case Ze.LICENSE_PERIOD_INVALID:case Ze.LICENSE_MULTIPLE_SDK_SERVICE:case Ze.LICENSE_ILLEGAL:case Ze.TOKEN_EXPIRE:n=t;break;default:n=zn.NETWORK_ERROR}g.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+zn.NETWORK_ERROR)),this.joinInfo&&pe.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===Ze.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=t,t!==Ze.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(Ee.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){const t=w("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;t&&(t.level||t.delay)&&(g.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(t.level,", delay: ").concat(t.delay)),this.setClientRole(this.role,t))}if(pe.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void g.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));vt("EVENT_REPORT_DOMAIN",t[1]),vt("EVENT_REPORT_BACKUP_DOMAIN",t[1]),vt("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}}),this.signal.on(Pe.ON_UPLINK_STATS,t=>{this._statsCollector.updateUplinkStats(t)}),this.signal.on(Ee.REQUEST_RECOVER,(t,n,r)=>{if(!this.joinInfo)return r(new B(b.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,hn(this,nn.REQUEST_NEW_GATEWAY_LIST).then(n).catch(r)}),this.signal.on(Ee.REQUEST_JOIN_INFO,async(t,n,r)=>{var i,o,s;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));const c=Mt((i=this.joinInfo)===null||i===void 0?void 0:i.turnServer);if(w("NEW_TURN_MODE")&&c&&((o=this.joinInfo)===null||o===void 0?void 0:o.cloudProxyServer)==="disabled"){var l;let _=c.servers.map(v=>"turnServerURL"in v&&w("USE_TURN_IP")?Un(Un({},v),{},{turnServerURL:am(v.turnServerURL)}):v),E=(l=c.serversFromGateway)===null||l===void 0?void 0:l.map(v=>w("USE_TURN_IP")?Un(Un({},v),{},{turnServerURL:am(v.turnServerURL)}):v);const I=this.signal.currentURLIndex;_.length>0&&(_=[_[I%_.length]],c.servers=_),Array.isArray(E)&&E.length>0&&(E=[E[0]],c.serversFromGateway=E),g.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(I))}const{iceParameters:u,dtlsParameters:h,rtpCapabilities:f}=await hn(this,nn.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:c,cloudProxyServer:(s=this.joinInfo)===null||s===void 0?void 0:s.cloudProxyServer});try{t(this.getJoinMessage({ortc:{iceParameters:u,dtlsParameters:h,rtpCapabilities:f,version:"2"}}))}catch(_){n(_)}}),this.signal.on(Ee.REQUEST_REJOIN_INFO,t=>{t(this.getRejoinMessage())}),this.signal.on(Ee.REPORT_JOIN_GATEWAY,(t,n)=>{if(!this.joinInfo)return;let r,i="";var o;t instanceof B?(r=((o=t.data)===null||o===void 0?void 0:o.desc)||t.code,i=t.message):r=t,pe.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:r,errorMsg:i,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer||this.usingProxy,signalChannel:this.signal.__name__==="DataChannelSignal"?"1":"0",preload:this.joinInfo.preload})}),this.signal.on(Ee.IS_P2P_DISCONNECTED,t=>{t(Nc(this,nn.IS_P2P_DISCONNECTED))}),this.signal.on(Ee.DISCONNECT_P2P,()=>{this.emit(nn.DISCONNECT_P2P)}),this.signal.on(Ee.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(Ee.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(Ee.JOIN_RESPONSE,t=>{const n=this.getCurrentGatewayAddress();this.emit(nn.JOIN_RESPONSE,t,n)}),this.signal.on(Ee.PRE_CONNECT_PC,async(t,n)=>{if(this.joinInfo){var r,i;this.updateTurnConfigFromSignal();const s=this.getCurrentGatewayAddress(),c=Mt((r=this.joinInfo)===null||r===void 0?void 0:r.turnServer);if(w("NEW_TURN_MODE")&&c&&((i=this.joinInfo)===null||i===void 0?void 0:i.cloudProxyServer)==="disabled"){var o;let u=c.servers.map(_=>"turnServerURL"in _&&w("USE_TURN_IP")?Un(Un({},_),{},{turnServerURL:am(_.turnServerURL)}):_),h=(o=c.serversFromGateway)===null||o===void 0?void 0:o.map(_=>w("USE_TURN_IP")?Un(Un({},_),{},{turnServerURL:am(_.turnServerURL)}):_);const f=this.signal.currentURLIndex;u.length>0&&(u=[u[f%u.length]],c.servers=u),Array.isArray(h)&&h.length>0&&(h=[h[0]],c.serversFromGateway=h),g.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(f,",in pre pc"))}const l=w("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(s&&l){const u=B1(s);hn(this,nn.PRE_CONNECT_PC,{candidates:u,fingerprint:l,turnServer:c}).then(h=>{t==null||t(h)}).catch(n||(()=>{}))}}}),this.signal.on(Ee.RECOVER_NOTIFICATION,t=>{this.joinInfo&&typeof w("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(w("AP_REQUEST_DETAIL"),";").concat(t))}),this.signal.on(Ee.VOS_FALLBACK,t=>{this.emit(nn.VOS_FALLBACK,t)}),this.signal.on(Ee.DATACHANNEL_FAILBACK,t=>{g.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(nn.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(t,n){try{await this.signal.request(ge.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[n]},!0)}catch(r){throw g.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),r),r}}async tryUnsubDataChannelBeforeResub(t,n){try{await this.signal.request(ge.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(r){throw g.warning("unsubscribe datachannel warning",r),r}}async tryUnpubBeforeRepub(t,n){try{await this.signal.request(ge.UNPUBLISH,{stream_id:t,ortc:n},!0)}catch(r){throw g.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),r),r}}async tryUnpubDataChannelBeforeRepub(t,n){try{await this.signal.request(ge.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(r){throw g.warning("unpublish datastream warning: ",r),r}}async tryMassUnsubBeforeResub(t){const n={users:t.map(r=>({stream_id:r.stream_id,stream_type:r.stream_type}))};try{await this.signal.request(ge.UNSUBSCRIBE_STREAMS,n,!0)}catch(r){throw g.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),r),r}}async muteLocal(t,n){const r={action:t.find(i=>i.stream_type===Et.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:n};try{await this.signal.request(ge.CONTROL,r,!0,!0)}catch(i){throw g.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),i),i}}async unmuteLocal(t,n){const r={action:t.find(i=>i.stream_type===Et.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:n};try{await this.signal.request(ge.CONTROL,r,!0,!0)}catch(i){throw g.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),i),i}}async muteRemote(t,n){const r={action:t===ue.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(ge.CONTROL,r,!0,!0)}catch(i){throw g.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),i),i}}async unmuteRemote(t,n){const r={action:t===ue.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request(ge.CONTROL,r,!0,!0)}catch(i){throw g.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),i),i}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,n){this.signal.upload(t,n)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(ge.RESTART_ICE,n,!0)}catch(r){throw g.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),r),r}}reconnect(t,n){this.state==="CONNECTED"&&this.signal.reconnect(t||void 0,n||zn.P2P_FAILED)}getCurrentGatewayAddress(){var t,n;if(!w("GATEWAY_WSS_ADDRESS"))return w("USE_CANDIDATE_FROM_AP_DETAIL")&&(t=this.joinInfo)!==null&&t!==void 0&&t.apGatewayAddress?(g.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(n=this.joinInfo)!==null&&n!==void 0&&n.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(ge.SET_PARAMETER,{enablePublishAudioFilter:t})}downgradeCodec(t){this.signal.downgradeCodec(t)}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Ze.FALLBACK)),this.store.useDcSignal=!1,this.signal=new b1(Un(Un({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(nn.RESET_SIGNAL)}}let fm=0,FR=0;function jo(e,t,n,r){return new se((i,o)=>{t.timeout=t.timeout||w("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),fm+=hs(t.data)):n&&(t.data.size?fm+=t.data.size:t.data instanceof FormData?fm+=wP(t.data):fm+=hs(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,br.request(t).then(s=>{typeof s.data=="string"?FR+=hs(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?FR+=s.data.byteLength:FR+=hs(JSON.stringify(s.data)),r&&i({data:s.data,headers:s.headers}),i(s.data)}).catch(s=>{br.isCancel(s)?o(new B(b.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new B(b.NETWORK_TIMEOUT,s.message)):s.response?o(new B(b.NETWORK_RESPONSE_ERROR,s.response.status)):o(new B(b.NETWORK_ERROR,s.message))})})}/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var e;function t(Y){var ne=0;return function(){return ne<Y.length?{done:!1,value:Y[ne++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(Y,ne,he){return Y==Array.prototype||Y==Object.prototype||(Y[ne]=he.value),Y},r,i=function(Y){Y=[typeof globalThis=="object"&&globalThis,Y,typeof window=="object"&&window,typeof self=="object"&&self,typeof m=="object"&&m];for(var ne=0;ne<Y.length;++ne){var he=Y[ne];if(he&&he.Math==Math)return he}throw Error("Cannot find global object")}(this);function o(Y,ne){if(ne)e:{var he=i;Y=Y.split(".");for(var z=0;z<Y.length-1;z++){var T=Y[z];if(!(T in he))break e;he=he[T]}(ne=ne(z=he[Y=Y[Y.length-1]]))!=z&&ne!=null&&n(he,Y,{configurable:!0,writable:!0,value:ne})}}function s(Y){return(Y={next:Y})[Symbol.iterator]=function(){return this},Y}function c(Y){var ne=typeof Symbol<"u"&&Symbol.iterator&&Y[Symbol.iterator];return ne?ne.call(Y):{next:t(Y)}}if(o("Symbol",function(Y){function ne(T,D){this.A=T,n(this,"description",{configurable:!0,writable:!0,value:D})}if(Y)return Y;ne.prototype.toString=function(){return this.A};var he="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",z=0;return function T(D){if(this instanceof T)throw new TypeError("Symbol is not a constructor");return new ne(he+(D||"")+"_"+z++,D)}}),o("Symbol.iterator",function(Y){if(Y)return Y;Y=Symbol("Symbol.iterator");for(var ne="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),he=0;he<ne.length;he++){var z=i[ne[he]];typeof z=="function"&&typeof z.prototype[Y]!="function"&&n(z.prototype,Y,{configurable:!0,writable:!0,value:function(){return s(t(this))}})}return Y}),typeof Object.setPrototypeOf=="function")r=Object.setPrototypeOf;else{var l;e:{var u={};try{u.__proto__={a:!0},l=u.a;break e}catch{}l=!1}r=l?function(Y,ne){if(Y.__proto__=ne,Y.__proto__!==ne)throw new TypeError(Y+" is not extensible");return Y}:null}var h=r;function f(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function _(Y){if(Y.m)throw new TypeError("Generator is already running");Y.m=!0}function E(Y,ne){return Y.h=3,{value:ne}}function I(Y){this.g=new f,this.G=Y}function v(Y,ne,he,z){try{var T=ne.call(Y.g.j,he);if(!(T instanceof Object))throw new TypeError("Iterator result "+T+" is not an object");if(!T.done)return Y.g.m=!1,T;var D=T.value}catch(k){return Y.g.j=null,Y.g.s(k),R(Y)}return Y.g.j=null,z.call(Y.g,D),R(Y)}function R(Y){for(;Y.g.h;)try{var ne=Y.G(Y.g);if(ne)return Y.g.m=!1,{value:ne.value,done:!1}}catch(he){Y.g.v=void 0,Y.g.s(he)}if(Y.g.m=!1,Y.g.l){if(ne=Y.g.l,Y.g.l=null,ne.F)throw ne.D;return{value:ne.return,done:!0}}return{value:void 0,done:!0}}function A(Y){this.next=function(ne){return Y.o(ne)},this.throw=function(ne){return Y.s(ne)},this.return=function(ne){return function(he,z){_(he.g);var T=he.g.j;return T?v(he,"return"in T?T.return:function(D){return{value:D,done:!0}},z,he.g.return):(he.g.return(z),R(he))}(Y,ne)},this[Symbol.iterator]=function(){return this}}function O(Y,ne){return ne=new A(new I(ne)),h&&Y.prototype&&h(ne,Y.prototype),ne}if(f.prototype.o=function(Y){this.v=Y},f.prototype.s=function(Y){this.l={D:Y,F:!0},this.h=this.C||this.u},f.prototype.return=function(Y){this.l={return:Y},this.h=this.u},I.prototype.o=function(Y){return _(this.g),this.g.j?v(this,this.g.j.next,Y,this.g.o):(this.g.o(Y),R(this))},I.prototype.s=function(Y){return _(this.g),this.g.j?v(this,this.g.j.throw,Y,this.g.o):(this.g.s(Y),R(this))},o("Array.prototype.entries",function(Y){return Y||function(){return function(ne,he){ne instanceof String&&(ne+="");var z=0,T=!1,D={next:function(){if(!T&&z<ne.length){var k=z++;return{value:he(k,ne[k]),done:!1}}return T=!0,{done:!0,value:void 0}}};return D[Symbol.iterator]=function(){return D},D}(this,function(ne,he){return[ne,he]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var P=function(Y,ne){for(var he=0;he<Y.length;he++)ne(Y[he])},M=function(Y){return Y.replace(/\r?\n|\r/g,`\r
`)},U=function(Y,ne,he){return ne instanceof Blob?(he=he!==void 0?he+"":typeof ne.name=="string"?ne.name:"blob",ne.name===he&&Object.prototype.toString.call(ne)!=="[object Blob]"||(ne=new File([ne],he)),[String(Y),ne]):[String(Y),String(ne)]},L=function(Y,ne){if(Y.length<ne)throw new TypeError(ne+" argument required, but only "+Y.length+" present.")},V=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,H=V.FormData,q=V.XMLHttpRequest&&V.XMLHttpRequest.prototype.send,de=V.Request&&V.fetch,Ne=V.navigator&&V.navigator.sendBeacon,Ae=V.Element&&V.Element.prototype,Ge=V.Symbol&&Symbol.toStringTag;Ge&&(Blob.prototype[Ge]||(Blob.prototype[Ge]="Blob"),"File"in V&&!File.prototype[Ge]&&(File.prototype[Ge]="File"));try{new File([],"")}catch{V.File=function(ne,he,z){return ne=new Blob(ne,z||{}),Object.defineProperties(ne,{name:{value:he},lastModified:{value:+(z&&z.lastModified!==void 0?new Date(z.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Ge&&Object.defineProperty(ne,Ge,{value:"File"}),ne}}var xe=function(Y){return Y.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},ct=function(Y){this.i=[];var ne=this;Y&&P(Y.elements,function(he){if(he.name&&!he.disabled&&he.type!=="submit"&&he.type!=="button"&&!he.matches("form fieldset[disabled] *"))if(he.type==="file"){var z=he.files&&he.files.length?he.files:[new File([],"",{type:"application/octet-stream"})];P(z,function(T){ne.append(he.name,T)})}else he.type==="select-multiple"||he.type==="select-one"?P(he.options,function(T){!T.disabled&&T.selected&&ne.append(he.name,T.value)}):he.type==="checkbox"||he.type==="radio"?he.checked&&ne.append(he.name,he.value):(z=he.type==="textarea"?M(he.value):he.value,ne.append(he.name,z))})};if((e=ct.prototype).append=function(Y,ne,he){L(arguments,2),this.i.push(U(Y,ne,he))},e.delete=function(Y){L(arguments,1);var ne=[];Y=String(Y),P(this.i,function(he){he[0]!==Y&&ne.push(he)}),this.i=ne},e.entries=function Y(){var ne,he=this;return O(Y,function(z){if(z.h==1&&(ne=0),z.h!=3)return ne<he.i.length?z=E(z,he.i[ne]):(z.h=0,z=void 0),z;ne++,z.h=2})},e.forEach=function(Y,ne){L(arguments,1);for(var he=c(this),z=he.next();!z.done;z=he.next()){var T=c(z.value);z=T.next().value,T=T.next().value,Y.call(ne,T,z,this)}},e.get=function(Y){L(arguments,1);var ne=this.i;Y=String(Y);for(var he=0;he<ne.length;he++)if(ne[he][0]===Y)return ne[he][1];return null},e.getAll=function(Y){L(arguments,1);var ne=[];return Y=String(Y),P(this.i,function(he){he[0]===Y&&ne.push(he[1])}),ne},e.has=function(Y){L(arguments,1),Y=String(Y);for(var ne=0;ne<this.i.length;ne++)if(this.i[ne][0]===Y)return!0;return!1},e.keys=function Y(){var ne,he,z,T,D=this;return O(Y,function(k){if(k.h==1&&(ne=c(D),he=ne.next()),k.h!=3)return he.done?void(k.h=0):(z=he.value,T=c(z),E(k,T.next().value));he=ne.next(),k.h=2})},e.set=function(Y,ne,he){L(arguments,2),Y=String(Y);var z=[],T=U(Y,ne,he),D=!0;P(this.i,function(k){k[0]===Y?D&&(D=!z.push(T)):z.push(k)}),D&&z.push(T),this.i=z},e.values=function Y(){var ne,he,z,T,D=this;return O(Y,function(k){if(k.h==1&&(ne=c(D),he=ne.next()),k.h!=3)return he.done?void(k.h=0):(z=he.value,(T=c(z)).next(),E(k,T.next().value));he=ne.next(),k.h=2})},ct.prototype._asNative=function(){for(var Y=new H,ne=c(this),he=ne.next();!he.done;he=ne.next()){var z=c(he.value);he=z.next().value,z=z.next().value,Y.append(he,z)}return Y},ct.prototype._blob=function(){var Y="----formdata-polyfill-"+Math.random(),ne=[],he="--"+Y+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(z,T){return typeof z=="string"?ne.push(he+xe(M(T))+`"\r
\r
`+M(z)+`\r
`):ne.push(he+xe(M(T))+'"; filename="'+xe(z.name)+`"\r
Content-Type: `+(z.type||"application/octet-stream")+`\r
\r
`,z,`\r
`)}),ne.push("--"+Y+"--"),new Blob(ne,{type:"multipart/form-data; boundary="+Y})},ct.prototype[Symbol.iterator]=function(){return this.entries()},ct.prototype.toString=function(){return"[object FormData]"},Ae&&!Ae.matches&&(Ae.matches=Ae.matchesSelector||Ae.mozMatchesSelector||Ae.msMatchesSelector||Ae.oMatchesSelector||Ae.webkitMatchesSelector||function(Y){for(var ne=(Y=(this.document||this.ownerDocument).querySelectorAll(Y)).length;0<=--ne&&Y.item(ne)!==this;);return-1<ne}),Ge&&(ct.prototype[Ge]="FormData"),q){var jt=V.XMLHttpRequest.prototype.setRequestHeader;V.XMLHttpRequest.prototype.setRequestHeader=function(Y,ne){jt.call(this,Y,ne),Y.toLowerCase()==="content-type"&&(this.B=!0)},V.XMLHttpRequest.prototype.send=function(Y){Y instanceof ct?(Y=Y._blob(),this.B||this.setRequestHeader("Content-Type",Y.type),q.call(this,Y)):q.call(this,Y)}}de&&(V.fetch=function(Y,ne){return ne&&ne.body&&ne.body instanceof ct&&(ne.body=ne.body._blob()),de.call(this,Y,ne)}),Ne&&(V.navigator.sendBeacon=function(Y,ne){return ne instanceof ct&&(ne=ne._asNative()),Ne.call(this,Y,ne)}),V.FormData=ct}})();const Dh=()=>{const e=w("AREAS");return e.length===0&&e.push(dt.GLOBAL),Di(e).call(e,(t,n,r)=>{const i=Q1(n);return i?r===0?i:"".concat(t,",").concat(i):t},"")},Q1=e=>e===dt.OVERSEA?"".concat(er.ASIA,",").concat(er.EUROPE,",").concat(er.AFRICA,",").concat(er.NORTH_AMERICA,",").concat(er.SOUTH_AMERICA,",").concat(er.OCEANIA):er[e],RX=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map(n=>{const r=im[n],i=Object.keys(r);i&&i.map(o=>{o!=="CODE"&&(t[o]=t[o].concat(r[o]))})}),t},_m={GLOBAL:{ASIA:[dt.CHINA,dt.JAPAN,dt.INDIA,dt.KOREA,dt.HKMC],EUROPE:[],NORTH_AMERICA:[dt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},mm=Object.keys(_m[dt.GLOBAL]),BR=[dt.CHINA,dt.NORTH_AMERICA,dt.EUROPE,dt.ASIA,dt.JAPAN,dt.INDIA,dt.OCEANIA,dt.SOUTH_AMERICA,dt.AFRICA,dt.KOREA,dt.HKMC,dt.US],yX=function(e,t){let n=[];if(Z(e).call(e,dt.GLOBAL)){const o=[dt.GLOBAL,dt.OVERSEA],s=Object.keys(im);if(t===dt.GLOBAL)throw new B(b.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===dt.CHINA)n=[dt.OVERSEA];else if(i=t,Z(mm).call(mm,i)){const c=(r=t,_m[dt.GLOBAL][r]||[]),l=[...o,t,...c];n=s.filter(u=>!Z(l).call(l,u))}else if(function(c){let l=!1;return mm.forEach(u=>{var h;Z(h=_m[dt.GLOBAL][u]).call(h,c)&&(l=!0)}),l}(t)){const c=function(u){let h;return mm.forEach(f=>{var _;Z(_=_m[dt.GLOBAL][f]).call(_,u)&&(h=f)}),h}(t),l=[...o,c,t];n=s.filter(u=>!Z(l).call(l,u))}else n=e;n=function(c){const l=[];return BR.forEach(u=>{Z(c).call(c,u)&&l.push(u)}),l.concat(c.filter(u=>!Z(BR).call(BR,u)))}(n)}else n=e;var r,i;return n};function Z1(e){var t,n;if(!e&&Z(t=w("AREAS")).call(t,dt.EXTENSIONS))return g.debug("update area from ap : reset"),void jR(Pq,!0);if(!Z(n=w("AREAS")).call(n,dt.GLOBAL)||!e)return;let r=im.EXTENSIONS;r&&(r={CODE:Q1(dt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},g.debug("update area from ap success: ".concat(e,",config is "),r),vt("AREAS",[dt.EXTENSIONS],!0),Object.keys(r).map(i=>{i==="LOG_UPLOAD_SERVER"||i==="EVENT_REPORT_DOMAIN"||i==="EVENT_REPORT_BACKUP_DOMAIN"||i==="PROXY_SERVER_TYPE3"?vt(i,r[i][0]):vt(i,r[i])}))}function jR(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=pe.reportApiInvoke(null,{name:Ft.SET_AREA,options:e,tag:It.TRACER});try{let r=[];if(typeof e=="string"&&(r=[e]),Array.isArray(e)&&(e.forEach(o=>{if(!Z(v1).call(v1,o))throw new B(b.INVALID_PARAMS,"invalid area code")}),r=e),Object.prototype.toString.call(e)==="[object Object]"){const{areaCode:o,excludedArea:s}=e;if(!o)throw new B(b.INVALID_PARAMS,"area code is needed");let c=o;typeof o=="string"&&(c=[o]),r=s?yX(c,s):c}if(!t){if(fi.AREAS){const o=new B(b.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(o),void g.warning("setArea is prohibited because of config-distribute")}if(Z(r).call(r,dt.GLOBAL)&&w("AREAS")===dt.EXTENSIONS){const o=new B(b.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(o),void g.warning("setArea is prohibited because of ap extensions")}}vt("AREAS",r,t);const i=RX(r);Object.keys(i).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?vt(o,i[o][0]):vt(o,i[o])}),g.debug("set area success:",r.join(","))}catch(r){throw n.onError(r),r}n.onSuccess()}function $1(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Ss(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?$1(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$1(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}let GR=1;function CX(e,t,n,r,i){GR+=1;const o={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:GR,requestId:GR,version:Li,cname:n.cname},s={service_name:t,json_body:JSON.stringify(o)};let c,l,u=e[0];return Mo(async()=>{c=Date.now();const h=await jo(u,{data:s,cancelToken:r,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(l=Date.now()-c,h.code!==0){const E=new B(b.UNEXPECTED_RESPONSE,"live streaming ap error, code"+h.code,{retry:!0,responseTime:l});throw g.error(E.toString()),E}const f=JSON.parse(h.json_body);if(f.code!==200){const E=new B(b.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(f.code,", reason: ").concat(f.reason),{code:f.code,responseTime:l});throw g.error(E.toString()),E}if(!f.servers||f.servers.length===0){const E=new B(b.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:f.code,responseTime:l});throw g.error(E.toString()),E}const _=function(E,I){return{addressList:E.servers.map(v=>"wss://".concat(v.address.replace(/\./g,"-"),".").concat(w("WORKER_DOMAIN"),":").concat(v.wss,"?serviceName=").concat(encodeURIComponent(I))),workerToken:E.workerToken,vid:E.vid}}(f,t);return w("LIVE_STREAMING_ADDRESS")&&(_.addressList=w("LIVE_STREAMING_ADDRESS")instanceof Array?w("LIVE_STREAMING_ADDRESS"):[w("LIVE_STREAMING_ADDRESS")]),Ss(Ss({},_),{},{responseTime:l})},(h,f)=>(pe.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(h.addressList),firstSuccess:f===0,responseTime:l,serverIp:e[f%e.length]}),!1),(h,f)=>(pe.apworkerEvent(n.sid,{success:!1,sc:h.data&&h.data.code||200,serviceName:t,responseTime:l,serverIp:e[f%e.length]}),!!(h.code!==b.OPERATION_ABORTED&&h.code!==b.UNEXPECTED_RESPONSE||h.data&&h.data.retry)&&(u=e[(f+1)%e.length],!0)),i)}let WR=1;function eM(e,t,n,r){let{url:i,areaCode:o}=e;const{clientId:s,sid:c}=t,l=Date.now();let u;const h=t.role,[f,_]=KR(t,o,[cn.CHOOSE_SERVER]);let E=qt.networkState;return Mo(async()=>{E&&qt.networkState===Er.OFFLINE&&qt.onlineWaiter&&await se.race([qt.onlineWaiter,In(r&&r.maxRetryTimeout||an.maxRetryTimeout)]),E=qt.networkState;const{data:I,headers:v}=await jo(i,{data:f,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);u=v.http3==="1"?1:-1,pe.reportResourceTiming(i,c),nM(I,i,t,l,[cn.CHOOSE_SERVER],u);const R=Ih(I,cn.CHOOSE_SERVER);return HR(R),NR(R,i)},I=>(I&&pe.joinChooseServer(c,{role:h,lts:l,succ:!0,csAddr:i,opid:_,serverList:I.gatewayAddrs.map(v=>v.address),ec:null,cid:I.cid.toString(),uid:I.uid.toString(),csIp:I.csIp,unilbsServerIds:[cn.CHOOSE_SERVER].toString(),isHttp3:u,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:I.res.detail&&I.res.detail[38],vid:I.vid}),!1),I=>I.code!==b.OPERATION_ABORTED&&(I.code===b.CAN_NOT_GET_GATEWAY_SERVER?I.data.retry:(pe.joinChooseServer(c,{role:h,lts:l,succ:!1,csAddr:i,serverList:null,opid:_,ec:I.code,csIp:I.data&&I.data.csIp,unilbsServerIds:[cn.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:E}),isHttp3:u,corssRegionTagReq:t.apRequestDetail}),g.warning("[".concat(s||"sid-".concat(c.slice(0,6)),"] Choose server network error, retry"),I),!0)),r)}function tM(e,t,n,r){let i,{url:o,areaCode:s,serviceIds:c}=e;const l=Date.now(),u=t.role,[h,f]=KR(t,s,c);let _;return Mo(async()=>{_&&qt.networkState===Er.OFFLINE&&qt.onlineWaiter&&await se.race([qt.onlineWaiter,In(r&&r.maxRetryTimeout||an.maxRetryTimeout)]),_=qt.networkState;const{data:E,headers:I}=await jo(o,{data:h,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);i=I.http3==="1"?1:-1,pe.reportResourceTiming(o,t.sid),nM(E,o,t,l,c,i);const v=Ih(E,cn.CHOOSE_SERVER),R=Ih(E,t.cloudProxyServer==="proxy5"?cn.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?cn.CLOUD_PROXY:cn.CLOUD_PROXY_FALLBACK),A=performance.getEntriesByName(o),O=A[A.length-1];let P;return O&&(P={name:O.name,protocol:"nextHopProtocol"in O?O.nextHopProtocol:"",dnscost:"domainLookupEnd"in O&&"domainLookupStart"in O&&typeof O.domainLookupEnd=="number"&&typeof O.domainLookupStart=="number"?O.domainLookupEnd-O.domainLookupStart:-1,tcpTlsCost:"connectEnd"in O&&"connectStart"in O&&typeof O.connectEnd=="number"&&typeof O.connectStart=="number"?O.connectEnd-O.connectStart:-1,reqCost:"requestStart"in O&&typeof O.requestStart=="number"&&"responseEnd"in O&&typeof O.responseEnd=="number"?O.responseEnd-O.requestStart:-1,handleCost:"leave_ts"in E&&"enter_ts"in E&&typeof E.leave_ts=="number"&&typeof E.enter_ts=="number"?E.leave_ts-E.enter_ts:-1}),HR(v),{gatewayInfo:NR(v,o),proxyInfo:R,url:o,resourceTimingInfo:P}},E=>{var I;return E.gatewayInfo&&pe.joinChooseServer(t.sid,{role:u,lts:l,succ:!0,csAddr:o,serverList:E.gatewayInfo.gatewayAddrs.map(v=>v.address),ec:null,opid:f,cid:E.gatewayInfo.cid.toString(),uid:E.gatewayInfo.uid.toString(),csIp:E.gatewayInfo.csIp,unilbsServerIds:c.toString(),isHttp3:i,corssRegionTagReq:t.apRequestDetail,corssRegionTagRes:E.gatewayInfo.res.detail&&E.gatewayInfo.res.detail[38],vid:(I=E.gatewayInfo)===null||I===void 0?void 0:I.vid,resourceTimingInfo:E.resourceTimingInfo?JSON.stringify(E.resourceTimingInfo):void 0}),E.proxyInfo&&pe.joinWebProxyAP(t.sid,{lts:l,sucess:1,apServerAddr:o,turnServerAddrList:E.proxyInfo.addresses.map(v=>v.ip).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:c.toString()}),!1},E=>E.code!==b.OPERATION_ABORTED&&(E.code===b.CAN_NOT_GET_GATEWAY_SERVER?E.data.retry:(pe.joinWebProxyAP(t.sid,{lts:l,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:E.code,eventType:t.cloudProxyServer,unilbsServerIds:c.toString(),extend:JSON.stringify({networkState:_})}),g.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),E),!0)),r)}const nM=(e,t,n,r,i,o)=>{const{sid:s,clientId:c,cloudProxyServer:l}=n,u=[],h=f=>{f.flag===4096?pe.joinChooseServer(s,{role:n.role,lts:r,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:f.error.message,csIp:f.error.data&&f.error.data.csIp,unilbsServerIds:i.toString(),isHttp3:o,corssRegionTagReq:n.apRequestDetail}):f.flag!==1048576&&f.flag!==4194304&&f.flag!==4194310||pe.joinWebProxyAP(s,{lts:r,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:f.error.code,eventType:l,unilbsServerIds:i.toString()})};if(e.response_body.forEach(f=>{const _=f.buffer.code;if(f.uri===23&&_===0&&!f.buffer.edges_services)if(f.buffer.flag===4194310)g.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),f.buffer.edges_services=[];else{const E={error:new B(b.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:w("NO_EDGES_RETRY"),csIp:e.detail[502]}),flag:f.buffer.flag};u.push(E),h(E)}if(_!==0){const E=wl(_),I={error:new B(b.CAN_NOT_GET_GATEWAY_SERVER,E.desc,{desc:E.desc,retry:E.retry,csIp:e.detail[502]}),flag:f.buffer.flag};f.buffer.flag===4194310?g.warning(I.error.toString()):u.push(I),h(I)}}),u.length)throw g.warning("[".concat(c||"sid-".concat(s.slice(0,6)),"] multi unilbs ").concat(t," failed, ").concat(u.map(f=>"flag: ".concat(f.flag,", message: ").concat(f.error.message,", retry: ").concat(f.error.data.retry)).join(" | "))),new B(b.CAN_NOT_GET_GATEWAY_SERVER,u.map(f=>"flag: ".concat(f.flag,", message: ").concat(f.error.message)).join(" | "),{retry:!!u.find(f=>f.error.data.retry),csIp:e.detail[502],desc:[...new Set(u.map(f=>{var _;return f==null||(_=f.error)===null||_===void 0||(_=_.data)===null||_===void 0?void 0:_.desc}).filter(f=>!!f))]})},HR=e=>{var t,n,r,i;if(e.addresses&&e.addresses.length===0&&e.code===0)throw new B(b.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(w("AP_AREA")&&((r=e.detail)!==null&&r!==void 0&&r[23]&&typeof((i=e.detail)===null||i===void 0?void 0:i[23])=="string"?Z1(e.detail[23].toLowerCase()):Z1()),(t=e.detail)!==null&&t!==void 0&&t[19]&&typeof((n=e.detail)===null||n===void 0?void 0:n[19])=="string"){const s=e.detail[19],c=s==null?void 0:s.split(";");for(let l=0;l<c.length;l++){var o;const u=_r(o=c[l]).call(o);e.addresses[l]&&c&&(e.addresses[l].fingerprint=u)}}if(w("GATEWAY_ADDRESS")&&w("GATEWAY_ADDRESS").length>0){g.debug("assign gateway address to",w("GATEWAY_ADDRESS"));const s=w("GATEWAY_ADDRESS").map(c=>{var l,u;const h=(l=(u=e.addresses.find(f=>f.ip===c.ip&&f.port===c.port))===null||u===void 0?void 0:u.fingerprint)!==null&&l!==void 0?l:"";return{ip:c.ip,port:c.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:c.fingerprint||h}});e.addresses=s}},IX=(e,t)=>{if(e.response_body&&e.response_body.length){const n=e.response_body[0];if(n.buffer.code!==0){const r=wl(n.buffer.code);throw new B(b.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(r.desc),{retry:r.retry})}return n.buffer.ticket}throw g.debug("update ticket request received ap response without response body:",t),new B(b.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},KR=(e,t,n)=>{const r=Math.floor(Math.random()*1e12),i=e.role==="host"?"1":e.role==="audience"?"2":void 0,o={appid:e.appId,client_ts:Date.now(),opid:r,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:Ss(Ss(Ss({6:e.stringUid,11:t,12:w("USE_NEW_TOKEN")?"1":void 0},i?{17:i}:{}),{},{22:t},e.apRequestDetail?{33:e.apRequestDetail}:{}),e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:n,uid:e.uid||0}}]};o.request_bodies.forEach(c=>{e.multiIP&&e.multiIP.gateway_ip&&(c.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))});const s=new FormData;return s.append("request",JSON.stringify(o)),[s,r]},wX=(e,t)=>{const n=Math.floor(Math.random()*1e12),r={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},i=new FormData;return i.append("request",JSON.stringify(r)),[i,n]};let Ol=0;function Nl(e){return se.all(e.map(t=>t.then(n=>{throw n},n=>n))).then(t=>{throw t},t=>t)}const Ph=async e=>{let{fragementLength:t,referenceList:n,asyncMapHandler:r,allFailedhandler:i,promisesCollector:o}=e,s=0;const c=t;let l,u=0;const h=async()=>{const f=(()=>{const _=s*c,E=_+c;return n.slice(_,E).map(r)})();o&&o.push(...f);try{l=await Nl(f)}catch(_){if(u+=c,s++,!(u>=n.length))return void await h();i(_)}f.forEach(_=>_.cancel())};return await h(),l},rM=async e=>{let{referenceList:t,asyncMapHandler:n,closeFn:r}=e;const i=t.length;let o=0;const s=async()=>{const c=n(t.shift());try{return await c}catch(l){if(o++,o>=i||r!=null&&r(l))throw l;return s()}};return s()};async function AX(){if(typeof VideoDecoder>"u")return!0;let e;const t=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,85,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,149,160,133,4,144,43,122,168,159,120,159,205,39,82,131,57,52,87,187,68,23,248,134,204,226,97,17,49,183,55,236,219,249,221,98,208,215,190,59,179,167,213,47,1,246,150,14,194,245,159,83,35,64,103,218,38,21,82,3,135,21,185,84,248,134],n=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,148,62,134,140,92,172,141,77,35,94,181,164,65,169,65,156,154,43,221,162,11,252,67,102,113,48,136,137,219,62,43,113,239,23,126,250,186,252,10,138,218,25,193,244,74,68,194,209,107,23,52,206,199,78,72,98,103,151,71,96,62,51,210,158,72,231,158],r=[18,0,10,13,0,0,0,3,180,253,144,6,136,8,8,8,32,50,87,16,66,128,2,8,32,132,0,8,0,180,90,204,169,166,242,109,241,190,143,143,233,163,51,196,98,95,151,224,22,134,33,240,150,248,67,18,34,196,142,81,238,173,140,80,205,232,132,144,67,12,131,157,4,171,243,86,122,35,6,166,184,243,85,126,13,206,103,152,62,168,160,187,2,241,138,52,211,72,121,128,151,63,147,128,19,42],i=[18,0,50,138,1,48,192,64,253,248,65,17,67,192,32,0,16,0,0,0,0,0,0,0,195,12,48,144,64,32,0,209,75,61,9,204,25,115,79,226,115,63,63,208,70,210,220,153,126,241,237,37,107,195,153,1,99,112,230,189,209,169,130,10,11,22,167,215,159,205,197,7,183,162,26,48,254,141,134,103,32,16,235,45,1,15,18,119,169,110,206,251,51,115,202,60,148,1,46,39,109,25,28,86,168,15,77,211,239,2,58,43,146,26,230,184,81,48,140,226,226,250,222,146,171,133,164,13,188,180,64,122,142,146,32,208,238,170,193,35,53,44,225],o=[18,0,50,107,48,0,133,125,248,65,26,195,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,204,24,122,65,56,165,18,52,206,218,4,187,51,97,9,29,191,90,253,106,185,31,197,155,52,205,245,185,203,131,20,226,25,124,95,113,220,113,141,15,15,104,211,144,152,237,150,157,127,51,143,24,231,218,171,255,176,241,128,229,149,150,148,66,245,228,91,27,182,228,136,61,182,237,133,45,220,24,103,214,152],s=[18,0,50,122,48,1,9,253,248,65,26,67,64,62,32,31,16,0,0,0,0,0,1,4,16,64,144,64,32,0,198,182,231,242,220,235,163,140,12,36,36,166,46,132,210,4,71,23,218,132,27,30,17,45,244,79,31,243,195,136,100,169,76,88,142,85,204,217,121,168,29,163,198,17,251,223,73,12,212,244,139,123,151,179,75,216,96,208,136,40,229,42,59,149,10,116,228,85,99,93,221,108,255,140,248,20,30,167,122,109,206,164,108,197,110,251,23,243,133,160,63,13,207,177,12,128];return await new se((l,u)=>{let h;(async function(){e&&e.state!=="closed"||await async function(){e=new VideoDecoder({output:_=>{_.close(),clearTimeout(h),l(!0)},error:_=>{clearTimeout(h),l(!1)}}),await e.configure({codec:"av01.0.05M.08",width:160,height:90})}();const f=[t,n,r,i,o,s];for(let _=0;_<f.length;_++){const E=new EncodedVideoChunk({type:_==0?"key":"delta",timestamp:33333*_,duration:33333,data:new Uint8Array(f[_])});try{await e.decode(E)}catch{return void l(!1)}}})(),h=setTimeout(()=>{l(!1)},5e3)})}async function Em(e,t,n,r){return{gatewayInfo:await async function(o,s,c,l){let u=null;const h=[],f=async()=>{const E=w("WEBCS_DOMAIN").slice(0,w("AJAX_REQUEST_CONCURRENT")).map(R=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(R+"/api/v2/transpond/webrtc?v=2"):"https://".concat(R,"/api/v2/transpond/webrtc?v=2"),areaCode:Dh()})),I=l.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:E.map(R=>R.url)}),v=await Ph({fragementLength:w("FRAGEMENT_LENGTH"),referenceList:E,asyncMapHandler:R=>(g.debug("[".concat(o.clientId,"] Connect to choose_server:"),R.url),eM(R,o,s,c)),allFailedhandler:R=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},I),R[0]},promisesCollector:h});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},I),v},_=async()=>{if(await In(1e3),u!==null)return u;const E=w("WEBCS_DOMAIN_BACKUP_LIST").map(R=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(R+"/api/v2/transpond/webrtc?v=2"):"https://".concat(R,"/api/v2/transpond/webrtc?v=2"),areaCode:Dh()})),I=l.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:E.map(R=>R.url)}),v=await Ph({fragementLength:w("FRAGEMENT_LENGTH"),referenceList:E,asyncMapHandler:R=>(g.debug("[".concat(o.clientId,"] Connect to backup choose_server:"),R.url),eM(R,o,s,c)),allFailedhandler:R=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},I),R[0]},promisesCollector:h});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},I),v};try{return u=await Nl([f(),_()]),h.length&&h.forEach(E=>E.cancel&&typeof E.cancel=="function"&&E.cancel()),u}catch(E){throw E[0]}}(e,t,n,r)}}async function iM(e,t,n,r,i){const o=e.cloudProxyServer;if(o==="disabled"){if(e.useLocalAccessPoint)return await Em(e,t,n,i);if(w("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:_,proxyInfo:E}=await aM(e,t,n,i);if(e.turnServer&&e.turnServer.mode!=="auto")return{gatewayInfo:_};const I=E.map(v=>({turnServerURL:v.address,tcpport:v.tcpport||qn.tcpport,udpport:v.udpport||qn.udpport,username:v.username||qn.username,password:v.password||qn.password,forceturn:!1,security:!0}));if(i.useP2P){var s;const v=(s=e.uid)!==null&&s!==void 0?s:_.uid,R="glb:".concat(v.toString()),A=await Av(R),O=E.map(P=>({turnServerURL:P.address,tcpport:P.tcpport||qn.tcpport,udpport:P.udpport||qn.udpport,username:R,password:A,forceturn:!1,security:!0}));I.push(...O)}return e.turnServer={mode:"manual",servers:I},{gatewayInfo:_}}return await Em(e,t,n,i)}const{proxyInfo:c,gatewayInfo:l}=await aM(e,t,n,i),u={gatewayInfo:l},h=c.map(_=>({turnServerURL:_.address,tcpport:o==="proxy3"?void 0:_.tcpport?_.tcpport:qn.tcpport,udpport:o==="proxy4"?void 0:_.udpport?_.udpport:qn.udpport,username:_.username||qn.username,password:_.password||qn.password,forceturn:o!=="proxy4",security:o==="proxy5"}));if(i.useP2P){var f;const _=(f=e.uid)!==null&&f!==void 0?f:l.uid,E="glb:".concat(_.toString()),I=await Av(E),v=c.map(R=>({turnServerURL:R.address,tcpport:o==="proxy3"?void 0:R.tcpport||qn.tcpport,udpport:o==="proxy4"?void 0:R.udpport||qn.udpport,username:E,password:I,forceturn:o!=="proxy4",security:o==="proxy5"}));h.push(...v)}return e.turnServer={mode:"manual",servers:h},g.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(o)),u}async function oM(e,t,n,r,i){const o=w("ACCOUNT_REGISTER").slice(0,w("AJAX_REQUEST_CONCURRENT"));let s=[];s=t.proxyServer?o.map(l=>"https://".concat(t.proxyServer,"/ap/?url=").concat(l+"/api/v1")):o.map(l=>"https://".concat(l,"/api/v1"));const c=i==null?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{const l=await async function(u,h,f,_,E){const I=Date.now(),v={sid:f.sid,opid:10,appid:f.appId,string_uid:h};let R=u[0];const A=await Mo(()=>jo(R+"".concat(R.indexOf("?")===-1?"?":"&","action=stringuid"),{data:v,cancelToken:_,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(O,P)=>{if(O.code===0){if(O.uid<=0||O.uid>=Math.pow(2,32))throw g.error("Invalid Uint Uid ".concat(h," => ").concat(O.uid),O),pe.reqUserAccount(v.sid,{lts:I,success:!1,serverAddr:R,stringUid:v.string_uid,uid:O.uid,errorCode:b.INVALID_UINT_UID_FROM_STRING_UID,extend:v}),new B(b.INVALID_UINT_UID_FROM_STRING_UID);return pe.reqUserAccount(v.sid,{lts:I,success:!0,serverAddr:R,stringUid:v.string_uid,uid:O.uid,errorCode:null,extend:v}),!1}const M=wl(O.code);return M.retry&&(R=u[(P+1)%u.length]),pe.reqUserAccount(v.sid,{lts:I,success:!1,serverAddr:R,stringUid:v.string_uid,uid:O.uid,errorCode:M.desc,extend:v}),M.retry},(O,P)=>O.code!==b.OPERATION_ABORTED&&(pe.reqUserAccount(v.sid,{lts:I,success:!1,serverAddr:R,stringUid:v.string_uid,uid:null,errorCode:O.code,extend:v}),R=u[(P+1)%u.length],!0),E);if(A.code!==0){const O=wl(A.code);throw new B(b.UNEXPECTED_RESPONSE,O.desc)}return A}(s,e,t,n,r);return i==null||i.recordJoinChannelService({status:"success",endTs:Date.now()},c),l.uid}catch(l){throw i==null||i.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[l]},c),l}}async function bX(e,t,n){const r=w("ACCOUNT_REGISTER");let i=[];i=t.proxyServer?r.map(o=>"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1")):r.map(o=>"https://".concat(o,"/api/v1"));try{return await rM({referenceList:i,asyncMapHandler:s=>async function(c,l,u,h){const f=Date.now(),_={sid:u.sid,opid:10,appid:u.appId,string_uid:l};try{const E=await jo(c+"".concat(c.indexOf("?")===-1?"?":"&","action=stringuid"),{data:_,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(E.code!==0){const I=wl(E.code);throw new B(b.UNEXPECTED_RESPONSE,"preload sua error:".concat(I.desc),I)}if(E.uid<=0||E.uid>=Math.pow(2,32))throw new B(b.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:f,url:c,req:_,uid:E.uid,elapse:Date.now()-f}}catch(E){throw E}}(s,e,t,n),closeFn:s=>s.code===b.OPERATION_ABORTED||s.code===b.UNEXPECTED_RESPONSE&&!s.data.retry})}catch(o){throw o}}async function OX(e,t,n){const r=w("CDS_AP").slice(0,w("AJAX_REQUEST_CONCURRENT")).map(l=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(l+"/api/v1"):"https://".concat(l,"/api/v1?action=config")),i=r.map(l=>function(u,h,f,_){const E=ot(),I={flag:64,cipher_method:0,features:Ss(Ss(Ss(Ss(Ss({install_id:Bv(),device:E.name,system:E.os,system_general:navigator.userAgent,vendor:h.appId,version:Li,cname:h.cname,session_id:h.sid,proxyServer:h.proxyServer,sdk_type:SX.WEB_RTC,browser_name:E.name,browser_version:E.version,user_agent:navigator.userAgent,channel_name:h.cname},h.stringUid&&{string_uid:h.stringUid}),h.uid&&{uid:h.uid+""}),E.os&&{os_name:E.os}),E.osVersion&&{os_version:E.osVersion}),{},{detail:""})};return Mo(()=>jo(u,{data:I,timeout:1e3,cancelToken:f,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,v=>v.code!==b.OPERATION_ABORTED,_)}(l,e,t,n));let o=null,s=null,c={};try{o=await Nl(i)}catch(l){if(l.code===b.OPERATION_ABORTED)throw l;s=l}if(i.forEach(l=>l.cancel()),pe.reportApiInvoke(e.sid,{name:Ft.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:o}}).onSuccess(),o&&o.test_tags)try{c=function(l){if(!l.test_tags)return{};const u=l.test_tags,h=Object.keys(u),f={};return h.forEach(_=>{var E;const I=_r(E=_.slice(4)).call(E),v=JSON.parse(u[_]),R=v[1];f[I]={tag:v[0]||"",value:R}}),f}(o)}catch{}return c}async function sM(e,t){const n=w("WEBCS_DOMAIN").concat(w("WEBCS_DOMAIN_BACKUP_LIST")).map(r=>({url:"https://".concat(r,"/api/v2/transpond/webrtc?v=2"),areaCode:Dh(),serviceIds:[cn.CHOOSE_SERVER,cn.CLOUD_PROXY_FALLBACK]}));try{return await rM({referenceList:n,asyncMapHandler:i=>async function(o,s,c){let l,{url:u,areaCode:h,serviceIds:f}=o;const _=Date.now(),[E,I]=KR(s,h,f);let v=qt.networkState;try{v&&qt.networkState===Er.OFFLINE&&qt.onlineWaiter&&await se.race([qt.onlineWaiter,In(an.maxRetryTimeout)]),v=qt.networkState;const{data:R,headers:A}=await jo(u,{data:E,cancelToken:c,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);l=A.http3==="1"?1:-1,(U=>{const L=[];if(U.response_body.forEach(V=>{const H=V.buffer.code;if(V.uri===23&&H===0&&!V.buffer.edges_services)if(V.buffer.flag===4194310)V.buffer.edges_services=[];else{const q={error:new B(b.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:w("NO_EDGES_RETRY"),csIp:U.detail[502]}),flag:V.buffer.flag};L.push(q)}if(H!==0){const q=wl(H),de={error:new B(b.CAN_NOT_GET_GATEWAY_SERVER,q.desc,{desc:q.desc,retry:q.retry,csIp:U.detail[502]}),flag:V.buffer.flag};V.buffer.flag===4194310?g.warning(de.error.toString()):L.push(de)}}),L.length)throw new B(b.CAN_NOT_GET_GATEWAY_SERVER,L.map(V=>"flag: ".concat(V.flag,", message: ").concat(V.error.message)).join(" | "),{retry:!!L.find(V=>V.error.data.retry),csIp:U.detail[502],desc:[...new Set(L.map(V=>{var H;return V==null||(H=V.error)===null||H===void 0||(H=H.data)===null||H===void 0?void 0:H.desc}).filter(V=>!!V))]})})(R);const P=Ih(R,cn.CHOOSE_SERVER),M=Ih(R,cn.CLOUD_PROXY_FALLBACK);return HR(P),{gatewayInfo:NR(P,u),proxyInfo:M,opid:I,requestTime:_,url:u,isHttp3:l,elapse:Date.now()-_}}catch(R){throw R}}(i,e,t),closeFn:i=>i.code===b.OPERATION_ABORTED||i.code===b.CAN_NOT_GET_GATEWAY_SERVER&&!i.data.retry})}catch(r){throw r}}async function aM(e,t,n,r){const i=w("PROXY_SERVER_TYPE3"),o=(E,I,v)=>{let R=v||i;return Array.isArray(R)&&(R=I%2==0&&i[1]||i[0]),"https://".concat(R,"/ap/?url=").concat(E)};let s=null;const c=[],l=async()=>{const E=w("WEBCS_DOMAIN").slice(0,w("AJAX_REQUEST_CONCURRENT")).map((R,A)=>{let O;return O=e.cloudProxyServer==="disabled"&&e.proxyServer?o("".concat(R,"/api/v2/transpond/webrtc?v=2"),A,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(R,"/api/v2/transpond/webrtc?v=2"):o("".concat(R,"/api/v2/transpond/webrtc?v=2"),A),{url:O,areaCode:Dh(),serviceIds:[cn.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?cn.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?cn.CLOUD_PROXY:cn.CLOUD_PROXY_FALLBACK]}}),I=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:E.map(R=>R.url)}),v=await Ph({fragementLength:w("FRAGEMENT_LENGTH"),referenceList:E,asyncMapHandler:R=>(g.debug("[".concat(e.clientId,"] Connect to choose_server:"),R.url),tM(R,e,t,n)),allFailedhandler:R=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},I),R[0]},promisesCollector:c});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},I),v},u=async()=>{if(await In(1e3),s!==null)return s;const E=w("WEBCS_DOMAIN_BACKUP_LIST").map((R,A)=>{let O;return O=e.cloudProxyServer==="disabled"&&e.proxyServer?o("".concat(R,"/api/v2/transpond/webrtc?v=2"),A,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(R,"/api/v2/transpond/webrtc?v=2"):o("".concat(R,"/api/v2/transpond/webrtc?v=2"),A),{url:O,areaCode:Dh(),serviceIds:[cn.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?cn.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?cn.CLOUD_PROXY:cn.CLOUD_PROXY_FALLBACK]}}),I=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:E.map(R=>R.url)}),v=await Ph({fragementLength:w("FRAGEMENT_LENGTH"),referenceList:E,asyncMapHandler:R=>(g.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),R.url),tM(R,e,t,n)),allFailedhandler:R=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},I),R[0]},promisesCollector:c});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},I),v};let h,f,_;try{({gatewayInfo:h,proxyInfo:f,url:_}=await Nl([l(),u()]))}catch(E){throw E[0]}if(c.length&&c.forEach(E=>E.cancel&&typeof E.cancel=="function"&&E.cancel()),!h||!f)throw new B(b.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=_,e.cloudProxyServer!=="disabled"&&Array.isArray(i)&&_){const E=/^https?:\/\/(.+?)(\/.*)?$/.exec(_)[1];Z(i).call(i,E)&&(e.proxyServer=E,g.setProxyServer(E),pe.setProxyServer(E))}return s={gatewayInfo:h,proxyInfo:await D1(f,h.uid)},s}async function NX(e,t,n){const r=w("UAP_AP").slice(0,w("AJAX_REQUEST_CONCURRENT")).map(o=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap")),i=r.map(o=>function(s,c,l,u){const h={command:"convergeAllocateEdge",sid:c.sid,appId:c.appId,token:c.token,ts:Date.now(),version:Li,cname:c.cname,uid:c.uid.toString(),requestId:WR,seq:WR};WR+=1;const f={service_name:"tele_channel",json_body:JSON.stringify(h)};return Mo(async()=>{const _=await jo(s,{data:f,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(_.code!==0){const I=new B(b.UNEXPECTED_RESPONSE,"cross channel ap error, code"+_.code,{retry:!0});throw g.error(I.toString()),I}const E=JSON.parse(_.json_body);if(E.code!==200){const I=new B(b.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(E.code,", reason: ").concat(E.reason));throw g.error(I.toString()),I}if(!E.servers||E.servers.length===0){const I=new B(b.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw g.error(I.toString()),I}return{vid:E.vid,workerToken:E.workerToken,addressList:(w("CHANNEL_MEDIA_RELAY_SERVERS")||E.servers).map(I=>"wss://".concat(I.address.replace(/\./g,"-"),".").concat(w("WORKER_DOMAIN"),":").concat(I.wss))}},void 0,_=>!!(_.code!==b.OPERATION_ABORTED&&_.code!==b.UNEXPECTED_RESPONSE||_.data&&_.data.retry),u)}(o,e,t,n));try{const o=await Nl(i);return i.forEach(s=>s.cancel()),o}catch(o){throw o[0]}}async function DX(e,t,n){let r=null;const i=[],o=async s=>{const c=w(s?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(l=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(l+"/api/v2/transpond/webrtc?v=2"):"https://".concat(l,"/api/v2/transpond/webrtc?v=2"));return s&&(await In(1e3),r!==null)?r:await Ph({fragementLength:w("FRAGEMENT_LENGTH"),referenceList:c,asyncMapHandler:l=>(g.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(s?"backup":""," choose_server:"),l),function(u,h,f,_){const[E]=wX(h,[cn.CHOOSE_SERVER]);let I=qt.networkState;return Mo(async()=>{I&&qt.networkState===Er.OFFLINE&&qt.onlineWaiter&&await se.race([qt.onlineWaiter,In(_&&_.maxRetryTimeout||an.maxRetryTimeout)]),I=qt.networkState;const v=await jo(u,{data:E,cancelToken:f,headers:{"Content-Type":"multipart/form-data;"}},!0);return IX(v,u)},()=>!1,v=>v.code!==b.OPERATION_ABORTED&&(v.code===b.UPDATE_TICKET_FAILED?v.data.retry:(g.warning("[".concat(h.clientId,"] update ticket network error, retry"),v),!0)),_)}(l,e,t,n)),allFailedhandler:l=>{throw l[0]},promisesCollector:i})};try{return r=await Nl([o(!1),o(!0)]),i.length&&i.forEach(s=>s.cancel&&typeof s.cancel=="function"&&s.cancel()),r}catch(s){throw s[0]}}function cM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function YR(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?cM(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):cM(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}class PX extends Wt{get isSuccess(){return!!this.configs}constructor(t,n){super(),y(this,"configs",void 0),y(this,"store",void 0),y(this,"joinInfo",void 0),y(this,"cancelToken",void 0),y(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),y(this,"interval",void 0),y(this,"mutex",void 0),y(this,"mutableParamsRead",!1),y(this,"configCache",{}),y(this,"limit_bitrate",void 0),this.mutex=new Ln("config-distribute",t),this.store=n}startGetConfigDistribute(t,n){this.joinInfo=t,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),w("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},w("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,pe.reportApiInvoke(null,{options:void 0,name:Ft.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:It.TRACER}).onSuccess(JSON.stringify(fi))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void g.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const n=await this.mutex.lock();try{t=await OX(this.joinInfo,this.cancelToken,this.retryConfig),g.debug("[config-distribute] get config distribute",JSON.stringify(t));const r=function(i){var o;const s=gc(o=Object.keys(i).filter(u=>/^webrtc_ng_global_parameter/.test(u))).call(o);for(let u=0;u<s.length;u++)for(let h=s.length-1;h>u;h--){const f=s[h],_=i[f].value;if(typeof _.__priority=="number"){const E=_.__priority,I=s[h-1],v=i[I].value;if(typeof v.__priority=="number"){if(!(E>v.__priority))continue;{const R=f;s[h]=s[h-1],s[h-1]=R}}else{const R=f;s[h]=s[h-1],s[h-1]=R}}}const c=Date.now(),l={};return s.forEach(u=>{const h=i[u].value.__expires;h&&h<=c||(l[u]=i[u])}),l}(t);this.cacheGlobalParameterConfig(r),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=r}catch(r){const i=new B(b.NETWORK_RESPONSE_ERROR,r);g.warning("[config-distribute] ".concat(i.toString()))}finally{n()}}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(t){R1(t)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==t.id&&this.emit(Vo.UPDATE_BITRATE_LIMIT,t):this.emit(Vo.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.limit_bitrate&&YR({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(t){try{const n={},r=Object.keys(t),i=[];r.forEach(o=>{const s=t[o].value;n[o]=s;const c=s.__id;if(c&&this.configCache[o]&&this.configCache[o].__id===c)return;const l=s.__type,u=t[o].value,h=t[o].tag;let f=0;l?l===jP.REALTIME&&(f=1):Object.keys(u).some(_=>Object.prototype.hasOwnProperty.call(Hv,_)||!gR()&&Object.prototype.hasOwnProperty.call(k_,_)?(f=1,!0):void 0),i.push({tag:h,isApplied:f,feature:o,params:JSON.stringify(s)})}),i.forEach(o=>{let{tag:s,feature:c,params:l,isApplied:u}=o;this.store.sessionId&&pe.abTest(this.store.sessionId,{intSucc:1,isApplied:u,tag:s,feature:c,params:l,cid:this.store.cid,uid:this.store.intUid})}),this.configCache=n}catch(n){g.debug("handleABTestConfigDistribute error",n)}}cacheGlobalParameterConfig(t){const n=function(i){const o={};return Object.keys(i).forEach(s=>{const c=i[s].value,l=c.__expires,u=c.__type;Object.keys(c).forEach(h=>{h==="__id"||h==="__type"||h==="__priority"||h==="__expires"||Object.prototype.hasOwnProperty.call(o,h)||(o[h]=YR(YR({value:c[h]},l&&{expires:l}),u&&{type:u}))})}),o}(t);try{var r;const i=(r=n.LIMIT_BITRATE)===null||r===void 0?void 0:r.value;delete n.LIMIT_BITRATE,i&&R1(i)&&this.handleBitrateLimit(i),this.limit_bitrate=i,this.handleGlobalParameterConfig(n),this.handleABTestConfigDistribute(t),function(c){try{const l=Date.now();Object.keys(c).forEach(u=>{const{value:h,type:f,expires:_}=c[u];_&&_<=l||((f===jP.REALTIME||Object.prototype.hasOwnProperty.call(Hv,u))&&(fi[u]=h,mt[u]=h,g.debug("Update realtime parameters from config distribute",u,h)),f||gR()||!Object.prototype.hasOwnProperty.call(k_,u)||(fi[u]=h,mt[u]=h,g.debug("Update gateway parameters from config distribute",u,h)))})}catch(l){g.error("Error update config immediately: ".concat(c),l.message)}}(n);const o=JSON.stringify(n),s=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",s),g.debug("Caching global parameters ".concat(o))}catch(i){g.error("Error caching global parameters:",i.message)}}handleGlobalParameterConfig(t){try{const n=Date.now();Object.keys(t).forEach(r=>{switch(r){case"CLIENT_ROLE_OPTIONS":if(Object.prototype.hasOwnProperty.call(mt,r)){const{value:o,expires:s}=t[r];if(s&&s<=n)return;Pv(mt[r],o)||(fi[r]=o,mt[r]=o,this.emit(Vo.UPDATE_CLIENT_ROLE_OPTIONS,o),g.debug("Updating client role options: ".concat(JSON.stringify(o))))}break;case"REMOTE_VIDEO_STREAM_TYPE":if(Object.prototype.hasOwnProperty.call(mt,r)){var i;const{value:o,expires:s}=t[r];if(s&&s<=n)return;typeof o=="number"&&Z(i=[0,1,4,5,6,7,8,9]).call(i,o)&&(fi[r]={value:o},mt[r]=o,this.emit(Vo.UPDATE_REMOTE_VIDEO_STREAM_TYPE,o),g.debug("Updating client remote stream type: ".concat(JSON.stringify(o))))}break;case"ENABLE_FORCE_HLS":if(Object.prototype.hasOwnProperty.call(mt,r)){const{value:o,expires:s}=t[r];if(s&&s<=n)return;Pv(mt[r],o)||(fi[r]=o,mt[r]=o,this.emit(Vo.FALLBACK_TO_HLS,o),g.debug("Updating enable force hls: ".concat(JSON.stringify(o))))}break;case"VOS_CONFIGURE":if(Object.prototype.hasOwnProperty.call(mt,r)){const{value:o,expires:s}=t[r];if(s&&s<=n)return;Pv(mt[r],o)||(fi[r]=o,mt[r]=o,this.emit(Vo.UPDATE_VOS_CONFIGURE,o),g.debug("Updating vos configure: ".concat(JSON.stringify(o))))}}})}catch(n){g.error("Error handling global parameter config:",n.message)}}}class LX extends Wt{constructor(){super(...arguments),y(this,"resultStorage",new Map)}setLocalAudioStats(t,n,r){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(r,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(r,n))}setLocalVideoStats(t,n,r){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(r,n)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(r,n)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(r)),!n.muted&&this.record("VIDEO_ENCODE_FAILED",t,this.checResolutionSent(r))}setRemoteAudioStats(t,n){const r=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",r,this.checkAudioOutputLevel(n))}setRemoteVideoStats(t,n){const r=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",r,this.checkVideoDecode(n))}record(t,n,r){if(w("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const i=this.resultStorage.get(t);if(!i)return;i.result.push(r);const o=t==="VIDEO_ENCODE_FAILED"?w("ENCODE_EXCEPTION_TIMES"):5;if(i.result.length>=o){var s;const c=Z(s=i.result).call(s,!0);i.isPrevNormal&&!c&&this.emit("exception",zR[t],t,n),!i.isPrevNormal&&c&&this.emit("exception",zR[t]+2e3,t+"_RECOVER",n),i.isPrevNormal=c,i.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,n){return n instanceof mn&&!n.isActive||!!n.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,n){let r=null;n._encoderConfig&&n._encoderConfig.frameRate&&(r=Pr(n._encoderConfig.frameRate));const i=t.captureFrameRate;return!r||!i||!(r>10&&i<5||r<10&&r>=5&&i<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checResolutionSent(t){var n;return!(!t.codecType||Z(n=w("ENCODE_EXCEPTION_VALIDATE_CODEC")).call(n,t.codecType.toLocaleLowerCase()))||!t.captureFrameRate||t.sendFrameRate!==0||t.sendResolutionWidth!==0||t.sendResolutionHeight!==0}checkSendVideoBitrate(t,n){return!!n.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,n){return n instanceof mn&&!n.isActive||!!n.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}const zR={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003,VIDEO_ENCODE_FAILED:2004},tr=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(n.length>0){const r=n[n.length-1];return Math.round(performance.now()-r.startTime)}return 0}measureFromPublishStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(n.length>0){const r=n[n.length-1];return Math.round(performance.now()-r.startTime)}return 0}};function dM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function zc(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?dM(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):dM(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}class Lh{constructor(t){y(this,"store",void 0),y(this,"onStatsException",void 0),y(this,"onUploadPublishDuration",void 0),y(this,"onStatsChanged",void 0),y(this,"onVideoCodecChanged",void 0),y(this,"localStats",new Map),y(this,"remoteStats",new Map),y(this,"updateStatsInterval",void 0),y(this,"trafficStats",void 0),y(this,"trafficStatsPeerList",[]),y(this,"uplinkStats",void 0),y(this,"exceptionMonitor",void 0),y(this,"p2pChannel",void 0),y(this,"scalabilityMode",P_.L1T1),y(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=t,this.exceptionMonitor=new LX,this.exceptionMonitor.on("exception",(n,r,i)=>{this.onStatsException&&this.onStatsException(n,r,i)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get($.LocalAudioTrack)||zc({},Jv)}getLocalVideoTrackStats(){return this.localStats.get($.LocalVideoTrack)||zc({},Qv)}getRemoteAudioTrackStats(t){const n=(o,s)=>{if(!this.trafficStats)return s;const c=this.trafficStats.peer_delay.find(l=>l.peer_uid===o);return c&&(s.publishDuration=c.B_ppad+(Date.now()-this.trafficStats.timestamp)),s},r={};if(t){var i;const o=(i=this.remoteStats.get(t))===null||i===void 0?void 0:i.audioStats;o&&(r[t]=n(t,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{audioStats:c}]=o;c&&(r[s]=n(s,c))});return r}getRemoteNetworkQualityStats(t){const n={};if(t){var r;const i=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.networkStats;i&&(n[t]=i)}else Array.from(this.remoteStats.entries()).forEach(i=>{let[o,{networkStats:s}]=i;s&&(n[o]=s)});return n}getNetworkQuality(){let t=0,n=0;return this.trafficStats&&(t=cm(this.trafficStats.B_unq),n=cm(this.trafficStats.B_dnq)),{uplinkNetworkQuality:t,downlinkNetworkQuality:n}}getRemoteVideoTrackStats(t){const n=(o,s)=>{if(!this.trafficStats)return s;const c=this.trafficStats.peer_delay.find(l=>l.peer_uid===o);return c&&(s.publishDuration=c.B_ppvd+(Date.now()-this.trafficStats.timestamp)),s},r={};if(t){var i;const o=(i=this.remoteStats.get(t))===null||i===void 0?void 0:i.videoStats;o&&(r[t]=n(t,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{videoStats:c}]=o;c&&(r[s]=n(s,c))});return r}getRTCStats(){let t=0,n=0,r=0,i=0;const o=this.localStats.get($.LocalAudioTrack);o&&(t+=o.sendBytes,n+=o.sendBitrate);const s=this.localStats.get($.LocalVideoTrack);s&&(t+=s.sendBytes,n+=s.sendBitrate);const c=this.localStats.get($.LocalVideoLowTrack);c&&(t+=c.sendBytes,n+=c.sendBitrate),this.remoteStats.forEach(u=>{let{audioStats:h,videoStats:f}=u;h&&(r+=h.receiveBytes,i+=h.receiveBitrate),f&&(r+=f.receiveBytes,i+=f.receiveBitrate)});let l=1;return this.trafficStats&&(l+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:l,SendBitrate:n,SendBytes:t,RecvBytes:r,RecvBitrate:i,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter(n=>n.B_ppad!==void 0||n.B_ppvd!==void 0),t.peer_delay.filter(n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1).forEach(n=>{var r;const i=(r=this.p2pChannel)===null||r===void 0?void 0:r.getRemoteMedia(n.peer_uid),o=i!=null&&i.videoSSRC?tr.measureFromSubscribeStart(this.store.clientId,i.videoSSRC):0,s=i!=null&&i.audioSSRC?tr.measureFromSubscribeStart(this.store.clientId,i.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,o>s?o:s),this.trafficStatsPeerList.push(n.peer_uid))}),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&g.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,n,r){if(!t)return!1;const i=!!r&&n.framesDecodeFreezeTime>r.framesDecodeFreezeTime,o=!r||n.framesDecodeCount>r.framesDecodeCount;return i||!o}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach(n=>{let[r,i]=n;switch(r){case $.LocalVideoTrack:case $.LocalVideoLowTrack:{const c=i,l=zc({},Qv),u=t.getStats(),h=t.getLocalMedia(r);if(u){const f=u.videoSend.find(_=>_.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(f){const _=t.getLocalVideoSize(),E=t.getEncoderConfig($.LocalVideoTrack);var o;(f.codec==="H264"||f.codec==="H265"||f.codec==="VP8"||f.codec==="VP9"||f.codec==="AV1X"||f.codec==="AV1")&&(l.codecType=f.codec,(c==null?void 0:c.codecType)!==f.codec&&((o=this.onVideoCodecChanged)===null||o===void 0||o.call(this,f.codec.toLocaleLowerCase()))),l.sendBytes=f.bytes,l.sendBitrate=c?8*Math.max(0,l.sendBytes-c.sendBytes):0,f.inputFrame?(l.captureFrameRate=f.inputFrame.frameRate,l.captureResolutionHeight=f.inputFrame.height,l.captureResolutionWidth=f.inputFrame.width):_&&(l.captureResolutionWidth=_.width,l.captureResolutionHeight=_.height),f.sentFrame?(l.sendFrameRate=f.sentFrame.frameRate,l.sendResolutionHeight=f.sentFrame.height,l.sendResolutionWidth=f.sentFrame.width):_&&(l.sendResolutionWidth=_.width,l.sendResolutionHeight=_.height),f.avgEncodeMs&&(l.encodeDelay=f.avgEncodeMs),E&&E.bitrateMax?l.targetSendBitrate=1e3*E.bitrateMax:f.targetBitrate&&(l.targetSendBitrate=f.targetBitrate),l.sendPackets=f.packets,l.sendPacketsLost=f.packetsLost,l.sendJitterMs=f.jitterMs,l.sendRttMs=f.rttMs,l.totalDuration=c?c.totalDuration+1:1,l.totalFreezeTime=c?c.totalFreezeTime:0,this.isLocalVideoFreeze(f)&&(l.totalFreezeTime+=1),f.scalabilityMode&&this.scalabilityMode!==f.scalabilityMode&&(g.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(f.scalabilityMode)),this.scalabilityMode=f.scalabilityMode)}this.trafficStats&&(l.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var s;this.localStats.set(r,l),((c==null?void 0:c.sendResolutionWidth)!==l.sendResolutionWidth||(c==null?void 0:c.sendResolutionHeight)!==l.sendResolutionHeight)&&((s=this.onStatsChanged)===null||s===void 0||s.call(this,"resolution",{width:l.sendResolutionWidth,height:l.sendResolutionHeight})),l&&h&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,h.track,l);break}case $.LocalAudioTrack:{const c=i,l=zc({},Jv),u=t.getStats(),h=t.getLocalMedia(r);if(u){const f=u.audioSend.find(_=>_.ssrc===(h==null?void 0:h.ssrcs[0].ssrcId));if(f){if(f.codec!=="opus"&&f.codec!=="aac"&&f.codec!=="PCMU"&&f.codec!=="PCMA"&&f.codec!=="G722"||(l.codecType=f.codec),f.inputLevel)l.sendVolumeLevel=Math.round(32767*f.inputLevel);else{const _=t.getLocalAudioVolume();_&&(l.sendVolumeLevel=Math.round(32767*_))}l.sendBytes=f.bytes,l.sendPackets=f.packets,l.sendPacketsLost=f.packetsLost,l.sendJitterMs=f.jitterMs,l.sendRttMs=f.rttMs,l.sendBitrate=c?8*Math.max(0,l.sendBytes-c.sendBytes):0}}this.trafficStats&&(l.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set($.LocalAudioTrack,l),l&&h&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,h.track,l);break}}})}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach(n=>{var r,i;let[o,{videoStats:s,audioStats:c,videoPcStats:l}]=n;const u=c,h=s,f=l,_=zc({},tL),E=zc({},nL),I=zc({},gq),{audioTrack:v,videoTrack:R,audioSSRC:A,videoSSRC:O}=t.getRemoteMedia(o);let P;P=this.store.useP2P?t.getStats(!0):t.getStats();const M=(r=P)===null||r===void 0?void 0:r.audioRecv.find(H=>H.ssrc===A),U=(i=P)===null||i===void 0?void 0:i.videoRecv.find(H=>H.ssrc===O),L=this.trafficStats&&this.trafficStats.peer_delay.find(H=>H.peer_uid===o);if(M&&(M.codec!=="opus"&&M.codec!=="aac"&&M.codec!=="PCMU"&&M.codec!=="PCMA"&&M.codec!=="G722"||(_.codecType=M.codec),M.outputLevel?_.receiveLevel=Math.round(32767*M.outputLevel):v&&(_.receiveLevel=Math.round(32767*v.getVolumeLevel())),_.receiveBytes=M.bytes,_.receivePackets=M.packets,_.receivePacketsLost=M.packetsLost,_.receivePacketsDiscarded=M.packetsDiscarded,_.packetLossRate=_.receivePacketsLost/(_.receivePackets+_.receivePacketsLost),_.receiveBitrate=u?8*Math.max(0,_.receiveBytes-u.receiveBytes):0,_.totalDuration=u?u.totalDuration+1:1,_.totalFreezeTime=u?u.totalFreezeTime:0,_.freezeRate=_.totalFreezeTime/_.totalDuration,_.receiveDelay=M.jitterBufferMs,_.totalDuration>10&&Lh.isRemoteAudioFreeze(v)&&(_.totalFreezeTime+=1)),U){var V;U.codec!=="H264"&&U.codec!=="H265"&&U.codec!=="VP8"&&U.codec!=="VP9"&&U.codec!=="AV1X"&&U.codec!=="AV1"||(E.codecType=U.codec),E.receiveBytes=U.bytes,E.receiveBitrate=h?8*Math.max(0,E.receiveBytes-h.receiveBytes):0,E.decodeFrameRate=U.decodeFrameRate<0?0:U.decodeFrameRate,E.renderFrameRate=U.decodeFrameRate<0?0:U.decodeFrameRate,U.outputFrame&&(E.renderFrameRate=U.outputFrame.frameRate),U.receivedFrame?(E.receiveFrameRate=U.receivedFrame.frameRate,E.receiveResolutionHeight=U.receivedFrame.height,E.receiveResolutionWidth=U.receivedFrame.width):R&&(E.receiveResolutionHeight=R._videoHeight||0,E.receiveResolutionWidth=R._videoWidth||0),U.framesRateFirefox!==void 0&&(E.receiveFrameRate=Math.round(U.framesRateFirefox)),E.receivePackets=U.packets,E.receivePacketsLost=U.packetsLost,E.packetLossRate=E.receivePacketsLost/(E.receivePackets+E.receivePacketsLost);const H=h?h.totalFreezeTime:0,q=h?h.totalDuration:0;E.totalDuration=h?h.totalDuration+1:1,E.totalFreezeTime=(V=U.totalFreezesDuration)!==null&&V!==void 0?V:H||0,E.receiveDelay=U.jitterBufferMs||0;const de=!!O&&t.getRemoteVideoIsReady(O);U.totalFreezesDuration===void 0&&R&&de&&Lh.isRemoteVideoFreeze(R,U,f)&&(E.totalFreezeTime+=1),E.freezeRate=Math.max(0,Math.min((E.totalFreezeTime-H)/(E.totalDuration-q),1))}L&&(_.end2EndDelay=L.B_ad,E.end2EndDelay=L.B_vd,_.transportDelay=L.B_ed,E.transportDelay=L.B_ed,_.currentPacketLossRate=L.B_ealr4/100,E.currentPacketLossRate=L.B_evlr4/100,I.uplinkNetworkQuality=L.B_punq?L.B_punq:0,I.downlinkNetworkQuality=L.B_pdnq?L.B_pdnq:0),this.remoteStats.set(o,{audioStats:_,videoStats:E,videoPcStats:U,networkStats:I}),v&&this.exceptionMonitor.setRemoteAudioStats(v,_),R&&this.exceptionMonitor.setRemoteVideoStats(R,E)})}}class lM{constructor(){y(this,"destChannelMediaInfos",new Map),y(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){T1(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){T1(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){tm(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function uM(e){if(!(e instanceof lM))return new B(b.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),n=e.getDestChannelMediaInfo();if(!t)return new B(b.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new B(b.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class Oa{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,n){y(this,"uid",void 0),y(this,"_uintid",void 0),y(this,"_trust_in_room_",!0),y(this,"_trust_audio_enabled_state_",!0),y(this,"_trust_video_enabled_state_",!0),y(this,"_trust_audio_mute_state_",!0),y(this,"_trust_video_mute_state_",!0),y(this,"_audio_muted_",!1),y(this,"_video_muted_",!1),y(this,"_audio_enabled_",!0),y(this,"_video_enabled_",!0),y(this,"_audio_added_",!1),y(this,"_video_added_",!1),y(this,"_is_pre_created",!1),y(this,"_video_pre_subscribed",!1),y(this,"_audio_pre_subscribed",!1),y(this,"_trust_video_stream_added_state_",!0),y(this,"_trust_audio_stream_added_state_",!0),y(this,"_audioTrack",void 0),y(this,"_videoTrack",void 0),y(this,"_dataChannels",[]),y(this,"_audioSSRC",void 0),y(this,"_videoSSRC",void 0),y(this,"_audioOrtc",void 0),y(this,"_videoOrtc",void 0),y(this,"_cname",void 0),y(this,"_rtxSsrcId",void 0),y(this,"_videoMid",void 0),y(this,"_audioMid",void 0),this.uid=t,this._uintid=n}}function hM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function qR(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?hM(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):hM(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}const kX=e=>`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1 2
a=msid-semantic: WMS
a=ice-lite`.concat(e?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:2
`),gm="9",XR=2e4,Sm=4e4;let pM=class{get localCapabilities(){return Mt(this._localCapabilities)}get rtpCapabilities(){return Mt(this._rtpCapabilities)}get candidates(){return Mt(this._candidates)}get iceParameters(){return Mt(this._iceParameters)}get dtlsParameters(){return Mt(this._dtlsParameters)}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3];y(this,"sessionDesc",void 0),y(this,"_localCapabilities",void 0),y(this,"_rtpCapabilities",void 0),y(this,"_candidates",void 0),y(this,"_originCandidates",void 0),y(this,"_iceParameters",void 0),y(this,"_isUseExtmapAllowMixed",void 0),y(this,"_isUseLocalCodecs",void 0),y(this,"_isUseDataChannel",void 0),y(this,"_dtlsParameters",void 0),y(this,"setup",void 0),y(this,"currentMidIndex",void 0),y(this,"cname",void 0),y(this,"useLocalCodecsMids",[]),y(this,"preloadSsrcs",[]),y(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=t,this._isUseLocalCodecs=n,this._isUseDataChannel=r,e=Mt(e);const{iceParameters:i,dtlsParameters:o,candidates:s,rtpCapabilities:c,setup:l,localCapabilities:u,cname:h}=e;this._rtpCapabilities=c,this._candidates=s,this._originCandidates=Mt(s),this._iceParameters=i,this._dtlsParameters=o,this._localCapabilities=u,this.setup=l,this.cname=h,[this.sessionDesc]=this.updateRemoteRTPCapabilities(c),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}checkPreloadSsrcs(e){return e.length===this.preloadSsrcs.length&&e.every(t=>{var n;return Z(n=this.preloadSsrcs).call(n,t)})}preloadRemoteMedia(e){let t=0;const n=[],r=[];for(;e>0;){const i=[qR({ssrcId:Sm+t},w("USE_SUB_RTX")?{rtx:Sm+t+1}:{})],o="".concat(Sm+t,"_").concat(XR+t),{ssrcs:s,ssrcGroups:c}=bh(i,this.cname,w("SYNC_GROUP")?o:void 0),l=this.preCreateOrRecycleSendMedia("video",s,c,void 0),u=[{ssrcId:XR+t}],h="".concat(Sm+t,"_").concat(XR+t),{ssrcs:f,ssrcGroups:_}=bh(u,this.cname,w("SYNC_GROUP")?h:void 0),E=this.preCreateOrRecycleSendMedia("audio",f,_,void 0);e--,t+=2,n.push(l,E),r.push(s[0].ssrcId,f[0].ssrcId)}return this.useLocalCodecsMids.push(...n),this.preloadSsrcs=r,{mids:n,preSSRCs:r,isAvailable:!0}}preCreateOrRecycleSendMedia(e,t,n,r){const i=this.rtpCapabilities.send.videoCodecs,o=this._isUseLocalCodecs||i.length===0?this.localCapabilities.recv:this.rtpCapabilities.send;g.debug("create or recycle send media without remote rtp capabilities, ssrcs ",t[0].ssrcId);const s=e===ue.VIDEO?o.videoCodecs:o.audioCodecs,c=e===ue.VIDEO?o.videoExtensions:o.audioExtensions;this.currentMidIndex+=1;const l="".concat(this.currentMidIndex);let u={media:{mediaType:e,port:gm,protos:["UDP","TLS","RTP","SAVPF"],fmts:s.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:s,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(l)}};return u=this.mungSendMediaDesc(u,r),this.sessionDesc.mediaDescriptions.push(u),this.updateBundleMids(),l}toString(){return js(this.sessionDesc)}send(e,t,n,r){const{ssrcs:i,ssrcGroups:o}=bh(t,this.cname,w("SYNC_GROUP")?n:void 0),s=this.findPreloadMediaDesc(i);if(s){if(kt()&&this.firefoxSsrcMidMap.set(i[0].ssrcId,s.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(s);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(s,r),{mid:s.attributes.mid,needExchangeSDP:!0}}return{mid:s.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,i);let l;return c===-1||c===1&&(Pn()||function(){const u=ot();return!(u.name!==at.CHROME||!u.osVersion)&&Number(u.version)<=90}()||ko(143)||Ta(143)||w("RESERVE_MID_1_MLINE")||w("ENABLE_ENCODED_TRANSFORM")&&Fs())||c===0&&!function(u){const h=ot();return!(h.name!==at.FIREFOX||!h.osVersion)&&Number(h.version)===u}(138)&&w("USE_SUB_RTX")||cP()?(l=this.createOrRecycleSendMedia(e,i,o,"sendonly",r),this.updateBundleMids()):(l=Mt(this.sessionDesc.mediaDescriptions[c]),l.attributes.direction="sendonly",l.attributes.ssrcs=i,l.attributes.ssrcGroups=o,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(l,r)),kt()&&this.firefoxSsrcMidMap.set(i[0].ssrcId,l.attributes.mid),{mid:l.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:e,needExchangeSDP:t}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:e.attributes.mid,needExchangeSDP:t}}batchSend(e){const t=e.map(i=>{let{kind:o,ssrcMsg:s,mslabel:c}=i;return this.send(o,s,c)}),n=[];let r=!1;return t.forEach(i=>{let{mid:o,needExchangeSDP:s}=i;s&&(r=!0),n.push(o)}),{mids:n,needExchangeSDP:r}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&e.indexOf(n.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(n=>{n.attributes.mid==="0"||kt()||cP()?n.attributes.ssrcs=[]:(n.attributes.ssrcs=[],n.attributes.direction="inactive",n.media.port="0")}),this.updateBundleMids()}mute(e){const t=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));t.attributes.direction="inactive"}unmute(e){const t=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!t)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));t.attributes.direction="sendonly"}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>Z(e).call(e,n.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>Z(e).call(e,n.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(n=>{n.attributes.direction="recvonly"})}receive(e,t,n,r){e.forEach((i,o)=>{this.createOrRecycleRecvMedia(i,[],"recvonly",t,n,r[o])}),this.updateBundleMids()}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>e.indexOf(n.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(e){const t=this.sessionDesc||gr((n=this._isUseExtmapAllowMixed,this._isUseDataChannel?kX(n):`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(n?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var n;this._rtpCapabilities=e;let r=!1;const i=this.rtpCapabilities.send,o=this.localCapabilities.send,s=this.localCapabilities.recv,c=s.videoCodecs,l=s.audioCodecs,u=s.videoExtensions,h=s.audioExtensions;for(const I of t.mediaDescriptions){var f;if(I.attributes.direction!=="sendonly"||typeof I.attributes.mid!="string"||!Z(f=this.useLocalCodecsMids).call(f,I.attributes.mid)){if(r=!0,I.attributes.iceUfrag=this._iceParameters.iceUfrag,I.attributes.icePwd=this._iceParameters.icePwd,I.attributes.fingerprints=this._dtlsParameters.fingerprints,I.attributes.candidates=this._candidates,I.attributes.setup=this.setup,I.media.mediaType==="application"&&(I.attributes.sctpPort="5000"),I.media.mediaType==="video")if(this._isUseLocalCodecs&&I.attributes.direction==="sendonly"){var _;I.media.fmts=c.map(R=>R.payloadType.toString(10)),I.attributes.payloads=c,I.attributes.extmaps=u;const v=I.attributes.mid;typeof v!="string"||Z(_=this.useLocalCodecsMids).call(_,v)||this.useLocalCodecsMids.push(v)}else if(i.videoCodecs.length===0){const v=o.videoCodecs.filter(R=>{var A,O;return(A=R.rtpMap)===null||A===void 0?void 0:Z(O=A.encodingName.toLowerCase()).call(O,"vp8")});v.length===0&&v.push(o.videoCodecs[0]),I.media.fmts=v.map(R=>R.payloadType.toString(10)),I.attributes.payloads=v,I.attributes.extmaps=[]}else I.media.fmts=i.videoCodecs.map(v=>v.payloadType.toString(10)),I.attributes.payloads=i.videoCodecs,I.attributes.extmaps=i.videoExtensions;if(I.media.mediaType==="audio")if(this._isUseLocalCodecs&&I.attributes.direction==="sendonly"){var E;I.media.fmts=l.map(R=>R.payloadType.toString(10)),I.attributes.payloads=l,I.attributes.extmaps=h;const v=I.attributes.mid;typeof v!="string"||Z(E=this.useLocalCodecsMids).call(E,v)||this.useLocalCodecsMids.push(v)}else if(i.audioCodecs.length===0){const v=o.audioCodecs.filter(R=>{var A,O;return(A=R.rtpMap)===null||A===void 0?void 0:Z(O=A.encodingName.toLowerCase()).call(O,"opus")})||[o.audioCodecs[0]];I.media.fmts=v.map(R=>R.payloadType.toString(10)),I.attributes.payloads=v,I.attributes.extmaps=[]}else I.media.fmts=i.audioCodecs.map(v=>v.payloadType.toString(10)),I.attributes.payloads=i.audioCodecs,I.attributes.extmaps=i.audioExtensions,bl(I)}}return this.sessionDesc=t,this.currentMidIndex=t.mediaDescriptions.length-1,[this.sessionDesc,r]}updateCandidates(e){const t=this._originCandidates.filter(r=>r.transport==="udp"),n=[];if(t.forEach(r=>{n.push(qR(qR({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))}),t.length!==0){switch(e){case kn.TCP_RELAY:this._candidates=n;break;case kn.UDP_TCP_RELAY:case kn.RELAY:this._candidates=[...t,...n];break;default:this._candidates=t}for(const r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(e){e=Mt(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}findAvailableMediaIndex(e,t){return this.sessionDesc.mediaDescriptions.findIndex(n=>{const r=n.media.mediaType===e&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(kt()){if(r){const i=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(i||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!i||i!==n.attributes.mid)}return!1}return r})}createOrRecycleDataChannel(){for(const n of this.sessionDesc.mediaDescriptions)if(n.media.mediaType==="application")return{mediaDesc:n,needExchangeSDP:!1};this.currentMidIndex+=1;const e="".concat(this.currentMidIndex),t={media:{mediaType:"application",port:gm,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(e),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(t),{mediaDesc:t,needExchangeSDP:!0}}createOrRecycleRecvMedia(e,t,n,r,i,o){const s=e._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,l=Nh(s,c,this.localCapabilities.send,s===ue.VIDEO?r:i),u=s===ue.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const h="".concat(this.currentMidIndex);let f={media:{mediaType:s,port:gm,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map(E=>E.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:u,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(h)}};f=this.mungRecvMediaDsec(f,e,o);const _=this.findFirstClosedMedia(s);if(_){const E=this.sessionDesc.mediaDescriptions.indexOf(_);this.sessionDesc.mediaDescriptions[E]=f}else this.sessionDesc.mediaDescriptions.push(f);return f}updateRemoteDtlsParameters(e){const t=new Set(this._dtlsParameters.fingerprints.map(i=>i.fingerprint)),n=new Set(e.map(i=>i.fingerprint));let r=!1;t.size!==n.size&&(r=!0);for(const i of t)n.has(i)||(r=!0);return r}updateRemoteCodec(e,t,n){const r=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(f=>f.rtpMap&&f.rtpMap.encodingName.toLowerCase()||"").filter(f=>{var _;return Z(_=Object.keys(Mc)).call(_,f)}))],i=new Set(t);if(r.every(f=>i.has(f)))return g.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(t)),!1;const o=this._rtpCapabilities.recv.videoCodecs.filter(f=>t.some(_=>{var E;return Z(E=f.rtpMap&&f.rtpMap.encodingName.toLowerCase()||"").call(E,_)}));if(o.length===0)return g.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(r," codecs: ").concat(t)),!1;const s=[...new Set(o.map(f=>f.rtpMap&&f.rtpMap.encodingName.toLowerCase()||""))];let c;if(g.debug("updateRemoteCodec, from ".concat(r," to ").concat(s)),e.length===0)c=this.sessionDesc.mediaDescriptions.filter(f=>f.media.mediaType==="video"&&f.attributes.direction==="recvonly");else if(c=this.sessionDesc.mediaDescriptions.filter(f=>f.attributes.mid&&f.media.mediaType==="video"&&Z(e).call(e,f.attributes.mid)&&f.attributes.direction==="recvonly"),c.length!==e.length)return g.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(e,", codecs: ").concat(t)),!1;if(w("USE_PUB_RTX")||w("USE_SUB_RTX")){const f=ba(o,this.rtpCapabilities.recv.videoCodecs);o.push(...f)}this._rtpCapabilities.recv.videoCodecs=o;const l=this.localCapabilities.send,u=this.rtpCapabilities.recv,h=Nh(ue.VIDEO,u,l,n);return c.forEach(f=>{const _=h.map(E=>E.payloadType.toString(10));g.debug("updateRemoteCodec mid: ".concat(f.attributes.mid,", from"),f.attributes.payloads,"to",h),f.attributes.payloads=h,f.media.fmts=_}),g.debug("updateRemoteCodec success, mids: ".concat(e,", codecs: ").concat(t,", remote recv: ").concat(this._rtpCapabilities.recv.videoCodecs.length,", remote send: ").concat(this._rtpCapabilities.send.videoCodecs.length)),!0}createOrRecycleSendMedia(e,t,n,r,i){const o=this.rtpCapabilities.send.videoCodecs,s=this._isUseLocalCodecs||o.length===0?this.localCapabilities.recv:this.rtpCapabilities.send,c=e===ue.VIDEO?s.videoCodecs:s.audioCodecs,l=e===ue.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const u="".concat(this.currentMidIndex);let h={media:{mediaType:e,port:gm,protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(_=>_.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(u)}};h=this.mungSendMediaDesc(h,i);const f=this.findFirstClosedMedia(e);if(f){const _=this.sessionDesc.mediaDescriptions.indexOf(f);this.sessionDesc.mediaDescriptions[_]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}mungRecvMediaDsec(e,t,n){const r=Mt(e);return LR(r),Yc(r,t),kR(r,t),j1(r),um(r,n,this.localCapabilities.send),r}mungSendMediaDesc(e,t){const n=Mt(e);return n.attributes&&n.attributes.payloads&&Array.isArray(n.attributes.payloads)&&n.attributes.payloads.length>0&&n.attributes.payloads.forEach(r=>{r.rtpMap&&r.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&w("ENABLE_DOWN_SPS_PPS")&&(r.fmtp&&r.fmtp.parameters||(r.fmtp={parameters:{}}),r.fmtp.parameters["sps-pps-idr-in-keyframe"]="1")}),um(n,t,this.localCapabilities.recv),bl(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(n!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=r}}bumpMid(e){this.currentMidIndex+=e}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(t=>kt()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0")}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(t=>{var n;return((n=t.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===e[0].ssrcId})}getSSRC(e){var t;return(t=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e))===null||t===void 0?void 0:t.attributes.ssrcs}};function fM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Ks(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?fM(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fM(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}var Dl=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(Dl||{});const Tm=new Map;function _M(e,t,n,r){let{scale:i}=e;if(i===0&&r===Dl.UP||i>=t.length-1&&r===Dl.DOWN)return e;let o=Ks(Ks({},e),{},{scale:r===Dl.DOWN?++i:--i});switch(n){case"maintain-framerate":o=Ks(Ks({},o),t[i].motion);break;case"maintain-resolution":o=Ks(Ks({},o),t[i].detail);break;case"balanced":o=Ks(Ks({},o),t[i].balanced)}return o}function mM(e,t){if(t){const n={overUse:0,underUse:0,adaptationList:EM(t)};Tm.set(e,n)}else Tm.delete(e)}function EM(e){const t=Ks({},e),{bitrateMax:n,frameRate:r,scaleResolutionDownBy:i,bitrateMin:o}=t,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:c,MAX_SCALE:l,BITRATE_MIN_THRESHOLD:u,BITRATE_MAX_THRESHOLD:h,BWE_SCALE_UP_THRESHOLD:f,BWE_SCALE_DOWN_THRESHOLD:_,PERF_SCALE_DOWN_THRESHOLD:E,PERF_SCALE_UP_THRESHOLD:I,BALANCE_BITRATE_FACTOR:v,BALANCE_FRAMERATE_FACTOR:R,BALANCE_RESOLUTION_FACTOR:A,MOTION_RESOLUTION_FACTOR:O,MOTION_BITRATE_FACTOR:P,DETAIL_FRAMERATE_FACTOR:M,DETAIL_BITRATE_FACTOR:U}=Gv,L=Math.min(t.frameRate,c),V=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(_,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(E,1)*L),fps_up:r},balanced:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:n,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:n,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:n,bitrateMin:o}}];for(let H=1;H<=l;H++){const q={bwe_up:Math.round(Math.pow(f,H)*n),bwe_down:Math.round(Math.pow(_,H+1)*n),fps_up:Math.round(Math.pow(I,H)*L),fps_down:Math.round(Math.pow(E,H+1)*L)},de={scaleResolutionDownBy:i/Math.pow(A,H),frameRate:Math.max(Math.round(Math.pow(R,H)*r),s),bitrateMax:Math.max(Math.round(Math.pow(v,H)*n),h),bitrateMin:Math.max(Math.round(Math.pow(v,H)*o),u)},Ne={scaleResolutionDownBy:i/Math.pow(O,H),frameRate:r,bitrateMax:Math.max(Math.round(Math.pow(P,H)*n),h),bitrateMin:Math.max(Math.round(Math.pow(P,H)*o),u)},Ae={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(M,H)*r),s),bitrateMax:Math.max(Math.round(Math.pow(U,H)*n),h),bitrateMin:Math.max(Math.round(Math.pow(U,H)*o),u)};V.push({scale:H,threshold:q,balanced:de,motion:Ne,detail:Ae})}return V}function MX(e,t,n,r,i,o){const s=Tm.get(e)||{overUse:0,underUse:0,adaptationList:EM(i)},{adaptationList:c}=s;Tm.set(e,s);const{OVERUSE_TIMES_THRESHOLD:l,UNDERUSE_TIMES_THRESHOLD:u}=Gv,{scale:h}=r;let f,_;return typeof t=="number"&&t>0&&function(E,I,v,R){if(I>=v.length)return!1;let{threshold:{fps_down:A}}=v[I];return w("FORCE_AG_HIGH_FRAMERATE")&&R==="maintain-framerate"&&(A=v[0].threshold.fps_down),E<A}(t,h,c,o)&&(s.overUse++,_=dl.CPU,s.overUse>l)||typeof n=="number"&&n>0&&function(E,I,v){if(I>=v.length)return!1;const{threshold:{bwe_down:R}}=v[I];return E<R}(n,h,c)&&(s.overUse++,_=dl.BANDWIDTH,s.overUse>l)?(s.overUse=0,s.underUse=0,f=_M(r,c,o,Dl.DOWN),[f,_]):(typeof t=="number"&&t>0&&typeof n=="number"&&n>0&&function(E,I,v,R){if(I===0)return;let{threshold:{fps_up:A}}=v[I];return w("FORCE_AG_HIGH_FRAMERATE")&&R==="maintain-framerate"&&(A=v[1].threshold.fps_up),E>A}(t,h,c,o)&&function(E,I,v){if(I===0)return;const{threshold:{bwe_up:R}}=v[I];return E>R}(n,h,c)&&(s.underUse++,s.underUse>u&&(s.overUse=0,s.underUse=0,f=_M(r,c,o,Dl.UP),f.scale===0&&(_=dl.NONE))),[f,_])}function gM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function JR(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?gM(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):gM(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}function SM(e){var t;return!!w("ENABLE_AG_ADAPTATION")&&!!(e instanceof H_||Z(t=e._hints).call(t,pt.CUSTOM_TRACK))&&(!!w("FORCE_SUPPORT_AG_ADAPTATION")||!!(sP(14,0,!1)&&aP(17,4,!0)||oP(14)&&Rv(17,4,!0)))}const vm=new Map;function TM(e,t,n,r,i,o){if(Pl(e,n),i(t),r!=="balanced"&&r!=="maintain-framerate"&&r!=="maintain-resolution")return;let s=-1;mM(e,t);const c=window.setInterval(()=>{const u=vm.get(e);if(!w("ENABLE_AG_ADAPTATION")||!u)return Pl(e,n),void i(t);const h=o();if(h.sendPackets>0&&h.OutgoingAvailableBandwidth>0){if(s===-1)return void(s=Date.now());if(Date.now()-s<1e3)return;const f=h.sendFrameRate,_=h.OutgoingAvailableBandwidth,[E,I]=MX(e,f,_,u.adaptationConfig,t,r);I&&(n.qualityLimitationReason=I),E&&u.adaptationConfig.scale!==E.scale&&(g.debug("[".concat(e,"] applyAdaptation: ").concat(n.qualityLimitationReason,`
           sendFps `).concat(f,", bwe ").concat(_,", switch from ").concat(u.adaptationConfig.scale," to ").concat(E.scale," ")),u.adaptationConfig=JR(JR({},u.adaptationConfig),E),i(E))}},w("CHECK_LOCAL_STATS_INTERVAL")),l=JR({},t);vm.set(e,{timer:c,adaptationConfig:l,originConfig:t,adaptationFunc:i}),g.debug("[".concat(e,"] start adaptation, originConfig: ").concat(JSON.stringify(t),", degradationPreference: ").concat(r))}function Pl(e,t){const n=vm.get(e);if(n){const{timer:r}=n;window.clearTimeout(r),vm.delete(e)}t.qualityLimitationReason=dl.NONE,mM(e)}function UX(e,t){var n;let r;switch(t){case $.LocalAudioTrack:r=Et.Audio;break;case $.LocalVideoTrack:r=Z(n=e._hints).call(n,pt.SCREEN_TRACK)?Et.Screen:Et.High;break;case $.LocalVideoLowTrack:r=Et.Low}return r}function QR(e){const t=Xe();if(e.some(n=>n._bypassWebAudio))throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function ZR(e,t){QR(e);const n=new mn;return e.forEach(r=>n.addAudioTrack(r)),n}const xX=!Xe().supportUnifiedPlan||w("CHROME_FORCE_PLAN_B")&&us();function kh(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(e.useDcSignal)return n={spec:t,store:e},Bo("DataChannelConnection").create(n);var n;return xX?function(i){return Bo("PlanBConnection").create(i)}({spec:t,store:e}):new vi(t,e)}function $R(e){return e&&(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")}function ey(e){try{if(e.iceServers)return!1;if(e.turnServer&&e.turnServer.mode!=="off"){if(bc(e.turnServer.servers))return!1;if(w("FORCE_TURN_TCP")||e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).some(t=>t.forceturn))return!0}return!1}catch{return!1}}var nt;function vM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Go(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?vM(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vM(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}let vi=(nt=class ld extends om{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var n;return Z(n=Object.keys(Mc)).call(n,t)}))]}constructor(t,n){super(t,n),y(this,"id",_t(5,"connection-")),y(this,"store",void 0),y(this,"peerConnection",void 0),y(this,"forceTurn",!1),y(this,"remoteSDP",void 0),y(this,"initialOffer",void 0),y(this,"transportEventReceiver",void 0),y(this,"statsFilter",void 0),y(this,"extension",{useXR:w("USE_XR")}),y(this,"localCapabilities",void 0),y(this,"remoteCodecs",void 0),y(this,"localCandidateCount",0),y(this,"allCandidatesReceived",!1),y(this,"isPreallocation",!1),y(this,"isPreRender",!1),y(this,"preMediaMap",new Map),y(this,"dataStreamChannelMap",new Map),y(this,"establishPromise",void 0),y(this,"recoveredDataChannelIds",[]),y(this,"currentDataChannelId",1),y(this,"supportAV1RtpSpec",!1),y(this,"mutex",void 0),y(this,"qualityLimitationReason",dl.NONE),y(this,"isFirstConnected",!1),this.store=n,this.forceTurn=ey(t),this.mutex=new Ln("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(ld.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=L_(this.peerConnection,w("STATS_UPDATE_INTERVAL"),void 0,kt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void g.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r);const o=this.remoteSDP.toString();i==null||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else g.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=Es(n.sdp),i=await UR({filterRTX:!w("USE_PUB_RTX")&&!w("USE_SUB_RTX"),filterVideoFec:w("FILTER_VIDEO_FEC"),filterAudioFec:w("FILTER_AUDIO_FEC"),filterVideoCodec:w("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:w("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:w("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=Oh(i),this.initialOffer=n,w("ENABLE_SVC")&&this.store.codec=="av1"){const s=await G1();var t;s&&(this.supportAV1RtpSpec=!0,(t=i.send)===null||t===void 0||t.videoExtensions.push(s))}let o;return n.sdp&&hm(n.sdp)&&(o=Mt(i),k1(o)),Go(Go({},r),{},{rtpCapabilities:o||i,offerSDP:n.sdp})}catch(n){throw new W(b.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&hm(this.initialOffer.sdp)&&M1(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new pM(Go(Go({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!w("ENABLE_PRE_SUB_WITH_PRE_PC")||!w("PRE_USE_LOCAL_CODECS"))&&Th(this.store)),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),r=xR(this.initialOffer.sdp,this.extension),i=this.logSDPExchange(r||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),i==null||i(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const o=this.peerConnection.getTransceivers()[0];if(o!=null&&o.receiver&&this.tryBindTransportEvents(o.receiver),Th(this.store))if(t.preallocation&&w("ENABLE_PRE_SUB_WITH_PRE_PC")){const s=w("PRE_SUB_NUM"),{mids:c,preSSRCs:l}=this.remoteSDP.preloadRemoteMedia(s);await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[".concat(this.store.clientId,"] [P2PConnection] preload media, in pre pc,add preload ssrcs ").concat(l)),this.presetMedia(c,l)}else{const{preSSRCs:s=[]}=t,c=s.map(u=>u.ssrcMsg[0].ssrcId);if(s.length===0)return;const{mids:l}=this.remoteSDP.batchSend(s.map(u=>Object.assign({},u)));await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[P2PConnection.connect] preload media, after join, add preload ssrcs ".concat(c)),this.presetMedia(l,c)}}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}presetMedia(t,n){t.forEach((r,i)=>{this.peerConnection.getTransceivers().forEach(o=>{if(o.mid!=null&&r===o.mid&&o.receiver.track){const s=o.receiver.track;let c;s.kind==="video"&&w("ENABLE_PRE_RENDER")&&(c=new W_({trackId:"track-".concat(s.kind,"-unknown-").concat(this.store.clientId,"_").concat(_t(5,""))},!0),c.updateVideoTrack(s),c.onFirstVideoFrameRender=()=>{var l;const u=this.preMediaMap.get(n[i]);u&&(u.firstVideoRender=Date.now()),(l=this.onFirstVideoRender)===null||l===void 0||l.call(this,n[i])},c.onVideoBufferReady=()=>{var l;(l=this.onFirstVideoBufferReady)===null||l===void 0||l.call(this,n[i])},c.play(this.store.sessionId||void 0),this.isPreRender=!0),this.preMediaMap.set(n[i],{mid:r,track:s,player:c,transceiver:o})}}),this.store.peerReceiver()})}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let n=!1;const{rtpCapabilities:r}=t;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(r),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const s=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||s}const{preSSRCs:i=[]}=t,o=i.map(s=>s.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(o)){const s=[],c=[];if(Array.from(this.preMediaMap.entries()).every(l=>{let[u,{mid:h,player:f,track:_}]=l;return s.push(h),c.push(u),this.preMediaMap.delete(u),f&&f.destroy(),!0}),s.length>0&&(this.remoteSDP.stopSending(s),await Wr(this.peerConnection,this.remoteSDP,this.extension),g.warn("[P2PConnection.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(c)),pe.reportApiInvoke(this.store.sessionId,{name:Ft.PRELOAD_MEDIA_FAILED,options:[i,c],tag:It.TRACER}).onSuccess()),i.length>0){const{mids:l}=this.remoteSDP.batchSend(i.map(u=>Object.assign({},u)));await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[P2PConnection.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(o)),this.presetMedia(l,o)}}n?(await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[P2PConnection] updateRemoteConnect by exchanging SDP.")):g.debug("[P2PConnection] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(n.toString()))}}send(t,n,r){var i=this;return Ar(function*(){const o=yield We(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[],c=wh();t.forEach(R=>{const A=i.peerConnection.addTransceiver(R._mediaStreamTrack,Go({direction:"sendonly"},R.trackMediaType==="video"&&i.supportAV1RtpSpec&&c?{sendEncodings:[{scalabilityMode:c}]}:{}));s.push(A),R._updateRtpTransceiver(A)}),kt()&&w("SIMULCAST")===!0&&(yield We(i.applySimulcastForFirefox(s,t)));const l=yield We(i.peerConnection.createOffer()),u=i.remoteSDP.predictReceivingMids(t.length),h=i.mungSendOfferSDP(l.sdp,t,u),f=gr(h),_=u.map(R=>{const A=f.mediaDescriptions.find(O=>O.attributes.mid===R);if(!A)throw new Error("Cannot extract ssrc from mediaDescription.");return PR(A,w("USE_PUB_RTX"))});let E;try{E=yield _}catch(R){E=[],i.remoteSDP.receive(t,n,r,E);const A=i.remoteSDP.toString();throw yield We(i.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield We(i.peerConnection.setRemoteDescription({type:"answer",sdp:A})),yield We(i.stopSending(u,!0)),R}i.remoteSDP.receive(t,n,r,E);const I=i.remoteSDP.toString(),v=i.logSDPExchange(h,"offer","local","send");return yield We(i.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield We(i.applySimulcastEncodings(s,t)),yield We(i.applySendEncodings(s,t)),v==null||v(I),yield We(i.peerConnection.setRemoteDescription({type:"answer",sdp:I})),s.map((R,A)=>{const O=u[A];return{localSSRC:_[A],id:O,transceiver:R}})}catch(s){throw s instanceof W?s:new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let r=this.dataStreamChannelMap.get(t);if(r&&r.readyState==="open")g.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");r=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:w("DATASTREAM_MAX_RETRANSMITS")}),r.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,r)}n.forEach(o=>{o._updateOriginDataChannel(r)});const{needExchangeSDP:i}=this.remoteSDP.sendDataChannel();if(i){const o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),g.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else g.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(r){throw r instanceof W?r:new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(r.toString()))}}async stopDataChannels(t){try{const n=this.dataStreamChannelMap.get(t);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(t)}catch(n){throw n instanceof W?n:new W(b.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(t,n){const r=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const i=this.peerConnection.getTransceivers().filter(l=>t.indexOf(l.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map(l=>{var u;Pl(this.id+l.mid,this),l.direction="inactive",(u=l.stop)===null||u===void 0||u.call(l)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(t);const c=this.remoteSDP.toString();s==null||s(c),await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(i){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}finally{r&&r()}}async receive(t,n,r,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(t,n,r,i);s&&(await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP.")));const c=this.peerConnection.getTransceivers().find(l=>l.mid===o);if(!c)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,id:o,transceiver:c}}catch(o){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:r}=this.remoteSDP.batchSend(t);return r&&(await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),n.map(i=>{const o=this.peerConnection.getTransceivers().find(s=>s.mid===i);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:i,transceiver:o}})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");t.forEach(o=>{Array.from(this.preMediaMap.entries()).some(s=>{let[c,{mid:l,player:u}]=s;if(l===o)return this.preMediaMap.delete(c),u&&u.destroy(),!0})}),this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(t);const o=this.remoteSDP.toString();i==null||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,c)=>{s.direction="sendonly"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const o=this.remoteSDP.toString();i==null||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return Ar(function*(){const r=yield We(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const i=Xe().supportPCSetConfiguration,o=w("FORCE_TURN_TCP")||n.forceTurn;if(t===kn.RELAY&&!i)return;if(i&&!o){const f=t===kn.RELAY?"relay":"all",_=n.peerConnection.getConfiguration();_.iceTransportPolicy!==f&&(g.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(_.iceTransportPolicy,"] to [").concat(f,"]")),_.iceTransportPolicy=f,n.peerConnection.setConfiguration(_))}n.remoteSDP.updateCandidates(t);const s=yield We(n.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const c=Es(s.sdp),{remoteIceParameters:l}=yield c.iceParameters;n.remoteSDP.restartICE(l);const u=n.remoteSDP.toString(),h=n.logSDPExchange(s.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield We(n.peerConnection.setLocalDescription(s)),h==null||h(u),yield We(n.peerConnection.setRemoteDescription({type:"answer",sdp:u}))}catch(i){g.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),i)}finally{r()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(kn.TCP_RELAY),await Wr(this.peerConnection,this.remoteSDP,this.extension)}catch(n){g.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach(n=>{Pl(this.id+n.mid,this)}),this.preMediaMap.forEach(n=>{let{player:r}=n;r&&r.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Go(Go({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(r.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const o=this.remoteSDP.toString(),s=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new W(b.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,n){const r=this.peerConnection.getTransceivers().filter(i=>i.mid===t);r.length===1&&(this.isVP8Simulcast(n)?kt()||await this.applySimulcastEncodings(r,[n]):await this.applySendEncodings(r,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const r=this.peerConnection.getTransceivers().find(i=>i.mid===n);r&&await r.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:r,remote:i}=n.getSelectedCandidatePair();return{local:Go(Go({},so),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:Go(Go({},so),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var n;const r="code: ".concat(t.errorCode,", message: ").concat(t.errorText),i=t.port?"local: ".concat(t.port):"",o=ms(t.url||"");g.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(r,"), url: ").concat(o||"",", host_candidate:").concat(i)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,r)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&g.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,g.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,g.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},w("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]},r=t.cloudProxyServer||"disabled";return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&(bc(t.turnServer.servers)?n.iceServers=t.turnServer.servers:w("NEW_TURN_MODE")&&n.iceServers&&r==="disabled"?(w("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&n.iceServers.push(...ld.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):n.iceServers.push(...ld.newTurnServerConfigToIceServers(t.turnServer.servers)),w("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...ld.turnServerConfigToIceServers(t.turnServer.servers)),w("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...ld.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),w("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),w("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach(r=>{r.security?r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ho(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!w("FORCE_TURN_TCP")&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),n}static newTurnServerConfigToIceServers(t){const n=[];return t.forEach(r=>{const i=w("NEW_TURN_MODE");i===1?n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}):i===2?n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}):i===3?n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ho(r.turnServerURL),":443?transport=tcp")}):i===4&&(n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}),n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}),n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ho(r.turnServerURL),":443?transport=tcp")}))}),n}tryBindTransportEvents(t){const n=t.transport;if(n){this.transportEventReceiver=t,n.onstatechange=()=>{var i;n!=null&&n.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,n.state))},n.onerror=i=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in i?i.error:i)};const r=n.iceTransport;r&&(r.onstatechange=()=>{const i=n==null?void 0:n.iceTransport.state;var o;i&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,i))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){const{local:i,remote:o}=r.getSelectedCandidatePair()||{};if(i&&o){const s=i.address+":"+i.port,c=o.address+":"+o.port;g.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(ms(s)),", remote ").concat(JSON.stringify(ms(c))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var r,i;if(n||(n=this.peerConnection.getSenders().find(R=>R.track===t._mediaStreamTrack)),!n)return g.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return g.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Xe().supportSetRtpSenderParameters)return g.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},s={};switch(t._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}const c=P1(this.peerConnection,t._mediaStreamTrack),l=vL(t);if(SM(t)&&c&&n&&l&&this.getLocalVideoStats&&Z(r=["vp8","vp9"]).call(r,this.store.codec)){var u;const v=o.degradationPreference||(Z(u=t._hints).call(u,pt.CUSTOM_TRACK)?w("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");TM(this.id+c.mid,l,this,v,R=>{n&&this.updateAdaptation(n,R)},this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var h;const{bitrateMax:v,frameRate:R,scaleResolutionDownBy:A}=t._encoderConfig;v&&(s.maxBitrate=1e3*v),(Z(h=t._hints).call(h,pt.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(R&&(s.maxFramerate=Pr(R)),A&&A>=1&&(s.scaleResolutionDownBy=A))}const{maxFramerate:f}=w("ENCODER_CONFIG_LIMIT");if(f&&typeof f=="number"&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,f):f),w("DSCP_TYPE")&&us()){var _;const v=w("DSCP_TYPE");Z(_=["very-low","low","medium","high"]).call(_,v)&&(s.networkPriority=v)}const E=n.getParameters(),I=(i=E.encodings)===null||i===void 0?void 0:i[0];kt()&&!I&&(o.encodings=[s]),I&&Object.assign(I,s),Object.assign(E,o),g.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(E.encodings))),await n.setParameters(E),await K1(this.store.codec,n,w("SVC_MODE"))}async updateAdaptation(t,n){var r,i;if(!t)return g.debug("[updateAdaptation] no rtpSender found");if(!Xe().supportSetRtpSenderParameters)return g.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const o={},{bitrateMax:s,frameRate:c,scaleResolutionDownBy:l}=n;s&&(o.maxBitrate=1e3*s),c&&(o.maxFramerate=Pr(c)),l&&l>=1&&Z(r=["vp8","vp9"]).call(r,this.store.codec)&&(o.scaleResolutionDownBy=l);const u=t.getParameters(),h=(i=u.encodings)===null||i===void 0?void 0:i[0];h&&Object.assign(h,o),Object.assign(u,{});try{await t.setParameters(u),g.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(u.encodings)))}catch(f){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?g.debug("[updateAdaptation] peerConnection not connected}"):g.debug("[updateAdaptation] updateRtpSenderEncodings failed",f):g.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,n){try{if(!Xe().supportSetRtpSenderParameters||t.length!==n.length)return;for(let r=0;r<t.length;r++){const i=t[r],o=n[r];o instanceof wt&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,i.sender)}}catch{g.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,r){if(w("FORBID_MODIFY_LOCAL_OFFER_SDP"))return t;const i=gr(t);return n.forEach((o,s)=>{const c=r[s],l=i.mediaDescriptions.find(u=>u.attributes.mid===c);l&&(Yc(l,o),MR(l,o,this.store.codec))}),js(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,r)=>{var i;(i=this.onFirstVideoDecoded)===null||i===void 0||i.call(this,t,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let l=0;l<t.length;l++){var r,i,o,s,c;const u=t[l],h=n[l];if(h instanceof wt&&!Z(r=h._hints).call(r,pt.LOW_STREAM)&&(i=h._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((o=h._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=h._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((c=h._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1&&this.store.codec==="vp8"){const f={},_={high:1e3*(h._encoderConfig.bitrateMax-50),medium:5e4};f.encodings=[{rid:"m",active:!0,maxBitrate:_.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:_.high}];const E=u.sender.getParameters();await u.sender.setParameters(Object.assign(E,f))}}}async applySimulcastEncodings(t,n){if(!kt()&&t.length===n.length)for(let r=0;r<t.length;r++){const i=n[r];if(i instanceof wt&&this.isVP8Simulcast(i)){const o=t[r],s={},c={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const l=o.sender.getParameters();await o.sender.setParameters(Object.assign(l,s))}}}isVP8Simulcast(t){var n,r,i,o,s;return!!(t instanceof wt&&w("SIMULCAST")&&this.store.codec==="vp8"&&!Z(n=t._hints).call(n,pt.LOW_STREAM)&&(r=t._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((i=t._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(o=t._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=t._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(t,n,r,i){if(w("SDP_LOGGING"))return g.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(n," SDP during P2PConnection.").concat(i,`
`),t),n==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",i)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(t){if(Xe().supportPCSetConfiguration){const n=ld.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}t.isPreallocation&&(this.isPreallocation=!0)}},ae(nt.prototype,"updateRemoteRTPCapabilities",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"updateRemoteRTPCapabilities"),nt.prototype),ae(nt.prototype,"connect",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"connect"),nt.prototype),ae(nt.prototype,"updateRemoteConnect",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"updateRemoteConnect"),nt.prototype),ae(nt.prototype,"createDataChannels",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"createDataChannels"),nt.prototype),ae(nt.prototype,"receive",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"receive"),nt.prototype),ae(nt.prototype,"batchReceive",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"batchReceive"),nt.prototype),ae(nt.prototype,"stopReceiving",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"stopReceiving"),nt.prototype),ae(nt.prototype,"muteRemote",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"muteRemote"),nt.prototype),ae(nt.prototype,"unmuteRemote",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"unmuteRemote"),nt.prototype),ae(nt.prototype,"muteLocal",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"muteLocal"),nt.prototype),ae(nt.prototype,"unmuteLocal",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"unmuteLocal"),nt.prototype),ae(nt.prototype,"close",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"close"),nt.prototype),ae(nt.prototype,"updateEncoderConfig",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"updateEncoderConfig"),nt.prototype),ae(nt.prototype,"updateSendParameters",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"updateSendParameters"),nt.prototype),ae(nt.prototype,"replaceTrack",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"replaceTrack"),nt.prototype),ae(nt.prototype,"updateAdaptation",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"updateAdaptation"),nt.prototype),ae(nt.prototype,"getRemoteSSRC",[Lr],Object.getOwnPropertyDescriptor(nt.prototype,"getRemoteSSRC"),nt.prototype),nt);function Lr(e,t,n){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,c=new Array(s),l=0;l<s;l++)c[l]=arguments[l];return await r.apply(this,c)}finally{o()}},n}function ty(e,t){let n=document.createElement("video"),r=document.createElement("canvas");n.setAttribute("style","display:none"),r.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),r.width=Pr(t.width),r.height=Pr(t.height);const i=Pr(t.framerate||15);document.body.append(n),document.body.append(r);let o=e._mediaStreamTrack;n.srcObject=new MediaStream([o]),n.play().catch(mh);const s=r.getContext("2d");if(!s)throw new B(b.UNEXPECTED_ERROR,"can not get canvas context");const c=Xe(),l=r.captureStream(c.supportRequestFrame?0:i).getVideoTracks()[0];l.canvas||(l.canvas=r),r.startCapture=()=>{if(!n)return r.stopCapture&&r.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const h=n.videoWidth,f=n.videoHeight/h,_=r.width*f;Math.abs(_-r.height)>=2&&(g.debug("adjust low stream resolution","".concat(r.width,"x").concat(r.height," -> ").concat(r.width,"x").concat(_)),r.height=_)}s.drawImage(n,0,0,r.width,r.height),l.requestFrame&&l.requestFrame(),o!==e._mediaStreamTrack&&(o=e._mediaStreamTrack,n.srcObject=new MediaStream([o]))},r.stopCapture=tR(()=>r.startCapture&&r.startCapture(),i);const u=l.stop;return l.stop=()=>{u.call(l),n&&(n.remove(),n.srcObject=null,n=null),r&&(r.width=0,r.remove(),r.stopCapture&&r.stopCapture(),r.startCapture=void 0,r.stopCapture=void 0,r=null),g.debug("clean low stream renderer")},l}var RM=function(e){return e[e.Video_Send_Type=190]="Video_Send_Type",e}(RM||{}),Wo=function(e){return e[e.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",e[e.Video_Send_Freeze=2082]="Video_Send_Freeze",e[e.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",e[e.Video_Recv_Freeze=2084]="Video_Recv_Freeze",e[e.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",e[e.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",e[e.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",e[e.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",e}(Wo||{}),Ue=function(e){return e[e.Video_Send_Retransmit=2062]="Video_Send_Retransmit",e[e.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",e[e.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",e[e.Video_Send_Transmit=2066]="Video_Send_Transmit",e[e.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",e[e.Video_Capture_Height=2033]="Video_Capture_Height",e[e.Video_Capture_Width=2035]="Video_Capture_Width",e[e.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",e[e.Video_Send_Low_Height=2073]="Video_Send_Low_Height",e[e.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",e[e.Video_Send_Low_Width=2077]="Video_Send_Low_Width",e[e.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",e[e.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",e[e.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",e[e.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",e[e.Video_Send_Width=2003]="Video_Send_Width",e[e.Video_Send_Height=2004]="Video_Send_Height",e[e.Video_Send_Disabled=2095]="Video_Send_Disabled",e[e.Video_Send_Adaptation=2032]="Video_Send_Adaptation",e[e.Video_Send_Player_Status=2128]="Video_Send_Player_Status",e[e.Video_Send_Nacks=2009]="Video_Send_Nacks",e[e.Video_Send_Plis=2010]="Video_Send_Plis",e[e.Video_Send_Firs=2011]="Video_Send_Firs",e[e.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",e[e.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",e[e.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",e[e.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",e[e.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",e[e.Video_Send_Bitrate=2012]="Video_Send_Bitrate",e[e.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",e[e.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",e[e.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",e[e.Audio_Send_Level=2038]="Audio_Send_Level",e[e.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",e[e.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",e[e.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",e[e.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",e[e.Audio_Send_Freeze=2081]="Audio_Send_Freeze",e[e.Audio_Send_Disabled=2096]="Audio_Send_Disabled",e[e.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",e[e.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",e[e.Video_Recv_Height=2019]="Video_Recv_Height",e[e.Video_Recv_Width=2018]="Video_Recv_Width",e[e.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",e[e.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",e[e.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",e[e.Video_Recv_Nacks=2026]="Video_Recv_Nacks",e[e.Video_Recv_Plis=2027]="Video_Recv_Plis",e[e.Video_Recv_Firs=2028]="Video_Recv_Firs",e[e.Video_Recv_Disabled=2101]="Video_Recv_Disabled",e[e.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",e[e.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",e[e.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",e[e.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",e[e.Audio_Render_Level=2043]="Audio_Render_Level",e[e.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",e[e.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",e[e.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",e[e.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",e[e.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",e[e.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",e[e.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",e[e.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",e[e.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",e[e.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",e[e.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",e[e.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",e}(Ue||{}),bn=function(e){return e[e.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",e[e.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",e[e.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",e[e.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",e[e.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",e[e.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",e[e.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",e[e.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",e[e.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",e[e.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",e[e.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",e[e.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",e[e.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",e[e.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",e[e.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",e[e.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",e[e.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",e[e.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",e[e.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",e[e.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",e[e.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",e[e.Audio_Recv_AV_Sync_TIME=2237]="Audio_Recv_AV_Sync_TIME",e}(bn||{}),Wn=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e[e.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",e}(Wn||{}),Ll=function(e){return e[e.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",e[e.PAGE_VISIBILITY=2233]="PAGE_VISIBILITY",e}(Ll||{}),ny=function(e){return e[e.Transport_Send_Bitrate=2234]="Transport_Send_Bitrate",e[e.Transport_Recv_Bitrate=2235]="Transport_Recv_Bitrate",e}(ny||{});const qc=1e3,Rm=6,Mh=3,VX=Math.max(Rm,Mh,60);function we(e,t,n){n!=null&&Number.isFinite(n)&&(e[t]=Math.round(Math.max(0,n)))}function yM(e){const t={[Wn.CONN_TYPE]:0,[Wn.RTT]:e.rtt,[Wn.STATS_UPDATE_INTERVAL]:e.updateInterval?Math.round(Math.max(0,e.updateInterval)):void 0};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=e.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(t[Wn.CONN_TYPE]=1),n==="tcp"&&(t[Wn.CONN_TYPE]=3),n==="tls"&&(t[Wn.CONN_TYPE]=4);break}case"srflx":t[Wn.CONN_TYPE]=2;break;case"unknown":t[Wn.CONN_TYPE]=5;break;default:t[Wn.CONN_TYPE]=0}return t}function CM(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class IM extends Wt{constructor(t){super(),y(this,"store",void 0),y(this,"uploadWRTCStatsTimer",void 0),y(this,"uploadOutboundDenoiserStatsTimer",void 0),y(this,"uploadExtStatsTimer",void 0),y(this,"uploadExtUsageStatsTimer",void 0),y(this,"uploadInboundExtStatsTimer",void 0),y(this,"requestStats",void 0),y(this,"requestTransportStats",void 0),y(this,"requestLocalMedia",void 0),y(this,"requestRemoteMedia",void 0),y(this,"requestAllTracks",void 0),y(this,"requestVideoIsReady",void 0),y(this,"requestUploadStats",void 0),y(this,"requestUpload",void 0),y(this,"uploadOutboundStarted",!1),y(this,"uploadInboundStarted",!1),y(this,"uploadTransportStarted",!1),y(this,"uploadBaseStatsStarted",!1),y(this,"uploadExtensionUsageStarted",!1),y(this,"lastRecvStats",void 0),y(this,"lastSendStats",void 0),y(this,"lastRefRecvStats",void 0),y(this,"lastRefSendStats",void 0),y(this,"lastNormalRecvStats",void 0),y(this,"lastNormalSendStats",void 0),y(this,"lastExtendStats",{}),y(this,"needUploadStats",{}),y(this,"needUploadRenderFreezeTime",!0),y(this,"lastUploadCompensateTime",-1),y(this,"uploadCompensateDeltaTime",0),this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;const n=t%Mh==0,r=t%Rm==0,i=t%60==0;let o,s;if(this.uploadTransportStarted&&(o=this.requestStats(),this.store.useP2P&&(s=this.requestStats(!0))),!o&&this.uploadOutboundStarted&&(o=this.requestStats()),!s&&this.uploadInboundStarted&&(s=this.requestStats(!0)),o||s){var c;const l={};if(this.uploadTransportStarted&&o){const h=this.getTransportStats(o,n?this.lastRefSendStats:void 0,s,n);h&&(l.misc=[h])}if(this.uploadOutboundStarted&&o){const h=this.getOutboundStats(o,r?this.lastNormalSendStats:void 0,n?this.lastRefSendStats:void 0,this.lastSendStats,i);h&&(l.outbound=[h])}if(this.uploadInboundStarted&&s){this.uploadCompensateStats(t);const h=this.getInboundStats(s,r?this.lastNormalRecvStats:void 0,n?this.lastRefRecvStats:void 0,this.lastRecvStats);h&&(l.inbound=h)}const u=(c=this.requestTransportStats)===null||c===void 0?void 0:c.call(this).connectState;if(u&&(Array.isArray(l.misc)?l.misc[0]&&l.misc[0].addition&&(l.misc[0].addition[Ll.RTC_PEER_CONNECTION_STATE]=Fv[u]):l.misc=[{addition:{[Ll.RTC_PEER_CONNECTION_STATE]:Fv[u]}}]),ri.needUploadStats.length>0||r){const h=ri.needUploadStats.shift()||(ri.visibility==="visible"?1:0);Array.isArray(l.misc)?l.misc[0]&&l.misc[0].addition&&(l.misc[0].addition[Ll.PAGE_VISIBILITY]=h):l.misc=[{addition:{[Ll.PAGE_VISIBILITY]:h}}]}this.needUploadStats.sendType&&(Array.isArray(l.outbound)&&l.outbound[0]&&l.outbound[0].high&&(l.outbound[0].high[RM.Video_Send_Type]=this.needUploadStats.sendType),this.needUploadStats.sendType=void 0),this.requestUploadStats(l)}this.lastRecvStats=s,this.lastSendStats=o,r&&(this.lastNormalRecvStats=s,this.lastNormalSendStats=o),n&&(this.lastRefRecvStats=s,this.lastRefSendStats=o)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0,ri.startCollectStats();let t=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var n,r;const i=(n=this.requestTransportStats)===null||n===void 0?void 0:n.call(this);return void(i&&((r=this.requestUploadStats)===null||r===void 0||r.call(this,{misc:[{addition:{[Ll.RTC_PEER_CONNECTION_STATE]:Fv[i.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(t),++t===VX+1&&(t=1)},qc)}uploadCompensateStats(t){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const n=t%Mh==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!n)return;if(this.lastUploadCompensateTime===-1)return void(this.lastUploadCompensateTime=Date.now());const r=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=r,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;const i=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*i;const o=this.requestStats(!0);new Array(i).fill(0).forEach(()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;const s={};if(this.uploadInboundStarted&&o){const c=this.requestRemoteMedia()||[],l=[];c.forEach(u=>{let[h,f]=u;const _={peer:h.uid};if(h._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(h._videoSSRC)&&f.has(ue.VIDEO)&&h.videoTrack){const E=function(I,v,R){if(!v.videoRecv.find(O=>O.ssrc===I))return;const A={};if(R&&R._player){const O=R._player,{renderFreezeAccTime2:P,videoElementStatus:M}=O;if(ri.visibility==="visible"&&M===$n.PLAYING&&Xe().supportRequestVideoFrameCallback){const U=Math.min(6e3,P);O.renderFreezeAccTime2=Math.max(0,P-U),we(A,Wo.Video_Render_Freeze_Time_Render2,U),w("USE_NEW_RENDER_FREEZE_TIME")&&we(A,Wo.Video_Render_Freeze_Time_Render,U)}}return A}(h._videoSSRC,o,h.videoTrack);E&&(_.video=E)}_.video&&l.push(_)}),l.length>0&&(s.inbound=l,this.requestUploadStats(s))}})}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(t,n,r,i){if(!this.requestStats)return;if(!i)return t.rtt==null?void 0:{addition:{[Wn.RTT]:t.rtt,[Wn.CONN_TYPE]:void 0,[Wn.STATS_UPDATE_INTERVAL]:t.updateInterval||void 0}};const o=yM(t);if(this.store.useP2P){if(r){const s=yM(r);o[Wn.CONN_TYPE]&&s[Wn.CONN_TYPE]&&(o[Wn.CONN_TYPE]+=s[Wn.CONN_TYPE]<<3)}o[Wn.CONN_TYPE]?o[Wn.CONN_TYPE]+=110:o[Wn.CONN_TYPE]=110}else{o[Wn.CONN_TYPE]?o[Wn.CONN_TYPE]+=100:o[Wn.CONN_TYPE]=100;const s=function(c,l){return l?[Math.ceil(8*(c.transport.bytesSent-l.transport.bytesSent)/(c.timestamp-l.timestamp)),Math.ceil(8*(c.transport.bytesReceived-l.transport.bytesReceived)/(c.timestamp-l.timestamp))]:[0,0]}(t,n);o[ny.Transport_Send_Bitrate]=s[0],o[ny.Transport_Recv_Bitrate]=s[1]}return{addition:o}}getOutboundStats(t,n,r,i,o){if(!this.requestUploadStats||!this.requestLocalMedia)return;const s=this.requestLocalMedia();if(!s||s.length===0)return;let c,l,u;return s.forEach(h=>{let[f,{track:_,ssrcs:E}]=h;switch(f){case $.LocalVideoLowTrack:case $.LocalVideoTrack:if(f===$.LocalVideoTrack){var I;const v=function(P,M,U,L,V,H){const q=M.videoSend.find(Ge=>Ge.ssrc===P);if(!q)return;const de={},{sentFrame:Ne,inputFrame:Ae}=q;if(L&&(we(de,Wo.Video_Send_Qp_Sum,q.qpSumPerFrame),Ae&&Ne)){const Ge=Ae.frameRate,xe=Ne.frameRate;de[Wo.Video_Send_Freeze]=function(ct,jt){let Y=!0;return Y=!(ct<=5)&&(ct<=10?jt<3:ct<=20?jt<4:jt<5),Y}(Ge,xe)?1:0}if(V){switch(Ne&&(we(de,Ue.Video_Send_Height,Ne.height),we(de,Ue.Video_Send_Width,Ne.width),we(de,Ue.Video_Send_Frame_Rate,Ne.frameRate)),de[Ue.Video_Send_Disabled]=U._originMediaStreamTrack&&!U._originMediaStreamTrack.enabled||U._mediaStreamTrack&&!U._mediaStreamTrack.enabled?1:0,q.adaptionChangeReason){case"none":de[Ue.Video_Send_Adaptation]=0;break;case"cpu":de[Ue.Video_Send_Adaptation]=1;break;case"bandwidth":de[Ue.Video_Send_Adaptation]=2;break;case"other":de[Ue.Video_Send_Adaptation]=3}let Ge=0;q.adaptionChangeReason&&(Ge+=CM(q.adaptionChangeReason)),M.qualityLimitationReason&&(Ge+=CM(M.qualityLimitationReason)<<3),de[Ue.Video_Send_Adaptation]=Ge,de[Ue.Video_Send_Player_Status]=Zv[U._player?U._player.videoElementStatus:"uninit"],we(de,Ue.Video_Send_Nacks,q.nacksCount),we(de,Ue.Video_Send_Plis,q.plisCount),we(de,Ue.Video_Send_Firs,q.firsCount),we(de,Ue.Video_Send_Avg_Encode,q.avgEncodeMs),we(de,Ue.Video_Send_Huge_Frame_Sent,q.hugeFramesSent),we(de,Ue.Video_Send_Bytes_Retransmit,q.retransmittedBytesSent),we(de,Ue.Video_Send_Packages_Retransmit,q.retransmittedPacketsSent),we(de,Ue.Video_Send_Key_Frames_Encoded,q.keyFramesEncoded);const xe=V.videoSend.find(ct=>ct.ssrc===P);if(xe){let ct=qc*Mh;xe.timestamp&&q.timestamp&&(ct=q.timestamp-xe.timestamp),xe.packets!=null&&q.packets!=null&&we(de,Ue.Video_Send_Package_Rate,1e3*(q.packets-xe.packets)/ct),q.packetsLost!=null&&xe.packetsLost!=null&&we(de,Ue.Video_Send_Package_Lost,q.packetsLost-xe.packetsLost),xe.bytes!=null&&q.bytes!=null&&we(de,Ue.Video_Send_Bitrate,8*(q.bytes-xe.bytes)/ct)}}return de}(E[0].ssrcId,t,_,n,r),R=_.__className__==="CameraVideoTrack"?3:Z(I=_._hints).call(I,pt.SCREEN_TRACK)?7:10;(this.lastExtendStats.sendType!==R||o)&&(this.needUploadStats={sendType:R},this.lastExtendStats.sendType=R);const A=_&&function(P,M,U,L){const V=M.videoSend.find(q=>q.ssrc===P);if(!V)return null;const H={};if(L){const q=V.inputFrame,de=q&&q.height||U.videoHeight||0,Ne=q&&q.width||U.videoWidth||0,Ae=q&&q.frameRate||0;we(H,Ue.Video_Capture_Height,de),we(H,Ue.Video_Capture_Width,Ne),we(H,Ue.Video_Capture_Frame_Rate,Ae)}return H}(E[0].ssrcId,t,_,!!r),O=function(P,M){const U={};return M&&(we(U,Ue.Video_Send_Retransmit,P.bitrate.retransmit),we(U,Ue.Video_Send_Target_Encoded,P.bitrate.targetEncoded),we(U,Ue.Video_Send_Actual_Encoded,P.bitrate.actualEncoded),we(U,Ue.Video_Send_Transmit,P.bitrate.transmit),we(U,Ue.Video_Send_Bandwidth,P.sendBandwidth)),U}(t,!!r);l=Object.assign({},v,A,O)}else u=function(v,R,A,O,P){const M=R.videoSend.find(L=>L.ssrc===v);if(!M)return;const U={};if(O){const L=M.sentFrame;L&&(we(U,Ue.Video_Send_Low_Height,L.height),we(U,Ue.Video_Send_Low_Width,L.width),we(U,Ue.Video_Send_Low_Frame_Rate,L.frameRate));const V=O.videoSend.find(H=>H.ssrc===v);if(V){let H=qc*Rm;V.timestamp&&M.timestamp&&(H=M.timestamp-V.timestamp),V.packets!=null&&M.packets!=null&&we(U,Ue.Video_Send_Low_Package_Rate,1e3*(M.packets-V.packets)/H),M.packetsLost!=null&&V.packetsLost!=null&&we(U,Ue.Video_Send_Low_Package_Lost,M.packetsLost-V.packetsLost),V.bytes!=null&&M.bytes!=null&&we(U,Ue.Video_Send_Low_Bitrate,8*(M.bytes-V.bytes)/H)}}return U}(E[0].ssrcId,t,0,r);break;case $.LocalAudioTrack:c=_&&function(v,R,A,O,P,M){const U=R.audioSend.find(V=>V.ssrc===v);if(!U)return;const L={};if(P){L[Ue.Audio_Send_Disabled]=A._originMediaStreamTrack&&!A._originMediaStreamTrack.enabled||A._mediaStreamTrack&&!A._mediaStreamTrack.enabled?1:0;const V=100*A._source.getAccurateVolumeLevel(),H=U.inputLevel;if(H!=null){const de=Math.ceil(50*Math.log10(100*H+1));we(L,Ue.Audio_Send_Level,de)}we(L,Ue.Audio_Capture_PCM_Level,V),we(L,Ue.Audio_Send_AEC_Return_Loss,U.aecReturnLoss),we(L,Ue.Audio_Send_AEC_Return_Loss_Enhancement,U.aecReturnLossEnhancement),we(L,Ue.Audio_Send_Bytes_Retransmit,U.retransmittedBytesSent),we(L,Ue.Audio_Send_Packages_Retransmit,U.retransmittedPacketsSent),L[Ue.Audio_Send_Freeze]=0;const q=P.audioSend.find(de=>de.ssrc===v);if(q){let de=qc*Rm;q.timestamp&&U.timestamp&&(de=U.timestamp-q.timestamp),q.bytes!=null&&U.bytes!=null&&we(L,Ue.Audio_Send_Bitrate,8*(U.bytes-q.bytes)/de),q.packets!=null&&U.packets!=null&&we(L,Ue.Audio_Send_Package_Rate,1e3*(U.packets-q.packets)/de)}}return L}(E[0].ssrcId,t,_,0,r)}}),{high:l,low:u,audio:c}}getInboundStats(t,n,r,i){if(!this.requestRemoteMedia)return;const o=this.requestRemoteMedia()||[],s=[];return o.forEach(c=>{let[l,u]=c;const h={peer:l.uid};let f;if(u.has(ue.VIDEO)&&l.videoTrack){const _=l._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(l._videoSSRC)||!1,E=l.videoTrack?function(I,v,R,A,O,P,M,U){const L=v.videoRecv.find(xe=>xe.ssrc===I);if(!L)return;const V={},{receivedFrame:H,outputFrame:q,decodeFrameRate:de}=L;we(V,bn.Video_Render_Frame_Rate_Decode,de),L.framesRateFirefox&&we(V,bn.Video_Recv_Frame_Rate,L.framesRateFirefox),H&&we(V,bn.Video_Recv_Frame_Rate,H.frameRate),we(V,bn.Video_Recv_Frame_Dropped,L.framesDroppedCount),we(V,bn.Video_Recv_Bytes_Retransmit,L.retransmittedBytesReceived),we(V,bn.Video_Recv_Packages_Retransmit,L.retransmittedPacketsReceived),we(V,bn.Video_Recv_Packages_Discarded,L.packetsDiscarded),we(V,bn.Video_Recv_Avg_Decode,L.avgDecodeMs),we(V,bn.Video_Recv_Avg_Processing_Delay,L.avgProcessingDelayMs),we(V,bn.Video_Recv_Avg_Assembly_Time,L.avgFramesAssembledFromMultiplePacketsMs),we(V,bn.Video_Recv_Avg_Inter_Frame_Delay,L.avgInterFrameDelayMs),we(V,bn.Video_Recv_Key_Frames_Decoded,L.keyFramesDecoded);const Ne=U&&U.videoRecv.find(xe=>xe.ssrc===I);if(Ne){const xe=v.timestamp-U.timestamp||qc;L.packetsLost!=null&&Ne.packetsLost!=null&&we(V,bn.Video_Recv_Package_Lost,L.packetsLost-Ne.packetsLost),Ne.bytes!=null&&L.bytes!=null&&we(V,bn.Video_Recv_Bitrate,8*(L.bytes-Ne.bytes)/xe),Ne.packets!=null&&L.packets!=null&&we(V,bn.Video_Recv_Package_Rate,1e3*(L.packets-Ne.packets)/xe)}const Ae=P&&P.videoRecv.find(xe=>xe.ssrc===I);if(Ae&&(we(V,Wo.Video_Recv_Qp_Sum,L.qpSumPerFrame),V[Wo.Video_Recv_Freeze]=A&&Lh.isRemoteVideoFreeze(R,L,Ae)?1:0),M){var Ge;const xe=M.videoRecv.find(jt=>jt.ssrc===I);H?(we(V,Ue.Video_Recv_Height,H.height),we(V,Ue.Video_Recv_Width,H.width)):R&&(we(V,Ue.Video_Recv_Height,R._videoHeight||0),we(V,Ue.Video_Recv_Width,R._videoWidth||0)),q&&we(V,Ue.Video_Recv_Frame_Rate_Output,q.frameRate);const ct=(Ge=R._player)===null||Ge===void 0?void 0:Ge.rendFrameRate.toFixed(0);if(ct&&we(V,Ue.Video_Render_Frame_Rate_Render,+ct),we(V,Ue.Video_Recv_Jitter_Buffer,L.jitterBufferMs),we(V,Ue.Video_Recv_Current_Delay,L.currentDelayMs),we(V,Ue.Video_Recv_Firs,L.firsCount),we(V,Ue.Video_Recv_Nacks,L.nacksCount),we(V,Ue.Video_Recv_Plis,L.plisCount),R){V[Ue.Video_Recv_Disabled]=R._originMediaStreamTrack.enabled&&R._mediaStreamTrack.enabled?0:1;const jt=R._player;if(jt){const{freezeTimeCounterList:Y,renderFreezeAccTime:ne,renderFreezeAccTime2:he,videoElementStatus:z}=jt;if(Y&&Y.length>0&&we(V,Wo.Video_Render_Freeze_Time,Y.splice(0,1)[0]),O&&ri.visibility==="visible"&&z===$n.PLAYING&&Xe().supportRequestVideoFrameCallback){const T=Math.min(6e3,he);jt.renderFreezeAccTime2=Math.max(0,he-T),we(V,Wo.Video_Render_Freeze_Time_Render2,T);const D=Math.min(6e3,ne);jt.renderFreezeAccTime=Math.max(0,ne-D),we(V,Wo.Video_Render_Freeze_Time_Render,w("USE_NEW_RENDER_FREEZE_TIME")?T:D)}if(typeof L.totalFreezesDuration=="number"){const T=xe&&xe.totalFreezesDuration?L.totalFreezesDuration-xe.totalFreezesDuration:L.totalFreezesDuration;we(V,Ue.Video_Render_Freeze_Duration,1e3*T)}}}if(V[Ue.Video_Recv_Player_Status]=Zv[R._player?R._player.videoElementStatus:"uninit"],xe&&L.totalInterFrameDelay!==void 0&&L.totalSquaredInterFrameDelay!==void 0&&xe.totalInterFrameDelay!==void 0&&xe.totalSquaredInterFrameDelay!==void 0){const jt=L.totalInterFrameDelay-xe.totalInterFrameDelay,Y=L.totalSquaredInterFrameDelay-xe.totalSquaredInterFrameDelay,ne=L.framesDecodeCount-xe.framesDecodeCount,he=jt/ne*1e3,z=Math.round(1e3*Math.sqrt((Y-Math.pow(jt,2)/ne)/ne));!isNaN(z)&&he+z>Math.max(3*he,he+150)&&(V[Ue.Video_Recv_I_Frame_Delay]=z)}}return V}(l._videoSSRC,t,l.videoTrack,_===!0,this.needUploadRenderFreezeTime,n,r,i):void 0;if(E&&(h.video=E),l.videoTrack){const I=t.videoRecv.find(v=>v.ssrc===l._videoSSRC);I&&I.estimatedPlayoutTimestamp&&(f=I.estimatedPlayoutTimestamp)}}if(u.has(ue.AUDIO)&&l.audioTrack){const _=l.audioTrack?function(E,I,v,R,A,O){const P=I.audioRecv.find(V=>V.ssrc===E);if(!P)return;const M={};we(M,bn.Audio_Recv_Jitter,P.jitterMs),we(M,bn.Audio_Recv_Bytes_Retransmit,P.retransmittedBytesReceived),we(M,bn.Audio_Recv_Packages_Retransmit,P.retransmittedPacketsReceived),we(M,bn.Audio_Recv_Packages_Discarded,P.packetsDiscarded),we(M,bn.Audio_Recv_Avg_Processing_Delay,P.avgProcessingDelayMs);const U=O&&O.audioRecv.find(V=>V.ssrc===E);if(U){const V=qc;P.packets!=null&&U.packets!=null&&we(M,bn.Audio_Recv_Package_Rate,1e3*(P.packets-U.packets)/V),P.packetsLost!=null&&U.packetsLost!=null&&we(M,bn.Audio_Recv_Package_Lost,P.packetsLost-U.packetsLost)}if(R){const{receivedFrames:V,droppedFrames:H}=P;V!=null&&H!=null&&(M[Wo.Audio_Recv_Freeze]=(L=V)===0||100*H/L>20?1:0)}var L;if(A){const V=100*v._source.getAccurateVolumeLevel(),H=P.outputLevel;if(H!=null){const de=Math.ceil(50*Math.log10(100*H+1));we(M,Ue.Audio_Render_Level,de)}we(M,Ue.Audio_Recv_PCM_Level,V),v&&(M[Ue.Audio_Recv_Disabled]=v._originMediaStreamTrack.enabled&&v._mediaStreamTrack.enabled?0:1),we(M,Ue.Audio_Recv_Jitter_Buffer,P.jitterBufferMs),we(M,Ue.Audio_Recv_Current_Delay,P.jitterBufferMs),M[Ue.Audio_Recv_Player_Status]=Zv[dr.getPlayerState(v.getTrackId())];const q=A.audioRecv.find(de=>de.ssrc===E);if(q){q.bytes!=null&&P.bytes!=null&&we(M,Ue.Audio_Recv_Bitrate,8*(P.bytes-q.bytes)/(qc*Mh));const de=P.concealedSamples-q.concealedSamples;de>0&&we(M,Ue.Audio_Recv_Concealed_Samples,de);const Ne=P.totalSamplesReceived-q.totalSamplesReceived;Ne>0&&we(M,Ue.Audio_Recv_Total_Samples_Received,Ne);const Ae=P.freezeSamples80-q.freezeSamples80;Ae>0&&we(M,Ue.Audio_Render_Freeze_Samples_80ms,Ae);const Ge=P.freezeSamples200-q.freezeSamples200;Ge>0&&we(M,Ue.Audio_Render_Freeze_Samples_200ms,Ge);const xe=P.freezeMs80-q.freezeMs80;we(M,Ue.Audio_Render_Freeze_Time_80ms,xe<0?0:xe);const ct=P.freezeMs200-q.freezeMs200;we(M,Ue.Audio_Render_Freeze_Time_200ms,ct<0?0:ct)}}return M}(l._audioSSRC,t,l.audioTrack,n,r,i):void 0;if(_&&(h.audio=_),l.audioTrack&&f){const E=t.audioRecv.find(I=>I.ssrc===l._audioSSRC);if(E&&E.estimatedPlayoutTimestamp){const I=E.estimatedPlayoutTimestamp-f;h.audio?h.audio[bn.Audio_Recv_AV_Sync_TIME]=I:h.audio={[bn.Audio_Recv_AV_Sync_TIME]:I}}}}(h.video||h.audio)&&s.push(h)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,s}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const t=(this.requestAllTracks()||[]).find(n=>n instanceof Rh);if(t&&t._external.getDenoiserStats){const n=t._external.getDenoiserStats();n&&this.requestUpload(Hc.DENOISER_STATS,n)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(t=>{t.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastExtendStats={},this.needUploadStats={},this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(t=>{let[n,r]=t;r.has(ue.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)}),r.has(ue.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const t=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const n=Date.now(),r={connectionInterval:w("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n};let i=[];const o=this.requestAllTracks&&this.requestAllTracks()||[];for(const u of o)!u.muted&&u.enabled&&(i=i.concat(await u.getProcessorUsage()));const s=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[u,h]of s)h.has(ue.VIDEO)&&u.videoTrack&&(i=i.concat(await u.videoTrack.getProcessorUsage())),h.has(ue.AUDIO)&&u.audioTrack&&(i=i.concat(await u.audioTrack.getProcessorUsage()));if(i.length===0)return;r.details=function(u,h){const f={};for(const{id:v,value:R,level:A,direction:O}of u){var _;const P=(_=h.get(v))!==null&&_!==void 0?_:0,M=R===2?P+w("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:P;var E,I;h.set(v,M),f[v]?(R===2&&(f[v].value=R),A>f[v].level&&(f[v].level=A),O==="remote"&&(f[v].remoteUidCount+=1),f[v].totalTs=(E=h.get(v))!==null&&E!==void 0?E:0):f[v]={value:R,level:A,remoteUidCount:O==="local"?0:1,totalTs:(I=h.get(v))!==null&&I!==void 0?I:0}}return Object.keys(f).map(v=>{const{level:R,value:A,totalTs:O}=f[v];return{id:v,level:R,value:A,totalTs:O}})}(i,t);const c=Date.now(),l=c>n?c:n+1;this.requestUpload&&this.requestUpload(Hc.EXTENSION_USAGE_STATS,{usageStats:r,sendTs:l})},w("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1,ri.stopCollectStats()}}const FX=w("ICE_RESTART_INTERVAL");let ym=new Map,kl=new Map,Na=[kn.UDP_TCP_RELAY,kn.TCP_RELAY,kn.RELAY],ry=w("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Xe().supportPCSetConfiguration;function wM(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=ym.get(e.id);n&&(window.clearTimeout(n),ym.delete(e.id));const r=kl.get(e.id);t&&r&&r.index===Na.length-1&&(g.debug("[".concat(e.id,"] reset ICE restart policy")),kl.delete(e.id))}function AM(e,t,n){if(ym.size===0&&kl.size===0&&(Array.isArray(w("RESTART_SEQUENCE"))&&w("RESTART_SEQUENCE").length>0&&!function(c,l){if(c.length!==l.length)return!1;for(let u=0;u<c.length;u+=1){const h=c[u];if(c.filter(f=>f===h).length!==l.filter(f=>f===h).length)return!1}return!0}(Na,w("RESTART_SEQUENCE"))&&(Na=w("RESTART_SEQUENCE").filter(c=>{var l;if(Z(l=Object.values(kn)).call(l,c))return!0}),g.debug("use reconnection policy from config distribution, queues: ".concat(Na.join(" => ")))),ry=w("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Xe().supportPCSetConfiguration),Na.length===0)return void n();let r,{index:i=0,type:o}=kl.get(e.id)||{};if(ry&&o===kn.RELAY)return void n();let s=o&&i>=Na.length-1;if(ry)o=kn.RELAY;else{if(s)return void n();o?(i++,o=Na[i]):(o=Na[0],i=0)}g.debug("[".concat(e.id,"] choose ICE restart policy: ").concat(o,", index: ").concat(i)),t(o),kl.set(e.id,{index:i,type:o}),r=window.setTimeout(()=>AM(e,t,n),FX),ym.set(e.id,r)}var Qe;function bM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Ts(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?bM(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):bM(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}function OM(e){var t,n,r,i=2;for(typeof Symbol<"u"&&(n=m_,r=Symbol.iterator);i--;){if(n&&(t=e[n])!=null)return t.call(e);if(r&&(t=e[r])!=null)return new Cm(t.call(e));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function Cm(e){function t(n){if(Object(n)!==n)return se.reject(new TypeError(n+" is not an object."));var r=n.done;return se.resolve(n.value).then(function(i){return{value:i,done:r}})}return Cm=function(n){this.s=n,this.n=n.next},Cm.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return r===void 0?se.resolve({value:n,done:!0}):t(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return r===void 0?se.reject(n):t(r.apply(this.s,arguments))}},new Cm(e)}let Xc=(Qe=class extends Wt{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Se.StateChange,t,this._state)}constructor(e,t){super(),y(this,"isPlanB",void 0),y(this,"store",void 0),y(this,"statsUploader",void 0),y(this,"connection",void 0),y(this,"localTrackMap",new Map),y(this,"remoteUserMap",new Map),y(this,"localDataChannels",[]),y(this,"remoteDataChannelMap",new Map),y(this,"pendingLocalTracks",[]),y(this,"pendingRemoteTracks",[]),y(this,"pendingLocalDataChannels",[]),y(this,"pendingRemoteDataChannels",[]),y(this,"statsCollector",void 0),y(this,"shouldForwardP2PCreation",void 0),y(this,"iceFailedCount",0),y(this,"dtlsFailedCount",0),y(this,"mutex",void 0),y(this,"_state",ut.Disconnected),y(this,"_pcStatsUploadType",w("NEW_ICE_RESTART")?Hs.FIRST_CONNECTION:Hs.OLD_FIRST_CONNECTION),y(this,"_isStartRestartIce",!1),y(this,"_restartTimer",void 0),y(this,"_isTryConnecting",!1),y(this,"_iceError",null),y(this,"_forceTurn",!1),y(this,"_isWaitPcToRePub",!1),y(this,"handleMuteLocalTrack",async(n,r,i)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==ut.Connected)return void i(new W(b.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(n);if(s.length===0)return void r();const c=s.find(u=>u[0]==="videoLowTrack");if(c){const u=c[1];this.store.enableInstantMuteRestore?(u.track._originMediaStreamTrack.enabled=!1,g.info("[".concat(this.store.clientId,"] P2PChannel muteLocalLowTrack without close sender because enableInstantMuteRestore is true"))):u.track._originMediaStreamTrack.stop()}this.store.enableInstantMuteRestore?g.info("[".concat(this.store.clientId,"] P2PChannel muteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.muteLocal(s.map(u=>{let[,{id:h}]=u;return h}));const l=this.createMuteMessage(s);await Ot(this,Se.RequestMuteLocal,l),r()}catch(s){i(s)}finally{o()}}),y(this,"handleUnmuteLocalTrack",async(n,r,i)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==ut.Connected)return void i(new W(b.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void r();const c=s.find(u=>u[0]==="videoLowTrack");if(c){const u=c[1];if(this.store.enableInstantMuteRestore)u.track._originMediaStreamTrack.enabled=!0,g.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalLowTrack without close sender because enableInstantMuteRestore is true"));else{if(u.track._originMediaStreamTrack.stop(),!w("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding){const h=n._mediaStreamTrack.clone();u.track._mediaStreamTrack=h,u.track._originMediaStreamTrack=h}else{const h=ty(n,Nc(this,Se.RequestLowStreamParameter));u.track._mediaStreamTrack=h,u.track._originMediaStreamTrack=h}await new se((h,f)=>{this.handleReplaceTrack(u.track,h,f,!0)})}}this.store.enableInstantMuteRestore?g.info("[".concat(this.store.clientId,"] P2PChannel unmuteLocalTrack without close sender because enableInstantMuteRestore is true")):await this.connection.unmuteLocal(s.map(u=>{let[,{id:h}]=u;return h}));const l=this.createUnmuteMessage(s);await Ot(this,Se.RequestUnmuteLocal,l),r()}catch(s){i(s)}finally{o()}}),y(this,"handleUpdateVideoEncoder",async(n,r,i,o)=>{let s;o||(s=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{const l=this.localTrackMap.get($.LocalVideoTrack);if(!this.connection||!l||l.track!==n||this.state!==ut.Connected)return void r();const{id:u,track:h}=l;await this.connection.updateSendParameters(u,h),await this.connection.updateEncoderConfig(u,h),this.emit(Se.UpdateVideoEncoder,h),r()}catch(l){i(l)}finally{var c;(c=s)===null||c===void 0||c()}}),y(this,"handleUpdateVideoSendParameters",async(n,r,i)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const s=this.localTrackMap.get($.LocalVideoTrack);if(!this.connection||!s||s.track!==n||this.state!==ut.Connected)return void r();const{id:c,track:l}=s;await this.connection.updateSendParameters(c,l),r()}catch(s){i(s)}finally{o()}}),y(this,"handleReplaceMixingTrack",async(n,r,i,o)=>{if(!this.connection||this.state!==ut.Connected)return void r();const s=ZR([n]);let c;g.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(s.getTrackId(),"]")),typeof o=="boolean"&&o||(c=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(n,s),r()}catch(u){i(u)}finally{var l;(l=c)===null||l===void 0||l()}}),y(this,"handleReplaceTrack",async(n,r,i,o)=>{let s;g.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var c;const u=Array.from(this.localTrackMap.entries()).find(h=>{let[,{track:f}]=h;return n===f});if(!this.connection||!u||this.state!==ut.Connected)return void r();if(await((c=this.connection)===null||c===void 0?void 0:c.replaceTrack(n,u[1].id)),this.isPlanB){const h=u[1];h.id=n._mediaStreamTrack.id,this.localTrackMap.set(u[0],h)}if(u[0]===$.LocalVideoTrack&&!w("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding){const h=this.localTrackMap.get($.LocalVideoLowTrack);if(h){const f=n._mediaStreamTrack.clone();h.track._originMediaStreamTrack.stop(),h.track._mediaStreamTrack=f,h.track._originMediaStreamTrack=f,await new se((_,E)=>{this.handleReplaceTrack(h.track,_,E,!0)})}}r()}catch(u){i(u)}finally{var l;(l=s)===null||l===void 0||l()}}),y(this,"handleGetRTCStats",n=>{n(this.statsCollector.getRTCStats())}),y(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),y(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),y(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),y(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new IM(this.store),this.bindStatsUploaderEvents(),this.mutex=new Ln("P2PChannel-mutex",this.store.clientId),this.isPlanB=!Xe().supportUnifiedPlan||w("CHROME_FORCE_PLAN_B")&&us(),this.shouldForwardP2PCreation=w("FORWARD_P2P_CREATION")&&Xe().supportPCSetConfiguration&&hP(),this.shouldForwardP2PCreation&&(this.connection=kh(this.store),this.emit(Se.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var n;this.state=ut.New,this._forceTurn=ey(e),g.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));const r=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if((!this.shouldForwardP2PCreation||r||t)&&((r||t)&&this.connection&&(g.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=kh(this.store,e),this.emit(Se.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new W(b.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=w("NEW_ICE_RESTART")?Hs.FIRST_CONNECTION:Hs.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e){if(!this.connection)throw new W(b.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");if(!this.isPreallocation()||this.state!==ut.Connected){this.store.peerConnectionStart();const t=await this.connection.connect(e);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=ut.Connected,t}if(this.connection instanceof vi&&this.connection.checkDtlsParameters(e.dtlsParameters.fingerprints))return g.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] dtls parameters mismatch, try next.")),pe.reportApiInvoke(this.store.sessionId,{name:Ft.MISMATCH_DTLS_PARAMETERS,options:[e.dtlsParameters.fingerprints],tag:It.TRACER}).onSuccess(),void setTimeout(()=>{this.emit(Se.RequestReconnect)});await this.connection.updateRemoteConnect(e)}updateRemoteRTPCapabilities(e){const t=Array.from(this.localTrackMap.entries()).filter(i=>{var o;let[s]=i;return Z(o=[$.LocalVideoLowTrack,$.LocalVideoTrack]).call(o,s)}),n=t.map(i=>{let[,{id:o}]=i;return o}),r=t.map(i=>{let[o]=i;return o});if(this.connection instanceof vi||this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"){if(pe.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(r),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!Z(e).call(e,this.store.codec)){const i=["vp9","vp8","h264"].find(o=>Z(e).call(e,o));i&&(this.store.codec=i,g.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(i,".")))}this.connection.updateRemoteRTPCapabilities(n,e)}}async getEstablishParams(){var e;return this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof vi&&this.connection.peerConnectionState!=="closed"&&Z(e=[ut.New,ut.Connected]).call(e,this.state)?this.connection.establishPromise:void 0}async publishDataChannel(e){if(!this.connection||this.state!==ut.Connected){if(this.state===ut.Disconnected)throw new W(b.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return e.forEach(n=>{var r;Z(r=this.pendingLocalDataChannels).call(r,n)||this.pendingLocalDataChannels.push(n)}),[]}const t=this.filterTobePublishedDataChannels(e);return t.length===0?[]:(t.forEach(n=>{const r=Date.now();this.store.publish(n.id.toString(),"datachannel",r)}),await this.connection.createDataChannels(this.store.uid,t),t.forEach(n=>{this.localDataChannels.push(n);const r=Date.now();this.store.publish(n.id+"","datachannel",void 0,r)}),e.map(n=>({streamId:n.id,ordered:n.ordered,maxRetransmits:n.maxRetransmits,metadata:n.metadata,channelId:n._originDataChannelId})))}publish(e,t,n){var r=this;return Ar(function*(){const i=yield We(r.mutex.lock("From P2PChannel.publish"));try{var o;const s=r.connection&&Z(o=["disconnected","failed"]).call(o,r.connection.peerConnectionState);if(!r.connection||r.state!==ut.Connected||s){if(r.state===ut.Disconnected)throw new W(b.UNEXPECTED_ERROR,"PeerConnection already disconnected.");r.throwIfTrackTypeNotMatch(e);const l=e.filter(u=>r.pendingLocalTracks.indexOf(u)===-1);return r.pendingLocalTracks=r.pendingLocalTracks.concat(l),void(s&&(r._isWaitPcToRePub=!0))}r.store.pubId=r.store.pubId+1,tr.markPublishStart(r.store.clientId,r.store.pubId);const c=r.filterTobePublishedTracks(e,t,n);if(c.length===0)return void(yield We(r.tryToUnmuteAudio(e)));yield*rl(OM(r.doPublish(r.connection,c)))}finally{i()}})()}doPublish(e,t){var n=this;return Ar(function*(){t.forEach(_=>{let{track:E,type:I}=_;const v=Date.now();n.store.publish(E.getTrackId(),I===$.LocalAudioTrack?"audio":"video",v)}),n.bindLocalTrackEvents(t);const r=t.map(_=>{let{track:E}=_;return E}),i=yield We(e.send(r,n.store.codec,n.store.audioCodec)),o=(yield We(i.next())).value,s=n.createGatewayPublishMessage(t,o);let c;try{c=yield s}catch(_){throw i.throw(_),(_==null?void 0:_.code)===b.WS_ABORT&&t.forEach(E=>{let{track:I}=E;n.pendingLocalTracks.indexOf(I)===-1&&n.pendingLocalTracks.push(I)}),n.unbindLocalTrackEvents(t),_}const l=n.mapPubResToRemoteConfig(s,c,r),u=(yield We(i.next(l))).value;if(n.state===ut.Disconnected)throw new W(b.UNEXPECTED_ERROR,"PeerConnection already disconnected.");w("ENABLE_VIDEO_SEI");const h=w("ENABLE_ENCODED_TRANSFORM"),f=w("ENABLE_AUDIO_METADATA");r.forEach(async _=>{const E=_.getRTCRtpTransceiver();if(!E||!h)return;const{interceptLocalVideoFrame:I,interceptLocalAudioFrame:v}=pm();_.trackMediaType===ue.VIDEO?await I(E.sender,_):_.trackMediaType===ue.AUDIO&&await v(E.sender,{metadata:f?()=>{const R=_.metadata.shift();return R&&R.value}:void 0})}),t.forEach(_=>{let{type:E}=_;n.statsCollector.addLocalStats(E)}),n.assignLocalTracks(t,u),n.statsUploader.startUploadOutboundStats(),t.forEach(_=>{let{track:E,type:I}=_;const v=Date.now();n.store.publish(E.getTrackId(),I===$.LocalAudioTrack?"audio":"video",void 0,v)})})()}async updateVideoStreamParameter(e,t){const n=this.localTrackMap.get(t);if(!n||!this.connection)return;if(!(n.track instanceof wt))return g.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");const{track:r}=n,i=function(o,s){const c={};return o.height&&o.width&&(c.scaleResolutionDownBy=DR(o,s)),c.maxFramerate=o.framerate?Pr(o.framerate):void 0,c.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,c}(e,r);if(r._encoderConfig||(r._encoderConfig={}),t!==$.LocalVideoLowTrack||!w("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding)i.scaleResolutionDownBy!=null&&(r._encoderConfig.scaleResolutionDownBy=i.scaleResolutionDownBy);else{const o=r._originMediaStreamTrack;if(!o.canvas)return g.warn("[".concat(r.getTrackId(),"] no canvas on track"));(function(s,c){const l=s.canvas;c.width&&(l.width=Pr(c.width)),c.height&&(l.height=Pr(c.height)),c.framerate&&(l.stopCapture&&l.stopCapture(),l.stopCapture=tR(()=>{!l.startCapture&&l.stopCapture&&l.stopCapture(),l.startCapture&&l.startCapture()},Pr(c.framerate)))})(o,e)}i.maxBitrate!=null&&(r._encoderConfig.bitrateMax=i.maxBitrate/1e3),i.maxFramerate!=null&&(r._encoderConfig.frameRate&&typeof r._encoderConfig.frameRate=="object"?r._encoderConfig.frameRate.max=i.maxFramerate:r._encoderConfig.frameRate={max:i.maxFramerate}),g.debug("[".concat(r.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(r._encoderConfig))),await this.connection.updateRtpSenderEncodings(r)}publishLowStream(e){var t=this;return Ar(function*(){if(!t.connection||t.state!==ut.Connected)return;const n=yield We(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const i=t.localTrackMap.get($.LocalVideoTrack);if(!i)throw new W(b.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has($.LocalVideoLowTrack))throw new W(b.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:t.getLowVideoTrack(i.track,e),type:$.LocalVideoLowTrack}];if(yield*rl(OM(t.doPublish(t.connection,o))),i.track.muted||!i.track.enabled){var r;const s=(r=t.localTrackMap.get($.LocalVideoLowTrack))===null||r===void 0?void 0:r.id;s!==void 0&&(yield We(t.connection.muteLocal([s])))}}finally{n()}})()}async republish(){this.pendingLocalTracks.length>0&&(g.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await hn(this,Se.RequestRePublish,this.pendingLocalTracks),this.emit(Se.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(g.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await hn(this,Se.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:n,kind:r}=this.pendingRemoteTracks[t];(r!==ue.AUDIO||n._audio_added_&&n._audioSSRC)&&(r!==ue.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await hn(this,Se.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:n}of this.pendingRemoteTracks)await this.subscribe(t,n,n===ue.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach(t=>{let{user:n}=t;this.emit(Se.MediaReconnectEnd,n.uid)}),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==ut.Connected)return void e.forEach(r=>{const i=this.pendingLocalTracks.indexOf(r);i!==-1&&this.pendingLocalTracks.splice(i,1)});const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const n=t.find(r=>r[0]==="videoLowTrack");return n&&n[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==ut.Connected)return void e.forEach(n=>{const r=this.pendingLocalDataChannels.indexOf(n);r!==-1&&this.pendingLocalDataChannels.splice(r,1)});const t=this.filterTobeUnpublishedDataChannels(e);return t.length!==0?(t.forEach(n=>{const r=this.localDataChannels.indexOf(n);r!==-1&&this.localDataChannels.splice(r,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),t.map(n=>n.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==ut.Connected)return;const e=this.localTrackMap.get($.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[$.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const n=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map(r=>{let[,{id:i}]=r;return i})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(r=>{let[i,{track:o}]=r;return{type:i,track:o}})),t.forEach(r=>{let[i]=r;this.statsCollector.removeLocalStats(i)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(e,t){if(!this.connection||this.state!==ut.Connected)throw new W(b.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=t.filter(r=>{var i;return!((i=this.remoteDataChannelMap.get(e))!==null&&i!==void 0&&i.get(r.id))});if(n.length!==0)return await this.connection.createDataChannels(e.uid,n),n.forEach(r=>{var i;this.remoteDataChannelMap.has(e)?(i=this.remoteDataChannelMap.get(e))===null||i===void 0||i.set(r.id,r):this.remoteDataChannelMap.set(e,new Map([[r.id,r]]));const o=this.pendingRemoteDataChannels.findIndex(s=>{let{user:c,id:l}=s;return c.uid===e.uid&&l===r.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),n.map(r=>r.id)}async subscribe(e,t,n,r,i){var o;if(!this.connection||this.state!==ut.Connected)throw new W(b.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(e))!==null&&o!==void 0&&o.has(t))return;let s,c,l,u;const h=this.connection.getPreMedia(n);if(h)g.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(n,", no need to send sub to gateway.")),l=h.transceiver,s=h.track,c=h.mid,u=h.player,h.firstVideoRender&&this.store.firstVideoFrameDecoded(e.uid,{firstPreRender:h.firstVideoRender});else if(i){const E=i.find(v=>{let{stream_type:R}=v;return R===t});if(!E)throw new W(b.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const I=await this.connection.receive(t,E.ssrcs,String(e._uintid),E.attributes);(this.connection instanceof vi||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(l=I.transceiver),s=I.track,c=I.id}else{const E=await this.connection.receive(t,[{ssrcId:n,rtx:r}],String(e._uintid),void 0);(this.connection instanceof vi||"name"in this.connection&&this.connection.name==="DataChannelConnection")&&(l=E.transceiver),s=E.track,c=E.id}if(t===ue.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(s):(e._audioTrack=new Tl(s,e.uid,e._uintid,this.store),g.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),l&&e._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(s):(e._videoTrack=new Sl(s,e.uid,e._uintid,this.store,u),g.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId())),e._videoTrack.once(Mi.PLAY_START,()=>{this.store.firstVideoFrameDecoded(e.uid,{playStart:Date.now()})}),e._videoTrack.once(Mi.PLAY_END,()=>{this.store.firstVideoFrameDecoded(e.uid,{playEnd:Date.now()}),this.reportVideoFirstFrameRender(e)}),u?e._videoTrack.once(Mi.FIRST_FRAME_RENDER,()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)}):e._videoTrack.once(Mi.FIRST_FRAME_DECODED,()=>{this.store.firstVideoFrameDecoded(e.uid,{firstRender:Date.now()}),this.reportVideoFirstFrameRender(e)})),l&&e._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(e,e._videoTrack)),l&&w("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:E,interceptRemoteAudioFrame:I}=pm();t==ue.VIDEO?await E(l.receiver,{onSei:w("ENABLE_VIDEO_SEI")&&(v=>{var R;return(R=e._videoTrack)===null||R===void 0?void 0:R._onSei(v)}),onFirstFrame:v=>{var R;const A=Array.from(ar(R=this.remoteUserMap).call(R)).find(O=>O._videoSSRC===v.ssrc);A&&this.store.firstVideoFrameDecoded(A.uid,{firstReceivedEncodedFrame:Date.now(),frameType:v.type,rtpTimestamp:v.rtpTimestamp,framePayloadType:v.payloadType,frameDataLength:v.length,mimeType:v.mimeType})}}):t==ue.AUDIO&&await I(l.receiver,{enableTopn:!!w("ENABLE_AUDIO_TOPN"),enableMetadata:!!w("ENABLE_AUDIO_METADATA"),enablePts:!!w("ENABLE_AUDIO_PTS"),onMetadata:v=>{this.safeEmit(Se.AudioMetadata,v)},onPts:v=>{this.safeEmit(Se.AudioPts,v)}})}const f=this.remoteUserMap.get(e);f?f.set(t,c):this.remoteUserMap.set(e,new Map([[t,c]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const _=this.pendingRemoteTracks.findIndex(E=>{let{user:I,kind:v}=E;return I.uid===e.uid&&t===v});_!==-1&&(this.pendingRemoteTracks.splice(_,1),this.emit(Se.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==ut.Connected)throw new W(b.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter(i=>{var o;let{user:s,mediaType:c}=i;return!((o=this.remoteUserMap.get(s))!==null&&o!==void 0&&o.has(c))});const t=[],n=new Map;e.forEach(i=>{if(!this.connection)return;const o=this.connection.getPreMedia(i.ssrcId);if(o){const{track:s,mid:c,transceiver:l,player:u}=o;n.set(i.ssrcId,{track:s,id:c,transceiver:l,player:u})}else t.push(i)});const r=await this.connection.batchReceive(t.map(i=>{let{user:o,mediaType:s,ssrcId:c,rtxSsrcId:l}=i;return{kind:s,ssrcMsg:[{ssrcId:c,rtx:l}],mslabel:String(o._uintid)}}));t.forEach((i,o)=>{n.set(i.ssrcId,r[o])});for(const{user:i,mediaType:o,ssrcId:s}of e){const c=n.get(s);if(!c)return void g.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(i.uid," subscribe data,").concat(o,", ").concat(s));const{track:l,id:u,transceiver:h,player:f}=c;if(h&&w("ENABLE_ENCODED_TRANSFORM")){const{interceptRemoteVideoFrame:I,interceptRemoteAudioFrame:v}=pm();o==ue.VIDEO?await I(h.receiver,{onSei:w("ENABLE_VIDEO_SEI")&&(R=>{var A;return(A=i._videoTrack)===null||A===void 0?void 0:A._onSei(R)}),onFirstFrame:R=>{var A;const O=Array.from(ar(A=this.remoteUserMap).call(A)).find(P=>P._videoSSRC===R.ssrc);O&&this.store.firstVideoFrameDecoded(O.uid,{firstReceivedEncodedFrame:Date.now(),frameType:R.type,rtpTimestamp:R.rtpTimestamp,framePayloadType:R.payloadType,frameDataLength:R.length,mimeType:R.mimeType})}}):o==ue.AUDIO&&await v(h.receiver,{enableTopn:!!w("ENABLE_AUDIO_TOPN"),enableMetadata:!!w("ENABLE_AUDIO_METADATA"),enablePts:!!w("ENABLE_AUDIO_PTS"),onMetadata:R=>{this.safeEmit(Se.AudioMetadata,R)},onPts:R=>{this.safeEmit(Se.AudioPts,R)}})}if(o===ue.AUDIO?(i._audioTrack?i._audioTrack._updateOriginMediaStreamTrack(l):(i._audioTrack=new Tl(l,i.uid,i._uintid,this.store),g.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(i._audioTrack.getTrackId()))),h&&i._audioTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(i,i._audioTrack)):(i._videoTrack?i._videoTrack._updateOriginMediaStreamTrack(l):(i._videoTrack=new Sl(l,i.uid,i._uintid,this.store,f),g.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(i._videoTrack.getTrackId()))),h&&i._videoTrack._updateRtpTransceiver(h),this.bindRemoteTrackEvents(i,i._videoTrack)),w("ENABLE_VIDEO_SEI")&&h){const{interceptRemoteVideoFrame:I,interceptRemoteAudioFrame:v}=pm();o==ue.VIDEO?await I(h.receiver,{onSei:R=>{var A;(A=i._videoTrack)===null||A===void 0||A._onSei(R)},onFirstFrame:R=>{var A;const O=Array.from(ar(A=this.remoteUserMap).call(A)).find(P=>P._videoSSRC===R.ssrc);O&&this.store.firstVideoFrameDecoded(O.uid,{firstReceivedEncodedFrame:Date.now(),frameType:R.type,rtpTimestamp:R.rtpTimestamp,framePayloadType:R.payloadType,frameDataLength:R.length,mimeType:R.mimeType})}}):o==ue.AUDIO&&await v(h.receiver)}const _=this.remoteUserMap.get(i);_?_.set(o,u):this.remoteUserMap.set(i,new Map([[o,u]])),this.statsCollector.addRemoteStats(i.uid),this.statsUploader.startUploadInboundStats();const E=this.pendingRemoteTracks.findIndex(I=>{let{user:v,kind:R}=I;return v.uid===i.uid&&o===R});E!==-1&&(this.pendingRemoteTracks.splice(E,1),this.emit(Se.MediaReconnectEnd,i.uid))}}async unsubscribe(e,t,n){const r=this.pendingRemoteTracks.filter(s=>{let{user:c,kind:l}=s;return t!==void 0?c.uid===e.uid&&t===l:c.uid===e.uid});if(r.forEach(s=>{const c=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(c,1)}),this.connection&&this.state===ut.Connected||n||r.forEach(s=>{let{kind:c}=s;var l;if(c===ue.AUDIO)(l=e._audioTrack)===null||l===void 0||l._destroy(),e._audioTrack=void 0;else if(c===ue.VIDEO){var u;(u=e._videoTrack)===null||u===void 0||u._destroy(),e._videoTrack=void 0}}),!this.connection||this.state!==ut.Connected)return;const i=this.filterTobeUnSubscribedTracks(e,t);if(i.length===0)return;await this.connection.stopReceiving(i.map(s=>{let[,{id:c}]=s;return c}));const o=this.createUnsubscribeMessage(i);return this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),i.forEach(s=>{let[c,{kind:l}]=s;var u,h;if(l===ue.VIDEO&&c._videoSSRC&&((u=this.connection)===null||u===void 0||u.setStatsRemoteVideoIsReady(c._videoSSRC,!1)),l===ue.VIDEO)this.unbindRemoteTrackEvents(c._videoTrack),n||((h=c._videoTrack)===null||h===void 0||h._destroy(),c._videoTrack=void 0);else if(l===ue.AUDIO){var f;this.unbindRemoteTrackEvents(c._audioTrack),!n&&((f=c._audioTrack)===null||f===void 0||f._destroy(),c._audioTrack=void 0)}}),o}async unsubscribeDataChannel(e,t){if(t.forEach(i=>{const o=this.pendingRemoteDataChannels.findIndex(s=>s.id===i.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(e,t);if(n.length===0)return;t.forEach(i=>{i._close()});const r=this.remoteDataChannelMap.get(e);return n.forEach(i=>{r&&r.delete(i.id)}),r&&r.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),n.map(i=>i.id)}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:i,mediaType:o}of e){const s=this.pendingRemoteTracks.filter(c=>{let{user:l,kind:u}=c;return o!==void 0?l.uid===i.uid&&o===u:l.uid===i.uid});s.forEach(c=>{const l=this.pendingRemoteTracks.indexOf(c);this.pendingRemoteTracks.splice(l,1)}),t=t.concat(s)}if(!this.connection||this.state!==ut.Connected)return void t.forEach(i=>{let{user:o,kind:s}=i;var c;if(s===ue.AUDIO)(c=o._audioTrack)===null||c===void 0||c._destroy(),o._audioTrack=void 0;else if(s===ue.VIDEO){var l;(l=o._videoTrack)===null||l===void 0||l._destroy(),o._videoTrack=void 0}});const n=Di(e).call(e,(i,o)=>{let{user:s,mediaType:c}=o;const l=this.filterTobeUnSubscribedTracks(s,c);return i.concat(l)},[]);if(n.length===0)return;await this.connection.stopReceiving(n.map(i=>{let[,{id:o}]=i;return o}));const r=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach(i=>{let[o,{kind:s}]=i;var c,l;if(s===ue.VIDEO&&o._videoSSRC&&((c=this.connection)===null||c===void 0||c.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),s===ue.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(l=o._videoTrack)===null||l===void 0||l._destroy(),o._videoTrack=void 0;else if(s===ue.AUDIO){var u;this.unbindRemoteTrackEvents(o._audioTrack),(u=o._audioTrack)===null||u===void 0||u._destroy(),o._audioTrack=void 0}}),r}isPreSubScribe(e){return!this.connection||this.state!==ut.Connected?!1:!!this.connection.getPreMedia(e)}async muteRemote(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void g.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void g.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const r=t===ue.VIDEO?e._videoSSRC:e._audioSSRC;r!==void 0&&this.connection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void g.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(t)||g.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}addAudioMetadata(e){const t=this.localTrackMap.get($.LocalAudioTrack),n=t&&t.track;n&&n.metadata.push(e)}getAllTracks(e){const t=this.localTrackMap.get($.LocalAudioTrack);if((t==null?void 0:t.track)instanceof mn){const n=t.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[i]=r;return i!==$.LocalAudioTrack}).filter(r=>{let[i]=r;return!(e&&i===$.LocalVideoLowTrack)}).map(r=>{let[,{track:i}]=r;return i}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return!(e&&r===$.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,r,i){if(e){const s=this.localTrackMap.get($.LocalAudioTrack),c=r?this.localTrackMap.get($.LocalVideoLowTrack):this.localTrackMap.get($.LocalVideoTrack);pe.publish(this.store.sessionId,{eventElapse:tr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:s==null?void 0:s.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf(pt.SCREEN_TRACK))!==-1,audio:!!s,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}else{var o;n||(n=[]);const s=n.find(l=>l instanceof Zt),c=r?(o=this.localTrackMap.get($.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(l=>l instanceof wt);pe.publish(this.store.sessionId,{eventElapse:tr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:s==null?void 0:s.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf(pt.SCREEN_TRACK))!==-1,audio:!!s,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}}reportSubscribeEvent(e,t,n,r){const i=r===ue.VIDEO?n._videoSSRC:n._audioSSRC;i&&pe.subscribe(this.store.sessionId,{succ:e,ec:t,video:r===ue.VIDEO,audio:r===ue.AUDIO,peerid:n.uid,subscribeRequestid:i,p2pid:this.store.p2pId,eventElapse:tr.measureFromSubscribeStart(this.store.clientId,i),preSsrc:this.isPreSubScribe(i)})}reset(){g.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Ln("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=kh(this.store),this.emit(Se.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get($.LocalAudioTrack);if((e==null?void 0:e.track)instanceof mn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach(n=>{t.removeAudioTrack(n)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=ut.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.connection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get($.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get($.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof wt||t&&t.track instanceof Zt?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(ar(t=this.remoteUserMap).call(t)).find(r=>r.uid===e);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(n=>{let[r]=n;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const t=this.localTrackMap.get($.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=gc(e).call(e,(n,r)=>n.level-r.level),e}async disconnectForReconnect(){this.connection&&(g.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=ut.Reconnecting,w("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&((n=t._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=kh(this.store),this.emit(Se.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[n,{track:r}]=e;switch(n){case $.LocalVideoTrack:Z(t=r._hints).call(t,pt.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case $.LocalAudioTrack:r instanceof mn?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case $.LocalVideoLowTrack:}}),this.emit(Se.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,n]=e;Array.from(ar(n).call(n)).forEach(r=>{this.setPendingRemoteMedia(t,r)}),this.emit(Se.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(e=>{this.pendingLocalDataChannels.push(e)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(e=>{let[t,n]=e;Array.from(ar(n).call(n)).forEach(r=>{this.setPendingRemoteDataChannel(t,r)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),g.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const n of this.pendingRemoteDataChannels){const{user:r,id:i}=n;if((e instanceof Oa?e.uid:e)===r.uid&&i===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:r,kind:i}=n;if((e instanceof Oa?e.uid:e)===r.uid&&t===i)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return Ar(function*(){if(!t.connection||t.state!==ut.Connected)return;const n=yield We(t.mutex.lock("From P2PChannel.restartICE"));let r;try{r=yield We(t.connection.restartICE(e));const o=yield We(r.next());if(o.done)return;const s=o.value,c=yield s;switch($R(t.connection)&&t.reportPCStats(Date.now(),!1,t._pcStatsUploadType),e){case kn.UDP_TCP_RELAY:t._pcStatsUploadType=Hs.UDP_TCP_RESTART;break;case kn.TCP_RELAY:t._pcStatsUploadType=Hs.TCP_RESTART;break;case kn.RELAY:t._pcStatsUploadType=Hs.RELAY_RESTART;break;default:t._pcStatsUploadType=Hs.OLD_RESTART}t._isTryConnecting=!0,r.next(c)}catch(o){var i;(i=r)===null||i===void 0||i.throw(o)}finally{n()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get($.LocalVideoTrack),n=this.localTrackMap.get($.LocalAudioTrack),r=e.videoSend.find(E=>E.ssrc===(t==null?void 0:t.ssrcs[0].ssrcId)),i=e.audioSend.find(E=>E.ssrc===(n==null?void 0:n.ssrcs[0].ssrcId));if(!r||!i)return 1;const o=ni(this,Se.NeedSignalRTT),s=r?r.rttMs:void 0,c=i?i.rttMs:void 0,l=s&&c?(s+c)/2:s||c,u=(l&&o?(l+o)/2:l||o)||0,h=100*e.sendPacketLossRate*.7/50+.3*u/1500,f=h<.17?1:h<.36?2:h<.59?3:h<.1?4:5,_=t==null?void 0:t.track;if(_&&_._encoderConfig&&_._hints.indexOf(pt.SCREEN_TRACK)===-1){const E=_._encoderConfig.bitrateMax,I=e.bitrate.actualEncoded;if(E&&I){const v=(1e3*E-I)/(1e3*E);return _1[v<.15?0:v<.3?1:v<.45?2:v<.6?3:4][f]}}return f}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[r]=n;const i=r._audioSSRC,o=r._videoSSRC,s=e.audioRecv.find(I=>I.ssrc===i),c=e.videoRecv.find(I=>I.ssrc===o);if(!s&&!c)return void(t+=1);const l=ni(this,Se.NeedSignalRTT),u=e.rtt,h=(u&&l?(u+l)/2:u||l)||0,f=s?s.jitterMs:void 0,_=e.recvPacketLossRate;let E=.7*_*100/50+.3*h/1500;f&&(E=.6*_*100/50+.2*h/1500+.2*f/400),t+=E<.1?1:E<.17?2:E<.36?3:E<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new se((t,n)=>{this.handleMuteLocalTrack(e,t,n)})}async replaceTrack(e,t){var n;if(g.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(t.getTrackId(),"]")),!this.connection||this.state!==ut.Connected)return;const r=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return e===s});if(!r)return;const i=r[0];if(e!==t&&(this.unbindLocalTrackEvents([{track:e,type:i}]),this.bindLocalTrackEvents([{track:t,type:i}]),r[1].track=t),await((n=this.connection)===null||n===void 0?void 0:n.replaceTrack(t,r[1].id)),this.isPlanB){const o=r[1];o.id=t._mediaStreamTrack.id,this.localTrackMap.set(i,o)}if(i===$.LocalVideoTrack&&!w("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding){const o=this.localTrackMap.get($.LocalVideoLowTrack);if(o){const s=e._mediaStreamTrack.clone();o.track._originMediaStreamTrack.stop(),o.track._mediaStreamTrack=s,o.track._originMediaStreamTrack=s,await new se((c,l)=>{this.handleReplaceTrack(o.track,c,l,!0)})}}}filterTobePublishedTracks(e,t,n){const r=[],i=this.getAllTracks();e=sl(e=e.filter(l=>i.indexOf(l)===-1));let o,s=!1;const c=this.localTrackMap.get($.LocalAudioTrack);for(const l of e){if(l instanceof wt&&(this.localTrackMap.has($.LocalVideoTrack)||s?new W(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:l,type:$.LocalVideoTrack}),s=!0),t)){const u=this.getLowVideoTrack(l,n);r.push({track:u,type:$.LocalVideoLowTrack})}if(l instanceof Zt)if(c){const u=c.track;if(u instanceof mn)QR([l]),u.addAudioTrack(l),this.bindLocalAudioTrackEvents(l,!0);else{const h=ZR([u,l]);g.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(h.getTrackId(),"]")),this.replaceTrack(u,h)}}else o instanceof mn?(QR([l]),o.addAudioTrack(l)):o||!l._useAudioElement&&Xe().webAudioMediaStreamDest&&!l._bypassWebAudio?o=ZR(o?[l,o]:[l]):o=l}return o&&(g.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),r.push({track:o,type:$.LocalAudioTrack})),r}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=sl(e=e.filter(r=>n.indexOf(r)!==-1));for(const r of e){if(r instanceof Zt){const i=this.localTrackMap.get($.LocalAudioTrack);if(!i)continue;i.track instanceof mn?(i.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),i.track.trackList.length===0&&(t.push([$.LocalAudioTrack,i]),i.track.close())):t.push([$.LocalAudioTrack,i])}if(r instanceof wt){const i=this.localTrackMap.get($.LocalVideoTrack);if(!i)continue;t.push([$.LocalVideoTrack,i]);const o=this.localTrackMap.get($.LocalVideoLowTrack);o&&t.push([$.LocalVideoLowTrack,o])}}return t}filterTobePublishedDataChannels(e){return e=(e=sl(e)).filter(t=>this.localDataChannels.findIndex(n=>n.id===t.id)===-1)}filterTobeUnpublishedDataChannels(e){return e=(e=(e=sl(e)).filter(t=>this.localDataChannels.indexOf(t)!==-1)).filter(t=>t._originDataChannel)}bindLocalTrackEvents(e){e.forEach(t=>{let{track:n,type:r}=t;switch(r){case $.LocalVideoTrack:n.addListener(me.GET_STATS,this.handleGetLocalVideoStats),n.addListener(me.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(me.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case $.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case $.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof mn?e.trackList.forEach(n=>{n.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(me.GET_STATS,this.handleGetLocalAudioStats),n.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(me.GET_STATS,this.handleGetLocalAudioStats),e.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(me.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[n,{track:r}]=t;return{track:r,type:n}})),e.forEach(t=>{let{track:n,type:r}=t;switch(r){case $.LocalVideoTrack:n.off(me.GET_STATS,this.handleGetLocalVideoStats),n.off(me.GET_RTC_STATS,this.handleGetRTCStats),n.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(me.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case $.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case $.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof mn?e.trackList.forEach(t=>{t.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(me.GET_STATS,this.handleGetLocalAudioStats),t.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(me.GET_STATS,this.handleGetLocalAudioStats),e.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(me.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Sl&&t.addListener(me.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(e))}),t instanceof Tl&&t.addListener(me.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(me.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,n]=e;n.has(ue.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(ue.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((n,r)=>{var i;let o,s,{track:c,type:l}=n;switch(l){case $.LocalAudioTrack:o=Et.Audio,s={dtx:c instanceof Rh&&c._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case $.LocalVideoTrack:o=Z(i=c._hints).call(i,pt.SCREEN_TRACK)?Et.Screen:Et.High,s=Ts(Ts({},N1(c)),{},{codec:this.store.codec,svc_mode:wh()});break;case $.LocalVideoLowTrack:o=Et.Low,s=Ts(Ts({},N1(c)),{},{codec:this.store.codec,svc_mode:wh()})}return{stream_type:o,attributes:s,ssrcs:t[r]}})}createGatewayUnpublishMessage(e){return e.map(t=>{var n;let r,[i,{track:o,ssrcs:s,id:c}]=t;switch(i){case $.LocalVideoTrack:r=Z(n=o._hints).call(n,pt.SCREEN_TRACK)?Et.Screen:Et.High;break;case $.LocalAudioTrack:r=Et.Audio;break;case $.LocalVideoLowTrack:r=Et.Low}return{stream_type:r,ssrcs:s,mid:c}})}assignLocalTracks(e,t){e.forEach((n,r)=>{let{track:i,type:o}=n;this.localTrackMap.set(o,{track:i,id:t[r].id,ssrcs:t[r].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[n]=t;this.localTrackMap.delete(n)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(Se.PeerConnectionStateChange,t),t==="connecting"&&e instanceof vi&&!kt()&&w("FIRST_TCP_CANDIDATE")&&window.setTimeout(()=>{t==="connecting"&&e.extendCandidate()},w("FIRST_TCP_CANDIDATE_INTERVAL")),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),e instanceof vi&&wM(e,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=Hs.DISCONNECTED_OR_FAILED,ni(this,Se.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){const n=this.pendingLocalTracks.map(i=>i.getTrackId()),r=this.pendingLocalDataChannels.map(i=>"dc_".concat(i.id));pe.reportApiInvoke(this.store.sessionId,{name:Ft.REPUB_AFTER_PC_CONNECTED,options:n.concat(r),tag:It.TRACER}).onSuccess(),this.republish()}if(w("NEW_ICE_RESTART")&&e instanceof vi&&!kt()&&!this._forceTurn&&!this.store.useDcSignal){if(Z(C1).call(C1,t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const n=i=>{$R(e)&&(g.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(i)),ni(this,Se.QueryClientConnectionState)==="CONNECTED"&&this.emit(Se.RequestRestartICE,i))},r=()=>{$R(e)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),g.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(Se.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout(()=>{AM(e,n,r)},800))}}else{if(t==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout(()=>{e.iceConnectionState==="disconnected"&&w("ICE_RESTART")&&ni(this,Se.QueryClientConnectionState)==="CONNECTED"&&this.emit(Se.RequestRestartICE)},800),void setTimeout(()=>{e.peerConnectionState==="disconnected"&&(g.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout(()=>this.emit(Se.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);t==="failed"&&(g.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout(()=>this.emit(Se.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),pe.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:It.TRACER}).onSuccess(),this.emit(Se.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var n;const r=Array.from(ar(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===t);var i;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(i=r.audioTrack)===null||i===void 0||i.emit(Mi.FIRST_FRAME_DECODED),pe.firstRemoteFrame(this.store.sessionId,_n.FIRST_AUDIO_DECODE,Bt.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:tr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var n;const r=Array.from(ar(n=this.remoteUserMap).call(n)).find(i=>i._audioSSRC===t);r&&pe.firstRemoteFrame(this.store.sessionId,_n.FIRST_AUDIO_RECEIVED,Bt.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:tr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,n,r)=>{var i;const o=Array.from(ar(i=this.remoteUserMap).call(i)).find(s=>s._videoSSRC===t);o&&this.store.firstVideoFrameDecoded(o.uid,{firstDecoded:Date.now()}),this.reportVideoFirstFrameDecoded(t,n,r)},e.onFirstVideoRender=t=>{var n;const r=Array.from(ar(n=this.remoteUserMap).call(n)).find(i=>i._videoSSRC===t);r&&(this.store.firstVideoFrameDecoded(r.uid,{firstPreRender:Date.now()}),this.reportVideoFirstFrameRender(r),this.emit(Se.FirstVideoPreRender,r.uid,t))},e.onFirstVideoReceived=t=>{var n;const r=Array.from(ar(n=this.remoteUserMap).call(n)).find(i=>i._videoSSRC===t);r&&(this.store.firstVideoFrameDecoded(r.uid,{firstReceived:Date.now()}),pe.firstRemoteFrame(this.store.sessionId,_n.FIRST_VIDEO_RECEIVED,Bt.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:tr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstVideoBufferReady=t=>{var n;const r=Array.from(ar(n=this.remoteUserMap).call(n)).find(i=>i._videoSSRC===t);r&&this.emit(Se.FirstVideoBufferReady,r.uid,t)},e.onSelectedLocalCandidateChanged=(t,n)=>{const r=t.candidateType==="relay",i=n.candidateType==="relay";n.candidateType!=="unknown"&&r===i||this.emit(Se.ConnectionTypeChange,r),g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Aa(n))," -> ").concat(JSON.stringify(Aa(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,n)=>{g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Aa(n))," -> ").concat(JSON.stringify(Aa(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.getLocalVideoStats=()=>{const t=this.statsCollector.getLocalVideoTrackStats(),n=this.statsCollector.getRTCStats();return Ts(Ts({},t),n)},e.onICECandidateError=t=>{this._iceError=t}}fallbackConnection(){g.debug("[".concat(this.store.clientId,"] [P2PChannel] try to fallback connection")),this.state===ut.Connected?(g.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&this.resetConnection(this.connection),this.shouldForwardP2PCreation&&(this.connection=kh(this.store),this.emit(Se.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)))}resetConnection(e){e instanceof vi&&function(t){kl.delete(t.id),wM(t)}(e),e.close(),this.emit(Se.PeerConnectionStateChange,"closed"),function(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.getLocalVideoStats=void 0}(e),this._isWaitPcToRePub=!1}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const n=this.localTrackMap.get($.LocalAudioTrack);if(e instanceof Zt&&(n==null?void 0:n.track)instanceof mn)return n.track.isActive||t.push([$.LocalAudioTrack,n]),t;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return e===o});if(r&&(t.push(r),r[0]===$.LocalVideoTrack)){const i=this.localTrackMap.get($.LocalVideoLowTrack);i&&t.push([$.LocalVideoLowTrack,i])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get($.LocalAudioTrack);if(e instanceof Zt&&(n==null?void 0:n.track)instanceof mn)return n.track.isActive&&t.push([$.LocalAudioTrack,n]),t;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return e===o});if(r)if(r[0]===$.LocalVideoTrack){t.push(r);const i=this.localTrackMap.get($.LocalVideoLowTrack);i&&t.push([$.LocalVideoLowTrack,i])}else t.push(r);return t}createMuteMessage(e){return e.map(t=>{var n;let r,[i,{track:o,ssrcs:s,id:c}]=t;switch(i){case $.LocalAudioTrack:r=Et.Audio;break;case $.LocalVideoTrack:r=Z(n=o._hints).call(n,pt.SCREEN_TRACK)?Et.Screen:Et.High;break;case $.LocalVideoLowTrack:r=Et.Low}return{stream_type:r,ssrcs:s,mid:c}})}createUnmuteMessage(e){return e.map(t=>{var n;let r,[i,{track:o,ssrcs:s,id:c}]=t;switch(i){case $.LocalAudioTrack:r=Et.Audio;break;case $.LocalVideoTrack:r=Z(n=o._hints).call(n,pt.SCREEN_TRACK)?Et.Screen:Et.High;break;case $.LocalVideoLowTrack:r=Et.Low}return{stream_type:r,ssrcs:s,mid:c}})}filterTobeUnSubscribedTracks(e,t){const n=[],r=this.remoteUserMap.get(e);if(!r)return n;if(t){const i=r.get(t);if(!i)return n;n.push([e,{kind:t,id:i}])}else Array.from(r.entries()).forEach(i=>{let[o,s]=i;n.push([e,{kind:o,id:s}])});return n}filterTobeUnSubscribedDataChannels(e,t){const n=[];return t.forEach(r=>{var i;(i=this.remoteDataChannelMap.get(e))!==null&&i!==void 0&&i.has(r.id)&&n.push(r)}),n}createUnsubscribeMessage(e){const t=[];return e.forEach(n=>{let[r,{kind:i,id:o}]=n;switch(i){case ue.VIDEO:return void(r._videoSSRC&&t.push({stream_type:ue.VIDEO,ssrcId:r._videoSSRC}));case ue.AUDIO:return void(r._audioSSRC&&t.push({stream_type:ue.AUDIO,ssrcId:r._audioSSRC}))}}),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach(n=>{let[r,{kind:i}]=n;if(t.has(r)){let o=t.get(r);i===ue.VIDEO?o|=An.Video:o|=An.Audio,t.set(r,o)}else i===ue.VIDEO?t.set(r,An.Video):t.set(r,An.Audio)}),{users:Array.from(t.entries()).map(n=>{let[r,i]=n;return{stream_id:r.uid,stream_type:i}})}}withdrawRemoteTracks(e){e.forEach(t=>{let[n,{kind:r}]=t;const i=this.remoteUserMap.get(n);i&&(i.delete(r),Array.from(i.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(e){const t=this.localTrackMap.get($.LocalVideoTrack),n=this.localTrackMap.get($.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new se((r,i)=>{this.handleUpdateVideoEncoder(t.track,r,i,!0)})),n&&e.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new se((r,i)=>{this.handleUpdateVideoEncoder(n.track,r,i,!0)}))}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}isPreallocation(){return!(!this.connection||!("name"in this.connection)||this.connection.name!=="DataChannelConnection"||this.connection.peerConnectionState==="closed")||this.connection instanceof vi&&this.connection.isPreallocation}isPreSub(){return(this.connection&&"name"in this.connection&&this.connection.name==="DataChannelConnection"&&this.connection.peerConnectionState!=="closed"||this.connection instanceof vi)&&this.connection.isPreSub()}isPreRender(){return this.connection instanceof vi&&this.connection.isPreRender}mapPubResToRemoteConfig(e,t,n){return e.map((r,i)=>{var o;let{stream_type:s}=r;const c=(o=t.find(l=>{let{stream_type:u}=l;return s===u}))===null||o===void 0?void 0:o.attributes;if(c&&w("DISABLE_SCREEN_SHARE_REMB")){const l=n[i]._hints;(Z(l).call(l,pt.SCREEN_TRACK)||Z(l).call(l,pt.SCREEN_LOW_TRACK))&&(c.remb=!1,g.debug("disable remb for screen share, hints:",l))}return c})}async tryToUnmuteAudio(e){for(let n=0;n<e.length;n++)if(e[n]instanceof Zt){var t;const r=this.filterTobeUnmutedTracks(e[n]);if(r.length===0)continue;await((t=this.connection)===null||t===void 0?void 0:t.unmuteLocal(r.map(o=>{let[,{id:s}]=o;return s})));const i=this.createUnmuteMessage(r);return void await Ot(this,Se.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.connection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Se.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(Se.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var e;return{connectState:((e=this.connection)===null||e===void 0?void 0:e.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await In(O_(this.dtlsFailedCount,an)),this.emit(Se.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await hn(this,Se.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(Se.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has($.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof wt)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof wt).length>1)throw new W(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof Zt).length>1&&(e.some(t=>t instanceof Zt&&t._bypassWebAudio)||!Xe().webAudioMediaStreamDest))throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof wt&&this.pendingLocalTracks.some(n=>n instanceof wt))throw new W(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Zt&&this.pendingLocalTracks.some(n=>n instanceof Zt)&&(!Xe().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Zt&&n._bypassWebAudio)))throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){var n;const r=!w("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding,i=Ts(Ts({},{width:160,height:120,framerate:15,bitrate:50}),t);let o;o=r?e._mediaStreamTrack.clone():ty(e,i);const s=_t(8,"track-low-"),c=new wt(o,Ts(Ts({},r&&{scaleResolutionDownBy:DR(i,e)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,s);return c.on(xc.TRANSCEIVER_UPDATED,l=>{e._updateRtpTransceiver(l,pl.LOW_STREAM)}),c._hints.push(pt.LOW_STREAM),Z(n=e._hints).call(n,pt.SCREEN_TRACK)&&c._hints.push(pt.SCREEN_LOW_TRACK),e.on("sei-to-send",l=>{c.emit("sei-to-send",l)}),e.addListener(me.NEED_CLOSE,()=>{c.close()}),c}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof vi){var i,o,s,c;const l=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:u,dtlsTransportState:h,peerConnectionState:f}=this.connection,{local:_,remote:E}=await this.connection.getSelectedCandidatePair();pe.pcStats(this.store.sessionId,{startTime:l,eventElapse:e-l||0,iceconnectionsate:u,dtlsstate:h,connectionstate:f,intSucc:t?1:2,error:this._iceError||r||"",selectedLocalCandidateProtocol:(i=_==null?void 0:_.protocol)!==null&&i!==void 0?i:"",selectedLocalCandidateType:(o=_.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(_.address,":").concat(_.port),selectedRemoteCandidateProtocol:(s=E.protocol)!==null&&s!==void 0?s:"",selectedRemoteCandidateType:(c=E.candidateType)!==null&&c!==void 0?c:"",selectedRemoteCandidateAddress:"".concat(E.address,":").concat(E.port),restartCnt:n,preallocation:this.connection.isPreallocation}),this._iceError=null}}reportVideoFirstFrameRender(e){const t=this.store.keyMetrics,n=t.firstVideoFrameDecoded.find(h=>h.userId===e.uid);if(!n)return;const{isInternalUpload:r,isExternalUpload:i}=n;if(r&&i)return;const{subscribeEnd:o,firstPreRender:s,peerPublishDuration:c,peerPubStatusMs:l}=n;let{firstRender:u=0}=n;if(o&&(u||s)&&c&&l){n.isInternalUpload=!0;const{playEnd:h}=n;h&&(n.isExternalUpload=!0);const{firstPreRender:f=0}=n;u=f||u;const _=e.videoTrack,E={peer:e._uintid,width:(_==null?void 0:_._videoWidth)||0,height:(_==null?void 0:_._videoHeight)||0,ssrc:e._videoSSRC||0,p2pid:this.store.p2pId,peerPublishDuration:c,peerPubStatusMs:l,joinChannelStart:t.joinStart||0,preloadStart:t.preloadStart||0,preloadEnd:t.preloadEnd||0,apStart:t.requestAPStart||0,apEnd:t.requestAPEnd||0,suaEnd:t.requestSUAEnd||0,beforeConnect:t.beforeConnect||0,peerReceiver:t.peerReceiver||0,ice:t.iceConnectionEnd||0,pc:t.peerConnectionEnd||0,signalConnected:t.signalConnected||0,joinReq:t.joinReq||0,joinRes:t.joinRep||0,userJoinNotify:n.userJoinNotify||0,videoAddNotify:n.videoAddNotify||0,subscribeStart:n.subscribeStart||0,subscribeEnd:n.subscribeEnd||0,firstReceived:n.firstReceived||0,firstDecoded:n.firstDecoded||0,firstPreRender:f||0,firstRender:h?Math.max(u,h):Math.max(u,o),playStart:n.playStart||0,playEnd:n.playEnd||0,isPreSub:!(!e._videoSSRC||!this.isPreSubScribe(e._videoSSRC)),isPrePc:this.isPreallocation(),isPreInstantVideo:JP(this.store),firstReceivedEncodedFrame:n.firstReceivedEncodedFrame||0,frameType:n.frameType||"",rtpTimestamp:n.rtpTimestamp||0,framePayloadType:n.framePayloadType||0,frameDataLength:n.frameDataLength||0,mimeType:n.mimeType||""};pe.firstXLAPeerFirstVideoFrame(this.store.sessionId,E)}}reportVideoFirstFrameDecoded(e,t,n,r){var i;const o=Array.from(ar(i=this.remoteUserMap).call(i)).find(s=>s._videoSSRC===e);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,c=s.subscribe.find(l=>l.userId===o.uid&&l.type==="video");pe.firstRemoteVideoDecode(this.store.sessionId,_n.FIRST_VIDEO_DECODE,Bt.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:t,videoheight:n,subscribeElapse:tr.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:r?1:0,firstFrame:(c==null?void 0:c.firstFrame)||0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.connection)return!1;const r=this.remoteUserMap.get(e);if(!r)return!1;const i=r.get(t);if(!i)return!1;const o=await this.connection.getRemoteSSRC(i);return o!==void 0&&o!==n}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:n}]=e;t===$.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,pl.LOW_STREAM):n._updateRtpTransceiver(void 0)})}},ae(Qe.prototype,"startP2PConnection",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"startP2PConnection"),Qe.prototype),ae(Qe.prototype,"connect",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"connect"),Qe.prototype),ae(Qe.prototype,"updateRemoteRTPCapabilities",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"updateRemoteRTPCapabilities"),Qe.prototype),ae(Qe.prototype,"publishDataChannel",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"publishDataChannel"),Qe.prototype),ae(Qe.prototype,"unpublish",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"unpublish"),Qe.prototype),ae(Qe.prototype,"unpublishDataChannel",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"unpublishDataChannel"),Qe.prototype),ae(Qe.prototype,"unpublishLowStream",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"unpublishLowStream"),Qe.prototype),ae(Qe.prototype,"subscribeDataChannel",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"subscribeDataChannel"),Qe.prototype),ae(Qe.prototype,"subscribe",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"subscribe"),Qe.prototype),ae(Qe.prototype,"massSubscribe",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"massSubscribe"),Qe.prototype),ae(Qe.prototype,"unsubscribe",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"unsubscribe"),Qe.prototype),ae(Qe.prototype,"unsubscribeDataChannel",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"unsubscribeDataChannel"),Qe.prototype),ae(Qe.prototype,"massUnsubscribe",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"massUnsubscribe"),Qe.prototype),ae(Qe.prototype,"muteRemote",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"muteRemote"),Qe.prototype),ae(Qe.prototype,"unmuteRemote",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"unmuteRemote"),Qe.prototype),ae(Qe.prototype,"hasRemoteMediaWithLock",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"hasRemoteMediaWithLock"),Qe.prototype),ae(Qe.prototype,"disconnectForReconnect",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"disconnectForReconnect"),Qe.prototype),ae(Qe.prototype,"updateBitrateLimit",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"updateBitrateLimit"),Qe.prototype),ae(Qe.prototype,"remoteMediaSsrcChanged",[lr],Object.getOwnPropertyDescriptor(Qe.prototype,"remoteMediaSsrcChanged"),Qe.prototype),Qe);function lr(e,t,n){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("From P2PChannel.".concat(t));try{for(var s=arguments.length,c=new Array(s),l=0;l<s;l++)c[l]=arguments[l];return await r.apply(this,c)}finally{o()}},n}function NM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function DM(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?NM(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):NM(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}const BX=Date.now(),jX=20,iy=new Map,Im=new Map;async function PM(e){const t=iy.get(e),n=Array.isArray(t)&&t[t.length-1],r=Im.get(e);if(!n)return void(r.isSyncing=!1);const i={uid:n.uid,payload:n.payload};r.firstRecvTs===0&&(r.firstRecvTs=n.recvTs,r.firstSendTs=n.sendTs);const o=n.sendTs-r.firstSendTs,s=o-(Date.now()-r.firstRecvTs);s>0&&(r.firstRecvTs=Date.now()-o);let c=n.mediaDelay+s;c<=0?(t.pop(),LM(n.context,i),c=0):c=Math.min(c,jX),setTimeout(()=>t.length&&PM(e),c)}function LM(e,t){e.safeEmit(Ke.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function GX(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return LM(n,{uid:e.uid,payload:e.payload});const r="".concat(n.id,"-").concat(e.uid),i=iy.get(r)||[],o=i.findIndex(u=>e.sendTs>=u.sendTs),s=DM(DM({},e),{},{context:n,mediaDelay:t,recvTs:Date.now()});o===-1?i.push(s):i.splice(o,0,s),iy.set(r,i);let c=!1;var l;Im.has(r)?c=!((l=Im.get(r))===null||l===void 0||!l.isSyncing):Im.set(r,{isSyncing:c,firstRecvTs:0,firstSendTs:0}),c||PM(r)}const WX=ot().name;function kM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function MM(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?kM(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):kM(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}const Ml="websdk_ng_cache_parameter",HX=w("MAX_PRELOAD_ASYNC_LENGTH"),KX=1e4,Jc=new Map,Qc=[];let oy=null,sy=0,ay=0;const wm=new Map,UM=new Uint8Array([241,141,127,212,103,139,200,225,251,157,127,139,143,2,22,163]),YX=function(e,t){const n=[];let r=0;const i=async()=>{const o=n.shift();o&&await o(),n.length>0&&r<t?i():r--};return async function(){for(var o=arguments.length,s=new Array(o),c=0;c<o;c++)s[c]=arguments[c];return new se(async(l,u)=>{n.push(async()=>{try{const h=await e(...s);l(h)}catch(h){u(h)}}),r<t&&(r++,i())})}}(dy,HX),cy=br.CancelToken.source();class zX{constructor(){y(this,"_audioContext",null)}createMuteAudioTrack(){this._audioContext=new AudioContext;const t=this._audioContext.sampleRate,n=10*t,r=this._audioContext.createBuffer(2,n,t),i=this._audioContext.createBufferSource();i.buffer=r;const o=this._audioContext.createMediaStreamDestination();return i.connect(o),i.start(),o.stream.getAudioTracks()[0]}close(){this._audioContext&&(this._audioContext.close(),this._audioContext=null)}}async function dy(e,t,n,r,i,o,s){try{if(!w("ENABLE_PRELOAD"))return;if(!Xe().supportWebCrypto)return void va(()=>{g.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!n&&n!==null)throw new W(b.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&jn(n,"token",1,2047),jn(e,"appid",1,2047),tm(t),r&&nm(r);const c=Lc();g.debug("preload channel ".concat(t,", uid is ").concat(r));const l={appId:e,cname:t,token:n||e,uid:typeof r!="string"?r:null,sid:c,proxyServer:i,role:s};let u,h;typeof r=="string"?(l.stringUid=r,[h,u]=await se.all([bX(r,{sid:c,appId:e},cy.token),sM(MM(MM({},l),{},{token:n||e,uid:0}),cy.token)]),l.uid=h.uid,u.gatewayInfo.uid=l.uid,u.gatewayInfo.res.uid=l.uid):(o&&(l.stringUid=o),u=await sM(l,cy.token));const f={sid:c,appId:e,cname:t,token:n||e,uid:l.stringUid||r,intUid:l.uid||u.gatewayInfo.uid,stringUid:l.stringUid,ts:Date.now(),sua:h,ap:u};await uy(f),sy++}catch(c){throw ay++,function(l){oy||(oy=window.setTimeout(()=>{let h="";wm.forEach((f,_)=>{h+="".concat(_,": ").concat(f," ;")}),pe.reportApiInvoke(null,{name:Ft.PRELOAD,options:{success:sy,failed:ay,err:h}}).onError(l),sy=0,ay=0,wm.clear(),oy=null},KX));const u=wm.get(l.code)||0;wm.set(l.code,u+1)}(c),c}}async function ly(e){try{if(w("AP_REQUEST_DETAIL")||w("ENABLE_ROLE_SELECT_EDGE"))return;const t=xM(e);if(!t||e.cloudProxyServer!=="disabled")return;const n=await async function(r,i){try{const o=await window.crypto.subtle.importKey("raw",CP(i),"AES-GCM",!1,["decrypt"]),s=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:UM},o,Pc(r));return JSON.parse(window.atob(Ra(new Uint8Array(s))))}catch{return}}(t,e.token||e.appId);if(!n||!function(r,i){return r.cname===i.cname&&r.appId===i.appId&&r.token===i.token?i.stringUid?r.stringUid===i.stringUid:typeof i.uid=="number"?r.uid===i.uid:r.uid==i.uid:!1}(n,e))return;if(n&&Date.now()-n.ts<w("AP_CACHE_LIFETIME"))return n}catch(t){g.warn("Error get preloadInfo",t.message)}}function xM(e){let t;try{if(t=BM(Ml),!t)return;const n=JSON.parse(t),r=jM(e),i=function(s,c){for(let l=s.length-1;l>=0;l--)if(c(s[l]))return l;return-1}(n,s=>r in s);if(i===-1)return;const o=n.splice(i,1)[0];return Am(Ml,JSON.stringify(n)),o[r]}catch(n){g.warn("Error delete preload info: ".concat(t),n.message),Am(Ml,"")}}async function uy(e){let t;try{e.uid&&xM({appId:e.appId,cname:e.cname,token:e.token,uid:e.uid,stringUid:e.stringUid});const n=jM(e),r=await async function(o,s){try{const c=await window.crypto.subtle.importKey("raw",CP(s),"AES-GCM",!1,["encrypt"]),l=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:UM},c,Pc(window.btoa(JSON.stringify(o))));return Ra(new Uint8Array(l))}catch{return}}(e,e.token||e.appId);if(!r)return;t=BM(Ml);const i=t?JSON.parse(t):[];i.push({[n]:r}),i.length>w("AP_CACHE_NUM")&&i.shift(),Am(Ml,JSON.stringify(i))}catch(n){g.warn("Error caching server parameters:",n.message),Am(Ml,"")}}function hy(e){if(e){let t=Jc.get(e);t&&(window.clearTimeout(t),t=null,Jc.delete(e)),Z(Qc).call(Qc,e)||e.cloudProxyServer!=="disabled"||Qc.push(e)}if(Jc.size<w("AP_CACHE_NUM")&&Qc.length>0){const t=Qc.shift();Jc.set(t,window.setTimeout(async()=>{const{appId:n,cname:r,token:i,stringUid:o,uid:s,proxyServer:c,role:l}=t;try{await YX(n,r,i,s,c,o,l),Jc.has(t)&&hy(t)}catch(u){g.warn("update preload failed",u.message),VM(t)}},w("AP_UPDATE_INTERVAL")))}}function VM(e){const t=Qc.indexOf(e);t!==-1&&Qc.splice(t,1);let n=Jc.get(e);n&&(window.clearTimeout(n),n=null,Jc.delete(e),hy())}function FM(e,t){const n=e.sua,r=e.ap;t&&n&&pe.reqUserAccount(e.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:t,uid:e.intUid,errorCode:null,extend:n.req}),pe.reportResourceTiming(e.ap.url,e.sid),pe.joinWebProxyAP(e.sid,{lts:r.requestTime,elapse:r.elapse,sucess:1,apServerAddr:r.url,turnServerAddrList:r.proxyInfo.addresses.map(i=>i.ip).join(","),eventType:"disabled",unilbsServerIds:[cn.CHOOSE_SERVER,cn.CLOUD_PROXY_FALLBACK].toString()}),pe.joinChooseServer(e.sid,{lts:r.requestTime,elapse:r.elapse,succ:!0,csAddr:r.url,opid:r.opid,serverList:r.gatewayInfo.gatewayAddrs.map(i=>i.address),ec:null,cid:r.gatewayInfo.cid.toString(),uid:r.gatewayInfo.uid.toString(),csIp:r.gatewayInfo.csIp,unilbsServerIds:[cn.CHOOSE_SERVER].toString(),isHttp3:r.isHttp3})}function BM(e){return window.atob(window.localStorage.getItem(e)||"")}function Am(e,t){window.localStorage.setItem(e,window.btoa(t))}function jM(e){let t="".concat(e.appId,"_").concat(e.cname);return typeof e.uid=="string"&&(t+="_s_".concat(e.uid)),typeof e.uid=="number"&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),DP(t)}function qX(e){let t=function(){const n=QX.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(n,r){let i=n.appId;i!==void 0&&(dn(r,10),Da(r,i));let o=n.cid;o!==void 0&&(dn(r,16),dn(r,o));let s=n.cname;s!==void 0&&(dn(r,26),Da(r,s));let c=n.deviceId;c!==void 0&&(dn(r,34),Da(r,c));let l=n.elapse;l!==void 0&&(dn(r,40),Pa(r,l));let u=n.fileSize;u!==void 0&&(dn(r,48),Pa(r,Ul(u)));let h=n.height;h!==void 0&&(dn(r,56),Pa(r,Ul(h)));let f=n.jpg;f!==void 0&&(dn(r,66),dn(r,f.length),WM(r,f));let _=n.networkType;_!==void 0&&(dn(r,72),Pa(r,Ul(_)));let E=n.osType;E!==void 0&&(dn(r,80),Pa(r,Ul(E)));let I=n.requestId;I!==void 0&&(dn(r,90),Da(r,I));let v=n.sdkVersion;v!==void 0&&(dn(r,98),Da(r,v));let R=n.sequence;R!==void 0&&(dn(r,104),Pa(r,Ul(R)));let A=n.sid;A!==void 0&&(dn(r,114),Da(r,A));let O=n.timestamp;O!==void 0&&(dn(r,120),Pa(r,O));let P=n.uid;P!==void 0&&(dn(r,128),dn(r,P));let M=n.vid;M!==void 0&&(dn(r,136),dn(r,M));let U=n.width;U!==void 0&&(dn(r,144),Pa(r,Ul(U)));let L=n.service;L!==void 0&&(dn(r,152),dn(r,L));let V=n.callbackData;V!==void 0&&(dn(r,162),dn(r,V.length),WM(r,V));let H=n.ticket;H!==void 0&&(dn(r,170),Da(r,H));let q=n.vendorConfigs;q!==void 0&&(dn(r,178),Da(r,q))}(e,t),function(n){let r=n.bytes,i=n.limit;return r.length===i?r:r.subarray(0,i)}(t)}function XX(e){return function(n){let r={};e:for(;!ZX(n);){let i=Uh(n);switch(i>>>3){case 0:break e;case 1:r.code=Uh(n);break;case 2:r.msg=HM(n,Uh(n));break;case 3:r.requestId=HM(n,Uh(n));break;case 4:r.timestamp=$X(n,!1);break;default:JX(n,7&i)}}return r}({bytes:t=e,offset:0,limit:t.length});var t}function JX(e,t){switch(t){case 0:for(;128&fo(e););break;case 2:py(e,Uh(e));break;case 5:py(e,4);break;case 1:py(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function Ul(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let QX=[];function py(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function ZX(e){return e.offset>=e.limit}function bm(e,t){let n=e.bytes,r=e.offset,i=e.limit,o=r+t;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),e.bytes=s}return e.offset=o,o>i&&(e.limit=o),r}function GM(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function WM(e,t){let n=bm(e,t.length);e.bytes.set(t,n)}function HM(e,t){let n=GM(e,t),r=String.fromCharCode,i=e.bytes,o="",s="";for(let c=0;c<t;c++){let l,u,h,f,_=i[c+n];128&_?(224&_)==192?c+1>=t?s+=o:(l=i[c+n+1],(192&l)!=128?s+=o:(f=(31&_)<<6|63&l,f<128?s+=o:(s+=r(f),c++))):(240&_)==224?c+2>=t?s+=o:(l=i[c+n+1],u=i[c+n+2],(49344&(l|u<<8))!=32896?s+=o:(f=(15&_)<<12|(63&l)<<6|63&u,f<2048||f>=55296&&f<=57343?s+=o:(s+=r(f),c+=2))):(248&_)==240?c+3>=t?s+=o:(l=i[c+n+1],u=i[c+n+2],h=i[c+n+3],(12632256&(l|u<<8|h<<16))!=8421504?s+=o:(f=(7&_)<<18|(63&l)<<12|(63&u)<<6|63&h,f<65536||f>1114111?s+=o:(f-=65536,s+=r(55296+(f>>10),56320+(1023&f)),c+=3))):s+=o:s+=r(_)}return s}function Da(e,t){let n=t.length,r=0;for(let s=0;s<n;s++){let c=t.charCodeAt(s);c>=55296&&c<=56319&&s+1<n&&(c=(c<<10)+t.charCodeAt(++s)-56613888),r+=c<128?1:c<2048?2:c<65536?3:4}dn(e,r);let i=bm(e,r),o=e.bytes;for(let s=0;s<n;s++){let c=t.charCodeAt(s);c>=55296&&c<=56319&&s+1<n&&(c=(c<<10)+t.charCodeAt(++s)-56613888),c<128?o[i++]=c:(c<2048?o[i++]=c>>6&31|192:(c<65536?o[i++]=c>>12&15|224:(o[i++]=c>>18&7|240,o[i++]=c>>12&63|128),o[i++]=c>>6&63|128),o[i++]=63&c|128)}}function fo(e){return e.bytes[GM(e,1)]}function KM(e,t){let n=bm(e,1);e.bytes[n]=t}function Uh(e){let t,n=0,r=0;do t=fo(e),n<32&&(r|=(127&t)<<n),n+=7;while(128&t);return r}function dn(e,t){for(t>>>=0;t>=128;)KM(e,127&t|128),t>>>=7;KM(e,t)}function $X(e,t){let n,r=0,i=0,o=0;return n=fo(e),r=127&n,128&n&&(n=fo(e),r|=(127&n)<<7,128&n&&(n=fo(e),r|=(127&n)<<14,128&n&&(n=fo(e),r|=(127&n)<<21,128&n&&(n=fo(e),i=127&n,128&n&&(n=fo(e),i|=(127&n)<<7,128&n&&(n=fo(e),i|=(127&n)<<14,128&n&&(n=fo(e),i|=(127&n)<<21,128&n&&(n=fo(e),o=127&n,128&n&&(n=fo(e),o|=(127&n)<<7))))))))),{low:r|i<<28,high:i>>>4|o<<24,unsigned:t}}function Pa(e,t){let n=t.low>>>0,r=(t.low>>>28|t.high<<4)>>>0,i=t.high>>>24,o=i===0?r===0?n<16384?n<128?1:2:n<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:i<128?9:10,s=bm(e,o),c=e.bytes;switch(o){case 10:c[s+9]=i>>>7&1;case 9:c[s+8]=o!==9?128|i:127&i;case 8:c[s+7]=o!==8?r>>>21|128:r>>>21&127;case 7:c[s+6]=o!==7?r>>>14|128:r>>>14&127;case 6:c[s+5]=o!==6?r>>>7|128:r>>>7&127;case 5:c[s+4]=o!==5?128|r:127&r;case 4:c[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:c[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:c[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:c[s]=o!==1?128|n:127&n}}const YM={},zM={},Om=4294967296,eJ=Om*Om,qM=eJ/2;JM(0,!0);const XM=JM(0),tJ=xh(0,-2147483648,!1),nJ=xh(-1,2147483647,!1);function JM(e,t){let n,r,i;return t?(i=0<=(e>>>=0)&&e<256)&&(r=zM[e],r)?r:(n=xh(e,0,!0),i&&(zM[e]=n),n):(i=-128<=(e|=0)&&e<128)&&(r=YM[e],r)?r:(n=xh(e,e<0?-1:0,!1),i&&(YM[e]=n),n)}function xh(e,t,n){return{low:0|e,high:0|t,unsigned:!!n}}function QM(e,t){if(isNaN(e))return XM;{if(e<=-qM)return tJ;if(e+1>=qM)return nJ}return e<0?XM:xh(e%Om|0,e/Om|0,t)}function ZM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}class fy extends Wt{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const n=this._connectionState;this._connectionState=t,this.emit(Fo.CONNECTION_STATE_CHANGE,t,n)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(t){var n;super(),y(this,"name","AgoraRTCImageModeration"),y(this,"_connectionState",Vi.CONNECTING),y(this,"_sequence",0),y(this,"_moderationStartTime",void 0),y(this,"_workerConnection",void 0),y(this,"_workerMessageLengthLimit",void 0),y(this,"_qualityRatio",void 0),y(this,"_connectInfo",void 0),y(this,"_cancelTokenSource",br.CancelToken.source()),y(this,"_retryConfig",void 0),y(this,"_moderationInterval",void 0),y(this,"_moderationTimer",null),y(this,"_moderationMode",1),y(this,"_quality",1),y(this,"_qualityTimer",null),y(this,"_ticket",void 0),y(this,"_moderationIntervalMinimum",void 0),y(this,"_uploadFailedNum",0),y(this,"_uploadNum",0),y(this,"_uploadTimer",null),y(this,"_extraInfo",void 0),y(this,"_vendor",""),y(this,"_encoder",new TextEncoder),y(this,"_moderationId",void 0),y(this,"inspectImage",()=>{if(this.connectionState!==Vi.CONNECTED)throw new B(b.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===Vi.CONNECTED?this.requestToInspectImage():g.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=_t(5,"image-moderation-"),this._workerMessageLengthLimit=w("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=w("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=t.interval)!==null&&n!==void 0?n:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=w("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Ch("worker-"+this._moderationId,an),this.on(Fo.STATE_CHANGE,(r,i)=>{g.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Cl[r]," ").concat(i||""))}),this.handleWorkerEvents()}async init(t,n){this.emit(Fo.STATE_CHANGE,Cl.CONNECT_AP),this._connectInfo=t;const r=this._cancelTokenSource.token;return this._retryConfig=n,new se((i,o)=>{this.on(Fo.CONNECTION_STATE_CHANGE,(s,c)=>{s===Vi.CONNECTED&&i()}),this.requestAP(t,r,n).then(s=>{this.connectWorker(s)}).catch(s=>{o(s)})})}updateConfig(t){var n;this._moderationInterval=(n=t.interval)!==null&&n!==void 0?n:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),g.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===Vi.CONNECTED&&this.inspectImage()}async requestAP(t,n,r){const i=w("WEBCS_DOMAIN").map(l=>"https://".concat(l,"/api/v1")),o=await function(l,u,h,f){let{appId:_,areaCode:E,cname:I,sid:v,token:R,uid:A}=u;Ol++;const O="moderation_plugin",P={service_name:O,json_body:JSON.stringify({appId:_,areaCode:E,cname:I,command:"allocateEdge",requestId:Ol,seq:Ol,sid:v,appToken:R,ts:Date.now(),uid:A+""})};let M,U,L=l[0];return Mo(async()=>{M=Date.now();const V=await jo(L,{data:P,cancelToken:h,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(U=Date.now()-M,V.code!==0){const Ae=new B(b.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+V.code,{retry:!0,responseTime:U});throw g.error(Ae.toString()),Ae}const H=JSON.parse(V.json_body);if(H.code!==200){const Ae=new B(b.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(H.code,", reason: ").concat(H.reason),{code:H.code,responseTime:U});throw g.error(Ae.toString()),Ae}if(!H.servers||!Array.isArray(H.servers)||H.servers.length===0){const Ae=new B(b.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:H.code,responseTime:U});throw g.error(Ae.toString()),Ae}if(!H.servers.some(Ae=>!!Ae.wss)){const Ae=new B(b.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:H.code,responseTime:U});throw g.error(Ae.toString()),Ae}const q=w("IMAGE_MODERATION_WORKER_WSS");if(q)return{addressList:[q],workerToken:H.workerToken,vid:H.vid,responseTime:U};const de=w("IMAGE_MODERATION_WORKER_HOST");return{addressList:H.servers.map(Ae=>{let{address:Ge,wss:xe}=Ae;if(Ge&&xe)return"wss://".concat(Ge.replace(/\./g,"-"),".").concat(de,":").concat(xe,"/moderation")}).filter(Ae=>!!Ae),workerToken:H.workerToken,vid:H.vid,ticket:H.appTicket,responseTime:U}},(V,H)=>(pe.apworkerEvent(v,{success:!0,sc:200,serviceName:O,responseDetail:JSON.stringify(V.addressList),firstSuccess:H===0,responseTime:U,serverIp:l[H%l.length]}),!1),(V,H)=>(pe.apworkerEvent(v,{success:!1,sc:V.data&&V.data.code||200,serviceName:O,responseTime:U,serverIp:l[H%l.length]}),!!(V.code!==b.OPERATION_ABORTED&&V.code!==b.UNEXPECTED_RESPONSE||V.data&&V.data.retry)&&(L=l[(H+1)%l.length],!0)),f)}(i,t,n,r);this.emit(Fo.STATE_CHANGE,Cl.AP_CONNECTED);const{addressList:s,ticket:c}=o;return this._ticket=c,s}async connectWorker(t){this.emit(Fo.STATE_CHANGE,Cl.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(Fe.CONNECTED,async()=>{this.emit(Fo.STATE_CHANGE,Cl.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=Vi.CONNECTED}),this._workerConnection.on(Fe.CLOSED,()=>{this.connectionState=Vi.CLOSED}),this._workerConnection.on(Fe.FAILED,()=>{this.connectionState=Vi.CLOSED}),this._workerConnection.on(Fe.RECONNECTING,()=>{this.connectionState=this.connectionState===Vi.CONNECTED?Vi.RECONNECTING:Vi.CONNECTING}),this._workerConnection.on(Fe.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const n=XX(new Uint8Array(t.data));w("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&g.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,g.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{pe.reportApiInvoke(this._connectInfo.sid||null,{name:Ft.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:It.TRACER}).onError(new B(b.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null},w("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else g.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(Fe.WILL_RECONNECT,(t,n,r)=>{t==="recover"&&r(t),r("tryNext")}),this._workerConnection.on(Fe.REQUEST_NEW_URLS,(t,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(n)})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=ni(this,Fo.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(w("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&g.debug("Only the track being played can be inspected"));this._sequence++;const r=await this.generateRequestData(t,n);this._workerConnection.sendMessage(r,!0,!0)}else w("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&g.debug("Only the track being published can be inspected")}async generateRequestData(t,n){let{appId:r,cname:i,cid:o,vid:s,sid:c,uid:l}=n;const u=Date.now(),h=await t.getCurrentFrameImage("image/jpeg",this.quality),f=await RL(h,r,i),_=this._sequence+"-"+o+"-"+l+"-"+u+"-"+_t(12,""),E={appId:r,cid:o,cname:i,deviceId:"",elapse:fy.intToLong(Number(u-this._moderationStartTime)),fileSize:h.buffer.byteLength,height:h.height,width:h.width,jpg:f,networkType:6,osType:7,requestId:_,sdkVersion:"4.24.2",sequence:this._sequence,sid:c,timestamp:QM(u),uid:l,vid:s,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete E.callbackData;const I=qX(E);if(I.byteLength<this._workerMessageLengthLimit){if(w("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const v=function(R){for(var A=1;A<arguments.length;A++){var O=arguments[A]!=null?arguments[A]:{};A%2?ZM(Object(O),!0).forEach(function(P){y(R,P,O[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(R,Object.getOwnPropertyDescriptors(O)):ZM(Object(O)).forEach(function(P){Object.defineProperty(R,P,Object.getOwnPropertyDescriptor(O,P))})}return R}({},E);delete v.jpg,g.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(v))}return I}{const v=this.quality*this._qualityRatio;return this.quality=v,await this.generateRequestData(t,{appId:r,cname:i,cid:o,vid:s,sid:c,uid:l})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=br.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=Vi.CLOSED,this.emit(Fo.STATE_CHANGE,Cl.CLOSED)}}function $M(e){if(Ct(e.interval,"interval",1e3,1/0),e&&e.extraInfo&&e.extraInfo.length>1024)throw new B(b.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(e&&e.vendor&&e.vendor.length>1024)throw new B(b.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}const rJ={name:"ImageModeration",create:function(e){let{config:t}=e;return $M(t),new fy(t)}};var e2,t2,n2,r2,i2,o2,s2,a2,c2,d2,l2,u2,h2,p2,f2,_2,m2,E2,g2,S2,T2,v2,R2,y2,C2,I2,w2,A2,b2,O2,N2,D2,P2,L2,k2,M2,U2,x2,V2,F2,B2,j2,le;function G2(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function _o(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?G2(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):G2(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}Ln.setLogger(g);let iJ=(e2=Ie(),t2=Ie({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof ml))return[t];t=[t]}return t.map(n=>n?Object(n).toString():"null")}}),n2=Ie({argsMap:(e,t)=>(t||(t=[]),Array.isArray(t)||t.trackMediaType!==_l.DATA?(Array.isArray(t)||(t=[t]),t.map(n=>n.getTrackId())):[t.getChannelId()])}),r2=Ie({argsMap:(e,t,n,r)=>[typeof t=="object"?t.uid:t,n,r]}),i2=Ie({argsMap:(e,t,n)=>[t,n]}),o2=Ie({argsMap:(e,t)=>t.map(n=>{let{user:r,mediaType:i}=n;return[r==null?void 0:r.uid,i]})}),s2=Ie({argsMap:(e,t,n,r)=>[typeof t=="object"?t.uid:t,n,r]}),a2=Ie({argsMap:(e,t)=>t.map(n=>{let{user:r,mediaType:i}=n;return{uid:r==null?void 0:r.uid,mediaType:i}})}),c2=Ie(),d2=Ie(),l2=Ie(),u2=Ie(),h2=Ie(),p2=Ie(),f2=Ie(),_2=Ie(),m2=Ie(),E2=Ie(),g2=Ie(),S2=Ie(),T2=Ie(),v2=Ie(),R2=Ie(),y2=Ie(),C2=Ie({argsMap:(e,t)=>[t]}),I2=Ie(),w2=Ie(),A2=Ie(),b2=Ie(),O2=Ie(),N2=Ie(),D2=Ie(),P2=Ie(),L2=Ie({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),k2=Ie(),M2=Ie(),U2=Ie(),x2=Ie(),V2=Ie(),F2=Ie(),B2=Ie({reportResult:!0}),j2=Ie(),le=class extends Wt{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e,t){let n;if(super(),y(this,"store",void 0),y(this,"_uid",void 0),y(this,"_channelName",void 0),y(this,"_uintUid",void 0),y(this,"_users",[]),y(this,"_config",void 0),y(this,"_clientId",void 0),y(this,"_appId",void 0),y(this,"_sessionId",null),y(this,"_key",void 0),y(this,"_rtmConfig",{}),y(this,"_joinInfo",void 0),y(this,"_gateway",void 0),y(this,"_statsCollector",void 0),y(this,"_configDistribute",void 0),y(this,"_leaveMutex",void 0),y(this,"_publishMutex",void 0),y(this,"_renewTokenMutex",void 0),y(this,"_subscribeMutex",void 0),y(this,"_encryptionMode","none"),y(this,"_encryptionSecret",null),y(this,"_encryptionSalt",null),y(this,"_encryptDataStream",!1),y(this,"_encryptDataStreamKey",null),y(this,"_encryptDataStreamIv",null),y(this,"_proxyServer",void 0),y(this,"_turnServer",{servers:[],mode:"auto"}),y(this,"_cloudProxyServerMode","disabled"),y(this,"_isDualStreamEnabled",!1),y(this,"_defaultStreamFallbackType",void 0),y(this,"_lowStreamParameter",void 0),y(this,"_streamFallbackTypeCacheMap",new Map),y(this,"_remoteStreamTypeCacheMap",new Map),y(this,"_axiosCancelSource",br.CancelToken.source()),y(this,"_audioVolumeIndicationInterval",void 0),y(this,"_networkQualityInterval",void 0),y(this,"_userOfflineTimeout",void 0),y(this,"_streamRemovedTimeout",void 0),y(this,"_rteDetailInterval",void 0),y(this,"_liveTranscodeStreamingClient",void 0),y(this,"_liveRawStreamingClient",void 0),y(this,"_channelMediaRelayClient",void 0),y(this,"_networkQualitySensitivity","normal"),y(this,"_p2pChannel",void 0),y(this,"_useLocalAccessPoint",!1),y(this,"_setLocalAPVersion",void 0),y(this,"_joinAndNotLeaveYet",!1),y(this,"_numberOfJoinCount",0),y(this,"_joinResponse",null),y(this,"_remoteDefaultVideoStreamType",void 0),y(this,"_inspect",void 0),y(this,"_moderation",void 0),y(this,"_license",void 0),y(this,"_pendingPublishedUsers",[]),y(this,"ntpAlignErrorCount",0),y(this,"remoteInboundOffset",0),y(this,"_peerConnectionState",void 0),y(this,"_pendingRtpCapabilityChange",void 0),y(this,"_fallbackServerInfo",void 0),y(this,"_dualStreamMode",void 0),y(this,"_handleLocalTrackEnable",(i,o,s)=>{this.publish(i,!1).then(o).catch(s)}),y(this,"_handleLocalTrackDisable",(i,o,s)=>{this.unpublish(i).then(o).catch(s)}),y(this,"_handleUserOnline",i=>{if(w("BLOCK_LOCAL_CLIENT")&&Wc(i.uid,this.channelName))return void g.debug("[".concat(i.uid,"] will be ignored in local"));this.isStringUID&&typeof i.uid!="string"&&g.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const o=this._users.find(s=>s.uid===i.uid);if(o)o._trust_in_room_=!0,o._is_pre_created&&(o._is_pre_created=!1,this.safeEmit(Ke.USER_JOINED,o));else{const s=new Oa(i.uid,i.uint_id||i.uid);this._users.push(s),g.debug("[".concat(this._clientId,"] user online"),i.uid),this.store.firstVideoFrameDecoded(s.uid,{userJoinNotify:Date.now()}),this.safeEmit(Ke.USER_JOINED,s)}}),y(this,"_handleUserOffline",i=>{if(w("BLOCK_LOCAL_CLIENT")&&Wc(i.uid,this.channelName))return;const o=this._users.find(s=>s.uid===i.uid);o&&(this._handleRemoveStream(i),this._handleRemoveDataChannels(i),o._audio_pre_subscribed||o._video_pre_subscribed?o._is_pre_created=!0:A_(this._users,o),this._remoteStreamTypeCacheMap.delete(o.uid),this._streamFallbackTypeCacheMap.delete(o.uid),g.debug("[".concat(this._clientId,"] user offline"),i.uid,"reason:",i.reason),this.safeEmit(Ke.USER_LEAVED,o,i.reason))}),y(this,"_handleAddAudioOrVideoStream",(i,o,s,c,l,u,h,f)=>{if(w("BLOCK_LOCAL_CLIENT")&&Wc(o,this.channelName))return;const _=this._users.find(v=>v.uid===o);if(!_)return void g.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));g.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(i)),this.store.subscribe(_.uid,i,void 0,void 0,void 0,Date.now()),i==="video"&&this.store.firstVideoFrameDecoded(_.uid,{videoAddNotify:Date.now()});const E=i==="audio"?_.hasAudio:_.hasVideo;_._uintid||(_._uintid=u||o),i==="audio"?_._trust_audio_stream_added_state_=!0:_._trust_video_stream_added_state_=!0,i==="audio"?(_._audio_added_=!0,s!==void 0&&(_._audioSSRC=s),c!==void 0&&(_._cname=c),h&&(_._audioOrtc=h)):(_._video_added_=!0,s!==void 0&&(_._videoSSRC=s),c!==void 0&&(_._cname=c),f!==void 0&&(_._rtxSsrcId=f),h&&(_._videoOrtc=h)),(i==="audio"?_.hasAudio:_.hasVideo)&&!E&&(g.info("[".concat(this._clientId,"] remote user ").concat(_.uid," published ").concat(i)),this.safeEmit(Ke.USER_PUBLISHED,_,i)),i==="video"?pe.onGatewayStream(this._sessionId,_n.ON_ADD_VIDEO_STREAM,Bt.ON_ADD_VIDEO_STREAM,{peer:u||o,ssrc:_._videoSSRC}):pe.onGatewayStream(this._sessionId,_n.ON_ADD_AUDIO_STREAM,Bt.ON_ADD_AUDIO_STREAM,{peer:u||o,ssrc:_._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(_,i,s).then(v=>{if(v&&(g.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(_.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Xc))return this._p2pChannel.unsubscribe(_,i,!0).then(()=>this._subscribe(_,i,!0).catch(R=>{g.error("[".concat(this._clientId,"] resubscribe error"),R.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(_,i)&&(g.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(_.uid," after reconnect.")),this._subscribe(_,i,!0).catch(v=>{g.error("[".concat(this._clientId,"] resubscribe error"),v.toString())}));const I=this._getEncodingName(l);i==="video"&&(I==="unknown"?this.safeEmit(Ke.AV1_DECODABLE_RESULT,!1):Pn()||sr()||(I==null?void 0:I.toLocaleLowerCase())!==Mc.av1||AX().then(v=>{w("FLS_ENABLE_AV1_DECODE_DETECT")&&this.safeEmit(Ke.AV1_DECODABLE_RESULT,v),v||this._gateway.downgradeCodec(I)}))}),y(this,"_handleRemoveStream",i=>{if(w("BLOCK_LOCAL_CLIENT")&&Wc(i.uid,this.channelName))return;const o=this._users.find(c=>c.uid===i.uid);if(!o)return void g.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));g.debug("[".concat(this._clientId,"] stream removed with uid ").concat(i.uid));let s=()=>{};o.hasAudio&&o.hasVideo?s=()=>{g.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(Ke.USER_UNPUBLISHED,o,"audio"),g.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(Ke.USER_UNPUBLISHED,o,"video")}:o.hasVideo?s=()=>{g.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(Ke.USER_UNPUBLISHED,o,"video")}:o.hasAudio&&(s=()=>{g.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(Ke.USER_UNPUBLISHED,o,"audio")}),o._video_pre_subscribed||o._audio_pre_subscribed||(o._trust_audio_stream_added_state_=!0,o._trust_video_stream_added_state_=!0,o._audio_added_=!1,o._video_added_=!1,this._p2pChannel instanceof Xc&&this._p2pChannel.unsubscribe(o).then(c=>{if(c)return this._gateway.unsubscribe(c,o.uid)}),o._audioSSRC=void 0,o._videoSSRC=void 0,o._audioOrtc=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),pe.onGatewayStream(this._sessionId,_n.ON_REMOVE_STREAM,Bt.ON_REMOVE_STREAM,{peer:i.uint_id||i.uid}),s()}),y(this,"_handleSetStreamLocalEnable",(i,o,s)=>{if(w("BLOCK_LOCAL_CLIENT")&&Wc(o,this.channelName))return;const c=this._users.find(h=>h.uid===o);if(!c)return void g.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));g.debug("[".concat(this._clientId,"] local ").concat(i," ").concat(s?"enabled":"disabled"," with uid ").concat(o));const l=i==="audio"?c.hasAudio:c.hasVideo;if(i==="audio"){c._trust_audio_enabled_state_=!0;const h=c._audio_enabled_;if(c._audio_enabled_=s,c._audio_enabled_===h)return;{const f=c._audio_enabled_?"enable-local-audio":"disable-local-audio";g.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(o,", msg: ").concat(f)),this.safeEmit(Ke.USER_INFO_UPDATED,o,f)}}else{c._trust_video_enabled_state_=!0;const h=c._video_enabled_;if(c._video_enabled_=s,c._video_enabled_===h)return;{const f=c._video_enabled_?"enable-local-video":"disable-local-video";g.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(f)),this.safeEmit(Ke.USER_INFO_UPDATED,o,f)}}const u=i==="audio"?c.hasAudio:c.hasVideo;return l!==u?!l&&u?(g.info("[".concat(this._clientId,"] remote user ").concat(o," published ").concat(i)),void this.safeEmit(Ke.USER_PUBLISHED,c,i)):(i==="video"&&c._videoTrack&&c._videoTrack._destroy(),i==="audio"&&c._audioTrack,this._p2pChannel.muteRemote(c,i),g.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished ").concat(i)),void this.safeEmit(Ke.USER_UNPUBLISHED,c,i)):void 0}),y(this,"_handleMuteStream",(i,o,s)=>{if(w("BLOCK_LOCAL_CLIENT")&&Wc(i,this.channelName))return;g.debug("[".concat(this._clientId,"] receive mute message"),i,o,s);const c=this._users.find(h=>h.uid===i);if(!c)return void g.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(i));const l=o==="audio"?c.hasAudio:c.hasVideo;if(o==="audio"){c._trust_audio_mute_state_=!0;const h=c._audio_muted_;if(c._audio_muted_=s,c._audio_muted_===h)return;{const f=c._audio_muted_?"mute-audio":"unmute-audio";g.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(f)),this.safeEmit(Ke.USER_INFO_UPDATED,i,f)}}else{c._trust_video_mute_state_=!0;const h=c._video_muted_;if(c._video_muted_=s,c._video_muted_===h)return;{const f=c._video_muted_?"mute-video":"unmute-video";g.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(f)),this.safeEmit(Ke.USER_INFO_UPDATED,i,f)}}const u=o==="audio"?c.hasAudio:c.hasVideo;if(l!==u){if(!l&&u)return(o==="audio"?c._audioSSRC:c._videoSSRC)?(g.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(o)),void this.safeEmit(Ke.USER_PUBLISHED,c,o)):void g.warning("[".concat(this._clientId,"] remote user ").concat(i," receive ").concat(o," unmute message  before add stream message, ").concat(o," SSRC doesn't exist yet."));o==="video"&&c._videoTrack&&!c._video_pre_subscribed&&c._videoTrack._destroy(),o==="audio"&&c._audioTrack,this._p2pChannel.muteRemote(c,o),g.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(o)),this.safeEmit(Ke.USER_UNPUBLISHED,c,o)}}),y(this,"_handleP2PLost",async i=>{g.debug("[".concat(this._clientId,"] receive p2p lost"),i),parseInt(i.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():g.warning("[".concat(this._clientId,"] P2PLost stream not found"),i)}),y(this,"_handleTokenWillExpire",()=>{g.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(Ke.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),y(this,"_handleBeforeUnload",i=>{i.type==="beforeunload"&&i.returnValue!==void 0&&i.returnValue!==""||(this.leave(),g.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),y(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(Ke.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const i={downlinkNetworkQuality:0,uplinkNetworkQuality:0};i.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),i.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(Ke.NETWORK_QUALITY,i)}),y(this,"_handleP2PAddAudioOrVideoStream",(i,o,s,c)=>{const l=this._users.find(h=>h.uid===o);if(!l)return void g.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));g.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(i)),this.store.subscribe(l.uid,i,void 0,void 0,void 0,Date.now());const u=i==="audio"?l.hasAudio:l.hasVideo;i==="audio"?l._trust_audio_stream_added_state_=!0:l._trust_video_stream_added_state_=!0,i==="audio"?(l._audio_added_=!0,s!==void 0&&(l._audioSSRC=s),c!==void 0&&(l._audioMid=c)):(l._video_added_=!0,s!==void 0&&(l._videoSSRC=s),c!==void 0&&(l._videoMid=c)),(i==="audio"?l.hasAudio:l.hasVideo)&&!u&&(g.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published ").concat(i)),this.safeEmit(Ke.USER_PUBLISHED,l,i)),this._p2pChannel.hasPendingRemoteMedia(l,i)&&(g.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(l.uid," after reconnect.")),this._subscribe(l,i,!0).catch(h=>{g.error("[".concat(this._clientId,"] resubscribe error"),h.toString())}))}),this._config=e,this._clientId=t||_t(5,"client-"),this.store=new class{constructor(i,o,s,c,l){ke(this,"state",void 0),this.state={codec:i,audioCodec:o,mode:s,clientId:c,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[],firstVideoFrameDecoded:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:kc.Default,hasStartJoinChannel:!1,isABTestSuccess:!1,rteUrl:void 0,rteSid:void 0,autoSubscribe:!1,enableInstantMuteRestore:!1,networkQualityProbe:!1,useDcSignal:!!l}}dispatch(i){this.state=function(o,s){switch(s.type){case De.SET_SESSION_ID:return te(te({},o),{},{sessionId:s.sessionId});case De.SET_P2P_ID:return te(te({},o),{},{p2pId:s.p2pId});case De.SET_UID:return te(te({},o),{},{uid:s.uid});case De.SET_INT_UID:return te(te({},o),{},{intUid:s.intUid});case De.SET_PUB_ID:return te(te({},o),{},{pubId:s.pubId});case De.KEY_METRIC_CLIENT_CREATED:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{clientCreated:s.metric})});case De.KEY_METRIC_JOIN_START:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{joinStart:s.metric})});case De.KEY_METRIC_PRELOAD_START:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{preloadStart:s.metric})});case De.KEY_METRIC_PRELOAD_END:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{preloadEnd:s.metric})});case De.KEY_METRIC_JOIN_END:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{joinEnd:s.metric})});case De.KEY_METRIC_REQUEST_AP_START:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{requestAPStart:s.metric})});case De.KEY_METRIC_REQUEST_AP_END:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{requestAPEnd:s.metric})});case De.KEY_METRIC_REQUEST_SUA_END:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{requestSUAEnd:s.metric})});case De.KEY_METRIC_BEFORE_CONNECT:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{beforeConnect:s.metric})});case De.KEY_METRIC_PEER_RECEIVER:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{peerReceiver:s.metric})});case De.KEY_METRIC_SIGNAL_CONNECTED:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{signalConnected:s.metric})});case De.KEY_METRIC_JOIN_REQ:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{joinReq:s.metric})});case De.KEY_METRIC_JOIN_REP:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{joinRep:s.metric})});case De.KEY_METRIC_JOIN_GATEWAY_START:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{joinGatewayStart:s.metric})});case De.KEY_METRIC_JOIN_GATEWAY_END:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{joinGatewayEnd:s.metric})});case De.KEY_METRIC_PEER_CONNECTION_START:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{peerConnectionStart:s.metric})});case De.KEY_METRIC_PEER_CONNECTION_END:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{peerConnectionEnd:s.metric})});case De.KEY_METRIC_DESCRIPTION_START:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{descriptionStart:s.metric})});case De.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{signalChannelOpen:s.metric})});case De.KEY_METRIC_ICE_CONNECTION_END:return te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{iceConnectionEnd:s.metric})});case De.KEY_METRIC_PUBLISH:{const c=o.keyMetrics.publish,l=c.findIndex(u=>u.trackId===s.metric.trackId);return l!==-1?(c[l]=te(te({},c[l]),s.metric),te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{publish:[...c]})})):te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{publish:[...o.keyMetrics.publish,s.metric]})})}case De.KEY_METRIC_SUBSCRIBE:{const c=o.keyMetrics.subscribe,l=c.findIndex(u=>u.userId===s.metric.userId&&u.type===s.metric.type);return l!==-1?(c[l]=te(te({},c[l]),s.metric),te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{subscribe:[...c]})})):te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{subscribe:[...o.keyMetrics.subscribe,s.metric]})})}case De.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED:{const c=o.keyMetrics.firstVideoFrameDecoded,l=c.findIndex(u=>u.userId===s.metric.userId);return l!==-1?(c[l]=te(te({},c[l]),s.metric),te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{firstVideoFrameDecoded:[...c]})})):te(te({},o),{},{keyMetrics:te(te({},o.keyMetrics),{},{firstVideoFrameDecoded:[...o.keyMetrics.firstVideoFrameDecoded,s.metric]})})}case De.RESET_FIRST_VIDEO_FRAME_DECODED:return o.keyMetrics.firstVideoFrameDecoded=[],o;case De.SET_CLOUD_PROXY_SERVER_MODE:return o.cloudProxyServerMode=s.mode,o;case De.RECORD_JOIN_CHANNEL_SERVICE:return typeof s.index!="number"?o.joinChannelServiceRecords=[...o.joinChannelServiceRecords,s.record]:(o.joinChannelServiceRecords[s.index]=te(te({},o.joinChannelServiceRecords[s.index]),s.record),o.joinChannelServiceRecords=[...o.joinChannelServiceRecords]),o;case De.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return o.joinChannelServiceRecords=[],o;case De.RESET_KEY_METRICS:return o.keyMetrics={publish:[],subscribe:[],firstVideoFrameDecoded:[]},o;case De.SET_USE_P2P:return te(te({},o),{},{useP2P:s.val});case De.SET_TRANSPORT_TYPE:return te(te({},o),{},{p2pTransport:s.val});case De.SET_RTE_URL:return te(te({},o),{},{rteUrl:s.rteUrl});case De.SET_RTE_SID:return te(te({},o),{},{rteSid:s.rteSid});default:return o}}(this.state,i)}get useDcSignal(){return this.state.useDcSignal}set useDcSignal(i){this.state.useDcSignal=i}set autoSubscribe(i){this.state.autoSubscribe=i}get autoSubscribe(){return this.state.autoSubscribe}set enableInstantMuteRestore(i){this.state.enableInstantMuteRestore=i}get enableInstantMuteRestore(){return this.state.enableInstantMuteRestore}set networkQualityProbe(i){this.state.networkQualityProbe=i}get networkQualityProbe(){return this.state.networkQualityProbe}set sessionId(i){this.dispatch({type:De.SET_SESSION_ID,sessionId:i})}get sessionId(){return this.state.sessionId}set rteUrl(i){this.dispatch({type:De.SET_RTE_URL,rteUrl:i})}get rteUrl(){return this.state.rteUrl}set rteSid(i){this.dispatch({type:De.SET_RTE_SID,rteSid:i})}get rteSid(){return this.state.rteSid}set cid(i){this.state.cid=i}get cid(){return this.state.cid}set codec(i){this.state.codec=i}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(i){this.dispatch({type:De.SET_P2P_ID,p2pId:i})}get p2pId(){return this.state.p2pId}set dcId(i){this.dispatch({type:De.SET_DC_ID,dcId:i})}get dcId(){return this.state.dcId}set uid(i){this.dispatch({type:De.SET_UID,uid:i})}get uid(){return this.state.uid}set intUid(i){this.dispatch({type:De.SET_INT_UID,intUid:i})}get intUid(){return this.state.intUid}set pubId(i){this.dispatch({type:De.SET_PUB_ID,pubId:i})}get pubId(){return this.state.pubId}set cloudProxyServerMode(i){this.dispatch({type:De.SET_CLOUD_PROXY_SERVER_MODE,mode:i})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(i){this.dispatch({type:De.SET_USE_P2P,val:i})}get useP2P(){return this.state.useP2P}set p2pTransport(i){this.dispatch({type:De.SET_TRANSPORT_TYPE,val:i})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(i){this.state.hasStartJoinChannel=i}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(i){this.state.isABTestSuccess=i}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:De.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:De.KEY_METRIC_JOIN_START,metric:Date.now()})}preloadStart(){this.dispatch({type:De.KEY_METRIC_PRELOAD_START,metric:Date.now()})}preloadEnd(){this.dispatch({type:De.KEY_METRIC_PRELOAD_END,metric:Date.now()})}joinEnd(){this.dispatch({type:De.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:De.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:De.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}requestSUAEnd(){this.dispatch({type:De.KEY_METRIC_REQUEST_SUA_END,metric:Date.now()})}beforeConnect(){this.dispatch({type:De.KEY_METRIC_BEFORE_CONNECT,metric:Date.now()})}peerReceiver(){this.dispatch({type:De.KEY_METRIC_PEER_RECEIVER,metric:Date.now()})}signalConnected(){this.dispatch({type:De.KEY_METRIC_SIGNAL_CONNECTED,metric:Date.now()})}joinReq(){this.dispatch({type:De.KEY_METRIC_JOIN_REQ,metric:Date.now()})}joinRep(){this.dispatch({type:De.KEY_METRIC_JOIN_REP,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:De.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:De.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:De.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:De.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}firstVideoFrameDecoded(i,o){this.dispatch({type:De.KEY_METRIC_FIRST_VIDEO_FRAME_DECODED,metric:te({userId:i},o)})}descriptionStart(){this.dispatch({type:De.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:De.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:De.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(i,o,s,c){this.dispatch({type:De.KEY_METRIC_PUBLISH,metric:te(te({trackId:i,type:o},s&&{publishStart:s}),c&&{publishEnd:c})})}subscribe(i,o,s,c,l,u,h){this.dispatch({type:De.KEY_METRIC_SUBSCRIBE,metric:te(te(te(te(te({userId:i,type:o},s&&{subscribeStart:s}),c&&{subscribeEnd:c}),l&&{firstFrame:l}),u&&{streamAdded:u}),h&&{firstDecoded:h})})}massSubscribe(i,o,s,c){i.forEach(l=>{this.dispatch({type:De.KEY_METRIC_SUBSCRIBE,metric:te(te(te({userId:l.userId,type:l.type},o&&{subscribeStart:o}),s&&{subscribeEnd:s}),c&&{firstFrame:c})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(i,o){i.service==="gateway"&&Array.isArray(i.urls)&&(i.urls=i.urls.map(s=>s.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof o!="number"?(this.dispatch({type:De.RECORD_JOIN_CHANNEL_SERVICE,record:te(te({},i),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(o<0||o>=this.state.joinChannelServiceRecords.length||this.dispatch({type:De.RECORD_JOIN_CHANNEL_SERVICE,record:i,index:o}),o)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:De.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:De.RESET_KEY_METRICS})}resetFirstVideoFrameDecoded(){this.dispatch({type:De.RESET_FIRST_VIDEO_FRAME_DECODED})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}}(e.codec,e.audioCodec,e.mode,this._clientId,w("SIGNAL_CHANNEL")===1),this._leaveMutex=new Ln("client-leave",this._clientId),this._publishMutex=new Ln("client-publish",this._clientId),this._renewTokenMutex=new Ln("client-renewtoken",this._clientId),this._subscribeMutex=new Ln("client-subscribe",this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),g.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(Li," build: ").concat(Wv,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{bv(e.clientRoleOptions),n=Object.assign({},e.clientRoleOptions)}catch(i){g.warning("[".concat(this._clientId,"] ").concat(i.toString()))}var r;this._statsCollector=new Lh(this.store),this._statsCollector.onStatsException=(i,o,s)=>{g.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(i,", msg: ").concat(o,", uid: ").concat(s)),i===zR.VIDEO_ENCODE_FAILED&&this.localTracks.forEach(c=>{c instanceof H_&&w("ENABLE_ENCODE_EXCEPTION")&&c.findClosestProfile()}),this.safeEmit(Ke.EXCEPTION,{code:i,msg:o,uid:s})},this._statsCollector.onUploadPublishDuration=(i,o,s,c)=>{const l=this._users.find(u=>u.uid===i);l&&(this.store.keyMetrics&&(this.store.firstVideoFrameDecoded(l.uid,{peerPublishDuration:s,peerPubStatusMs:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(l)),pe.peerPublishStatus(this._sessionId,{subscribeElapse:c,audioPublishDuration:o,videoPublishDuration:s,peer:l._uintid}))},this._statsCollector.onVideoCodecChanged=i=>{if(w("VIDEO_STANDARD_BITRATE_VERSION")&&(i==="av1"||i==="h265"||i==="h264")){const o=this.localTracks.find(s=>s instanceof wt);o&&o._saveEncodeBitrateRatio!==1&&o.setSaveEncodeBitrateRatio(i==="h264"?w("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P=e.mode==="p2p",this._gateway=new vX(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||an,httpRetryConfig:e.httpRetryConfig||an,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:n}),this._configDistribute=new PX(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(r={store:this.store,statsCollector:this._statsCollector},Bo("P2PChannel").create(r)),this._handleP2PEvents()):this._p2pChannel=new Xc(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,n,r,i){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],s=arguments.length>6&&arguments[6]!==void 0&&arguments[6];vt("JOIN_GATEWAY_USE_443PORT_ONLY",o),vt("JOIN_GATEWAY_USE_DUAL_DOMAIN",s);const c=this._gateway.signal.websocket;return c instanceof bR&&(c.use443PortOnly=o,c.tryDoubleDomain=s),async function(l,u,h){y_.get(l)||y_.set(l,[]),C_.get(l)||C_.set(l,u),ls.get(l)||ls.set(l,0);const f=y_.get(l),_=C_.get(l);if(!f||!_)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(ls.get(l)===_){const A=uh();f.push(A),await A.promise}ls.set(l,ls.get(l)+1);for(var E=arguments.length,I=new Array(E>3?E-3:0),v=3;v<E;v++)I[v-3]=arguments[v];const R=await h(...I);return ls.set(l,ls.get(l)-1),ls.get(l)===_-1&&f.length>0&&(f[0].resolve(),f.shift()),ls.get(l)===0&&(y_.set(l,[]),C_.set(l,0),ls.set(l,0)),R}("client.join",w("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,n,r,i)}async join(e,t,n,r,i){const o=++this._numberOfJoinCount;this.store.joinStart(),r&&(this.store.uid=r);const s=(N_||N_||(N_=(window.location.protocol.split(":")[0]||"").toUpperCase(),N_))==="HTTPS",c=LP()?window.isSecureContext:"Browser Not Support";(!LP()&&!s||!window.isSecureContext)&&g.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser");let l;pe.setAppId(e);try{if(!n&&n!==null)throw new B(b.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));if(n&&jn(n,"token",1,2047),jn(e,"appid",1,2047),tm(t),r&&nm(r),i)if(typeof i=="string")jn(i,"optionalInfo",1,256),l=i;else{if(typeof i!="object")throw new B(b.INVALID_PARAMS,"Invalid options: options is not a string or object");{const{autoSubscribe:R,enableInstantMuteRestore:A,networkQualityProbe:O}=i;R&&(io(R,"autoSubscribe"),g.info("[".concat(this._clientId,"] join: autoSubscribe: ").concat(R)),this.store.autoSubscribe=R),A&&(io(A,"enableInstantMuteRestore"),g.info("[".concat(this._clientId,"] join: enableInstantMuteRestore: ").concat(A)),this.store.enableInstantMuteRestore=A),O&&(io(O,"networkQualityProbe"),g.info("[".concat(this._clientId,"] join: networkQualityProbe: ").concat(O)),this.store.networkQualityProbe=O)}}}catch(R){throw pe.reportApiInvoke(Lc(),{name:Ft.JOIN,options:[e,t,n,r],states:{isHttps:s,isSecureContext:c},tag:It.TRACER}).onError(R),R}if(this._leaveMutex.isLocked&&(g.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),g.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const R=new B(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw pe.reportApiInvoke(Lc(),{name:Ft.JOIN,options:[e,t,n,r],states:{isHttps:s,isSecureContext:c},tag:It.TRACER}).onError(R),R}this._gateway.state="CONNECTING",this.store.preloadStart();const u=await ly({appId:e,cname:t,uid:r,stringUid:typeof r=="string"?r:void 0,token:n||e,cloudProxyServer:this._cloudProxyServerMode});if(this.store.preloadEnd(),!this._joinAndNotLeaveYet)throw new B(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));const h=(u==null?void 0:u.sid)||Lc();g.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(o)),this._sessionId||(this._sessionId=h,this.store.sessionId=this._sessionId);const f=pe.reportApiInvoke(this._sessionId,{id:this._clientId,name:Ft.JOIN,options:[e,t,n,r],states:{isHttps:s,isSecureContext:c},tag:It.TRACER}),_=_o(_o(_o({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:typeof r!="string"?r:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:l,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!u},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:w("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(_.setLocalAPVersion=this._setLocalAPVersion),typeof r=="string"&&(_.stringUid=r,this._uintUid?(_.uid=this._uintUid,this._uintUid=void 0):_.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(_.aesmode=this._encryptionMode,_.aespassword=await(async R=>{const A=function(U){const L=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),V=new Uint8Array(new ArrayBuffer(L.length));for(let H=0;H<L.length;H+=1)V[H]=L.charCodeAt(H);return V}(),O=await window.crypto.subtle.importKey("spki",A,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),P=wv(R),M=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},O,P);return function(U){let L="";for(let V=0;V<U.length;V+=1)L+=String.fromCharCode(U[V]);return window.btoa(L)}(new Uint8Array(M))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new B(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(_.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const R=new TextEncoder,A=w("USE_PURE_ENCRYPTION_MASTER_KEY")?R.encode(_.appId+this._encryptionSecret+this._encryptionSecret):R.encode(_.appId+_.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(O,P,M){const U=await window.crypto.subtle.importKey("raw",P,"PBKDF2",!1,["deriveBits","deriveKey"]),L=O==="aes-128-gcm2"?128:256,V=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:WP,hash:"SHA-256",salt:M},U,L+$7);return new Uint8Array(V).subarray(L/8)}(this._encryptionMode,A,Pc(this._encryptionSalt)),this._encryptDataStreamKey=await async function(O,P,M){const U=await window.crypto.subtle.importKey("raw",P,"PBKDF2",!1,["deriveBits","deriveKey"]),L=O==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:WP,hash:"SHA-256",salt:M},U,{name:"AES-GCM",length:L},!0,["encrypt","decrypt"])}(this._encryptionMode,A,Pc(this._encryptionSalt))}else c?g.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):g.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,g.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:t,appId:e,stringUid:_.stringUid});const E=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&E===this._sessionId&&pe.joinChannelTimeout(this._sessionId,5)},5e3);try{var I;let R;const A=_.cloudProxyServer;if(Z(I=["proxy3","proxy4","proxy5"]).call(I,A)){const L=w("PROXY_SERVER_TYPE3");Array.isArray(L)?_.proxyServer=L[0]:_.proxyServer=L}if(pe.setProxyServer(_.proxyServer),g.setProxyServer(_.proxyServer),this.store.requestAPStart(),u){if(g.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(_.stringUid?", ".concat(_.stringUid," => ").concat(u.intUid):""," ")),_.stringUid&&!_.uid&&(_.uid=u.intUid),R={gatewayInfo:u.ap.gatewayInfo},w("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&_.turnServer.mode==="auto")if(u.ap.proxyInfo.addresses.length===0)g.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const L=(await D1(u.ap.proxyInfo,u.ap.gatewayInfo.uid)).map(V=>({turnServerURL:V.address,tcpport:V.tcpport||qn.tcpport,udpport:V.udpport||qn.udpport,username:V.username||qn.username,password:V.password||qn.password,forceturn:!1,security:!0}));_.turnServer={mode:"manual",servers:L}}FM(u,_.stringUid)}else{if(_.stringUid&&!_.uid){let L;[L,R]=await se.all([oM(_.stringUid,_,this._axiosCancelSource.token,this._config.httpRetryConfig||an,this.store).finally(()=>{this.store.requestSUAEnd()}),iM(_,this._axiosCancelSource.token,this._config.httpRetryConfig||an,!0,this.store).finally(()=>{this.store.requestAPEnd()})]),g.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(_.stringUid," => ").concat(L)),_.uid=L,R.gatewayInfo.uid=L,R.gatewayInfo.res.uid=L}else R=await iM(_,this._axiosCancelSource.token,this._config.httpRetryConfig||an,!0,this.store);if(!this._joinAndNotLeaveYet)throw new B(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(_,this._axiosCancelSource.token),this._configDistribute.on(Vo.UPDATE_BITRATE_LIMIT,L=>{this._p2pChannel.updateBitrateLimit(L)}),this._configDistribute.on(Vo.UPDATE_CLIENT_ROLE_OPTIONS,L=>{this._setClientRoleOptions(L)}),this._configDistribute.on(Vo.UPDATE_REMOTE_VIDEO_STREAM_TYPE,L=>{var V;Z(V=[0,1,4,5,6,7,8,9]).call(V,L)&&(this.remoteUsers.forEach(H=>{this._remoteStreamTypeCacheMap.get(H.uid)!==L&&this.setRemoteVideoStreamType(H.uid,L)}),this.setRemoteDefaultVideoStreamType(L))}),this._configDistribute.on(Vo.FALLBACK_TO_HLS,L=>{L&&this.safeEmit(Ke.FALLBACK_TO_HLS,Ov.CONFIG)}),this._configDistribute.on(Vo.UPDATE_VOS_CONFIGURE,L=>{this._gateway.setConfigure(L).catch(V=>{g.debug("[".concat(this._clientId,"] auto set vos config failed"),V)})})},0),this._key=n||e;const O=R.gatewayInfo,P=_.uid?_.uid:O.uid;this._joinInfo=_o(_o({},_),{},{cid:O.cid,uid:P,vid:O.vid,apResponse:O.res,apGatewayAddress:O.apGatewayAddress,uni_lbs_ip:O.uni_lbs_ip,gatewayAddrs:O.gatewayAddrs}),this.store.intUid=P,this.store.cid=O.cid;const M=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new B(b.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));f.onSuccess(M),this._appId=e,this._channelName=_.cname,this._uid=M,this.store.uid=M,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),!Pn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(Pn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);const U=_.stringUid?"string uid: ".concat(_.stringUid,",uid: ").concat(_.uid):"uid: ".concat(this._uid);return g.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(U)),setTimeout(()=>{g.startUpload()},5e3),this.store.joinEnd(),v=this,Z(Gc).call(Gc,v)||Gc.push(v),this._cloudProxyServerMode==="disabled"&&Xe().supportWebCrypto&&w("ENABLE_PRELOAD")&&hy(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0),this._sessionId&&pe.reportRteDetail(this._sessionId),this._rteDetailInterval=window.setInterval(()=>{this._sessionId&&pe.reportRteDetail(this._sessionId)},w("RTE_DETAIL_REPORT_INTERVAL")||6e4),M}catch(R){const A=Array.isArray(R)?R[0]:R;throw A&&A.code===b.OPERATION_ABORTED?g.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),A):g.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),A),A.code!==b.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),f.onError(A),A}var v}async _joinGateway(){if(!this._joinInfo||!this._key)throw new B(b.INVALID_OPERATION);try{return await this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!w("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}catch(e){if(e.code===b.INIT_DATACHANNEL_TIMEOUT){if(this._gateway.leave(!0,Ze.FALLBACK),g.debug("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new B(b.INVALID_OPERATION);return pe.reportApiInvoke(this._sessionId,{name:Ft.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:It.TRACER}).onSuccess(),await this._joinGateway()}throw e}}async leave(){g.info("[".concat(this._clientId,"] Leaving channel"));const e=()=>{!Pn()&&this.store.useDcSignal?(window.addEventListener("beforeunload",this._handleBeforeUnload),window.addEventListener("pagehide",this._handleBeforeUnload)):window.addEventListener(Pn()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(n){const r=Gc.indexOf(n);r!==-1&&Gc.splice(r,1)}(this),this._statsCollector.stopUpdateStats()};this.store.useDcSignal||e();const t=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return g.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();await this._gateway.leave(this.connectionState!=="CONNECTED",Ze.LEAVE),g.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t(),this.store.useDcSignal&&e()}async publish(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof ml))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new B(b.INVALID_PARAMS,"param list is empty");const n=e;if(this._gateway.role==="audience")throw new B(b.INVALID_OPERATION,"audience can not publish stream");for(const i of n){if(!(i instanceof ml))throw new B(b.INVALID_PARAMS,"parameter is not local track");if(!i._enabled&&t)throw new B(b.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(i.getTrackId()))}g.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map(i=>"".concat(i.getTrackId()," "))));const r=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&n.forEach(i=>{const o=this._configDistribute.getBitrateLimit();i instanceof wt&&o&&i.setBitrateLimit(o.uplink)});try{await this._publishHighStream(n),g.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map(i=>"".concat(i.getTrackId()," "))))}catch(i){throw g.error("[".concat(this._clientId,"] publish error"),i.toString()),i}finally{r()}}async _publishDataChannel(e){if(e==null)throw new B(b.INVALID_PARAMS,"parameter is not local track or datachannel config, config is ".concat(JSON.stringify(e)));Ct(e.id,"id",0,65535,!0),io(e.ordered,"ordered"),jn(e.metadata,"metadata",0,512),g.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const t=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(i=>i.id===e.id)!==-1)throw new B(b.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new B(b.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&w("FORCE_TURN")&&!w("TURN_ENABLE_TCP")&&!w("TURN_ENABLE_UDP"))throw new B(b.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=function(i){return X1(i,!1)}(e),r=await this._p2pChannel.publishDataChannel([n]);if(r.length>0){if(typeof n._originDataChannelId!="number")throw g.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new B(b.CREATE_DATACHANNEL_ERROR);try{await se.all(r.map(i=>this._uid&&this._gateway.publishDataChannel(this._uid,i,!0))),await n._waitTillOpen()}catch(i){if(i.code!==b.DISCONNECT_P2P)throw i}}return g.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw g.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{t()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new B(b.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof ml))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);g.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map(r=>"".concat(r.getTrackId()," "))," "));const n=await this._publishMutex.lock();try{if(this.store.useP2P){const r=await this._p2pChannel.unpublish(t);r&&await this._gateway.sendExtensionMessage(rn.UNPUBLISH,{unpubMsg:r},!0)}else{const r=await this._p2pChannel.unpublish(t);r&&await this._gateway.unpublish(r,this._uid),g.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map(i=>"".concat(i.getTrackId()))))}}catch(r){throw g.error("[".concat(this._clientId,"] unpublish error"),r.toString()),r}finally{n&&n()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),g.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map(n=>"".concat(n.id," "))," "));const t=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(e);n&&await this._gateway.unpublishDataChannel(n),g.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map(r=>"".concat(r.id))))}catch(n){throw g.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{t&&t()}}async subscribe(e,t,n){if(!(e instanceof Oa)){const r=this.remoteUsers.find(i=>i.uid===e);if(!r)throw new B(b.INVALID_REMOTE_USER,"user is not in the channel");e=r}return t==="datachannel"?this._subscribeDataChannel(e,n):this._subscribe(e,t)}async presubscribe(e,t){if(sn(t,"mediaType",["audio","video"]),this.store.useP2P)throw new B(b.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new B(b.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=t===ue.AUDIO,r=t===ue.VIDEO,i=await this._subscribeMutex.lock();try{const{ssrcId:o,ortc:s,rtxSsrcId:c,cname:l,uint_id:u}=await this._gateway.presubscribe(e,t,!0);if(o==null)throw new B(b.UNEXPECTED_RESPONSE,"no ssrc id");let h=this._users.find(_=>_.uid===e);h||(h=new Oa(e,u||e),h._is_pre_created=!0,this._users.push(h)),l&&(h._cname=l),h._uintid||(h._uintid=u||e),n&&(h._audioSSRC=o,h._audio_pre_subscribed=!0,s&&(h._audioOrtc=s)),r&&(h._videoSSRC=o,h._video_pre_subscribed=!0,s&&(h._videoOrtc=s),c!=null&&(h._rtxSsrcId=c)),g.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(h,t,o,c,s);const f=n?h._audioTrack:h._videoTrack;if(!f)throw new B(b.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(h._trust_audio_stream_added_state_=!0,h._audio_added_=!0),r&&(h._trust_video_stream_added_state_=!0,h._video_added_=!0),f}catch(o){throw g.error("[".concat(this._clientId,"] presub user ").concat(e," error"),o),o}finally{i()}}async _subscribeDataChannel(e,t){var n;if(Ct(t,"channelId",0,65535,!0),!this._joinInfo)throw new B(b.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(c=>c===e))throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new B(b.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new B(b.INVALID_REMOTE_USER,"user is not published");const i=(n=e._dataChannels)===null||n===void 0?void 0:n.find(c=>c.id===t);if(!i)throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new B(b.REMOTE_USER_IS_NOT_PUBLISHED);const o=await this._subscribeMutex.lock();g.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const c=await this._p2pChannel.subscribeDataChannel(e,[i]);if(c&&Z(c).call(c,i.id))try{var s;if(typeof i._originDataChannelId!="number")throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new B(b.CREATE_DATACHANNEL_ERROR);const l={id:i.id,datachannelId:i._originDataChannelId,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:(s=i.metadata)!==null&&s!==void 0?s:""};await this._gateway.subscribeDataChannel(e.uid,l,!0),await i._waitTillOpen()}catch(l){if((l==null?void 0:l.code)!==b.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[i]),l;await this._p2pChannel.unsubscribeDataChannel(e,[i]),this._p2pChannel.setPendingRemoteDataChannel(e,i.id)}return g.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),i}finally{o()}}async _p2pSubscribe(e,t,n){if(sn(t,"mediaType",["audio","video"]),!this._joinInfo)throw new B(b.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(o=>o===e)){const o=new B(b.INVALID_REMOTE_USER,"user is not in the channel");throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),o}if(!e.hasAudio&&!e.hasVideo){const o=new B(b.INVALID_REMOTE_USER,"user is not published");throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),o}if(!n&&(t==="audio"&&!e.hasAudio||t==="video"&&!e.hasVideo)){const o=new B(b.REMOTE_USER_IS_NOT_PUBLISHED);throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),o}const i=await this._subscribeMutex.lock();g.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const s=t==="audio"?e._audioSSRC:e._videoSSRC,c=t==="audio"?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this.store.useP2P&&await this._p2pChannel.subscribe(e,t,s,c)}catch(s){throw s}g.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(s=>{g.warning("[".concat(this._clientId,"] auto set fallback failed"),s)});const o=t==="audio"?e._audioTrack:e._videoTrack;if(!o)throw new B(b.UNEXPECTED_ERROR,"can not find remote track in user object");return o}catch(o){throw g.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),o),o}finally{i()}}async _subscribe(e,t,n){if(this.store.useP2P)return this._p2pSubscribe(e,t);if(sn(t,"mediaType",["audio","video"]),!this._joinInfo)throw new B(b.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(u=>u===e)){const u=new B(b.INVALID_REMOTE_USER,"user is not in the channel");throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),u}if(!e.hasAudio&&!e.hasVideo){const u=new B(b.INVALID_REMOTE_USER,"user is not published");throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),u}if(!(n||(t!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(t!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){const u=new B(b.REMOTE_USER_IS_NOT_PUBLISHED);throw g.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),u}let i=t==="audio"?e._audioSSRC:e._videoSSRC,o=t==="audio"?e._audioOrtc:e._videoOrtc,s=t==="video"?e._rtxSsrcId:void 0,c={stream_type:t==="audio"?ue.AUDIO:ue.VIDEO,ssrcId:i};t==="video"&&this.store.firstVideoFrameDecoded(e.uid,{subscribeStart:Date.now()});const l=await this._subscribeMutex.lock();g.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const h=t==="audio"?e._audioSSRC:e._videoSSRC;h!==void 0&&h!==i&&(i=h,o=t==="audio"?e._audioOrtc:e._videoOrtc,s=t==="video"?e._rtxSsrcId:void 0,c={stream_type:t==="audio"?ue.AUDIO:ue.VIDEO,ssrcId:i}),tr.markSubscribeStart(this.store.clientId,i),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,i,s,o);try{this._p2pChannel.isPreSubScribe(i)||await this._gateway.subscribe(e.uid,c,!0)}catch(f){if((f==null?void 0:f.code)!==b.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),f;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(h){throw this._p2pChannel.reportSubscribeEvent(!1,h==null?void 0:h.code,e,t),h}g.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType!==void 0&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(h=>{g.warning("[".concat(this._clientId,"] auto set fallback failed"),h)});const u=t==="audio"?e._audioTrack:e._videoTrack;if(!u)throw new B(b.UNEXPECTED_ERROR,"can not find remote track in user object");return t==="video"&&(this.store.firstVideoFrameDecoded(e.uid,{subscribeEnd:Date.now()}),this._p2pChannel.reportVideoFirstFrameRender(e)),u}catch(u){throw g.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),u),u}finally{l()}}async massSubscribe(e){if(Bs(e,"subscribeList"),!this._joinInfo)throw new B(b.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),n=new Map,r=await this._subscribeMutex.lock();g.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map(c=>{let{user:l,mediaType:u}=c;return"user: ".concat(l==null?void 0:l.uid,", mediaType: ").concat(u)}).join("; ")));const i=(e=[...e]).map(c=>{let{user:l,mediaType:u}=c;return{user:l,mediaType:u}}),o=await this._p2pChannel.globalLock();try{var s;for(let l=e.length-1;l>=0;l--){const u=e[l],{user:h,mediaType:f}=u;if(sn(f,"mediaType",["audio","video"]),!h){const v=new B(b.INVALID_PARAMS,"user property does not exist in subscribeList item");throw g.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),v}if(!this._users.find(v=>v===h)){const v=new B(b.INVALID_REMOTE_USER,"user is not in the channel");g.error("[".concat(this._clientId,"] can not massSubscribe ").concat(h.uid,", this user is not in the channel")),i[l].error=v,e.splice(l,1);continue}if(f==="audio"&&(!h.hasAudio||h._audioSSRC===void 0)||f==="video"&&(!h.hasVideo||h._videoSSRC===void 0)){const v=new B(b.REMOTE_USER_IS_NOT_PUBLISHED);g.error("[".concat(this._clientId,"] can not subscribe ").concat(h.uid," with mediaType ").concat(f,", remote user is not published")),i[l].error=v,e.splice(l,1);continue}const E=An.Video|An.LwoVideo,I=n.get(h);if(I){if(f==="video"?I&E:I&An.Audio){e.splice(l,1),g.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(h.uid,", mediaType:").concat(f," twice"));continue}n.set(h,I|(f==="video"?E:An.Audio))}else n.set(h,f==="video"?E:An.Audio)}for(let l=e.length-1;l>=0;l--){const u=e[l],{user:h,mediaType:f}=u,_=An.Video|An.LwoVideo;if(this._p2pChannel.hasRemoteMedia(h,f)){await this._p2pChannel.unmuteRemoteNoLock(h,f);const E=n.get(h);n.set(h,f==="video"?E^_:E^An.Audio),e.splice(l,1)}}this.store.massSubscribe(e.map(l=>({userId:l.user.uid,type:l.mediaType})),t);let c=Di(s=Array.from(n.entries())).call(s,(l,u)=>{let[h,f]=u;if(f===0)return l;const _={stream_id:h.uid,stream_type:f};return f&An.Audio&&(_.audio_ssrc=h._audioSSRC),f&An.Video&&(_.video_ssrc=h._videoSSRC),l.push(_),l},[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map(u=>{let{user:h,mediaType:f}=u;return{user:h,mediaType:f,ssrcId:f===ue.VIDEO?h._videoSSRC:h._audioSSRC,rtxSsrcId:f===ue.VIDEO?h._rtxSsrcId:void 0}}));const l=new Map;if(c=c.filter(u=>u.video_ssrc&&!this._p2pChannel.isPreSubScribe(u.video_ssrc)||u.audio_ssrc&&!this._p2pChannel.isPreSubScribe(u.audio_ssrc)||!u.video_ssrc&&!u.audio_ssrc),c.length>0){const u=await this._gateway.subscribeAll(c,!0);((u==null?void 0:u.users)||[]).forEach(h=>{let{stream_id:f,video_error_code:_,audio_error_code:E,error_code:I}=h;(_||E||I)&&l.set(f,{video_error_code:_,audio_error_code:E,error_code:I})})}if(Array.from(l.entries()).length>0){const u=[];Array.from(l.entries()).forEach(h=>{let[f,_]=h;const E=this.remoteUsers.find(I=>I.uid===f);if(E){let I;_.error_code||_.video_error_code&&_.audio_error_code?I=void 0:_.video_error_code?I=ue.VIDEO:_.audio_error_code&&(I=ue.AUDIO),u.push({user:E,mediaType:I})}}),u.length>0&&await this._p2pChannel.massUnsubscribeNoLock(u)}for(const u of i){const h=l.get(u.user.uid);if(h){const f=h.error_code||u.mediaType==="audio"&&h.audio_error_code||u.mediaType==="video"&&h.video_error_code;if(f){const _=Kc(f);g.error("user:".concat(u.user.uid," mediaType:").concat(u.mediaType," has massSubscribe error ").concat(_.desc)),u.error=new B(b.SUBSCRIBE_FAILED,"code ".concat(f,": ").concat(_.desc))}}u.error||(u.mediaType==="video"?u.track=u.user.videoTrack:u.track=u.user.audioTrack)}return this.store.massSubscribe(i.filter(u=>!u.error).map(u=>({userId:u.user.uid,type:u.mediaType})),void 0,Date.now()),i.forEach(u=>{var h;pe.subscribe(this.store.sessionId,{succ:!!u.error,ec:((h=u.error)===null||h===void 0?void 0:h.code)||null,video:u.mediaType===ue.VIDEO,audio:u.mediaType===ue.AUDIO,peerid:u.user.uid,subscribeRequestid:u.mediaType===ue.VIDEO?u.user._videoSSRC:u.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t),preSsrc:this._p2pChannel.isPreSubScribe(u.user._videoSSRC)},!0)}),g.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map(u=>{let{user:h,mediaType:f}=u;return"user: ".concat(h==null?void 0:h.uid,", mediaType: ").concat(f)}).join("; "))),i}catch(l){throw await this._p2pChannel.massUnsubscribeNoLock(e),l}}finally{o(),r()}}async unsubscribe(e,t,n){if(!(e instanceof Oa)){const o=this.remoteUsers.find(s=>s.uid===e);if(!o)throw new B(b.INVALID_REMOTE_USER,"user is not in the channel");e=o}if(t||this.store.useP2P){if(t==="datachannel")return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(t&&sn(t,"mediaType",["audio","video"]),!this._joinInfo)throw new B(b.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(o=>o===e)){const o=new B(b.INVALID_REMOTE_USER,"user is not in the channel");throw g.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),o}g.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));const i=await this._subscribeMutex.lock();try{if(this.store.useP2P)await this._p2pChannel.unsubscribe(e,t);else{const o=await this._p2pChannel.unsubscribe(e,t);o&&await this._gateway.unsubscribe(o,e.uid),t&&t!=="audio"||(e._audio_pre_subscribed=!1),t&&t!=="video"||(e._video_pre_subscribed=!1),e._is_pre_created&&A_(this._users,e),g.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(o){if(o.code===b.DISCONNECT_P2P)return void g.warning("disconnecting p2p, abort unsubscribe request.");throw g.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),o.toString()),o}finally{i()}}async _unsubscribeDataChannel(e,t){if(t&&Ct(t,"id",0,65535,!0),!this._joinInfo)throw new B(b.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(i=>i===e)){const i=new B(b.INVALID_REMOTE_USER,"user is not in the channel");throw g.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}let r;if(typeof t=="number"){const i=e._dataChannels.find(o=>o.id===t);i&&(r=[i])}else r=e._dataChannels;if(r===void 0){const i=new B(b.REMOTE_USER_IS_NOT_PUBLISHED);throw g.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),i}g.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(r.map(i=>i.id)));try{const i=await this._p2pChannel.unsubscribeDataChannel(e,r);i&&await this._gateway.unsubscribeDataChannel(i,e.uid),g.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i))}catch(i){if(i.code===b.DISCONNECT_P2P)return void g.warning("disconnecting p2p, abort unsubscribe request.");throw g.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}}async massUnsubscribe(e){if(Bs(e,"unsubscribeList"),!this._joinInfo)throw new B(b.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");g.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map(n=>{let{user:r,mediaType:i}=n;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(i,";")}).join())),e=[...e];const t=new Map;for(let n=e.length-1;n>=0;n--){const{user:r,mediaType:i}=e[n];if(!r){const c=new B(b.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw g.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),c}if(sn(i,"mediaType",["video","audio",void 0]),!this._users.find(c=>c===r)){g.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(r.uid,", user is not in the channel")),e.splice(n,1);continue}const s=An.Video|An.LwoVideo;if(t.has(r)){const c=t.get(r);let l;switch(i){case"video":l=c&s;break;case"audio":l=c&An.Audio;break;default:l=c&(An.Audio|s)}if(l){g.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(r.uid,",mediaType:").concat(i," twice.")),e.splice(n,1);continue}i?i==="audio"?t.set(r,c|An.Audio):i==="video"&&t.set(r,c|s):t.set(r,c|An.Audio|s)}else i?i==="audio"?t.set(r,An.Audio):i==="video"&&t.set(r,s):t.set(r,An.Audio|s)}try{const n=await this._p2pChannel.massUnsubscribe(e);n&&await this._gateway.massUnsubscribe(n),g.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map(r=>{let{user:i,mediaType:o}=r;return"user: ".concat(i==null?void 0:i.uid,", mediaType: ").concat(o,";")}).join()))}catch(n){if(n.code===b.DISCONNECT_P2P)return void g.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw g.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(e){(function(n){if(!n)throw new W(b.INVALID_PARAMS);zt(n.width)||Cv(n.width,"streamParameter.width"),zt(n.height)||Cv(n.height,"streamParameter.height"),zt(n.framerate)||Cv(n.framerate,"streamParameter.framerate"),zt(n.bitrate)||Ct(n.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&g.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),g.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,$.LocalVideoLowTrack)}async setDualStreamMode(e,t){sn(e,"mode",[0,1,-1]);try{switch(t&&await this.setLowStreamParameter(t),this._dualStreamMode=e,this._joinInfo?this._gateway.setDualStreamMode(e).catch(n=>{g.warning("[".concat(this._clientId,"] set dual stream mode failed"),n.toString())}):g.debug("[".concat(this._clientId,"] haven't joined yet, cache dual stream mode ").concat(e)),e){case ol.AUTO_SIMULCAST_STREAM:g.info("[".concat(this._clientId,"] set dual stream mode to ").concat(e));break;case ol.DISABLE_SIMULCAST_STREM:return this.disableDualStream();case ol.ENABLE_SIMULCAST_STREAM:return this.enableDualStream()}}catch(n){throw g.error("[".concat(this._clientId,"] set dual stream mode error"),n.toString()),n}}async enableDualStream(){if(!Xe().supportDualStream)throw pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new B(b.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new B(b.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,this._dualStreamMode=ol.ENABLE_SIMULCAST_STREAM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(e=>{g.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())}),pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),g.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)return this._isDualStreamEnabled=!1,void g.info("[".concat(this._clientId,"] disable dual stream before join"));if(this._p2pChannel.getLocalMedia($.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,this._dualStreamMode=ol.DISABLE_SIMULCAST_STREM,this._joinInfo&&this._gateway.setDualStreamMode(this._dualStreamMode,!0,!0).catch(e=>{g.debug("[".concat(this._clientId,"] try to inform gateway to set dual stream mode to ").concat(this._dualStreamMode," ,but failed"),e.toString())}),pe.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),g.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(function(r){sn(r,"role",["audience","host"])}(e),t&&bv(t),this.mode==="rtc"||this.mode==="p2p")throw g.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new B(b.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&e==="host")throw new B(b.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new B(b.INVALID_OPERATION,"can not set client role to audience when publishing stream");const n=this._config.role;if(this._joinInfo&&(this._joinInfo.role=e),e!==n&&w("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(e,t),this._config.role=e,this._gateway.reconnect("recover",zn.REGIONAL_DISTRIBUTION)):(await this._gateway.setClientRole(e,t),this._config.role=e),g.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level)),n==="audience"&&e!=="audience"&&this._pendingRtpCapabilityChange&&this._p2pChannel instanceof Xc){const{video_codec:r}=this._pendingRtpCapabilityChange;this._p2pChannel.updateRemoteRTPCapabilities(r.map(i=>i.toLowerCase()).filter(i=>{var o;return Z(o=Object.keys(Mc)).call(o,i)}))}}async _setClientRoleOptions(e){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let t=!1;try{e&&bv(e),await this._gateway.setClientRole(this._config.role,e),t=!0}catch{}finally{g.info("[".concat(this._clientId,"] set client role options ").concat(t?"succeed":"failed",", options is ").concat(e))}}getRemoteInboundOffset(){var e;const t=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const n=t.timestamp-Date.now();return Math.abs(n)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(jn(e,"proxyServer"),!t){if(this.connectionState!=="DISCONNECTED")throw new B(b.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new B(b.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,pe.setProxyServer(this._proxyServer),g.setProxyServer(this._proxyServer),g.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if(this.connectionState!=="DISCONNECTED")throw new B(b.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new B(b.INVALID_OPERATION,"You have already set the proxy")}if(bc(e))return this._turnServer={servers:e,mode:"original-manual"},void g.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map(n=>n.urls).join(","),"."));e.forEach(n=>vP(n)),this._turnServer={servers:e,mode:"manual"},g.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new B(b.INVALID_OPERATION,"you should set license before join channel");if(jn(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new B(b.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,g.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new B(b.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new B(b.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let n;switch(e===void 0&&(e=3),e){case 1:case 2:throw new B(b.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new B(b.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,g.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new B(b.INVALID_OPERATION,"Stop proxy server after leave channel");pe.setProxyServer(),g.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",g.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new B(b.INVALID_PARAMS,"accessPoints is required.");Bs(e.accessPoints.serverList,"accessPoints.serverList"),jn(e.accessPoints.domain,"accessPoints.domain");const t=(_,E)=>{Ct(_,E,0,65535,!0)};let n=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new B(b.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");w("CLOSE_AFB_FOR_LOCAL_AP")&&(vt("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),vt("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const r=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,i=e.accessPoints.domain,o=e.accessPoints.serverList.map(_=>r.test(_)?"".concat(_.replace(/\./g,"-"),".").concat(i):_),s=o.map(_=>"".concat(_,":").concat(n));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,vt("WEBCS_DOMAIN",s),vt("WEBCS_DOMAIN_BACKUP_LIST",s),vt("GATEWAY_DOMAINS",[i]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(Bs(e.report.hostname,"report.hostname"),vt("EVENT_REPORT_DOMAIN",e.report.hostname[0]),vt("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(vt("EVENT_REPORT_DOMAIN",o[0]),vt("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let c=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),c=e.report.port),vt("STATS_COLLECTOR_PORT",c),e.report?vt("ENABLE_EVENT_REPORT",!0):vt("ENABLE_EVENT_REPORT",!1);let l="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(Bs(e.log.hostname,"log.hostname"),l=e.log.hostname[0]):l=o[0];let u=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),u=e.log.port),vt("LOG_UPLOAD_SERVER","".concat(l,":").concat(u));let h=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(Bs(e.cds.hostname,"cds.hostname"),h=e.cds.hostname):h=o;let f=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),f=e.cds.port),vt("CDS_AP",h.map(_=>"".concat(_,":").concat(f))),e.cds?vt("ENABLE_CONFIG_DISTRIBUTE",!0):vt("ENABLE_CONFIG_DISTRIBUTE",!1),g.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(Bs(e,"serverList"),jn(t,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new B(b.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map(r=>n.test(r)?"".concat(r.replace(/\./g,"-"),".").concat(t):r),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,vt("WEBCS_DOMAIN",e),vt("WEBCS_DOMAIN_BACKUP_LIST",e),vt("GATEWAY_DOMAINS",[t]),vt("EVENT_REPORT_DOMAIN",e[0]),vt("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),vt("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),g.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(sn(e,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw g.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else g.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){sn(t,"streamType",[0,1,4,5,6,7,8,9]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout(()=>{const n=this._users.find(r=>r.uid===e);n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(n){throw g.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}g.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){sn(t,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(n){throw g.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}g.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,n,r){(function(o){sn(o,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),jn(t,"secret");const i=["aes-128-gcm2","aes-256-gcm2"];if(Z(i).call(i,e)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new B(b.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new B(b.INVALID_PARAMS,"current encrypt mode does not need salt");if(r){if(io(r,"encryptDataStream"),!Z(i).call(i,e))throw new B(b.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(t)||g.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=t,n&&(this._encryptionSalt=Ra(n))}async renewToken(e){if(jn(e,"token",1,2047),!this._key||!this._joinInfo)throw new B(b.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(w("USE_NEW_TOKEN")){g.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const r=await DX(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||an);g.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:r})}else g.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});g.debug("[".concat(this._clientId,"] renewToken success"))}catch(r){throw this._key=t,this._joinInfo.token=t,g.error("[".concat(this._clientId,"] renewToken failed"),r.toString()),r}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?g.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(Ke.VOLUME_INDICATOR,e)},w("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if(this.codec!=="h264")throw new B(b.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new B(b.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new B(b.LIVE_STREAMING_TASK_CONFLICT);const n=t?Gs.TRANSCODE:Gs.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(e,n)}setLiveTranscoding(e){return this._createLiveStreamingClient(Gs.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(n=>n&&n.hasUrl(e));if(!t.length)throw new B(b.INVALID_PARAMS,"can not find live streaming url to stop");await se.all(t.map(n=>n&&n.stopLiveStreamingTask(e)))}async startChannelMediaRelay(e){uM(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){uM(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}sendAudioMetadata(e){this._p2pChannel instanceof Xc&&this._p2pChannel.addAudioMetadata(e)}async sendStreamMessage(e){var t;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new B(b.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){const i=new TextEncoder;e.payload=i.encode(e.payload)}let r=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Z(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)&&(r=!0,e.payload=await async function(i,o,s){var c;const l=Di(c=Array.from(s)).call(c,(v,R)=>v+R,0),u={serverTs:0,seq:eq++,length:s.length,checkSum:l},h=new Uint8Array(NP(l,2)),f=new ArrayBuffer(ul),_=new DataView(f);_.setUint32(0,u.serverTs),_.setUint16(4,u.seq),_.setUint16(6,u.length),_.setUint16(8,u.checkSum);const E=16-s.length%16;s=IP(s,new Uint8Array(E));const I=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:i,tagLength:GP,additionalData:h},o,s);return IP(new Uint8Array(f),new Uint8Array(I))}(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new B(b.INVALID_PARAMS,r?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(ge.DATA_STREAM,{payload:Ra(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-BX},!n)}sendMetadata(e){if(!this._joinInfo)throw new B(b.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new B(b.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(ge.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Ra(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(dq),!this._joinInfo)throw new B(b.INVALID_OPERATION,"can not send custom report, not joined");await pe.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){const e=this._statsCollector.getRemoteNetworkQualityStats();if(w("DELETE_NEQ_AFTER_USER_LEAVE")){const t=this._users.map(n=>n.uid+"");Object.keys(e).forEach(n=>{Z(t).call(t,n)||delete e[n]})}return e}getNetworkQuality(){return this._statsCollector.getNetworkQuality()}async pickSVCLayer(e,t){sn(t.spatialLayer,"spatialLayer",[0,1,2,3]),sn(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(n){throw g.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(e){const{apRTM:t=!1,rtmFlag:n}=e;if(io(t,"apRTM"),Ct(n,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=n,g.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(g.debug("[".concat(this._clientId,"] reset client")),function(e){const t=Rl.indexOf(e);t!==-1&&Rl.splice(t,1)}(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this.store.autoSubscribe=!1,this._pendingRtpCapabilityChange=void 0,this._axiosCancelSource.cancel(),this._axiosCancelSource=br.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&VM(this._joinInfo),this._rteDetailInterval&&(window.clearInterval(this._rteDetailInterval),this._rteDetailInterval=void 0,this._sessionId&&pe.reportRteDetail(this._sessionId)),this._fallbackServerInfo=void 0,this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&pe.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this.store.resetFirstVideoFrameDecoded(),this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach(t=>t._close()),e._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Ln("client-publish",this._clientId),this._subscribeMutex=new Ln("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,t){var n;const r=e||Lc();e?g.debug("[".concat(this._clientId,"] new Session ").concat(r)):g.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(r));const i=e?"":this._sessionId||"";this._sessionId=r,this.store.sessionId=r,pe.addSid(r);const o={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:(t==null?void 0:t.stringUid)||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:i,clientRole:this.role==="audience"?2:1,rteUrl:this.store.rteUrl,rteSid:this.store.rteSid};pe.sessionInit(this._sessionId,_o({cname:t.channel,appid:t.appId},o)),this._joinInfo&&(this._joinInfo.sid=r),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=r)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new B(b.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&w("FORCE_TURN")&&!w("TURN_ENABLE_TCP")&&!w("TURN_ENABLE_UDP"))throw new B(b.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");g.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){const r=(await n.next()).value;if(r){try{await this._gateway.sendExtensionMessage(rn.PUBLISH,r,!0)}catch(i){throw n.throw(i),i}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const r=(await n.next()).value;if(r){var t;let i;try{i=await this._gateway.publish(this._uid,r,!0)}catch(o){if(o.code!==b.DISCONNECT_P2P)throw n.throw(o),o}await n.next(((t=i)===null||t===void 0?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const i of e)i instanceof wt&&i._encoderConfig&&this._gateway.setVideoProfile(i._encoderConfig).catch(o=>{g.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))}),!i.muted&&i.enabled||await this._p2pChannel.muteLocalTrack(i)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,e),(n==null?void 0:n.code)===b.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new B(b.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new B(b.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));g.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),r=(await n.next()).value;if(r){var t;let i;try{i=await this._gateway.publish(this._uid,r,!0)}catch(o){if(o.code!==b.DISCONNECT_P2P)throw n.throw(o),o}n.next(((t=i)===null||t===void 0?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,void 0,!0),(n==null?void 0:n.code)===b.WS_ABORT)return;throw n}}_createLiveStreamingClient(e){const t=()=>{if(!this._joinInfo||!this._appId)return new B(b.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const n=(r={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},Bo("LiveStreaming").create(r));var r;return n.onLiveStreamError=(i,o)=>{pe.reportApiInvoke(this._sessionId,{name:Ft.ON_LIVE_STREAM_ERROR,options:[i,o],tag:It.TRACER}).onSuccess(),this.safeEmit(Ke.LIVE_STREAMING_ERROR,i,o)},n.onLiveStreamWarning=(i,o)=>{pe.reportApiInvoke(this._sessionId,{name:Ft.ON_LIVE_STREAM_WARNING,options:[i,o],tag:It.TRACER}).onSuccess(),this.safeEmit(Ke.LIVE_STREAMING_WARNING,i,o)},n.on(IR.REQUEST_WORKER_MANAGER_LIST,(i,o,s)=>{if(!this._joinInfo)return s(new B(b.INVALID_OPERATION,"can not find join info to get worker manager"));(async function(c,l,u,h){const f=w("UAP_AP").slice(0,w("AJAX_REQUEST_CONCURRENT")).map(_=>l.proxyServer?"https://".concat(l.proxyServer,"/ap/?url=").concat(_+"/api/v1?action=uap"):"https://".concat(_,"/api/v1?action=uap"));return await CX(f,c,l,u,h)})(i,this._joinInfo,this._axiosCancelSource.token,an).then(o).catch(s)}),n};return e===Gs.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||t(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||t(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new B(b.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:t,sendResolutionHeight:n}=this.getLocalVideoStats(),r=(e={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:t,height:n}},Bo("ChannelMediaRelay").create(e));r.on("state",i=>{i===Gr.RELAY_STATE_FAILURE&&r&&r.dispose(),this.safeEmit(Ke.CHANNEL_MEDIA_RELAY_STATE,i)}),r.on("event",i=>{this.safeEmit(Ke.CHANNEL_MEDIA_RELAY_EVENT,i)}),this._channelMediaRelayClient=r,this._statsCollector.onStatsChanged=(i,o)=>{var s;i==="resolution"&&((s=this._channelMediaRelayClient)===null||s===void 0||s.setVideoProfile(o))}}var e;return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){const{added:n,deleted:r}=e,i=[];if(t){const o=[];this._users.forEach(s=>{s._dataChannels.forEach(c=>{n.every(l=>l.uid!==s._uintid||l.stream_id!==c.id)&&o.push({uid:s._uintid,stream_id:c.id,ordered:c.ordered,max_retrans_times:c.maxRetransmits,metadata:c.metadata})})}),o.length>0&&this._handleUpdateDataChannel({added:[],deleted:o})}Array.isArray(n)&&n.length>0&&n.forEach(o=>{const{uid:s,stream_id:c,ordered:l,max_retrans_times:u,metadata:h}=o,f=this._users.find(_=>_._uintid===s);if(!f)return void g.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(g.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(s)),Z(i).call(i,f)||i.push(f),f._uintid||(f._uintid=s),f._dataChannels.findIndex(_=>_.id===o.stream_id)===-1){const _={id:c,ordered:!!l,maxRetransmits:u,metadata:h},E=function(I){return X1(I,!0)}(_);f._dataChannels.push(E),g.info("[".concat(this._clientId,"] remote user ").concat(f.uid," published datachannel")),t||this.safeEmit(Ke.USER_PUBLISHED,f,"datachannel",_)}this._p2pChannel.hasPendingRemoteDataChannel(f,o.stream_id)&&(g.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(f.uid," after reconnect.")),this._subscribeDataChannel(f,o.stream_id).catch(_=>{g.error("[".concat(this._clientId,"] resubscribe datachannel error"),_.toString())}))}),t&&(this.safeEmit(Ke.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(r)&&r.length>0&&r.forEach(o=>{const{uid:s,stream_id:c}=o,l=this._users.find(h=>h._uintid===s);if(!l)return void g.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const u=l._dataChannels.find(h=>h.id===o.stream_id);u&&(g.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(s)),this._p2pChannel.unsubscribeDataChannel(l,[u]).then(h=>{if(l._dataChannels=l._dataChannels.filter(f=>f!==u),h)return this._gateway.unsubscribeDataChannel(h,l.uid)}),g.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished datachannel ,id:").concat(u.id)),this.safeEmit(Ke.USER_UNPUBLISHED,l,"datachannel",u._config))})}_getEncodingName(e){var t,n;if(!this._joinResponse)return;const r=(t=this._joinResponse.ortc.rtpCapabilities.sendrecv)===null||t===void 0?void 0:t.videoCodecs;if(!r)return;for(const c of r){var i;if(c.payloadType===e)return c==null||(i=c.rtpMap)===null||i===void 0?void 0:i.encodingName}const o=(n=this._joinResponse.ortc.rtpCapabilities.recv)===null||n===void 0?void 0:n.videoCodecs;if(o)for(const c of o){var s;if(c.payloadType===e)return c==null||(s=c.rtpMap)===null||s===void 0?void 0:s.encodingName}return e===0?"unknown":void 0}_handleRemoveDataChannels(e){const t=this._users.find(n=>n.uid===e.uid);if(t){if(t._dataChannels!==void 0&&t._dataChannels.length>0){g.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{g.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach(r=>{this.safeEmit(Ke.USER_UNPUBLISHED,t,"datachannel",r._config)})};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then(r=>{if(r)return this._gateway.unsubscribeDataChannel(r,t.uid)}),n()}}else g.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(nn.UPDATE_GATEWAY_CONFIG,()=>{(function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void g.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),n=Date.now();Object.keys(t).forEach(r=>{const{value:i,type:o,expires:s}=t[r];s&&s<=n||o||gR()||!Object.prototype.hasOwnProperty.call(k_,r)||(fi[r]=i,mt[r]=i,g.debug("Update gateway parameters from config distribute",r,i))})}catch(t){g.error("Error update config from local cache",t.message)}})()}),this._gateway.on(nn.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(nn.CONNECTION_STATE_CHANGE,(e,t,n)=>{var r;if(n===Ze.FALLBACK)return;const i=()=>{this.safeEmit(Ke.CONNECTION_STATE_CHANGE,e,t,n)};if(pe.reportApiInvoke(this._sessionId||((r=this._gateway.joinInfo)===null||r===void 0?void 0:r.sid)||null,{name:Ft.CONNECTION_STATE_CHANGE,options:[e,t,n],tag:It.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:n})),g.info("[".concat(this._clientId,"] signal connection state change: ").concat(t," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void i();if(e==="RECONNECTING")this._users.forEach(s=>{s._trust_in_room_=!1,s._trust_audio_enabled_state_=!1,s._trust_video_enabled_state_=!1,s._trust_audio_mute_state_=!1,s._trust_video_mute_state_=!1,s._trust_audio_stream_added_state_=!1,s._trust_video_stream_added_state_=!1,s._is_pre_created||(s._audio_pre_subscribed||(s._audioSSRC=void 0,s._audioOrtc=void 0),s._video_pre_subscribed||(s._videoSSRC=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),s._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((s,c)=>{this._gateway.setStreamFallbackOption(c,s).catch(l=>{g.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),l)})}),this._remoteStreamTypeCacheMap.forEach((s,c)=>{this._gateway.setRemoteVideoStreamType(c,s).catch(l=>{g.warning("[".concat(this._clientId,"] auto set remote stream type failed"),l)})}),w("VOS_CONFIGURE")&&Array.isArray(w("VOS_CONFIGURE"))&&w("VOS_CONFIGURE").length>0&&(this._gateway.setConfigure(w("VOS_CONFIGURE")).catch(s=>{g.debug("[".concat(this._clientId,"] auto set vos config failed"),s)}),g.debug("[".concat(this._clientId,"] ws connected auto set vos config"))),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{g.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(s=>{g.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(s))}),this._dualStreamMode&&this._gateway.setDualStreamMode(this._dualStreamMode).catch(s=>{g.warning("[".concat(this._clientId,"] auto set dual stream mode failed"),s)}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(s=>!s._trust_in_room_).forEach(s=>{g.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(s.uid)),this._handleUserOffline({uid:s.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(s=>{s._trust_audio_mute_state_||(g.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,ue.AUDIO,!1)),s._trust_video_mute_state_||(g.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,ue.VIDEO,!1)),s._trust_audio_enabled_state_||(g.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(s.uid)),this._handleSetStreamLocalEnable("audio",s.uid,!0)),s._trust_video_enabled_state_||(g.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(s.uid)),this._handleSetStreamLocalEnable("video",s.uid,!0)),s._trust_video_stream_added_state_||(g.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(s.uid)),this._handleResetAddStream(s,"video")),s._trust_audio_stream_added_state_||(g.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(s.uid)),this._handleResetAddStream(s,"audio")),s._video_added_||s._audio_added_||(g.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(s.uid)),this._handleRemoveStream({uid:s.uid,uint_id:s._uintid}))}))},1e3))}i()}),this._gateway.on(nn.REQUEST_NEW_GATEWAY_LIST,async(e,t)=>{if(!this._joinInfo)return t(new B(b.UNEXPECTED_ERROR,"can not recover, no join info"));try{let n;if(this._fallbackServerInfo)n=this._fallbackServerInfo,this._fallbackServerInfo=void 0,this._joinInfo.preload=!1,pe.reportApiInvoke(this._sessionId,{name:Ft.VOS_FALLBACK_CN,options:{cur:n.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!0},tag:It.TRACER}).onSuccess(),g.info("[".concat(this._clientId,"] use fallback cn server info"));else{const i=await ly(_o(_o({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));i?(n=i.ap,FM(i),this._joinInfo.preload=!0):(n=await Em(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||an,this.store),this._joinInfo.preload=!1)}this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);const r=[];n.gatewayInfo.gatewayAddrs.forEach(i=>{let{address:o}=i;const[s,c]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?r.push({proxy:this._joinInfo.proxyServer,host:s,port:c}):r.push({host:s,port:c})}),e(r)}catch(n){t(n)}}),this._gateway.on(nn.NETWORK_QUALITY,e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(Ke.NETWORK_QUALITY,e)}),this._gateway.on(nn.STREAM_TYPE_CHANGE,(e,t)=>{this.safeEmit(Ke.STREAM_TYPE_CHANGED,e,t),pe.reportApiInvoke(this._sessionId,{name:Ft.STREAM_TYPE_CHANGE,options:[e,t],tag:It.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))}),this._gateway.isPreSub=()=>"isPreSub"in this._p2pChannel&&this._p2pChannel.isPreSub(),this._gateway.isPreallocation=()=>"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation(),this._gateway.on(nn.IS_P2P_DISCONNECTED,e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)}),this._gateway.on(nn.REQUEST_P2P_CONNECTION_PARAMS,async(e,t,n)=>{try{let r=await this._p2pChannel.getEstablishParams();r&&"isPreallocation"in this._p2pChannel&&this._p2pChannel.isPreallocation()||(r=await this._p2pChannel.startP2PConnection(e)),t(r)}catch(r){n(r)}}),this._gateway.on(nn.JOIN_RESPONSE,(e,t)=>{if(this.store.useP2P)return;let n;this._joinResponse=e,e.attributes?n=e.attributes.userAttributes.preSubSsrcs:g.debug("no attributes in joinResponse");const r=F1(e.ortc,t,n);this._p2pChannel.connect(r)}),this._gateway.on(nn.PRE_CONNECT_PC,async(e,t,n)=>{const{candidates:r,fingerprint:i,turnServer:o}=e;if(this._joinInfo&&r.length>0&&!this._p2pChannel.isPlanB){const{cert:c,cid:l}=this._joinInfo.apResponse,u="".concat(l,"_").concat(c);if(u.length<4||u.length>256)return void g.debug("[".concat(this._clientId,"] ufrag length is not valid, length: ").concat(u.length));await this._p2pChannel.startP2PConnection({turnServer:o,cloudProxyServer:this._joinInfo.cloudProxyServer,isPreallocation:!0});try{var s;t(await this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(l,"_").concat(c),icePwd:"".concat(l,"_").concat(c)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(s=w("FINGERPRINT"))!==null&&s!==void 0?s:i}]},candidates:r,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0}))}catch(h){h.code&&h.code===b.EXCHANGE_SDP_FAILED&&await this._p2pChannel.startP2PConnection({turnServer:o,cloudProxyServer:this._joinInfo.cloudProxyServer},!0),n(h)}}}),this._gateway.on(nn.VOS_FALLBACK,e=>{e==="fallback_hls"&&this.safeEmit(Ke.FALLBACK_TO_HLS,Ov.VOSERROR)}),this._gateway.on(nn.RESET_SIGNAL,()=>{this._p2pChannel instanceof Xc&&this._p2pChannel.fallbackConnection(),this._handleGatewaySignalEvents()}),this._gateway.on(nn.DATACHANNEL_FAILBACK,()=>{pe.reportApiInvoke(this._sessionId,{name:Ft.DATACHANNEL_FAILBACK,options:{},tag:It.TRACER}).onSuccess(),this._joinGateway()})}_handleGatewaySignalEvents(){this._gateway.signal.on(Pe.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Pe.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Pe.ON_ADD_AUDIO_STREAM,e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc)),this._gateway.signal.on(Pe.ON_ADD_VIDEO_STREAM,e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.pt,e.uint_id,e.ortc,e.rtxSsrcId)),this._gateway.signal.on(Pe.ON_REMOTE_DATASTREAM_UPDATE,e=>{this._handleUpdateDataChannel(e)}),this._gateway.signal.on(Pe.ON_REMOTE_FULL_DATASTREAM_INFO,e=>{this._handleUpdateDataChannel({added:e.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(Pe.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Pe.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Pe.MUTE_AUDIO,e=>this._handleMuteStream(e.uid,ue.AUDIO,!0)),this._gateway.signal.on(Pe.UNMUTE_AUDIO,e=>this._handleMuteStream(e.uid,ue.AUDIO,!1)),this._gateway.signal.on(Pe.MUTE_VIDEO,e=>this._handleMuteStream(e.uid,ue.VIDEO,!0)),this._gateway.signal.on(Pe.UNMUTE_VIDEO,e=>this._handleMuteStream(e.uid,ue.VIDEO,!1)),this._gateway.signal.on(Pe.RECEIVE_METADATA,e=>{const t=Pc(e.metadata);this.safeEmit(Ke.RECEIVE_METADATA,e.uid,t)}),this._gateway.signal.on(Pe.ON_DATA_STREAM,async e=>{var t;if(!e)return;let n=Pc(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&Z(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)){if(e.payload.length<ul)throw new B(b.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(ul));n=await async function(o,s,c){const l=c.subarray(0,ul),u=l.slice(8,ul),h=(u[0]<<8)+u[1],f=(l[6]<<8)+l[7],_=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:o,tagLength:GP,additionalData:new Uint8Array(NP(h,2))},s,c.subarray(ul));return new Uint8Array(_).subarray(0,f)}(this._encryptDataStreamIv,this._encryptDataStreamKey,n)}let r=0;if(e.ordered||e.syncWithAudio){const i=this._p2pChannel.getStats(),o=this.remoteUsers.find(c=>c.uid===e.uid),s=i==null?void 0:i.audioRecv.find(c=>c.ssrc===(o==null?void 0:o._audioSSRC));r=s==null?void 0:s.jitterBufferMs}(r==null||Number.isNaN(r))&&(r=0),GX(_o(_o({},e),{},{payload:n}),r,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Pe.ON_CRYPT_ERROR,()=>{va(()=>{g.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(Ke.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Pe.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Pe.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{g.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Ze.TOKEN_EXPIRE),this.safeEmit(Ke.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Pe.ON_STREAM_FALLBACK_UPDATE,e=>{g.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(Ke.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Pe.ENABLE_MULTI_STREAM,e=>{this._dualStreamMode===ol.AUTO_SIMULCAST_STREAM&&this.enableDualStream().catch(t=>{g.debug("[".concat(this._clientId,"] set dual stream mode error"),t.toString())})}),this._gateway.signal.on(Pe.ON_PUBLISH_STREAM,e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),g.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))}),this._gateway.signal.on(Pe.ENABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)}),this._gateway.signal.on(Pe.DISABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)}),this._gateway.signal.on(Ee.REQUEST_TIMEOUT,(e,t)=>{if(this._joinInfo)switch(e){case ge.PUBLISH:{if(!t)return;const i=t.ortc;if(i){var n,r;const o=i.some(l=>{let{stream_type:u}=l;return u===Et.Audio}),s=i.some(l=>{let{stream_type:u}=l;return u!==Et.Audio}),c=i.some(l=>{let{stream_type:u}=l;return u===Et.Screen||u===Et.ScreenLow});t.state==="offer"&&pe.publish(this._joinInfo.sid,{eventElapse:tr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:b.TIMEOUT,audio:o,video:s,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:c,audioName:o?(n=i.find(l=>{let{stream_type:u}=l;return u===Et.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:s?(r=i.find(l=>{let{stream_type:u}=l;return u!==Et.Audio}))===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId.toString():void 0})}break}case ge.SUBSCRIBE:t&&pe.subscribe(this._joinInfo.sid,{succ:!1,ec:b.TIMEOUT,audio:t.stream_type===ue.AUDIO,video:t.stream_type===ue.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:tr.measureFromSubscribeStart(this.store.clientId,t.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(t.ssrcId)})}}),this._gateway.signal.on(Pe.ON_P2P_OK,e=>{this.uid,this._uid}),this._gateway.signal.on(Pe.ON_PUBLISHED_USER_LIST,e=>{if(e==null||!e.users)return;w("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter(r=>!Wc(r.string_id||r.stream_id,this.channelName)));const t=[],n=[];for(const r of e.users){let i=this._users.find(h=>h._uintid===r.stream_id);i?i._trust_in_room_=!0:(i=new Oa(r.string_id||r.stream_id,r.stream_id),this._users.push(i),this.store.firstVideoFrameDecoded(i.uid,{userJoinNotify:Date.now()}),this.getListeners(Ke.PUBLISHED_USER_LIST).length===0&&(g.debug("[".concat(this._clientId,"] user online"),r.stream_id),this.safeEmit(Ke.USER_JOINED,i)));const o=An.Audio&r.stream_type,s=(An.Video|An.LwoVideo)&r.stream_type,c=(65280&r.stream_type)!=0,l=o&&i.hasAudio,u=s&&i.hasVideo;s&&(i._trust_video_stream_added_state_=!0,i._video_added_=!0,i._videoSSRC=r.video_ssrc,i._rtxSsrcId=r.video_rtx),o&&(i._trust_audio_stream_added_state_=!0,i._audio_added_=!0,i._audioSSRC=r.audio_ssrc),o&&!l&&this.getListeners(Ke.PUBLISHED_USER_LIST).length===0&&(g.info("[".concat(this._clientId,"] remote user ").concat(i.uid," published audio")),this.safeEmit(Ke.USER_PUBLISHED,i,"audio")),s&&!u&&this.getListeners(Ke.PUBLISHED_USER_LIST).length===0&&(g.info("[".concat(this._clientId,"] remote user ").concat(i.uid," published video")),this.safeEmit(Ke.USER_PUBLISHED,i,"video")),(o&&!l||s&&!u||c)&&t.push(i),s&&this._p2pChannel.hasPendingRemoteMedia(i,"video")&&n.push({user:i,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(i,"audio")&&n.push({user:i,mediaType:"audio"})}n.length>0&&(g.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map(r=>"user: ".concat(r.user.uid,", mediaType: ").concat(r.mediaType)).join("; ")," ")),this.massSubscribe(n).catch(r=>{g.error("[".concat(this._clientId,"] mass resubscribe error"),r.toString())})),this.getListeners(Ke.PUBLISHED_USER_LIST).length>0?w("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(g.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map(r=>r.uid).join(", "))),this.safeEmit(Ke.PUBLISHED_USER_LIST,t)):g.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map(r=>r.uid).join(", ")))}),this._gateway.signal.on(Pe.ON_RTP_CAPABILITY_CHANGE,e=>{const{video_codec:t}=e;if(this._p2pChannel instanceof Xc){if(this.role==="audience"&&w("UPDATE_RTP_CAP_IN_HOST"))return this._pendingRtpCapabilityChange=e,void g.debug("[".concat(this._clientId,"] no need to change rtp capability because of audience, params: ").concat(JSON.stringify(e)));this._p2pChannel.updateRemoteRTPCapabilities(t.map(n=>n.toLowerCase()).filter(n=>{var r;return Z(r=Object.keys(Mc)).call(r,n)}))}}),this._gateway.signal.on(Ee.VOS_FALLBACK_PROMISE,async(e,t,n)=>{if(e==="FALLBACKCN"&&w("ENABLE_QUALITY_FALLBACK")){if(!this._joinInfo)return n(new B(b.UNEXPECTED_ERROR,"can not recover, no join info"));g.info("[".concat(this._clientId,"] try fallback to cn, start request new server info"));const i=this._joinInfo.apRequestDetail;try{this._joinInfo.apRequestDetail=e;const o=await Em(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||an,this.store);if(w("QUALITY_FALLBACK_REHEARSAL"))return pe.reportApiInvoke(this._sessionId,{name:Ft.VOS_FALLBACK_CN,options:{cur:o.gatewayInfo.gatewayAddrs,prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:It.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=i,void n();this._fallbackServerInfo=o,t()}catch(o){var r;const s=o==null||(r=o.data)===null||r===void 0?void 0:r.desc;w("QUALITY_FALLBACK_REHEARSAL")?(pe.reportApiInvoke(this._sessionId,{name:Ft.VOS_FALLBACK_CN,options:{cur:"failed, errorReason: "+s||"unknown",prev:this._joinInfo.gatewayAddrs,is_done:!1},tag:It.TRACER}).onSuccess(),this._joinInfo.apRequestDetail=i):Array.isArray(s)&&Z(s).call(s,"request downgrade fallback")&&this.safeEmit(Ke.FALLBACK_TO_HLS,Ov.AP_ERROR),n(o)}}else n()})}_handleP2PEvents(){this._gateway.signal.on(Pe.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(rn.PUBLISH,(e,t,n)=>{const{uid:r}=e;e.forEach(i=>{const{kind:o,ssrcs:s,mid:c,isMuted:l}=i;this._handleP2PAddAudioOrVideoStream(o,r,s[0].ssrcId,c);const u=this._users.find(h=>h.uid===r);return u&&this.store.useP2P?this._p2pChannel.mockSubscribe(u,o,s[0].ssrcId,c).then(()=>{t()}).catch(n):t(),this._handleMuteStream(r,o,!!l)})}),this._gateway.signal.on(rn.CALL,async(e,t,n)=>{if(this.store.useP2P)try{var r;t(await this._p2pChannel.startP2P({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},e))}catch(i){n(i)}}),this._gateway.signal.on(Ee.P2P_CONNECTION,async e=>{this.store.useP2P&&(await this._p2pChannel).p2pConnect(e)}),this._gateway.signal.on(rn.UNPUBLISH,async(e,t,n)=>{if(this.store.useP2P){const{unpubMsg:r,uid:i}=e,o=this._users.find(s=>s.uid===i);if(!o)return g.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(i)),void t();try{r.forEach(async s=>{let{stream_type:c}=s;const l=c===Et.Audio?ue.AUDIO:ue.VIDEO;await this._p2pChannel.unsubscribe(o,l),this._handleMuteStream(i,l,!0)}),t()}catch(s){n(s)}}}),this._gateway.signal.on(rn.CONTROL,async(e,t)=>{const{action:n}=e;switch(n){case wa.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,ue.VIDEO,!0);break;case wa.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,ue.AUDIO,!0);break;case wa.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,ue.VIDEO,!1);break;case wa.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,ue.AUDIO,!1)}}),this._gateway.signal.on(rn.RESTART_ICE,async(e,t,n)=>{if(this.store.useP2P)try{const{direction:r,iceParameter:i}=e;r!==vr.SEND_ONLY||i?t(await this._p2pChannel.restartICE(r,i)):(this._p2pChannel.handleDisconnect(r),t())}catch(r){n(r)}}),this._gateway.signal.on(rn.CANDIDATE,e=>{if(this.store.useP2P){const{candidate:t,direction:n}=e;this._p2pChannel.addRemoteCandidate(t,n)}}),this._p2pChannel.on(Se.RequestP2PRestartICE,async(e,t,n)=>{try{const{direction:r}=e;t(await this._gateway.sendExtensionMessage(rn.RESTART_ICE,e,r===vr.SEND_ONLY))}catch(r){n(r)}}),this._p2pChannel.on(Se.LocalCandidate,e=>{this._gateway.sendExtensionMessage(rn.CANDIDATE,JSON.stringify(e),!0)}),this._p2pChannel.on(Se.RequestP2PMuteLocal,async(e,t,n)=>{try{await this._gateway.sendExtensionMessage(rn.CONTROL,e,!0),t()}catch(r){n(r)}}),this._p2pChannel.on(Se.RequestP2PUnmuteRemote,async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===b.DISCONNECT_P2P?t():n(r)}else t()}),this._p2pChannel.on(Se.RequestP2PMuteRemote,async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===b.DISCONNECT_P2P?t():n(r)}else t()}),this._p2pChannel.on(Se.StateChange,(e,t)=>{t===ut.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(Se.PeerConnectionStateChange,e=>{const t=this._peerConnectionState;e!==t&&(this.safeEmit(Ke.PEERCONNECTION_STATE_CHANGE,e,t),this._peerConnectionState=e)}),this._p2pChannel.on(Se.RequestMuteLocal,async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===b.DISCONNECT_P2P?t():n(r)}else t()}),this._p2pChannel.on(Se.RequestUnmuteLocal,async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===b.DISCONNECT_P2P?t():n(r)}else t()}),this._p2pChannel.on(Se.RequestRePublish,(e,t,n)=>{this.publish(e,!1).then(t).catch(n)}),this._p2pChannel.on(Se.RequestRePublishDataChannel,(e,t,n)=>{se.all(e.map(async r=>{const i=await this._p2pChannel.publishDataChannel([r]);try{i.forEach(o=>{this._uid&&this._gateway.publishDataChannel(this._uid,o,!0)})}catch(o){if(o.code!==b.DISCONNECT_P2P)throw o}})).then(t).catch(n)}),this._p2pChannel.on(Se.RequestReSubscribe,async(e,t,n)=>{try{for(const{user:r,kind:i}of e)i===ue.VIDEO?await this.subscribe(r,"video"):await this.subscribe(r,"audio");t()}catch(r){n(r)}}),this._p2pChannel.on(Se.RequestUpload,(e,t)=>{this._gateway.upload(e,t)}),this._p2pChannel.on(Se.RequestUploadStats,e=>{this._gateway.uploadWRTCStats(e)}),this._p2pChannel.on(Se.MediaReconnectStart,e=>{this.safeEmit(Ke.MEDIA_RECONNECT_START,e)}),this._p2pChannel.on(Se.MediaReconnectEnd,e=>{this.safeEmit(Ke.MEDIA_RECONNECT_END,e)}),this._p2pChannel.on(Se.NeedSignalRTT,e=>{e(this._gateway.getSignalRTT())}),this._p2pChannel.on(Se.RequestRestartICE,async e=>{if(this.store.useP2P)return;const t=await this._p2pChannel.restartICE(e),n=await t.next();if(n.done)return;const r=n.value;let i;try{i=await this._gateway.restartICE({iceParameters:r})}catch(s){return void t.throw(s)}const{iceParameters:o}=function(s){const c=s.iceParameters;return{iceParameters:{iceUfrag:c.iceUfrag,icePwd:c.icePwd}}}(i);await t.next({remoteIceParameters:o})}),this._p2pChannel.on(Se.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(Se.RequestReconnectPC,async()=>{var e;const{iceParameters:t,dtlsParameters:n,rtpCapabilities:r}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:i,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:n,rtpCapabilities:r}),s=F1(i,o);await this._p2pChannel.connect(s),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(Se.RequestUnpublishForReconnectPC,async(e,t,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),t()):n()}),this._p2pChannel.on(Se.P2PLost,()=>{this.safeEmit(Ke.P2P_LOST,this.store.uid)}),this._p2pChannel.on(Se.UpdateVideoEncoder,e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)}),this._p2pChannel.on(Se.ConnectionTypeChange,e=>{this.safeEmit(Ke.IS_USING_CLOUD_PROXY,e),this._gateway.setUsingProxy(e)}),this._p2pChannel.on(Se.FirstVideoBufferReady,(e,t)=>{this.safeEmit(Ke.FIRST_VIDEO_BUFFER_READY,e,t)}),this._p2pChannel.on(Se.FirstVideoPreRender,(e,t)=>{this.safeEmit(Ke.FIRST_VIDEO_PRE_RENDER,e,t)}),this._p2pChannel.on(Se.RequestLowStreamParameter,e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(Se.QueryClientConnectionState,e=>{e(this.connectionState)}),this._p2pChannel.on(Se.AudioMetadata,e=>{this.safeEmit(Ke.AUDIO_METADATA,e)}),this._p2pChannel.on(Se.AudioPts,e=>{this.safeEmit(Ke.AUDIO_PTS,Number(e))})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new B(b.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new B(b.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{const n=(t={config:e},Bo("ContentInspect").create(t));this._inspect=n,this.handleVideoInspectEvents(n);const{appId:r,cname:i,sid:o,token:s,uid:c,cid:l,vid:u}=this._joinInfo;await n.init({appId:r,areaCode:"",cname:i,sid:o,token:s,uid:c,cid:l,vid:u?Number(u):0},an)}catch(n){throw Array.isArray(n)?n[0]:n}var t}handleVideoInspectEvents(e){e.on(Mn.CONNECTION_STATE_CHANGE,(t,n)=>{if(this.safeEmit(Ke.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,n),n===lo.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(Ke.CONTENT_INSPECT_ERROR,new B(b.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}}),e.on(Mn.INSPECT_RESULT,(t,n)=>{var r;if((n==null?void 0:n.code)===b.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return g.debug("Stop inspect content because that has left channel"),this==null||(r=this._inspect)===null||r===void 0||r.close(),void(this._inspect=void 0);this.safeEmit(Ke.CONTENT_INSPECT_RESULT,t,n)}),e.on(Mn.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}async disableContentInspect(){if(!this._inspect)throw new B(b.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(io(e,"enabled"),e){if(!t)throw new B(b.INVALID_PARAMS,"config is required");if($M(t),!this._joinInfo)throw new B(b.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(t);else{const r=(n={config:t},Bo("ImageModeration").create(n));this._moderation=r,this.handleImageModerationEvents(r);const{appId:i,cname:o,sid:s,token:c,uid:l,cid:u,vid:h}=this._joinInfo;await r.init({appId:i,areaCode:"",cname:o,sid:s,token:c,uid:l,cid:u,vid:h?Number(h):0},an)}}catch(r){throw Array.isArray(r)?r[0]:r}}else{var n;if(!this._moderation)throw new B(b.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(r){throw Array.isArray(r)?r[0]:r}}}handleImageModerationEvents(e){e.on(Fo.CONNECTION_STATE_CHANGE,(t,n)=>{if(this.safeEmit(Ke.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,n),t===Vi.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new B(b.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}}),e.on(Fo.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}setP2PTransport(e){if(function(t){sn(t,"transport",["default","auto","relay","sd-rtn"])}(e),this.mode!=="p2p")throw new B(b.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,g.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}getJoinChannelServiceRecords(){return g.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){io(e,"enabled"),vt("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_setRteInfo(e,t){this.store.rteUrl=e,this.store.rteSid=t}_isPreRender(){return"isPreRender"in this._p2pChannel&&this._p2pChannel.isPreRender()}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}},ae(le.prototype,"leave",[e2],Object.getOwnPropertyDescriptor(le.prototype,"leave"),le.prototype),ae(le.prototype,"publish",[t2],Object.getOwnPropertyDescriptor(le.prototype,"publish"),le.prototype),ae(le.prototype,"unpublish",[n2],Object.getOwnPropertyDescriptor(le.prototype,"unpublish"),le.prototype),ae(le.prototype,"subscribe",[r2],Object.getOwnPropertyDescriptor(le.prototype,"subscribe"),le.prototype),ae(le.prototype,"presubscribe",[i2],Object.getOwnPropertyDescriptor(le.prototype,"presubscribe"),le.prototype),ae(le.prototype,"massSubscribe",[o2],Object.getOwnPropertyDescriptor(le.prototype,"massSubscribe"),le.prototype),ae(le.prototype,"unsubscribe",[s2],Object.getOwnPropertyDescriptor(le.prototype,"unsubscribe"),le.prototype),ae(le.prototype,"massUnsubscribe",[a2],Object.getOwnPropertyDescriptor(le.prototype,"massUnsubscribe"),le.prototype),ae(le.prototype,"setLowStreamParameter",[c2],Object.getOwnPropertyDescriptor(le.prototype,"setLowStreamParameter"),le.prototype),ae(le.prototype,"setDualStreamMode",[d2],Object.getOwnPropertyDescriptor(le.prototype,"setDualStreamMode"),le.prototype),ae(le.prototype,"enableDualStream",[l2],Object.getOwnPropertyDescriptor(le.prototype,"enableDualStream"),le.prototype),ae(le.prototype,"disableDualStream",[u2],Object.getOwnPropertyDescriptor(le.prototype,"disableDualStream"),le.prototype),ae(le.prototype,"setClientRole",[h2],Object.getOwnPropertyDescriptor(le.prototype,"setClientRole"),le.prototype),ae(le.prototype,"_setClientRoleOptions",[p2],Object.getOwnPropertyDescriptor(le.prototype,"_setClientRoleOptions"),le.prototype),ae(le.prototype,"setProxyServer",[f2],Object.getOwnPropertyDescriptor(le.prototype,"setProxyServer"),le.prototype),ae(le.prototype,"setTurnServer",[_2],Object.getOwnPropertyDescriptor(le.prototype,"setTurnServer"),le.prototype),ae(le.prototype,"setLicense",[m2],Object.getOwnPropertyDescriptor(le.prototype,"setLicense"),le.prototype),ae(le.prototype,"startProxyServer",[E2],Object.getOwnPropertyDescriptor(le.prototype,"startProxyServer"),le.prototype),ae(le.prototype,"stopProxyServer",[g2],Object.getOwnPropertyDescriptor(le.prototype,"stopProxyServer"),le.prototype),ae(le.prototype,"setLocalAccessPointsV2",[S2],Object.getOwnPropertyDescriptor(le.prototype,"setLocalAccessPointsV2"),le.prototype),ae(le.prototype,"setLocalAccessPoints",[T2],Object.getOwnPropertyDescriptor(le.prototype,"setLocalAccessPoints"),le.prototype),ae(le.prototype,"setRemoteDefaultVideoStreamType",[v2],Object.getOwnPropertyDescriptor(le.prototype,"setRemoteDefaultVideoStreamType"),le.prototype),ae(le.prototype,"setRemoteVideoStreamType",[R2],Object.getOwnPropertyDescriptor(le.prototype,"setRemoteVideoStreamType"),le.prototype),ae(le.prototype,"setStreamFallbackOption",[y2],Object.getOwnPropertyDescriptor(le.prototype,"setStreamFallbackOption"),le.prototype),ae(le.prototype,"setEncryptionConfig",[C2],Object.getOwnPropertyDescriptor(le.prototype,"setEncryptionConfig"),le.prototype),ae(le.prototype,"renewToken",[I2],Object.getOwnPropertyDescriptor(le.prototype,"renewToken"),le.prototype),ae(le.prototype,"enableAudioVolumeIndicator",[w2],Object.getOwnPropertyDescriptor(le.prototype,"enableAudioVolumeIndicator"),le.prototype),ae(le.prototype,"startLiveStreaming",[A2],Object.getOwnPropertyDescriptor(le.prototype,"startLiveStreaming"),le.prototype),ae(le.prototype,"setLiveTranscoding",[b2],Object.getOwnPropertyDescriptor(le.prototype,"setLiveTranscoding"),le.prototype),ae(le.prototype,"stopLiveStreaming",[O2],Object.getOwnPropertyDescriptor(le.prototype,"stopLiveStreaming"),le.prototype),ae(le.prototype,"startChannelMediaRelay",[N2],Object.getOwnPropertyDescriptor(le.prototype,"startChannelMediaRelay"),le.prototype),ae(le.prototype,"updateChannelMediaRelay",[D2],Object.getOwnPropertyDescriptor(le.prototype,"updateChannelMediaRelay"),le.prototype),ae(le.prototype,"stopChannelMediaRelay",[P2],Object.getOwnPropertyDescriptor(le.prototype,"stopChannelMediaRelay"),le.prototype),ae(le.prototype,"sendCustomReportMessage",[L2],Object.getOwnPropertyDescriptor(le.prototype,"sendCustomReportMessage"),le.prototype),ae(le.prototype,"pickSVCLayer",[k2],Object.getOwnPropertyDescriptor(le.prototype,"pickSVCLayer"),le.prototype),ae(le.prototype,"setRTMConfig",[M2],Object.getOwnPropertyDescriptor(le.prototype,"setRTMConfig"),le.prototype),ae(le.prototype,"enableContentInspect",[U2],Object.getOwnPropertyDescriptor(le.prototype,"enableContentInspect"),le.prototype),ae(le.prototype,"disableContentInspect",[x2],Object.getOwnPropertyDescriptor(le.prototype,"disableContentInspect"),le.prototype),ae(le.prototype,"setImageModeration",[V2],Object.getOwnPropertyDescriptor(le.prototype,"setImageModeration"),le.prototype),ae(le.prototype,"setP2PTransport",[F2],Object.getOwnPropertyDescriptor(le.prototype,"setP2PTransport"),le.prototype),ae(le.prototype,"getJoinChannelServiceRecords",[B2],Object.getOwnPropertyDescriptor(le.prototype,"getJoinChannelServiceRecords"),le.prototype),ae(le.prototype,"setPublishAudioFilterEnabled",[j2],Object.getOwnPropertyDescriptor(le.prototype,"setPublishAudioFilterEnabled"),le.prototype),le);function W2(){var e;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const n=_t(5,"client-"),r=pe.reportApiInvoke(null,{id:n,name:Ft.CREATE_CLIENT,options:[t],tag:It.TRACER});try{(function(i){sn(i.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),sn(i.mode,"config.mode",["rtc","live","p2p"]),i.audioCodec!==void 0&&sn(i.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),i.proxyServer!==void 0&&jn(i.proxyServer,"config.proxyServer",1,1e4),i.turnServer!==void 0&&vP(i.turnServer),i.httpRetryConfig!==void 0&&TP(i.httpRetryConfig),i.websocketRetryConfig!==void 0&&TP(i.websocketRetryConfig)})(t)}catch(i){throw r.onError(i),i}return(aP(16,0,!0)||Rv(16,0,!0))&&(t.codec==="vp9"&&(t.codec="vp8",g.debug("browser not support vp9, force use vp8")),vt("UNSUPPORTED_VIDEO_CODEC",["vp9"])),t.audioCodec===void 0&&(t.audioCodec="opus"),r.onSuccess(),new iJ(_o(_o({forceWaitGatewayResponse:!0},t),{},{role:Z(e=["rtc","p2p"]).call(e,t.mode)?"host":t.role||"audience"}),n)}function oJ(){let e=!1;const t=ot();return(t.name===at.CHROME&&Number(t.version)>=58&&(Lo.engine.name!=="WebKit"||function(){const n=ot();if(w_()){if(n.os===Cn.MAC_OS)return!0;if(n.os===Cn.IOS){const r=Lo.os.version&&Lo.os.version.split(".");if(r&&Number(r[0])===14&&r[1]&&Number(r[1])>=3||r&&Number(r[0])>14)return!0}}return!1}())||t.name===at.FIREFOX&&Number(t.version)>=56||t.name===at.OPERA&&Number(t.version)>=45||t.name===at.SAFARI&&Number(t.version)>=11||t.name==="WebKit"&&(sr()||ro())&&t.osVersion&&Number(t.osVersion.split(".")[0])>=11||lP()||ot().name===at.QQ)&&(e=!0),e}class Vh{constructor(t,n){y(this,"id",0),y(this,"element",void 0),y(this,"peerPair",void 0),y(this,"context",void 0),y(this,"audioPlayerElement",void 0),y(this,"audioTrack",void 0),Vh.count+=1,this.id=Vh.count,this.element=t,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const n=document.createElement("audio");n.srcObject=new MediaStream([t.track]),n.play(),this.audioPlayerElement=n}}async switchSdp(){if(!this.peerPair)return;const t=async(r,i)=>{const o=i==="offer"?await r.createOffer():await r.createAnswer();return await r.setLocalDescription(o),r.iceGatheringState==="complete"?r.localDescription:new se(s=>{r.onicegatheringstatechange=()=>{r.iceGatheringState==="complete"&&s(r.localDescription)}})},n=async(r,i)=>await r.setRemoteDescription(i);try{const r=await t(this.peerPair[0],"offer");await n(this.peerPair[1],r);const i=await t(this.peerPair[1],"answer");await n(this.peerPair[0],i)}catch(r){throw new B(b.LOCAL_AEC_ERROR,r.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let n;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(n)}catch(i){throw new B(b.LOCAL_AEC_ERROR,i.toString()).print()}if(!n)throw new B(b.LOCAL_AEC_ERROR,"no dest node when local aec").print();const r=n.stream.getAudioTracks()[0];return this.audioTrack=r,r}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,n=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp()}close(){g.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(t=>{t.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var H2,Nm;y(Vh,"count",0);const sJ=window.AudioContext||window.webkitAudioContext,aJ=new(H2=Ie({report:pe}),ae((Nm=class{constructor(){y(this,"units",[]),y(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return g.debug("the system does not need to process local aec"),-1;this.context||(this.context=new sJ);let t=this.units.find(n=>n&&n.getElement()===e);return t||(t=new Vh(e,this.context),this.units.push(t)),t.startEchoCancellation(),g.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return ot().name!==at.SAFARI}}).prototype,"processExternalMediaAEC",[H2],Object.getOwnPropertyDescriptor(Nm.prototype,"processExternalMediaAEC"),Nm.prototype),Nm);function K2(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Y2(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?K2(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):K2(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}const _y=window||document;function z2(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!_y)return;const n=pn._cspEventHandlerPointer;if(n&&t)return void console.error(n,t);const r=i=>{if(!(i&&i.blockedURI&&(pn.onSecurityPolicyViolation||pn.getListeners(_s.SECURITY_POLICY_VIOLATION).length>0)))return;const o=i.blockedURI;w("CSP_DETECTED_HOSTNAME_LIST").some(s=>Z(o).call(o,s))&&(pn.onSecurityPolicyViolation&&typeof pn.onSecurityPolicyViolation=="function"&&pn.onSecurityPolicyViolation(i),pn.getListeners(_s.SECURITY_POLICY_VIOLATION).length>0&&pn.safeEmit(_s.SECURITY_POLICY_VIOLATION,i))};n&&_y.removeEventListener("securitypolicyviolation",n),(t||e&&typeof e=="function"||pn.getListeners(_s.SECURITY_POLICY_VIOLATION).length>0)&&_y.addEventListener("securitypolicyviolation",r),pn._cspEventHandlerPointer=r}var cJ=re,dJ=bT,q2=RegExp.prototype,lJ=function(e){return e===q2||cJ(q2,e)?dJ(e):e.flags},ur=S(lJ);function xl(e){let t=e.length;for(;--t>=0;)e[t]=0}const my=256,X2=286,Fh=30,Bh=15,Ey=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Dm=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),uJ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),J2=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Ys=new Array(576);xl(Ys);const jh=new Array(60);xl(jh);const Gh=new Array(512);xl(Gh);const Wh=new Array(256);xl(Wh);const gy=new Array(29);xl(gy);const Pm=new Array(Fh);function Sy(e,t,n,r,i){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=r,this.max_length=i,this.has_stree=e&&e.length}let Q2,Z2,$2;function Ty(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}xl(Pm);const eU=e=>e<256?Gh[e]:Gh[256+(e>>>7)],Hh=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},Ri=(e,t,n)=>{e.bi_valid>16-n?(e.bi_buf|=t<<e.bi_valid&65535,Hh(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=n-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)},vs=(e,t,n)=>{Ri(e,n[2*t],n[2*t+1])},tU=(e,t)=>{let n=0;do n|=1&e,e>>>=1,n<<=1;while(--t>0);return n>>>1},nU=(e,t,n)=>{const r=new Array(16);let i,o,s=0;for(i=1;i<=Bh;i++)s=s+n[i-1]<<1,r[i]=s;for(o=0;o<=t;o++){let c=e[2*o+1];c!==0&&(e[2*o]=tU(r[c]++,c))}},rU=e=>{let t;for(t=0;t<X2;t++)e.dyn_ltree[2*t]=0;for(t=0;t<Fh;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},iU=e=>{e.bi_valid>8?Hh(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},oU=(e,t,n,r)=>{const i=2*t,o=2*n;return e[i]<e[o]||e[i]===e[o]&&r[t]<=r[n]},vy=(e,t,n)=>{const r=e.heap[n];let i=n<<1;for(;i<=e.heap_len&&(i<e.heap_len&&oU(t,e.heap[i+1],e.heap[i],e.depth)&&i++,!oU(t,r,e.heap[i],e.depth));)e.heap[n]=e.heap[i],n=i,i<<=1;e.heap[n]=r},sU=(e,t,n)=>{let r,i,o,s,c=0;if(e.sym_next!==0)do r=255&e.pending_buf[e.sym_buf+c++],r+=(255&e.pending_buf[e.sym_buf+c++])<<8,i=e.pending_buf[e.sym_buf+c++],r===0?vs(e,i,t):(o=Wh[i],vs(e,o+my+1,t),s=Ey[o],s!==0&&(i-=gy[o],Ri(e,i,s)),r--,o=eU(r),vs(e,o,n),s=Dm[o],s!==0&&(r-=Pm[o],Ri(e,r,s)));while(c<e.sym_next);vs(e,256,t)},Ry=(e,t)=>{const n=t.dyn_tree,r=t.stat_desc.static_tree,i=t.stat_desc.has_stree,o=t.stat_desc.elems;let s,c,l,u=-1;for(e.heap_len=0,e.heap_max=573,s=0;s<o;s++)n[2*s]!==0?(e.heap[++e.heap_len]=u=s,e.depth[s]=0):n[2*s+1]=0;for(;e.heap_len<2;)l=e.heap[++e.heap_len]=u<2?++u:0,n[2*l]=1,e.depth[l]=0,e.opt_len--,i&&(e.static_len-=r[2*l+1]);for(t.max_code=u,s=e.heap_len>>1;s>=1;s--)vy(e,n,s);l=o;do s=e.heap[1],e.heap[1]=e.heap[e.heap_len--],vy(e,n,1),c=e.heap[1],e.heap[--e.heap_max]=s,e.heap[--e.heap_max]=c,n[2*l]=n[2*s]+n[2*c],e.depth[l]=(e.depth[s]>=e.depth[c]?e.depth[s]:e.depth[c])+1,n[2*s+1]=n[2*c+1]=l,e.heap[1]=l++,vy(e,n,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((h,f)=>{const _=f.dyn_tree,E=f.max_code,I=f.stat_desc.static_tree,v=f.stat_desc.has_stree,R=f.stat_desc.extra_bits,A=f.stat_desc.extra_base,O=f.stat_desc.max_length;let P,M,U,L,V,H,q=0;for(L=0;L<=Bh;L++)h.bl_count[L]=0;for(_[2*h.heap[h.heap_max]+1]=0,P=h.heap_max+1;P<573;P++)M=h.heap[P],L=_[2*_[2*M+1]+1]+1,L>O&&(L=O,q++),_[2*M+1]=L,M>E||(h.bl_count[L]++,V=0,M>=A&&(V=R[M-A]),H=_[2*M],h.opt_len+=H*(L+V),v&&(h.static_len+=H*(I[2*M+1]+V)));if(q!==0){do{for(L=O-1;h.bl_count[L]===0;)L--;h.bl_count[L]--,h.bl_count[L+1]+=2,h.bl_count[O]--,q-=2}while(q>0);for(L=O;L!==0;L--)for(M=h.bl_count[L];M!==0;)U=h.heap[--P],U>E||(_[2*U+1]!==L&&(h.opt_len+=(L-_[2*U+1])*_[2*U],_[2*U+1]=L),M--)}})(e,t),nU(n,u,e.bl_count)},aU=(e,t,n)=>{let r,i,o=-1,s=t[1],c=0,l=7,u=4;for(s===0&&(l=138,u=3),t[2*(n+1)+1]=65535,r=0;r<=n;r++)i=s,s=t[2*(r+1)+1],++c<l&&i===s||(c<u?e.bl_tree[2*i]+=c:i!==0?(i!==o&&e.bl_tree[2*i]++,e.bl_tree[32]++):c<=10?e.bl_tree[34]++:e.bl_tree[36]++,c=0,o=i,s===0?(l=138,u=3):i===s?(l=6,u=3):(l=7,u=4))},cU=(e,t,n)=>{let r,i,o=-1,s=t[1],c=0,l=7,u=4;for(s===0&&(l=138,u=3),r=0;r<=n;r++)if(i=s,s=t[2*(r+1)+1],!(++c<l&&i===s)){if(c<u)do vs(e,i,e.bl_tree);while(--c!=0);else i!==0?(i!==o&&(vs(e,i,e.bl_tree),c--),vs(e,16,e.bl_tree),Ri(e,c-3,2)):c<=10?(vs(e,17,e.bl_tree),Ri(e,c-3,3)):(vs(e,18,e.bl_tree),Ri(e,c-11,7));c=0,o=i,s===0?(l=138,u=3):i===s?(l=6,u=3):(l=7,u=4)}};let dU=!1;const lU=(e,t,n,r)=>{Ri(e,0+(r?1:0),3),iU(e),Hh(e,n),Hh(e,~n),n&&e.pending_buf.set(e.window.subarray(t,t+n),e.pending),e.pending+=n};var hJ=e=>{dU||((()=>{let t,n,r,i,o;const s=new Array(16);for(r=0,i=0;i<28;i++)for(gy[i]=r,t=0;t<1<<Ey[i];t++)Wh[r++]=i;for(Wh[r-1]=i,o=0,i=0;i<16;i++)for(Pm[i]=o,t=0;t<1<<Dm[i];t++)Gh[o++]=i;for(o>>=7;i<Fh;i++)for(Pm[i]=o<<7,t=0;t<1<<Dm[i]-7;t++)Gh[256+o++]=i;for(n=0;n<=Bh;n++)s[n]=0;for(t=0;t<=143;)Ys[2*t+1]=8,t++,s[8]++;for(;t<=255;)Ys[2*t+1]=9,t++,s[9]++;for(;t<=279;)Ys[2*t+1]=7,t++,s[7]++;for(;t<=287;)Ys[2*t+1]=8,t++,s[8]++;for(nU(Ys,287,s),t=0;t<Fh;t++)jh[2*t+1]=5,jh[2*t]=tU(t,5);Q2=new Sy(Ys,Ey,257,X2,Bh),Z2=new Sy(jh,Dm,0,Fh,Bh),$2=new Sy(new Array(0),uJ,0,19,7)})(),dU=!0),e.l_desc=new Ty(e.dyn_ltree,Q2),e.d_desc=new Ty(e.dyn_dtree,Z2),e.bl_desc=new Ty(e.bl_tree,$2),e.bi_buf=0,e.bi_valid=0,rU(e)},pJ=(e,t,n,r)=>{let i,o,s=0;e.level>0?(e.strm.data_type===2&&(e.strm.data_type=(c=>{let l,u=4093624447;for(l=0;l<=31;l++,u>>>=1)if(1&u&&c.dyn_ltree[2*l]!==0)return 0;if(c.dyn_ltree[18]!==0||c.dyn_ltree[20]!==0||c.dyn_ltree[26]!==0)return 1;for(l=32;l<my;l++)if(c.dyn_ltree[2*l]!==0)return 1;return 0})(e)),Ry(e,e.l_desc),Ry(e,e.d_desc),s=(c=>{let l;for(aU(c,c.dyn_ltree,c.l_desc.max_code),aU(c,c.dyn_dtree,c.d_desc.max_code),Ry(c,c.bl_desc),l=18;l>=3&&c.bl_tree[2*J2[l]+1]===0;l--);return c.opt_len+=3*(l+1)+5+5+4,l})(e),i=e.opt_len+3+7>>>3,o=e.static_len+3+7>>>3,o<=i&&(i=o)):i=o=n+5,n+4<=i&&t!==-1?lU(e,t,n,r):e.strategy===4||o===i?(Ri(e,2+(r?1:0),3),sU(e,Ys,jh)):(Ri(e,4+(r?1:0),3),((c,l,u,h)=>{let f;for(Ri(c,l-257,5),Ri(c,u-1,5),Ri(c,h-4,4),f=0;f<h;f++)Ri(c,c.bl_tree[2*J2[f]+1],3);cU(c,c.dyn_ltree,l-1),cU(c,c.dyn_dtree,u-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),sU(e,e.dyn_ltree,e.dyn_dtree)),rU(e),r&&iU(e)},fJ=(e,t,n)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=n,t===0?e.dyn_ltree[2*n]++:(e.matches++,t--,e.dyn_ltree[2*(Wh[n]+my+1)]++,e.dyn_dtree[2*eU(t)]++),e.sym_next===e.sym_end),_J=e=>{Ri(e,2,3),vs(e,256,Ys),(t=>{t.bi_valid===16?(Hh(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(e)},mJ={_tr_init:hJ,_tr_stored_block:lU,_tr_flush_block:pJ,_tr_tally:fJ,_tr_align:_J},Kh=(e,t,n,r)=>{let i=65535&e|0,o=e>>>16&65535|0,s=0;for(;n!==0;){s=n>2e3?2e3:n,n-=s;do i=i+t[r++]|0,o=o+i|0;while(--s);i%=65521,o%=65521}return i|o<<16|0};const EJ=new Uint32Array((()=>{let e,t=[];for(var n=0;n<256;n++){e=n;for(var r=0;r<8;r++)e=1&e?3988292384^e>>>1:e>>>1;t[n]=e}return t})());var Rr=(e,t,n,r)=>{const i=EJ,o=r+n;e^=-1;for(let s=r;s<o;s++)e=e>>>8^i[255&(e^t[s])];return-1^e},Zc={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Lm={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:gJ,_tr_stored_block:yy,_tr_flush_block:SJ,_tr_tally:La,_tr_align:TJ}=mJ,{Z_NO_FLUSH:ka,Z_PARTIAL_FLUSH:vJ,Z_FULL_FLUSH:RJ,Z_FINISH:mo,Z_BLOCK:uU,Z_OK:kr,Z_STREAM_END:hU,Z_STREAM_ERROR:Rs,Z_DATA_ERROR:yJ,Z_BUF_ERROR:Cy,Z_DEFAULT_COMPRESSION:CJ,Z_FILTERED:IJ,Z_HUFFMAN_ONLY:km,Z_RLE:wJ,Z_FIXED:AJ,Z_DEFAULT_STRATEGY:bJ,Z_UNKNOWN:OJ,Z_DEFLATED:Mm}=Lm,Iy=286,NJ=30,DJ=19,PJ=2*Iy+1,LJ=15,$c=258,ys=262,Vl=42,ed=113,Yh=666,td=(e,t)=>(e.msg=Zc[t],t),pU=e=>2*e-(e>4?9:0),Ma=e=>{let t=e.length;for(;--t>=0;)e[t]=0},kJ=e=>{let t,n,r,i=e.w_size;t=e.hash_size,r=t;do n=e.head[--r],e.head[r]=n>=i?n-i:0;while(--t);t=i,r=t;do n=e.prev[--r],e.prev[r]=n>=i?n-i:0;while(--t)};let Ua=(e,t,n)=>(t<<e.hash_shift^n)&e.hash_mask;const Fi=e=>{const t=e.state;let n=t.pending;n>e.avail_out&&(n=e.avail_out),n!==0&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+n),e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,t.pending===0&&(t.pending_out=0))},Bi=(e,t)=>{SJ(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,Fi(e.strm)},en=(e,t)=>{e.pending_buf[e.pending++]=t},zh=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},wy=(e,t,n,r)=>{let i=e.avail_in;return i>r&&(i=r),i===0?0:(e.avail_in-=i,t.set(e.input.subarray(e.next_in,e.next_in+i),n),e.state.wrap===1?e.adler=Kh(e.adler,t,i,n):e.state.wrap===2&&(e.adler=Rr(e.adler,t,i,n)),e.next_in+=i,e.total_in+=i,i)},fU=(e,t)=>{let n,r,i=e.max_chain_length,o=e.strstart,s=e.prev_length,c=e.nice_match;const l=e.strstart>e.w_size-ys?e.strstart-(e.w_size-ys):0,u=e.window,h=e.w_mask,f=e.prev,_=e.strstart+$c;let E=u[o+s-1],I=u[o+s];e.prev_length>=e.good_match&&(i>>=2),c>e.lookahead&&(c=e.lookahead);do if(n=t,u[n+s]===I&&u[n+s-1]===E&&u[n]===u[o]&&u[++n]===u[o+1]){o+=2,n++;do;while(u[++o]===u[++n]&&u[++o]===u[++n]&&u[++o]===u[++n]&&u[++o]===u[++n]&&u[++o]===u[++n]&&u[++o]===u[++n]&&u[++o]===u[++n]&&u[++o]===u[++n]&&o<_);if(r=$c-(_-o),o=_-$c,r>s){if(e.match_start=t,s=r,r>=c)break;E=u[o+s-1],I=u[o+s]}}while((t=f[t&h])>l&&--i!=0);return s<=e.lookahead?s:e.lookahead},Fl=e=>{const t=e.w_size;let n,r,i;do{if(r=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-ys)&&(e.window.set(e.window.subarray(t,t+t-r),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),kJ(e),r+=t),e.strm.avail_in===0)break;if(n=wy(e.strm,e.window,e.strstart+e.lookahead,r),e.lookahead+=n,e.lookahead+e.insert>=3)for(i=e.strstart-e.insert,e.ins_h=e.window[i],e.ins_h=Ua(e,e.ins_h,e.window[i+1]);e.insert&&(e.ins_h=Ua(e,e.ins_h,e.window[i+3-1]),e.prev[i&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=i,i++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<ys&&e.strm.avail_in!==0)},_U=(e,t)=>{let n,r,i,o=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,s=0,c=e.strm.avail_in;do{if(n=65535,i=e.bi_valid+42>>3,e.strm.avail_out<i||(i=e.strm.avail_out-i,r=e.strstart-e.block_start,n>r+e.strm.avail_in&&(n=r+e.strm.avail_in),n>i&&(n=i),n<o&&(n===0&&t!==mo||t===ka||n!==r+e.strm.avail_in)))break;s=t===mo&&n===r+e.strm.avail_in?1:0,yy(e,0,0,s),e.pending_buf[e.pending-4]=n,e.pending_buf[e.pending-3]=n>>8,e.pending_buf[e.pending-2]=~n,e.pending_buf[e.pending-1]=~n>>8,Fi(e.strm),r&&(r>n&&(r=n),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+r),e.strm.next_out),e.strm.next_out+=r,e.strm.avail_out-=r,e.strm.total_out+=r,e.block_start+=r,n-=r),n&&(wy(e.strm,e.strm.output,e.strm.next_out,n),e.strm.next_out+=n,e.strm.avail_out-=n,e.strm.total_out+=n)}while(s===0);return c-=e.strm.avail_in,c&&(c>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=c&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-c,e.strm.next_in),e.strstart),e.strstart+=c,e.insert+=c>e.w_size-e.insert?e.w_size-e.insert:c),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),s?4:t!==ka&&t!==mo&&e.strm.avail_in===0&&e.strstart===e.block_start?2:(i=e.window_size-e.strstart,e.strm.avail_in>i&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,i+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),i>e.strm.avail_in&&(i=e.strm.avail_in),i&&(wy(e.strm,e.window,e.strstart,i),e.strstart+=i,e.insert+=i>e.w_size-e.insert?e.w_size-e.insert:i),e.high_water<e.strstart&&(e.high_water=e.strstart),i=e.bi_valid+42>>3,i=e.pending_buf_size-i>65535?65535:e.pending_buf_size-i,o=i>e.w_size?e.w_size:i,r=e.strstart-e.block_start,(r>=o||(r||t===mo)&&t!==ka&&e.strm.avail_in===0&&r<=i)&&(n=r>i?i:r,s=t===mo&&e.strm.avail_in===0&&n===r?1:0,yy(e,e.block_start,n,s),e.block_start+=n,Fi(e.strm)),s?3:1)},Ay=(e,t)=>{let n,r;for(;;){if(e.lookahead<ys){if(Fl(e),e.lookahead<ys&&t===ka)return 1;if(e.lookahead===0)break}if(n=0,e.lookahead>=3&&(e.ins_h=Ua(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),n!==0&&e.strstart-n<=e.w_size-ys&&(e.match_length=fU(e,n)),e.match_length>=3)if(r=La(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do e.strstart++,e.ins_h=Ua(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!=0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=Ua(e,e.ins_h,e.window[e.strstart+1]);else r=La(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(r&&(Bi(e,!1),e.strm.avail_out===0))return 1}return e.insert=e.strstart<2?e.strstart:2,t===mo?(Bi(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(Bi(e,!1),e.strm.avail_out===0)?1:2},Bl=(e,t)=>{let n,r,i;for(;;){if(e.lookahead<ys){if(Fl(e),e.lookahead<ys&&t===ka)return 1;if(e.lookahead===0)break}if(n=0,e.lookahead>=3&&(e.ins_h=Ua(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,n!==0&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-ys&&(e.match_length=fU(e,n),e.match_length<=5&&(e.strategy===IJ||e.match_length===3&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){i=e.strstart+e.lookahead-3,r=La(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=i&&(e.ins_h=Ua(e,e.ins_h,e.window[e.strstart+3-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!=0);if(e.match_available=0,e.match_length=2,e.strstart++,r&&(Bi(e,!1),e.strm.avail_out===0))return 1}else if(e.match_available){if(r=La(e,0,e.window[e.strstart-1]),r&&Bi(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(r=La(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===mo?(Bi(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(Bi(e,!1),e.strm.avail_out===0)?1:2};function Cs(e,t,n,r,i){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=r,this.func=i}const qh=[new Cs(0,0,0,0,_U),new Cs(4,4,8,4,Ay),new Cs(4,5,16,8,Ay),new Cs(4,6,32,32,Ay),new Cs(4,4,16,16,Bl),new Cs(8,16,32,32,Bl),new Cs(8,16,128,128,Bl),new Cs(8,32,128,256,Bl),new Cs(32,128,258,1024,Bl),new Cs(32,258,258,4096,Bl)];function MJ(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=Mm,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*PJ),this.dyn_dtree=new Uint16Array(2*(2*NJ+1)),this.bl_tree=new Uint16Array(2*(2*DJ+1)),Ma(this.dyn_ltree),Ma(this.dyn_dtree),Ma(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(LJ+1),this.heap=new Uint16Array(2*Iy+1),Ma(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Iy+1),Ma(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Xh=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==Vl&&t.status!==57&&t.status!==69&&t.status!==73&&t.status!==91&&t.status!==103&&t.status!==ed&&t.status!==Yh?1:0},mU=e=>{if(Xh(e))return td(e,Rs);e.total_in=e.total_out=0,e.data_type=OJ;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?57:t.wrap?Vl:ed,e.adler=t.wrap===2?0:1,t.last_flush=-2,gJ(t),kr},EU=e=>{const t=mU(e);return t===kr&&(n=>{n.window_size=2*n.w_size,Ma(n.head),n.max_lazy_match=qh[n.level].max_lazy,n.good_match=qh[n.level].good_length,n.nice_match=qh[n.level].nice_length,n.max_chain_length=qh[n.level].max_chain,n.strstart=0,n.block_start=0,n.lookahead=0,n.insert=0,n.match_length=n.prev_length=2,n.match_available=0,n.ins_h=0})(e.state),t},gU=(e,t,n,r,i,o)=>{if(!e)return Rs;let s=1;if(t===CJ&&(t=6),r<0?(s=0,r=-r):r>15&&(s=2,r-=16),i<1||i>9||n!==Mm||r<8||r>15||t<0||t>9||o<0||o>AJ||r===8&&s!==1)return td(e,Rs);r===8&&(r=9);const c=new MJ;return e.state=c,c.strm=e,c.status=Vl,c.wrap=s,c.gzhead=null,c.w_bits=r,c.w_size=1<<c.w_bits,c.w_mask=c.w_size-1,c.hash_bits=i+7,c.hash_size=1<<c.hash_bits,c.hash_mask=c.hash_size-1,c.hash_shift=~~((c.hash_bits+3-1)/3),c.window=new Uint8Array(2*c.w_size),c.head=new Uint16Array(c.hash_size),c.prev=new Uint16Array(c.w_size),c.lit_bufsize=1<<i+6,c.pending_buf_size=4*c.lit_bufsize,c.pending_buf=new Uint8Array(c.pending_buf_size),c.sym_buf=c.lit_bufsize,c.sym_end=3*(c.lit_bufsize-1),c.level=t,c.strategy=o,c.method=n,EU(e)};var UJ=(e,t)=>{if(Xh(e)||t>uU||t<0)return e?td(e,Rs):Rs;const n=e.state;if(!e.output||e.avail_in!==0&&!e.input||n.status===Yh&&t!==mo)return td(e,e.avail_out===0?Cy:Rs);const r=n.last_flush;if(n.last_flush=t,n.pending!==0){if(Fi(e),e.avail_out===0)return n.last_flush=-1,kr}else if(e.avail_in===0&&pU(t)<=pU(r)&&t!==mo)return td(e,Cy);if(n.status===Yh&&e.avail_in!==0)return td(e,Cy);if(n.status===Vl&&n.wrap===0&&(n.status=ed),n.status===Vl){let i=Mm+(n.w_bits-8<<4)<<8,o=-1;if(o=n.strategy>=km||n.level<2?0:n.level<6?1:n.level===6?2:3,i|=o<<6,n.strstart!==0&&(i|=32),i+=31-i%31,zh(n,i),n.strstart!==0&&(zh(n,e.adler>>>16),zh(n,65535&e.adler)),e.adler=1,n.status=ed,Fi(e),n.pending!==0)return n.last_flush=-1,kr}if(n.status===57){if(e.adler=0,en(n,31),en(n,139),en(n,8),n.gzhead)en(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),en(n,255&n.gzhead.time),en(n,n.gzhead.time>>8&255),en(n,n.gzhead.time>>16&255),en(n,n.gzhead.time>>24&255),en(n,n.level===9?2:n.strategy>=km||n.level<2?4:0),en(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(en(n,255&n.gzhead.extra.length),en(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=Rr(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(en(n,0),en(n,0),en(n,0),en(n,0),en(n,0),en(n,n.level===9?2:n.strategy>=km||n.level<2?4:0),en(n,3),n.status=ed,Fi(e),n.pending!==0)return n.last_flush=-1,kr}if(n.status===69){if(n.gzhead.extra){let i=n.pending,o=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+o>n.pending_buf_size;){let c=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+c),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>i&&(e.adler=Rr(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex+=c,Fi(e),n.pending!==0)return n.last_flush=-1,kr;i=0,o-=c}let s=new Uint8Array(n.gzhead.extra);n.pending_buf.set(s.subarray(n.gzindex,n.gzindex+o),n.pending),n.pending+=o,n.gzhead.hcrc&&n.pending>i&&(e.adler=Rr(e.adler,n.pending_buf,n.pending-i,i)),n.gzindex=0}n.status=73}if(n.status===73){if(n.gzhead.name){let i,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(e.adler=Rr(e.adler,n.pending_buf,n.pending-o,o)),Fi(e),n.pending!==0)return n.last_flush=-1,kr;o=0}i=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,en(n,i)}while(i!==0);n.gzhead.hcrc&&n.pending>o&&(e.adler=Rr(e.adler,n.pending_buf,n.pending-o,o)),n.gzindex=0}n.status=91}if(n.status===91){if(n.gzhead.comment){let i,o=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>o&&(e.adler=Rr(e.adler,n.pending_buf,n.pending-o,o)),Fi(e),n.pending!==0)return n.last_flush=-1,kr;o=0}i=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,en(n,i)}while(i!==0);n.gzhead.hcrc&&n.pending>o&&(e.adler=Rr(e.adler,n.pending_buf,n.pending-o,o))}n.status=103}if(n.status===103){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(Fi(e),n.pending!==0))return n.last_flush=-1,kr;en(n,255&e.adler),en(n,e.adler>>8&255),e.adler=0}if(n.status=ed,Fi(e),n.pending!==0)return n.last_flush=-1,kr}if(e.avail_in!==0||n.lookahead!==0||t!==ka&&n.status!==Yh){let i=n.level===0?_U(n,t):n.strategy===km?((o,s)=>{let c;for(;;){if(o.lookahead===0&&(Fl(o),o.lookahead===0)){if(s===ka)return 1;break}if(o.match_length=0,c=La(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,c&&(Bi(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===mo?(Bi(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(Bi(o,!1),o.strm.avail_out===0)?1:2})(n,t):n.strategy===wJ?((o,s)=>{let c,l,u,h;const f=o.window;for(;;){if(o.lookahead<=$c){if(Fl(o),o.lookahead<=$c&&s===ka)return 1;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=3&&o.strstart>0&&(u=o.strstart-1,l=f[u],l===f[++u]&&l===f[++u]&&l===f[++u])){h=o.strstart+$c;do;while(l===f[++u]&&l===f[++u]&&l===f[++u]&&l===f[++u]&&l===f[++u]&&l===f[++u]&&l===f[++u]&&l===f[++u]&&u<h);o.match_length=$c-(h-u),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=3?(c=La(o,1,o.match_length-3),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(c=La(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),c&&(Bi(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===mo?(Bi(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(Bi(o,!1),o.strm.avail_out===0)?1:2})(n,t):qh[n.level].func(n,t);if(i!==3&&i!==4||(n.status=Yh),i===1||i===3)return e.avail_out===0&&(n.last_flush=-1),kr;if(i===2&&(t===vJ?TJ(n):t!==uU&&(yy(n,0,0,!1),t===RJ&&(Ma(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),Fi(e),e.avail_out===0))return n.last_flush=-1,kr}return t!==mo?kr:n.wrap<=0?hU:(n.wrap===2?(en(n,255&e.adler),en(n,e.adler>>8&255),en(n,e.adler>>16&255),en(n,e.adler>>24&255),en(n,255&e.total_in),en(n,e.total_in>>8&255),en(n,e.total_in>>16&255),en(n,e.total_in>>24&255)):(zh(n,e.adler>>>16),zh(n,65535&e.adler)),Fi(e),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?kr:hU)},xJ=(e,t)=>{let n=t.length;if(Xh(e))return Rs;const r=e.state,i=r.wrap;if(i===2||i===1&&r.status!==Vl||r.lookahead)return Rs;if(i===1&&(e.adler=Kh(e.adler,t,n,0)),r.wrap=0,n>=r.w_size){i===0&&(Ma(r.head),r.strstart=0,r.block_start=0,r.insert=0);let l=new Uint8Array(r.w_size);l.set(t.subarray(n-r.w_size,n),0),t=l,n=r.w_size}const o=e.avail_in,s=e.next_in,c=e.input;for(e.avail_in=n,e.next_in=0,e.input=t,Fl(r);r.lookahead>=3;){let l=r.strstart,u=r.lookahead-2;do r.ins_h=Ua(r,r.ins_h,r.window[l+3-1]),r.prev[l&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=l,l++;while(--u);r.strstart=l,r.lookahead=2,Fl(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=2,r.match_available=0,e.next_in=s,e.input=c,e.avail_in=o,r.wrap=i,kr},Jh={deflateInit:(e,t)=>gU(e,t,Mm,15,8,bJ),deflateInit2:gU,deflateReset:EU,deflateResetKeep:mU,deflateSetHeader:(e,t)=>Xh(e)||e.state.wrap!==2?Rs:(e.state.gzhead=t,kr),deflate:UJ,deflateEnd:e=>{if(Xh(e))return Rs;const t=e.state.status;return e.state=null,t===ed?td(e,yJ):kr},deflateSetDictionary:xJ,deflateInfo:"pako deflate (from Nodeca project)"};const VJ=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var Um={assign:function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const n=t.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const r in n)VJ(n,r)&&(e[r]=n[r])}}return e},flattenChunks:e=>{let t=0;for(let r=0,i=e.length;r<i;r++)t+=e[r].length;const n=new Uint8Array(t);for(let r=0,i=0,o=e.length;r<o;r++){let s=e[r];n.set(s,i),i+=s.length}return n}};let SU=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{SU=!1}const Qh=new Uint8Array(256);for(let e=0;e<256;e++)Qh[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;Qh[254]=Qh[254]=1;var Zh={string2buf:e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let t,n,r,i,o,s=e.length,c=0;for(i=0;i<s;i++)n=e.charCodeAt(i),(64512&n)==55296&&i+1<s&&(r=e.charCodeAt(i+1),(64512&r)==56320&&(n=65536+(n-55296<<10)+(r-56320),i++)),c+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Uint8Array(c),o=0,i=0;o<c;i++)n=e.charCodeAt(i),(64512&n)==55296&&i+1<s&&(r=e.charCodeAt(i+1),(64512&r)==56320&&(n=65536+(n-55296<<10)+(r-56320),i++)),n<128?t[o++]=n:n<2048?(t[o++]=192|n>>>6,t[o++]=128|63&n):n<65536?(t[o++]=224|n>>>12,t[o++]=128|n>>>6&63,t[o++]=128|63&n):(t[o++]=240|n>>>18,t[o++]=128|n>>>12&63,t[o++]=128|n>>>6&63,t[o++]=128|63&n);return t},buf2string:(e,t)=>{const n=t||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,t));let r,i;const o=new Array(2*n);for(i=0,r=0;r<n;){let s=e[r++];if(s<128){o[i++]=s;continue}let c=Qh[s];if(c>4)o[i++]=65533,r+=c-1;else{for(s&=c===2?31:c===3?15:7;c>1&&r<n;)s=s<<6|63&e[r++],c--;c>1?o[i++]=65533:s<65536?o[i++]=s:(s-=65536,o[i++]=55296|s>>10&1023,o[i++]=56320|1023&s)}}return((s,c)=>{if(c<65534&&s.subarray&&SU)return String.fromCharCode.apply(null,s.length===c?s:s.subarray(0,c));let l="";for(let u=0;u<c;u++)l+=String.fromCharCode(s[u]);return l})(o,i)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let n=t-1;for(;n>=0&&(192&e[n])==128;)n--;return n<0||n===0?t:n+Qh[e[n]]>t?n:t}},TU=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const vU=Object.prototype.toString,{Z_NO_FLUSH:FJ,Z_SYNC_FLUSH:BJ,Z_FULL_FLUSH:jJ,Z_FINISH:GJ,Z_OK:xm,Z_STREAM_END:WJ,Z_DEFAULT_COMPRESSION:HJ,Z_DEFAULT_STRATEGY:KJ,Z_DEFLATED:YJ}=Lm;function Vm(e){this.options=Um.assign({level:HJ,method:YJ,chunkSize:16384,windowBits:15,memLevel:8,strategy:KJ},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new TU,this.strm.avail_out=0;let n=Jh.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==xm)throw new Error(Zc[n]);if(t.header&&Jh.deflateSetHeader(this.strm,t.header),t.dictionary){let r;if(r=typeof t.dictionary=="string"?Zh.string2buf(t.dictionary):vU.call(t.dictionary)==="[object ArrayBuffer]"?new Uint8Array(t.dictionary):t.dictionary,n=Jh.deflateSetDictionary(this.strm,r),n!==xm)throw new Error(Zc[n]);this._dict_set=!0}}function RU(e,t){const n=new Vm(t);if(n.push(e,!0),n.err)throw n.msg||Zc[n.err];return n.result}Vm.prototype.push=function(e,t){const n=this.strm,r=this.options.chunkSize;let i,o;if(this.ended)return!1;for(o=t===~~t?t:t===!0?GJ:FJ,typeof e=="string"?n.input=Zh.string2buf(e):vU.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;)if(n.avail_out===0&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),(o===BJ||o===jJ)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(i=Jh.deflate(n,o),i===WJ)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),i=Jh.deflateEnd(this.strm),this.onEnd(i),this.ended=!0,i===xm;if(n.avail_out!==0){if(o>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(n.avail_in===0)break}else this.onData(n.output)}return!0},Vm.prototype.onData=function(e){this.chunks.push(e)},Vm.prototype.onEnd=function(e){e===xm&&(this.result=Um.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var zJ={deflate:RU,deflateRaw:function(e,t){return(t=t||{}).raw=!0,RU(e,t)}};const Fm=16209;var qJ=function(e,t){let n,r,i,o,s,c,l,u,h,f,_,E,I,v,R,A,O,P,M,U,L,V,H,q;const de=e.state;n=e.next_in,H=e.input,r=n+(e.avail_in-5),i=e.next_out,q=e.output,o=i-(t-e.avail_out),s=i+(e.avail_out-257),c=de.dmax,l=de.wsize,u=de.whave,h=de.wnext,f=de.window,_=de.hold,E=de.bits,I=de.lencode,v=de.distcode,R=(1<<de.lenbits)-1,A=(1<<de.distbits)-1;e:do{E<15&&(_+=H[n++]<<E,E+=8,_+=H[n++]<<E,E+=8),O=I[_&R];t:for(;;){if(P=O>>>24,_>>>=P,E-=P,P=O>>>16&255,P===0)q[i++]=65535&O;else{if(!(16&P)){if(!(64&P)){O=I[(65535&O)+(_&(1<<P)-1)];continue t}if(32&P){de.mode=16191;break e}e.msg="invalid literal/length code",de.mode=Fm;break e}M=65535&O,P&=15,P&&(E<P&&(_+=H[n++]<<E,E+=8),M+=_&(1<<P)-1,_>>>=P,E-=P),E<15&&(_+=H[n++]<<E,E+=8,_+=H[n++]<<E,E+=8),O=v[_&A];n:for(;;){if(P=O>>>24,_>>>=P,E-=P,P=O>>>16&255,!(16&P)){if(!(64&P)){O=v[(65535&O)+(_&(1<<P)-1)];continue n}e.msg="invalid distance code",de.mode=Fm;break e}if(U=65535&O,P&=15,E<P&&(_+=H[n++]<<E,E+=8,E<P&&(_+=H[n++]<<E,E+=8)),U+=_&(1<<P)-1,U>c){e.msg="invalid distance too far back",de.mode=Fm;break e}if(_>>>=P,E-=P,P=i-o,U>P){if(P=U-P,P>u&&de.sane){e.msg="invalid distance too far back",de.mode=Fm;break e}if(L=0,V=f,h===0){if(L+=l-P,P<M){M-=P;do q[i++]=f[L++];while(--P);L=i-U,V=q}}else if(h<P){if(L+=l+h-P,P-=h,P<M){M-=P;do q[i++]=f[L++];while(--P);if(L=0,h<M){P=h,M-=P;do q[i++]=f[L++];while(--P);L=i-U,V=q}}}else if(L+=h-P,P<M){M-=P;do q[i++]=f[L++];while(--P);L=i-U,V=q}for(;M>2;)q[i++]=V[L++],q[i++]=V[L++],q[i++]=V[L++],M-=3;M&&(q[i++]=V[L++],M>1&&(q[i++]=V[L++]))}else{L=i-U;do q[i++]=q[L++],q[i++]=q[L++],q[i++]=q[L++],M-=3;while(M>2);M&&(q[i++]=q[L++],M>1&&(q[i++]=q[L++]))}break}}break}}while(n<r&&i<s);M=E>>3,n-=M,E-=M<<3,_&=(1<<E)-1,e.next_in=n,e.next_out=i,e.avail_in=n<r?r-n+5:5-(n-r),e.avail_out=i<s?s-i+257:257-(i-s),de.hold=_,de.bits=E};const Bm=15,XJ=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),JJ=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),QJ=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),ZJ=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var $h=(e,t,n,r,i,o,s,c)=>{const l=c.bits;let u,h,f,_,E,I,v=0,R=0,A=0,O=0,P=0,M=0,U=0,L=0,V=0,H=0,q=null;const de=new Uint16Array(16),Ne=new Uint16Array(16);let Ae,Ge,xe,ct=null;for(v=0;v<=Bm;v++)de[v]=0;for(R=0;R<r;R++)de[t[n+R]]++;for(P=l,O=Bm;O>=1&&de[O]===0;O--);if(P>O&&(P=O),O===0)return i[o++]=20971520,i[o++]=20971520,c.bits=1,0;for(A=1;A<O&&de[A]===0;A++);for(P<A&&(P=A),L=1,v=1;v<=Bm;v++)if(L<<=1,L-=de[v],L<0)return-1;if(L>0&&(e===0||O!==1))return-1;for(Ne[1]=0,v=1;v<Bm;v++)Ne[v+1]=Ne[v]+de[v];for(R=0;R<r;R++)t[n+R]!==0&&(s[Ne[t[n+R]]++]=R);if(e===0?(q=ct=s,I=20):e===1?(q=XJ,ct=JJ,I=257):(q=QJ,ct=ZJ,I=0),H=0,R=0,v=A,E=o,M=P,U=0,f=-1,V=1<<P,_=V-1,e===1&&V>852||e===2&&V>592)return 1;for(;;){Ae=v-U,s[R]+1<I?(Ge=0,xe=s[R]):s[R]>=I?(Ge=ct[s[R]-I],xe=q[s[R]-I]):(Ge=96,xe=0),u=1<<v-U,h=1<<M,A=h;do h-=u,i[E+(H>>U)+h]=Ae<<24|Ge<<16|xe|0;while(h!==0);for(u=1<<v-1;H&u;)u>>=1;if(u!==0?(H&=u-1,H+=u):H=0,R++,--de[v]==0){if(v===O)break;v=t[n+s[R]]}if(v>P&&(H&_)!==f){for(U===0&&(U=P),E+=A,M=v-U,L=1<<M;M+U<O&&(L-=de[M+U],!(L<=0));)M++,L<<=1;if(V+=1<<M,e===1&&V>852||e===2&&V>592)return 1;f=H&_,i[f]=P<<24|M<<16|E-o|0}}return H!==0&&(i[E+H]=v-U<<24|64<<16|0),c.bits=P,0};const{Z_FINISH:yU,Z_BLOCK:$J,Z_TREES:jm,Z_OK:nd,Z_STREAM_END:eQ,Z_NEED_DICT:tQ,Z_STREAM_ERROR:Eo,Z_DATA_ERROR:CU,Z_MEM_ERROR:IU,Z_BUF_ERROR:nQ,Z_DEFLATED:wU}=Lm,Gm=16180,Wm=16190,zs=16191,by=16192,Oy=16194,Hm=16199,Km=16200,Ny=16206,xn=16209,AU=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function rQ(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const rd=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<Gm||t.mode>16211?1:0},bU=e=>{if(rd(e))return Eo;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=Gm,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,nd},OU=e=>{if(rd(e))return Eo;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,bU(e)},NU=(e,t)=>{let n;if(rd(e))return Eo;const r=e.state;return t<0?(n=0,t=-t):(n=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?Eo:(r.window!==null&&r.wbits!==t&&(r.window=null),r.wrap=n,r.wbits=t,OU(e))},DU=(e,t)=>{if(!e)return Eo;const n=new rQ;e.state=n,n.strm=e,n.window=null,n.mode=Gm;const r=NU(e,t);return r!==nd&&(e.state=null),r};let Dy,Py,PU=!0;const iQ=e=>{if(PU){Dy=new Int32Array(512),Py=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for($h(1,e.lens,0,288,Dy,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;$h(2,e.lens,0,32,Py,0,e.work,{bits:5}),PU=!1}e.lencode=Dy,e.lenbits=9,e.distcode=Py,e.distbits=5},LU=(e,t,n,r)=>{let i;const o=e.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),r>=o.wsize?(o.window.set(t.subarray(n-o.wsize,n),0),o.wnext=0,o.whave=o.wsize):(i=o.wsize-o.wnext,i>r&&(i=r),o.window.set(t.subarray(n-r,n-r+i),o.wnext),(r-=i)?(o.window.set(t.subarray(n-r,n),0),o.wnext=r,o.whave=o.wsize):(o.wnext+=i,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=i))),0};var oQ=(e,t)=>{let n,r,i,o,s,c,l,u,h,f,_,E,I,v,R,A,O,P,M,U,L,V,H=0;const q=new Uint8Array(4);let de,Ne;const Ae=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(rd(e)||!e.output||!e.input&&e.avail_in!==0)return Eo;n=e.state,n.mode===zs&&(n.mode=by),s=e.next_out,i=e.output,l=e.avail_out,o=e.next_in,r=e.input,c=e.avail_in,u=n.hold,h=n.bits,f=c,_=l,V=nd;e:for(;;)switch(n.mode){case Gm:if(n.wrap===0){n.mode=by;break}for(;h<16;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if(2&n.wrap&&u===35615){n.wbits===0&&(n.wbits=15),n.check=0,q[0]=255&u,q[1]=u>>>8&255,n.check=Rr(n.check,q,2,0),u=0,h=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&u)<<8)+(u>>8))%31){e.msg="incorrect header check",n.mode=xn;break}if((15&u)!==wU){e.msg="unknown compression method",n.mode=xn;break}if(u>>>=4,h-=4,L=8+(15&u),n.wbits===0&&(n.wbits=L),L>15||L>n.wbits){e.msg="invalid window size",n.mode=xn;break}n.dmax=1<<n.wbits,n.flags=0,e.adler=n.check=1,n.mode=512&u?16189:zs,u=0,h=0;break;case 16181:for(;h<16;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if(n.flags=u,(255&ur(n))!==wU){e.msg="unknown compression method",n.mode=xn;break}if(57344&ur(n)){e.msg="unknown header flags set",n.mode=xn;break}n.head&&(n.head.text=u>>8&1),512&ur(n)&&4&n.wrap&&(q[0]=255&u,q[1]=u>>>8&255,n.check=Rr(n.check,q,2,0)),u=0,h=0,n.mode=16182;case 16182:for(;h<32;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}n.head&&(n.head.time=u),512&ur(n)&&4&n.wrap&&(q[0]=255&u,q[1]=u>>>8&255,q[2]=u>>>16&255,q[3]=u>>>24&255,n.check=Rr(n.check,q,4,0)),u=0,h=0,n.mode=16183;case 16183:for(;h<16;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}n.head&&(n.head.xflags=255&u,n.head.os=u>>8),512&ur(n)&&4&n.wrap&&(q[0]=255&u,q[1]=u>>>8&255,n.check=Rr(n.check,q,2,0)),u=0,h=0,n.mode=16184;case 16184:if(1024&ur(n)){for(;h<16;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}n.length=u,n.head&&(n.head.extra_len=u),512&ur(n)&&4&n.wrap&&(q[0]=255&u,q[1]=u>>>8&255,n.check=Rr(n.check,q,2,0)),u=0,h=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&ur(n)&&(E=n.length,E>c&&(E=c),E&&(n.head&&(L=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(r.subarray(o,o+E),L)),512&ur(n)&&4&n.wrap&&(n.check=Rr(n.check,r,E,o)),c-=E,o+=E,n.length-=E),n.length))break e;n.length=0,n.mode=16186;case 16186:if(2048&ur(n)){if(c===0)break e;E=0;do L=r[o+E++],n.head&&L&&n.length<65536&&(n.head.name+=String.fromCharCode(L));while(L&&E<c);if(512&ur(n)&&4&n.wrap&&(n.check=Rr(n.check,r,E,o)),c-=E,o+=E,L)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&ur(n)){if(c===0)break e;E=0;do L=r[o+E++],n.head&&L&&n.length<65536&&(n.head.comment+=String.fromCharCode(L));while(L&&E<c);if(512&ur(n)&&4&n.wrap&&(n.check=Rr(n.check,r,E,o)),c-=E,o+=E,L)break e}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&ur(n)){for(;h<16;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if(4&n.wrap&&u!==(65535&n.check)){e.msg="header crc mismatch",n.mode=xn;break}u=0,h=0}n.head&&(n.head.hcrc=ur(n)>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=zs;break;case 16189:for(;h<32;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}e.adler=n.check=AU(u),u=0,h=0,n.mode=Wm;case Wm:if(n.havedict===0)return e.next_out=s,e.avail_out=l,e.next_in=o,e.avail_in=c,n.hold=u,n.bits=h,tQ;e.adler=n.check=1,n.mode=zs;case zs:if(t===$J||t===jm)break e;case by:if(n.last){u>>>=7&h,h-=7&h,n.mode=Ny;break}for(;h<3;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}switch(n.last=1&u,u>>>=1,h-=1,3&u){case 0:n.mode=16193;break;case 1:if(iQ(n),n.mode=Hm,t===jm){u>>>=2,h-=2;break e}break;case 2:n.mode=16196;break;case 3:e.msg="invalid block type",n.mode=xn}u>>>=2,h-=2;break;case 16193:for(u>>>=7&h,h-=7&h;h<32;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if((65535&u)!=(u>>>16^65535)){e.msg="invalid stored block lengths",n.mode=xn;break}if(n.length=65535&u,u=0,h=0,n.mode=Oy,t===jm)break e;case Oy:n.mode=16195;case 16195:if(E=n.length,E){if(E>c&&(E=c),E>l&&(E=l),E===0)break e;i.set(r.subarray(o,o+E),s),c-=E,o+=E,l-=E,s+=E,n.length-=E;break}n.mode=zs;break;case 16196:for(;h<14;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if(n.nlen=257+(31&u),u>>>=5,h-=5,n.ndist=1+(31&u),u>>>=5,h-=5,n.ncode=4+(15&u),u>>>=4,h-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=xn;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;h<3;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}n.lens[Ae[n.have++]]=7&u,u>>>=3,h-=3}for(;n.have<19;)n.lens[Ae[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,de={bits:n.lenbits},V=$h(0,n.lens,0,19,n.lencode,0,n.work,de),n.lenbits=de.bits,V){e.msg="invalid code lengths set",n.mode=xn;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;H=n.lencode[u&(1<<n.lenbits)-1],R=H>>>24,A=H>>>16&255,O=65535&H,!(R<=h);){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if(O<16)u>>>=R,h-=R,n.lens[n.have++]=O;else{if(O===16){for(Ne=R+2;h<Ne;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if(u>>>=R,h-=R,n.have===0){e.msg="invalid bit length repeat",n.mode=xn;break}L=n.lens[n.have-1],E=3+(3&u),u>>>=2,h-=2}else if(O===17){for(Ne=R+3;h<Ne;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}u>>>=R,h-=R,L=0,E=3+(7&u),u>>>=3,h-=3}else{for(Ne=R+7;h<Ne;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}u>>>=R,h-=R,L=0,E=11+(127&u),u>>>=7,h-=7}if(n.have+E>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=xn;break}for(;E--;)n.lens[n.have++]=L}}if(n.mode===xn)break;if(n.lens[256]===0){e.msg="invalid code -- missing end-of-block",n.mode=xn;break}if(n.lenbits=9,de={bits:n.lenbits},V=$h(1,n.lens,0,n.nlen,n.lencode,0,n.work,de),n.lenbits=de.bits,V){e.msg="invalid literal/lengths set",n.mode=xn;break}if(n.distbits=6,n.distcode=n.distdyn,de={bits:n.distbits},V=$h(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,de),n.distbits=de.bits,V){e.msg="invalid distances set",n.mode=xn;break}if(n.mode=Hm,t===jm)break e;case Hm:n.mode=Km;case Km:if(c>=6&&l>=258){e.next_out=s,e.avail_out=l,e.next_in=o,e.avail_in=c,n.hold=u,n.bits=h,qJ(e,_),s=e.next_out,i=e.output,l=e.avail_out,o=e.next_in,r=e.input,c=e.avail_in,u=n.hold,h=n.bits,n.mode===zs&&(n.back=-1);break}for(n.back=0;H=n.lencode[u&(1<<n.lenbits)-1],R=H>>>24,A=H>>>16&255,O=65535&H,!(R<=h);){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if(A&&!(240&A)){for(P=R,M=A,U=O;H=n.lencode[U+((u&(1<<P+M)-1)>>P)],R=H>>>24,A=H>>>16&255,O=65535&H,!(P+R<=h);){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}u>>>=P,h-=P,n.back+=P}if(u>>>=R,h-=R,n.back+=R,n.length=O,A===0){n.mode=16205;break}if(32&A){n.back=-1,n.mode=zs;break}if(64&A){e.msg="invalid literal/length code",n.mode=xn;break}n.extra=15&A,n.mode=16201;case 16201:if(n.extra){for(Ne=n.extra;h<Ne;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}n.length+=u&(1<<n.extra)-1,u>>>=n.extra,h-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;H=n.distcode[u&(1<<n.distbits)-1],R=H>>>24,A=H>>>16&255,O=65535&H,!(R<=h);){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if(!(240&A)){for(P=R,M=A,U=O;H=n.distcode[U+((u&(1<<P+M)-1)>>P)],R=H>>>24,A=H>>>16&255,O=65535&H,!(P+R<=h);){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}u>>>=P,h-=P,n.back+=P}if(u>>>=R,h-=R,n.back+=R,64&A){e.msg="invalid distance code",n.mode=xn;break}n.offset=O,n.extra=15&A,n.mode=16203;case 16203:if(n.extra){for(Ne=n.extra;h<Ne;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}n.offset+=u&(1<<n.extra)-1,u>>>=n.extra,h-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=xn;break}n.mode=16204;case 16204:if(l===0)break e;if(E=_-l,n.offset>E){if(E=n.offset-E,E>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=xn;break}E>n.wnext?(E-=n.wnext,I=n.wsize-E):I=n.wnext-E,E>n.length&&(E=n.length),v=n.window}else v=i,I=s-n.offset,E=n.length;E>l&&(E=l),l-=E,n.length-=E;do i[s++]=v[I++];while(--E);n.length===0&&(n.mode=Km);break;case 16205:if(l===0)break e;i[s++]=n.length,l--,n.mode=Km;break;case Ny:if(n.wrap){for(;h<32;){if(c===0)break e;c--,u|=r[o++]<<h,h+=8}if(_-=l,e.total_out+=_,n.total+=_,4&n.wrap&&_&&(e.adler=n.check=ur(n)?Rr(n.check,i,_,s-_):Kh(n.check,i,_,s-_)),_=l,4&n.wrap&&(ur(n)?u:AU(u))!==n.check){e.msg="incorrect data check",n.mode=xn;break}u=0,h=0}n.mode=16207;case 16207:if(n.wrap&&ur(n)){for(;h<32;){if(c===0)break e;c--,u+=r[o++]<<h,h+=8}if(4&n.wrap&&u!==(4294967295&n.total)){e.msg="incorrect length check",n.mode=xn;break}u=0,h=0}n.mode=16208;case 16208:V=eQ;break e;case xn:V=CU;break e;case 16210:return IU;default:return Eo}return e.next_out=s,e.avail_out=l,e.next_in=o,e.avail_in=c,n.hold=u,n.bits=h,(n.wsize||_!==e.avail_out&&n.mode<xn&&(n.mode<Ny||t!==yU))&&LU(e,e.output,e.next_out,_-e.avail_out),f-=e.avail_in,_-=e.avail_out,e.total_in+=f,e.total_out+=_,n.total+=_,4&n.wrap&&_&&(e.adler=n.check=ur(n)?Rr(n.check,i,_,e.next_out-_):Kh(n.check,i,_,e.next_out-_)),e.data_type=n.bits+(n.last?64:0)+(n.mode===zs?128:0)+(n.mode===Hm||n.mode===Oy?256:0),(f===0&&_===0||t===yU)&&V===nd&&(V=nQ),V},qs={inflateReset:OU,inflateReset2:NU,inflateResetKeep:bU,inflateInit:e=>DU(e,15),inflateInit2:DU,inflate:oQ,inflateEnd:e=>{if(rd(e))return Eo;let t=e.state;return t.window&&(t.window=null),e.state=null,nd},inflateGetHeader:(e,t)=>{if(rd(e))return Eo;const n=e.state;return 2&n.wrap?(n.head=t,t.done=!1,nd):Eo},inflateSetDictionary:(e,t)=>{const n=t.length;let r,i,o;return rd(e)?Eo:(r=e.state,r.wrap!==0&&r.mode!==Wm?Eo:r.mode===Wm&&(i=1,i=Kh(i,t,n,0),i!==r.check)?CU:(o=LU(e,t,n,n),o?(r.mode=16210,IU):(r.havedict=1,nd)))},inflateInfo:"pako inflate (from Nodeca project)"},sQ=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const kU=Object.prototype.toString,{Z_NO_FLUSH:aQ,Z_FINISH:cQ,Z_OK:ep,Z_STREAM_END:Ly,Z_NEED_DICT:ky,Z_STREAM_ERROR:dQ,Z_DATA_ERROR:MU,Z_MEM_ERROR:lQ}=Lm;function Ym(e){this.options=Um.assign({chunkSize:65536,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new TU,this.strm.avail_out=0;let n=qs.inflateInit2(this.strm,t.windowBits);if(n!==ep)throw new Error(Zc[n]);if(this.header=new sQ,qs.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=Zh.string2buf(t.dictionary):kU.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(n=qs.inflateSetDictionary(this.strm,t.dictionary),n!==ep)))throw new Error(Zc[n])}function UU(e,t){const n=new Ym(t);if(n.push(e),n.err)throw n.msg||Zc[n.err];return n.result}Ym.prototype.push=function(e,t){const n=this.strm,r=this.options.chunkSize,i=this.options.dictionary;let o,s,c;if(this.ended)return!1;for(s=t===~~t?t:t===!0?cQ:aQ,kU.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(r),n.next_out=0,n.avail_out=r),o=qs.inflate(n,s),o===ky&&i&&(o=qs.inflateSetDictionary(n,i),o===ep?o=qs.inflate(n,s):o===MU&&(o=ky));n.avail_in>0&&o===Ly&&n.state.wrap>0&&e[n.next_in]!==0;)qs.inflateReset(n),o=qs.inflate(n,s);switch(o){case dQ:case MU:case ky:case lQ:return this.onEnd(o),this.ended=!0,!1}if(c=n.avail_out,n.next_out&&(n.avail_out===0||o===Ly))if(this.options.to==="string"){let l=Zh.utf8border(n.output,n.next_out),u=n.next_out-l,h=Zh.buf2string(n.output,l);n.next_out=u,n.avail_out=r-u,u&&n.output.set(n.output.subarray(l,l+u),0),this.onData(h)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(o!==ep||c!==0){if(o===Ly)return o=qs.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(n.avail_in===0)break}}return!0},Ym.prototype.onData=function(e){this.chunks.push(e)},Ym.prototype.onEnd=function(e){e===ep&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Um.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var uQ={inflate:UU,inflateRaw:function(e,t){return(t=t||{}).raw=!0,UU(e,t)}};const{deflate:hQ,deflateRaw:pQ}=zJ,{inflate:fQ,inflateRaw:_Q}=uQ;var mQ=hQ,EQ=pQ,gQ=fQ,SQ=_Q,xU=function(e){return e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE",e}(xU||{});class TQ{constructor(){y(this,"_sequence",0),y(this,"_startTime",Date.now()),y(this,"isUseOneByte",!0)}get startTime(){const t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){const n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){const c=new Uint8Array(4);c.set([1,0,0,0]);const l={id:0,length:4,data:c.buffer},u={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[l]};n.commonPacketHeader.extension=1,n.extension=u,n.payload=this.compress(t),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;w("SHOW_DATASTREAM2_LOG")&&g.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));const r=new ArrayBuffer(n.commonPacketHeader.length),i=new Uint8Array(r),o=new DataView(r);let s=0;if(o.setUint16(s,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),s+=2,o.setUint32(s,n.commonPacketHeader.sequence,!0),s+=4,o.setUint16(s,n.commonStreamHeader,!0),s+=2,n.extension){const c=this.serializeExtension(n.extension);i.set(new Uint8Array(c),s),s+=c.byteLength}if(i.set(new Uint8Array(n.payload),s),s+=n.payload.byteLength,s!==n.commonPacketHeader.length)throw Error("serialize error!");return r}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);const n=new DataView(t);let r=0;const i=n.getUint16(r,!0);r+=2;const o={length:16383&i,reserved:(16384&i)>>14,extension:(32768&i)>>15,sequence:n.getUint16(r+2,!0)<<16|n.getUint16(r,!0)};let s,c;if(r+=4,w("SHOW_DATASTREAM2_LOG")&&g.debug("receive data header: ".concat(JSON.stringify(o))),n.getUint16(r,!0),r+=2,o.extension){c=this.deserializeExtension(t.slice(r)),r+=2+c.length,s=t.slice(r);let l=!1;if(c.datas.length>0){const u=c.datas.find(h=>h.id===0);u&&(l=(1&new DataView(u.data).getUint32(0,!0))==1)}s=l?this.decompress(s):s}else s=t.slice(8);return s}serializeExtension(t){const{profile:n,length:r,datas:i}=t,o=new ArrayBuffer(r+2),s=new Uint8Array(o),c=new DataView(o);let l=0;if(c.setUint8(l++,n),c.setUint8(l++,r),i.forEach(u=>{n?(c.setUint8(l++,u.id),c.setUint8(l++,u.length),s.set(new Uint8Array(u.data),l),l+=u.data.byteLength):(c.setUint8(l++,u.id|u.length<<4),s.set(new Uint8Array(u.data),l),l+=u.data.byteLength)}),l!==r+2)throw Error("serialize extension error, is ".concat(l,"!==").concat(r+2));return o}deserializeExtension(t){const n=new DataView(t);let r=0;const i=n.getUint8(r);r++;const o=n.getUint8(r);r++;const s=i===xU.TWO_BYTE,c=[],l=new DataView(t,2);let u=0;for(;u<o;){let h=0,f=0,_=new ArrayBuffer(0);s?(h=l.getUint8(u),u++,f=l.getUint8(u),u++):(h=15&l.getUint8(u),f=l.getUint8(u)>>4,u++),f>0&&(_=l.buffer.slice(u+2,u+2+f),u+=_.byteLength),c.push({id:h,length:f,data:_})}if(u!==o)throw Error("parse error");return{profile:i,length:o,datas:c}}decompress(t){return gQ(new Uint8Array(t))}compress(t){return mQ(new Uint8Array(t))}}const vQ={name:"DataStream",create:(e,t)=>{const n=t?new Iq(e):new wq(e);return n.useDataStream(new TQ),n}};class RQ extends Wt{constructor(t,n,r){super(),y(this,"ws",void 0),y(this,"requestId",1),y(this,"heartBeatTimer",void 0),y(this,"joinInfo",void 0),y(this,"clientId",void 0),y(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),y(this,"onClose",i=>{this.emit("close"),this.dispose()}),y(this,"onMessage",i=>{const o=JSON.parse(i.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)}),this.joinInfo=t,this.clientId=n,this.ws=new Ch("cross-channel-".concat(this.clientId),r),this.ws.on(Fe.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(Fe.CONNECTED,this.onOpen),this.ws.on(Fe.ON_MESSAGE,this.onMessage),this.ws.on(Fe.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){const n=this.requestId++;return t.requestId=n,t.seq=n,this.ws.sendMessage(t),n}waitStatus(t){return new se((n,r)=>{const i=window.setTimeout(()=>{r(new B(b.TIMEOUT,"wait status timeout, status: ".concat(t)))},5e3);this.once(t,o=>{window.clearTimeout(i),o.state&&o.state!==0?r(new B(b.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):n(void 0)}),this.once("dispose",()=>{window.clearTimeout(i),r(new B(b.WS_ABORT))})})}async request(t){if(this.ws.state==="closed")throw new B(b.WS_DISCONNECT);const n=()=>new se((s,c)=>{this.ws.once(Fe.CLOSED,()=>c(new B(b.WS_ABORT))),this.ws.once(Fe.CONNECTED,s)});this.ws.state!=="connected"&&await n();const r=this.sendMessage(t),i=new se((s,c)=>{const l=()=>{c(new B(b.WS_ABORT))};this.ws.once(Fe.RECONNECTING,l),this.ws.once(Fe.CLOSED,l),this.once("req_".concat(r),s),In(3e3).then(()=>{this.removeAllListeners("req_".concat(r)),this.ws.off(Fe.RECONNECTING,l),this.ws.off(Fe.CLOSED,l),c(new B(b.TIMEOUT,"cross channel ws request timeout"))})}),o=await i;if(!o||o.code!==200)throw new B(b.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o}async connect(t){this.ws.removeAllListeners(Fe.REQUEST_NEW_URLS),this.ws.on(Fe.REQUEST_NEW_URLS,n=>{n(t)}),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const n=this.requestId++;return t.requestId=n,this.ws.sendMessage(t),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class yQ extends Wt{set state(t){t!==this._state&&(t!==Gr.RELAY_STATE_FAILURE&&(this.errorCode=yl.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,n,r,i,o){super(),y(this,"joinInfo",void 0),y(this,"sid",void 0),y(this,"clientId",void 0),y(this,"cancelToken",br.CancelToken.source()),y(this,"workerToken",void 0),y(this,"requestId",0),y(this,"signal",void 0),y(this,"prevChannelMediaConfig",void 0),y(this,"httpRetryConfig",void 0),y(this,"_resolution",void 0),y(this,"_state",Gr.RELAY_STATE_IDLE),y(this,"errorCode",yl.RELAY_OK),y(this,"onStatus",s=>{g.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(s))),s&&s.command&&(s.command==="onAudioPacketReceived"&&this.emit("event",Ws.PACKET_RECEIVED_AUDIO_FROM_SRC),s.command==="onVideoPacketReceived"&&this.emit("event",Ws.PACKET_RECEIVED_VIDEO_FROM_SRC),s.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=yl.SRC_TOKEN_EXPIRED,this.state=Gr.RELAY_STATE_FAILURE),s.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=yl.DEST_TOKEN_EXPIRED,this.state=Gr.RELAY_STATE_FAILURE))}),y(this,"onReconnect",async()=>{g.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Ws.NETWORK_DISCONNECTED),this.state=Gr.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(s=>{this.state!==Gr.RELAY_STATE_IDLE&&(g.error("auto restart channel media relay failed",s.toString()),this.errorCode=yl.SERVER_CONNECTION_LOST,this.state=Gr.RELAY_STATE_FAILURE)})}),this.joinInfo=t,this.clientId=n,this.sid=Lc(),this.signal=new RQ(this.joinInfo,this.clientId,r),this.httpRetryConfig=i,this._resolution=o}async startChannelMediaRelay(t){if(this.state!==Gr.RELAY_STATE_IDLE)throw new B(b.INVALID_OPERATION);this.state=Gr.RELAY_STATE_CONNECTING,await this.connect(),g.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new B(b.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new B(b.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new B(b.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==Gr.RELAY_STATE_RUNNING)throw new B(b.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==Gr.RELAY_STATE_RUNNING)throw new B(b.INVALID_OPERATION);const n=this.genMessage(Dr.SetVideoProfile);await this.signal.request(n),g.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),g.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=Gr.RELAY_STATE_IDLE,this.dispose()}dispose(){g.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=br.CancelToken.source(),this.state=Gr.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await NX(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",Ws.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const n=this.genMessage(Dr.SetSdkProfile,t);await this.signal.request(n),g.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const r=this.genMessage(Dr.SetSourceChannel,t);await this.signal.request(r),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Ws.PACKET_JOINED_SRC_CHANNEL),g.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const i=this.genMessage(Dr.SetSourceUserId,t);await this.signal.request(i),g.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const o=this.genMessage(Dr.SetDestChannel,t);await this.signal.request(o),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Ws.PACKET_JOINED_DEST_CHANNEL),g.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const s=this.genMessage(Dr.StartPacketTransfer,t);await this.signal.request(s),this.emit("event",Ws.PACKET_SENT_TO_DEST_CHANNEL),this.state=Gr.RELAY_STATE_RUNNING,g.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const n=this.genMessage(Dr.UpdateDestChannel,t);await this.signal.request(n),this.emit("event",Ws.PACKET_UPDATE_DEST_CHANNEL),g.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(Dr.StopPacketTransfer);await this.signal.request(t),g.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,n){const r=[],i=[],o=[];this.requestId+=1;const s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:Li,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};s.sdkVersion==="4.24.2"&&(s.sdkVersion="0.0.1");let c=null,l=null;switch(t){case Dr.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case Dr.SetSourceChannel:if(l=n&&n.getSrcChannelMediaInfo(),!l)throw new B(b.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:l.channelName,token:l.token||this.joinInfo.appId},s;case Dr.SetSourceUserId:if(l=n&&n.getSrcChannelMediaInfo(),!l)throw new B(b.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:l.uid+""},s;case Dr.SetDestChannel:if(c=n&&n.getDestChannelMediaInfo(),!c)throw new B(b.UNEXPECTED_ERROR,"can not find dest config");return c.forEach(u=>{r.push(u.channelName),i.push(u.uid+""),o.push(u.token||this.joinInfo.appId)}),s.clientRequest={command:"SetDestChannel",channelName:r,uid:i,token:o},s;case Dr.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case Dr.Reconnect:return s.clientRequest={command:"Reconnect"},s;case Dr.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case Dr.UpdateDestChannel:if(c=n&&n.getDestChannelMediaInfo(),!c)throw new B(b.UNEXPECTED_ERROR,"can not find dest config");return c.forEach(u=>{r.push(u.channelName),i.push(u.uid+""),o.push(u.token||this.joinInfo.appId)}),s.clientRequest={command:"UpdateDestChannel",channelName:r,uid:i,token:o},s;case Dr.SetVideoProfile:s.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return s}}const CQ={name:"ChannelMediaRelay",create:function(e){return new yQ(e.joinInfo,e.clientId,e.websocketRetryConfig||an,e.httpRetryConfig||an,e.resolution)}};function VU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function tp(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?VU(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):VU(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}class IQ extends Wt{constructor(t,n,r,i){super(),y(this,"spec",void 0),y(this,"token",void 0),y(this,"websocket",void 0),y(this,"pingpongTimer",void 0),y(this,"reconnectMode","retry"),y(this,"serviceMode",void 0),y(this,"reqId",0),y(this,"commandReqId",0),y(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),y(this,"handleWebSocketMessage",o=>{if(!o.data)return;const s=JSON.parse(o.data);s.requestId?this.emit("@".concat(s.requestId,"-").concat(s.sid),s):(pe.workerEvent(this.spec.sid,{actionType:"status",serverCode:s.code,workerType:this.serviceMode===Gs.TRANSCODE?1:2}),this.emit(Ca.PUBLISH_STREAM_STATUS,s))}),this.spec=n,this.token=t,this.serviceMode=i,this.websocket=new Ch("live-streaming",r),this.websocket.on(Fe.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Fe.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Fe.REQUEST_NEW_URLS,(o,s)=>{hn(this,Ca.REQUEST_NEW_ADDRESS).then(o).catch(s)}),this.websocket.on(Fe.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(t){return this.websocket.init(t)}async request(t,n,r,i){this.reqId+=1,t==="request"&&(this.commandReqId+=1);const o=this.commandReqId,s=this.reqId;if(!s||!this.websocket)throw new B(b.UNEXPECTED_ERROR);const c=tp({command:t,sdkVersion:Li==="4.24.2"?"0.0.1":Li,seq:s,requestId:s,allocate:r,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new B(b.WS_DISCONNECT);const l=()=>new se((_,E)=>{this.websocket.once(Fe.CLOSED,()=>E(new B(b.WS_ABORT))),this.websocket.once(Fe.CONNECTED,_)});this.websocket.state!=="connected"&&await l(),c.clientRequest&&(c.clientRequest.workerToken=this.token);const u=new se((_,E)=>{const I=()=>{E(new B(b.WS_ABORT))};this.websocket.once(Fe.RECONNECTING,I),this.websocket.once(Fe.CLOSED,I),this.once("@".concat(s,"-").concat(this.spec.sid),v=>{_(v)})});i&&pe.workerEvent(this.spec.sid,tp(tp({},i),{},{requestId:o,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));const h=Date.now();this.websocket.sendMessage(c);let f=null;try{f=await u}catch(_){if(this.websocket.state==="closed")throw _;return await l(),await this.request(t,n,r)}return i&&pe.workerEvent(this.spec.sid,tp(tp({},i),{},{requestId:o,actionType:"response",payload:JSON.stringify(f.serverResponse),serverCode:f.code,success:f.code===200,responseTime:Date.now()-h})),f.code!==200&&this.handleResponseError(f),f}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t=Li==="4.24.2"?"0.0.1":Li;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case En.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void g.warning("live stream response already exists stream");case En.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case En.LIVE_STREAM_RESPONSE_BAD_STREAM:case En.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new B(b.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case En.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream")return;throw new B(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case En.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new B(b.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case En.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const n=new B(b.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Ca.WARNING,n,t.serverResponse.url)}case En.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const n=new B(b.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Ca.WARNING,n,t.serverResponse.url)}case En.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new B(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case En.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new B(b.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case En.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const n=new B(b.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Ca.WARNING,n,t.serverResponse.url)}case En.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new B(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case En.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new B(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case En.LIVE_STREAM_RESPONSE_WORKER_LOST:case En.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream")return;throw new B(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case En.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new B(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new B(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case En.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case En.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case En.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case En.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new B(b.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(mh)},6e3)}}function FU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Hr(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?FU(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):FU(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}class wQ extends Wt{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:an,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:an;super(),y(this,"onLiveStreamWarning",void 0),y(this,"onLiveStreamError",void 0),y(this,"spec",void 0),y(this,"retryTimeout",1e4),y(this,"connection",void 0),y(this,"httpRetryConfig",void 0),y(this,"wsRetryConfig",void 0),y(this,"streamingTasks",new Map),y(this,"isStartingStreamingTask",!1),y(this,"taskMutex",new Ln("live-streaming")),y(this,"cancelToken",br.CancelToken.source()),y(this,"transcodingConfig",void 0),y(this,"uapResponse",void 0),y(this,"lastTaskId",1),y(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=r,this.wsRetryConfig=n}async setTranscodingConfig(t){const n=Hr(Hr({},dX),t);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(g.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map(s=>Hr(Hr(Hr({},cX),s),{},{zOrder:s.zOrder?s.zOrder+1:1}))),function(s){zt(s.width)||Ct(s.width,"config.width",0,1e4),zt(s.height)||Ct(s.height,"config.height",0,1e4),zt(s.videoBitrate)||Ct(s.videoBitrate,"config.videoBitrate",1,1e6),zt(s.videoFrameRate)||Ct(s.videoFrameRate,"config.videoFrameRate"),zt(s.lowLatency)||io(s.lowLatency,"config.lowLatency"),zt(s.audioSampleRate)||sn(s.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),zt(s.audioBitrate)||Ct(s.audioBitrate,"config.audioBitrate",1,128),zt(s.audioChannels)||sn(s.audioChannels,"config.audioChannels",[1,2,3,4,5]),zt(s.videoGop)||Ct(s.videoGop,"config.videoGop"),zt(s.videoCodecProfile)||sn(s.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),zt(s.userCount)||Ct(s.userCount,"config.userCount",0,17),zt(s.backgroundColor)||Ct(s.backgroundColor,"config.backgroundColor",0,16777215),zt(s.userConfigExtraInfo)||jn(s.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),s.transcodingUsers&&!zt(s.transcodingUsers)&&(Bs(s.transcodingUsers,"config.transcodingUsers"),s.transcodingUsers.forEach((c,l)=>{nm(c.uid),zt(c.x)||Ct(c.x,"transcodingUser[".concat(l,"].x"),0,1e4),zt(c.y)||Ct(c.y,"transcodingUser[".concat(l,"].y"),0,1e4),zt(c.width)||Ct(c.width,"transcodingUser[".concat(l,"].width"),0,1e4),zt(c.height)||Ct(c.height,"transcodingUser[".concat(l,"].height"),0,1e4),zt(c.zOrder)||Ct(c.zOrder-1,"transcodingUser[".concat(l,"].zOrder"),0,100),zt(c.alpha)||Ct(c.alpha,"transcodingUser[".concat(l,"].alpha"),0,1,!1)})),zt(s.watermark)||CR(s.watermark,"watermark"),zt(s.backgroundImage)||CR(s.backgroundImage,"backgroundImage"),s.images&&!zt(s.images)&&(Bs(s.images,"config.images"),s.images.forEach((c,l)=>{CR(c,"images[".concat(l,"]"))}))}(n);const r=[];n.images&&r.push(...n.images.map(s=>Hr(Hr(Hr({},yR),s),{},{zOrder:255}))),n.backgroundImage&&(r.push(Hr(Hr(Hr({},yR),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(r.push(Hr(Hr(Hr({},yR),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=r,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map(s=>Hr({},s)),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);const i=(n.userConfigs||[]).map(s=>typeof s.uid=="number"?se.resolve(s.uid):oM(s.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await se.all(i)).forEach((s,c)=>{n.userConfigs&&n.userConfigs[c]&&(n.userConfigs[c].uid=s)}),this.transcodingConfig=n,this.connection)try{var o;const s=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from($r(o=this.streamingTasks).call(o)).map(c=>c.taskId).join("#")});g.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(s.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(s){if(!s.data||!s.data.retry)throw s;s.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(c=>{g.warning("[".concat(this.spec.clientId,"] live streaming receive error"),s.toString(),"try to republish",c.url),this.startLiveStreamingTask(c.url,c.mode,s).then(()=>{g.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(c.url," success"))}).catch(l=>{g.error("[".concat(this.spec.clientId,"] live streaming republish failed"),c.url,l.toString()),this.onLiveStreamError&&this.onLiveStreamError(c.url,l)})})}}async startLiveStreamingTask(t,n,r){if(!this.transcodingConfig&&n===Gs.TRANSCODE)throw new B(b.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");const i={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};g.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(n));const o=await this.taskMutex.lock();if(!this.connection&&r)return void o();if(this.streamingTasks.get(t)&&!r)return o(),new B(b.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n))}catch(c){throw o(),c}switch(n){case Gs.TRANSCODE:i.transcodingConfig=Hr({},this.transcodingConfig)}this.uapResponse&&this.uapResponse.vid&&(i.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const s=this.lastTaskId++;try{const c=new se((u,h)=>{In(this.retryTimeout).then(()=>{if(r)return h(r);const f=this.statusError.get(t);return f?(this.statusError.delete(t),h(f)):void 0})}),l=await se.race([this.connection.request("request",{clientRequest:i},!0,{url:t,command:"PublishStream",workerType:n===Gs.TRANSCODE?1:2,requestByUser:!r,tid:s.toString()}),c]);this.isStartingStreamingTask=!1,g.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(l.code)),this.streamingTasks.set(t,{clientRequest:i,mode:n,url:t,taskId:s}),o()}catch(c){if(o(),this.isStartingStreamingTask=!1,!c.data||!c.data.retry||r)throw c;return c.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,n,c)):await this.startLiveStreamingTask(t,n,c)}}stopLiveStreamingTask(t){return new se((n,r)=>{const i=this.streamingTasks.get(t);if(!i||!this.connection)return new B(b.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=i.mode;i.abortTask=()=>{g.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),n()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:i.url}},!1,{url:t,command:"UnPublishStream",workerType:o===Gs.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(s=>{g.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(s.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),n()}).catch(r)})}resetAllTask(){var t;const n=Array.from($r(t=this.streamingTasks).call(t));this.terminate();for(const r of n)this.startLiveStreamingTask(r.url,r.mode).catch(i=>{this.onLiveStreamError&&this.onLiveStreamError(r.url,i)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=br.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new B(b.UNEXPECTED_ERROR,"live streaming connection has already connected");const n=await hn(this,IR.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=n,this.connection=new IQ(n.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(Ca.WARNING,(r,i)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(i,r)),this.connection.on(Ca.PUBLISH_STREAM_STATUS,r=>this.handlePublishStreamServer(r)),this.connection.on(Ca.REQUEST_NEW_ADDRESS,(r,i)=>{if(!this.connection)return i(new B(b.UNEXPECTED_ERROR,"can not get new live streaming address list"));hn(this,IR.REQUEST_WORKER_MANAGER_LIST,t).then(o=>{this.uapResponse=o,r(o.addressList)}).catch(i)}),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(t){const n=t.serverStatus&&t.serverStatus.url||"empty_url",r=this.streamingTasks.get(n),i=t.reason;switch(t.code){case En.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case En.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case En.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case En.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const s=new B(b.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(r)return g.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,s);if(!this.isStartingStreamingTask)return;this.statusError.set(n,s)}case En.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const s=new B(b.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,i);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,s)}case En.LIVE_STREAM_RESPONSE_WORKER_LOST:case En.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();const s=Array.from($r(o=this.streamingTasks).call(o));for(const c of s)c.abortTask?c.abortTask():(g.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",c.url),this.startLiveStreamingTask(c.url,c.mode,new B(b.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then(()=>{g.debug("[".concat(this.spec.clientId,"] republish live stream success"),c.url)}).catch(l=>{g.error(l.toString()),this.onLiveStreamError&&this.onLiveStreamError(c.url,l)}));return}}}hasUrl(t){return this.streamingTasks.has(t)}}const AQ={name:"LiveStreaming",create:function(e){return new wQ(e.joinInfo,e.websocketRetryConfig||an,e.httpRetryConfig||an)}};function bQ(e){let t=GU();return function(n,r){let i=n.appId;i!==void 0&&(St(r,10),Is(r,i));let o=n.cid;o!==void 0&&(St(r,16),St(r,o));let s=n.cname;s!==void 0&&(St(r,26),Is(r,s));let c=n.deviceId;c!==void 0&&(St(r,34),Is(r,c));let l=n.elapse;l!==void 0&&(St(r,40),xa(r,l));let u=n.fileSize;u!==void 0&&(St(r,48),xa(r,jl(u)));let h=n.height;h!==void 0&&(St(r,56),xa(r,jl(h)));let f=n.jpg;f!==void 0&&(St(r,66),St(r,f.length),function(jt,Y){let ne=Gl(jt,Y.length);jt.bytes.set(Y,ne)}(r,f));let _=n.networkType;_!==void 0&&(St(r,72),xa(r,jl(_)));let E=n.osType;E!==void 0&&(St(r,80),xa(r,jl(E)));let I=n.requestId;I!==void 0&&(St(r,90),Is(r,I));let v=n.sdkVersion;v!==void 0&&(St(r,98),Is(r,v));let R=n.sequence;R!==void 0&&(St(r,104),xa(r,jl(R)));let A=n.sid;A!==void 0&&(St(r,114),Is(r,A));let O=n.timestamp;O!==void 0&&(St(r,120),xa(r,O));let P=n.uid;P!==void 0&&(St(r,128),St(r,P));let M=n.vid;M!==void 0&&(St(r,136),St(r,M));let U=n.width;U!==void 0&&(St(r,144),xa(r,jl(U)));let L=n.service;L!==void 0&&(St(r,152),St(r,L));let V=n.callbackData;V!==void 0&&(St(r,162),Is(r,V));let H=n.jpgEncryption;H!==void 0&&(St(r,168),St(r,H));let q=n.requestType;q!==void 0&&(St(r,176),St(r,q));let de=n.scorePorn;de!==void 0&&(St(r,185),Fy(r,de));let Ne=n.scoreSexy;Ne!==void 0&&(St(r,193),Fy(r,Ne));let Ae=n.scoreNeutral;Ae!==void 0&&(St(r,201),Fy(r,Ae));let Ge=n.scene;Ge!==void 0&&(St(r,208),St(r,Ge));let xe=n.ossFilePrefix;xe!==void 0&&(St(r,218),Is(r,xe));let ct=n.serviceVendor;if(ct!==void 0)for(let jt of ct){St(r,226);let Y=GU();DQ(jt,Y),St(r,Y.limit),MQ(r,Y),kQ(Y)}}(e,t),function(n){let r=n.bytes,i=n.limit;return r.length===i?r:r.subarray(0,i)}(t)}function OQ(e){return function(n){let r={};e:for(;!WU(n);){let i=ws(n);switch(i>>>3){case 0:break e;case 1:r.code=ws(n);break;case 2:r.msg=HU(n,ws(n));break;case 3:{let o=PQ(n);r.data=NQ(n),n.limit=o;break}default:BU(n,7&i)}}return r}({bytes:t=e,offset:0,limit:t.length});var t}function NQ(e){let t={};e:for(;!WU(e);){let n=ws(e);switch(n>>>3){case 0:break e;case 1:t.requestId=HU(e,ws(e));break;case 2:t.requestType=ws(e)>>>0;break;case 3:t.scorePorn=Vy(e);break;case 4:t.scoreSexy=Vy(e);break;case 5:t.scoreNeutral=Vy(e);break;case 6:t.requestScene=ws(e)>>>0;break;case 7:t.scene=ws(e)>>>0;break;default:BU(e,7&n)}}return t}function DQ(e,t){let n=e.service;n!==void 0&&(St(t,8),St(t,n));let r=e.vendor;r!==void 0&&(St(t,16),St(t,r));let i=e.token;i!==void 0&&(St(t,26),Is(t,i));let o=e.callbackUrl;o!==void 0&&(St(t,34),Is(t,o))}function PQ(e){let t=ws(e),n=e.limit;return e.limit=e.offset+t,n}function BU(e,t){switch(t){case 0:for(;128&KU(e););break;case 2:Uy(e,ws(e));break;case 5:Uy(e,4);break;case 1:Uy(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let LQ=new Float32Array(1);new Uint8Array(LQ.buffer);let My=new Float64Array(1),Kr=new Uint8Array(My.buffer);function jl(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let jU=[];function GU(){const e=jU.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function kQ(e){jU.push(e)}function Uy(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function WU(e){return e.offset>=e.limit}function Gl(e,t){let n=e.bytes,r=e.offset,i=e.limit,o=r+t;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),e.bytes=s}return e.offset=o,o>i&&(e.limit=o),r}function xy(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function HU(e,t){let n=xy(e,t),r=String.fromCharCode,i=e.bytes,o="",s="";for(let c=0;c<t;c++){let l,u,h,f,_=i[c+n];128&_?(224&_)==192?c+1>=t?s+=o:(l=i[c+n+1],(192&l)!=128?s+=o:(f=(31&_)<<6|63&l,f<128?s+=o:(s+=r(f),c++))):(240&_)==224?c+2>=t?s+=o:(l=i[c+n+1],u=i[c+n+2],(49344&(l|u<<8))!=32896?s+=o:(f=(15&_)<<12|(63&l)<<6|63&u,f<2048||f>=55296&&f<=57343?s+=o:(s+=r(f),c+=2))):(248&_)==240?c+3>=t?s+=o:(l=i[c+n+1],u=i[c+n+2],h=i[c+n+3],(12632256&(l|u<<8|h<<16))!=8421504?s+=o:(f=(7&_)<<18|(63&l)<<12|(63&u)<<6|63&h,f<65536||f>1114111?s+=o:(f-=65536,s+=r(55296+(f>>10),56320+(1023&f)),c+=3))):s+=o:s+=r(_)}return s}function Is(e,t){let n=t.length,r=0;for(let s=0;s<n;s++){let c=t.charCodeAt(s);c>=55296&&c<=56319&&s+1<n&&(c=(c<<10)+t.charCodeAt(++s)-56613888),r+=c<128?1:c<2048?2:c<65536?3:4}St(e,r);let i=Gl(e,r),o=e.bytes;for(let s=0;s<n;s++){let c=t.charCodeAt(s);c>=55296&&c<=56319&&s+1<n&&(c=(c<<10)+t.charCodeAt(++s)-56613888),c<128?o[i++]=c:(c<2048?o[i++]=c>>6&31|192:(c<65536?o[i++]=c>>12&15|224:(o[i++]=c>>18&7|240,o[i++]=c>>12&63|128),o[i++]=c>>6&63|128),o[i++]=63&c|128)}}function MQ(e,t){let n=Gl(e,t.limit),r=e.bytes,i=t.bytes;for(let o=0,s=t.limit;o<s;o++)r[o+n]=i[o]}function KU(e){return e.bytes[xy(e,1)]}function YU(e,t){let n=Gl(e,1);e.bytes[n]=t}function Vy(e){let t=xy(e,8),n=e.bytes;return Kr[0]=n[t++],Kr[1]=n[t++],Kr[2]=n[t++],Kr[3]=n[t++],Kr[4]=n[t++],Kr[5]=n[t++],Kr[6]=n[t++],Kr[7]=n[t++],My[0]}function Fy(e,t){let n=Gl(e,8),r=e.bytes;My[0]=t,r[n++]=Kr[0],r[n++]=Kr[1],r[n++]=Kr[2],r[n++]=Kr[3],r[n++]=Kr[4],r[n++]=Kr[5],r[n++]=Kr[6],r[n++]=Kr[7]}function ws(e){let t,n=0,r=0;do t=KU(e),n<32&&(r|=(127&t)<<n),n+=7;while(128&t);return r}function St(e,t){for(t>>>=0;t>=128;)YU(e,127&t|128),t>>>=7;YU(e,t)}function xa(e,t){let n=t.low>>>0,r=(t.low>>>28|t.high<<4)>>>0,i=t.high>>>24,o=i===0?r===0?n<16384?n<128?1:2:n<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:i<128?9:10,s=Gl(e,o),c=e.bytes;switch(o){case 10:c[s+9]=i>>>7&1;case 9:c[s+8]=o!==9?128|i:127&i;case 8:c[s+7]=o!==8?r>>>21|128:r>>>21&127;case 7:c[s+6]=o!==7?r>>>14|128:r>>>14&127;case 6:c[s+5]=o!==6?r>>>7|128:r>>>7&127;case 5:c[s+4]=o!==5?128|r:127&r;case 4:c[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:c[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:c[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:c[s]=o!==1?128|n:127&n}}function zU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}const UQ=new Map([["moderation",1],["supervise",2]]);class xQ extends Wt{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const n=this._connectionState;this._connectionState=t,this.emit(Mn.CONNECTION_STATE_CHANGE,n,t)}get inspectType(){return this._inspectType}set inspectType(t){var n;this._inspectMode=Di(n=t.map(r=>UQ.get(r)||0)).call(n,(r,i)=>r+i),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(t){super(),y(this,"name","AgoraRTCVideoContentInspect"),y(this,"_connectionState",lo.CONNECTING),y(this,"_innerConnectionState",void 0),y(this,"sequence",0),y(this,"inspectStartTime",void 0),y(this,"workerManagerConnection",void 0),y(this,"workerConnection",void 0),y(this,"workerMessageLengthLimit",void 0),y(this,"inspectIntervalMinimum",void 0),y(this,"qualityRatio",void 0),y(this,"_connectInfo",void 0),y(this,"_cancelTokenSource",br.CancelToken.source()),y(this,"_retryConfig",void 0),y(this,"wmSequence",0),y(this,"inspectInterval",void 0),y(this,"inspectTimer",null),y(this,"ossFilePrefix",void 0),y(this,"extraInfo",void 0),y(this,"_inspectType",void 0),y(this,"_inspectMode",void 0),y(this,"_quality",1),y(this,"qualityTimer",null),y(this,"_inspectId",void 0),y(this,"_needWorkUrlOnly",!1),y(this,"inspectImage",()=>{if(this.connectionState!==lo.CONNECTED)throw new B(b.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===lo.CONNECTED?this.requestToInspectImage():g.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=_t(5,"inspect-"),this.workerMessageLengthLimit=w("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=w("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=w("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Ch("worker-manager-"+this._inspectId,an),this.on(Mn.STATE_CHANGE,(n,r)=>{this._innerConnectionState=n,g.debug("[".concat(this._inspectId,"] Inspect operation :").concat(uo[n]," ").concat(r||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Ch("worker-"+this._inspectId,an),this.handleWorkerEvents()}async init(t,n){this.emit(Mn.STATE_CHANGE,uo.CONNECT_AP),this._connectInfo=t;const r=this._cancelTokenSource.token;return this._retryConfig=n,new se((i,o)=>{this.on(Mn.CONNECTION_STATE_CHANGE,(s,c)=>{c===lo.CONNECTED&&i()}),this.requestAP(t,r,n).then(s=>{this.connectWorkerManager(s)}).catch(s=>{o(s)})})}async requestAP(t,n,r){const i=w("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),o=await function(c,l,u,h){let{appId:f,areaCode:_,cname:E,sid:I,token:v,uid:R}=l;Ol++;const A="image_moderation_api",O={service_name:A,json_body:JSON.stringify({appId:f,areaCode:_,cname:E,command:"allocateEdge",requestId:Ol,seq:Ol,sid:I,token:v,ts:Date.now(),uid:R+""})};let P,M,U=c[0];return Mo(async()=>{P=Date.now();const L=await jo(U,{data:O,cancelToken:u,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(M=Date.now()-P,L.code!==0){const Ae=new B(b.UNEXPECTED_RESPONSE,"image inspect ap error, code"+L.code,{retry:!0,responseTime:M});throw g.error(Ae.toString()),Ae}const V=JSON.parse(L.json_body);if(V.code!==200){const Ae=new B(b.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(V.code,", reason: ").concat(V.reason),{code:V.code,responseTime:M});throw g.error(Ae.toString()),Ae}if(!V.servers||!Array.isArray(V.servers)||V.servers.length===0){const Ae=new B(b.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:V.code,responseTime:M});throw g.error(Ae.toString()),Ae}const H=w("VIDEO_INSPECT_WORKER_MANAGER_WSS");if(H)return{addressList:[H],workerToken:V.workerToken,vid:V.vid,responseTime:M};const q=w("VIDEO_INSPECT_WORKER_MANAGER_HOST"),de=w("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:V.servers.map(Ae=>{let{address:Ge,wss:xe}=Ae;if(Ge&&xe)return"wss://".concat(Ge.replace(/\./g,"-"),".").concat(q,":").concat(de||xe)}).filter(Ae=>!!Ae),workerToken:V.workerToken,vid:V.vid,responseTime:M}},(L,V)=>(pe.apworkerEvent(I,{success:!0,sc:200,serviceName:A,responseDetail:JSON.stringify(L.addressList),firstSuccess:V===0,responseTime:M,serverIp:c[V%c.length]}),!1),(L,V)=>(pe.apworkerEvent(I,{success:!1,sc:L.data&&L.data.code||200,serviceName:A,responseTime:M,serverIp:c[V%c.length]}),!!(L.code!==b.OPERATION_ABORTED&&L.code!==b.UNEXPECTED_RESPONSE||L.data&&L.data.retry)&&(U=c[(V+1)%c.length],!0)),h)}(i,t,n,r);this.emit(Mn.STATE_CHANGE,uo.AP_CONNECTED);const{addressList:s}=o;return this.wmSequence++,s}async connectWorkerManager(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(Mn.STATE_CHANGE,uo.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Fe.CONNECTED,async()=>{this.emit(Mn.STATE_CHANGE,uo.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.24.2",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(Fe.CLOSED,()=>{this._innerConnectionState<uo.GET_WORKER_MANAGER_RESPONSE&&g.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(Fe.FAILED,()=>{this._innerConnectionState<uo.GET_WORKER_MANAGER_RESPONSE&&g.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(Fe.RECONNECTING,()=>{this._innerConnectionState<uo.GET_WORKER_MANAGER_RESPONSE&&g.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(Fe.ON_MESSAGE,async t=>{this.emit(Mn.STATE_CHANGE,uo.GET_WORKER_MANAGER_RESPONSE);const n=this.workerManagerConnection.url;this.workerManagerConnection.close();const r=JSON.parse(t.data);if(r.code!==200)throw g.error("[".concat(this._inspectId,"] Unexpected code ").concat(r.code," from worker manager")),new B(b.UNEXPECTED_RESPONSE,"response code of worker is unexpected",r);if(!(r.serverResponse&&r.serverResponse.portWss&&n))throw g.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(r))),new B(b.UNEXPECTED_RESPONSE,"response content of worker is unexpected",r);{const i=w("VIDEO_INSPECT_WORKER_PORT")||r.serverResponse.portWss,o=n.replace(/:\d+\/?$/,":".concat(i));this.emit(Mn.STATE_CHANGE,uo.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(Mn.REQUEST_NEW_WORKER_URL,o):await this.connectWorker(o)}}),this.workerManagerConnection.on(Fe.WILL_RECONNECT,(t,n,r)=>{r(t)}),this.workerManagerConnection.on(Fe.REQUEST_NEW_URLS,(t,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(n)})}handleWorkerEvents(){this.workerConnection.on(Fe.CONNECTED,async()=>{this.emit(Mn.STATE_CHANGE,uo.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=lo.CONNECTED}),this.workerConnection.on(Fe.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const r=OQ(new Uint8Array(t.data));if(w("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&g.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(r)),r.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Mn.INSPECT_RESULT,void 0,void 0);if(r.data&&r.data.scorePorn&&r.data.scoreSexy&&r.data.scoreNeutral){var n;const i={porn:r.data.scorePorn,sexy:r.data.scoreSexy,neutral:r.data.scoreNeutral},o=Di(n=Object.keys(i)).call(n,(c,l)=>i[c]>i[l]?c:l,"porn"),s=Object.keys(i).find(c=>c===o);this.emit(Mn.INSPECT_RESULT,s)}else this.emit(Mn.INSPECT_RESULT,void 0,new B(b.UNEXPECTED_RESPONSE,r.code+"","There is an unexpected data on message"))}else this.emit(Mn.INSPECT_RESULT,void 0,new B(b.UNEXPECTED_RESPONSE,r.code+"",r.msg))}else g.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Mn.INSPECT_RESULT,void 0,new B(b.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(Fe.CLOSED,()=>{this.connectionState=lo.CLOSED}),this.workerConnection.on(Fe.FAILED,()=>{this.connectionState=lo.CLOSED}),this.workerConnection.on(Fe.RECONNECTING,()=>{this.connectionState=this.connectionState===lo.CONNECTED?lo.RECONNECTING:lo.CONNECTING}),this.workerConnection.on(Fe.WILL_RECONNECT,(t,n,r)=>{t==="recover"&&r(t),r("tryNext")}),this.workerConnection.on(Fe.REQUEST_NEW_URLS,(t,n)=>{this.workerManagerConnection.close(),this.once(Mn.REQUEST_NEW_WORKER_URL,r=>{t([r])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(r=>{this.connectWorkerManager(r,!0)}).catch(r=>{n(r)})})}async requestToInspectImage(){this.sequence++;const t=ni(this,Mn.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(Mn.INSPECT_RESULT,void 0,new B(b.INVALID_OPERATION,"Only the track being played can be inspected"));const r=await this.generateRequestData(t,n);this.workerConnection.sendMessage(r,!0,!0)}else this.emit(Mn.INSPECT_RESULT,void 0,new B(b.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,n){let{appId:r,cname:i,cid:o,vid:s,sid:c,uid:l}=n;const u=Date.now(),h=await t.getCurrentFrameImage("image/jpeg",this.quality),f=await RL(h,r,i),_=this.sequence+"-"+o+"-"+l+"-"+u+"-"+_t(12,""),E={appId:r,cid:o,cname:i,deviceId:"",elapse:(I=Number(u-this.inspectStartTime),{low:I|=0,high:I>>31,unsigned:I>=0}),fileSize:f.byteLength,jpgEncryption:2,height:h.height,width:h.width,jpg:f,networkType:6,osType:7,requestId:_,sdkVersion:"4.24.2",sequence:this.sequence,sid:c,timestamp:QM(u),uid:l,vid:s,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var I;this.extraInfo===void 0&&delete E.callbackData,this.ossFilePrefix===void 0&&delete E.ossFilePrefix;const v=bQ(E);if(v.byteLength<this.workerMessageLengthLimit){if(w("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const R=function(A){for(var O=1;O<arguments.length;O++){var P=arguments[O]!=null?arguments[O]:{};O%2?zU(Object(P),!0).forEach(function(M){y(A,M,P[M])}):Object.getOwnPropertyDescriptors?Object.defineProperties(A,Object.getOwnPropertyDescriptors(P)):zU(Object(P)).forEach(function(M){Object.defineProperty(A,M,Object.getOwnPropertyDescriptor(P,M))})}return A}({},E);delete R.jpg,g.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(R))}return v}{const R=this.quality*this.qualityRatio;return this.quality=R,await this.generateRequestData(t,{appId:r,cname:i,cid:o,vid:s,sid:c,uid:l})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=br.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=lo.CLOSED,this.emit(Mn.STATE_CHANGE,uo.CLOSED)}}const VQ={name:"ContentInspect",create:function(e){let{config:t}=e;return function(n){if(!n)throw new B(b.INVALID_PARAMS,"inspectConfig is necessary.");if(!n.inspectType||!Array.isArray(n.inspectType))throw new B(b.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{const r=[...new Set(n.inspectType)];r.forEach(i=>{var o;if(!Z(o=["supervise","moderation"]).call(o,i))throw new B(b.INVALID_PARAMS,"".concat(i," is not a valid inspect type."))}),n.inspectType=r}if(n&&n.extraInfo&&n.extraInfo.length>1024)throw new B(b.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(t),new xQ(t)}};var qU=S(wr.Object.getOwnPropertySymbols),FQ=ft,BQ=Lg.indexOf,jQ=tf,By=ht([].indexOf),XU=!!By&&1/By([1],1,-0)<0;FQ({target:"Array",proto:!0,forced:XU||!jQ("indexOf")},{indexOf:function(e){var t=arguments.length>1?arguments[1]:void 0;return XU?By(this,e,t)||0:BQ(this,e,t)}});var GQ=Ni("Array","indexOf"),WQ=re,HQ=GQ,jy=Array.prototype,KQ=function(e){var t=e.indexOf;return e===jy||WQ(jy,e)&&t===jy.indexOf?HQ:t},JU=S(KQ);function YQ(e,t){if(e==null)return{};var n,r,i=function(s,c){if(s==null)return{};var l={};for(var u in s)if({}.hasOwnProperty.call(s,u)){if(JU(c).call(c,u)!==-1)continue;l[u]=s[u]}return l}(e,t);if(qU){var o=qU(e);for(r=0;r<o.length;r++)n=o[r],JU(t).call(t,n)===-1&&{}.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}let QU=class{get localCapabilities(){return Mt(this._localCapabilities)}get rtpCapabilities(){return Mt(this._rtpCapabilities)}get candidates(){return Mt(this._candidates)}get iceParameters(){return Mt(this._iceParameters)}get dtlsParameters(){return Mt(this._dtlsParameters)}constructor(e){y(this,"sessionDesc",void 0),y(this,"_localCapabilities",void 0),y(this,"_rtpCapabilities",void 0),y(this,"_candidates",void 0),y(this,"_iceParameters",void 0),y(this,"_dtlsParameters",void 0),y(this,"setup",void 0),y(this,"currentMidIndex",void 0),y(this,"cname","o/i14u9pJrxRKAsu"),y(this,"firefoxSsrcMidMap",new Map),e=Mt(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:r,remoteRTPCapabilities:i,localCapabilities:o,direction:s,setup:c,videoCodec:l,audioCodec:u}=e;let h;this.setup=c,h=s===vr.RECEIVE_ONLY?gr(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):gr(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=i,this._candidates=r,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=o;const f=s===vr.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,_=s===vr.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,E=s===vr.RECEIVE_ONLY?i.send.videoCodecs:Nh(ue.VIDEO,f,_,l),I=s===vr.RECEIVE_ONLY?i.send.audioCodecs:Nh(ue.AUDIO,f,_,u);for(const v of h.mediaDescriptions)v.attributes.iceUfrag=t.iceUfrag,v.attributes.icePwd=t.icePwd,v.attributes.fingerprints=n.fingerprints,v.attributes.candidates=r,v.attributes.setup=this.setup,v.media.mediaType==="application"&&(v.attributes.sctpPort="5000"),v.media.mediaType==="video"&&(v.media.fmts=E.map(R=>R.payloadType.toString(10)),v.attributes.payloads=E,v.attributes.extmaps=f.videoExtensions),v.media.mediaType==="audio"&&(v.media.fmts=I.map(R=>R.payloadType.toString(10)),v.attributes.payloads=I,v.attributes.extmaps=f.audioExtensions,bl(v));this.sessionDesc=h,this.currentMidIndex=h.mediaDescriptions.length-1}toString(){return js(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every(t=>this.hasMid(t)):this.sessionDesc.mediaDescriptions.some(t=>t.attributes.mid===e)}send(e,t,n,r,i){n=n.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:s}=bh(t,this.cname,w("SYNC_GROUP")?n:void 0),c=this.findPreloadMediaDesc(o);if(c){if(kt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,c.attributes.mid),i&&(i.twcc||i.remb)){const l=this.sessionDesc.mediaDescriptions.indexOf(c);return this.sessionDesc.mediaDescriptions[l]=this.mungSendMediaDesc(c,i),{mid:c.attributes.mid,needExchangeSDP:!0}}return{mid:c.attributes.mid,needExchangeSDP:!1}}{const l=this.findAvailableMediaIndex(e,o,r);let u;return l===-1?(u=this.createOrRecycleSendMedia(e,o,s,"sendonly",r,i),this.updateBundleMids()):(u=Mt(this.sessionDesc.mediaDescriptions[l]),u.attributes.direction="sendonly",u.attributes.ssrcs=o,u.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[l]=this.mungSendMediaDesc(u,i)),kt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,u.attributes.mid),{needExchangeSDP:!0,mid:u.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&e.indexOf(n.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(n=>{n.attributes.ssrcs=[]}),this.updateBundleMids()}receive(e,t,n){const r=[];return e.forEach(i=>{const o=i._mediaStreamTrack.kind,s=this.findAvailableRecvMediaIndex(o);let c,l=!1;s===-1?(l=!0,c=this.createOrRecycleRecvMedia(i,[],"recvonly",t,n),this.updateBundleMids()):(c=Mt(this.sessionDesc.mediaDescriptions[s]),c.attributes.direction="recvonly"),r.push({mid:c.attributes.mid,needCreateTransceiver:l})}),r}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>e.indexOf(n.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:n,address:r,port:i,type:o,relatedAddress:s,relatedPort:c,priority:l}=new RTCIceCandidate(e),u={foundation:t??"",componentId:"1",transport:n??"",priority:l?l+"":"",connectionAddress:r??"",port:i?i+"":"",type:o?o+"":"",relAddr:s??"",relPort:c?c+"":"",extension:{}};this.candidates.some(h=>h.priority===u.priority&&h.connectionAddress===u.connectionAddress&&h.port===u.port)||(this._candidates.push(u),this.sessionDesc.mediaDescriptions.forEach(h=>{h.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,n,r,i){const o=e._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,c=Nh(o,s,this.localCapabilities.send,o===ue.AUDIO?i:r),l=o===ue.VIDEO?s.videoExtensions:s.audioExtensions,u="".concat(++this.currentMidIndex);let h={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(_=>_.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(u)}};h=this.mungRecvMediaDsec(h,e);const f=this.findFirstClosedMedia(o);if(f){const _=this.sessionDesc.mediaDescriptions.indexOf(f);this.sessionDesc.mediaDescriptions[_]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>Z(e).call(e,n.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>Z(e).call(e,n.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(n=>{n.attributes.direction="recvonly"})}findAvailableMediaIndex(e,t,n){return this.sessionDesc.mediaDescriptions.findIndex(r=>{const i=r.media.mediaType===e&&r.media.port!=="0"&&(r.attributes.direction==="sendonly"||r.attributes.direction==="sendrecv")&&r.attributes.ssrcs.length===0;if(kt()){if(i){const o=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(o||r.attributes.mid!=="0"&&r.attributes.mid!=="1")||!(!o||o!==r.attributes.mid)}return!1}return i&&r.attributes.mid===n})}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex(t=>{const n=t.media.mediaType===e&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&n})}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}restartICE(e){e=Mt(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}createOrRecycleSendMedia(e,t,n,r,i,o){const s=this.rtpCapabilities.send,c=e===ue.VIDEO?s.videoCodecs:s.audioCodecs,l=e===ue.VIDEO?s.videoExtensions:s.audioExtensions;kt()&&(i="".concat(++this.currentMidIndex));let u={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:c.map(f=>f.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:c,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:i}};u=this.mungSendMediaDesc(u,o);const h=this.findFirstClosedMedia(e);if(h){const f=this.sessionDesc.mediaDescriptions.indexOf(h);this.sessionDesc.mediaDescriptions[f]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}mungRecvMediaDsec(e,t,n){const r=Mt(e);return LR(r),Yc(r,t),kR(r,t),j1(r),um(r,n,this.localCapabilities.send),r}mungSendMediaDesc(e,t){const n=Mt(e);return um(n,t,this.localCapabilities.recv),bl(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(n!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=r}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(t=>{var n;return((n=t.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===e[0].ssrcId})}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(t=>kt()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0")}};const zQ=["sdp"];var Ut;function ZU(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Va(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?ZU(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ZU(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}let $U=(Ut=class ql extends y1{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,n,r){super(t,n),y(this,"direction",void 0),y(this,"name",void 0),y(this,"store",void 0),y(this,"spec",void 0),y(this,"peerConnection",void 0),y(this,"initialOffer",void 0),y(this,"transport",void 0),y(this,"statsFilter",void 0),y(this,"localCandidateCount",0),y(this,"_isInRestartIce",!1),y(this,"mutex",void 0),y(this,"onLocalCandidate",void 0),y(this,"remoteSDP",void 0),y(this,"pendingCandidates",[]),y(this,"localCapabilities",void 0),y(this,"isReady",!1),y(this,"restartCnt",0),y(this,"curTurnServerIndex",0),this.store=n,this.spec=t,this.mutex=new Ln("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(ql.resolvePCConfiguration(t,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=r??vr.SEND_ONLY,this.name=this.direction===vr.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=L_(this.peerConnection,w("STATS_UPDATE_INTERVAL"),void 0,kt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{const n=await UR();if(this.localCapabilities=Oh(n),t){const{sdp:r}=t,i=YQ(t,zQ),o=function(){const h={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},f=Ah(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),_={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},E={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},I={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(po(f,h,"videoExtensions",_,E,I),po(f,h,"videoCodecs",_,E,I),po(f,h,"audioExtensions",_,E,I),po(f,h,"audioCodecs",_,E,I),w("RAISE_H264_BASELINE_PRIORITY")){const v=I.videoCodecs.findIndex(R=>R.rtpMap&&R.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&R.fmtp&&R.fmtp.parameters["profile-level-id"]==="42001f");if(v!==-1){const R=I.videoCodecs.findIndex(A=>A.rtpMap&&A.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(R<v){g.debug("raising H264 baseline profile priority");const A=I.videoCodecs[v];I.videoCodecs.splice(v,1),I.videoCodecs.splice(R,0,A)}R!==-1&&w("FILTER_SEND_H264_BASELINE")&&(_.videoCodecs=_.videoCodecs.filter(A=>!(A.rtpMap&&A.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&A.fmtp&&A.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:_,recv:E,sendrecv:I}}({},{},r);this.remoteSDP=new QU({remoteIceParameters:i.iceParameters,remoteDtlsParameters:i.dtlsParameters,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const s=await this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const c=Es(s.sdp);await this.peerConnection.setLocalDescription(s);const l=await W1({},{},s.sdp);this.localCapabilities=Oh(l);const u=this.peerConnection.getTransceivers()[0];return u!=null&&u.receiver&&u.receiver.transport&&this.tryBindTransportEvents(u.receiver.transport),Va(Va({},c),{},{sdp:s.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const r=await this.peerConnection.createOffer();if(!r.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=Es(r.sdp);return this.initialOffer=r,Va(Va({},i),{},{sdp:r.sdp})}}catch(n){throw new W(b.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:n,iceParameters:r,dtlsParameters:i}=t,o=await W1({},{},n);this.remoteSDP=new QU({remoteIceParameters:r,remoteDtlsParameters:i,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const s=this.peerConnection.getTransceivers()[0];s!=null&&s.sender&&s.sender.transport&&this.tryBindTransportEvents(s.sender.transport)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(n=>{this.peerConnection.addIceCandidate(n)}),this.pendingCandidates=[])}catch(n){throw new W(b.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(t,n,r){var i=this;return Ar(function*(){const o=yield We(i.mutex.lock("From P2PConnection.send"));try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[],c=i.remoteSDP.receive(t,n,r);t.forEach((R,A)=>{if(c[A].needCreateTransceiver){const O=i.peerConnection.addTransceiver(R._mediaStreamTrack,{direction:"sendonly"});s.push(O),R._updateRtpTransceiver(O)}else{const O=i.peerConnection.getTransceivers().find(P=>P.mid===c[A].mid);if(!O)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(c[A].mid));s.push(O),R._updateRtpTransceiver(O)}}),kt()&&w("SIMULCAST")===!0&&(yield We(i.applySimulcastForFirefox(s,t)));const l=c.map(R=>R.mid),u=yield We(i.peerConnection.createOffer()),h=i.mungSendOfferSDP(u.sdp,t,l),f=gr(h),_=l.map(R=>{const A=f.mediaDescriptions.find(O=>O.attributes.mid===R);if(!A)throw new Error("Cannot extract ssrc from mediaDescription.");return PR(A,w("USE_PUB_RTX"))}),E=s.map((R,A)=>{const O=l[A];return{localSSRC:_[A],id:O}});yield We(i.peerConnection.setLocalDescription({type:"offer",sdp:h}));try{yield E}catch(R){const A=i.remoteSDP.toString();throw yield We(i.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield We(i.peerConnection.setRemoteDescription({type:"answer",sdp:A})),yield We(i.stopSending(l,!0)),R}yield We(i.applySimulcastEncodings(s,t)),yield We(i.applySendEncodings(s,t));const I=i.remoteSDP.toString(),v=i.logSDPExchange(h,"offer","local","send");return v==null||v(I),yield We(i.setRemoteDescription({type:"answer",sdp:I})),s.map((R,A)=>{const O=l[A];return{localSSRC:_[A],id:O}})}catch(s){throw s instanceof W?s:new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(t,n){const r=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const i=this.peerConnection.getTransceivers().filter(l=>t.indexOf(l.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length (".concat(i.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));i.map(l=>{var u;l.direction="inactive",(u=l.stop)===null||u===void 0||u.call(l)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(t);const c=this.remoteSDP.toString();s==null||s(c),await this.setRemoteDescription({type:"answer",sdp:c})}catch(i){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}finally{r&&r()}}async receive(t,n,r,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(t,n,r,i);if(s){const l=this.remoteSDP.toString(),u=this.logSDPExchange(l,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:l});const h=await this.peerConnection.createAnswer(),f=this.mungReceiveAnswerSDP(h.sdp,o,t);u==null||u(f||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:f}),g.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else g.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const c=this.peerConnection.getTransceivers().find(l=>l.mid===o);if(!c||c.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,mid:c.mid,transceiver:c}}catch(o){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async mockReceive(t,n,r,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(t,n,r,i);if(s){const c=this.remoteSDP.toString(),l=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const u=await this.peerConnection.createAnswer(),h=this.mungReceiveAnswerSDP(u.sdp,o,t);l==null||l(h||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:h}),g.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else g.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(o){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===kc.Auto&&(this.store.p2pTransport=kc.SdRtn,Xe().supportPCSetConfiguration&&this.peerConnection.setConfiguration(ql.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Xe().supportPCSetConfiguration&&this.peerConnection.setConfiguration(ql.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:r}=Es(n.sdp);return this.store.descriptionStart(),this.direction===vr.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),r}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===vr.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:r}=Es(n.sdp);return await this.peerConnection.setLocalDescription(n),r}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(r.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const o=this.remoteSDP.toString(),s=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new W(b.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,n){const r=this.peerConnection.getTransceivers().filter(i=>i.mid===t);r.length===1&&(this.isVP8Simulcast(n)?kt()||await this.applySimulcastEncodings(r,[n]):await this.applySendEncodings(r,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const r=this.peerConnection.getTransceivers().find(i=>i.mid===n);r&&await r.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:r,remote:i}=n.getSelectedCandidatePair();return{local:Va(Va({},so),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:Va(Va({},so),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t,n;Z(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(n=this.onICEConnectionStateChange)===null||n===void 0||n.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var n;t.candidate.candidate&&((n=this.onLocalCandidate)===null||n===void 0||n.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else g.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const i={iceServers:[]};var o;return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(bc(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...ql.turnServerConfigToIceServers(t.turnServer.servers,n,r)),w("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...ql.turnServerConfigToIceServers(t.turnServer.serversFromGateway,n,r)),Z(o=[kc.Relay,kc.SdRtn]).call(o,n)&&(i.iceTransportPolicy="relay"),w("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(s=>{s.forceturn&&(i.iceTransportPolicy="relay")}))),w("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),g.debug("P2PConnection p2pTransport is ".concat(n)),i}static turnServerConfigToIceServers(t,n){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const i=[],o=t.filter(c=>c.tcpport);g.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(r));const s=o.length>r?o[r]:o[0];switch(n){case kc.SdRtn:const c=t.filter(u=>{var h;return Z(h=u.username).call(h,"glb:")&&u.turnServerURL==u.turnServerURL}),l=c.length>r?c[r]:c[0];l&&(i.push({username:l.username,credential:l.password,credentialType:"password",urls:"turn:".concat(ho(l.turnServerURL),":").concat(l.tcpport,"?transport=udp")}),i.push({username:l.username,credential:l.password,credentialType:"password",urls:"turns:".concat(ho(l.turnServerURL),":").concat(l.tcpport,"?transport=tcp")}));break;case kc.Relay:s&&(i.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),i.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(ho(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}));break;default:s&&(i.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),i.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(ho(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}),i.push({username:s.username,credential:s.password,credentialType:"password",urls:"stun:".concat(s.turnServerURL,":").concat(s.tcpport)}))}return i}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var r;t!=null&&t.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,t.state))},t.onerror=r=>{var i;(i=this.onDTLSTransportError)===null||i===void 0||i.call(this,"error"in r?r.error:r)};const n=t.iceTransport;n&&(n.onstatechange=()=>{const r=t==null?void 0:t.iceTransport.state;var i;r&&((i=this.onICETransportStateChange)===null||i===void 0||i.call(this,r))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:r,remote:i}=n.getSelectedCandidatePair()||{};if(r&&i){const o=r.address+":"+r.port,s=i.address+":"+i.port;g.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(ms(o)),", remote ").concat(JSON.stringify(ms(s))))}}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var r;if(n||(n=this.peerConnection.getSenders().find(h=>h.track===t._mediaStreamTrack)),!n)return g.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return g.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Xe().supportSetRtpSenderParameters)return g.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const i={},o={};switch(t._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;default:i.degradationPreference="balanced"}if(t._encoderConfig){var s;const{bitrateMax:h,frameRate:f,scaleResolutionDownBy:_}=t._encoderConfig;h&&(o.maxBitrate=1e3*h),Z(s=t._hints).call(s,pt.LOW_STREAM)&&(f&&(o.maxFramerate=Pr(f)),_&&_>=1&&(o.scaleResolutionDownBy=_))}if(w("DSCP_TYPE")&&us()){var c;const h=w("DSCP_TYPE");Z(c=["very-low","low","medium","high"]).call(c,h)&&(o.networkPriority=h)}const l=n.getParameters(),u=(r=l.encodings)===null||r===void 0?void 0:r[0];kt()&&!u&&(i.encodings=[o]),u&&Object.assign(u,o),Object.assign(l,i),g.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(l.encodings))),await n.setParameters(l)}async applySendEncodings(t,n){try{if(!Xe().supportSetRtpSenderParameters||t.length!==n.length)return;for(let r=0;r<t.length;r++){const i=t[r],o=n[r];o instanceof wt&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,i.sender)}}catch{g.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,r){const i=gr(t);return n.forEach((o,s)=>{const c=r[s],l=i.mediaDescriptions.find(u=>u.attributes.mid===c);l&&(Yc(l,o),MR(l,o,this.store.codec))}),js(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,r)=>{var i;(i=this.onFirstVideoDecoded)===null||i===void 0||i.call(this,t,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let l=0;l<t.length;l++){var r,i,o,s,c;const u=t[l],h=n[l];if(h instanceof wt&&!Z(r=h._hints).call(r,pt.LOW_STREAM)&&(i=h._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((o=h._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=h._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((c=h._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1&&this.store.codec==="vp8"){const f={},_={high:1e3*(h._encoderConfig.bitrateMax-50),medium:5e4};f.encodings=[{rid:"m",active:!0,maxBitrate:_.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:_.high}];const E=u.sender.getParameters();await u.sender.setParameters(Object.assign(E,f))}}}async applySimulcastEncodings(t,n){if(!kt()&&t.length===n.length)for(let r=0;r<t.length;r++){const i=n[r];if(i instanceof wt&&this.isVP8Simulcast(i)){const o=t[r],s={},c={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const l=o.sender.getParameters();await o.sender.setParameters(Object.assign(l,s))}}}isVP8Simulcast(t){var n,r,i,o,s;return!!(t instanceof wt&&w("SIMULCAST")&&this.store.codec==="vp8"&&!Z(n=t._hints).call(n,pt.LOW_STREAM)&&(r=t._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((i=t._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(o=t._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=t._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(t,n,r,i){if(w("SDP_LOGGING"))return g.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(n," SDP during P2PConnection.").concat(i,`
`),t),n==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",i)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(t);const o=this.remoteSDP.toString();i==null||i(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async s=>{s.direction="sendonly"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(t);const o=this.remoteSDP.toString();i==null||i(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(t,n){var r;if(n=n??((r=this.currentRemoteDescription)===null||r===void 0?void 0:r.sdp)){var i;const o=(i=gr(n).mediaDescriptions.find(s=>s.attributes.mid===t))===null||i===void 0?void 0:i.attributes.ssrcs;return o==null?void 0:o[0].ssrcId}}async setRemoteDescription(t){var n;await this.peerConnection.setRemoteDescription(t),Z(n=["connected","completed"]).call(n,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,n,r){const i=gr(t),o=i.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&r===ue.AUDIO&&o.media.mediaType==="audio"&&bl(o),js(i)}},ae(Ut.prototype,"establish",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"establish"),Ut.prototype),ae(Ut.prototype,"connect",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"connect"),Ut.prototype),ae(Ut.prototype,"receive",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"receive"),Ut.prototype),ae(Ut.prototype,"mockReceive",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"mockReceive"),Ut.prototype),ae(Ut.prototype,"stopReceiving",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"stopReceiving"),Ut.prototype),ae(Ut.prototype,"restartICE",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"restartICE"),Ut.prototype),ae(Ut.prototype,"close",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"close"),Ut.prototype),ae(Ut.prototype,"updateEncoderConfig",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"updateEncoderConfig"),Ut.prototype),ae(Ut.prototype,"updateSendParameters",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"updateSendParameters"),Ut.prototype),ae(Ut.prototype,"replaceTrack",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"replaceTrack"),Ut.prototype),ae(Ut.prototype,"muteLocal",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"muteLocal"),Ut.prototype),ae(Ut.prototype,"unmuteLocal",[go],Object.getOwnPropertyDescriptor(Ut.prototype,"unmuteLocal"),Ut.prototype),Ut);function go(e,t,n){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,c=new Array(s),l=0;l<s;l++)c[l]=arguments[l];return await r.apply(this,c)}finally{o()}},n}let Ho=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});var ex,tx,nx,rx,ix,ox,sx,ax,cx,dx,lx,Ht;function ux(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function zm(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?ux(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ux(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}let qQ=(ex=Ko(Ho.SEND_ONLY),tx=Ko(Ho.SEND_ONLY),nx=Ko(),rx=Ko(Ho.RECEIVE_ONLY),ix=Ko(Ho.RECEIVE_ONLY),ox=Ko(Ho.RECEIVE_ONLY),sx=Ko(Ho.RECEIVE_ONLY),ax=Ko(Ho.RECEIVE_ONLY),cx=Ko(Ho.RECEIVE_ONLY),dx=Ko(),lx=Ko(Ho.RECEIVE_ONLY),Ht=class extends Wt{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(Se.StateChange,t,this._state)}constructor(e,t){super(),y(this,"isPlanB",!1),y(this,"store",void 0),y(this,"statsUploader",void 0),y(this,"sendConnection",void 0),y(this,"recvConnection",void 0),y(this,"localTrackMap",new Map),y(this,"remoteUserMap",new Map),y(this,"localDataChannels",[]),y(this,"pendingLocalTracks",[]),y(this,"pendingRemoteTracks",[]),y(this,"statsCollector",void 0),y(this,"dtlsFailedCount",0),y(this,"sendMutex",void 0),y(this,"recvMutex",void 0),y(this,"_state",ut.Disconnected),y(this,"_restartStates",["disconnected","failed"]),y(this,"reconnectInterval",void 0),y(this,"uploadUnplinkStarted",!1),y(this,"uploadDownlinkStarted",!1),y(this,"uplinkStateUploadInterval",void 0),y(this,"downlinkStatsUploadInterval",void 0),y(this,"handleMuteLocalTrack",async(n,r,i)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==ut.Connected)return void i(new W(b.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const l=this.filterTobeMutedTracks(n);if(l.length===0)return void r();const u=l.find(E=>E[0]==="videoLowTrack");u&&u[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(l.map(E=>{let[,{id:I}]=E;return I}));let h=!1;var s,c;n.trackMediaType==="video"?h=!((s=this.localTrackMap.get($.LocalAudioTrack))===null||s===void 0||!s.track._muted):h=((c=this.localTrackMap.get($.LocalVideoTrack))===null||c===void 0?void 0:c.id)===void 0;const f=this.createMuteMessage(l);await Ot(this,Se.RequestMuteLocal,f);const _=n.trackMediaType==="video"?wa.MUTE_LOCAL_VIDEO:wa.MUTE_LOCAL_AUDIO;await Ot(this,Se.RequestP2PMuteLocal,{action:_,message:f,isMuteAll:h}),r()}catch(l){i(l)}finally{o()}}),y(this,"handleUnmuteLocalTrack",async(n,r,i)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==ut.Connected)return void i(new W(b.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void r();await this.sendConnection.unmuteLocal(s.map(u=>{let[,{id:h}]=u;return h}));const c=this.createUnmuteMessage(s),l=n.trackMediaType==="video"?wa.UNMUTE_LOCAL_VIDEO:wa.UNMUTE_LOCAL_AUDIO;await Ot(this,Se.RequestP2PMuteLocal,{action:l,message:c}),r()}catch(s){i(s)}finally{o()}}),y(this,"handleUpdateVideoEncoder",async(n,r,i,o)=>{let s;typeof o=="boolean"&&o||(s=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{const l=this.localTrackMap.get($.LocalVideoTrack);if(!this.sendConnection||!l||l.track!==n||this.state!==ut.Connected)return void r();const{id:u,track:h}=l;u&&(await this.sendConnection.updateSendParameters(u,h),await this.sendConnection.updateEncoderConfig(u,h),this.emit(Se.UpdateVideoEncoder,h)),r()}catch(l){i(l)}finally{var c;(c=s)===null||c===void 0||c()}}),y(this,"handleUpdateVideoSendParameters",async(n,r,i)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const s=this.localTrackMap.get($.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==n||this.state!==ut.Connected)return void r();const{id:c,track:l}=s;c&&await this.sendConnection.updateSendParameters(c,l),r()}catch(s){i(s)}finally{o()}}),y(this,"handleReplaceTrack",async(n,r,i,o)=>{let s;g.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var c;const u=Array.from(this.localTrackMap.entries()).find(h=>{let[,{track:f}]=h;return n===f});if(!this.sendConnection||!u||u[1].id===void 0||this.state!==ut.Connected)return void r();if(await((c=this.sendConnection)===null||c===void 0?void 0:c.replaceTrack(n,u[1].id)),u[0]===$.LocalVideoTrack&&Xe().supportDualStreamEncoding){const h=this.localTrackMap.get($.LocalVideoLowTrack);if(h){const f=n._mediaStreamTrack.clone();h.track._originMediaStreamTrack.stop(),h.track._mediaStreamTrack=f,h.track._originMediaStreamTrack=f,await new se((_,E)=>{this.handleReplaceTrack(h.track,_,E,!0)})}}r()}catch(u){i(u)}finally{var l;(l=s)===null||l===void 0||l()}}),y(this,"handleGetLocalVideoStats",n=>{n(this.statsCollector.getLocalVideoTrackStats())}),y(this,"handleGetLocalAudioStats",n=>{n(this.statsCollector.getLocalAudioTrackStats())}),y(this,"handleGetRemoteVideoStats",n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid]),y(this,"handleGetRemoteAudioStats",n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new IM(e),this.bindStatsUploaderEvents(),this.sendMutex=new Ln("P2PChannel2-send-mutex",e.clientId),this.recvMutex=new Ln("P2PChannel2-recv-mutex",e.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))})},w("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new W(b.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e){throw new W(b.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let n;try{if(t){this.recvConnection&&(g.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new $U(e,this.store,vr.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const r=await this.recvConnection.establish(t);return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}{this.state=ut.New,this.sendConnection&&(g.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new $U(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const r=await this.sendConnection.establish();return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}}finally{n&&n()}}async p2pConnect(e){if(!this.sendConnection)throw new W(b.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=ut.Connected}async addRemoteCandidate(e,t){if(t===vr.RECEIVE_ONLY){if(!this.sendConnection)throw new W(b.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new W(b.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,n){var r=this;return Ar(function*(){const i=yield We(r.sendMutex.lock("From P2PChannel.publish"));try{if(!r.sendConnection||r.state!==ut.Connected){r.throwIfTrackTypeNotMatch(e);const u=e.filter(h=>r.pendingLocalTracks.indexOf(h)===-1);return void(r.pendingLocalTracks=r.pendingLocalTracks.concat(u))}r.store.pubId=r.store.pubId+1,tr.markPublishStart(r.store.clientId,r.store.pubId);const o=r.filterTobePublishedTracks(e,t,n);if(o.length===0)return void(yield We(r.tryToUnmuteAudio(e)));o.forEach(u=>{let{track:h,type:f}=u;const _=Date.now();r.store.publish(h.getTrackId(),f===$.LocalAudioTrack?"audio":"video",_)}),r.bindLocalTrackEvents(o);const s=yield We(r.sendConnection.send(o.map(u=>{let{track:h}=u;return h}),r.store.codec,r.store.audioCodec)),c=(yield We(s.next())).value,l=r.createGatewayPublishMessage(o,c);try{yield l}catch(u){throw s.throw(u),(u==null?void 0:u.code)===b.WS_ABORT&&o.forEach(h=>{let{track:f}=h;r.pendingLocalTracks.indexOf(f)===-1&&r.pendingLocalTracks.push(f)}),r.unbindLocalTrackEvents(o),u}yield We(s.next()),o.forEach(u=>{let{type:h}=u;r.statsCollector.addLocalStats(h)}),r.statsUploader.startUploadOutboundStats(),r.assignLocalTracks(o,c),o.forEach(u=>{let{track:h,type:f}=u;const _=Date.now();r.store.publish(h.getTrackId(),f===$.LocalAudioTrack?"audio":"video",void 0,_)}),r.startUploadUplinkState()}finally{i()}})()}async unpublish(e){if(!this.sendConnection||this.state!==ut.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(i=>!Z(e).call(e,i)));const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const n=t.find(i=>i[0]==="videoLowTrack");n&&n[1].track.close();const r=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map(i=>{let[,{id:o}]=i;return o})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(i=>{let[o,{track:s}]=i;return{type:o,track:s}})),t.forEach(i=>{let[o]=i;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===ut.Connected)return n&&n[1].track.close(),r;e.forEach(i=>{const o=this.pendingLocalTracks.indexOf(i);o!==-1&&this.pendingLocalTracks.splice(o,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const t=[],n=[];Array.from(this.localTrackMap.entries()).forEach(r=>{let[i,{track:o,ssrcs:s}]=r;const c={stream_type:UX(o,i),ssrcs:s};o._muted||!o._enabled?t.push(c):n.push(c)}),t.length>0&&t.forEach(r=>{Ot(this,Se.RequestMuteLocal,[r])}),n.length>0&&n.forEach(r=>{Ot(this,Se.RequestUnmuteLocal,[r])})};e(),this.uplinkStateUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return Ar(function*(){throw new W(b.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(g.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await hn(this,Se.RequestRePublish,this.pendingLocalTracks),this.emit(Se.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new W(b.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,n,r){var i;if(!this.recvConnection)throw new W(b.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((i=this.remoteUserMap.get(e))!==null&&i!==void 0&&i.has(t))return;const{track:o,mid:s,transceiver:c}=await this.recvConnection.receive(t,[{ssrcId:n}],String(e.uid),r);t===ue.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new Tl(o,e.uid,e._uintid,this.store),g.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new Sl(o,e.uid,e._uintid,this.store),g.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack));const l=this.remoteUserMap.get(e);l?l.set(t,s):this.remoteUserMap.set(e,new Map([[t,s]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const u=this.pendingRemoteTracks.findIndex(h=>{let{user:f,kind:_}=h;return f.uid===e.uid&&t===_});u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(Se.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,n,r){if(!this.recvConnection)throw new W(b.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:n}],String(e.uid),r)}async unsubscribe(e,t,n){const r=this.pendingRemoteTracks.filter(o=>{let{user:s,kind:c}=o;return t!==void 0?s.uid===e.uid&&t===c:s.uid===e.uid});if(r.forEach(o=>{const s=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(s,1)}),this.recvConnection||n||r.forEach(o=>{let{kind:s}=o;var c;if(s===ue.AUDIO)(c=e._audioTrack)===null||c===void 0||c._destroy(),e._audioTrack=void 0;else if(s===ue.VIDEO){var l;(l=e._videoTrack)===null||l===void 0||l._destroy(),e._videoTrack=void 0}}),!this.recvConnection)return;const i=this.filterTobeUnSubscribedTracks(e,t);i.length!==0&&(await this.recvConnection.stopReceiving(i.map(o=>{let[,{id:s}]=o;return s})),this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),i.forEach(o=>{let[s,{kind:c}]=o;var l,u;if(c===ue.VIDEO&&s._videoSSRC&&((l=this.recvConnection)===null||l===void 0||l.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),c===ue.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),n||((u=s._videoTrack)===null||u===void 0||u._destroy(),s._videoTrack=void 0);else if(c===ue.AUDIO){var h;this.unbindRemoteTrackEvents(s._audioTrack),!n&&((h=s._audioTrack)===null||h===void 0||h._destroy(),s._audioTrack=void 0)}}),i.forEach(o=>{let[,{kind:s}]=o;Ot(this,Se.RequestP2PMuteRemote,s)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach(t=>{let[,n]=t;[ue.VIDEO,ue.AUDIO].forEach(r=>{n.has(r)?Ot(this,Se.RequestP2PUnmuteRemote,r):Ot(this,Se.RequestP2PMuteRemote,r)})});e(),this.downlinkStatsUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new W(b.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new W(b.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new W(b.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new W(b.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void g.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void g.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const r=t===ue.VIDEO?e._videoSSRC:e._audioSSRC;r!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void g.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(t)||g.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){const t=this.localTrackMap.get($.LocalAudioTrack);if((t==null?void 0:t.track)instanceof mn){const n=t.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[i]=r;return i!==$.LocalAudioTrack}).filter(r=>{let[i]=r;return!(e&&i===$.LocalVideoLowTrack)}).map(r=>{let[,{track:i}]=r;return i}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return!(e&&r===$.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r})}reportPublishEvent(e,t,n,r,i){if(e){const s=this.localTrackMap.get($.LocalAudioTrack),c=r?this.localTrackMap.get($.LocalVideoLowTrack):this.localTrackMap.get($.LocalVideoTrack);pe.publish(this.store.sessionId,{eventElapse:tr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:s==null?void 0:s.track.getTrackLabel(),videoName:c==null?void 0:c.track.getTrackLabel(),screenshare:(c==null?void 0:c.track._hints.indexOf(pt.SCREEN_TRACK))!==-1,audio:!!s,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}else{var o;n||(n=[]);const s=n.find(l=>l instanceof Zt),c=r?(o=this.localTrackMap.get($.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(l=>l instanceof wt);pe.publish(this.store.sessionId,{eventElapse:tr.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:s==null?void 0:s.getTrackLabel(),videoName:c==null?void 0:c.getTrackLabel(),screenshare:(c==null?void 0:c._hints.indexOf(pt.SCREEN_TRACK))!==-1,audio:!!s,video:!!c,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:i})}}reportSubscribeEvent(e,t,n,r){const i=r===ue.VIDEO?n._videoSSRC:n._audioSSRC;i&&pe.subscribe(this.store.sessionId,{succ:e,ec:t,video:r===ue.VIDEO,audio:r===ue.AUDIO,peerid:n.uid,subscribeRequestid:r===ue.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:tr.measureFromSubscribeStart(this.store.clientId,i)})}reset(){g.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Ln("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new Ln("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get($.LocalAudioTrack);if((e==null?void 0:e.track)instanceof mn){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach(n=>{t.removeAudioTrack(n)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=ut.Disconnected}getStats(e){var t,n;return e?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(t=this.sendConnection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.recvConnection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get($.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get($.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof wt||t&&t.track instanceof Zt?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){var t;const n=Array.from(ar(t=this.remoteUserMap).call(t)).find(r=>r.uid===e);return n?{audioTrack:n.audioTrack,audioSSRC:n._audioSSRC,videoTrack:n.videoTrack,videoSSRC:n._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(n=>{let[r]=n;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}});const t=this.localTrackMap.get($.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=gc(e).call(e,(n,r)=>n.level-r.level),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(g.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=ut.Reconnecting,w("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&((n=t._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[n,{track:r}]=e;switch(n){case $.LocalVideoTrack:Z(t=r._hints).call(t,pt.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case $.LocalAudioTrack:r instanceof mn?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case $.LocalVideoLowTrack:}}),this.emit(Se.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,n]=e;Array.from(ar(n).call(n)).forEach(r=>{this.setPendingRemoteMedia(t,r)}),this.emit(Se.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),g.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:r,kind:i}=n;if((e instanceof Oa?e.uid:e)===r.uid&&t===i)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let n,r;if(e===vr.SEND_ONLY){if(!this.sendConnection)throw new W(b.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),r=this.sendConnection}else{if(!this.recvConnection)throw new W(b.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),r=this.recvConnection}try{if(t){const i=await r.restartICE(t);return r.isInRestartIce=!1,i}{const i=await r.restartICE();if(i){const o=await hn(this,Se.RequestP2PRestartICE,{direction:vr.RECEIVE_ONLY,iceParameter:i});await r.restartICE(o),r.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get($.LocalVideoTrack),n=this.localTrackMap.get($.LocalAudioTrack),r=e.videoSend.find(E=>{var I;return E.ssrc===(t==null||(I=t.ssrcs)===null||I===void 0?void 0:I[0].ssrcId)}),i=e.audioSend.find(E=>{var I;return E.ssrc===(n==null||(I=n.ssrcs)===null||I===void 0?void 0:I[0].ssrcId)});if(!r||!i)return 1;const o=ni(this,Se.NeedSignalRTT),s=r?r.rttMs:void 0,c=i?i.rttMs:void 0,l=s&&c?(s+c)/2:s||c,u=(l&&o?(l+o)/2:l||o)||0,h=100*e.sendPacketLossRate*.7/50+.3*u/1500,f=h<.17?1:h<.36?2:h<.59?3:h<.1?4:5,_=t==null?void 0:t.track;if(_&&_._encoderConfig&&_._hints.indexOf(pt.SCREEN_TRACK)===-1){const E=_._encoderConfig.bitrateMax,I=e.bitrate.actualEncoded;if(E&&I){const v=(1e3*E-I)/(1e3*E);return _1[v<.15?0:v<.3?1:v<.45?2:v<.6?3:4][f]}}return f}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[r]=n;const i=r._audioSSRC,o=r._videoSSRC,s=e.audioRecv.find(I=>I.ssrc===i),c=e.videoRecv.find(I=>I.ssrc===o);if(!s&&!c)return void(t+=1);const l=ni(this,Se.NeedSignalRTT),u=e.rtt,h=(u&&l?(u+l)/2:u||l)||0,f=s?s.jitterMs:void 0,_=e.recvPacketLossRate;let E=.7*_*100/50+.3*h/1500;f&&(E=.6*_*100/50+.2*h/1500+.2*f/400),t+=E<.1?1:E<.17?2:E<.36?3:E<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new se((t,n)=>{this.handleMuteLocalTrack(e,t,n)})}filterTobePublishedTracks(e,t,n){const r=[],i=Xe(),o=this.getAllTracks();e=sl(e=e.filter(l=>o.indexOf(l)===-1));let s=!1,c=!1;for(const l of e){if(l instanceof wt&&(this.localTrackMap.has($.LocalVideoTrack)||s?new W(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:l,type:$.LocalVideoTrack}),s=!0),t)){const u=this.getLowVideoTrack(l,n);r.push({track:u,type:$.LocalVideoLowTrack})}if(l instanceof Zt){const u=this.localTrackMap.get($.LocalAudioTrack);if(u){if(!(u.track instanceof mn))throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(l._bypassWebAudio)throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(l),this.bindLocalAudioTrackEvents(l,!0)}else if(c){const h=r.find(f=>{let{type:_}=f;return _===$.LocalAudioTrack});if(!(h.track instanceof mn))throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(l._bypassWebAudio)throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");h.track.addAudioTrack(l)}else{if(!i.webAudioMediaStreamDest||l instanceof mn||l._bypassWebAudio)r.push({track:l,type:$.LocalAudioTrack});else{const h=new mn;h.addAudioTrack(l),r.push({track:h,type:$.LocalAudioTrack})}c=!0}}}return r}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=sl(e=e.filter(r=>n.indexOf(r)!==-1));for(const r of e){if(r instanceof Zt){const i=this.localTrackMap.get($.LocalAudioTrack);if(!i)continue;i.track instanceof mn?(i.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),i.track.trackList.length===0&&(t.push([$.LocalAudioTrack,i]),i.track.close())):t.push([$.LocalAudioTrack,i])}if(r instanceof wt){const i=this.localTrackMap.get($.LocalVideoTrack);if(!i)continue;t.push([$.LocalVideoTrack,i]);const o=this.localTrackMap.get($.LocalVideoLowTrack);o&&t.push([$.LocalVideoLowTrack,o])}}return t}bindLocalTrackEvents(e){e.forEach(t=>{let{track:n,type:r}=t;switch(r){case $.LocalVideoTrack:n.addListener(me.GET_STATS,this.handleGetLocalVideoStats),n.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(me.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case $.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case $.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof mn?e.trackList.forEach(n=>{n.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(me.GET_STATS,this.handleGetLocalAudioStats),n.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(me.GET_STATS,this.handleGetLocalAudioStats),e.addListener(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(me.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[n,{track:r}]=t;return{track:r,type:n}})),e.forEach(t=>{let{track:n,type:r}=t;switch(r){case $.LocalVideoTrack:n.off(me.GET_STATS,this.handleGetLocalVideoStats),n.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(me.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(me.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case $.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case $.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof mn?e.trackList.forEach(t=>{t.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(me.GET_STATS,this.handleGetLocalAudioStats),t.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(me.GET_STATS,this.handleGetLocalAudioStats),e.off(me.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(me.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(me.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(me.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(me.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Sl&&t.addListener(me.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(e))}),t instanceof Tl&&t.addListener(me.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(me.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,n]=e;n.has(ue.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(ue.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((n,r)=>{var i;let o,{track:s,type:c}=n;switch(c){case $.LocalAudioTrack:o=Et.Audio;break;case $.LocalVideoTrack:o=Z(i=s._hints).call(i,pt.SCREEN_TRACK)?Et.Screen:Et.High;break;case $.LocalVideoLowTrack:o=Et.Low}return{kind:c===$.LocalAudioTrack?ue.AUDIO:ue.VIDEO,stream_type:o,mid:t[r].id,ssrcs:t[r].localSSRC,isMuted:s.muted||!s.enabled}})}createGatewayUnpublishMessage(e){return e.map(t=>{var n;let r,[i,{track:o,ssrcs:s,id:c}]=t;switch(i){case $.LocalVideoTrack:r=Z(n=o._hints).call(n,pt.SCREEN_TRACK)?Et.Screen:Et.High;break;case $.LocalAudioTrack:r=Et.Audio;break;case $.LocalVideoLowTrack:r=Et.Low}return{stream_type:r,ssrcs:s,mid:c}})}assignLocalTracks(e,t){e.forEach((n,r)=>{let{track:i,type:o}=n;this.localTrackMap.set(o,{track:i,id:t[r].id,ssrcs:t[r].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[n]=t;this.localTrackMap.delete(n)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{var n;g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(Se.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(e.isInRestartIce=!1),Z(n=this._restartStates).call(n,t)&&!e.isInRestartIce&&(t==="disconnected"&&await In(800),e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="failed"||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),pe.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:It.TRACER}).onSuccess(),this.emit(Se.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var n;const r=Array.from(ar(n=this.remoteUserMap).call(n)).find(o=>o._audioSSRC===t);var i;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(i=r.audioTrack)===null||i===void 0||i.emit(Mi.FIRST_FRAME_DECODED),pe.firstRemoteFrame(this.store.sessionId,_n.FIRST_AUDIO_DECODE,Bt.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:tr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var n;const r=Array.from(ar(n=this.remoteUserMap).call(n)).find(i=>i._audioSSRC===t);r&&pe.firstRemoteFrame(this.store.sessionId,_n.FIRST_AUDIO_RECEIVED,Bt.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:tr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,n,r)=>{this.reportVideoFirstFrameDecoded(t,n,r)},e.onFirstVideoReceived=t=>{var n;const r=Array.from(ar(n=this.remoteUserMap).call(n)).find(i=>i._videoSSRC===t);r&&pe.firstRemoteFrame(this.store.sessionId,_n.FIRST_VIDEO_RECEIVED,Bt.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:tr.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,n)=>{const r=t.candidateType==="relay",i=n.candidateType==="relay";n.candidateType!=="unknown"&&r===i||this.emit(Se.ConnectionTypeChange,r),g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(Aa(n))," -> ").concat(JSON.stringify(Aa(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,n)=>{g.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(Aa(n))," -> ").concat(JSON.stringify(Aa(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(Se.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===vr.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,g.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===vr.SEND_ONLY?this.restartICE(e):hn(this,Se.RequestP2PRestartICE,{direction:vr.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const n=this.localTrackMap.get($.LocalAudioTrack);if(e instanceof Zt&&(n==null?void 0:n.track)instanceof mn)return n.track.isActive||t.push([$.LocalAudioTrack,n]),t;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return e===o});if(r&&(t.push(r),r[0]===$.LocalVideoTrack)){const i=this.localTrackMap.get($.LocalVideoLowTrack);i&&t.push([$.LocalVideoLowTrack,i])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get($.LocalAudioTrack);if(e instanceof Zt&&(n==null?void 0:n.track)instanceof mn)return n.track.isActive&&t.push([$.LocalAudioTrack,n]),t;const r=Array.from(this.localTrackMap.entries()).find(i=>{let[,{track:o}]=i;return e===o});if(r)if(r[0]===$.LocalVideoTrack){t.push(r);const i=this.localTrackMap.get($.LocalVideoLowTrack);i&&t.push([$.LocalVideoLowTrack,i])}else t.push(r);return t}createMuteMessage(e){return e.map(t=>{var n;let r,[i,{track:o,ssrcs:s,id:c}]=t;switch(i){case $.LocalAudioTrack:r=Et.Audio;break;case $.LocalVideoTrack:r=Z(n=o._hints).call(n,pt.SCREEN_TRACK)?Et.Screen:Et.High;break;case $.LocalVideoLowTrack:r=Et.Low}return{stream_type:r,ssrcs:s,mid:c}})}createUnmuteMessage(e){return e.map(t=>{var n;let r,[i,{track:o,ssrcs:s,id:c}]=t;switch(i){case $.LocalAudioTrack:r=Et.Audio;break;case $.LocalVideoTrack:r=Z(n=o._hints).call(n,pt.SCREEN_TRACK)?Et.Screen:Et.High;break;case $.LocalVideoLowTrack:r=Et.Low}return{stream_type:r,ssrcs:s,mid:c}})}filterTobeUnSubscribedTracks(e,t){const n=[],r=this.remoteUserMap.get(e);if(!r)return n;if(t){const i=r.get(t);if(!i)return n;n.push([e,{kind:t,id:i}])}else Array.from(r.entries()).forEach(i=>{let[o,s]=i;n.push([e,{kind:o,id:s}])});return n}createUnsubscribeMessage(e){const t=[];return e.forEach(n=>{let[r,{kind:i,id:o}]=n;switch(i){case ue.VIDEO:return void(r._videoSSRC&&t.push({stream_type:ue.VIDEO,ssrcId:r._videoSSRC}));case ue.AUDIO:return void(r._audioSSRC&&t.push({stream_type:ue.AUDIO,ssrcId:r._audioSSRC}))}}),t}withdrawRemoteTracks(e){e.forEach(t=>{let[n,{kind:r}]=t;const i=this.remoteUserMap.get(n);i&&(i.delete(r),Array.from(i.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(e){const t=this.localTrackMap.get($.LocalVideoTrack),n=this.localTrackMap.get($.LocalVideoLowTrack);t&&(await t.track.setBitrateLimit(e.uplink),await new se((r,i)=>{this.handleUpdateVideoEncoder(t.track,r,i,!0)})),n&&e.low_stream_uplink&&(await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0}),await new se((r,i)=>{this.handleUpdateVideoEncoder(n.track,r,i,!0)}))}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return e!=="connected"&&t!=="connected"}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof Zt){const n=this.filterTobeUnmutedTracks(e[t]);if(n.length===0)continue;const r=this.createUnmuteMessage(n);return void await Ot(this,Se.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(e=>{let[,{ssrcs:t}]=e;return!!t}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.recvConnection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(Se.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(Se.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await In(O_(this.dtlsFailedCount,an)),this.emit(Se.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has($.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof wt)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof wt).length>1)throw new W(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof Zt).length>1&&(e.some(t=>t instanceof Zt&&t._bypassWebAudio)||!Xe().webAudioMediaStreamDest))throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof wt&&this.pendingLocalTracks.some(n=>n instanceof wt))throw new W(b.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof Zt&&this.pendingLocalTracks.some(n=>n instanceof Zt)&&(!Xe().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof Zt&&n._bypassWebAudio)))throw new W(b.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const n=!w("DISABLE_DUAL_STREAM_USE_ENCODING")&&Xe().supportDualStreamEncoding,r=zm(zm({},{width:160,height:120,framerate:15,bitrate:50}),t);let i;i=n?e._mediaStreamTrack.clone():ty(e,r);const o=_t(8,"track-low-"),s=new wt(i,zm(zm({},n&&{scaleResolutionDownBy:DR(r,e)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return s.on(xc.TRANSCEIVER_UPDATED,c=>{e._updateRtpTransceiver(c,pl.LOW_STREAM)}),s._hints.push(pt.LOW_STREAM),e.addListener(me.NEED_CLOSE,()=>{s.close()}),s}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,n,r){var i;const o=Array.from(ar(i=this.remoteUserMap).call(i)).find(s=>s._videoSSRC===e);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());const s=this.store.keyMetrics,c=s.subscribe.find(l=>l.userId===o.uid&&l.type==="video");pe.firstRemoteVideoDecode(this.store.sessionId,_n.FIRST_VIDEO_DECODE,Bt.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:t,videoheight:n,subscribeElapse:tr.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:(c==null?void 0:c.subscribeEnd)||0,subscriberStart:(c==null?void 0:c.subscribeStart)||0,videoAddNotify:(c==null?void 0:c.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.recvConnection)return!1;const r=this.remoteUserMap.get(e);if(!r)return!1;const i=r.get(t);if(!i)return!1;const o=await this.recvConnection.getRemoteSSRC(i);return o!==void 0&&o!==n}isPreSubScribe(e){return!1}async publishDataChannel(e){throw new W(b.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new W(b.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new W(b.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new W(b.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new W(b.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new W(b.NOT_SUPPORTED)}async preConnect(e){throw new W(b.NOT_SUPPORTED)}getEstablishParams(){throw new W(b.NOT_SUPPORTED)}async reSubscribe(e){throw new W(b.NOT_SUPPORTED)}reportVideoFirstFrameRender(e){}async updateVideoStreamParameter(e,t){throw new W(b.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:n}]=e;t===$.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,pl.LOW_STREAM):n._updateRtpTransceiver(void 0)})}},ae(Ht.prototype,"p2pConnect",[ex],Object.getOwnPropertyDescriptor(Ht.prototype,"p2pConnect"),Ht.prototype),ae(Ht.prototype,"unpublish",[tx],Object.getOwnPropertyDescriptor(Ht.prototype,"unpublish"),Ht.prototype),ae(Ht.prototype,"unpublishLowStream",[nx],Object.getOwnPropertyDescriptor(Ht.prototype,"unpublishLowStream"),Ht.prototype),ae(Ht.prototype,"subscribe",[rx],Object.getOwnPropertyDescriptor(Ht.prototype,"subscribe"),Ht.prototype),ae(Ht.prototype,"mockSubscribe",[ix],Object.getOwnPropertyDescriptor(Ht.prototype,"mockSubscribe"),Ht.prototype),ae(Ht.prototype,"unsubscribe",[ox],Object.getOwnPropertyDescriptor(Ht.prototype,"unsubscribe"),Ht.prototype),ae(Ht.prototype,"muteRemote",[sx],Object.getOwnPropertyDescriptor(Ht.prototype,"muteRemote"),Ht.prototype),ae(Ht.prototype,"unmuteRemote",[ax],Object.getOwnPropertyDescriptor(Ht.prototype,"unmuteRemote"),Ht.prototype),ae(Ht.prototype,"hasRemoteMediaWithLock",[cx],Object.getOwnPropertyDescriptor(Ht.prototype,"hasRemoteMediaWithLock"),Ht.prototype),ae(Ht.prototype,"disconnectForReconnect",[dx],Object.getOwnPropertyDescriptor(Ht.prototype,"disconnectForReconnect"),Ht.prototype),ae(Ht.prototype,"remoteMediaSsrcChanged",[lx],Object.getOwnPropertyDescriptor(Ht.prototype,"remoteMediaSsrcChanged"),Ht.prototype),Ht);function Ko(e){return function(t,n,r){const i=t[n];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){for(var o=arguments.length,s=new Array(o),c=0;c<o;c++)s[c]=arguments[c];switch(e){case Ho.SEND_ONLY:{const l=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await i.apply(this,s)}finally{l()}}case Ho.RECEIVE_ONLY:{const l=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await i.apply(this,s)}finally{l()}}default:{const l=await this.sendMutex.lock("From P2PChannel2.".concat(n)),u=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await i.apply(this,s)}finally{l(),u()}}}},r}}class id extends Wt{constructor(t,n){super(),y(this,"signal",void 0),y(this,"token",void 0),y(this,"tokenTimeout",void 0),y(this,"tokenInterval",void 0),y(this,"_sequence",0),y(this,"userMap",new Map),y(this,"encoder",new TextEncoder),this.signal=t,this.token=n;const r=()=>{this.signal.connectionState===$e.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(r,1e3):this.tokenInterval=window.setTimeout(r,3*w("P2P_TOKEN_INTERVAL"))};r()}async send(t,n,r,i,o){var s;if(this.userMap.size===0)return;const c=Array.from($r(s=this.userMap).call(s))[0].token;typeof n!="string"&&(n=JSON.stringify(n)),i=i??_t(6,""),o=o??this._sequence++;const l={_id:i,_type:t,_seq:o,_message:n,token:"".concat(this.token,"_").concat(c)};w("SHOW_P2P_LOG")&&g.debug("send message",l,"noNeedResponse : ".concat(r)),this.splitMessage(JSON.stringify(l)).forEach(h=>{this.signal.request(ge.DATA_STREAM,{payload:Ra(this.encoder.encode(h))})});const u=new se((h,f)=>{const _=window.setTimeout(()=>{this.off("res-@".concat(i,"_ack"),E),this.off("res-@".concat(i),v),this.off(Il.ABORT,I),g.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(i)),this.userMap.size===0?f(new W(b.INVALID_REMOTE_USER)):f(new W(b.TIMEOUT))},w("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),E=()=>{_&&window.clearTimeout(_),this.off(Il.ABORT,I),r&&h()},I=()=>{_&&window.clearTimeout(_),this.off("res-@".concat(i,"_ack"),E),this.off("res-@".concat(i),v),f(new W(b.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(i)))};this.once(Il.ABORT,I),this.once("res-@".concat(i,"_ack"),E);const v=(A,O)=>{R=!0,_&&window.clearTimeout(_),this.off("res-@".concat(i,"_ack"),E),this.off(Il.ABORT,I),A==="success"?h(O):f(new W(b.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(i)))};let R=!1;r||(this.once("res-@".concat(i),v),In(w("SIGNAL_REQUEST_TIMEOUT")).then(()=>{R||g.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(i,", ").concat(l))}))});try{return await u}catch(h){if(h.code===b.TIMEOUT)return await this.send(t,n,r,i,o);throw h}}onMessage(t){var n;const{_uid:r}=t;let i,o=this.userMap.get(r);if(o)i=o.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==rn.CHECK)return;const{token:u}=t;i=new Map,o={uid:r,isStart:!0,token:u,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(r,o),this.signal.emit(Pe.ON_USER_ONLINE,{uid:r}),this.handleUserOnline()}if("id"in t&&"total"in t){var s;const{id:u,total:h}=t,f=(s=i.get(u))!==null&&s!==void 0?s:[];if(f.push(t),i.has(u)||i.set(u,f),f.length!==h)return;{const _=gc(f).call(f,(E,I)=>E.index-I.index).map(E=>E.payload).join("");i.delete(u),(t=JSON.parse(_))._uid=r}}const{_type:c,token:l}=t;if(Z(n=[rn.ACK,rn.CHECK]).call(n,c))return c===rn.CHECK&&this.handleCheckToken(o,l),void this.receiveMessage(t);l==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(t):g.debug('Receive unexpected message", '.concat(l,", cur_token: ").concat(o.token,"_").concat(this.token),t)}check(){const t={_id:_t(6,""),token:this.token,_type:rn.CHECK};w("SHOW_P2P_LOG")&&g.debug("send message",t),this.signal.request(ge.DATA_STREAM,{payload:Ra(this.encoder.encode(JSON.stringify(t)))})}ack(t){const n={_id:t,_type:rn.ACK,token:this.token};w("SHOW_P2P_LOG")&&g.debug("send message",n),this.signal.request(ge.DATA_STREAM,{payload:Ra(this.encoder.encode(JSON.stringify(n)))})}response(t,n,r){this.send(rn.RESPONSE,JSON.stringify({success:!r,message:n}),!0,t)}handleReceivedMessage(t){const n=()=>{this.userMap.forEach(u=>{const{receivedMessagesMap:h,nextExpectedSequenceNumber:f}=u;for(;h.has(f);){const _=h.get(f);h.delete(f),this.receiveMessage(_),u.nextExpectedSequenceNumber++}})};if(!t)return void n();const{_uid:r,_seq:i}=t,o=this.userMap.get(r),{receivedMessagesMap:s,isStart:c,nextExpectedSequenceNumber:l}=o;if(i<l)return this.ack(t._id),void g.debug("[external-signal] receive old message, seq: ".concat(i,", ").concat(t._message));s.set(i,t),c&&i===l&&(this.receiveMessage(t),s.delete(l),o.nextExpectedSequenceNumber++,n())}receiveMessage(t){const{_id:n,_type:r,_message:i,_uid:o}=t;if(w("SHOW_P2P_LOG")&&g.debug("receive message",t),n){let s;switch(t._type!==rn.ACK&&(i&&(s=JSON.parse(i)),this.ack(t._id)),t._type){case rn.CANDIDATE:case rn.CONTROL:this.signal.emit(r,s,o);break;case rn.PUBLISH:case rn.UNPUBLISH:case rn.RESTART_ICE:case rn.CALL:s.uid=o,hn(this.signal,r,s).then(c=>{this.response(t._id,c)}).catch(()=>{this.response(t._id,void 0,!0)});break;case rn.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case rn.RESPONSE:{const{success:c,message:l}=s;this.emit("res-@".concat(n),c?"success":"failed",l);break}}}}splitMessage(t){if(t.length<id.MAX_MESSAGE_SIZE)return[t];const n=[],{remoteToken:r}=JSON.parse(t),i=_t(6,"");let o=0,s=800;const c=Math.ceil(t.length/s);for(;t.length>0;){o++;const l={id:i,index:o,total:c,payload:t.slice(0,s),token:"".concat(this.token,"_").concat(r)};JSON.stringify(l).length>id.MAX_MESSAGE_SIZE?s-=50:(n.push(l),t=t.slice(s))}return n.map(l=>JSON.stringify(l))}handleCheckToken(t,n){return t.token!==n?(g.debug("token changed, from ".concat(t.token," to ").concat(n)),this.reset(t.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{g.debug("token timeout, ".concat(n)),this.reset(t.uid)},w("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const t=await hn(this.signal,rn.CALL,void 0),n=await this.send(rn.CALL,t);this.signal.emit(Ee.P2P_CONNECTION,n,!0)}async reset(t,n){const r=this.userMap.get(t);r&&(this.emit(Il.ABORT),this.signal.emit(Pe.ON_USER_OFFLINE,{uid:r.uid,reason:lX.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(g.debug("change local token from ".concat(n," to ").concat(n)),this.token=_t(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Il.ABORT)}}y(id,"MAX_SIZE",1),y(id,"MAX_MESSAGE_SIZE",1024);class XQ extends Wt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===$e.CONNECTED?this.emit(Ee.WS_CONNECTED):t===$e.RECONNECTING?this.emit(Ee.WS_RECONNECTING,this._websocketReconnectReason):t===$e.CLOSED&&this.emit(Ee.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,n){super(),y(this,"__name__","P2PSignal"),y(this,"_disconnectedReason",void 0),y(this,"_websocketReconnectReason",void 0),y(this,"_connectionState",$e.CLOSED),y(this,"reconnectToken",void 0),y(this,"p2pToken",void 0),y(this,"websocket",void 0),y(this,"openConnectionTime",void 0),y(this,"clientId",void 0),y(this,"lastMsgTime",Date.now()),y(this,"uploadCache",[]),y(this,"uploadCacheInterval",void 0),y(this,"rttRolling",new kv(5)),y(this,"pingpongTimer",void 0),y(this,"pingpongTimeoutCount",0),y(this,"joinResponse",void 0),y(this,"multiIpOption",void 0),y(this,"initError",void 0),y(this,"spec",void 0),y(this,"store",void 0),y(this,"_external_signal",void 0),y(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(Ee.ON_BINARY_DATA,r.data);const i=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const o="res-@".concat(i._id);this.emit(o,i._result,i._message)}else if(Object.prototype.hasOwnProperty.call(i,"_type")){switch(i._type){case Pe.ON_DATA_STREAM:return void this.handleDataStream(i._message);case Pe.MUTE_AUDIO:case Pe.MUTE_VIDEO:case Pe.ON_P2P_LOST:case Pe.ON_USER_ONLINE:return;case Pe.ON_USER_OFFLINE:const{uid:o}=i._message;return g.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(i._type,i._message),i._type===Pe.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===Pe.ON_USER_BANNED)switch(i._message.error_code){case 14:this.close(Ze.UID_BANNED);break;case 15:this.close(Ze.IP_BANNED);break;case 16:this.close(Ze.CHANNEL_BANNED)}if(i._type===Pe.ON_USER_LICENSE_BANNED)switch(i._message.error_code){case Re.ERR_LICENSE_MISSING:this.close(Ze.LICENSE_MISSING);break;case Re.ERR_LICENSE_EXPIRED:this.close(Ze.LICENSE_EXPIRED);break;case Re.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ze.LICENSE_MINUTES_EXCEEDED);break;case Re.ERR_LICENSE_PERIOD_INVALID:this.close(Ze.LICENSE_PERIOD_INVALID);break;case Re.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ze.LICENSE_MULTIPLE_SDK_SERVICE);break;case Re.ERR_LICENSE_ILLEGAL:this.close(Ze.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new bR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,w("JOIN_GATEWAY_USE_DUAL_DOMAIN"),w("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===$e.CONNECTED&&this.reconnect("retry",zn.OFFLINE)}),this.p2pToken=_t(6,""),this._external_signal=new id(this,this.p2pToken)}async request(t,n,r,i){const o=_t(6,""),s={_id:o,_type:t,_message:n},c=this.websocket.connectionID,l=()=>new se((I,v)=>{if(this.connectionState===$e.CONNECTED)return I();const R=()=>{this.off(Ee.WS_CLOSED,A),I()},A=()=>{this.off(Ee.WS_CONNECTED,R),v(new W(b.WS_ABORT))};this.once(Ee.WS_CONNECTED,R),this.once(Ee.WS_CLOSED,A)});if(this.connectionState!==$e.CONNECTING&&this.connectionState!==$e.RECONNECTING||t===ge.JOIN||t===ge.REJOIN||await l(),this.websocket.sendMessage(s,!0),i)return;const u=new se((I,v)=>{let R=!1;const A=(P,M)=>{R=!0,I({isSuccess:P==="success",message:M||{}}),this.off(Ee.WS_CLOSED,O),this.off(Ee.WS_RECONNECTING,O),this.emit(Ee.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(o),A);const O=()=>{v(new W(b.WS_ABORT,"type: ".concat(t))),this.off(Ee.WS_CLOSED,O),this.off(Ee.WS_RECONNECTING,O),this.off("res-@".concat(o),A)};this.once(Ee.WS_CLOSED,O),this.once(Ee.WS_RECONNECTING,O),In(w("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==c||R||(g.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(Ee.REQUEST_TIMEOUT,t,n))})});let h=null;try{h=await u}catch(I){if(this.connectionState===$e.CLOSED||t===ge.LEAVE)throw new W(b.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?I.throw():t===ge.JOIN||t===ge.REJOIN?null:(await l(),await this.request(t,n))}if(h.isSuccess)return h.message;const f=Number(h.message.error_code||h.message.code),_=Kc(f),E=new W(b.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(h.message.error_str),{code:f,data:h.message,desc:_.desc});return _.action==="success"?h.message:(g.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(f,", message: ").concat(_.desc,", action: ").concat(_.action)),f===Re.ERR_TOO_MANY_BROADCASTERS?((t===ge.JOIN||t===ge.REJOIN)&&(this.initError=E,this.close()),E.throw()):_.action==="failed"?E.throw():_.action==="quit"?(this.initError=E,this.close(),E.throw()):(f===Re.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,g.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",zn.MULTI_IP)):this.reconnect(_.action,zn.SERVER_ERROR),t===ge.JOIN||t===ge.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new se(r=>{const i=o=>{(!n||n(o))&&(this.off(t,i),r(o))};this.on(t,i)})}uploadWRTCStats(t){if(!this.store.sessionId)return void g.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Hc.WRTC_STATS,n)}upload(t,n){const r={_type:t,_message:n};try{this.websocket.sendMessage(r)}catch{const o=w("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==$e.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},w("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,n){const r={_type:t,_message:n};this.websocket.sendMessage(r)}async sendExtensionMessage(t,n,r){return await this._external_signal.send(t,n,r)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new se((n,r)=>{this.once(Ee.WS_CONNECTED,()=>n(this.joinResponse)),this.once(Ee.WS_CLOSED,()=>r(this.initError||new W(b.WS_ABORT))),this.connectionState=$e.CONNECTING,this.websocket.init(t).catch(r)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||Ze.LEAVE,this.connectionState=$e.CLOSED,g.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=_t(6,""),this._external_signal.clear(),this._external_signal=new id(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(Ee.ABORT_P2P_EXECUTION);const t=await hn(this,Ee.REQUEST_JOIN_INFO),n=await this.request(ge.JOIN,t);if(!n)return this.emit(Ee.REPORT_JOIN_GATEWAY,b.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(Ee.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=$e.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}async downgradeCodec(t){return!1}handleDataStream(t){try{var n;const r=Pc(t.payload),i=new TextDecoder().decode(r),o=JSON.parse(i);"total"in o&&"id"in o||Z(n=Object.values(rn)).call(n,o._type)?(o._uid=t.uid,this._external_signal.onMessage(o)):this.emit(Pe.ON_DATA_STREAM,t)}catch{this.emit(Pe.ON_DATA_STREAM,t)}}handleNotification(t){g.debug("[".concat(this.clientId,"] receive notification: "),t);const n=Kc(t.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?t.code===Re.ERR_REPEAT_JOIN_CHANNEL&&w("IGNORE_UID_CHECK")?void this.close(Ze.UID_CONFLICT):(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ze.UID_BANNED),void this.close()):void this.reconnect(n.action,zn.SERVER_ERROR);g.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=w("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(g.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>w("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",zn.TIMEOUT):this.request(ge.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-n;this.rttRolling.add(r),w("REPORT_STATS")&&this.send(ge.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWebsocketEvents(){this.websocket.on(Fe.RECONNECT_CREATE_CONNECTION,t=>{this.emit(Ee.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(Fe.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Fe.CLOSED,()=>{this.connectionState=$e.CLOSED}),this.websocket.on(Fe.FAILED,()=>{this._disconnectedReason=Ze.NETWORK_ERROR,this.connectionState=$e.CLOSED}),this.websocket.on(Fe.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===$e.CONNECTED?this.connectionState=$e.RECONNECTING:this.connectionState=$e.CONNECTING}),this.websocket.on(Fe.WILL_RECONNECT,(t,n,r)=>{t!=="retry"?(g.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0):g.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),r(t)}),this.websocket.on(Fe.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(t=>{if(this.emit(Ee.REPORT_JOIN_GATEWAY,t,this.url||""),t instanceof W&&t.code===b.UNEXPECTED_RESPONSE&&t.data.code===Re.ERR_NO_AUTHORIZED)return g.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",zn.SERVER_ERROR);g.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",zn.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(Fe.REQUEST_NEW_URLS,(t,n)=>{hn(this,Ee.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)}),this.websocket.on(Fe.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Pe.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}const JQ={name:"P2PChannel",create:function(e){let{store:t,statsCollector:n}=e;return new qQ(t,n)},createSubmodule:function(e){let{store:t,spec:n}=e;return new XQ(n,t)}};function hx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function px(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?hx(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):hx(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}class QQ{constructor(t){y(this,"sessionDesc",void 0),y(this,"localCapabilities",void 0),y(this,"rtpCapabilities",void 0),y(this,"candidates",void 0),y(this,"_originCandidates",void 0),y(this,"iceParameters",void 0),y(this,"dtlsParameters",void 0),y(this,"setup",void 0),y(this,"currentMidIndex",void 0),y(this,"cname",void 0),t=Mt(t);const{iceParameters:n,dtlsParameters:r,candidates:i,rtpCapabilities:o,setup:s,localCapabilities:c,sdkCodec:l,cname:u}=t,h=gr(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=o,this.candidates=i,this._originCandidates=Mt(i),this.iceParameters=n,this.dtlsParameters=r,this.setup=s,this.localCapabilities=c,this.cname=u;for(let f=0;f<h.mediaDescriptions.length;f++){const _=h.mediaDescriptions[f];if(_.attributes.iceUfrag=n.iceUfrag,_.attributes.icePwd=n.icePwd,_.attributes.fingerprints=r.fingerprints,_.attributes.candidates=i,_.attributes.setup=s,_.media.mediaType==="video"){_.media.fmts=o.videoCodecs.map(v=>v.payloadType.toString(10));const E=o.videoCodecs.filter(v=>{var R,A;return(R=v.rtpMap)===null||R===void 0?void 0:Z(A=R.encodingName.toLowerCase()).call(A,l)}),I=o.videoCodecs.filter(v=>!Z(E).call(E,v));_.attributes.payloads=[...E,...I],_.attributes.extmaps=o.videoExtensions}_.media.mediaType==="audio"&&(_.media.fmts=o.audioCodecs.map(E=>E.payloadType.toString(10)),_.attributes.payloads=o.audioCodecs,_.attributes.extmaps=o.audioExtensions),h.mediaDescriptions[f]=this.mungMediaDesc(_)}this.sessionDesc=h,this.currentMidIndex=h.mediaDescriptions.length-1}toString(){return js(this.sessionDesc)}send(t,n,r){const{ssrcs:i,ssrcGroups:o}=bh(n,this.cname),s=this.sessionDesc.mediaDescriptions.find(u=>t===ue.VIDEO?u.media.mediaType==="video":u.media.mediaType==="audio"),c=i[0].attributes.label,l=i[0].attributes.mslabel;return s.attributes.ssrcs=s.attributes.ssrcs.concat(i),s.attributes.ssrcGroups=s.attributes.ssrcGroups.concat(o),{id:c,mslabel:l}}batchSend(t){return t.map(n=>{let{kind:r,ssrcMsg:i}=n;return this.send(r,i,void 0)})}stopSending(t){this.sessionDesc.mediaDescriptions.forEach(n=>{const r=[],i=[],o=[];n.attributes.ssrcs.forEach(s=>{Z(t).call(t,s.attributes.label||"")?o.push(s):r.push(s)}),n.attributes.ssrcGroups.forEach(s=>{var c;Z(c=o.map(l=>l.ssrcId)).call(c,s.ssrcIds[0])||i.push(s)}),n.attributes.ssrcs=r,n.attributes.ssrcGroups=i})}mute(t){const n=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===t);if(!n)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(t){const n=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===t);if(!n)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}receive(t,n,r){t.forEach((i,o)=>{const s=i._mediaStreamTrack,c=this.sessionDesc.mediaDescriptions.findIndex(u=>u.attributes.mid===s.kind),l=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[c],i);this.sessionDesc.mediaDescriptions[c]=l})}stopReceiving(t){}updateCandidates(t){const n=this._originCandidates.filter(i=>i.transport==="udp"),r=[];if(n.forEach(i=>{r.push(px(px({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))}),n.length!==0){switch(t){case kn.TCP_RELAY:this.candidates=r;break;case kn.UDP_TCP_RELAY:case kn.RELAY:this.candidates=[...n,...r];break;default:this.candidates=n}for(const i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}}restartICE(t){t=Mt(t),this.iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(n=>{n.attributes.iceUfrag=t.iceUfrag,n.attributes.icePwd=t.icePwd})}predictReceivingMids(t){const n=[];for(let r=0;r<t;r++)n.push((this.currentMidIndex+r+1).toString(10));return n}mungRecvMediaDsec(t,n){const r=Mt(t);return Yc(r,n),kR(r,n),r}updateRecvMedia(t,n){const r=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===t);if(r!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[r],n);this.sessionDesc.mediaDescriptions[r]=i}}bumpMid(t){this.currentMidIndex+=t}updateTrackLabel(t,n,r){const i=this.sessionDesc.mediaDescriptions.find(s=>t===ue.VIDEO?s.attributes.mid==="video":s.attributes.mid==="audio");if(i){const s=i.attributes.ssrcs.find(c=>c.attributes.label===n);var o;s&&(s.attributes.label=r,(o=s.attributes.msid)===null||o===void 0||o.replace(n,r))}}mungMediaDesc(t){const n=Mt(t);return LR(n),function(r){const i=r.attributes.extmaps.find(o=>lm(o.extensionName));i&&r.attributes.extmaps.splice(r.attributes.extmaps.indexOf(i),1),r.attributes.payloads.forEach(o=>{const s=o.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");s!==-1&&o.rtcpFeedbacks.splice(s,1)})}(n),n}getSSRC(t){for(const n of this.sessionDesc.mediaDescriptions)for(const r of n.attributes.ssrcs)if(r.attributes.label===t)return[r]}}var Nt;function fx(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function qm(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?fx(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):fx(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}let ZQ=(Nt=class _p extends om{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var n;return Z(n=Object.keys(Mc)).call(n,t)}))]}constructor(t,n){super(t,n),y(this,"store",void 0),y(this,"peerConnection",void 0),y(this,"remoteSDP",void 0),y(this,"initialOffer",void 0),y(this,"statsFilter",void 0),y(this,"useRTX",!1),y(this,"localCapabilities",void 0),y(this,"localCandidateCount",0),y(this,"allCandidatesReceived",!1),y(this,"establishPromise",void 0),y(this,"mutex",void 0),this.store=n,this.mutex=new Ln("P2PConnection-mutex",n.clientId),this.peerConnection=new RTCPeerConnection(_p.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=L_(this.peerConnection,w("STATS_UPDATE_INTERVAL"),void 0,kt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=Es(t.sdp),r=Ah(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:w("FILTER_VIDEO_FEC"),filterAudioFec:w("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=r,this.initialOffer=t,qm(qm({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:r},offerSDP:t.sdp})}catch(t){throw new W(b.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async updateRemoteConnect(){}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new QQ(qm(qm({},t),{},{rtpCapabilities:t.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));const n=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async updateRemoteRTPCapabilities(t,n){throw new W(b.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}getPreMedia(t){}send(t,n){var r=this;return Ar(function*(){const i=yield We(r.mutex.lock());try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=t.map(_=>r.peerConnection.addTrack(_._mediaStreamTrack)),s=yield We(r.peerConnection.createOffer()),c=gr(s.sdp),l=t.map(_=>{const E=_._mediaStreamTrack,I=c.mediaDescriptions.find(v=>v.attributes.mid===E.kind);if(!I)throw new Error("Cannot extract ssrc from mediaDescription.");return function(v,R,A){const O=v.attributes.ssrcs.filter(M=>M.attributes.label===R),P=v.attributes.ssrcGroups;if(O.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(P&&O.length>1){const M=P.find(U=>U.ssrcIds.indexOf(O[0].ssrcId)!==-1);return M?[{ssrcId:M.ssrcIds[0],rtx:A?M.ssrcIds[1]:void 0}]:[{ssrcId:O[0].ssrcId}]}return[{ssrcId:O[0].ssrcId}]}(I,E.id,r.useRTX)});let u;try{u=yield l}catch(_){throw o.forEach(E=>{Pn()&&E.replaceTrack(null),r.peerConnection.removeTrack(E)}),_}const h=r.mungSendOfferSDP(s.sdp,t);r.remoteSDP.receive(t,n,u);const f=r.remoteSDP.toString();return yield We(r.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield We(r.applySendEncodings(o,t)),yield We(r.peerConnection.setRemoteDescription({type:"answer",sdp:f})),t.map((_,E)=>{const I=_._mediaStreamTrack.id;return{localSSRC:l[E],id:I}})}catch(o){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{i()}})()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const n=this.peerConnection.getSenders().filter(o=>{var s;return t.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map(o=>{Pn()&&o.replaceTrack(null),this.peerConnection.removeTrack(o)});const r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r),this.remoteSDP.stopReceiving(t);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(t,n,r,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:o,mslabel:s}=this.remoteSDP.send(t,n,i),c=new se((h,f)=>{const _=setTimeout(()=>{f(new Error("Cannot receive track, id: ".concat(o)))},1e4),E=I=>{const v=ot();if((v.name==="Safari"&&Number(v.version)===11||sr())&&I.track.id!==o&&I.streams[0].id===s){var R;const A=I.streams[0].getTracks()[0];return(R=this.remoteSDP)===null||R===void 0||R.updateTrackLabel(t,o,I.track.id),this.peerConnection.removeEventListener("track",E),clearTimeout(_),void h(A)}if(I.track.id===o)return this.peerConnection.removeEventListener("track",E),clearTimeout(_),void h(I.track)};this.peerConnection.addEventListener("track",E)}),l=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:l});const u=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(u),{track:await c,id:o}}catch(o){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(r=>{var i;return t.indexOf(((i=r.track)===null||i===void 0?void 0:i.id)||"")!==-1});if(n.length!==t.length)throw new Error("sender' length doesn't match mids' length.");n.map(r=>{if(Pn()&&r.track)r.track.enabled=!1;else{const i=r.getParameters();i.encodings.forEach(o=>o.active=!1),r.setParameters(i)}})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(o=>{var s;return t.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");n.map(async o=>{if(Pn()&&o.track)o.track.enabled=!0;else{const s=o.getParameters();s.encodings.forEach(c=>c.active=!0),await o.setParameters(s)}});const r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r);const i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return Ar(function*(){const r=yield We(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const i=Xe().supportPCSetConfiguration;if(t===kn.RELAY&&!i)return;if(i){const u=n.peerConnection.getConfiguration(),h=t===kn.RELAY?"relay":"all";u.iceTransportPolicy!==h&&(g.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(u.iceTransportPolicy,"] to [").concat(h,"]")),u.iceTransportPolicy=h,n.peerConnection.setConfiguration(u))}t!==kn.RELAY&&n.remoteSDP.updateCandidates(t);const o=yield We(n.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const s=Es(o.sdp),{remoteIceParameters:c}=yield s.iceParameters;n.remoteSDP.restartICE(c);const l=n.remoteSDP.toString();yield We(n.peerConnection.setLocalDescription(o)),yield We(n.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(i){g.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),i)}finally{r()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(r.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);const o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new W(b.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,n){const r=this.peerConnection.getSenders().filter(i=>{var o;return((o=i.track)===null||o===void 0?void 0:o.id)===t});r.length===1&&await this.applySendEncodings(r,[n])}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const r=this.peerConnection.getSenders().find(i=>{var o;return((o=i.track)===null||o===void 0?void 0:o.id)===n});r&&await r.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,n){throw new W(b.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new W(b.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,g.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,g.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},w("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(bc(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(..._p.turnServerConfigToIceServers(t.turnServer.servers)),w("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(..._p.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach(r=>{r.security?r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),n}async updateRtpSenderEncodings(t,n){var r;if(n||(n=this.peerConnection.getSenders().find(u=>{var h;return((h=u.track)===null||h===void 0?void 0:h.id)===t._mediaStreamTrack.id})),!n)return g.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!Xe().supportSetRtpSenderParameters)return g.warn("Browser not support set rtp-sender parameters");const i={},o={};if(t instanceof wt)switch(t._optimizationMode){case"motion":i.degradationPreference="maintain-framerate";break;case"detail":i.degradationPreference="maintain-resolution";break;default:i.degradationPreference="balanced"}if(w("DSCP_TYPE")&&us()){var s;const u=w("DSCP_TYPE");Z(s=["very-low","low","medium","high"]).call(s,u)&&(o.networkPriority=u)}const c=n.getParameters(),l=(r=c.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,o),Object.assign(c,i),g.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),await n.setParameters(c)}async applySendEncodings(t,n){try{if(!Xe().supportSetRtpSenderParameters||t.length!==n.length)return;for(let r=0;r<t.length;r++){const i=t[r],o=n[r];i&&o&&await this.updateRtpSenderEncodings(o,i)}}catch{g.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n){const r=gr(t);return n.forEach((i,o)=>{const s=i._mediaStreamTrack,c=r.mediaDescriptions.find(l=>l.attributes.mid===s.kind);c&&Yc(c,i)}),js(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,r)=>{var i;(i=this.onFirstVideoDecoded)===null||i===void 0||i.call(this,t,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const n=this.remoteSDP.batchSend(t).map((o,s)=>{let{id:c,mslabel:l}=o;const{kind:u}=t[s];return new se((h,f)=>{const _=setTimeout(()=>{f(new Error("Cannot receive track, id: ".concat(c)))},1e4),E=I=>{const v=ot();if(v.name==="Safari"&&Number(v.version)===11&&I.track.id!==c&&I.streams[0].id===l){var R;const A=I.streams[0].getTracks()[0];return(R=this.remoteSDP)===null||R===void 0||R.updateTrackLabel(u,c,I.track.id),this.peerConnection.removeEventListener("track",E),clearTimeout(_),void h({track:A,id:c})}if(I.track.id===c)return this.peerConnection.removeEventListener("track",E),clearTimeout(_),void h({track:I.track,id:c})};this.peerConnection.addEventListener("track",E)})}),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const i=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(i),await se.all(n)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n==null?void 0:n[0].ssrcId}setConfiguration(t){if(Xe().supportPCSetConfiguration){const n=_p.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}}},ae(Nt.prototype,"connect",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"connect"),Nt.prototype),ae(Nt.prototype,"stopSending",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"stopSending"),Nt.prototype),ae(Nt.prototype,"receive",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"receive"),Nt.prototype),ae(Nt.prototype,"stopReceiving",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"stopReceiving"),Nt.prototype),ae(Nt.prototype,"muteRemote",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"muteRemote"),Nt.prototype),ae(Nt.prototype,"unmuteRemote",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"unmuteRemote"),Nt.prototype),ae(Nt.prototype,"muteLocal",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"muteLocal"),Nt.prototype),ae(Nt.prototype,"unmuteLocal",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"unmuteLocal"),Nt.prototype),ae(Nt.prototype,"close",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"close"),Nt.prototype),ae(Nt.prototype,"updateEncoderConfig",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"updateEncoderConfig"),Nt.prototype),ae(Nt.prototype,"updateSendParameters",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"updateSendParameters"),Nt.prototype),ae(Nt.prototype,"replaceTrack",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"replaceTrack"),Nt.prototype),ae(Nt.prototype,"getRemoteSSRC",[ji],Object.getOwnPropertyDescriptor(Nt.prototype,"getRemoteSSRC"),Nt.prototype),Nt);function ji(e,t,n){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("Locking from P2PConnection.".concat(t));try{for(var s=arguments.length,c=new Array(s),l=0;l<s;l++)c[l]=arguments[l];return await r.apply(this,c)}finally{o()}},n}const $Q={name:"PlanBConnection",create:function(e){let{store:t,spec:n}=e;return new ZQ(n,t)}},eZ={interceptLocalAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Xe().supportWebRTCEncodedTransform)return void g.warning("browser not support audio encoded transform");if(Y_.has(e)||!e.track)return;const n={track:e.track};if(Fs()){if(!e.createEncodedStreams)return void g.warning("browser not support createEncodedStreams() API");let i=null;try{i=e.createEncodedStreams()}catch(s){return void g.error("create audio-encoded-streams error",s&&s.message)}const o=new TransformStream({transform(s,c){n.controller||(n.controller=c),e.track&&e.track.id!==n.track.id&&(g.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",r),n.track=e.track,n.track.addEventListener("ended",r));const l=t.metadata&&t.metadata();l?function(u,h){const{chunk:f,controller:_}=h,E=ya.METADATA;f.data=function(I,v,R){const A=R.byteLength,O=A+uR+a1,P=dR+lR+O,M=new ArrayBuffer(I.byteLength+P),U=new DataView(M);U.setUint8(0,s1),U.setUint16(1,O),U.setUint8(3,v),U.setUint16(4,A);for(let V=0;V<A;V++)U.setUint8(6+V,R[V]);const L=new Uint8Array(U.buffer);return L.set(new Uint8Array(I),P),L.buffer}(f.data,E,u),_.enqueue(f)}(l,{chunk:s,controller:c}):c.enqueue(s)}});i.readable.pipeThrough(o).pipeTo(i.writable)}else if(Pn()){if(typeof RTCRtpScriptTransform>"u")return void g.warning("browser not support RTCRtpScriptTransform");const i=K_(),o=new MessageChannel;await new se(c=>i.onmessage=l=>{l.data==="registered"&&c(void 0)});const s=new RTCRtpScriptTransform(i,{name:"audio-metadata-tx",port:o.port2},[o.port2]);e.transform=s,await new se(c=>i.onmessage=l=>{l.data==="started"&&c(void 0)}),o.port1.onmessage=c=>{var l;if(c.data.transformed&&e.track&&((l=e.track)===null||l===void 0?void 0:l.id)!==n.track.id)g.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",r),n.track=e.track,n.track.addEventListener("ended",r);else if(c.data.getMetadata){const u=t.metadata&&t.metadata();u&&o.port1.postMessage({metadata:u})}},n.worker=i}function r(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",r)}const i=Y_.get(e);if(i){Y_.delete(e);try{var o,s;(o=i.controller)===null||o===void 0||o.terminate(),(s=i.worker)===null||s===void 0||s.terminate()}catch(c){g.warning(c&&c.message)}}}Y_.set(e,n),e.track.addEventListener("ended",r)},interceptRemoteAudioFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Xe().supportWebRTCEncodedTransform)return void g.warning("browser not support audio encoded transform");if(Z_.has(e))return;const n={track:e.track,onMetadata:t.onMetadata,onPts:t.onPts};if(Fs()&&!sr()){if(!e.createEncodedStreams)return void g.warning("browser not support createEncodedStreams() API");Tv(at.CHROME,87,116)||(t.enableTopn=!1);let i=null;try{i=e.createEncodedStreams()}catch(s){return void g.error("create audio-encoded-streams error",s&&s.message)}const o=new TransformStream({transform(s,c){n.controller||(n.controller=c),e.track&&e.track.id!==n.track.id&&(g.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",r),n.track=e.track,n.track.addEventListener("ended",r)),t.enableTopn?function(l,u,h){var f;const _=hR(new DataView(u.data));if(!_)return h.enqueue(u);const E=l.track.id;Dq.set(E,l.track);const I=(f=_.tlv.find(M=>M.tag===ya.AUDIO_LEVEL))===null||f===void 0?void 0:f.value;let v=0;typeof I=="number"&&(v=127-I);const R=Math.round(Math.pow(10,v/60)-1),{selected:A,speaker:O}=function(M,U){let L=vl.get(M);if(L||(L=function(V){const H=new d1;return vl.set(V,H),Uo||(Uo=new Oq(w("TOPN_SILENCE_THRESHOLD")||500),Uo.on("ActiveSpeakerChanged",q=>{q!=null&&(X_=q)})),Uo.addSpeakers([H]),H}(M)),vl.size<=l1)return{selected:!0,speaker:L};if(!Uo)throw new Error("no active speaker detector");return Uo.levelChanged(L.id,U),jc=Uo.loudest.map(V=>V.id),X_&&!Z(jc).call(jc,X_)&&jc.length>=l1&&jc.pop(),{selected:Z(jc).call(jc,L.id)||L.id===X_,speaker:L}}(l,R),P=function(M,U,L){const V=xo.get(M)||new Nq(M,U);return V.score=L,xo.set(M,V),function(H){if(J_.set(H,!0),!Q_)return void(Q_=Date.now());const q=Date.now();q-Q_>1e3&&(J_.get(H)?J_.set(H,!1):(u1(H),J_.delete(H)),Q_=q)}(M),V}(E,l.track,O.energyScore);P.addSample(A),P.active&&(u.data=_.frame.buffer,h.enqueue(u))}(e,s,c):t.enableMetadata||t.enablePts?function(l,u,h,f){const _=new DataView(l.data),E=_.getUint8(0);let I;if(128&E&&E!==71){const A=function(O){if(O.byteLength<=0)return[];const P=[];let M=0;for(;M<O.byteLength;){const L=(128&O.getUint8(M))>>7,V=127&O.getUint8(M);if(!(L&&M+4<=O.byteLength)){M++;break}{const H=O.getUint32(M,!1),q=(16776192&H)>>10,de=1023&H;P.push({pt:V,ts_offset:q,length:de,data:new Uint8Array}),M+=4}}let U=O.byteLength-M;for(const L of P){if(L.length>U)return console.warn("Broken red payload"),[];L.length>0&&(L.data=new Uint8Array(O.buffer,O.byteOffset+M,L.length),M+=L.length,U-=L.length)}if(U>0){const L={pt:P.length>0?P[P.length-1].pt:0,ts_offset:0,length:U,data:new Uint8Array(O.buffer,O.byteOffset+M,U)};P.push(L)}return P}(_);if(A.length>0){const O=function(P){let M=0;for(let V=0;V<P.length;V++)M+=V<P.length-1?4:1,M+=P[V].length;const U=new Uint8Array(M);let L=0;for(let V=0;V<P.length;V++)if(V<P.length-1){const H=(2147483648|(127&P[V].pt)<<24|(262143&P[V].ts_offset)<<10|1023&P[V].length)>>>0;U[L++]=H>>24&255,U[L++]=H>>16&255,U[L++]=H>>8&255,U[L++]=255&H}else U[L++]=127&P[V].pt;for(const V of P)U.set(V.data,L),L+=V.length;return U}(A.map(P=>{const M=new Uint8Array(P.length);M.set(P.data);const U=hR(new DataView(M.buffer));return U!=null&&U.frame&&(P.data=U==null?void 0:U.frame),I=U,P}));l.data=O.buffer}}else I=hR(_),I&&(l.data=I.frame.buffer);if(u.enqueue(l),!I)return;const v=I.tlv.find(A=>A.tag===ya.METADATA);v&&h&&v.value instanceof Uint8Array&&h(v.value);const R=I.tlv.find(A=>A.tag===ya.AUDIO_64_BIT_PTS);R&&f&&R.value instanceof Uint8Array&&R.value.length==8&&f(new DataView(R.value.buffer).getBigUint64(0,!0))}(s,c,t.onMetadata,t.onPts):c.enqueue(s)}});i.readable.pipeThrough(o).pipeTo(i.writable)}else{if(typeof RTCRtpScriptTransform>"u")return void g.warning("browser not support RTCRtpScriptTransform");const i=K_(),o=new MessageChannel;await new se(c=>i.onmessage=l=>{l.data==="registered"&&c(void 0)});const s=new RTCRtpScriptTransform(i,{name:"audio-metadata-rx",port:o.port2},[o.port2]);e.transform=s,await new se(c=>i.onmessage=l=>{l.data==="started"&&c(void 0)}),o.port1.onmessage=c=>{var l;c.data.transformed&&e.track&&((l=e.track)===null||l===void 0?void 0:l.id)!==n.track.id?(g.debug("audio track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",r),n.track=e.track,n.track.addEventListener("ended",r)):c.data.metadata&&n.onMetadata?n.onMetadata(c.data.metadata):c.data.pts&&n.onPts&&n.onPts(c.data.pts)},n.worker=i}function r(){e.track.removeEventListener("ended",r),function(i){const o=Z_.get(i);if(o){(function(l){const u=vl.get(l);u&&(vl.delete(l),Uo&&(Uo.removeSpeakers([u]),vl.size===0&&(Uo.destroy(),Uo=null)))})(i),u1(i.track.id),Z_.delete(i);try{var s,c;(s=o.controller)===null||s===void 0||s.terminate(),(c=o.worker)===null||c===void 0||c.terminate()}catch(l){g.warning(l&&l.message)}}}(e)}Z_.set(e,n),e.track.addEventListener("ended",r)},interceptLocalVideoFrame:async function(e,t){if(!Xe().supportWebRTCEncodedTransform)return void g.warning("browser not support video encoded transform");if($_.has(e)||!e.track)return;const n={track:e.track};if(Fs()){if(!e.createEncodedStreams)return void g.warning("browser not support createEncodedStreams() API");let i=null;try{i=e.createEncodedStreams()}catch(c){return void g.error("create video-encoded-streams error",c&&c.message)}const o=[];t.on("sei-to-send",c=>{o.push(c)});const s=new TransformStream({transform(c,l){n.controller||(n.controller=l),e.track&&e.track.id!==n.track.id&&(g.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",r),n.track=e.track,n.track.addEventListener("ended",r));const u=f1(new Uint8Array(c.data)),h=o.shift();if(h){const f=function(_,E,I){switch(I){case mR:return function(v,R){const A=p1(R),O=A.length,P=Math.floor(O/255),M=O%255,U=new Uint8Array(6+P+1+O+v.byteLength);U[0]=0,U[1]=0,U[2]=0,U[3]=1,U[4]=6,U[5]=101;let L=0;for(;L<P;)U[6+L]=255,L++;return U[6+L]=M,L++,U.set(A,6+L),U.set(new Uint8Array(v),6+L+O),U.buffer}(_,E);case ER:return function(v,R){const A=p1(R),O=A.length,P=Math.floor(O/255),M=O%255,U=new Uint8Array(7+P+1+O+1+v.byteLength);U[0]=0,U[1]=0,U[2]=0,U[3]=1,U[4]=78,U[5]=1,U[6]=101;let L=0;for(;L<P;)U[7+L]=255,L++;return U[7+L]=M,L++,U.set(A,7+L),L+=O,U[7+L]=128,L++,U.set(new Uint8Array(v),7+L),U.buffer}(_,E);default:return null}}(c.data,h,u);f&&(c.data=f)}l.enqueue(c)}});i.readable.pipeThrough(s).pipeTo(i.writable)}else{if(!Pn())return;{if(typeof RTCRtpScriptTransform>"u")return void g.warning("browser not support RTCRtpScriptTransform");const i=K_(),o=new MessageChannel;await new se(c=>i.onmessage=l=>{l.data==="registered"&&c(void 0)});const s=new RTCRtpScriptTransform(i,{name:"sei-tx",port:o.port2},[o.port2]);e.transform=s,await new se(c=>i.onmessage=l=>{l.data==="started"&&c(void 0)}),t.on("sei-to-send",c=>{o.port1.postMessage({sei:c})}),o.port1.onmessage=c=>{var l;c.data.transformed&&e.track&&((l=e.track)===null||l===void 0?void 0:l.id)!==n.track.id&&(g.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",r),n.track=e.track,n.track.addEventListener("ended",r))},n.worker=i}}function r(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",r)}const i=$_.get(e);if(i){$_.delete(e);try{var o,s;(o=i.controller)===null||o===void 0||o.terminate(),(s=i.worker)===null||s===void 0||s.terminate()}catch(c){g.warning(c&&c.message)}}}$_.set(e,n),e.track.addEventListener("ended",r)},interceptRemoteVideoFrame:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Xe().supportWebRTCEncodedTransform)return void g.warning("browser not support video encoded transform");if(!e.track)return;if(yh.has(e)){const i=yh.get(e);return void(i&&(i.onSei=t.onSei))}const n={track:e.track,onSei:t.onSei};if(Fs()){if(!e.createEncodedStreams)return void g.warning("browser not support createEncodedStreams() API");let i=null;try{i=e.createEncodedStreams()}catch(s){return void g.error("create video-encoded-streams error",s&&s.message)}const o=new TransformStream({transform(s,c){if(n.controller||(n.controller=c),!n.firstFrameInfo){var l;const h=s.getMetadata()||{};n.firstFrameInfo=Pt({type:s.type,rtpTimestamp:s.timestamp,payloadType:h.payloadType||0,ssrc:h.synchronizationSource||0,length:s.data.byteLength},"mimeType"in h?{mimeType:h.mimeType}:{}),(l=t.onFirstFrame)===null||l===void 0||l.call(t,n.firstFrameInfo)}e.track&&e.track.id!==n.track.id&&(g.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",r),n.track=e.track,n.track.addEventListener("ended",r));const u=function(h,f){switch(f){case mR:return function(_){const E=new DataView(_.data);let I=0;for(;I+4<_.data.byteLength;){if(E.getUint8(I+0)===0&&E.getUint8(I+1)===0&&E.getUint8(I+2)===0&&E.getUint8(I+3)===1&&E.getUint8(I+4)===6){let v=I+6,R=0,A=0;for(;(A=E.getUint8(v++))===255;)R+=255;R+=A;const O=h1(_.data,v,R);return new Uint8Array(O)}I++}return null}(h);case ER:return function(_){const E=new DataView(_.data);let I=0;for(;I+5<_.data.byteLength;){if(E.getUint8(I+0)===0&&E.getUint8(I+1)===0&&E.getUint8(I+2)===0&&E.getUint8(I+3)===1&&E.getUint8(I+4)===78&&E.getUint8(I+5)===1&&E.getUint8(I+6)===101){let v=I+7,R=0,A=0;for(;(A=E.getUint8(v++))===255;)R+=255;R+=A;const O=h1(_.data,v,R);return new Uint8Array(O)}I++}return null}(h);default:return null}}(s,f1(new Uint8Array(s.data)));u&&n.onSei&&n.onSei(u),c.enqueue(s)}});i.readable.pipeThrough(o).pipeTo(i.writable)}else if(Pn()){if(typeof RTCRtpScriptTransform>"u")return void g.warning("browser not support RTCRtpScriptTransform");const i=K_(),o=new MessageChannel;await new se(c=>i.onmessage=l=>{l.data==="registered"&&c(void 0)});const s=new RTCRtpScriptTransform(i,{name:"sei-rx",port:o.port2},[o.port2]);e.transform=s,await new se(c=>i.onmessage=l=>{l.data==="started"&&c(void 0)}),o.port1.onmessage=c=>{var l;if(c.data.transformed&&e.track&&((l=e.track)===null||l===void 0?void 0:l.id)!==n.track.id)g.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",r),n.track=e.track,n.track.addEventListener("ended",r);else if(c.data.sei&&n.onSei)n.onSei(c.data.sei);else if(c.data.firstFrameInfo&&t.onFirstFrame){var u;(u=t.onFirstFrame)===null||u===void 0||u.call(t,c.data.firstFrameInfo)}},n.worker=i}function r(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",r)}(function(i){const o=yh.get(i);if(o){yh.delete(i);try{var s,c;(s=o.controller)===null||s===void 0||s.terminate(),(c=o.worker)===null||c===void 0||c.terminate()}catch(l){g.warning(l&&l.message)}}})(e)}yh.set(e,n),e.track.addEventListener("ended",r)}},tZ={name:"InterceptFrame",create:()=>eZ};var rt;function _x(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}function Yo(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?_x(Object(n),!0).forEach(function(r){y(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):_x(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}let nZ=(rt=class Xl extends om{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var n;return Z(n=Object.keys(Mc)).call(n,t)}))]}constructor(t,n,r){super(t,n),y(this,"id",_t(5,"connection-")),y(this,"store",void 0),y(this,"peerConnection",void 0),y(this,"forceTurn",!1),y(this,"remoteSDP",void 0),y(this,"initialOffer",void 0),y(this,"transportEventReceiver",void 0),y(this,"statsFilter",void 0),y(this,"extension",{useXR:w("USE_XR")}),y(this,"localCapabilities",void 0),y(this,"remoteCodecs",void 0),y(this,"localCandidateCount",0),y(this,"allCandidatesReceived",!1),y(this,"isPreallocation",!1),y(this,"preMediaMap",new Map),y(this,"dataStreamChannelMap",new Map),y(this,"establishPromise",void 0),y(this,"recoveredDataChannelIds",[]),y(this,"currentDataChannelId",1),y(this,"supportAV1RtpSpec",!1),y(this,"mutex",void 0),y(this,"qualityLimitationReason",dl.NONE),y(this,"isFirstConnected",!1),this.store=n,this.forceTurn=ey(t),this.mutex=new Ln("NVConnectionExtension-mutex",n.clientId),this.peerConnection=r,this.isFirstConnected=!1,this.statsFilter=L_(this.peerConnection,w("STATS_UPDATE_INTERVAL"),void 0,kt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,t.isPreallocation&&(this.isPreallocation=!0),this.establishPromise=this.establish()}getPreMedia(t){return this.preMediaMap.get(t)}isPreSub(){return this.preMediaMap.size>0}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void g.debug("[NVConnectionExtension] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r);const o=this.remoteSDP.toString();i==null||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else g.debug("[NVConnectionExtension] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=Es(n.sdp),i=await UR({filterRTX:!w("USE_PUB_RTX")&&!w("USE_SUB_RTX"),filterVideoFec:w("FILTER_VIDEO_FEC"),filterAudioFec:w("FILTER_AUDIO_FEC"),filterVideoCodec:w("FILTER_VIDEO_CODEC"),unsupportedVideoUplinkCodec:w("UNSUPPORTED_VIDEO_UPLINK_CODEC"),unsupportedVideoDownlinkCodec:w("UNSUPPORTED_VIDEO_DOWNLINK_CODEC")},this.extension);if(this.localCapabilities=Oh(i),this.initialOffer=n,w("ENABLE_SVC")&&this.store.codec=="av1"){const s=await G1();var t;s&&(this.supportAV1RtpSpec=!0,(t=i.send)===null||t===void 0||t.videoExtensions.push(s))}let o;return n.sdp&&hm(n.sdp)&&(o=Mt(i),k1(o)),Yo(Yo({},r),{},{rtpCapabilities:o||i,offerSDP:n.sdp})}catch(n){throw new W(b.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnectionExtension without initial offer.");this.initialOffer.sdp&&hm(this.initialOffer.sdp)&&M1(t.rtpCapabilities,this.localCapabilities),this.remoteSDP=new pM(Yo(Yo({},t),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec,!(!w("ENABLE_PRE_SUB_WITH_PRE_PC")||!w("PRE_USE_LOCAL_CODECS"))&&Th(this.store),!0),t.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const n=this.remoteSDP.toString(),r=xR(this.initialOffer.sdp,this.extension),i=this.logSDPExchange(r||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),i==null||i(n),await this.peerConnection.setRemoteDescription({type:"answer",sdp:n});const o=this.peerConnection.getTransceivers()[0];if(o!=null&&o.receiver&&this.tryBindTransportEvents(o.receiver),Th(this.store))if(t.preallocation&&w("ENABLE_PRE_SUB_WITH_PRE_PC")){const s=w("PRE_SUB_NUM"),{mids:c,preSSRCs:l}=this.remoteSDP.preloadRemoteMedia(s);await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] preload media, in pre pc,add preload ssrcs ").concat(l)),this.presetMedia(c,l)}else{const{preSSRCs:s=[]}=t,c=s.map(u=>u.ssrcMsg[0].ssrcId);if(s.length===0)return;const{mids:l}=this.remoteSDP.batchSend(s.map(u=>Object.assign({},u)));await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[NVConnectionExtension.connect] preload media, after join, add preload ssrcs ".concat(c)),this.presetMedia(l,c)}}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.connect failed; ".concat(n.toString()))}}presetMedia(t,n){t.forEach((r,i)=>{this.peerConnection.getTransceivers().forEach(o=>{if(o.mid!=null&&r===o.mid&&o.receiver.track){const s=o.receiver.track;let c;s.kind==="video"&&w("ENABLE_PRE_RENDER")&&(c=new W_({trackId:"track-".concat(s.kind,"-unknown-").concat(this.store.clientId,"_").concat(_t(5,""))},!0),c.updateVideoTrack(s),c.onFirstVideoFrameRender=()=>{var l;const u=this.preMediaMap.get(n[i]);u&&(u.firstVideoRender=Date.now()),(l=this.onFirstVideoRender)===null||l===void 0||l.call(this,n[i])},c.onVideoBufferReady=()=>{var l;(l=this.onFirstVideoBufferReady)===null||l===void 0||l.call(this,n[i])},c.play(this.store.sessionId||void 0)),this.preMediaMap.set(n[i],{mid:r,track:s,player:c,transceiver:o})}}),this.store.peerReceiver()})}checkDtlsParameters(t){return!!this.remoteSDP&&t.length>0&&this.remoteSDP.updateRemoteDtlsParameters(t)}async updateRemoteConnect(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateRemoteConnect before remote SDP created");let n=!1;const{rtpCapabilities:r}=t;if([,n]=this.remoteSDP.updateRemoteRTPCapabilities(r),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0){const s=this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);n=n||s}const{preSSRCs:i=[]}=t,o=i.map(s=>s.ssrcMsg[0].ssrcId);if(!this.remoteSDP.checkPreloadSsrcs(o)){const s=[],c=[];if(Array.from(this.preMediaMap.entries()).every(l=>{let[u,{mid:h,player:f,track:_}]=l;return s.push(h),c.push(u),this.preMediaMap.delete(u),f&&f.destroy(),!0}),s.length>0&&(this.remoteSDP.stopSending(s),await Wr(this.peerConnection,this.remoteSDP,this.extension),g.warn("[NVConnectionExtension.updateRemoteConnect] preload media, failed, del preload ssrcs ".concat(c)),pe.reportApiInvoke(this.store.sessionId,{name:Ft.PRELOAD_MEDIA_FAILED,options:[i,c],tag:It.TRACER}).onSuccess()),i.length>0){const{mids:l}=this.remoteSDP.batchSend(i.map(u=>Object.assign({},u)));await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[NVConnectionExtension.updateRemoteConnect] preload media, after join, add preload ssrcs ".concat(o)),this.presetMedia(l,o)}}n?(await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[NVConnectionExtension] updateRemoteConnect by exchanging SDP.")):g.debug("[NVConnectionExtension] updateRemoteConnect no need to exchange SDP, because no need to update remote codecs (use local codecs)")}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.updateRemoteConnect failed; ".concat(n.toString()))}}send(t,n,r){var i=this;return Ar(function*(){const o=yield We(i.mutex.lock("From NVConnectionExtension.send"));try{if(!i.remoteSDP)throw new Error("Cannot call NVConnectionExtension.send before remote SDP created");const s=[],c=wh();t.forEach(R=>{const A=i.peerConnection.addTransceiver(R._mediaStreamTrack,Yo({direction:"sendonly"},R.trackMediaType==="video"&&i.supportAV1RtpSpec&&c?{sendEncodings:[{scalabilityMode:c}]}:{}));s.push(A),R._updateRtpTransceiver(A)}),kt()&&w("SIMULCAST")===!0&&(yield We(i.applySimulcastForFirefox(s,t)));const l=yield We(i.peerConnection.createOffer()),u=i.remoteSDP.predictReceivingMids(t.length),h=i.mungSendOfferSDP(l.sdp,t,u),f=gr(h),_=u.map(R=>{const A=f.mediaDescriptions.find(O=>O.attributes.mid===R);if(!A)throw new Error("Cannot extract ssrc from mediaDescription.");return PR(A,w("USE_PUB_RTX"))});let E;try{E=yield _}catch(R){E=[],i.remoteSDP.receive(t,n,r,E);const A=i.remoteSDP.toString();throw yield We(i.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield We(i.peerConnection.setRemoteDescription({type:"answer",sdp:A})),yield We(i.stopSending(u,!0)),R}i.remoteSDP.receive(t,n,r,E);const I=i.remoteSDP.toString(),v=i.logSDPExchange(h,"offer","local","send");return yield We(i.peerConnection.setLocalDescription({type:"offer",sdp:h})),yield We(i.applySimulcastEncodings(s,t)),yield We(i.applySendEncodings(s,t)),v==null||v(I),yield We(i.peerConnection.setRemoteDescription({type:"answer",sdp:I})),s.map((R,A)=>{const O=u[A];return{localSSRC:_[A],id:O,transceiver:R}})}catch(s){throw s instanceof W?s:new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.send failed; ".concat(s.toString()))}finally{o()}})()}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.createDataChannels before remote SDP created");let r=this.dataStreamChannelMap.get(t);if(r&&r.readyState==="open")g.debug("[NVConnectionExtension] Channels are already available and can be reused directly.");else{const o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");r=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:w("DATASTREAM_MAX_RETRANSMITS")}),r.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,r)}n.forEach(o=>{o._updateOriginDataChannel(r)});const{needExchangeSDP:i}=this.remoteSDP.sendDataChannel();if(i){const o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),g.debug("[NVConnectionExtension] createDataChannels by exchanging SDP.")}else g.debug("[NVConnectionExtension] createDataChannels no need to exchange SDP.");return}catch(r){throw r instanceof W?r:new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.createDataChannels failed; ".concat(r.toString()))}}async stopDataChannels(t){try{const n=this.dataStreamChannelMap.get(t);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(t)}catch(n){throw n instanceof W?n:new W(b.DATACHANNEL_FAILED,"NVConnectionExtension.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(t,n){const r=n?void 0:await this.mutex.lock("From NVConnectionExtension.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopSending before remote SDP created");const i=this.peerConnection.getTransceivers().filter(l=>t.indexOf(l.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVConnectionExtension.stopSending.");i.map(l=>{var u;Pl(this.id+l.mid,this),l.direction="inactive",(u=l.stop)===null||u===void 0||u.call(l)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(t);const c=this.remoteSDP.toString();s==null||s(c),await this.peerConnection.setRemoteDescription({type:"answer",sdp:c})}catch(i){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.stopSending failed; ".concat(i.toString()))}finally{r&&r()}}async receive(t,n,r,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(t,n,r,i);s&&(await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] receive ").concat(t," by exchanging SDP.")));const c=this.peerConnection.getTransceivers().find(l=>l.mid===o);if(!c)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:c.receiver.track,id:o,transceiver:c}}catch(o){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(o.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:r}=this.remoteSDP.batchSend(t);return r&&(await Wr(this.peerConnection,this.remoteSDP,this.extension),g.debug("[".concat(this.store.clientId,"] [NVConnectionExtension] batchReceive by exchanging SDP."))),n.map(i=>{const o=this.peerConnection.getTransceivers().find(s=>s.mid===i);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:i,transceiver:o}})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.receive failed; ".concat(n.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.stopReceiving before remote SDP created.");t.forEach(o=>{Array.from(this.preMediaMap.entries()).some(s=>{let[c,{mid:l,player:u}]=s;if(l===o)return this.preMediaMap.delete(c),u&&u.destroy(),!0})}),this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const n=this.remoteSDP.toString(),r=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();r==null||r(i.sdp||""),await this.peerConnection.setLocalDescription(i)}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(t);const o=this.remoteSDP.toString();i==null||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,c)=>{s.direction="sendonly"});const r=await this.peerConnection.createOffer(),i=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(t,this.remoteCodecs,this.store.codec);const o=this.remoteSDP.toString();i==null||i(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new W(b.EXCHANGE_SDP_FAILED,"NVConnectionExtension.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return Ar(function*(){const r=yield We(n.mutex.lock("From NVConnectionExtension.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");const i=Xe().supportPCSetConfiguration,o=w("FORCE_TURN_TCP")||n.forceTurn;if(t===kn.RELAY&&!i)return;if(i&&!o){const f=t===kn.RELAY?"relay":"all",_=n.peerConnection.getConfiguration();_.iceTransportPolicy!==f&&(g.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(_.iceTransportPolicy,"] to [").concat(f,"]")),_.iceTransportPolicy=f,n.peerConnection.setConfiguration(_))}n.remoteSDP.updateCandidates(t);const s=yield We(n.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const c=Es(s.sdp),{remoteIceParameters:l}=yield c.iceParameters;n.remoteSDP.restartICE(l);const u=n.remoteSDP.toString(),h=n.logSDPExchange(s.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield We(n.peerConnection.setLocalDescription(s)),h==null||h(u),yield We(n.peerConnection.setRemoteDescription({type:"answer",sdp:u}))}catch(i){g.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),i)}finally{r()}})()}async extendCandidate(){if(!this.remoteSDP||this.isFirstConnected)return;const t=await this.mutex.lock("From NVConnectionExtension.extendCandidate");try{this.remoteSDP.updateCandidates(kn.TCP_RELAY),await Wr(this.peerConnection,this.remoteSDP,this.extension)}catch(n){g.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),n)}finally{t()}}close(){var t;this.peerConnection.getTransceivers().forEach(n=>{Pl(this.id+n.mid,this)}),this.preMediaMap.forEach(n=>{let{player:r}=n;r&&r.destroy()}),this.preMediaMap.clear(),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return Yo(Yo({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVConnectionExtension.updateEncoderConfig before remote SDP created.");const r=await this.peerConnection.createOffer(),i=this.mungSendOfferSDP(r.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const o=this.remoteSDP.toString(),s=this.logSDPExchange(i,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:i}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new W(b.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,n){const r=this.peerConnection.getTransceivers().filter(i=>i.mid===t);r.length===1&&(this.isVP8Simulcast(n)?kt()||await this.applySimulcastEncodings(r,[n]):await this.applySendEncodings(r,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const r=this.peerConnection.getTransceivers().find(i=>i.mid===n);r&&await r.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:r,remote:i}=n.getSelectedCandidatePair();return{local:Yo(Yo({},so),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:Yo(Yo({},so),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=t=>{if(t&&(t.errorCode||t.errorText)){var n;const r="code: ".concat(t.errorCode,", message: ").concat(t.errorText),i=t.port?"local: ".concat(t.port):"",o=ms(t.url||"");g.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: NVConnectionExtension.onICECandidateError(").concat(r,"), url: ").concat(o||"",", host_candidate:").concat(i)),(n=this.onICECandidateError)===null||n===void 0||n.call(this,r)}},this.peerConnection.onicegatheringstatechange=t=>{t&&t.target&&"iceGatheringState"in t.target&&g.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(t.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,g.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,g.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},w("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]},r=t.cloudProxyServer||"disabled";return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&(bc(t.turnServer.servers)?n.iceServers=t.turnServer.servers:w("NEW_TURN_MODE")&&n.iceServers&&r==="disabled"?(w("USE_TURN_SERVER_OF_GATEWAY")?t.turnServer.serversFromGateway&&n.iceServers.push(...Xl.newTurnServerConfigToIceServers(t.turnServer.serversFromGateway)):n.iceServers.push(...Xl.newTurnServerConfigToIceServers(t.turnServer.servers)),w("NEW_FORCE_TURN")&&(n.iceTransportPolicy="relay")):t.turnServer.mode!=="off"&&(n.iceServers&&n.iceServers.push(...Xl.turnServerConfigToIceServers(t.turnServer.servers)),w("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...Xl.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),w("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),w("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach(r=>{r.security?r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ho(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!w("FORCE_TURN_TCP")&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),n}static newTurnServerConfigToIceServers(t){const n=[];return t.forEach(r=>{const i=w("NEW_TURN_MODE");i===1?n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}):i===2?n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}):i===3?n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ho(r.turnServerURL),":443?transport=tcp")}):i===4&&(n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=udp")}),n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":3478?transport=tcp")}),n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ho(r.turnServerURL),":443?transport=tcp")}))}),n}tryBindTransportEvents(t){const n=t.transport;if(n){this.transportEventReceiver=t,n.onstatechange=()=>{var i;n!=null&&n.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,n.state))},n.onerror=i=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in i?i.error:i)};const r=n.iceTransport;r&&(r.onstatechange=()=>{const i=n==null?void 0:n.iceTransport.state;var o;i&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,i))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){const{local:i,remote:o}=r.getSelectedCandidatePair()||{};if(i&&o){const s=i.address+":"+i.port,c=o.address+":"+o.port;g.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify(ms(s)),", remote ").concat(JSON.stringify(ms(c))))}}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var r,i;if(n||(n=this.peerConnection.getSenders().find(R=>R.track===t._mediaStreamTrack)),!n)return g.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return g.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Xe().supportSetRtpSenderParameters)return g.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const o={},s={};switch(t._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}const c=P1(this.peerConnection,t._mediaStreamTrack),l=vL(t);if(SM(t)&&c&&n&&l&&this.getLocalVideoStats&&Z(r=["vp8","vp9"]).call(r,this.store.codec)){var u;const v=o.degradationPreference||(Z(u=t._hints).call(u,pt.CUSTOM_TRACK)?w("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");TM(this.id+c.mid,l,this,v,R=>{n&&this.updateAdaptation(n,R)},this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var h;const{bitrateMax:v,frameRate:R,scaleResolutionDownBy:A}=t._encoderConfig;v&&(s.maxBitrate=1e3*v),(Z(h=t._hints).call(h,pt.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(R&&(s.maxFramerate=Pr(R)),A&&A>=1&&(s.scaleResolutionDownBy=A))}const{maxFramerate:f}=w("ENCODER_CONFIG_LIMIT");if(f&&typeof f=="number"&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,f):f),w("DSCP_TYPE")&&us()){var _;const v=w("DSCP_TYPE");Z(_=["very-low","low","medium","high"]).call(_,v)&&(s.networkPriority=v)}const E=n.getParameters(),I=(i=E.encodings)===null||i===void 0?void 0:i[0];kt()&&!I&&(o.encodings=[s]),I&&Object.assign(I,s),Object.assign(E,o),g.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(E.encodings))),await n.setParameters(E),await K1(this.store.codec,n,w("SVC_MODE"))}async updateAdaptation(t,n){var r,i;if(!t)return g.debug("[updateAdaptation] no rtpSender found");if(!Xe().supportSetRtpSenderParameters)return g.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const o={},{bitrateMax:s,frameRate:c,scaleResolutionDownBy:l}=n;s&&(o.maxBitrate=1e3*s),c&&(o.maxFramerate=Pr(c)),l&&l>=1&&Z(r=["vp8","vp9"]).call(r,this.store.codec)&&(o.scaleResolutionDownBy=l);const u=t.getParameters(),h=(i=u.encodings)===null||i===void 0?void 0:i[0];h&&Object.assign(h,o),Object.assign(u,{});try{await t.setParameters(u),g.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(u.encodings)))}catch(f){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?g.debug("[updateAdaptation] peerConnection not connected}"):g.debug("[updateAdaptation] updateRtpSenderEncodings failed",f):g.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,n){try{if(!Xe().supportSetRtpSenderParameters||t.length!==n.length)return;for(let r=0;r<t.length;r++){const i=t[r],o=n[r];o instanceof wt&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,i.sender)}}catch{g.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,r){const i=gr(t);return n.forEach((o,s)=>{const c=r[s],l=i.mediaDescriptions.find(u=>u.attributes.mid===c);l&&(Yc(l,o),MR(l,o,this.store.codec))}),js(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,r)=>{var i;(i=this.onFirstVideoDecoded)===null||i===void 0||i.call(this,t,n,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let l=0;l<t.length;l++){var r,i,o,s,c;const u=t[l],h=n[l];if(h instanceof wt&&!Z(r=h._hints).call(r,pt.LOW_STREAM)&&(i=h._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((o=h._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=h._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((c=h._scalabilityMode)===null||c===void 0?void 0:c.numSpatialLayers)>1&&this.store.codec==="vp8"){const f={},_={high:1e3*(h._encoderConfig.bitrateMax-50),medium:5e4};f.encodings=[{rid:"m",active:!0,maxBitrate:_.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:_.high}];const E=u.sender.getParameters();await u.sender.setParameters(Object.assign(E,f))}}}async applySimulcastEncodings(t,n){if(!kt()&&t.length===n.length)for(let r=0;r<t.length;r++){const i=n[r];if(i instanceof wt&&this.isVP8Simulcast(i)){const o=t[r],s={},c={high:1e3*(i._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:c.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:c.medium,scaleResolutionDownBy:4}];const l=o.sender.getParameters();await o.sender.setParameters(Object.assign(l,s))}}}isVP8Simulcast(t){var n,r,i,o,s;return!!(t instanceof wt&&w("SIMULCAST")&&this.store.codec==="vp8"&&!Z(n=t._hints).call(n,pt.LOW_STREAM)&&(r=t._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((i=t._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(o=t._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=t._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(t,n,r,i){if(w("SDP_LOGGING"))return g.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(n," SDP during NVConnectionExtension.").concat(i,`
`),t),n==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",i)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n&&n.length!==0?n[0].ssrcId:void 0}setConfiguration(t){if(Xe().supportPCSetConfiguration){const n=Xl.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}t.isPreallocation&&(this.isPreallocation=!0)}},ae(rt.prototype,"updateRemoteRTPCapabilities",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"updateRemoteRTPCapabilities"),rt.prototype),ae(rt.prototype,"connect",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"connect"),rt.prototype),ae(rt.prototype,"updateRemoteConnect",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"updateRemoteConnect"),rt.prototype),ae(rt.prototype,"createDataChannels",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"createDataChannels"),rt.prototype),ae(rt.prototype,"receive",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"receive"),rt.prototype),ae(rt.prototype,"batchReceive",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"batchReceive"),rt.prototype),ae(rt.prototype,"stopReceiving",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"stopReceiving"),rt.prototype),ae(rt.prototype,"muteRemote",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"muteRemote"),rt.prototype),ae(rt.prototype,"unmuteRemote",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"unmuteRemote"),rt.prototype),ae(rt.prototype,"muteLocal",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"muteLocal"),rt.prototype),ae(rt.prototype,"unmuteLocal",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"unmuteLocal"),rt.prototype),ae(rt.prototype,"close",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"close"),rt.prototype),ae(rt.prototype,"updateEncoderConfig",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"updateEncoderConfig"),rt.prototype),ae(rt.prototype,"updateSendParameters",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"updateSendParameters"),rt.prototype),ae(rt.prototype,"replaceTrack",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"replaceTrack"),rt.prototype),ae(rt.prototype,"updateAdaptation",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"updateAdaptation"),rt.prototype),ae(rt.prototype,"getRemoteSSRC",[Mr],Object.getOwnPropertyDescriptor(rt.prototype,"getRemoteSSRC"),rt.prototype),rt);function Mr(e,t,n){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("From NVConnectionExtension.".concat(t));try{for(var s=arguments.length,c=new Array(s),l=0;l<s;l++)c[l]=arguments[l];return await r.apply(this,c)}finally{o()}},n}var Tt;function mx(e){var t,n,r,i=2;for(typeof Symbol<"u"&&(n=m_,r=Symbol.iterator);i--;){if(n&&(t=e[n])!=null)return t.call(e);if(r&&(t=e[r])!=null)return new Xm(t.call(e));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function Xm(e){function t(n){if(Object(n)!==n)return se.reject(new TypeError(n+" is not an object."));var r=n.done;return se.resolve(n.value).then(function(i){return{value:i,done:r}})}return Xm=function(n){this.s=n,this.n=n.next},Xm.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var r=this.s.return;return r===void 0?se.resolve({value:n,done:!0}):t(r.apply(this.s,arguments))},throw:function(n){var r=this.s.return;return r===void 0?se.reject(n):t(r.apply(this.s,arguments))}},new Xm(e)}let rZ=(Tt=class OE extends om{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,n){super(t,n),y(this,"name","DataChannelConnection"),y(this,"store",void 0),y(this,"peerConnection",void 0),y(this,"cname",void 0),y(this,"mutex",new Ln("DataChannelConnection-mutex")),y(this,"dataChannel",void 0),y(this,"_p2pConnection",void 0),y(this,"establishPromise",void 0),y(this,"_nvMedia",void 0),this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(OE.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new nZ(t,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}getPreMedia(t){var n;return(n=this._p2pConnection)===null||n===void 0?void 0:n.getPreMedia(t)}isPreSub(){var t,n;return(t=(n=this._p2pConnection)===null||n===void 0?void 0:n.isPreSub())!==null&&t!==void 0&&t}async establish(){return await this._p2pConnection.establish()}getP2PConnectionParams(){return this._p2pConnection.establishPromise}updateRtpSenderEncodings(t){return this._p2pConnection.updateRtpSenderEncodings(t)}async connect(t){return this.cname=t.cname,await this._p2pConnection.connect(t),await new se((n,r)=>{const i=setTimeout(()=>{this.closeSignal(),r(new B(b.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(t.candidates))))},w("DC_CONNECTION_TIMEOUT"));this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(i),void n()},this.dataChannel.onerror=o=>{this.closeSignal(),r(o)},this.dataChannel.addEventListener("close",()=>{r(new B(b.DATACHANNEL_CONNECTION_TIMEOUT))})}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,n){return this._p2pConnection.updateRemoteRTPCapabilities(t,n)}send(t,n,r){var i=this;return Ar(function*(){const o=yield We(i.mutex.lock("From DataChannelConnection.send"));try{return yield*rl(mx(i._p2pConnection.send(t,n,r)))}finally{o()}})()}async stopSending(t,n){return this._p2pConnection.stopSending(t,n)}async createDataChannels(t,n){return this._p2pConnection.createDataChannels(t,n)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,n,r,i){return this._nvMedia?(g.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,n,this.cname)):(g.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,n,r,i))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var n=this;return Ar(function*(){return yield*rl(mx(n._p2pConnection.restartICE(t)))})()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var n;return(n=this._nvMedia)===null||n===void 0||n.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,n){return await this._p2pConnection.updateEncoderConfig(t,n)}async updateSendParameters(t,n){return await this._p2pConnection.updateSendParameters(t,n)}setStatsRemoteVideoIsReady(t,n){this._p2pConnection.setStatsRemoteVideoIsReady(t,n)}async replaceTrack(t,n){return await this._p2pConnection.replaceTrack(t,n)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,n,r,i){if(w("SDP_LOGGING"))return g.upload("exchanging ".concat(r," ").concat(n," SDP during DataChannelConnection.").concat(i,`
`),t),n==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",i)}:void 0}static resolvePCConfiguration(t){const n={iceServers:[]};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(bc(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...OE.turnServerConfigToIceServers(t.turnServer.servers)),w("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...OE.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),w("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(n.iceTransportPolicy="relay")}))),w("ENABLE_ENCODED_TRANSFORM")&&Xe().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach(r=>{r.security?r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ho(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!w("FORCE_TURN_TCP")&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&n.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),n}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var n;return(n=this.onICEConnectionStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var n;return(n=this.onConnectionStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var n;return(n=this.onDTLSTransportStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var n;return(n=this.onDTLSTransportError)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var n;return(n=this.onICETransportStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var n;return(n=this.onFirstAudioReceived)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var n;return(n=this.onFirstVideoReceived)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var n;return(n=this.onFirstAudioDecoded)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoRender=t=>{var n;return(n=this.onFirstVideoRender)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoBufferReady=t=>{var n;return(n=this.onFirstVideoBufferReady)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,n,r)=>{var i;return(i=this.onFirstVideoDecoded)===null||i===void 0?void 0:i.call(this,t,n,r)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var n;return(n=this.onFirstVideoDecodedTimeout)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,n)=>{var r;return(r=this.onSelectedLocalCandidateChanged)===null||r===void 0?void 0:r.call(this,t,n)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,n)=>{var r;return(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0?void 0:r.call(this,t,n)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}},ae(Tt.prototype,"connect",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"connect"),Tt.prototype),ae(Tt.prototype,"updateRemoteRTPCapabilities",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"updateRemoteRTPCapabilities"),Tt.prototype),ae(Tt.prototype,"createDataChannels",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"createDataChannels"),Tt.prototype),ae(Tt.prototype,"receive",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"receive"),Tt.prototype),ae(Tt.prototype,"stopReceiving",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"stopReceiving"),Tt.prototype),ae(Tt.prototype,"muteRemote",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"muteRemote"),Tt.prototype),ae(Tt.prototype,"unmuteRemote",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"unmuteRemote"),Tt.prototype),ae(Tt.prototype,"muteLocal",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"muteLocal"),Tt.prototype),ae(Tt.prototype,"unmuteLocal",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"unmuteLocal"),Tt.prototype),ae(Tt.prototype,"close",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"close"),Tt.prototype),ae(Tt.prototype,"updateEncoderConfig",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"updateEncoderConfig"),Tt.prototype),ae(Tt.prototype,"updateSendParameters",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"updateSendParameters"),Tt.prototype),ae(Tt.prototype,"replaceTrack",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"replaceTrack"),Tt.prototype),ae(Tt.prototype,"getRemoteSSRC",[yi],Object.getOwnPropertyDescriptor(Tt.prototype,"getRemoteSSRC"),Tt.prototype),Tt);function yi(e,t,n){const r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const i=this.mutex,o=await i.lock("From DataChannelConnection.".concat(t));try{for(var s=arguments.length,c=new Array(s),l=0;l<s;l++)c[l]=arguments[l];return await r.apply(this,c)}finally{o()}},n}function Ex(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(i){return Object.getOwnPropertyDescriptor(e,i).enumerable})),n.push.apply(n,r)}return n}class iZ extends Wt{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var n;Z(n=["tryNext","recover"]).call(n,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(gn.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(gn.CONNECTED):this._state==="closed"?this.emit(gn.CLOSED):this._state==="failed"&&this.emit(gn.FAILED))}constructor(t,n,r,i){super(),y(this,"connectionID",0),y(this,"currentURLIndex",0),y(this,"reconnectReason",void 0),y(this,"_reconnectMode","tryNext"),y(this,"_initMutex",void 0),y(this,"_name",void 0),y(this,"_state","closed"),y(this,"_reconnectInterrupter",void 0),y(this,"_url",void 0),y(this,"_retryConfig",void 0),y(this,"_reconnectCount",0),y(this,"_forceCloseTimeout",5e3),y(this,"_onlineReconnectListener",void 0),y(this,"_closeEstablishingTransmitter",()=>{}),y(this,"_store",void 0),y(this,"_joinChannelServiceRecordIndex",void 0),y(this,"_transmitter",void 0),y(this,"_useCompress",void 0),y(this,"_inflateLength",0),y(this,"_deflateLength",0),this._store=i,this._name=t,this._retryConfig=function(o){for(var s=1;s<arguments.length;s++){var c=arguments[s]!=null?arguments[s]:{};s%2?Ex(Object(c),!0).forEach(function(l){y(o,l,c[l])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(c)):Ex(Object(c)).forEach(function(l){Object.defineProperty(o,l,Object.getOwnPropertyDescriptor(c,l))})}return o}({},n),this._useCompress=r}resetReconnectCount(t){g.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const r=this._transmitter;n?setTimeout(()=>r.close(),500):r.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,n){if(!this._transmitter)return void g.warning("[".concat(this._name,"] can not reconnect, no websocket"));var r;t!==void 0&&(this.reconnectMode=t),g.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((r=this._store)===null||r===void 0||r.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));const i=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),i&&i.bind(this._transmitter)({code:9999,reason:n})}getInflateData(){const t=this._inflateLength,n=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:n}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let zo=function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e}({});class oZ{constructor(t,n,r){y(this,"version",1),y(this,"initialRTO",void 0),y(this,"maxBatchAckCount",void 0),y(this,"maxRTO",void 0),y(this,"initialRTT",void 0),y(this,"ID",void 0),y(this,"rtt",void 0),y(this,"packetNumber",1),y(this,"rtoRatioMap",new Map),y(this,"timeoutMap",new Map),y(this,"unorderedPacketQueue",[]),y(this,"batchAckPacketQueue",[]),y(this,"lastOrderedPacketNumber",0),y(this,"batchAckTimer",void 0),y(this,"sendImpl",void 0),y(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=n,this.ID=_t(7,"transmitter-"),this.initialRTO=(r==null?void 0:r.initialRTO)!==void 0?r.initialRTO:w("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(r==null?void 0:r.initialRTT)!==void 0?r.initialRTT:w("TRANSMITTER_INITIAL_RTT"),this.rtt=(r==null?void 0:r.initialRTT)!==void 0?r.initialRTT:w("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(r==null?void 0:r.maxBatchAckCount)!==void 0?r.maxBatchAckCount:w("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(r==null?void 0:r.maxRTO)!==void 0?r.maxRTO:w("TRANSMITTER_MAX_RTO")}packetize(t,n){return{type:zo.Default,version:this.version,packetNumber:n,payload:t}}serialize(t){switch(t.type){case zo.Default:{let n;typeof t.payload=="string"?n=new TextEncoder().encode(t.payload):n=t.payload;const r=new ArrayBuffer(n.length+15),i=new DataView(r);return i.setUint16(0,t.version),i.setUint8(2,t.type),i.setUint32(3,t.packetNumber),mP(i,7,BigInt(t.sendTs)),new Uint8Array(i.buffer).set(n,15),r}case zo.Ack:{const n=new ArrayBuffer(16),r=new DataView(n);return r.setUint16(0,t.version),r.setUint8(2,t.type),r.setUint32(3,t.maxAckPacketNumber),r.setUint8(7,t.shift),mP(r,8,BigInt(t.ackSendTs)),n}}}deserialize(t){const n=new DataView(t),r=n.getUint16(0),i=n.getUint8(2);switch(i){case zo.Default:{const o=n.getUint32(3),s=_P(n,7),c=t.slice(15),l=new Uint8Array(c);return{version:r,type:i,packetNumber:o,sendTs:Number(s),payload:l}}case zo.Ack:{const o=n.getUint32(3),s=n.getUint8(7),c=_P(n,8);return{version:r,type:i,maxAckPacketNumber:o,shift:s,ackSendTs:Number(c)}}default:throw g.error("[".concat(this.ID,"] Unrecognized packet type ").concat(i)),new Error("Unrecognized packet type ".concat(i))}}sendMessage(t){w("DC_DEBUG_LOG")&&typeof t=="string"&&g.debug("[".concat(this.ID,"] sending message packet"),JSON.parse(t));const n=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const r=this.calculateRTO(n),i=window.setTimeout(()=>{this.resendMessage(n)},r);this.timeoutMap.set(n.packetNumber,i),this.sendPacket(n)}onData(t){const n=this.deserialize(t);n.type===zo.Default?this.ack(n):n.type===zo.Ack&&(this.updateRTT(n,Math.round(performance.now())),this.clearRTO(n))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(t=>{let[n,r]=t;window.clearTimeout(r)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const n=this.calculateRTO(t),r=window.setTimeout(()=>{w("DC_DEBUG_LOG")&&typeof t.payload=="string"&&g.debug("[".concat(this.ID,"] resending message packet"),JSON.parse(t.payload),"timeout: ".concat(n)),this.resendMessage(t)},n);this.timeoutMap.set(t.packetNumber,r),this.sendPacket(t)}calculateRTO(t){const n=this.rtoRatioMap.get(t.packetNumber);if(n===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const r=9*this.rtt/8*n;return this.rtoRatioMap.set(t.packetNumber,n+1),r>this.maxRTO?this.maxRTO:r}}updateRTT(t,n){const r=t.ackSendTs;this.rtt=this.rtt*(7/8)+(n-r-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const n=this.unorderedPacketQueue[0];if(!n){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(n.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:zo.Ack,version:this.version};w("DC_DEBUG_LOG")&&g.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(n)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:zo.Ack,version:this.version};w("DC_DEBUG_LOG")&&g.debug("[".concat(this.ID,"] sending ack packet"),n,"packetNumber: ".concat(t.packetNumber)),this.sendPacket(n)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:zo.Ack,version:this.version};w("DC_DEBUG_LOG")&&g.debug("[".concat(this.ID,"] sending batch ack packet"),t,"shift: ".concat(this.batchAckPacketQueue.length-1)),this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===zo.Default&&(t.sendTs=Math.round(performance.now()));const n=this.serialize(t);this.sendImpl(n)}clearRTO(t){for(let n=t.maxAckPacketNumber-t.shift;n<=t.maxAckPacketNumber;n++){const r=this.timeoutMap.get(n);r!==void 0&&window.clearTimeout(r),this.timeoutMap.delete(n),this.rtoRatioMap.delete(n)}}}class gx extends iZ{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),y(this,"_initMutex",void 0),y(this,"_reconnectInterrupter",void 0),y(this,"_url",void 0),y(this,"_transmitter",void 0),y(this,"_addresses",void 0),y(this,"_reliableTransmission",void 0),y(this,"_textEncoder",void 0),y(this,"_textDecoder",void 0),this._textEncoder=new TextEncoder,this._textDecoder=new TextDecoder,this._initMutex=new Ln("datachannel");const{timeout:r,timeoutFactor:i}=n,o=Math.max(300,Math.floor(3*r/5)),s=Math.max(1.2,Math.floor(8*i)/10);Er.ONLINE&&(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s),qt.on(Oc.NETWORK_STATE_CHANGE,(c,l)=>{c!==l&&(this.resetReconnectCount("network state change: ".concat(l," -> ").concat(c)),c===Er.ONLINE?(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s):(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=i))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=n;const r=(i,o)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex(c=>c.fingerprint||w("FINGERPRINT"));const s=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(s).then(i).catch(o),this.once(gn.CLOSED,()=>o(new B(b.WS_DISCONNECT))),this.once(gn.CONNECTED,()=>i())};return this._initMutex.lock().then(i=>new se((o,s)=>{r(o,s)}).then(()=>{i()}).catch(()=>{i()}))}async sendMessage(t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new B(b.WS_ABORT,"datachannel is not ready");try{n||(t=JSON.stringify(t));const r=this._textEncoder.encode(t),i=EQ(r,{raw:!0});this._reliableTransmission.sendMessage(i)}catch(r){throw new B(b.WS_ERR,"send datachannel signal message error"+r.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const n=JSON.stringify(t);return{compressed:n,compressedLength:n.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new se((n,r)=>{var i;const o=()=>{g.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="recover",this.state="connected",this.resetReconnectCount("opened"),n()},s=async h=>{var f;if((f=this._closeEstablishingTransmitter)===null||f===void 0||f.call(this),g.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(h.code,", reason: ").concat(h.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=h.reason,this.state="reconnecting");const _=ni(this,gn.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,E=await this.reconnectWithAction(_);if(this.state==="closed")return void g.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!E)return r(new B(b.WS_DISCONNECT,"datachannel reconnect failed: ".concat(h.code))),void this.close(!0);n()}else r(new B(b.WS_DISCONNECT,"datachannel close: ".concat(h.code))),this.close()},c=async h=>{try{var f;(f=this._reliableTransmission)===null||f===void 0||f.onData(h.data)}catch(_){console.log(_)}};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),g.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const l=(i=this._store)===null||i===void 0?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),u=Date.now();hn(this,gn.TO_CONNECT_DATACHANNEL).then(h=>{var f,_;if(!h)throw new Error("transmissonInfo not exist yet");const{transmitter:E,close:I}=h;this._transmitter=E,(f=this._store)===null||f===void 0||f.signalChannelOpen();const v=Date.now()-u;g.debug("[choose dc] dc open cost ".concat(v,"ms")),this._reliableTransmission=new oZ(R=>{var A;this._transmitter&&this._transmitter.readyState==="open"&&((A=this._transmitter)===null||A===void 0||A.send(R))},R=>{if(typeof R=="string")this.emit(gn.ON_MESSAGE,R);else{const A=SQ(R,{raw:!0}).buffer,O=this._textDecoder.decode(A);this.emit(gn.ON_MESSAGE,O)}}),this._closeEstablishingTransmitter=()=>{var R;(R=this._reliableTransmission)===null||R===void 0||R.close(),this._reliableTransmission=void 0,I()},o&&o(),E.onclose=s,E.onmessage=c,(_=this._store)===null||_===void 0||_.recordJoinChannelService({endTs:Date.now(),status:"success"},l),this._joinChannelServiceRecordIndex=l}).catch(h=>{var f;if((f=this._store)===null||f===void 0||f.recordJoinChannelService({endTs:Date.now(),status:h instanceof B&&h.code===b.WS_ABORT?"aborted":"error",errors:[h]},l),this.state!=="closed"){if(h instanceof B&&h.code===b.WS_ERR){const _=new B(b.WS_ERR,"init datachannel failed! Error: ".concat(h.toString()));return g.error("[".concat(this._name,"]").concat(_)),void r(_)}s&&s(h)}else r(new B(b.WS_DISCONNECT,"datachannel is closed: ".concat(h.toString())))})})}async reconnectWithAction(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||qt.networkState!==Er.OFFLINE||(this._onlineReconnectListener=qt.onlineWaiter&&qt.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let r=!0;if(this._reconnectInterrupter=()=>{r=!1},n){const c=O_(this._reconnectCount,this._retryConfig);g.debug("[".concat(this._name,"] wait ").concat(c,"ms to reconnect datachannel, mode: ").concat(t)),await se.race([In(c),this._onlineReconnectListener||new se(()=>{})])}if(this.state==="closed"||!r)return!1;this._reconnectCount+=1;const i=async(c,l)=>{this.emit(gn.RECONNECT_CREATE_CONNECTION,l),await this.createTransmitterConnection(c)};try{if(t==="retry"){const c=this._addresses[this.currentURLIndex];await i(c,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let l=this.currentURLIndex;l<this._addresses.length;l++){if(this._addresses[l].fingerprint||w("FINGERPRINT")){this.currentURLIndex=l;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return g.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);g.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const c=this._addresses[this.currentURLIndex];await i(c,t)}else t==="recover"&&(g.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(gn.FAILBACK));return!0}catch(c){var o,s;return g.error("[".concat(this._name,"] reconnect failed"),c.toString()),c!=null&&(o=c.data)!==null&&o!==void 0&&o.desc&&Array.isArray(c.data.desc)&&c.data.desc.length&&Z(s=c.data.desc).call(s,"dynamic key expired")?(this.emit(gn.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,n)}}}class sZ extends Wt{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===$e.CONNECTED?this.emit(Ee.WS_CONNECTED):t===$e.RECONNECTING?this.emit(Ee.WS_RECONNECTING,this._websocketReconnectReason):t===$e.CLOSED&&this.emit(Ee.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}processPendingNotifications(){this.pendingNotifications.length!==0&&(g.debug("[".concat(this.clientId,"] processing ").concat(this.pendingNotifications.length," pending notifications")),this.pendingNotifications.forEach(t=>{let{type:n,message:r}=t;this.emit(n,r),n===Pe.ON_NOTIFICATION&&this.handleNotification(r),n===Pe.ON_USER_BANNED&&this.handleUserBanned(r)}),this.pendingNotifications=[])}handleUserBanned(t){switch(t.error_code){case 14:this.close(Ze.UID_BANNED);break;case 15:this.close(Ze.IP_BANNED);break;case 16:this.close(Ze.CHANNEL_BANNED)}}constructor(t,n){super(),y(this,"__name__","DataChannelSignal"),y(this,"_disconnectedReason",void 0),y(this,"_websocketReconnectReason",void 0),y(this,"_connectionState",$e.CLOSED),y(this,"reconnectToken",void 0),y(this,"websocket",void 0),y(this,"openConnectionTime",void 0),y(this,"clientId",void 0),y(this,"lastMsgTime",Date.now()),y(this,"uploadCache",[]),y(this,"uploadCacheInterval",void 0),y(this,"rttRolling",new kv(5)),y(this,"pingpongTimer",void 0),y(this,"inflateDataTimer",void 0),y(this,"pingpongTimeoutCount",0),y(this,"ortc",void 0),y(this,"joinResponse",void 0),y(this,"multiIpOption",void 0),y(this,"initError",void 0),y(this,"spec",void 0),y(this,"store",void 0),y(this,"isJoining",!1),y(this,"pendingNotifications",[]),y(this,"onWebsocketMessage",r=>{if(r instanceof ArrayBuffer)return void this.emit(Ee.ON_BINARY_DATA,r);const i=JSON.parse(r);if(w("DC_DEBUG_LOG")&&g.debug("[datachannel-signal] received packet",i),this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(i,"_id")){const o="res-@".concat(i._id);this.emit(o,i._result,i._message)}else Object.prototype.hasOwnProperty.call(i,"_type")&&(this.isJoining?i._type===Pe.ON_NOTIFICATION||i._type===Pe.ON_USER_BANNED?(this.emit(i._type,i._message),i._type===Pe.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===Pe.ON_USER_BANNED&&this.handleUserBanned(i._message)):(this.pendingNotifications.push({type:i._type,message:i._message}),g.debug("[".concat(this.clientId,"] cached notification during join: ").concat(i._type))):(this.emit(i._type,i._message),i._type===Pe.ON_NOTIFICATION&&this.handleNotification(i._message),i._type===Pe.ON_USER_BANNED&&this.handleUserBanned(i._message)))}),this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new gx("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===$e.CONNECTED&&this.reconnect("retry",Ia.OFFLINE)})}async request(t,n,r,i){const o=_t(6,""),s={_id:o,_type:t,_message:n},c=this.websocket.connectionID,l=()=>new se((I,v)=>{if(this.connectionState===$e.CONNECTED)return I();const R=()=>{this.off(Ee.WS_CLOSED,A),I()},A=()=>{this.off(Ee.WS_CONNECTED,R),v(new B(b.WS_ABORT))};this.once(Ee.WS_CONNECTED,R),this.once(Ee.WS_CLOSED,A),t!==ge.PUBLISH&&t!==ge.SUBSCRIBE&&t!==ge.UNSUBSCRIBE&&t!==ge.UNPUBLISH&&t!==ge.CONTROL&&t!==ge.RESTART_ICE||this.once(Ee.DISCONNECT_P2P,()=>{v(new B(b.DISCONNECT_P2P))}),t!==ge.PUBLISH&&t!==ge.RESTART_ICE||this.once(Ee.ABORT_P2P_EXECUTION,()=>{v(new B(b.DISCONNECT_P2P))})});if(this.connectionState!==$e.CONNECTING&&this.connectionState!==$e.RECONNECTING||t===ge.JOIN||t===ge.REJOIN||await l(),t===ge.LEAVE&&(this.websocket.unbindDcCloseEventListener(),i=!0),w("DC_DEBUG_LOG")&&g.debug("[datachannel-signal] sendMessage",s),await this.websocket.sendMessage(s,!0,!1),i)return;const u=new se((I,v)=>{let R=!1;const A=(P,M)=>{R=!0,I({isSuccess:P==="success",message:M||{}}),this.off(Ee.WS_CLOSED,O),this.off(Ee.WS_RECONNECTING,O),this.emit(Ee.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(o),A);const O=()=>{v(new B(b.WS_ABORT,"type: ".concat(t))),this.off(Ee.WS_CLOSED,O),this.off(Ee.WS_RECONNECTING,O),this.off("res-@".concat(o),A)};this.once(Ee.WS_CLOSED,O),this.once(Ee.WS_RECONNECTING,O),In(w("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==c||R||(g.warning("dc request timeout, type: ".concat(t)),this.emit(Ee.REQUEST_TIMEOUT,t,n))})});let h=null;try{h=await u}catch(I){if(this.connectionState===$e.CLOSED||t===ge.LEAVE)throw new B(b.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?I.throw():t===ge.JOIN||t===ge.REJOIN?null:(await l(),await this.request(t,n))}if(h.isSuccess)return h.message;const f=Number(h.message.error_code||h.message.code),_=Kc(f),E=new B(b.UNEXPECTED_RESPONSE,"".concat(_.desc,": ").concat(h.message.error_str),{code:f,data:h.message});return _.action==="success"?h.message:(g.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(f,", message: ").concat(_.desc,", action: ").concat(_.action)),f===Re.ERR_TOO_MANY_BROADCASTERS?((t===ge.JOIN||t===ge.REJOIN)&&(this.initError=E,this.close()),E.throw()):_.action==="failed"?E.throw():_.action==="quit"?(this.initError=E,this.close(),E.throw()):(f===Re.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=h.message.option,g.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Ia.MULTI_IP)):this.reconnect(_.action,Ia.SERVER_ERROR),t===ge.JOIN||t===ge.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new se(r=>{const i=o=>{(!n||n(o))&&(this.off(t,i),r(o))};this.on(t,i)})}uploadWRTCStats(t){if(!this.store.sessionId)return void g.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Hc.WRTC_STATS,n)}upload(t,n){const r={_type:t,_message:n};try{this.websocket.sendMessage(r)}catch{const o=w("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==$e.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},w("UPLOAD_CACHE_INTERVAL")||2e3))}}async send(t,n){const r={_type:t,_message:n};await this.websocket.sendMessage(r)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new se((n,r)=>{this.once(Ee.WS_CONNECTED,()=>n(this.joinResponse)),this.once(Ee.WS_CLOSED,()=>r(this.initError||new B(b.WS_ABORT))),this.connectionState=$e.CONNECTING,this.websocket.init(t).catch(r),this.websocket.once(gn.FAILBACK,()=>{r(new B(b.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{this.openConnectionTime===void 0&&(g.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),r(new B(b.INIT_DATACHANNEL_TIMEOUT)))},w("DC_JOIN_WITH_FAILBACK"))})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this.isJoining=!1,this.pendingNotifications=[],this._disconnectedReason=t||Ze.LEAVE,this.connectionState=$e.CLOSED,g.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===Ze.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new gx("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),w("DC_PINGPONG_INTERVAL")),!this.joinResponse){this.emit(Ee.ABORT_P2P_EXECUTION),this.store.signalConnected();const t=await hn(this,Ee.REQUEST_JOIN_INFO);this.store.joinReq(),this.isJoining=!0,this.pendingNotifications=[];const n=await this.request(ge.JOIN,t);if(this.store.joinRep(),this.ortc=t==null?void 0:t.ortc,!n)return this.emit(Ee.REPORT_JOIN_GATEWAY,b.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(Ee.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=$e.CONNECTED,this.isJoining=!1,this.processPendingNotifications(),!0}async rejoin(){if(!this.reconnectToken)throw new B(b.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=Nc(this,Ee.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const n=await this.request(ge.REJOIN,t);return!!n&&(this.connectionState=$e.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),w("DC_PINGPONG_INTERVAL")),n.peers&&n.peers.forEach(r=>{this.emit(Pe.ON_USER_ONLINE,{uid:r.uid}),r.audio&&this.emit(Pe.ON_ADD_AUDIO_STREAM,{uid:r.uid,uint_id:r.uint_id,audio:!0,ssrcId:r.audio_ssrc}),r.video&&this.emit(Pe.ON_ADD_VIDEO_STREAM,{uid:r.uid,uint_id:r.uint_id,video:!0,ssrcId:r.video_ssrc}),r.audio_mute?this.emit(Pe.MUTE_AUDIO,{uid:r.uid}):this.emit(Pe.UNMUTE_AUDIO,{uid:r.uid}),r.video_mute?this.emit(Pe.MUTE_VIDEO,{uid:r.uid}):this.emit(Pe.UNMUTE_VIDEO,{uid:r.uid}),r.audio_enable_local?this.emit(Pe.ENABLE_LOCAL_AUDIO,{uid:r.uid}):this.emit(Pe.DISABLE_LOCAL_AUDIO,{uid:r.uid}),r.video_enable_local?this.emit(Pe.ENABLE_LOCAL_VIDEO,{uid:r.uid}):this.emit(Pe.DISABLE_LOCAL_VIDEO,{uid:r.uid}),r.audio||r.video||this.emit(Pe.ON_REMOVE_STREAM,{uid:r.uid,uint_id:r.uint_id})}),!0)}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}async downgradeCodec(t){if(!this.ortc)return!1;const n={downgrade_codec:t,ortc:this.ortc};return!!await this.request(ge.DOWNGRADE_CODEC,n)}handleNotification(t){g.debug("[".concat(this.clientId,"] receive notification: "),t);const n=Kc(t.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ze.UID_BANNED),void this.close()):void this.reconnect(n.action,Ia.SERVER_ERROR);g.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1,w("DC_DEBUG_LOG")&&console.debug("[datachannel-signal] pingpongTimeoutCount: ".concat(this.pingpongTimeoutCount));const t=w("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(g.warning("[datachannel-signal] PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>w("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("recover",Ia.FALLBACK):this.request(ge.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const r=Date.now()-n;this.rttRolling.add(r),w("REPORT_STATS")&&this.send(ge.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleInflateData(){const{inflateLength:t,deflateLength:n}=this.websocket.getInflateData();t!==0&&n!==0&&this.upload(Hc.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(gn.RECONNECT_CREATE_CONNECTION,t=>{this.emit(Ee.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(gn.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(gn.CLOSED,()=>{this.connectionState=$e.CLOSED}),this.websocket.on(gn.FAILED,()=>{this._disconnectedReason=Ze.NETWORK_ERROR,this.connectionState=$e.CLOSED}),this.websocket.on(gn.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===$e.CONNECTED?this.connectionState=$e.RECONNECTING:this.connectionState=$e.CONNECTING}),this.websocket.on(gn.WILL_RECONNECT,(t,n)=>{if(Nc(this,Ee.IS_P2P_DISCONNECTED)&&t==="retry")return g.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(Ee.NEED_RENEW_SESSION),this.emit(Ee.DISCONNECT_P2P),n("tryNext");t!=="retry"&&(g.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(Ee.NEED_RENEW_SESSION),this.emit(Ee.DISCONNECT_P2P)),n(t)}),this.websocket.on(gn.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{g.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Ia.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(Ee.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof B&&t.code===b.UNEXPECTED_RESPONSE&&t.data.code===Re.ERR_NO_AUTHORIZED)return g.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Ia.SERVER_ERROR);g.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Ia.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(gn.REQUEST_NEW_URLS,(t,n)=>{hn(this,Ee.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)}),this.websocket.on(gn.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Pe.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(gn.TO_CONNECT_DATACHANNEL,(t,n)=>{hn(this,Ee.PRE_CONNECT_PC).then(t).catch(n)}),this.websocket.on(gn.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(Ee.DATACHANNEL_FAILBACK)})}}const aZ={name:"DataChannelConnection",create:function(e){let{store:t,spec:n}=e;return new rZ(n,t)}},cZ={name:"DataChannelSignal",create:function(e){let{store:t,spec:n}=e;return new sZ(n,t)}};Bv(),vt("PROCESS_ID","process-".concat(_t(8,""),"-").concat(_t(4,""),"-").concat(_t(4,""),"-").concat(_t(4,""),"-").concat(_t(12,""))),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void g.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),n=Date.now();g.debug("Loading global parameters from cache",t),Object.keys(t).forEach(r=>{if(Object.prototype.hasOwnProperty.call(mt,r)){const{value:i,expires:o}=t[r];if(o&&o<=n)return;fi[r]=i,mt[r]=i}})}catch(t){g.error("Error loading mutableParamsCache: ".concat(e),t.message)}}(),Array.isArray(fi.AREAS)&&fi.AREAS.length>0&&jR(fi.AREAS,!0);const Sx=(e,t,n)=>{g.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(t))),vt(e,t,n)};gs(CQ,!1),gs(AQ,!1),gs(rJ,!1),gs(VQ,!1),gs(vQ,!1),gs(JQ,!1),gs($Q,!1),gs(tZ,!1),gs(aZ,!1),gs(cZ,!1);const pn=function(e){const t=new Wt,n=e,r={getListeners:t.getListeners.bind(t),on:(i,o)=>(function(s,c){s===_s.SECURITY_POLICY_VIOLATION&&z2(c,!0)}(i,o),t.on.bind(t)(i,o)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return Y2(Y2({},n),r)}({__TRACK_LIST__:Uc,VERSION:Li,BUILD:Wv,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:Sx,getParameter:w,getSupportedCodec:async function(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection;const n=await async function(r){let i;return Xe().supportUnifiedPlan?(r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"}),i=(await r.createOffer()).sdp):i=(await r.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,i}(t);if(!n)return e;t.close(),t=null,e=function(r){const i={video:[],audio:[]};return r.match(/ VP8/i)&&i.video.push("VP8"),r.match(/ VP9/i)&&i.video.push("VP9"),r.match(/ AV1/i)&&i.video.push("AV1"),r.match(/ H264/i)&&i.video.push("H264"),r.match(/ H265/i)&&i.video.push("H265"),r.match(/ opus/i)&&i.audio.push("OPUS"),r.match(/ PCMU/i)&&i.audio.push("PCMU"),r.match(/ PCMA/i)&&i.audio.push("PCMA"),r.match(/ G722/i)&&i.audio.push("G722"),i}(n)}catch(t){throw new B(b.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return e},checkSystemRequirements:function(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];const t=pe.reportApiInvoke(null,{name:Ft.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:It.TRACER}),n=function(){let o=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0],s=!1;try{const c=window.RTCPeerConnection,l=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,u=window.WebSocket;s=!(!c||!u),o&&!l&&(s=!1),s&&hh()&&iP(75)&&new c().close()}catch(c){g.error("check system requirement failed: ",c),s=!1}return s}(e),r=oJ();g.debug("checkSystemRequirements, api:",n,"browser",r);const i=n&&r;return t.onSuccess(i),w("IGNORE_RTC_DEVICE_CHECK")?n:i},getDevices:function(e){return Si.enumerateDevices(!0,!0,e)},getMicrophones:function(e){return Si.getRecordingDevices(e)},getCameras:function(e){return Si.getCamerasDevices(e)},getElectronScreenSources:dL,getPlaybackDevices:function(e){return Si.getSpeakers(e)},createClient:W2,createCameraVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=w("CAMERA_CAPTURE_CONFIG"),n=_t(8,"track-cam-"),r=pe.reportApiInvoke(null,{id:n,tag:It.TRACER,name:Ft.CREATE_CAM_VIDEO_TRACK,options:[Pt({},e),t]});t&&(e.encoderConfig=t);const i=G_(e);let o=null;g.info("start create camera video track with config",JSON.stringify(e),"trackId",n);try{o=(await gi({video:i},n)).getVideoTracks()[0]||null}catch(c){throw r.onError(c),c}if(!o){const c=new W(b.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(c),c.throw(g)}if(e.optimizationMode&&cR(n,o,e,co(e.encoderConfig)),w("USE_STANDARD_BITRATE_DEFAULT")){const c=co(e.encoderConfig);e.encoderConfig=c,delete c.bitrateMax,delete c.bitrateMin}const s=new H_(o,e,i,e.scalabiltyMode?V_(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,n);return r.onSuccess(s.getTrackId()),g.info("create camera video success, trackId:",n),s},createCustomVideoTrack:function(e){const t=_t(8,"track-cus-"),n=pe.reportApiInvoke(null,{id:t,tag:It.TRACER,name:Ft.CREATE_CUSTOM_VIDEO_TRACK,options:[e]});w("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin);const r=new wt(e.mediaStreamTrack,{width:e.width,height:e.height,frameRate:e.frameRate,bitrateMax:e.bitrateMax,bitrateMin:e.bitrateMin},e.scalabiltyMode?V_(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,t,[pt.CUSTOM_TRACK]);return n.onSuccess(r.getTrackId()),g.info("create custom video track success with config",e,"trackId",r.getTrackId()),r},createScreenVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable";const n=typeof t=="object"?function(_){const E=SL(_);return ZP()&&_.suppressLocalAudioPlayback&&(E.suppressLocalAudioPlayback=_.suppressLocalAudioPlayback),$P()&&_.restrictOwnAudio&&(E.restrictOwnAudio=!0),E}(t):void 0;n&&(t="auto");const r=_t(8,"track-scr-v-"),i=pe.reportApiInvoke(null,{id:r,tag:It.TRACER,name:Ft.CREATE_SCREEN_VIDEO_TRACK,options:[Pt({},e),t]});e.encoderConfig?typeof e.encoderConfig=="string"||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";const o=function(_){const E={};_.screenSourceType&&(E.mediaSource=_.screenSourceType),_.extensionId&&Fs()&&(E.extensionId=_.extensionId);const{displaySurface:I,selfBrowserSurface:v,surfaceSwitching:R,systemAudio:A,preferCurrentTab:O,windowAudio:P,monitorTypeSurfaces:M}=_;(ko(107)||Ta(107)||Ac(93))&&(I&&(sn(I,"displaySurface",["browser","window","monitor"]),E.displaySurface=I),v?(sn(v,"selfBrowserSurface",["exclude","include"]),E.selfBrowserSurface=v):E.selfBrowserSurface="include",R&&(sn(R,"surfaceSwitching",["exclude","include"]),E.surfaceSwitching=R)),(ko(105)||Ta(105)||Ac(91))&&A&&(sn(A,"systemAudio",["exclude","include"]),E.systemAudio=A),(ko(94)||Ta(94)||Ac(80))&&O&&(E.preferCurrentTab=!0),(ko(141)||Ta(141)||Ac(125))&&P&&(sn(P,"windowAudio",["exclude","system"]),E.windowAudio=P),(ko(119)||Ta(119)||Ac(105))&&M&&(sn(M,"monitorTypeSurfaces",["exclude","include"]),E.monitorTypeSurfaces=M),_.electronScreenSourceId&&(E.sourceId=_.electronScreenSourceId);const U=_.encoderConfig?Xv(_.encoderConfig):null;return E.mandatory={chromeMediaSource:"desktop",maxWidth:U?U.width:void 0,maxHeight:U?U.height:void 0},U&&(U.frameRate&&(typeof U.frameRate=="number"?(E.mandatory.maxFrameRate=U.frameRate,E.mandatory.minFrameRate=U.frameRate):(E.mandatory.maxFrameRate=U.frameRate.max||U.frameRate.ideal||U.frameRate.exact||void 0,E.mandatory.minFrameRate=U.frameRate.min||U.frameRate.ideal||U.frameRate.exact||void 0),E.frameRate=U.frameRate),U.width&&(E.width=U.width),U.height&&(E.height=U.height)),E}(e);let s=null,c=null;const l=Xe();if(!l.supportShareAudio&&t==="enable"){const _=new W(b.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return i.onError(_),_.throw(g)}g.info("start create screen video track with config",e,"withAudio",t,"trackId",r);const u=l.supportShareAudio&&t!=="disable";try{const _=await gi({screen:o,screenAudio:u?n||!0:void 0},r);s=_.getVideoTracks()[0]||null,c=_.getAudioTracks()[0]||null}catch(_){throw i.onError(_),_}if(!s){const _=new W(b.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(_),_.throw(g)}if(!c&&t==="enable"){s&&s.stop();const _=new W(b.SHARE_AUDIO_NOT_ALLOWED);return i.onError(_),_.throw(g)}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(cR(r,s,e,e.encoderConfig&&Xv(e.encoderConfig)||void 0),e.encoderConfig&&typeof e.encoderConfig!="string"&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));const h=new wt(s,e.encoderConfig?Xv(e.encoderConfig):{},e.scalabiltyMode?V_(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r,[pt.SCREEN_TRACK]);if(!c)return i.onSuccess(h.getTrackId()),g.info("create screen video track success","video:",h.getTrackId()),h;const f=new Zt(c,void 0,_t(8,"track-scr-a-"),!1);return i.onSuccess([h.getTrackId(),f.getTrackId()]),g.info("create screen video track success","video:",h.getTrackId(),"audio:",f.getTrackId()),[h,f]},createMicrophoneAndCameraTracks:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=w("CAMERA_CAPTURE_CONFIG"),r=_t(8,"track-mic-"),i=_t(8,"track-cam-"),o=pe.reportApiInvoke(null,{id:"".concat(r,"-").concat(i),tag:It.TRACER,name:Ft.CREATE_MIC_AND_CAM_TRACKS,options:[e,t,n]});n&&(t.encoderConfig=n);const s=G_(t),c=TL(e);let l=null,u=null;g.info("start create camera video track(".concat(i,") and microphone audio track(").concat(r,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(t)));try{const _=await gi({audio:c,video:s},"".concat(r,"-").concat(i));l=_.getAudioTracks()[0],u=_.getVideoTracks()[0]}catch(_){throw o.onError(_),_}if(!l||!u){const _=new W(b.UNEXPECTED_ERROR,"can not find tracks in media stream");return o.onError(_),_.throw(g)}if(t.optimizationMode&&cR(i,u,t,co(t.encoderConfig)),w("USE_STANDARD_BITRATE_DEFAULT")){const _=co(t.encoderConfig);t.encoderConfig=_,delete _.bitrateMax,delete _.bitrateMin}const h=new Rh(l,e,c,r),f=new H_(u,t,s,t.scalabiltyMode?V_(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,i);return o.onSuccess([h.getTrackId(),f.getTrackId()]),g.info("create camera video track(".concat(i,") and microphone audio track(").concat(r,") success")),[h,f]},createMicrophoneAudioTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=_t(8,"track-mic-"),n=pe.reportApiInvoke(null,{id:t,tag:It.TRACER,name:Ft.CREATE_MIC_AUDIO_TRACK,options:[e]}),r=TL(e);let i=null;g.info("start create microphone audio track with config",JSON.stringify(e),"trackId",t);try{i=(await gi({audio:r},t)).getAudioTracks()[0]||null}catch(s){throw n.onError(s),s}if(!i){const s=new W(b.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(s),s.throw(g)}const o=new Rh(i,e,r,t);return n.onSuccess(o.getTrackId()),g.info("create microphone audio track success, trackId:",t),o},createCustomAudioTrack:Yk,createBufferSourceAudioTrack:async function(e){var t;const{cacheOnlineFile:n,encoderConfig:r}=e;let{source:i}=e;const o={source:i instanceof AudioBuffer?"AudioBuffer":i instanceof File?(t=File.name)!==null&&t!==void 0?t:"File":i,cacheOnlineFile:n,encoderConfig:r},s=_t(8,"track-buf-"),c=pe.reportApiInvoke(null,{id:s,tag:It.TRACER,name:Ft.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(w("DISABLE_WEBAUDIO"))throw new W(b.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");g.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",s);const l=i;if(!(i instanceof AudioBuffer))try{i=await async function(f,_){let E=null;if(typeof f=="string"){const v=ak.get(f);if(v)return g.debug("use cached audio resource: ",f),v;try{E=(await Mo(()=>br.get(f,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(R){throw new W(b.FETCH_AUDIO_FILE_FAILED,R.toString())}}else E=await new se((R,A)=>{const O=new FileReader;O.onload=P=>{P.target?R(P.target.result):A(new W(b.READ_LOCAL_AUDIO_FILE_ERROR))},O.onerror=()=>{A(new W(b.READ_LOCAL_AUDIO_FILE_ERROR))},O.readAsArrayBuffer(f)});const I=await function(v){const R=El();return new se((A,O)=>{R.decodeAudioData(v,P=>{A(P)},P=>{O(new W(b.DECODE_AUDIO_FILE_FAILED,P.toString()))})})}(E);return typeof f=="string"&&_&&ak.set(f,I),I}(i,n)}catch(f){return c.onError(f),f.throw(g)}const u=new Cq(i),h=new yq(l,u,r?F_(r):{},s);return g.info("create buffer source audio track success, trackId:",s),c.onSuccess(h.getTrackId()),h},setAppType:function(e){if(g.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw g.debug("Invalid appType"),new B(b.INVALID_PARAMS,"invalid app type",e);vt("APP_TYPE",Math.floor(e))},setLogLevel:function(e){g.setLogLevel(e)},enableLogUpload:function(){w("USE_NEW_LOG")?vt("UPLOAD_LOG",!0):g.enableLogUpload()},disableLogUpload:function(){w("USE_NEW_LOG")?vt("UPLOAD_LOG",!1):g.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new lM},checkAudioTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=pe.reportApiInvoke(null,{tag:It.TRACER,name:Ft.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof Zt||e instanceof Tl)){const l=new B(b.INVALID_TRACK,"the parameter is not a audio track");return n.onError(l),l.throw()}t&&t<1e3&&(t=1e3);const r=e instanceof Zt?e.getTrackLabel():"remote_track",i=e.getVolumeLevel();let o=i,s=i;const c=Date.now();return new se(l=>{const u=setInterval(()=>{const h=e.getVolumeLevel();o=h>o?h:o,s=h<s?h:s;const f=o-s>1e-4,_=Date.now()-c;if(f||_>t){clearInterval(u);const E=f,I={duration:_,deviceLabel:r,maxVolumeLevel:o,result:E};g.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(I))),n.onSuccess(I),l(E)}},200)})},checkVideoTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const n=pe.reportApiInvoke(null,{tag:It.TRACER,name:Ft.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof wt||e instanceof Sl)){const f=new B(b.INVALID_TRACK,"the parameter is not a video track");return n.onError(f),f.throw()}t&&t<1e3&&(t=1e3);const r=e instanceof wt?e.getTrackLabel():"remote_track",i=e.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(Pn()||w_())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([i]),o.play();const s=document.createElement("canvas");s.width=160,s.height=120;let c=0,l=0;try{const f=Date.now();c=await function(_,E,I,v){let R,A=0,O=null;return new se((P,M)=>{function U(){A>v&&R&&(R(),P(A));const L=I.getContext("2d");if(!L){const q=new B(b.UNEXPECTED_ERROR,"can not get canvas 2d context.");return g.error(q.toString()),void M(q)}L.drawImage(_,0,0,160,120);const V=L.getImageData(0,0,I.width,I.height),H=Math.floor(V.data.length/3);if(O){for(let q=0;q<H;q+=3)if(V.data[q]!==O[q])return A+=1,void(O=V.data);O=V.data}else O=V.data}setTimeout(()=>{R&&(R(),P(A))},E),R=tR(()=>{U()},30)})}(o,t,s,4),l=Date.now()-f}catch(f){throw n.onError(f),f}WX===at.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;const u=c>4,h={duration:l,changedPicNum:c,deviceLabel:r,result:u};return g.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(h))),n.onSuccess(h),u},setArea:jR,audioElementPlayCenter:dr,resumeAudioContext:function(){return dr.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(e){aJ.processExternalMediaAEC(e)},registerExtensions:function(e){const t=w("PLUGIN_INFO")||[];e.forEach(n=>{"name"in n&&!Z(t).call(t,n.name)&&t.push(n.name);const r=n;r.__registered__=!0,r.logger.hookLog=g.extLog,r.reporter.hookApiInvoke=pe.extApiInvoke,r.parameters&&Object.keys(r.parameters).forEach(i=>{r.parameters[i]=w(i)})}),Sx("PLUGIN_INFO",t)},ChannelMediaRelayError:yl,ChannelMediaRelayEvent:Ws,ChannelMediaRelayState:Gr,RemoteStreamFallbackType:Eq,RemoteStreamType:mq,ConnectionDisconnectedReason:Ze,AudienceLatencyLevelType:K7,AREAS:dt,preload:async function(e,t,n,r){return dy(e,t,n,r)},startLastmileProbeTest:async function(e,t,n,r){let i={state:"unavailable"};await dy(e,t,n,r);const o=await ly({appId:e,cname:t,token:n||e,uid:r,cloudProxyServer:"disabled"});if(!o)return i;await uy(o);let s,c=W2({mode:"rtc",codec:"vp8"});try{s=await c.join(e,t,n,r,{networkQualityProbe:!0})}catch{return i}const l=new zX,u=l.createMuteAudioTrack();let h=await Yk({mediaStreamTrack:u});await c.publish([h]);let[f,_,E]=await new se((P,M)=>{const U=setTimeout(()=>{clearTimeout(U),P([!0,null,"audio"])},5e3);c.on("user-published",async(L,V)=>{L.uid===s&&(clearTimeout(U),P([!1,L,V]))})});if(f||!_)return await c.unpublish([h]),await c.leave(),h.close(),l.close(),i;await c.subscribe(_,E),await new se((P,M)=>{const U=setTimeout(()=>{clearTimeout(U),P(null)},5e3)});let I=c.getRTCStats(),v=c.getLocalAudioStats();const R=I.RTT,A=v.sendJitterMs,O=v.currentPacketLossRate;return i={state:"complete",rtt:R,packetLossRate:O,jitter:A,networkQuality:((P,M,U)=>{let L=1;if(U>0){let Ne=Math.log(100*U)/Math.log(2)+1;Ne=Math.min(5,Math.max(0,Ne)),L=1-Ne/5}let V=1;if(P>0){let Ne=Math.log(P/40)/Math.log(2)+1;Ne=Math.min(5,Math.max(0,Ne)),V=1-Ne/5}let H=1;if(M>0){let Ne=Math.log(M/10)/Math.log(2.5)+1;Ne=Math.min(5,Math.max(0,Ne)),H=1-Ne/5}const q=.5*L+.3*V+.2*H;let de=0;return de=q>=.8?1:q>=.6?2:q>=.4?3:q>=.2?4:5,de})(R,A,O)},await c.unsubscribe(_),await c.unpublish([h]),await c.leave(),h.close(),l.close(),await uy(o),i}});return Object.defineProperties(pn,{onAudioAutoplayFailed:{get:()=>Nr.onAudioAutoplayFailed,set:e=>{Nr.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>Nr.onAutoplayFailed,set:e=>{Nr.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>pn._onSecurityPolicyViolation,set(e){pn._onSecurityPolicyViolation=e,z2(e)}},__CLIENT_LIST__:{get:()=>w("SHOW_GLOBAL_CLIENT_LIST")?Gc:[]}}),Si.on(Vc.CAMERA_DEVICE_CHANGED,e=>{g.info("camera device changed",JSON.stringify(e)),pn.onCameraChanged&&pn.onCameraChanged(e),pn.safeEmit(_s.CAMERA_CHANGED,e)}),Si.on(Vc.RECORDING_DEVICE_CHANGED,e=>{g.info("microphone device changed",JSON.stringify(e)),pn.onMicrophoneChanged&&pn.onMicrophoneChanged(e),pn.safeEmit(_s.MICROPHONE_CHANGED,e)}),Si.on(Vc.PLAYOUT_DEVICE_CHANGED,e=>{g.debug("playout device changed",JSON.stringify(e)),pn.onPlaybackDeviceChanged&&pn.onPlaybackDeviceChanged(e),pn.safeEmit(_s.PLAYBACK_DEVICE_CHANGED,e)}),dr.onAutoplayFailed=()=>{g.info("detect audio element autoplay failed"),Nr.onAudioAutoplayFailed&&Nr.onAudioAutoplayFailed()},Rt.on("autoplay-failed",()=>{g.info("detect webaudio autoplay failed"),Nr.onAudioAutoplayFailed&&Nr.onAudioAutoplayFailed(),pn.safeEmit(_s.AUTOPLAY_FAILED)}),Rt.on(Gn.STATE_CHANGE,(e,t)=>{g.info("audio context state changed: ".concat(t," => ").concat(e)),pn.onAudioContextStateChanged&&pn.onAudioContextStateChanged(e,t),pn.safeEmit(_s.AUDIO_CONTEXT_STATE_CHANGED,e,t)}),qt.on(Oc.NETWORK_STATE_CHANGE,(e,t)=>{g.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))}),window&&(window.__ARTC__=pn),pn})})(QB);var Uee=QB.exports;const Yl=VV(Uee);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */var xee={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vee=a=>a.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase().trim(),fr=(a,d)=>{const p=et.forwardRef(({color:m="currentColor",size:S=24,strokeWidth:C=2,absoluteStrokeWidth:N,className:F="",children:x,...X},_e)=>et.createElement("svg",{ref:_e,...xee,width:S,height:S,stroke:m,strokeWidth:N?Number(C)*24/Number(S):C,className:["lucide",`lucide-${Vee(a)}`,F].join(" "),...X},[...d.map(([oe,re])=>et.createElement(oe,re)),...Array.isArray(x)?x:[x]]));return p.displayName=`${a}`,p};/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fee=fr("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const DV=fr("EyeOff",[["path",{d:"M9.88 9.88a3 3 0 1 0 4.24 4.24",key:"1jxqfv"}],["path",{d:"M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68",key:"9wicm4"}],["path",{d:"M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61",key:"1jreej"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const PV=fr("Eye",[["path",{d:"M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z",key:"rwhkz3"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Bee=fr("Globe",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20",key:"13o1zl"}],["path",{d:"M2 12h20",key:"9i4pu4"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const jee=fr("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fC=fr("MicOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const LV=fr("Mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Gee=fr("MonitorOff",[["path",{d:"M17 17H4a2 2 0 0 1-2-2V5c0-1.5 1-2 1-2",key:"k0q8oc"}],["path",{d:"M22 15V5a2 2 0 0 0-2-2H9",key:"cp1ac0"}],["path",{d:"M8 21h8",key:"1ev6f3"}],["path",{d:"M12 17v4",key:"1riwvh"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wee=fr("Monitor",[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Hee=fr("PhoneOff",[["path",{d:"M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91",key:"z86iuo"}],["line",{x1:"22",x2:"2",y1:"2",y2:"22",key:"11kh81"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kee=fr("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yee=fr("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zee=fr("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qee=fr("Signal",[["path",{d:"M2 20h.01",key:"4haj6o"}],["path",{d:"M7 20v-4",key:"j294jx"}],["path",{d:"M12 20v-8",key:"i3yub9"}],["path",{d:"M17 20V8",key:"1tkaf5"}],["path",{d:"M22 4v16",key:"sih9yq"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xee=fr("Sparkles",[["path",{d:"m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z",key:"17u4zn"}],["path",{d:"M5 3v4",key:"bklmnn"}],["path",{d:"M19 17v4",key:"iiml17"}],["path",{d:"M3 5h4",key:"nem4j1"}],["path",{d:"M17 19h4",key:"lbex7p"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jee=fr("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const kV=fr("VideoOff",[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.34l1 1L22 8v8",key:"ubwiq0"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2l10 10Z",key:"1l10zd"}],["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zl=fr("Video",[["path",{d:"m22 8-6 4 6 4V8Z",key:"50v9me"}],["rect",{width:"14",height:"12",x:"2",y:"6",rx:"2",ry:"2",key:"1rqjg6"}]]);/**
 * @license lucide-react v0.294.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const NE=fr("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]);function Ga(...a){return a.filter(Boolean).join(" ")}function MV({open:a,title:d,children:p,onClose:m}){return a?G.jsx("div",{className:"sheetBackdrop",role:"dialog","aria-modal":"true",onMouseDown:m,children:G.jsxs("div",{className:"sheet",onMouseDown:S=>S.stopPropagation(),children:[G.jsxs("div",{className:"sheetHeader",children:[G.jsx("div",{className:"sheetTitle",children:G.jsx("div",{className:"titleText",children:d})}),G.jsx("button",{className:"iconBtn",onClick:m,"aria-label":"Close",children:G.jsx(NE,{size:20})})]}),G.jsx("div",{className:"sheetBody",children:p})]})}):null}const Qee=({room:a,token:d,uid:p,username:m,type:S,appId:C,hasConsent:N,onConsentGranted:F})=>{const[x,X]=et.useState({video:null,audio:null}),[_e,oe]=et.useState([]),[re,Ce]=et.useState(!1),[fe,Oe]=et.useState(!1),[Vt,J]=et.useState(!1),[K,Q]=et.useState(!1),[Te,Ve]=et.useState(!1),[Be,Me]=et.useState(!1),[ze,Kt]=et.useState(null),[ht,Ye]=et.useState(!1),[qe,Tn]=et.useState(!1),[At,rr]=et.useState(!1),[Fr,$t]=et.useState(!1),[be,lt]=et.useState(!0),[gt,Rn]=et.useState([]),[tn,Io]=et.useState([]),[Fn,Ls]=et.useState(""),[Br,Xi]=et.useState(""),[Eg,cc]=et.useState(0),[dc,gg]=et.useState("DISCONNECTED"),[Cu,is]=et.useState({uplink:null,downlink:null}),[Sg,zp]=et.useState(!1),Ir=et.useRef(null),Iu=et.useRef(null),yn=et.useRef(null);et.useEffect(()=>{const ie=Yl.createClient({mode:"rtc",codec:"vp8"});return Ir.current=ie,ie.on("user-published",Au),ie.on("user-unpublished",Xp),ie.on("user-left",Jp),ie.on("connection-state-change",ve=>{gg(String(ve||"UNKNOWN").toUpperCase())}),ie.on("network-quality",ve=>{ve&&is({uplink:ve.uplinkNetworkQuality,downlink:ve.downlinkNetworkQuality})}),()=>{Qp()}},[]);const wr=et.useMemo(()=>{const ie=Math.max(Cu.uplink??0,Cu.downlink??0);return ie?ie<=2?"Excellent":ie<=3?"Good":ie<=4?"Fair":ie<=5?"Poor":"Bad":""},[Cu]),lc=async()=>{try{const[ie,ve]=await Promise.all([Yl.getMicrophones(),Yl.getCameras()]);Rn(ie||[]),Io(ve||[]),Ls(Lt=>{var bt;return Lt||((bt=ie==null?void 0:ie[0])==null?void 0:bt.deviceId)||""}),Xi(Lt=>{var bt;return Lt||((bt=ve==null?void 0:ve[0])==null?void 0:bt.deviceId)||""})}catch{}};et.useEffect(()=>{lc()},[]),et.useEffect(()=>{if(!x.audio||!re){cc(0);return}const ie=setInterval(()=>{var ve,Lt;try{const bt=((Lt=(ve=x.audio)==null?void 0:ve.getVolumeLevel)==null?void 0:Lt.call(ve))??0;cc(Math.max(0,Math.min(1,bt)))}catch{}},120);return()=>clearInterval(ie)},[x.audio,re]);const wu=async()=>{try{if(!("wakeLock"in navigator)||yn.current)return;yn.current=await navigator.wakeLock.request("screen"),yn.current.addEventListener("release",()=>{yn.current=null})}catch{}},Tg=async()=>{var ie,ve;try{await((ve=(ie=yn.current)==null?void 0:ie.release)==null?void 0:ve.call(ie))}catch{}yn.current=null},sa=ie=>{var ve,Lt;try{(ve=ie==null?void 0:ie.stop)==null||ve.call(ie)}catch{}try{(Lt=ie==null?void 0:ie.close)==null||Lt.call(ie)}catch{}},Zn=ie=>{try{if(!ie)return;ie.play("prejoin-player")}catch{}},uc=(ie,ve)=>{var Lt,bt;try{if(!ie)return;(Lt=ie.stop)==null||Lt.call(ie)}catch{}try{(bt=ie==null?void 0:ie.play)==null||bt.call(ie,ve)}catch{}},yd=async()=>{if(x.audio)return Fn&&typeof x.audio.setDevice=="function"&&await x.audio.setDevice(Fn),await x.audio.setEnabled(!0),Ce(!0),x.audio;const ie=await Yl.createMicrophoneAudioTrack(Fn?{microphoneId:Fn}:void 0);return X(ve=>({...ve,audio:ie})),Ce(!0),ie},Oi=async()=>{if(x.video)return Br&&typeof x.video.setDevice=="function"&&await x.video.setDevice(Br),await x.video.setEnabled(!0),Oe(!0),Zn(x.video),x.video;const ie=await Yl.createCameraVideoTrack(Br?{cameraId:Br}:void 0);return X(ve=>({...ve,video:ie})),Oe(!0),Zn(ie),ie},qp=async()=>{const ie=Ir.current;if(ie)try{Kt(null),Ye(!0),await ie.join(C,a,d,p);const ve=[];let Lt=null;if(re){const bt=await yd();bt&&ve.push(bt)}if(fe){const bt=await Oi();bt&&(Lt=bt,ve.push(bt))}ve.length&&await ie.publish(ve),Me(!0),await wu(),Lt&&uc(Lt,"local-player")}catch(ve){console.error("Failed to join channel:",ve),Kt((ve==null?void 0:ve.message)||"Failed to join room");try{await(ie==null?void 0:ie.leave())}catch{}}finally{Ye(!1)}},Au=async(ie,ve)=>{if(await Ir.current.subscribe(ie,ve),ve==="video"){oe(wo=>wo.find(ca=>ca.uid===ie.uid)?wo.map(ca=>ca.uid===ie.uid?{...ca,videoTrack:ie.videoTrack}:ca):[...wo,{uid:ie.uid,videoTrack:ie.videoTrack,audioTrack:null}]);const bt=(wo=0)=>{if(document.getElementById(`player-${ie.uid}`)&&ie.videoTrack){try{ie.videoTrack.play(`player-${ie.uid}`)}catch{}return}wo<15&&setTimeout(()=>bt(wo+1),120)};setTimeout(()=>bt(0),80)}ve==="audio"&&(oe(bt=>bt.find(di=>di.uid===ie.uid)?bt.map(di=>di.uid===ie.uid?{...di,audioTrack:ie.audioTrack}:di):[...bt,{uid:ie.uid,audioTrack:ie.audioTrack,videoTrack:null}]),ie.audioTrack&&ie.audioTrack.play())},Xp=(ie,ve)=>{ve==="video"&&oe(Lt=>Lt.map(bt=>bt.uid===ie.uid?{...bt,videoTrack:null}:bt)),ve==="audio"&&oe(Lt=>Lt.map(bt=>bt.uid===ie.uid?{...bt,audioTrack:null}:bt))},Jp=ie=>{oe(ve=>ve.filter(Lt=>Lt.uid!==ie.uid))},bu=async()=>{if(!Be){if(re){sa(x.audio),X(ve=>({...ve,audio:null})),Ce(!1);return}try{await yd()}catch(ve){Kt((ve==null?void 0:ve.message)||"Microphone permission denied")}return}if(x.audio){if(re){await x.audio.setEnabled(!1),Ce(!1);return}await x.audio.setEnabled(!0),Ce(!0);return}const ie=Ir.current;if(ie)try{const ve=await yd();await ie.publish(ve)}catch(ve){Kt((ve==null?void 0:ve.message)||"Microphone permission denied")}},Ou=async()=>{if(!Be){if(fe){sa(x.video),X(ve=>({...ve,video:null})),Oe(!1);return}try{await Oi()}catch(ve){Kt((ve==null?void 0:ve.message)||"Camera permission denied")}return}if(x.video){if(fe){await x.video.setEnabled(!1),Oe(!1);return}await x.video.setEnabled(!0),Oe(!0),uc(x.video,"local-player");return}const ie=Ir.current;if(ie)try{const ve=await Oi();await ie.publish(ve),ve.play("local-player")}catch(ve){Kt((ve==null?void 0:ve.message)||"Camera permission denied")}},ks=async()=>{const ie=Ir.current;if(Vt)await Cd();else try{const ve=await Yl.createScreenVideoTrack(),Lt=Array.isArray(ve)?ve[0]:ve;Iu.current=Lt,x.video&&await ie.unpublish(x.video),await ie.publish(Lt),uc(Lt,"local-player"),J(!0),Lt.on("track-ended",async()=>{await Cd()})}catch(ve){console.error("Failed to start screen sharing:",ve)}},Cd=async()=>{const ie=Ir.current,ve=Iu.current;if(ve){try{await ie.unpublish(ve)}catch{}sa(ve),Iu.current=null}x.video&&fe&&(await ie.publish(x.video),uc(x.video,"local-player")),J(!1)},Qp=async()=>{const ie=Ir.current;Vt&&await Cd(),sa(x.audio),sa(x.video),ie&&await ie.leave(),Me(!1),await Tg(),window.close()},Zp=ie=>{const ve=String(ie??"");return`Participant ${ve.length>4?ve.slice(-4):ve}`},aa=()=>{const ie=_e.length+1;return ie===1?"single":ie===2?"two":ie<=4?"four":"many"},hc=S==="main"?"PNP Room":"Private Call",Nu=_e.length+1;return ze?G.jsxs(G.Fragment,{children:[G.jsxs("header",{className:"header",children:[G.jsxs("div",{className:"brand",children:[G.jsx("div",{className:"brandMark",children:G.jsx(zl,{size:18})}),G.jsxs("div",{className:"brandText",children:[G.jsx("div",{className:"brandName",children:"PNPtv Hangouts"}),G.jsxs("div",{className:"brandTag",children:[hc,"  ",Nu," participants"]})]})]}),G.jsx("div",{className:"headerActions",children:G.jsx("button",{className:"iconBtn danger",onClick:()=>window.close(),title:"Exit","aria-label":"Exit",children:G.jsx(NE,{size:20})})})]}),G.jsx("main",{className:"main callBody",children:G.jsx("div",{className:"notice error",children:ze})})]}):N?Be?G.jsxs(G.Fragment,{children:[G.jsxs("header",{className:"header",children:[G.jsxs("div",{className:"brand",children:[G.jsx("div",{className:"brandMark",children:G.jsx(zl,{size:18})}),G.jsxs("div",{className:"brandText",children:[G.jsx("div",{className:"brandName",children:"PNPtv Hangouts"}),G.jsxs("div",{className:"brandTag",children:[hc,"  ",Nu," participants  ",G.jsx("span",{className:"monoInline",children:be?"Privacy on":"Privacy off"})]})]})]}),G.jsxs("div",{className:"headerActions",children:[G.jsx("button",{className:Ga("iconBtn",be&&"active"),onClick:()=>lt(ie=>!ie),title:be?"Privacy Mode: On":"Privacy Mode: Off","aria-label":"Toggle privacy mode",children:be?G.jsx(DV,{size:20}):G.jsx(PV,{size:20})}),G.jsx("button",{className:"iconBtn",onClick:async()=>{try{await navigator.clipboard.writeText(a),zp(!0),setTimeout(()=>zp(!1),1200)}catch{}},title:"Copy room code","aria-label":"Copy room code",children:G.jsx(Fee,{size:20})}),G.jsx("button",{className:"iconBtn",onClick:()=>Q(!0),title:"Participants","aria-label":"Participants",children:G.jsx(Jee,{size:20})}),G.jsx("button",{className:"iconBtn",onClick:()=>Ve(!0),title:"Settings","aria-label":"Settings",children:G.jsx(zee,{size:20})})]})]}),G.jsxs("main",{className:"main callBody",children:[G.jsxs("div",{className:"call-status",children:[G.jsxs("span",{className:"status-pill",children:[G.jsx(qee,{size:14})," ",dc]}),G.jsxs("span",{className:"status-pill",children:[G.jsx("span",{className:"dot"})," ",wr]})]}),G.jsxs("div",{className:`video-container ${aa()} ${be?"privacy":""}`,children:[G.jsxs("div",{className:"video-player local",children:[G.jsx("div",{id:"local-player",style:{width:"100%",height:"100%"}}),G.jsxs("div",{className:`player-info ${re?"":"muted"}`,children:[!re&&G.jsx(fC,{size:16}),be?"You":`${m||"You"} (You)`]})]}),_e.map(ie=>G.jsxs("div",{className:"video-player",children:[G.jsx("div",{id:`player-${ie.uid}`,style:{width:"100%",height:"100%"}}),G.jsx("div",{className:"player-info",children:be?Zp(ie.uid):`User ${ie.uid}`})]},ie.uid))]})]}),G.jsxs("div",{className:"callControls",children:[G.jsx("button",{className:Ga("iconBtn","callBtn",re?"active":""),onClick:bu,disabled:!Be,title:re?"Mute":"Unmute","aria-label":re?"Mute":"Unmute",children:re?G.jsx(LV,{size:22}):G.jsx(fC,{size:22})}),G.jsx("button",{className:Ga("iconBtn","callBtn",fe?"active":""),onClick:Ou,disabled:!Be,title:fe?"Stop Video":"Start Video","aria-label":fe?"Stop video":"Start video",children:fe?G.jsx(zl,{size:22}):G.jsx(kV,{size:22})}),G.jsx("button",{className:Ga("iconBtn","callBtn",Vt?"active":""),onClick:ks,disabled:!Be,title:Vt?"Stop Sharing":"Share Screen","aria-label":Vt?"Stop sharing":"Share screen",children:Vt?G.jsx(Gee,{size:22}):G.jsx(Wee,{size:22})}),G.jsx("button",{className:"iconBtn callBtn danger",onClick:Qp,title:"Leave Call","aria-label":"Leave call",children:G.jsx(Hee,{size:22})})]}),G.jsx(MV,{open:K,title:`Participants (${Nu})`,onClose:()=>Q(!1),children:G.jsxs("div",{className:"list",children:[G.jsx("div",{className:"listItem",children:be?"You":`${m||"You"} (You)`}),_e.map(ie=>G.jsx("div",{className:"listItem",children:be?Zp(ie.uid):`User ${ie.uid}`},ie.uid))]})}),G.jsx(MV,{open:Te,title:"Settings",onClose:()=>Ve(!1),children:G.jsxs("div",{className:"card",children:[G.jsx("div",{className:"hint",children:"Change mic/camera without leaving."}),G.jsxs("label",{className:"field",style:{marginTop:10},children:[G.jsx("div",{className:"label",children:"Microphone"}),G.jsx("select",{value:Fn,onChange:async ie=>{const ve=ie.target.value;Ls(ve);try{x.audio&&typeof x.audio.setDevice=="function"&&await x.audio.setDevice(ve)}catch{}},children:gt.map(ie=>G.jsx("option",{value:ie.deviceId,children:ie.label||`Microphone ${ie.deviceId.slice(-4)}`},ie.deviceId))})]}),G.jsxs("label",{className:"field",children:[G.jsx("div",{className:"label",children:"Camera"}),G.jsx("select",{value:Br,onChange:async ie=>{const ve=ie.target.value;Xi(ve);try{x.video&&typeof x.video.setDevice=="function"&&(await x.video.setDevice(ve),x.video.play("local-player"))}catch{}},children:tn.map(ie=>G.jsx("option",{value:ie.deviceId,children:ie.label||`Camera ${ie.deviceId.slice(-4)}`},ie.deviceId))})]}),G.jsxs("div",{className:"heroActions",children:[G.jsx("button",{className:"btn btnGhost",onClick:lc,type:"button",children:"Refresh devices"}),G.jsxs("button",{className:"btn btnGhost",onClick:()=>$t(ie=>!ie),type:"button",children:[Fr?"Hide":"Show"," room details"]})]}),Fr?G.jsxs("div",{className:"monoTextarea",children:["Room: ",a,`
`,"User ID: ",p,`
`,"Type: ",S,`
`,"Connection: ",dc,`
`,"Quality: ",wr]}):null]})}),Sg?G.jsx("div",{className:"toast",children:"Copied room code"}):null]}):G.jsxs(G.Fragment,{children:[G.jsxs("header",{className:"header",children:[G.jsxs("div",{className:"brand",children:[G.jsx("div",{className:"brandMark",children:G.jsx(zl,{size:18})}),G.jsxs("div",{className:"brandText",children:[G.jsx("div",{className:"brandName",children:"PNPtv Hangouts"}),G.jsxs("div",{className:"brandTag",children:[hc,"  Pre-join  18+"]})]})]}),G.jsxs("div",{className:"headerActions",children:[G.jsx("button",{className:Ga("iconBtn",be&&"active"),onClick:()=>lt(ie=>!ie),title:be?"Privacy Mode: On":"Privacy Mode: Off","aria-label":"Toggle privacy mode",children:be?G.jsx(DV,{size:20}):G.jsx(PV,{size:20})}),G.jsx("button",{className:"iconBtn danger",onClick:()=>window.close(),title:"Exit","aria-label":"Exit",children:G.jsx(NE,{size:20})})]})]}),G.jsxs("main",{className:"main callBody",children:[G.jsxs("div",{className:"hero",children:[G.jsx("div",{className:"heroTitle",children:"Ready when you are"}),G.jsx("div",{className:"heroText",children:"Choose what to share before joining."}),G.jsxs("div",{className:"card",children:[G.jsxs("div",{className:"prejoin-preview",children:[G.jsxs("div",{className:Ga("prejoin-preview-box",fe&&"on"),children:[G.jsx("div",{id:"prejoin-player",className:"prejoin-player"}),fe?null:G.jsx("div",{className:"prejoin-preview-overlay",children:"Camera preview is off"})]}),G.jsxs("div",{className:"prejoin-stats",children:[G.jsxs("div",{className:"stat",children:[G.jsx("div",{className:"stat-label",children:"Mic"}),G.jsx("div",{className:"stat-value",children:re?"On":"Off"}),G.jsx("div",{className:"meter",children:G.jsx("div",{className:"meter-fill",style:{width:`${Math.round(Eg*100)}%`}})})]}),G.jsxs("div",{className:"stat",children:[G.jsx("div",{className:"stat-label",children:"Privacy"}),G.jsx("div",{className:"stat-value",children:be?"On":"Off"}),G.jsx("div",{className:"hint",children:"Hides room/user details."})]})]})]}),G.jsxs("div",{className:"segmented prejoin-toggles",children:[G.jsxs("button",{className:Ga("seg",re&&"active"),onClick:bu,"aria-pressed":re,type:"button",children:[re?G.jsx(LV,{size:16}):G.jsx(fC,{size:16})," Mic"]}),G.jsxs("button",{className:Ga("seg",fe&&"active"),onClick:Ou,"aria-pressed":fe,type:"button",children:[fe?G.jsx(zl,{size:16}):G.jsx(kV,{size:16})," Camera"]})]}),G.jsxs("div",{className:"prejoin-devices",children:[G.jsxs("label",{className:"field",children:[G.jsx("div",{className:"label",children:"Microphone"}),G.jsx("select",{value:Fn,onChange:async ie=>{const ve=ie.target.value;Ls(ve);try{x.audio&&typeof x.audio.setDevice=="function"&&await x.audio.setDevice(ve)}catch{}},children:gt.map(ie=>G.jsx("option",{value:ie.deviceId,children:ie.label||`Microphone ${ie.deviceId.slice(-4)}`},ie.deviceId))})]}),G.jsxs("label",{className:"field",children:[G.jsx("div",{className:"label",children:"Camera"}),G.jsx("select",{value:Br,onChange:async ie=>{const ve=ie.target.value;Xi(ve);try{x.video&&typeof x.video.setDevice=="function"&&(await x.video.setDevice(ve),Zn(x.video))}catch{}},children:tn.map(ie=>G.jsx("option",{value:ie.deviceId,children:ie.label||`Camera ${ie.deviceId.slice(-4)}`},ie.deviceId))})]}),G.jsx("button",{className:"btn btnGhost",onClick:lc,type:"button",children:"Refresh devices"})]}),G.jsxs("div",{className:"heroActions",children:[G.jsx("button",{className:"btn",onClick:qp,disabled:ht,children:ht?"Joining":"Join now"}),G.jsx("button",{className:"btn btnGhost",onClick:()=>window.close(),children:"Exit"})]})]})]}),G.jsx("div",{className:"hint",children:"Privacy mode is enabled by default."})]})]}):G.jsxs(G.Fragment,{children:[G.jsxs("header",{className:"header",children:[G.jsxs("div",{className:"brand",children:[G.jsx("div",{className:"brandMark",children:G.jsx(zl,{size:18})}),G.jsxs("div",{className:"brandText",children:[G.jsx("div",{className:"brandName",children:"PNPtv Hangouts"}),G.jsxs("div",{className:"brandTag",children:[hc,"  Private-by-default  18+"]})]})]}),G.jsx("div",{className:"headerActions",children:G.jsx("button",{className:"iconBtn danger",onClick:()=>window.close(),title:"Exit","aria-label":"Exit",children:G.jsx(NE,{size:20})})})]}),G.jsx("main",{className:"main callBody",children:G.jsxs("div",{className:"hero",children:[G.jsx("div",{className:"heroTitle",children:"Confirm before entering"}),G.jsx("div",{className:"heroText",children:"Nothing starts until you confirm."}),G.jsxs("div",{className:"card",children:[G.jsxs("div",{className:"checkList",children:[G.jsxs("label",{className:"checkRow",children:[G.jsx("input",{type:"checkbox",checked:qe,onChange:ie=>Tn(ie.target.checked)}),G.jsx("span",{children:"I confirm I am 18+ (or legal age in my country)"})]}),G.jsxs("label",{className:"checkRow",children:[G.jsx("input",{type:"checkbox",checked:At,onChange:ie=>rr(ie.target.checked)}),G.jsx("span",{children:"I understand this is private content; dont record or share links"})]})]}),G.jsxs("div",{className:"heroActions",children:[G.jsx("button",{className:"btn",disabled:!qe||!At,onClick:F,children:"Continue"}),G.jsx("button",{className:"btn btnGhost",onClick:()=>window.close(),children:"Exit"})]})]}),G.jsx("div",{className:"hint",children:"Tip: open in a private window, disable screen recording, and keep your link secret."})]})})]})};function Zee(){var a;try{return(a=window.Telegram)!=null&&a.WebApp?(window.Telegram.WebApp.expand(),window.Telegram.WebApp.ready(),!0):!1}catch(d){return console.error("Telegram WebApp error:",d),!1}}function UV(){var a,d;try{const p=(a=window.Telegram)==null?void 0:a.WebApp;if(!p)return null;const m=(d=p.initDataUnsafe)==null?void 0:d.user;if(!(m!=null&&m.id))return null;const C=(m.username?`@${m.username}`:null)||m.first_name||"Anonymous";return{id:m.id,username:m.username||null,firstName:m.first_name||null,lastName:m.last_name||null,languageCode:m.language_code||null,displayName:C,initData:p.initData||null,isTelegram:!0}}catch(p){return console.error("Error getting Telegram user:",p),null}}function $ee(){var a;return!!((a=window.Telegram)!=null&&a.WebApp)}function ete(a){const d=Math.max(0,Math.floor(a/1e3));if(d<60)return`${d}s`;const p=Math.floor(d/60);return p<60?`${p}m`:`${Math.floor(p/60)}h`}function xV({baseUrl:a="/hangouts/",room:d,token:p,uid:m,username:S,type:C,appId:N,callId:F}){const x=new URL(a,window.location.origin);return d&&x.searchParams.set("room",d),p&&x.searchParams.set("token",p),m&&x.searchParams.set("uid",String(m)),S&&x.searchParams.set("username",S),C&&x.searchParams.set("type",C),N&&x.searchParams.set("appId",N),F&&x.searchParams.set("callId",F),x.pathname+(x.search?x.search:"")}function tte({defaultAppId:a}){const[d,p]=et.useState(null),[m,S]=et.useState([]),[C,N]=et.useState(!1),[F,x]=et.useState(""),[X,_e]=et.useState(""),[oe,re]=et.useState(!1),[Ce,fe]=et.useState(""),[Oe,Vt]=et.useState(!0),[J,K]=et.useState(10),[Q,Te]=et.useState(""),Ve=et.useRef(!1);et.useEffect(()=>{const Ye=Zee(),qe=UV();p(qe),Ye&&!qe&&console.warn("Telegram WebApp available but no user data")},[]),et.useEffect(()=>{if(!X)return;const Ye=setTimeout(()=>_e(""),1800);return()=>clearTimeout(Ye)},[X]);const Be=et.useMemo(()=>{try{const qe=new URLSearchParams(window.location.search||"").get("join");return qe?String(qe):""}catch{return""}},[]),Me=async()=>{N(!0),x("");try{const Ye=await fetch("/api/hangouts/public",{method:"GET"});if(!Ye.ok)throw new Error(`Failed to load rooms (${Ye.status})`);const qe=await Ye.json(),Tn=Array.isArray(qe==null?void 0:qe.rooms)?qe.rooms:[];S(Tn)}catch(Ye){S([]),x((Ye==null?void 0:Ye.message)||"Failed to load rooms")}finally{N(!1)}};et.useEffect(()=>{Me()},[]);const ze=et.useCallback(()=>{const Ye=d||UV();return Ye||($ee()?_e("Telegram authentication failed. Please try again."):_e(" Open this inside Telegram to join/create rooms"),null)},[d]),Kt=et.useCallback(async Ye=>{const qe=ze();if(qe){Te(Ye);try{const Tn={"Content-Type":"application/json"};qe.initData&&(Tn["x-telegram-init-data"]=qe.initData);const At=await fetch(`/api/hangouts/join/${encodeURIComponent(Ye)}`,{method:"POST",headers:Tn,body:JSON.stringify({userId:qe.id,userName:qe.displayName,initData:qe.initData})}),rr=await At.json();if(!At.ok||!(rr!=null&&rr.success)){const $t=(rr==null?void 0:rr.error)||`Join failed (${At.status})`;throw console.error("Join room failed:",$t,rr),new Error($t)}const Fr=xV({baseUrl:"/hangouts/",room:rr.room,token:rr.token,uid:rr.uid,username:qe.displayName,type:"public",appId:rr.appId||a,callId:rr.callId||Ye});window.location.href=Fr}catch(Tn){console.error("Error joining room:",Tn),_e((Tn==null?void 0:Tn.message)||"Failed to join room")}finally{Te("")}}},[ze,a]),ht=async()=>{const Ye=ze();if(Ye){if(Oe&&!Ye.initData){_e("Public rooms require Telegram authentication. Please open this from Telegram.");return}re(!0);try{const qe={"Content-Type":"application/json"};Ye.initData&&(qe["x-telegram-init-data"]=Ye.initData);const Tn=await fetch("/api/hangouts/create",{method:"POST",headers:qe,body:JSON.stringify({creatorId:Ye.id,creatorName:Ye.displayName,initData:Ye.initData,title:String(Ce||"").trim()||`${Ye.displayName}'s Hangout`,maxParticipants:Math.max(2,Math.min(50,Number(J)||10)),isPublic:!!Oe,allowGuests:!0,enforceCamera:!1})}),At=await Tn.json();if(!Tn.ok||!(At!=null&&At.success)){const Fr=(At==null?void 0:At.error)||`Create failed (${Tn.status})`;throw console.error("Room creation failed:",Fr,At),new Error(Fr)}const rr=xV({baseUrl:"/hangouts/",room:At.room,token:At.token,uid:At.uid,username:Ye.displayName,type:At.isPublic?"public":"private",appId:At.appId||a,callId:At.callId||At.id});window.location.href=rr}catch(qe){console.error("Error creating room:",qe),_e((qe==null?void 0:qe.message)||"Failed to create room")}finally{re(!1)}}};return et.useEffect(()=>{Be&&(Ve.current||(Ve.current=!0,Kt(Be)))},[Be,Kt]),G.jsxs("div",{className:"app",children:[G.jsx("div",{className:"bg"}),G.jsx("header",{className:"header",children:G.jsxs("div",{className:"brand",children:[G.jsx("div",{className:"brandMark",children:G.jsx(Xee,{size:18})}),G.jsxs("div",{className:"brandText",children:[G.jsx("div",{className:"brandName",children:"PNPtv Hangouts"}),G.jsx("div",{className:"brandTag",children:"Rooms  Public  Private  18+"})]})]})}),G.jsxs("main",{className:"main",children:[G.jsxs("div",{className:"hero",children:[G.jsx("div",{className:"heroTitle",children:"Find a room or start one"}),G.jsx("div",{className:"heroText",children:d?G.jsxs(G.Fragment,{children:["Connected as ",G.jsx("span",{className:"monoInline",children:d.displayName}),". Public rooms show up here."]}):G.jsx(G.Fragment,{children:"Open from Telegram for instant join + creator credit."})}),G.jsxs("div",{className:"heroActions",children:[G.jsxs("button",{className:"btn",onClick:ht,disabled:oe,children:[G.jsx(Kee,{size:18})," ",oe?"Creating":"Create room"]}),G.jsxs("button",{className:"btn btnGhost",onClick:Me,disabled:C,children:[G.jsx(Yee,{size:18})," Refresh"]})]}),!d&&G.jsxs("div",{className:"notice info",children:[G.jsx("span",{role:"img","aria-label":"telegram",children:""})," This feature requires Telegram. Open this link in Telegram to create/join rooms."]})]}),G.jsxs("div",{className:"card glass",children:[G.jsxs("div",{className:"formGrid",children:[G.jsxs("label",{className:"field",children:[G.jsx("div",{className:"label",children:"Title"}),G.jsx("input",{value:Ce,onChange:Ye=>fe(Ye.target.value),placeholder:"e.g., Late-night vibez"})]}),G.jsxs("label",{className:"field",children:[G.jsx("div",{className:"label",children:"Visibility"}),G.jsxs("div",{className:"segmented",children:[G.jsxs("button",{className:Oe?"seg active":"seg",onClick:()=>Vt(!0),type:"button",children:[G.jsx(Bee,{size:16})," Public"]}),G.jsxs("button",{className:Oe?"seg":"seg active",onClick:()=>Vt(!1),type:"button",children:[G.jsx(jee,{size:16})," Private"]})]})]}),G.jsxs("label",{className:"field",children:[G.jsx("div",{className:"label",children:"Max participants"}),G.jsx("input",{type:"number",min:2,max:50,value:J,onChange:Ye=>K(Ye.target.value)})]})]}),G.jsx("div",{className:"hint",children:"Public rooms send a community notification with a join link."})]}),G.jsx("div",{className:"sectionTitle",children:"Public rooms"}),F?G.jsx("div",{className:"notice error",children:F}):null,C?G.jsxs("div",{className:"loading",children:[G.jsx("div",{className:"spinner"}),G.jsx("div",{className:"muted",children:"Loading rooms"})]}):m.length===0?G.jsxs("div",{className:"empty",children:[G.jsx("div",{className:"emptyTitle",children:"No public rooms right now"}),G.jsx("div",{className:"emptyText",children:"Create one and it will appear here."})]}):G.jsx("div",{className:"grid",children:m.map(Ye=>G.jsxs("div",{className:"card",children:[G.jsxs("div",{className:"cardTop",children:[G.jsx("div",{className:"pill",children:"Public"}),G.jsx("button",{className:"btn btnSmall",onClick:()=>Kt(Ye.id),disabled:Q===Ye.id,children:Q===Ye.id?"Joining":"Join"})]}),G.jsx("div",{className:"cardTitle",children:Ye.title||"Untitled room"}),G.jsxs("div",{className:"cardDesc",children:["Host: ",G.jsx("span",{className:"monoInline",children:Ye.creatorName||"Unknown"})]}),G.jsxs("div",{className:"cardMeta",children:[G.jsxs("span",{className:"pill subtle",children:[Ye.currentParticipants||0,"/",Ye.maxParticipants||0]}),Ye.createdAt?G.jsxs("span",{className:"pill subtle",children:[ete(Date.now()-new Date(Ye.createdAt).getTime())," ago"]}):null]})]},Ye.id))})]}),X?G.jsx("div",{className:"toast",children:X}):null]})}function nte(){const a=new URLSearchParams(window.location.search);return{room:a.get("room"),token:a.get("token"),uid:a.get("uid"),username:a.get("username")||"Anonymous",type:a.get("type")||"private",appId:a.get("appId")||"b68ab7b61ea44eabab7f242171311c5e",callId:a.get("callId")}}function rte(){const[a,d]=et.useState(null),[p,m]=et.useState(!1);et.useEffect(()=>{var N;const C=nte();if(!C.room||!C.token||!C.uid){d(null),m(sessionStorage.getItem("pnp_hangouts_consent_v1")==="true");return}if(d(C),(N=window==null?void 0:window.history)!=null&&N.replaceState){const F=`${window.location.origin}${window.location.pathname}`;window.history.replaceState({},document.title,F)}m(sessionStorage.getItem("pnp_hangouts_consent_v1")==="true")},[]);const S=et.useMemo(()=>(a==null?void 0:a.appId)||new URLSearchParams(window.location.search||"").get("appId")||void 0,[a]);return a?G.jsxs("div",{className:"app",children:[G.jsx("div",{className:"bg"}),G.jsx(Qee,{...a,hasConsent:p,onConsentGranted:()=>{sessionStorage.setItem("pnp_hangouts_consent_v1","true"),m(!0)}})]}):G.jsx(tte,{defaultAppId:S})}_C.createRoot(document.getElementById("root")).render(G.jsx(CZ.StrictMode,{children:G.jsx(rte,{})}));
