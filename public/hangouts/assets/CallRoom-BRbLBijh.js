const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/AgoraRTC_N-production-DiD-Tp2-.js","assets/vendor-rZsTfZeC.js","assets/agora-3WCzbCe7.js"])))=>i.map(i=>d[i]);
import{s as te,j as e,_ as se}from"./index-COS71ljP.js";import{b as i,S as I,L as V,M as $,e as D,C as oe,V as J,f as ie,g as ae,h as ne}from"./vendor-rZsTfZeC.js";const F="pnp_hangouts_consent_v1",re=a=>{const d=Math.max(0,Math.floor(a/1e3));if(d<60)return`${d}s`;const u=Math.floor(d/60);return u<60?`${u}m`:`${Math.floor(u/60)}h`},ce=a=>{const d=Number(a);return Number.isFinite(d)?d:a||null};function ue({params:a,telegramUser:d}){const[u,Y]=i.useState(sessionStorage.getItem(F)==="true"),[E,B]=i.useState(!1),[A,G]=i.useState(!1),[n,T]=i.useState(!0),[r,M]=i.useState(!0),[p,H]=i.useState(!0),[U,z]=i.useState(!1),[L,h]=i.useState(""),[N,b]=i.useState([]),[c,K]=i.useState(null),[y,Q]=i.useState(!1),k=i.useRef(null),v=i.useRef(null),g=i.useRef(null),l=i.useRef({audio:null,video:null}),f=i.useRef(null),O=a.type==="main",w=O?"live":"rtc",C=!O,P=a.appId||void 0||"";i.useEffect(()=>{te()},[]),i.useEffect(()=>{let t=!0;return(async()=>{h("Loading video engine...");try{const o=await se(()=>import("./AgoraRTC_N-production-DiD-Tp2-.js").then(S=>S.A),__vite__mapDeps([0,1,2]));if(!t)return;f.current=o.default||o,Q(!0),h("")}catch{t&&h("Failed to load video engine.")}})(),()=>{t=!1}},[]),i.useEffect(()=>{if(!y||!f.current)return;const s=f.current.createClient({mode:w,codec:"vp8"});g.current=s;const o=async(m,x)=>{try{if(await s.subscribe(m,x),x==="video"){const j=document.getElementById(`remote-${m.uid}`);j&&m.videoTrack.play(j)}x==="audio"&&m.audioTrack?.play(),b([...s.remoteUsers])}catch(j){console.error("Subscribe error:",j)}},S=(m,x)=>{x==="video"&&m.videoTrack?.stop(),x==="audio"&&m.audioTrack?.stop(),b([...s.remoteUsers])},ee=()=>{b([...s.remoteUsers])};return s.on("user-published",o),s.on("user-unpublished",S),s.on("user-left",ee),()=>{s.removeAllListeners()}},[w,y]);const _=async()=>{const t=f.current;if(!t)throw new Error("Video engine not ready.");const s=l.current;return n&&!s.audio&&(s.audio=await t.createMicrophoneAudioTrack()),!n&&s.audio&&(s.audio.stop(),s.audio.close(),s.audio=null),r&&!s.video&&(s.video=await t.createCameraVideoTrack(),k.current&&s.video.play(k.current)),!r&&s.video&&(s.video.stop(),s.video.close(),s.video=null),l.current=s,s},q=async()=>{const t=f.current;if(!t||!c)return;const s=g.current;if(!s)return;const o=l.current;if(!C){o.audio&&(o.audio.stop(),o.audio.close(),o.audio=null),o.video&&(o.video.stop(),o.video.close(),o.video=null);return}n&&!o.audio&&(o.audio=await t.createMicrophoneAudioTrack(),await s.publish(o.audio)),!n&&o.audio&&(await s.unpublish(o.audio),o.audio.stop(),o.audio.close(),o.audio=null),r&&!o.video&&(o.video=await t.createCameraVideoTrack(),await s.publish(o.video),v.current&&o.video.play(v.current)),!r&&o.video&&(await s.unpublish(o.video),o.video.stop(),o.video.close(),o.video=null),l.current=o},W=async()=>{z(!0),h("");try{if(!y||!f.current)throw new Error("Video engine is still loading. Please try again.");const t=g.current;if(!t)throw new Error("Video client not ready");if(!P)throw new Error("Missing Agora App ID");if(w==="live"&&await t.setClientRole("audience"),await _(),await t.join(P,a.room,a.token,ce(a.uid)),C){const s=l.current,o=[];s.audio&&o.push(s.audio),s.video&&o.push(s.video),o.length&&await t.publish(o)}l.current.video&&v.current&&l.current.video.play(v.current),b([...t.remoteUsers]),K(Date.now())}catch(t){console.error("Join call error:",t),h(t?.message||"Unable to join this room.")}finally{z(!1)}},R=async()=>{try{const s=g.current;s&&await s.leave()}catch(s){console.error("Leave error:",s)}const t=l.current;t.audio&&(t.audio.stop(),t.audio.close(),t.audio=null),t.video&&(t.video.stop(),t.video.close(),t.video=null),window.location.href="/hangouts/"},X=()=>{sessionStorage.setItem(F,"true"),Y(!0)},Z=async()=>{try{await navigator.clipboard.writeText(window.location.href),h("Copied room link.")}catch{h("Copy failed.")}};return i.useEffect(()=>{if(u)return _(),()=>{l.current.video?.stop()}},[u,r,n]),i.useEffect(()=>{q().catch(t=>{console.error("Failed to update live tracks:",t)})},[n,r,c]),u?e.jsxs("div",{className:"app",children:[e.jsxs("header",{className:"header",children:[e.jsxs("div",{className:"header-logo",children:[e.jsx("div",{className:"logo-icon",children:e.jsx(I,{size:18})}),e.jsxs("div",{className:"header-text",children:[e.jsx("h1",{children:"PNPtv Hangouts"}),e.jsxs("p",{children:[a.type," | ",p?"Privacy On":"Privacy Off"," | 18+"]})]})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{className:`button-icon ${p?"active":""}`,onClick:()=>H(t=>!t),"aria-label":"Toggle privacy mode",title:"Toggle privacy mode",children:e.jsx(I,{size:18})}),e.jsx("button",{className:"button-icon button-danger",onClick:R,title:"Exit",children:e.jsx(V,{size:18})})]})]}),e.jsxs("main",{className:"container call-body",children:[e.jsxs("section",{className:"hero-section text-center",children:[e.jsx("h2",{className:"hero-title",children:c?"You are live":"Ready when you are"}),e.jsx("p",{className:"hero-text",children:c?`Room is active. ${N.length} online.`:"Choose what to share before joining."}),!c&&e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"relative w-full h-48 bg-black rounded-lg overflow-hidden flex items-center justify-center",children:[e.jsx("div",{ref:k,className:"w-full h-full object-cover"}),!r&&e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center text-muted-foreground",children:"Camera preview is off"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 mt-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Mic"}),e.jsx("div",{className:"text-lg font-semibold",children:n?"On":"Off"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-sm text-muted-foreground",children:"Mode"}),e.jsx("div",{className:"text-lg font-semibold",children:C?"Speaker":"Audience"})]})]}),e.jsxs("div",{className:"segmented-control mt-4",children:[e.jsxs("button",{className:`segmented-control-button ${n?"active":""}`,onClick:()=>T(t=>!t),type:"button",children:[n?e.jsx($,{size:16}):e.jsx(D,{size:16})," Mic"]}),e.jsxs("button",{className:`segmented-control-button ${r?"active":""}`,onClick:()=>M(t=>!t),type:"button",children:[r?e.jsx(oe,{size:16}):e.jsx(J,{size:16})," Camera"]})]}),e.jsxs("div",{className:"flex gap-4 mt-6",children:[e.jsx("button",{className:"button",onClick:W,disabled:U,children:U?"Joining...":"Join now"}),e.jsx("button",{className:"button button-secondary",onClick:R,children:"Exit"})]})]}),c&&e.jsxs("div",{className:"flex flex-wrap justify-center gap-4 mt-6",children:[e.jsxs("span",{className:"badge",children:[e.jsx(ie,{size:14})," ",N.length+1," participants"]}),e.jsxs("span",{className:"badge badge-subtle",children:["Live for ",re(Date.now()-c)]}),e.jsxs("button",{className:"button-link",onClick:Z,children:[e.jsx(ae,{size:14})," Copy link"]})]})]}),L&&e.jsx("div",{className:"alert alert-info",children:L}),c&&e.jsxs("section",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-8",children:[e.jsxs("div",{className:"relative bg-black rounded-lg overflow-hidden aspect-video",children:[e.jsx("div",{className:"w-full h-full object-cover",ref:v}),e.jsx("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded",children:p?"You":d?.displayName||a.username})]}),N.map(t=>e.jsxs("div",{className:"relative bg-black rounded-lg overflow-hidden aspect-video",children:[e.jsx("div",{className:"w-full h-full object-cover",id:`remote-${t.uid}`}),e.jsx("div",{className:"absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded",children:p?"Guest":`User ${t.uid}`})]},t.uid))]}),c&&e.jsxs("div",{className:"control-bar fixed bottom-0 left-0 right-0 p-4 bg-background border-t border-border flex justify-center gap-4",children:[e.jsxs("button",{className:"button-icon button-lg",onClick:()=>T(t=>!t),children:[n?e.jsx($,{size:18}):e.jsx(D,{size:18}),e.jsx("span",{children:n?"Mute":"Unmute"})]}),e.jsxs("button",{className:"button-icon button-lg",onClick:()=>M(t=>!t),children:[r?e.jsx(ne,{size:18}):e.jsx(J,{size:18}),e.jsx("span",{children:r?"Camera":"Cam off"})]}),e.jsxs("button",{className:"button-icon button-lg button-danger",onClick:R,children:[e.jsx(V,{size:18}),e.jsx("span",{children:"Leave"})]})]})]})]}):e.jsx("div",{className:"app",children:e.jsxs("div",{className:"card max-w-lg mx-auto my-8 p-6",children:[e.jsx("h2",{className:"hero-title text-center",children:"Confirm before entering"}),e.jsx("p",{className:"hero-text text-center mt-2",children:"Nothing starts until you confirm."}),e.jsxs("div",{className:"form-group space-y-3 my-6",children:[e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:E,onChange:t=>B(t.target.checked),className:"form-checkbox h-4 w-4 text-blue-600 rounded"}),e.jsx("span",{children:"I confirm I am 18+ (or legal age in my country)."})]}),e.jsxs("label",{className:"flex items-center space-x-2",children:[e.jsx("input",{type:"checkbox",checked:A,onChange:t=>G(t.target.checked),className:"form-checkbox h-4 w-4 text-blue-600 rounded"}),e.jsx("span",{children:"I understand this is private content and will not record."})]})]}),e.jsxs("div",{className:"flex gap-4 mt-6",children:[e.jsx("button",{className:"button",onClick:X,disabled:!E||!A,children:"Continue"}),e.jsx("button",{className:"button button-secondary",onClick:()=>window.close(),children:"Exit"})]}),e.jsx("p",{className:"text-sm text-muted-foreground mt-4 text-center",children:"Tip: open in a private window and keep your link secret."})]})})}export{ue as default};
