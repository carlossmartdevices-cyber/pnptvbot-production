const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallRoom-BQlaq9r4.js","assets/vendor-DvYm4xTx.js"])))=>i.map(i=>d[i]);
import{r as B,a as G,L as V,b as m,G as K,d as Q,R as Y}from"./vendor-DvYm4xTx.js";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))l(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const d of o.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&l(d)}).observe(document,{childList:!0,subtree:!0});function s(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function l(n){if(n.ep)return;n.ep=!0;const o=s(n);fetch(n.href,o)}})();var R={exports:{}},j={};var O;function X(){if(O)return j;O=1;var t=B(),r=Symbol.for("react.element"),s=Symbol.for("react.fragment"),l=Object.prototype.hasOwnProperty,n=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function d(i,c,h){var u,x={},f=null,p=null;h!==void 0&&(f=""+h),c.key!==void 0&&(f=""+c.key),c.ref!==void 0&&(p=c.ref);for(u in c)l.call(c,u)&&!o.hasOwnProperty(u)&&(x[u]=c[u]);if(i&&i.defaultProps)for(u in c=i.defaultProps,c)x[u]===void 0&&(x[u]=c[u]);return{$$typeof:r,type:i,key:f,ref:p,props:x,_owner:n.current}}return j.Fragment=s,j.jsx=d,j.jsxs=d,j}var I;function Z(){return I||(I=1,R.exports=X()),R.exports}var e=Z(),P={},M;function ee(){if(M)return P;M=1;var t=G();return P.createRoot=t.createRoot,P.hydrateRoot=t.hydrateRoot,P}var te=ee();(function(){const r=window.Telegram?.WebApp,s=document.documentElement;if(r){const l=r.themeParams||{},n=(o,d)=>{d&&s.style.setProperty(o,d)};n("--tg-bg",l.bg_color),n("--tg-text",l.text_color),n("--tg-hint",l.hint_color),n("--tg-link",l.link_color),n("--tg-button",l.button_color),n("--tg-button-text",l.button_text_color),n("--tg-secondary-bg",l.secondary_bg_color),r.expand(),r.ready()}else s.style.setProperty("--tg-bg","#1c1c1e"),s.style.setProperty("--tg-text","#f5f5f7"),s.style.setProperty("--tg-hint","#8e8e93"),s.style.setProperty("--tg-link","#0a84ff"),s.style.setProperty("--tg-button","#0a84ff"),s.style.setProperty("--tg-button-text","#ffffff"),s.style.setProperty("--tg-secondary-bg","#2c2c2e")})();const re="modulepreload",se=function(t){return"/hangouts/"+t},U={},ne=function(r,s,l){let n=Promise.resolve();if(s&&s.length>0){let c=function(h){return Promise.all(h.map(u=>Promise.resolve(u).then(x=>({status:"fulfilled",value:x}),x=>({status:"rejected",reason:x}))))};document.getElementsByTagName("link");const d=document.querySelector("meta[property=csp-nonce]"),i=d?.nonce||d?.getAttribute("nonce");n=c(s.map(h=>{if(h=se(h),h in U)return;U[h]=!0;const u=h.endsWith(".css"),x=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${x}`))return;const f=document.createElement("link");if(f.rel=u?"stylesheet":re,u||(f.as="script"),f.crossOrigin="",f.href=h,i&&f.setAttribute("nonce",i),document.head.appendChild(f),u)return new Promise((p,v)=>{f.addEventListener("load",p),f.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${h}`)))})}))}function o(d){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=d,window.dispatchEvent(i),!i.defaultPrevented)throw d}return n.then(d=>{for(const i of d||[])i.status==="rejected"&&o(i.reason);return r().catch(o)})};function $({title:t,telegramUser:r,onLogout:s}){return e.jsxs("header",{className:"header",children:[e.jsxs("div",{className:"header-logo",children:[e.jsx("div",{className:"logo-icon",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"2",y:"7",width:"20",height:"15",rx:"2",ry:"2"}),e.jsx("polyline",{points:"17 2 12 7 7 2"})]})}),e.jsx("div",{className:"header-text",children:e.jsx("h1",{children:t})})]}),e.jsx("div",{className:"header-user-info",children:r&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"user-greeting",children:r.name}),e.jsx("button",{onClick:s,className:"logout-button",title:"Logout",children:e.jsx(V,{size:15})})]})})]})}const _=window.location.hostname==="localhost"?"http://localhost:3000/api":"/api",S=`${_}/hangouts`,F=()=>window.Telegram?.WebApp?.initData||"",T=(t="GET",r=null)=>{const s={"x-telegram-init-data":F()};return r&&(s["Content-Type"]="application/json"),{method:t,headers:s,body:r?JSON.stringify({...r,initData:F()}):void 0}},E=async(t,r)=>{const s=await t.json().catch(()=>null);if(!t.ok)throw new Error(s?.error||r);return s};async function q(){const t=await fetch(`${S}/public`,T());return(await E(t,"Failed to load rooms.")).rooms||[]}async function ae(t){const r=await fetch(`${S}/create`,T("POST",t));return await E(r,"Failed to create room.")}async function oe(t){const r=await fetch(`${S}/join/${t}`,T("POST"));return await E(r,"Failed to join room.")}function ie(){const t=new URLSearchParams(window.location.search);return{token:t.get("token"),uid:t.get("uid"),room:t.get("room"),type:t.get("type"),callId:t.get("callId"),role:t.get("role")||""}}async function le(){try{const t=await fetch(`${_}/telegram-auth/check`,T());return t.ok&&(await t.json()).user||null}catch(t){return console.error("Error fetching Telegram user:",t),null}}function ce(t){if(t.current&&window.TelegramLoginWidget){const r=document.createElement("script");r.src="https://telegram.org/js/telegram-widget.js?22",r.setAttribute("data-telegram-bot","PNPtv_bot"),r.setAttribute("data-size","large"),r.setAttribute("data-onauth","window.onTelegramAuth(user)"),r.setAttribute("data-request-access","write"),t.current.innerHTML="",t.current.appendChild(r)}}async function de(t,r,s,l){s(!0);try{const o=await(await fetch(`${_}/telegram-auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();o.success?r(o.user):l(o.message||"Telegram login failed.")}catch(n){console.error("Error during Telegram auth:",n),l("Network error during Telegram login.")}finally{s(!1)}}const D=({baseUrl:t="/hangouts/",room:r,token:s,uid:l,username:n,type:o,appId:d,callId:i}={})=>{const c=new URL(t,window.location.origin);return r&&c.searchParams.set("room",r),s&&c.searchParams.set("token",s),l&&c.searchParams.set("uid",String(l)),n&&c.searchParams.set("username",n),o&&c.searchParams.set("type",o),d&&c.searchParams.set("appId",d),i&&c.searchParams.set("callId",i),c.pathname+(c.search||"")},be=()=>{if(window.history?.replaceState){const t=`${window.location.origin}${window.location.pathname}`;window.history.replaceState({},document.title,t)}},ue=()=>{try{return window.Telegram?.WebApp||null}catch(t){return console.error("Telegram WebApp unavailable:",t),null}},me=()=>!!ue(),fe=t=>{const r=Math.max(0,Math.floor(t/1e3));if(r<60)return`${r}s`;const s=Math.floor(r/60);return s<60?`${s}m`:`${Math.floor(s/60)}h`};function he({telegramUser:t,role:r}){const[s,l]=m.useState([]),[n,o]=m.useState(!0),[d,i]=m.useState(""),[c,h]=m.useState(""),[u,x]=m.useState(10),[f,p]=m.useState(!0),[v,N]=m.useState(!1),[L,k]=m.useState(""),[w,y]=m.useState(""),C=me()&&t?.initData,A=r?.toUpperCase()||"",J=A==="PRIME"||A==="ADMIN";n||s.length,n||s.reduce((a,g)=>a+(g.currentParticipants||0),0),n||s.reduce((a,g)=>a+(g.maxParticipants||0),0),m.useEffect(()=>{let a=!0;return(async()=>{try{o(!0);const b=await q();a&&(l(b),i(""))}catch(b){a&&(l([]),i(b?.message||"Failed to load rooms."))}finally{a&&o(!1)}})(),()=>{a=!1}},[]),m.useEffect(()=>{if(!w)return;const a=setTimeout(()=>y(""),1800);return()=>clearTimeout(a)},[w]);const W=async()=>{o(!0);try{const a=await q();l(a),i("")}catch(a){i(a?.message||"Failed to load rooms.")}finally{o(!1)}},z=async()=>{if(!J){y("Only PRIME/ADMIN users can create rooms."),N(!1);return}if(f&&!C){y("Open from Telegram to create public rooms."),N(!1);return}try{N(!0);const a=await ae({title:c,maxParticipants:u,isPublic:f,allowGuests:!0,enforceCamera:!1}),g=D({room:a.room,token:a.token,uid:a.uid,username:t?.displayName||"Host",type:a.isPublic?"public":"private",appId:a.appId,callId:a.callId});window.location.href=g}catch(a){y(a?.message||"Failed to create room.")}finally{N(!1)}},H=async a=>{if(!C){y("Open from Telegram to join rooms.");return}try{k(a);const g=await oe(a),b=D({room:g.room,token:g.token,uid:g.uid,username:t?.displayName||"Guest",type:g.isPublic?"public":"private",appId:g.appId,callId:g.callId});window.location.href=b}catch(g){y(g?.message||"Failed to join room.")}finally{k("")}};return e.jsxs("main",{className:"container",children:[e.jsxs("section",{className:"card",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("label",{className:"form-group",children:[e.jsx("div",{className:"form-label",children:"Title"}),e.jsx("input",{value:c,onChange:a=>h(a.target.value),placeholder:"e.g., Late-night vibez"})]}),e.jsxs("label",{className:"form-group",children:[e.jsx("div",{className:"form-label",children:"Visibility"}),e.jsxs("div",{className:"segmented-control",children:[e.jsxs("button",{className:f?"segmented-control-button active":"segmented-control-button",onClick:()=>p(!0),type:"button",children:[e.jsx(K,{size:16})," Public"]}),e.jsxs("button",{className:f?"segmented-control-button":"segmented-control-button active",onClick:()=>p(!1),type:"button",children:[e.jsx(Q,{size:16})," Private"]})]})]}),e.jsxs("label",{className:"form-group",children:[e.jsx("div",{className:"form-label",children:"Max participants"}),e.jsx("input",{type:"number",min:2,max:50,value:u,onChange:a=>x(Number(a.target.value))})]})]}),e.jsx("div",{className:"text-sm text-muted-foreground mt-2",children:"Public rooms send a community notification with a join link. Private rooms stay invite-only."}),e.jsxs("div",{className:"flex gap-4 mt-6",children:[e.jsx("button",{className:"btn",onClick:z,disabled:v,children:v?"Creating...":"Create room"}),e.jsx("button",{className:"btn btn-secondary",onClick:W,disabled:n,children:"Refresh"})]})]}),e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Public rooms"}),d&&e.jsx("div",{className:"alert alert-error",children:d}),n?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx("div",{className:"spinner-lg"}),e.jsx("div",{className:"text-muted-foreground mt-4",children:"Loading rooms..."})]}):s.length===0?e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"text-xl font-semibold mb-2",children:"No public rooms right now"}),e.jsx("div",{className:"text-muted-foreground",children:"Create one and it will appear here."})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:s.map(a=>e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("div",{className:"badge",children:"Public"}),e.jsx("button",{className:"btn btn-sm",onClick:()=>H(a.id),disabled:L===a.id,children:L===a.id?"Joining...":"Join"})]}),e.jsx("div",{className:"text-lg font-semibold",children:a.title||"Untitled room"}),e.jsxs("div",{className:"text-muted-foreground text-sm",children:["Host: ",e.jsx("span",{className:"font-mono",children:a.creatorName||"Unknown"})]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs("span",{className:"badge badge-subtle",children:[a.currentParticipants||0,"/",a.maxParticipants||0]}),a.createdAt&&e.jsxs("span",{className:"badge badge-subtle",children:[fe(Date.now()-new Date(a.createdAt).getTime())," ago"]})]})]},a.id))}),w&&e.jsx("div",{className:"toast-message",children:w})]})}const ge=({onAuthSuccess:t,authLoading:r})=>{const s=m.useRef(null);return m.useEffect(()=>{r||ce(s)},[r]),e.jsx("div",{className:"login-container",children:e.jsxs("div",{className:"login-card",children:[e.jsx("h1",{className:"login-title",children:"PNPtv Hangouts"}),e.jsx("p",{className:"login-subtitle",children:"Log in with Telegram to continue"}),r?e.jsx("div",{className:"loading-container",children:e.jsx("div",{className:"spinner"})}):e.jsx("div",{ref:s,className:"telegram-login-widget"})]})})},pe=m.lazy(()=>ne(()=>import("./CallRoom-BQlaq9r4.js"),__vite__mapDeps([0,1])));function xe(){const t=m.useMemo(()=>ie(),[]),r=(t.role||"").toUpperCase(),[s,l]=m.useState(null),[n,o]=m.useState(!0),[d,i]=m.useState(!1),[c,h]=m.useState(null);m.useRef(null),m.useEffect(()=>{(async()=>{o(!0);try{const p=await le();p?(l(p),i(!0)):i(!1)}catch(p){h(p.message),i(!1)}finally{o(!1)}})(),window.onTelegramAuth=async p=>{await de(p,l,o,h),i(!0)}},[]);const u=async()=>{try{await fetch("/api/logout",{method:"POST"}),l(null),i(!1)}catch(f){console.error("Logout failed:",f)}};return n?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen",children:[e.jsx("div",{className:"spinner-lg"}),e.jsx("p",{className:"text-muted-foreground mt-4",children:"Loading authentication..."})]}):d?t.room&&t.token&&t.uid?e.jsxs(e.Fragment,{children:[e.jsx($,{title:"PNPtv Hangouts",telegramUser:s,onLogout:u}),e.jsx(m.Suspense,{fallback:e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"spinner-lg"}),e.jsx("div",{className:"text-muted-foreground mt-4",children:"Loading call..."})]}),children:e.jsx(pe,{params:t,telegramUser:s})})]}):e.jsxs(e.Fragment,{children:[e.jsx($,{title:"PNPtv Hangouts",subtitle:"Video Calls",telegramUser:s,onLogout:u}),e.jsx(he,{telegramUser:s,role:r})]}):e.jsx(ge,{onAuthSuccess:()=>i(!0),authLoading:n})}te.createRoot(document.getElementById("root")).render(e.jsx(Y.StrictMode,{children:e.jsx(xe,{})}));export{ne as _,e as j,be as s};
