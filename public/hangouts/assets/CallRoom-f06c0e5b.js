import{s as Z,j as e}from"./index-086de808.js";import{r as a,c as P,d as $,M as B,e as V,C as ee,V as _,U as se,f as ie,g as ae}from"./vendor-1b7ccb23.js";import{A as j}from"./agora-2d0f9cfc.js";const G="pnp_hangouts_consent_v1",ne=n=>{const c=Math.max(0,Math.floor(n/1e3));if(c<60)return`${c}s`;const d=Math.floor(c/60);return d<60?`${d}m`:`${Math.floor(d/60)}h`},te=n=>{const c=Number(n);return Number.isFinite(c)?c:n||null};function le({params:n,telegramUser:c}){const[d,D]=a.useState(sessionStorage.getItem(G)==="true"),[S,F]=a.useState(!1),[M,J]=a.useState(!1),[o,R]=a.useState(!0),[t,A]=a.useState(!0),[p,Y]=a.useState(!0),[E,z]=a.useState(!1),[L,N]=a.useState(""),[C,b]=a.useState([]),[r,H]=a.useState(null),y=a.useRef(null),x=a.useRef(null),k=a.useRef(null),l=a.useRef({audio:null,video:null}),O=n.type==="main",g=O?"live":"rtc",w=!O,I=n.appId||{}.VITE_AGORA_APP_ID||"";a.useEffect(()=>{Z()},[]),a.useEffect(()=>{const s=j.createClient({mode:g,codec:"vp8"});k.current=s;const i=async(u,m)=>{var f;try{if(await s.subscribe(u,m),m==="video"){const h=document.getElementById(`remote-${u.uid}`);h&&u.videoTrack.play(h)}m==="audio"&&((f=u.audioTrack)==null||f.play()),b([...s.remoteUsers])}catch(h){console.error("Subscribe error:",h)}},v=(u,m)=>{var f,h;m==="video"&&((f=u.videoTrack)==null||f.stop()),m==="audio"&&((h=u.audioTrack)==null||h.stop()),b([...s.remoteUsers])},X=()=>{b([...s.remoteUsers])};return s.on("user-published",i),s.on("user-unpublished",v),s.on("user-left",X),()=>{s.removeAllListeners()}},[g]);const U=async()=>{const s=l.current;return o&&!s.audio&&(s.audio=await j.createMicrophoneAudioTrack()),!o&&s.audio&&(s.audio.stop(),s.audio.close(),s.audio=null),t&&!s.video&&(s.video=await j.createCameraVideoTrack(),y.current&&s.video.play(y.current)),!t&&s.video&&(s.video.stop(),s.video.close(),s.video=null),l.current=s,s},K=async()=>{if(!r)return;const s=k.current;if(!s)return;const i=l.current;if(!w){i.audio&&(i.audio.stop(),i.audio.close(),i.audio=null),i.video&&(i.video.stop(),i.video.close(),i.video=null);return}o&&!i.audio&&(i.audio=await j.createMicrophoneAudioTrack(),await s.publish(i.audio)),!o&&i.audio&&(await s.unpublish(i.audio),i.audio.stop(),i.audio.close(),i.audio=null),t&&!i.video&&(i.video=await j.createCameraVideoTrack(),await s.publish(i.video),x.current&&i.video.play(x.current)),!t&&i.video&&(await s.unpublish(i.video),i.video.stop(),i.video.close(),i.video=null),l.current=i},Q=async()=>{z(!0),N("");try{const s=k.current;if(!s)throw new Error("Video client not ready");if(!I)throw new Error("Missing Agora App ID");if(g==="live"&&await s.setClientRole("audience"),await U(),await s.join(I,n.room,n.token,te(n.uid)),w){const i=l.current,v=[];i.audio&&v.push(i.audio),i.video&&v.push(i.video),v.length&&await s.publish(v)}l.current.video&&x.current&&l.current.video.play(x.current),b([...s.remoteUsers]),H(Date.now())}catch(s){console.error("Join call error:",s),N((s==null?void 0:s.message)||"Unable to join this room.")}finally{z(!1)}},T=async()=>{try{const i=k.current;i&&await i.leave()}catch(i){console.error("Leave error:",i)}const s=l.current;s.audio&&(s.audio.stop(),s.audio.close(),s.audio=null),s.video&&(s.video.stop(),s.video.close(),s.video=null),window.location.href="/hangouts/"},q=()=>{sessionStorage.setItem(G,"true"),D(!0)},W=async()=>{try{await navigator.clipboard.writeText(window.location.href),N("Copied room link.")}catch{N("Copy failed.")}};return a.useEffect(()=>{if(d)return U(),()=>{var i;(i=l.current.video)==null||i.stop()}},[d,t,o]),a.useEffect(()=>{K().catch(s=>{console.error("Failed to update live tracks:",s)})},[o,t,r]),d?e.jsxs("div",{className:"app",children:[e.jsx("div",{className:"bg"}),e.jsxs("header",{className:"header",children:[e.jsxs("div",{className:"brand",children:[e.jsx("div",{className:"brandMark",children:e.jsx(P,{size:18})}),e.jsxs("div",{className:"brandText",children:[e.jsx("div",{className:"brandName",children:"PNPtv Hangouts"}),e.jsxs("div",{className:"brandTag",children:[n.type," | ",p?"Privacy On":"Privacy Off"," | 18+"]})]})]}),e.jsxs("div",{className:"headerActions",children:[e.jsx("button",{className:`iconBtn ${p?"active":""}`,onClick:()=>Y(s=>!s),"aria-label":"Toggle privacy mode",title:"Toggle privacy mode",children:e.jsx(P,{size:18})}),e.jsx("button",{className:"iconBtn danger",onClick:T,title:"Exit",children:e.jsx($,{size:18})})]})]}),e.jsxs("main",{className:"main callBody",children:[e.jsxs("section",{className:"hero",children:[e.jsx("div",{className:"heroTitle",children:r?"You are live":"Ready when you are"}),e.jsx("div",{className:"heroText",children:r?`Room is active. ${C.length} online.`:"Choose what to share before joining."}),!r&&e.jsxs("div",{className:"card glass",children:[e.jsxs("div",{className:"prejoin-preview",children:[e.jsxs("div",{className:`prejoin-preview-box ${t?"on":""}`,children:[e.jsx("div",{ref:y,className:"prejoin-player"}),!t&&e.jsx("div",{className:"prejoin-preview-overlay",children:"Camera preview is off"})]}),e.jsxs("div",{className:"prejoin-stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("div",{className:"stat-label",children:"Mic"}),e.jsx("div",{className:"stat-value",children:o?"On":"Off"})]}),e.jsxs("div",{className:"stat",children:[e.jsx("div",{className:"stat-label",children:"Mode"}),e.jsx("div",{className:"stat-value",children:w?"Speaker":"Audience"})]})]})]}),e.jsxs("div",{className:"segmented prejoin-toggles",children:[e.jsxs("button",{className:`seg ${o?"active":""}`,onClick:()=>R(s=>!s),type:"button",children:[o?e.jsx(B,{size:16}):e.jsx(V,{size:16})," Mic"]}),e.jsxs("button",{className:`seg ${t?"active":""}`,onClick:()=>A(s=>!s),type:"button",children:[t?e.jsx(ee,{size:16}):e.jsx(_,{size:16})," Camera"]})]}),e.jsxs("div",{className:"heroActions",children:[e.jsx("button",{className:"btn",onClick:Q,disabled:E,children:E?"Joining...":"Join now"}),e.jsx("button",{className:"btn btnGhost",onClick:T,children:"Exit"})]})]}),r&&e.jsxs("div",{className:"callSummary",children:[e.jsxs("div",{className:"pill",children:[e.jsx(se,{size:14})," ",C.length+1," participants"]}),e.jsxs("div",{className:"pill subtle",children:["Live for ",ne(Date.now()-r)]}),e.jsxs("button",{className:"pill subtle linkBtn",onClick:W,children:[e.jsx(ie,{size:14})," Copy link"]})]})]}),L&&e.jsx("div",{className:"notice info",children:L}),r&&e.jsxs("section",{className:"videoGrid",children:[e.jsxs("div",{className:"videoCard",children:[e.jsx("div",{className:"videoFrame",ref:x}),e.jsx("div",{className:"videoLabel",children:p?"You":(c==null?void 0:c.displayName)||n.username})]}),C.map(s=>e.jsxs("div",{className:"videoCard",children:[e.jsx("div",{className:"videoFrame",id:`remote-${s.uid}`}),e.jsx("div",{className:"videoLabel",children:p?"Guest":`User ${s.uid}`})]},s.uid))]}),r&&e.jsxs("div",{className:"controlBar",children:[e.jsxs("button",{className:"controlBtn",onClick:()=>R(s=>!s),children:[o?e.jsx(B,{size:18}):e.jsx(V,{size:18}),e.jsx("span",{children:o?"Mute":"Unmute"})]}),e.jsxs("button",{className:"controlBtn",onClick:()=>A(s=>!s),children:[t?e.jsx(ae,{size:18}):e.jsx(_,{size:18}),e.jsx("span",{children:t?"Camera":"Cam off"})]}),e.jsxs("button",{className:"controlBtn danger",onClick:T,children:[e.jsx($,{size:18}),e.jsx("span",{children:"Leave"})]})]})]})]}):e.jsxs("div",{className:"app",children:[e.jsx("div",{className:"bg"}),e.jsxs("div",{className:"centerCard",children:[e.jsx("div",{className:"heroTitle",children:"Confirm before entering"}),e.jsx("p",{className:"heroText",children:"Nothing starts until you confirm."}),e.jsxs("div",{className:"checkList",children:[e.jsxs("label",{className:"checkRow",children:[e.jsx("input",{type:"checkbox",checked:S,onChange:s=>F(s.target.checked)}),e.jsx("span",{children:"I confirm I am 18+ (or legal age in my country)."})]}),e.jsxs("label",{className:"checkRow",children:[e.jsx("input",{type:"checkbox",checked:M,onChange:s=>J(s.target.checked)}),e.jsx("span",{children:"I understand this is private content and will not record."})]})]}),e.jsxs("div",{className:"heroActions",children:[e.jsx("button",{className:"btn",onClick:q,disabled:!S||!M,children:"Continue"}),e.jsx("button",{className:"btn btnGhost",onClick:()=>window.close(),children:"Exit"})]}),e.jsx("div",{className:"hint",children:"Tip: open in a private window and keep your link secret."})]})]})}export{le as default};
