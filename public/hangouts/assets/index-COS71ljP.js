const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/CallRoom-BRbLBijh.js","assets/vendor-rZsTfZeC.js"])))=>i.map(i=>d[i]);
import{r as K,a as Q,T as Y,U as X,L as Z,b as u,G as ee,d as te,R as se}from"./vendor-rZsTfZeC.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))m(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&m(c)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function m(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();var C={exports:{}},v={};var I;function re(){if(I)return v;I=1;var t=K(),s=Symbol.for("react.element"),r=Symbol.for("react.fragment"),m=Object.prototype.hasOwnProperty,n=t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,o={key:!0,ref:!0,__self:!0,__source:!0};function c(i,l,f){var d,x={},h=null,p=null;f!==void 0&&(h=""+f),l.key!==void 0&&(h=""+l.key),l.ref!==void 0&&(p=l.ref);for(d in l)m.call(l,d)&&!o.hasOwnProperty(d)&&(x[d]=l[d]);if(i&&i.defaultProps)for(d in l=i.defaultProps,l)x[d]===void 0&&(x[d]=l[d]);return{$$typeof:s,type:i,key:h,ref:p,props:x,_owner:n.current}}return v.Fragment=r,v.jsx=c,v.jsxs=c,v}var M;function ae(){return M||(M=1,C.exports=re()),C.exports}var e=ae(),R={},$;function ne(){if($)return R;$=1;var t=Q();return R.createRoot=t.createRoot,R.hydrateRoot=t.hydrateRoot,R}var oe=ne();const ie="modulepreload",le=function(t){return"/hangouts/"+t},U={},ce=function(s,r,m){let n=Promise.resolve();if(r&&r.length>0){let l=function(f){return Promise.all(f.map(d=>Promise.resolve(d).then(x=>({status:"fulfilled",value:x}),x=>({status:"rejected",reason:x}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),i=c?.nonce||c?.getAttribute("nonce");n=l(r.map(f=>{if(f=le(f),f in U)return;U[f]=!0;const d=f.endsWith(".css"),x=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${x}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":ie,d||(h.as="script"),h.crossOrigin="",h.href=f,i&&h.setAttribute("nonce",i),document.head.appendChild(h),d)return new Promise((p,y)=>{h.addEventListener("load",p),h.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${f}`)))})}))}function o(c){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=c,window.dispatchEvent(i),!i.defaultPrevented)throw c}return n.then(c=>{for(const i of c||[])i.status==="rejected"&&o(i.reason);return s().catch(o)})};function F({title:t,subtitle:s,telegramUser:r,onLogout:m,loginRef:n}){return e.jsxs("header",{className:"header",children:[e.jsxs("div",{className:"header-logo",children:[e.jsx("div",{className:"logo-icon",children:e.jsx(Y,{size:28})}),e.jsxs("div",{className:"header-text",children:[e.jsx("h1",{children:t}),e.jsx("p",{children:s})]})]}),e.jsx("div",{className:"header-user-info",children:r?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"user-greeting",children:[e.jsx(X,{size:16}),e.jsxs("span",{children:["Welcome, ",r.name]})]}),e.jsxs("button",{onClick:m,className:"logout-button",children:[e.jsx(Z,{size:16}),e.jsx("span",{children:"Logout"})]})]}):e.jsx("div",{ref:n})})]})}const E=window.location.hostname==="localhost"?"http://localhost:3000/api":"/api",_=`${E}/hangouts`,q=()=>window.Telegram?.WebApp?.initData||"",S=(t="GET",s=null)=>{const r={"x-telegram-init-data":q()};return s&&(r["Content-Type"]="application/json"),{method:t,headers:r,body:s?JSON.stringify({...s,initData:q()}):void 0}},A=async(t,s)=>{const r=await t.json().catch(()=>null);if(!t.ok)throw new Error(r?.error||s);return r};async function D(){const t=await fetch(`${_}/public`,S());return(await A(t,"Failed to load rooms.")).rooms||[]}async function de(t){const s=await fetch(`${_}/create`,S("POST",t));return await A(s,"Failed to create room.")}async function ue(t){const s=await fetch(`${_}/join/${t}`,S("POST"));return await A(s,"Failed to join room.")}function me(){const t=new URLSearchParams(window.location.search);return{token:t.get("token"),uid:t.get("uid"),room:t.get("room"),type:t.get("type"),callId:t.get("callId"),role:t.get("role")||""}}async function he(){try{const t=await fetch(`${E}/telegram-auth/check`,S());return t.ok&&(await t.json()).user||null}catch(t){return console.error("Error fetching Telegram user:",t),null}}function fe(t){if(t.current&&window.TelegramLoginWidget){const s=document.createElement("script");s.src="https://telegram.org/js/telegram-widget.js?22",s.setAttribute("data-telegram-bot","PNPtv_bot"),s.setAttribute("data-size","large"),s.setAttribute("data-onauth","window.onTelegramAuth(user)"),s.setAttribute("data-request-access","write"),t.current.innerHTML="",t.current.appendChild(s)}}async function ge(t,s,r,m){r(!0);try{const o=await(await fetch(`${E}/telegram-auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).json();o.success?s(o.user):m(o.message||"Telegram login failed.")}catch(n){console.error("Error during Telegram auth:",n),m("Network error during Telegram login.")}finally{r(!1)}}const z=({baseUrl:t="/hangouts/",room:s,token:r,uid:m,username:n,type:o,appId:c,callId:i}={})=>{const l=new URL(t,window.location.origin);return s&&l.searchParams.set("room",s),r&&l.searchParams.set("token",r),m&&l.searchParams.set("uid",String(m)),n&&l.searchParams.set("username",n),o&&l.searchParams.set("type",o),c&&l.searchParams.set("appId",c),i&&l.searchParams.set("callId",i),l.pathname+(l.search||"")},Pe=()=>{if(window.history?.replaceState){const t=`${window.location.origin}${window.location.pathname}`;window.history.replaceState({},document.title,t)}},pe=()=>{try{return window.Telegram?.WebApp||null}catch(t){return console.error("Telegram WebApp unavailable:",t),null}},xe=()=>!!pe(),je=t=>{const s=Math.max(0,Math.floor(t/1e3));if(s<60)return`${s}s`;const r=Math.floor(s/60);return r<60?`${r}m`:`${Math.floor(r/60)}h`};function be({telegramUser:t,role:s}){const[r,m]=u.useState([]),[n,o]=u.useState(!0),[c,i]=u.useState(""),[l,f]=u.useState(""),[d,x]=u.useState(10),[h,p]=u.useState(!0),[y,w]=u.useState(!1),[L,O]=u.useState(""),[P,j]=u.useState(""),b=xe()&&t?.initData,k=s?.toUpperCase()||"",T=k==="PRIME"||k==="ADMIN",J=n?"—":r.length,W=n?"—":r.reduce((a,g)=>a+(g.currentParticipants||0),0),H=n?"—":r.reduce((a,g)=>a+(g.maxParticipants||0),0);u.useEffect(()=>{let a=!0;return(async()=>{try{o(!0);const N=await D();a&&(m(N),i(""))}catch(N){a&&(m([]),i(N?.message||"Failed to load rooms."))}finally{a&&o(!1)}})(),()=>{a=!1}},[]),u.useEffect(()=>{if(!P)return;const a=setTimeout(()=>j(""),1800);return()=>clearTimeout(a)},[P]);const G=async()=>{o(!0);try{const a=await D();m(a),i("")}catch(a){i(a?.message||"Failed to load rooms.")}finally{o(!1)}},B=async()=>{if(!T){j("Only PRIME/ADMIN users can create rooms."),w(!1);return}if(h&&!b){j("Open from Telegram to create public rooms."),w(!1);return}try{w(!0);const a=await de({title:l,maxParticipants:d,isPublic:h,allowGuests:!0,enforceCamera:!1}),g=z({room:a.room,token:a.token,uid:a.uid,username:t?.displayName||"Host",type:a.isPublic?"public":"private",appId:a.appId,callId:a.callId});window.location.href=g}catch(a){j(a?.message||"Failed to create room.")}finally{w(!1)}},V=async a=>{if(!b){j("Open from Telegram to join rooms.");return}try{O(a);const g=await ue(a),N=z({room:g.room,token:g.token,uid:g.uid,username:t?.displayName||"Guest",type:g.isPublic?"public":"private",appId:g.appId,callId:g.callId});window.location.href=N}catch(g){j(g?.message||"Failed to join room.")}finally{O("")}};return e.jsxs("main",{className:"container",children:[e.jsxs("section",{className:"hero-section",children:[e.jsx("h2",{className:"hero-title",children:"Find a room or start one."}),e.jsx("p",{className:"hero-text",children:t?e.jsxs(e.Fragment,{children:["Connected as ",e.jsx("span",{className:"font-mono",children:t.displayName}),". Public rooms appear below."]}):e.jsx(e.Fragment,{children:"Open from Telegram for instant join and creator credit."})}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-4",children:[e.jsx("span",{className:`badge ${b?"badge-success":"badge-muted"}`,children:b?"Telegram linked":"Telegram required"}),e.jsx("span",{className:`badge ${T?"badge-success":"badge-warning"}`,children:T?"Creator access":"Viewer access"}),e.jsx("span",{className:"badge badge-muted",children:"Instant join links"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-8",children:[e.jsxs("div",{className:"card text-center",children:[e.jsx("div",{className:"text-2xl font-bold",children:J}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Public rooms"})]}),e.jsxs("div",{className:"card text-center",children:[e.jsx("div",{className:"text-2xl font-bold",children:W}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Guests online"})]}),e.jsxs("div",{className:"card text-center",children:[e.jsx("div",{className:"text-2xl font-bold",children:H}),e.jsx("div",{className:"text-sm text-muted-foreground",children:"Total capacity"})]})]}),!b&&e.jsx("div",{className:"alert alert-info",children:"This feature requires Telegram authentication. Open this link inside Telegram to join or create public rooms."}),!T&&e.jsx("div",{className:"alert alert-warning",children:"Room creation is restricted to PRIME/ADMIN members in the full webapp."})]}),e.jsxs("section",{className:"card",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("label",{className:"form-group",children:[e.jsx("div",{className:"form-label",children:"Title"}),e.jsx("input",{value:l,onChange:a=>f(a.target.value),placeholder:"e.g., Late-night vibez"})]}),e.jsxs("label",{className:"form-group",children:[e.jsx("div",{className:"form-label",children:"Visibility"}),e.jsxs("div",{className:"segmented-control",children:[e.jsxs("button",{className:h?"segmented-control-button active":"segmented-control-button",onClick:()=>p(!0),type:"button",children:[e.jsx(ee,{size:16})," Public"]}),e.jsxs("button",{className:h?"segmented-control-button":"segmented-control-button active",onClick:()=>p(!1),type:"button",children:[e.jsx(te,{size:16})," Private"]})]})]}),e.jsxs("label",{className:"form-group",children:[e.jsx("div",{className:"form-label",children:"Max participants"}),e.jsx("input",{type:"number",min:2,max:50,value:d,onChange:a=>x(Number(a.target.value))})]})]}),e.jsx("div",{className:"text-sm text-muted-foreground mt-2",children:"Public rooms send a community notification with a join link. Private rooms stay invite-only."}),e.jsxs("div",{className:"flex gap-4 mt-6",children:[e.jsx("button",{className:"btn",onClick:B,disabled:y,children:y?"Creating...":"Create room"}),e.jsx("button",{className:"btn btn-secondary",onClick:G,disabled:n,children:"Refresh"})]})]}),e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Public rooms"}),c&&e.jsx("div",{className:"alert alert-error",children:c}),n?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8",children:[e.jsx("div",{className:"spinner-lg"}),e.jsx("div",{className:"text-muted-foreground mt-4",children:"Loading rooms..."})]}):r.length===0?e.jsxs("div",{className:"text-center p-8",children:[e.jsx("div",{className:"text-xl font-semibold mb-2",children:"No public rooms right now"}),e.jsx("div",{className:"text-muted-foreground",children:"Create one and it will appear here."})]}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:r.map(a=>e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("div",{className:"badge",children:"Public"}),e.jsx("button",{className:"btn btn-sm",onClick:()=>V(a.id),disabled:L===a.id,children:L===a.id?"Joining...":"Join"})]}),e.jsx("div",{className:"text-lg font-semibold",children:a.title||"Untitled room"}),e.jsxs("div",{className:"text-muted-foreground text-sm",children:["Host: ",e.jsx("span",{className:"font-mono",children:a.creatorName||"Unknown"})]}),e.jsxs("div",{className:"flex gap-2 mt-2",children:[e.jsxs("span",{className:"badge badge-subtle",children:[a.currentParticipants||0,"/",a.maxParticipants||0]}),a.createdAt&&e.jsxs("span",{className:"badge badge-subtle",children:[je(Date.now()-new Date(a.createdAt).getTime())," ago"]})]})]},a.id))}),P&&e.jsx("div",{className:"toast-message",children:P})]})}const Ne=({onAuthSuccess:t,authLoading:s})=>{const r=u.useRef(null);return u.useEffect(()=>{s||fe(r)},[s]),e.jsx("div",{className:"login-container",children:e.jsxs("div",{className:"login-card",children:[e.jsx("h1",{className:"login-title",children:"Welcome to PNPtv Hangouts"}),e.jsx("p",{className:"login-subtitle",children:"Please log in with Telegram to continue."}),s?e.jsxs("div",{className:"flex items-center justify-center p-4",children:[e.jsx("div",{className:"spinner-sm"}),e.jsx("p",{className:"text-muted-foreground ml-2",children:"Checking authentication..."})]}):e.jsx("div",{ref:r,className:"telegram-login-widget"})]})})},ve=u.lazy(()=>ce(()=>import("./CallRoom-BRbLBijh.js"),__vite__mapDeps([0,1])));function ye(){const t=u.useMemo(()=>me(),[]),s=(t.role||"").toUpperCase(),[r,m]=u.useState(null),[n,o]=u.useState(!0),[c,i]=u.useState(!1),[l,f]=u.useState(null);u.useRef(null),u.useEffect(()=>{(async()=>{o(!0);try{const p=await he();p?(m(p),i(!0)):i(!1)}catch(p){f(p.message),i(!1)}finally{o(!1)}})(),window.onTelegramAuth=async p=>{await ge(p,m,o,f),i(!0)}},[]);const d=async()=>{try{await fetch("/api/logout",{method:"POST"}),m(null),i(!1)}catch(h){console.error("Logout failed:",h)}};return n?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen",children:[e.jsx("div",{className:"spinner-lg"}),e.jsx("p",{className:"text-muted-foreground mt-4",children:"Loading authentication..."})]}):c?t.room&&t.token&&t.uid?e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"PNPtv Hangouts",subtitle:"Video Calls",telegramUser:r,onLogout:d}),e.jsx(u.Suspense,{fallback:e.jsxs("div",{className:"loading-state",children:[e.jsx("div",{className:"spinner-lg"}),e.jsx("div",{className:"text-muted-foreground mt-4",children:"Loading call..."})]}),children:e.jsx(ve,{params:t,telegramUser:r})})]}):e.jsxs(e.Fragment,{children:[e.jsx(F,{title:"PNPtv Hangouts",subtitle:"Video Calls",telegramUser:r,onLogout:d}),e.jsx(be,{telegramUser:r,role:s})]}):e.jsx(Ne,{onAuthSuccess:()=>i(!0),authLoading:n})}oe.createRoot(document.getElementById("root")).render(e.jsx(se.StrictMode,{children:e.jsx(ye,{})}));export{ce as _,e as j,Pe as s};
