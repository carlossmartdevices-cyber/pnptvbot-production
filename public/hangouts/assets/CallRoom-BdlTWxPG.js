const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/AgoraRTC_N-production-DM0AVDw9.js","assets/vendor-BCuqLCnw.js","assets/agora-DvDQCoAV.js"])))=>i.map(i=>d[i]);
import{s as ee,j as e,_ as te}from"./index-sbwaY-t3.js";import{b as r,S as se,f as V,g as M,h as L,V as $,i as J}from"./vendor-BCuqLCnw.js";const D="pnp_hangouts_consent_v1",oe=a=>{const x=Number(a);return Number.isFinite(x)?x:a||null};function ae({params:a,telegramUser:x}){const[j,F]=r.useState(sessionStorage.getItem(D)==="true"),[C,Y]=r.useState(!1),[R,B]=r.useState(!1),[n,S]=r.useState(!0),[i,E]=r.useState(!0),[h,G]=r.useState(!0),[A,T]=r.useState(!1),[U,f]=r.useState(""),[H,b]=r.useState([]),[v,K]=r.useState(null),[y,Q]=r.useState(!1),w=r.useRef(null),m=r.useRef(null),p=r.useRef(null),c=r.useRef({audio:null,video:null}),d=r.useRef(null),P=a.type==="main",N=P?"live":"rtc",_=!P,z=a.appId||void 0||"";r.useEffect(()=>{ee()},[]),r.useEffect(()=>{let t=!0;return(async()=>{f("Loading video engine...");try{const o=await te(()=>import("./AgoraRTC_N-production-DM0AVDw9.js").then(k=>k.A),__vite__mapDeps([0,1,2]));if(!t)return;d.current=o.default||o,Q(!0),f("")}catch{t&&f("Failed to load video engine.")}})(),()=>{t=!1}},[]),r.useEffect(()=>{if(!y||!d.current)return;const s=d.current.createClient({mode:N,codec:"vp8"});p.current=s;const o=async(l,u)=>{try{if(await s.subscribe(l,u),u==="video"){const g=document.getElementById(`remote-${l.uid}`);g&&l.videoTrack.play(g)}u==="audio"&&l.audioTrack?.play(),b([...s.remoteUsers])}catch(g){console.error("Subscribe error:",g)}},k=(l,u)=>{u==="video"&&l.videoTrack?.stop(),u==="audio"&&l.audioTrack?.stop(),b([...s.remoteUsers])},Z=()=>{b([...s.remoteUsers])};return s.on("user-published",o),s.on("user-unpublished",k),s.on("user-left",Z),()=>{s.removeAllListeners()}},[N,y]);const I=async()=>{const t=d.current;if(!t)throw new Error("Video engine not ready.");const s=c.current;return n&&!s.audio&&(s.audio=await t.createMicrophoneAudioTrack()),!n&&s.audio&&(s.audio.stop(),s.audio.close(),s.audio=null),i&&!s.video&&(s.video=await t.createCameraVideoTrack(),w.current&&s.video.play(w.current)),!i&&s.video&&(s.video.stop(),s.video.close(),s.video=null),c.current=s,s},q=async()=>{const t=d.current;if(!t||!v)return;const s=p.current;if(!s)return;const o=c.current;if(!_){o.audio&&(o.audio.stop(),o.audio.close(),o.audio=null),o.video&&(o.video.stop(),o.video.close(),o.video=null);return}n&&!o.audio&&(o.audio=await t.createMicrophoneAudioTrack(),await s.publish(o.audio)),!n&&o.audio&&(await s.unpublish(o.audio),o.audio.stop(),o.audio.close(),o.audio=null),i&&!o.video&&(o.video=await t.createCameraVideoTrack(),await s.publish(o.video),m.current&&o.video.play(m.current)),!i&&o.video&&(await s.unpublish(o.video),o.video.stop(),o.video.close(),o.video=null),c.current=o},W=async()=>{T(!0),f("");try{if(!y||!d.current)throw new Error("Video engine is still loading. Please try again.");const t=p.current;if(!t)throw new Error("Video client not ready");if(!z)throw new Error("Missing Agora App ID");if(N==="live"&&await t.setClientRole("audience"),await I(),await t.join(z,a.room,a.token,oe(a.uid)),_){const s=c.current,o=[];s.audio&&o.push(s.audio),s.video&&o.push(s.video),o.length&&await t.publish(o)}c.current.video&&m.current&&c.current.video.play(m.current),b([...t.remoteUsers]),K(Date.now())}catch(t){console.error("Join call error:",t),f(t?.message||"Unable to join this room.")}finally{T(!1)}},O=async()=>{try{const s=p.current;s&&await s.leave()}catch(s){console.error("Leave error:",s)}const t=c.current;t.audio&&(t.audio.stop(),t.audio.close(),t.audio=null),t.video&&(t.video.stop(),t.video.close(),t.video=null),window.location.href="/hangouts/"},X=()=>{sessionStorage.setItem(D,"true"),F(!0)};return r.useEffect(()=>{if(j)return I(),()=>{c.current.video?.stop()}},[j,i,n]),r.useEffect(()=>{q().catch(t=>{console.error("Failed to update live tracks:",t)})},[n,i,v]),j?e.jsxs("div",{className:"flex flex-col h-screen bg-color text-color",children:[e.jsxs("header",{className:"header",children:[e.jsx("div",{className:"header-logo",children:e.jsx("h1",{children:"PNPtv Hangouts"})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("button",{className:`btn btn-sm ${h?"btn-primary":"btn-secondary"}`,onClick:()=>G(t=>!t),"aria-label":"Toggle privacy mode",title:"Toggle privacy mode",children:[e.jsx(se,{size:16,className:"mr-2"}),h?"Privacy On":"Privacy Off"]}),e.jsxs("button",{className:"btn btn-destructive btn-sm",onClick:O,title:"Exit",children:[e.jsx(V,{size:16,className:"mr-2"})," Exit"]})]})]}),e.jsx("main",{className:"flex-grow flex flex-col items-center justify-center p-4",children:v?e.jsx("div",{className:"w-full h-full flex flex-col",children:e.jsxs("div",{className:"flex-grow grid grid-cols-1 md:grid-cols-2 gap-4 p-4",children:[e.jsxs("div",{className:"relative bg-black rounded-lg overflow-hidden",children:[e.jsx("div",{className:"w-full h-full object-cover",ref:m}),e.jsx("div",{className:"absolute bottom-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded",children:h?"You":x?.displayName||a.username})]}),H.map(t=>e.jsxs("div",{className:"relative bg-black rounded-lg overflow-hidden",children:[e.jsx("div",{className:"w-full h-full object-cover",id:`remote-${t.uid}`}),e.jsx("div",{className:"absolute bottom-2 left-2 bg-black/50 text-white text-xs px-2 py-1 rounded",children:h?"Guest":`User ${t.uid}`})]},t.uid))]})}):e.jsx("div",{className:"w-full max-w-lg mx-auto",children:e.jsxs("div",{className:"bg-color-2 p-6 rounded-lg shadow-md text-center",children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Ready when you are"}),e.jsx("p",{className:"text-muted-color mb-6",children:"Choose what to share before joining."}),e.jsxs("div",{className:"relative w-full aspect-video bg-black rounded-lg overflow-hidden mb-4",children:[e.jsx("div",{ref:w,className:"w-full h-full object-cover"}),!i&&e.jsx("div",{className:"absolute inset-0 bg-black/70 flex items-center justify-center text-muted-color",children:"Camera preview is off"})]}),e.jsxs("div",{className:"flex justify-center gap-4 mb-6",children:[e.jsx("button",{className:`btn ${n?"btn-primary":"btn-secondary"}`,onClick:()=>S(t=>!t),children:n?e.jsx(M,{size:20}):e.jsx(L,{size:20})}),e.jsx("button",{className:`btn ${i?"btn-primary":"btn-secondary"}`,onClick:()=>E(t=>!t),children:i?e.jsx($,{size:20}):e.jsx(J,{size:20})})]}),e.jsx("button",{className:"btn btn-primary w-full",onClick:W,disabled:A,children:A?"Joining...":"Join now"})]})})}),v&&e.jsxs("footer",{className:"flex justify-center items-center gap-4 p-4 bg-color-2 border-t border-color",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>S(t=>!t),children:n?e.jsx(M,{size:20}):e.jsx(L,{size:20})}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>E(t=>!t),children:i?e.jsx($,{size:20}):e.jsx(J,{size:20})}),e.jsx("button",{className:"btn btn-destructive",onClick:O,children:e.jsx(V,{size:20})})]}),U&&e.jsx("div",{className:"fixed top-20 right-8 bg-color-2 text-color px-6 py-3 rounded-lg shadow-lg animate-fade-in-out",children:U})]}):e.jsx("div",{className:"flex items-center justify-center min-h-screen bg-color",children:e.jsxs("div",{className:"w-full max-w-md p-8 space-y-6 bg-color-2 rounded-lg shadow-md",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Confirm before entering"}),e.jsx("p",{className:"mt-2 text-muted-color",children:"Nothing starts until you confirm."})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("label",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"checkbox",checked:C,onChange:t=>Y(t.target.checked),className:"h-5 w-5 rounded border-gray-300 text-primary-color focus:ring-primary-color"}),e.jsx("span",{className:"text-color",children:"I confirm I am 18+ (or legal age in my country)."})]}),e.jsxs("label",{className:"flex items-center space-x-3",children:[e.jsx("input",{type:"checkbox",checked:R,onChange:t=>B(t.target.checked),className:"h-5 w-5 rounded border-gray-300 text-primary-color focus:ring-primary-color"}),e.jsx("span",{className:"text-color",children:"I understand this is private content and will not record."})]})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx("button",{className:"btn btn-primary w-full",onClick:X,disabled:!C||!R,children:"Continue"}),e.jsx("button",{className:"btn btn-secondary w-full",onClick:()=>window.close(),children:"Exit"})]}),e.jsx("p",{className:"text-xs text-muted-color text-center pt-2",children:"Tip: open in a private window and keep your link secret."})]})})}export{ae as default};
