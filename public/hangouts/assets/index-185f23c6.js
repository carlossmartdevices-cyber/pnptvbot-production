import{r as d,a as z,S as G,R as J,G as H,L as q,b as Q}from"./vendor-1b7ccb23.js";import"./agora-2d0f9cfc.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function r(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=r(i);fetch(i.href,a)}})();var D={exports:{}},v={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var V=d,K=Symbol.for("react.element"),Y=Symbol.for("react.fragment"),X=Object.prototype.hasOwnProperty,Z=V.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,U={key:!0,ref:!0,__self:!0,__source:!0};function M(t,s,r){var o,i={},a=null,c=null;r!==void 0&&(a=""+r),s.key!==void 0&&(a=""+s.key),s.ref!==void 0&&(c=s.ref);for(o in s)X.call(s,o)&&!U.hasOwnProperty(o)&&(i[o]=s[o]);if(t&&t.defaultProps)for(o in s=t.defaultProps,s)i[o]===void 0&&(i[o]=s[o]);return{$$typeof:K,type:t,key:a,ref:c,props:i,_owner:Z.current}}v.Fragment=Y;v.jsx=M;v.jsxs=M;D.exports=v;var e=D.exports,F,I=z;F=I.createRoot,I.hydrateRoot;const ee="modulepreload",se=function(t){return"/hangouts/"+t},O={},te=function(s,r,o){if(!r||r.length===0)return s();const i=document.getElementsByTagName("link");return Promise.all(r.map(a=>{if(a=se(a),a in O)return;O[a]=!0;const c=a.endsWith(".css"),m=c?'[rel="stylesheet"]':"";if(!!o)for(let p=i.length-1;p>=0;p--){const x=i[p];if(x.href===a&&(!c||x.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${m}`))return;const h=document.createElement("link");if(h.rel=c?"stylesheet":ee,c||(h.as="script",h.crossOrigin=""),h.href=a,document.head.appendChild(h),c)return new Promise((p,x)=>{h.addEventListener("load",p),h.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${a}`)))})})).then(()=>s()).catch(a=>{const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=a,window.dispatchEvent(c),!c.defaultPrevented)throw a})},w=()=>{var t;try{return((t=window.Telegram)==null?void 0:t.WebApp)||null}catch(s){return console.error("Telegram WebApp unavailable:",s),null}},ae=()=>!!w(),P=()=>{var t;try{const s=w();if(!s)return null;const r=(t=s.initDataUnsafe)==null?void 0:t.user;if(!(r!=null&&r.id))return null;const o=r.username?`@${r.username}`:r.first_name||r.last_name||"Anonymous";return{id:r.id,username:r.username||null,firstName:r.first_name||null,lastName:r.last_name||null,languageCode:r.language_code||null,displayName:o,initData:s.initData||null,isTelegram:!0}}catch(s){return console.error("Failed to read Telegram user:",s),null}},ne=()=>{const t=w();if(!t)return!1;try{return t.expand(),t.ready(),!0}catch(s){return console.error("Telegram WebApp init failed:",s),!1}},$=t=>{const s={"Content-Type":"application/json"};return t&&(s["x-telegram-init-data"]=t),s},L=async()=>{const t=await fetch("/api/hangouts/public",{method:"GET"}),s=await t.json();if(!t.ok||!s.success)throw new Error(s.error||"Failed to load rooms");return s.rooms||[]},re=async({title:t,maxParticipants:s,isPublic:r,enforceCamera:o,allowGuests:i}={})=>{const a=P(),c={title:t,maxParticipants:s,isPublic:r,enforceCamera:o,allowGuests:i,creatorId:a==null?void 0:a.id,creatorName:a==null?void 0:a.displayName,initData:a==null?void 0:a.initData},m=await fetch("/api/hangouts/create",{method:"POST",headers:$(a==null?void 0:a.initData),body:JSON.stringify(c)}),l=await m.json();if(!m.ok||!l.success)throw new Error(l.error||"Failed to create room");return l},ie=async t=>{const s=P(),r=await fetch(`/api/hangouts/join/${encodeURIComponent(t)}`,{method:"POST",headers:$(s==null?void 0:s.initData),body:JSON.stringify({userId:s==null?void 0:s.id,userName:s==null?void 0:s.displayName,initData:s==null?void 0:s.initData})}),o=await r.json();if(!r.ok||!o.success)throw new Error(o.error||"Failed to join room");return o},oe=()=>{const t=new URLSearchParams(window.location.search||"");return{room:t.get("room"),token:t.get("token"),uid:t.get("uid"),username:t.get("username")||"Anonymous",type:t.get("type")||"private",appId:t.get("appId")||"",callId:t.get("callId")||""}},A=({baseUrl:t="/hangouts/",room:s,token:r,uid:o,username:i,type:a,appId:c,callId:m}={})=>{const l=new URL(t,window.location.origin);return s&&l.searchParams.set("room",s),r&&l.searchParams.set("token",r),o&&l.searchParams.set("uid",String(o)),i&&l.searchParams.set("username",i),a&&l.searchParams.set("type",a),c&&l.searchParams.set("appId",c),m&&l.searchParams.set("callId",m),l.pathname+(l.search||"")},pe=()=>{var t;if((t=window.history)!=null&&t.replaceState){const s=`${window.location.origin}${window.location.pathname}`;window.history.replaceState({},document.title,s)}},ce=t=>{const s=Math.max(0,Math.floor(t/1e3));if(s<60)return`${s}s`;const r=Math.floor(s/60);return r<60?`${r}m`:`${Math.floor(r/60)}h`};function le({telegramUser:t,role:s}){const[r,o]=d.useState([]),[i,a]=d.useState(!0),[c,m]=d.useState(""),[l,h]=d.useState(""),[p,x]=d.useState(10),[y,T]=d.useState(!0),[R,N]=d.useState(!1),[E,S]=d.useState(""),[b,j]=d.useState(""),g=ae()&&(t==null?void 0:t.initData),k=(s==null?void 0:s.toUpperCase())||"",C=k==="PRIME"||k==="ADMIN";d.useEffect(()=>{let n=!0;return(async()=>{try{a(!0);const f=await L();n&&(o(f),m(""))}catch(f){n&&(o([]),m((f==null?void 0:f.message)||"Failed to load rooms."))}finally{n&&a(!1)}})(),()=>{n=!1}},[]),d.useEffect(()=>{if(!b)return;const n=setTimeout(()=>j(""),1800);return()=>clearTimeout(n)},[b]);const _=async()=>{a(!0);try{const n=await L();o(n),m("")}catch(n){m((n==null?void 0:n.message)||"Failed to load rooms.")}finally{a(!1)}},B=async()=>{if(!C){j("Only PRIME/ADMIN users can create rooms."),N(!1);return}if(y&&!g){j("Open from Telegram to create public rooms."),N(!1);return}try{N(!0);const n=await re({title:l,maxParticipants:p,isPublic:y,allowGuests:!0,enforceCamera:!1}),u=A({room:n.room,token:n.token,uid:n.uid,username:(t==null?void 0:t.displayName)||"Host",type:n.isPublic?"public":"private",appId:n.appId,callId:n.callId});window.location.href=u}catch(n){j((n==null?void 0:n.message)||"Failed to create room.")}finally{N(!1)}},W=async n=>{if(!g){j("Open from Telegram to join rooms.");return}try{S(n);const u=await ie(n),f=A({room:u.room,token:u.token,uid:u.uid,username:(t==null?void 0:t.displayName)||"Guest",type:u.isPublic?"public":"private",appId:u.appId,callId:u.callId});window.location.href=f}catch(u){j((u==null?void 0:u.message)||"Failed to join room.")}finally{S("")}};return e.jsxs("div",{className:"app",children:[e.jsx("div",{className:"bg"}),e.jsxs("header",{className:"header",children:[e.jsxs("div",{className:"brand",children:[e.jsx("div",{className:"brandMark",children:e.jsx(G,{size:18})}),e.jsxs("div",{className:"brandText",children:[e.jsx("div",{className:"brandName",children:"PNPtv Hangouts"}),e.jsx("div",{className:"brandTag",children:"Rooms | Live | Private-by-default | 18+"})]})]}),e.jsx("button",{className:"iconBtn",onClick:_,disabled:i,title:"Refresh rooms",children:e.jsx(J,{size:18})})]}),e.jsxs("main",{className:"main",children:[e.jsxs("section",{className:"hero",children:[e.jsx("div",{className:"heroTitle",children:"Find a room or start one."}),e.jsx("div",{className:"heroText",children:t?e.jsxs(e.Fragment,{children:["Connected as ",e.jsx("span",{className:"monoInline",children:t.displayName}),". Public rooms appear below."]}):e.jsx(e.Fragment,{children:"Open from Telegram for instant join and creator credit."})}),!g&&e.jsx("div",{className:"notice info",children:"This feature requires Telegram authentication. Open this link inside Telegram to join or create public rooms."}),!C&&e.jsx("div",{className:"notice warning",children:"Room creation is restricted to PRIME/ADMIN members in the full webapp."})]}),e.jsxs("section",{className:"card glass",children:[e.jsxs("div",{className:"formGrid",children:[e.jsxs("label",{className:"field",children:[e.jsx("div",{className:"label",children:"Title"}),e.jsx("input",{value:l,onChange:n=>h(n.target.value),placeholder:"e.g., Late-night vibez"})]}),e.jsxs("label",{className:"field",children:[e.jsx("div",{className:"label",children:"Visibility"}),e.jsxs("div",{className:"segmented",children:[e.jsxs("button",{className:y?"seg active":"seg",onClick:()=>T(!0),type:"button",children:[e.jsx(H,{size:16})," Public"]}),e.jsxs("button",{className:y?"seg":"seg active",onClick:()=>T(!1),type:"button",children:[e.jsx(q,{size:16})," Private"]})]})]}),e.jsxs("label",{className:"field",children:[e.jsx("div",{className:"label",children:"Max participants"}),e.jsx("input",{type:"number",min:2,max:50,value:p,onChange:n=>x(Number(n.target.value))})]})]}),e.jsx("div",{className:"hint",children:"Public rooms send a community notification with a join link. Private rooms stay invite-only."}),e.jsxs("div",{className:"heroActions",children:[e.jsx("button",{className:"btn",onClick:B,disabled:R,children:R?"Creating...":"Create room"}),e.jsx("button",{className:"btn btnGhost",onClick:_,disabled:i,children:"Refresh"})]})]}),e.jsx("div",{className:"sectionTitle",children:"Public rooms"}),c&&e.jsx("div",{className:"notice error",children:c}),i?e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("div",{className:"muted",children:"Loading rooms..."})]}):r.length===0?e.jsxs("div",{className:"empty",children:[e.jsx("div",{className:"emptyTitle",children:"No public rooms right now"}),e.jsx("div",{className:"emptyText",children:"Create one and it will appear here."})]}):e.jsx("div",{className:"grid",children:r.map(n=>e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"cardTop",children:[e.jsx("div",{className:"pill",children:"Public"}),e.jsx("button",{className:"btn btnSmall",onClick:()=>W(n.id),disabled:E===n.id,children:E===n.id?"Joining...":"Join"})]}),e.jsx("div",{className:"cardTitle",children:n.title||"Untitled room"}),e.jsxs("div",{className:"cardDesc",children:["Host: ",e.jsx("span",{className:"monoInline",children:n.creatorName||"Unknown"})]}),e.jsxs("div",{className:"cardMeta",children:[e.jsxs("span",{className:"pill subtle",children:[n.currentParticipants||0,"/",n.maxParticipants||0]}),n.createdAt&&e.jsxs("span",{className:"pill subtle",children:[ce(Date.now()-new Date(n.createdAt).getTime())," ago"]})]})]},n.id))})]}),b&&e.jsx("div",{className:"toast",children:b})]})}const de=d.lazy(()=>te(()=>import("./CallRoom-1f4944e6.js"),["assets/CallRoom-1f4944e6.js","assets/vendor-1b7ccb23.js","assets/agora-2d0f9cfc.js"]));function ue(){const t=d.useMemo(()=>oe(),[]),s=(t.role||"").toUpperCase(),[r,o]=d.useState(null);return d.useEffect(()=>{ne()&&o(P())},[]),!(t.room&&t.token&&t.uid)?e.jsx(le,{telegramUser:r,role:s}):e.jsx(d.Suspense,{fallback:e.jsxs("div",{className:"app",children:[e.jsx("div",{className:"bg"}),e.jsxs("div",{className:"loading",children:[e.jsx("div",{className:"spinner"}),e.jsx("div",{className:"muted",children:"Loading call..."})]})]}),children:e.jsx(de,{params:t,telegramUser:r})})}F(document.getElementById("root")).render(e.jsx(Q.StrictMode,{children:e.jsx(ue,{})}));export{e as j,pe as s};
